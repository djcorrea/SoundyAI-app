<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: True Peak - Mensagem Estendida</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1a1a; 
            color: #fff; 
        }
        .test-section { 
            background: #2a2a2a; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid #007acc; 
        }
        .success { border-left-color: #28a745; }
        .warning { border-left-color: #ffc107; }
        .error { border-left-color: #dc3545; }
        .true-peak-extended {
            background: #2d1b47;
            border-left: 4px solid #9c27b0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .extended-field {
            background: #3a3a3a;
            padding: 10px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #9c27b0;
        }
        .extended-field h4 {
            margin: 0 0 8px 0;
            color: #e1bee7;
        }
        button {
            background: #9c27b0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #7b1fa2; }
        .log { 
            background: #1e1e1e; 
            padding: 10px; 
            font-family: monospace; 
            font-size: 12px; 
            max-height: 300px; 
            overflow-y: auto; 
            border: 1px solid #444;
        }
        .scenario-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .technical-data {
            background: #1a2332;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #17a2b8;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>‚ö° Teste: True Peak - Mensagem Estendida</h1>
    <p>Este teste valida se a mensagem did√°tica do True Peak est√° funcionando corretamente.</p>

    <div class="test-section">
        <h3>üéõÔ∏è Cen√°rios de Teste</h3>
        <div class="scenario-controls">
            <button onclick="testarTruePeakCritico()">1. True Peak CR√çTICO (+0.5 dBTP)</button>
            <button onclick="testarTruePeakAlto()">2. True Peak ALTO (-0.2 dBTP)</button>
            <button onclick="testarTruePeakIdeal()">3. True Peak IDEAL (-1.5 dBTP)</button>
            <button onclick="testarTruePeakBaixo()">4. True Peak BAIXO (-3.0 dBTP)</button>
        </div>
        <div class="scenario-controls">
            <button onclick="testarComparacaoAntesDepois()">üîÑ Comparar: Antes vs Depois da IA</button>
            <button onclick="limparResultados()">üóëÔ∏è Limpar</button>
        </div>
    </div>

    <div class="test-section">
        <h3>üìä Status do Sistema</h3>
        <div id="systemStatus"></div>
    </div>

    <div class="test-section">
        <h3>‚ö° Resultado da Mensagem Estendida</h3>
        <div id="truePeakResult"></div>
    </div>

    <div class="test-section">
        <h3>üìù Log de Execu√ß√£o</h3>
        <div id="logOutput" class="log"></div>
    </div>

    <!-- Carregar depend√™ncias -->
    <script src="enhanced-suggestion-engine.js"></script>
    <script src="ai-suggestion-layer.js"></script>

    <script>
        let logContainer;
        
        function log(message, type = 'info') {
            if (!logContainer) logContainer = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ff6b6b' : 
                                 type === 'success' ? '#51cf66' : 
                                 type === 'warning' ? '#ffd43b' : '#74c0fc';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function limparResultados() {
            document.getElementById('logOutput').innerHTML = '';
            document.getElementById('truePeakResult').innerHTML = '';
        }

        function verificarSistema() {
            const status = document.getElementById('systemStatus');
            const componentes = [
                { nome: 'Enhanced Suggestion Engine', disponivel: typeof window.EnhancedSuggestionEngine !== 'undefined' },
                { nome: 'AI Suggestion Layer', disponivel: typeof window.aiSuggestionLayer !== 'undefined' },
                { nome: 'Fun√ß√£o createTruePeakExtendedSuggestion', disponivel: window.EnhancedSuggestionEngine?.prototype?.createTruePeakExtendedSuggestion !== undefined }
            ];

            status.innerHTML = componentes.map(comp => `
                <div style="color: ${comp.disponivel ? '#51cf66' : '#ff6b6b'}">
                    ${comp.disponivel ? '‚úÖ' : '‚ùå'} ${comp.nome}
                </div>
            `).join('');

            log(`Verifica√ß√£o do sistema: ${componentes.filter(c => c.disponivel).length}/${componentes.length} componentes OK`);
        }

        function criarDadosTeste(truePeakValue) {
            return {
                technicalData: {
                    lufsIntegrated: -9.2,
                    truePeakDbtp: truePeakValue,
                    dynamicRange: 6.8,
                    lra: 7.5,
                    stereoCorrelation: 0.45
                },
                runId: 'test_true_peak_' + Date.now(),
                metadata: { genre: 'funk_mandela' }
            };
        }

        function criarReferenciaFunkMandela() {
            return {
                lufs_target: -8.0,
                tol_lufs: 2.5,
                true_peak_target: -0.8,
                tol_true_peak: 1.0,
                dr_target: 8.0,
                tol_dr: 3.0,
                lra_target: 9.0,
                tol_lra: 2.5,
                stereo_target: 0.60,
                tol_stereo: 0.25
            };
        }

        function executarTesteTruePeak(valorTruePeak, cenario) {
            log(`üéØ Executando teste: ${cenario} (True Peak: ${valorTruePeak} dBTP)`, 'info');
            
            if (typeof window.EnhancedSuggestionEngine === 'undefined') {
                log('‚ùå Enhanced Engine n√£o dispon√≠vel', 'error');
                return null;
            }

            try {
                const engine = new window.EnhancedSuggestionEngine();
                const dadosTeste = criarDadosTeste(valorTruePeak);
                const referencia = criarReferenciaFunkMandela();
                
                const resultado = engine.processAnalysis(dadosTeste, referencia);
                
                // Procurar sugest√£o de True Peak
                const truePeakSuggestion = resultado.suggestions?.find(s => 
                    s.type === 'reference_true_peak' || s.metricType === 'true_peak'
                );
                
                if (truePeakSuggestion) {
                    log('‚úÖ Sugest√£o de True Peak encontrada', 'success');
                    
                    if (truePeakSuggestion._isTruePeakExtended) {
                        log('üéØ Mensagem estendida detectada!', 'success');
                        exibirMensagemEstendida(truePeakSuggestion, cenario);
                        return truePeakSuggestion;
                    } else {
                        log('‚ö†Ô∏è Sugest√£o encontrada mas sem mensagem estendida', 'warning');
                        exibirSugestaoSimples(truePeakSuggestion, cenario);
                        return truePeakSuggestion;
                    }
                } else {
                    log('‚ùå Nenhuma sugest√£o de True Peak encontrada', 'error');
                    return null;
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
                return null;
            }
        }

        function exibirMensagemEstendida(suggestion, cenario) {
            const container = document.getElementById('truePeakResult');
            const ext = suggestion.extendedMessage;
            const tech = suggestion.technical;
            
            container.innerHTML = `
                <div class="true-peak-extended">
                    <h3>‚ö° ${cenario} - Mensagem Estendida</h3>
                    
                    <div class="technical-data">
                        <strong>Dados T√©cnicos:</strong><br>
                        ‚Ä¢ Valor Atual: ${tech.currentValue} dBTP<br>
                        ‚Ä¢ Valor Alvo: ${tech.targetValue} dBTP<br>
                        ‚Ä¢ Diferen√ßa: ${tech.delta.toFixed(2)} dB (${tech.direcaoAjuste})<br>
                        ‚Ä¢ Severidade: ${suggestion.severity}<br>
                        ‚Ä¢ Prioridade: ${suggestion.priority.toFixed(2)}
                    </div>
                    
                    <div class="extended-field">
                        <h4>üö® Problema</h4>
                        <p>${ext.problema}</p>
                    </div>
                    
                    <div class="extended-field">
                        <h4>üîç Causa Prov√°vel</h4>
                        <p>${ext.causaProvavel}</p>
                    </div>
                    
                    <div class="extended-field">
                        <h4>üõ†Ô∏è Solu√ß√£o Pr√°tica</h4>
                        <p>${ext.solucaoPratica}</p>
                    </div>
                    
                    <div class="extended-field">
                        <h4>üí° Dica Extra</h4>
                        <p>${ext.dicaExtra}</p>
                    </div>
                    
                    <div class="extended-field">
                        <h4>üéõÔ∏è Plugin/Ferramenta</h4>
                        <p>${ext.pluginFerramenta}</p>
                    </div>
                    
                    <div class="extended-field">
                        <h4>üéØ Resultado Esperado</h4>
                        <p>${ext.resultadoEsperado}</p>
                    </div>
                </div>
            `;
        }

        function exibirSugestaoSimples(suggestion, cenario) {
            const container = document.getElementById('truePeakResult');
            
            container.innerHTML = `
                <div class="test-section warning">
                    <h3>‚ö†Ô∏è ${cenario} - Sugest√£o Simples (N√£o Estendida)</h3>
                    <p><strong>Mensagem:</strong> ${suggestion.message || 'N/A'}</p>
                    <p><strong>A√ß√£o:</strong> ${suggestion.action || 'N/A'}</p>
                    <p><strong>Por qu√™:</strong> ${suggestion.why || 'N/A'}</p>
                    <p><em>Esta sugest√£o n√£o possui mensagem estendida.</em></p>
                </div>
            `;
        }

        // Fun√ß√µes de teste espec√≠ficas
        function testarTruePeakCritico() {
            executarTesteTruePeak(0.5, 'True Peak CR√çTICO');
        }

        function testarTruePeakAlto() {
            executarTesteTruePeak(-0.2, 'True Peak ALTO');
        }

        function testarTruePeakIdeal() {
            executarTesteTruePeak(-1.5, 'True Peak IDEAL');
        }

        function testarTruePeakBaixo() {
            executarTesteTruePeak(-3.0, 'True Peak BAIXO');
        }

        function testarComparacaoAntesDepois() {
            log('üîÑ Executando compara√ß√£o: Antes vs Depois da IA', 'info');
            
            const suggestion = executarTesteTruePeak(-0.2, 'Compara√ß√£o Antes/Depois');
            
            if (suggestion && window.aiSuggestionLayer && suggestion._isTruePeakExtended) {
                // Simular processamento da IA
                window.aiSuggestionLayer.process([suggestion], {
                    technicalData: criarDadosTeste(-0.2).technicalData,
                    genre: 'funk_mandela'
                }).then(enhancedSuggestions => {
                    const enhanced = enhancedSuggestions[0];
                    
                    if (enhanced.ai_preserved_extended) {
                        log('‚úÖ IA preservou mensagem estendida do True Peak', 'success');
                    } else {
                        log('‚ö†Ô∏è IA pode ter alterado mensagem do True Peak', 'warning');
                    }
                    
                }).catch(error => {
                    log(`ü§ñ AI Layer n√£o configurada ou erro: ${error.message}`, 'warning');
                });
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema de testes True Peak inicializado', 'success');
            verificarSistema();
        });
    </script>
</body>
</html>