<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Valida√ß√£o Corre√ß√£o Bandas Espectrais dBFS</title>
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 20px; 
            background: #1e1e1e; 
            color: #ffffff; 
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { 
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
        }
        .test-section { 
            background: #2d2d2d; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            border-left: 4px solid #27ae60; 
        }
        .validation { 
            background: #3d3d3d; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
        }
        .pass { color: #27ae60; font-weight: bold; }
        .fail { color: #e74c3c; font-weight: bold; }
        .info { color: #3498db; }
        .btn { 
            background: #27ae60; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px; 
        }
        .btn:hover { background: #2ecc71; }
        .metrics { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .metric { 
            background: #3d3d3d; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        pre { 
            background: #2d2d2d; 
            padding: 15px; 
            border-radius: 8px; 
            overflow-x: auto; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úÖ Valida√ß√£o das Corre√ß√µes dBFS</h1>
            <p>Testar se as corre√ß√µes garantem: Bandas ‚â§ 0 dBFS, True Peak pode > 0 dBTP, Deltas real√≠sticos</p>
        </div>

        <div class="test-section">
            <h2>üéµ Upload de Arquivo de Teste</h2>
            <input type="file" id="audioFile" accept="audio/*" class="btn">
            <button onclick="validateCorrections()" class="btn">üî¨ Validar Corre√ß√µes</button>
        </div>

        <div id="validationResults"></div>

        <div class="test-section">
            <h2>üìã Regras de Valida√ß√£o</h2>
            <div class="validation">
                <h3>‚úÖ Regra 1: Bandas dBFS ‚â§ 0</h3>
                <p>Todas as bandas espectrais devem ter valores negativos ou zero em dBFS</p>
            </div>
            <div class="validation">
                <h3>‚úÖ Regra 2: True Peak pode > 0 dBTP</h3>
                <p>True Peak √© permitido ser positivo em √°udio clipado (normal)</p>
            </div>
            <div class="validation">
                <h3>‚úÖ Regra 3: Deltas Real√≠sticos</h3>
                <p>Deltas vs targets devem estar na faixa ¬±1 a ¬±6 dB (t√≠pico funk mandela)</p>
            </div>
            <div class="validation">
                <h3>‚úÖ Regra 4: Energy % Consistente</h3>
                <p>Percentuais de energia devem somar aproximadamente 100%</p>
            </div>
        </div>

        <div class="test-section">
            <h2>üéØ Targets de Refer√™ncia (Funk Mandela)</h2>
            <div class="metrics">
                <div class="metric">
                    <h4>Sub</h4>
                    <div>Target: -17.3dB</div>
                    <div>Toler√¢ncia: ¬±2.5dB</div>
                </div>
                <div class="metric">
                    <h4>Bass</h4>
                    <div>Target: -17.7dB</div>
                    <div>Toler√¢ncia: ¬±2.5dB</div>
                </div>
                <div class="metric">
                    <h4>Mid</h4>
                    <div>Target: -17.9dB</div>
                    <div>Toler√¢ncia: ¬±2.5dB</div>
                </div>
                <div class="metric">
                    <h4>Presence</h4>
                    <div>Target: -34.0dB</div>
                    <div>Toler√¢ncia: ¬±3.5dB</div>
                </div>
            </div>
        </div>
    </div>

    <script src="audio-analyzer.js"></script>
    
    <script>
    let audioAnalyzer = new AudioAnalyzer();

    async function validateCorrections() {
        const fileInput = document.getElementById('audioFile');
        if (!fileInput.files[0]) {
            alert('Selecione um arquivo de √°udio primeiro');
            return;
        }

        const validationResults = document.getElementById('validationResults');
        validationResults.innerHTML = '<div class="validation">üîÑ Processando e validando...</div>';

        try {
            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            console.log('üéµ === VALIDA√á√ÉO DAS CORRE√á√ïES ===');
            console.log('Arquivo:', file.name);

            const leftChannel = audioBuffer.getChannelData(0);
            
            // Executar an√°lise com corre√ß√µes
            const spectralResult = audioAnalyzer.calculateSpectralBalance(leftChannel, audioBuffer.sampleRate);
            
            if (spectralResult) {
                const validationReport = validateRules(spectralResult);
                displayValidationResults(validationReport, spectralResult);
            } else {
                validationResults.innerHTML = '<div class="validation">‚ùå Erro na an√°lise espectral</div>';
            }

        } catch (error) {
            console.error('Erro na valida√ß√£o:', error);
            validationResults.innerHTML = `<div class="validation">‚ùå Erro: ${error.message}</div>`;
        }
    }

    function validateRules(result) {
        const report = {
            rule1: { name: "Bandas dBFS ‚â§ 0", passed: true, details: [] },
            rule2: { name: "True Peak valida√ß√£o", passed: true, details: [] },
            rule3: { name: "Deltas Real√≠sticos", passed: true, details: [] },
            rule4: { name: "Energy % Consistente", passed: true, details: [] }
        };

        // Regra 1: Validar que todas as bandas s√£o ‚â§ 0 dBFS
        result.bands.forEach(band => {
            if (band.rmsDb > 0.01) { // Pequena toler√¢ncia para erros de ponto flutuante
                report.rule1.passed = false;
                report.rule1.details.push(`${band.name}: ${band.rmsDb.toFixed(2)}dB > 0`);
            } else {
                report.rule1.details.push(`${band.name}: ${band.rmsDb.toFixed(2)}dB ‚úÖ`);
            }
        });

        // Regra 3: Simular deltas real√≠sticos (usando targets funk mandela)
        const funkMandelaTargets = {
            'Sub Bass': -17.3,
            'Bass': -17.7,
            'Mid': -17.9,
            'Presence': -34.0
        };

        result.bands.forEach(band => {
            const target = funkMandelaTargets[band.name];
            if (target) {
                const delta = band.rmsDb - target;
                if (Math.abs(delta) > 15) { // Deltas muito grandes indicam problema
                    report.rule3.passed = false;
                    report.rule3.details.push(`${band.name}: Œî=${delta.toFixed(1)}dB (muito grande)`);
                } else {
                    report.rule3.details.push(`${band.name}: Œî=${delta.toFixed(1)}dB ‚úÖ`);
                }
            }
        });

        // Regra 4: Validar que energias somam ~100%
        const totalEnergyPct = result.bands.reduce((sum, band) => sum + band.energyPct, 0);
        if (Math.abs(totalEnergyPct - 100) > 5) { // 5% de toler√¢ncia
            report.rule4.passed = false;
            report.rule4.details.push(`Total: ${totalEnergyPct.toFixed(1)}% (deveria ser ~100%)`);
        } else {
            report.rule4.details.push(`Total: ${totalEnergyPct.toFixed(1)}% ‚úÖ`);
        }

        return report;
    }

    function displayValidationResults(report, result) {
        let html = '<div class="test-section">';
        html += '<h2>üìä Resultados da Valida√ß√£o</h2>';

        // Resumo das regras
        html += '<div class="validation">';
        html += '<h3>üîç Resumo das Regras:</h3>';
        Object.values(report).forEach(rule => {
            const status = rule.passed ? '‚úÖ PASSOU' : '‚ùå FALHOU';
            const statusClass = rule.passed ? 'pass' : 'fail';
            html += `<div><span class="${statusClass}">${status}</span> - ${rule.name}</div>`;
        });
        html += '</div>';

        // Detalhes por banda
        html += '<div class="metrics">';
        result.bands.forEach(band => {
            const isValid = band.rmsDb <= 0.01;
            const statusClass = isValid ? 'pass' : 'fail';
            const statusText = isValid ? '‚úÖ V√ÅLIDO' : '‚ùå INV√ÅLIDO';
            
            html += '<div class="metric">';
            html += `<h4>${band.name}</h4>`;
            html += `<div class="${statusClass}">dBFS: ${band.rmsDb.toFixed(2)}dB</div>`;
            html += `<div>% Energia: ${band.energyPct.toFixed(1)}%</div>`;
            html += `<div class="info">${statusText}</div>`;
            html += '</div>';
        });
        html += '</div>';

        // Detalhes t√©cnicos
        html += '<div class="validation">';
        html += '<h3>üî¨ Detalhes T√©cnicos:</h3>';
        html += '<pre>';
        html += `Bandas processadas: ${result.bands.length}\n`;
        html += `FFT Size: ${result.fftSize}\n`;
        html += `Sample Rate: ${result.sampleRate}Hz\n`;
        html += `Frames processados: ${result.processedFrames}\n`;
        html += `Energia total: ${result.totalEnergy.toExponential(3)}\n`;
        
        if (result.bands[0].trackRmsDbfs) {
            html += `Track RMS Baseline: ${result.bands[0].trackRmsDbfs.toFixed(1)} dBFS\n`;
        }
        html += '</pre>';
        html += '</div>';

        // Valida√ß√£o geral
        const allPassed = Object.values(report).every(rule => rule.passed);
        html += '<div class="validation">';
        if (allPassed) {
            html += '<h3 class="pass">üéâ TODAS AS VALIDA√á√ïES PASSARAM!</h3>';
            html += '<p>As corre√ß√µes est√£o funcionando corretamente. Bandas espectrais agora produzem valores dBFS v√°lidos (‚â§ 0).</p>';
        } else {
            html += '<h3 class="fail">‚ö†Ô∏è ALGUMAS VALIDA√á√ïES FALHARAM</h3>';
            html += '<p>Verifique os detalhes acima para identificar problemas restantes.</p>';
        }
        html += '</div>';

        html += '</div>';
        
        document.getElementById('validationResults').innerHTML = html;
    }

    // Inicializa√ß√£o
    window.addEventListener('load', () => {
        console.log('‚úÖ Sistema de valida√ß√£o carregado');
        console.log('üìã Pronto para testar corre√ß√µes dBFS');
    });
    </script>
</body>
</html>