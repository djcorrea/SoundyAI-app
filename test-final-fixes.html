<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ TESTE FINAL: Ordena√ß√£o e Sub-Scores</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #0a0e1a; color: #e0e6ed; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-card { background: #141b2d; border: 1px solid #2a3441; border-radius: 8px; padding: 20px; margin: 15px 0; }
        .result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #0f4c3a; border-left: 4px solid #10b981; }
        .error { background: #4c1d1d; border-left: 4px solid #ef4444; }
        .warning { background: #4c3d1d; border-left: 4px solid #f59e0b; }
        .info { background: #1e3a8a; border-left: 4px solid #3b82f6; }
        .fix-applied { background: #0f3a0f; border: 2px solid #10b981; padding: 15px; border-radius: 8px; margin: 10px 0; }
        button { background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 8px; font-size: 14px; }
        button:hover { background: #047857; }
        pre { background: #0f1419; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 13px; border: 1px solid #374151; }
        .highlight { background: #fbbf24; color: #000; padding: 2px 6px; border-radius: 3px; font-weight: bold; }
        .suggestion-order { border: 1px solid #374151; margin: 5px 0; padding: 10px; background: #1f2937; border-radius: 4px; }
        .priority-1 { border-left: 4px solid #ef4444; }
        .priority-2 { border-left: 4px solid #f59e0b; }
        .priority-3 { border-left: 4px solid #10b981; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ TESTE FINAL: Ordena√ß√£o e Sub-Scores</h1>
        
        <div class="fix-applied">
            <h3>üîß CORRE√á√ïES APLICADAS:</h3>
            <div class="result success">‚úÖ <strong>Ordena√ß√£o Fixed:</strong> Mudou de <code>(a.priority||999)-(b.priority||999)</code> para <code>(b.priority||0)-(a.priority||0)</code></div>
            <div class="result success">‚úÖ <strong>Sub-Scores Fixed:</strong> Adicionado fallback para <code>__activeRefData</code> quando ausente</div>
            <div class="result info">üéØ <strong>True Peak</strong> agora deve aparecer PRIMEIRO (prioridade alta)</div>
            <div class="result info">üìä <strong>Sub-Scores</strong> agora devem aparecer mesmo sem refer√™ncia ativa</div>
        </div>

        <div class="test-card">
            <h2>üß™ TESTE DE ORDENA√á√ÉO</h2>
            <button onclick="testSuggestionOrdering()">üîç Testar Ordena√ß√£o de Sugest√µes</button>
            <div id="ordering-results"></div>
        </div>

        <div class="test-card">
            <h2>üìä TESTE DE SUB-SCORES</h2>
            <button onclick="testSubScores()">üìà Testar C√°lculo de Sub-Scores</button>
            <div id="subscores-results"></div>
        </div>

        <div class="test-card">
            <h2>‚úÖ TESTE INTEGRADO</h2>
            <button onclick="testIntegratedSystem()">üöÄ Testar Sistema Completo</button>
            <div id="integrated-results"></div>
        </div>
    </div>

    <!-- Carregar scripts necess√°rios -->
    <script src="public/lib/audio/features/scoring.js"></script>
    <script src="public/suggestion-scorer.js"></script>
    <script src="public/enhanced-suggestion-engine.js"></script>

    <script>
        function log(message, type = 'info') {
            const classes = { success: 'success', error: 'error', warning: 'warning', info: 'info' };
            return `<div class="result ${classes[type]}">${message}</div>`;
        }

        function testSuggestionOrdering() {
            let html = '<h3>üîç Teste de Ordena√ß√£o de Sugest√µes</h3>';
            
            try {
                if (!window.EnhancedSuggestionEngine) {
                    html += log('‚ùå Enhanced Suggestion Engine n√£o dispon√≠vel', 'error');
                    document.getElementById('ordering-results').innerHTML = html;
                    return;
                }
                
                const engine = new window.EnhancedSuggestionEngine();
                
                // Dados de teste com True Peak ALTO (deve ser primeiro)
                const testAnalysis = {
                    technicalData: {
                        lufs: { value: -16, lufs: -16 },           // Problema m√©dio
                        true_peak: { value: -0.2, true_peak: -0.2 }, // üö® PROBLEMA CR√çTICO
                        dr: { value: 8, dr: 8 },                   // Problema baixo
                        spectralBands: {
                            bass: { energy_db: -18 }               // Problema baixo
                        }
                    }
                };
                
                const testReference = {
                    lufs_target: -14, tol_lufs: 1,
                    true_peak_target: -1, tol_true_peak: 0.2,
                    dr_target: 12, tol_dr: 2,
                    spectralBands: {
                        bass: { target_db: -12, tol_db: 2 }
                    }
                };
                
                // Gerar sugest√µes
                const suggestions = engine.generateSuggestions(testAnalysis, testReference);
                
                html += log(`üìä Total de sugest√µes geradas: ${suggestions.length}`, 'info');
                
                // Verificar ordena√ß√£o
                suggestions.slice(0, 5).forEach((suggestion, index) => {
                    const priorityLevel = suggestion.priority > 8 ? 'priority-1' : 
                                         suggestion.priority > 5 ? 'priority-2' : 'priority-3';
                    
                    const isFirstAndTruePeak = index === 0 && (suggestion.type === 'reference_true_peak' || suggestion.type === 'heuristic_true_peak');
                    
                    html += `<div class="suggestion-order ${priorityLevel}">`;
                    html += `<strong>${index + 1}¬∞</strong> ${suggestion.type.toUpperCase()} `;
                    html += `(Prioridade: ${suggestion.priority?.toFixed(1) || 'N/A'}) `;
                    if (isFirstAndTruePeak) {
                        html += `<span style="color: #10b981; font-weight: bold;">‚úÖ CORRETO</span>`;
                    } else if (index === 0) {
                        html += `<span style="color: #f59e0b; font-weight: bold;">‚ö†Ô∏è True Peak deveria ser primeiro</span>`;
                    }
                    html += `<br><small>${suggestion.message?.substring(0, 80)}...</small>`;
                    html += `</div>`;
                });
                
                // Verificar se True Peak est√° primeiro
                const firstSuggestion = suggestions[0];
                const truePeakFirst = firstSuggestion && (firstSuggestion.type === 'reference_true_peak' || firstSuggestion.type === 'heuristic_true_peak');
                
                html += truePeakFirst ? 
                    log('‚úÖ ORDENA√á√ÉO CORRETA: True Peak aparece primeiro!', 'success') :
                    log('‚ùå ORDENA√á√ÉO INCORRETA: True Peak n√£o est√° primeiro', 'error');
                
            } catch (error) {
                html += log(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
            
            document.getElementById('ordering-results').innerHTML = html;
        }

        function testSubScores() {
            let html = '<h3>üìà Teste de Sub-Scores</h3>';
            
            try {
                // Simular dados de an√°lise t√≠picos
                const mockAnalysis = {
                    technicalData: {
                        lufs: { value: -16, lufs: -16 },
                        true_peak: { value: -0.5, true_peak: -0.5 },
                        dr: { value: 8, dr: 8 },
                        lra: { value: 4, lra: 4 },
                        spectralBands: {
                            bass: { energy_db: -15 },
                            mid: { energy_db: -10 },
                            brilliance: { energy_db: -20 }
                        },
                        stereo: { 
                            correlation: 0.8,
                            width: 0.9,
                            balance: 0.1,
                            separation: 85
                        }
                    }
                };
                
                // Simular refer√™ncia
                const mockReference = {
                    lufs_target: -14, tol_lufs: 1,
                    true_peak_target: -1, tol_true_peak: 0.2,
                    dr_target: 12, tol_dr: 2,
                    lra_target: 6, tol_lra: 2,
                    spectralBands: {
                        bass: { target_db: -12, tol_db: 2 },
                        mid: { target_db: -8, tol_db: 2 },
                        brilliance: { target_db: -18, tol_db: 3 }
                    }
                };
                
                // Verificar se as fun√ß√µes de c√°lculo de score existem
                const functions = [
                    'calculateLoudnessScore',
                    'calculateDynamicsScore',
                    'calculateStereoScore',
                    'calculateFrequencyScore',
                    'calculateTechnicalScore'
                ];
                
                html += '<h4>üîç Fun√ß√µes de Sub-Score Dispon√≠veis:</h4>';
                functions.forEach(funcName => {
                    const exists = typeof window[funcName] === 'function';
                    html += log(`${funcName}: ${exists ? 'DISPON√çVEL' : 'AUSENTE'}`, exists ? 'success' : 'error');
                });
                
                // Testar calculateMetricScore (fun√ß√£o base)
                if (typeof window.calculateMetricScore === 'function') {
                    const testScores = {
                        'LUFS': window.calculateMetricScore(-16, -14, 1, 'lufs'),
                        'True Peak': window.calculateMetricScore(-0.5, -1, 0.2, 'true_peak'),
                        'DR': window.calculateMetricScore(8, 12, 2, 'dr')
                    };
                    
                    html += '<h4>üìä Scores Calculados:</h4>';
                    Object.entries(testScores).forEach(([metric, score]) => {
                        html += log(`${metric}: ${score}% ${score >= 70 ? '‚úÖ' : score >= 50 ? '‚ö†Ô∏è' : '‚ùå'}`, 
                                   score >= 70 ? 'success' : score >= 50 ? 'warning' : 'error');
                    });
                } else {
                    html += log('‚ùå calculateMetricScore n√£o dispon√≠vel', 'error');
                }
                
                // Testar se fallback de refer√™ncia funciona
                const hasWindowAudioRefs = typeof window.audioRefs === 'object' && window.audioRefs;
                html += log(`Refer√™ncias embarcadas (window.audioRefs): ${hasWindowAudioRefs ? 'DISPON√çVEL' : 'AUSENTE'}`, 
                           hasWindowAudioRefs ? 'success' : 'warning');
                
                if (hasWindowAudioRefs) {
                    const genres = Object.keys(window.audioRefs);
                    html += log(`G√™neros dispon√≠veis: ${genres.join(', ')}`, 'info');
                }
                
            } catch (error) {
                html += log(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
            
            document.getElementById('subscores-results').innerHTML = html;
        }

        function testIntegratedSystem() {
            let html = '<h3>üöÄ Teste do Sistema Integrado</h3>';
            
            try {
                // Verificar se todos os componentes est√£o carregados
                const components = {
                    'Enhanced Suggestion Engine': typeof window.EnhancedSuggestionEngine === 'function',
                    'Suggestion Scorer': typeof window.SuggestionScorer === 'function',
                    'calculateMetricScore': typeof window.calculateMetricScore === 'function',
                    'Inst√¢ncia Global Scorer': typeof window.suggestionScorer === 'object'
                };
                
                html += '<h4>üîß Componentes do Sistema:</h4>';
                let allComponentsOk = true;
                Object.entries(components).forEach(([name, exists]) => {
                    html += log(`${name}: ${exists ? 'OK' : 'AUSENTE'}`, exists ? 'success' : 'error');
                    if (!exists) allComponentsOk = false;
                });
                
                if (allComponentsOk) {
                    html += log('‚úÖ TODOS os componentes est√£o funcionais!', 'success');
                    
                    // Testar fluxo completo
                    html += '<h4>üîÑ Teste de Fluxo Completo:</h4>';
                    
                    // 1. Scores educativos
                    const educationalScore = window.calculateMetricScore(-16.5, -14, 1, 'lufs');
                    html += log(`1. Score educativo LUFS (-16.5 vs -14): ${educationalScore}%`, 
                               educationalScore >= 70 ? 'success' : 'warning');
                    
                    // 2. Mensagem educativa com limita√ß√£o
                    const educationalMessage = window.suggestionScorer.generateSuggestion({
                        type: 'lufs',
                        value: -16.5,
                        target: -14,
                        tolerance: 1,
                        severity: 'medium',
                        metricType: 'lufs'
                    });
                    
                    const adjustmentLimited = Math.abs(educationalMessage.adjustmentValue) <= 6;
                    html += log(`2. Mensagem educativa LUFS: "${educationalMessage.message.substring(0, 50)}..."`, 'info');
                    html += log(`   Ajuste sugerido: ${educationalMessage.adjustmentValue} dB (limitado ‚â§6dB: ${adjustmentLimited ? '‚úÖ' : '‚ùå'})`, 
                               adjustmentLimited ? 'success' : 'error');
                    
                    // 3. Ordena√ß√£o inteligente
                    const engine = new window.EnhancedSuggestionEngine();
                    const testSuggestions = engine.generateSuggestions({
                        technicalData: {
                            lufs: { value: -16, lufs: -16 },
                            true_peak: { value: -0.1, true_peak: -0.1 }, // CR√çTICO
                            dr: { value: 9, dr: 9 }
                        }
                    }, {
                        lufs_target: -14, tol_lufs: 1,
                        true_peak_target: -1, tol_true_peak: 0.2,
                        dr_target: 12, tol_dr: 2
                    });
                    
                    const firstIsTruePeak = testSuggestions[0] && 
                        (testSuggestions[0].type === 'reference_true_peak' || testSuggestions[0].type === 'heuristic_true_peak');
                    
                    html += log(`3. Ordena√ß√£o inteligente: Primeira sugest√£o = ${testSuggestions[0]?.type || 'N/A'}`, 
                               firstIsTruePeak ? 'success' : 'warning');
                    html += log(`   True Peak est√° primeiro: ${firstIsTruePeak ? '‚úÖ SIM' : '‚ùå N√ÉO'}`, 
                               firstIsTruePeak ? 'success' : 'error');
                    
                    // Resumo final
                    const systemHealthy = educationalScore > 0 && adjustmentLimited && firstIsTruePeak;
                    html += '<br><div class="fix-applied">';
                    html += `<h4>üìã RESULTADO FINAL:</h4>`;
                    html += systemHealthy ? 
                        log('üéâ SISTEMA COMPLETAMENTE FUNCIONAL! Todos os recursos educativos restaurados.', 'success') :
                        log('‚ö†Ô∏è Sistema parcialmente funcional. Algumas corre√ß√µes podem ser necess√°rias.', 'warning');
                    html += '</div>';
                    
                } else {
                    html += log('‚ùå Sistema com componentes ausentes - verificar carregamento', 'error');
                }
                
            } catch (error) {
                html += log(`‚ùå Erro no teste integrado: ${error.message}`, 'error');
            }
            
            document.getElementById('integrated-results').innerHTML = html;
        }

        // Auto-executar teste b√°sico ao carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('üéØ Executando teste autom√°tico...');
                testSubScores();
            }, 1000);
        });
    </script>
</body>
</html>