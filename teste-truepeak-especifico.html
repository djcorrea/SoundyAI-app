<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Teste True Peak Espec√≠fico</title>
    <style>
        body { 
            font-family: monospace; 
            background: #000; 
            color: #0f0; 
            padding: 20px; 
        }
        .test { 
            background: #111; 
            padding: 10px; 
            margin: 10px 0; 
            border-left: 3px solid #0f0; 
        }
        .result { 
            background: #030; 
            color: #8f8; 
            font-weight: bold; 
        }
    </style>
</head>
<body>
    <h1>üéØ Teste True Peak Espec√≠fico</h1>
    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');
        
        function addResult(test, result) {
            const div = document.createElement('div');
            div.className = 'test result';
            div.innerHTML = `<strong>${test}:</strong> ${result}`;
            resultsDiv.appendChild(div);
        }
        
        // Simular exatamente o que acontece no frontend
        const mockAnalysisData = {
            technicalData: {
                truePeakDbtp: -3.1,
                lufsIntegrated: -14.2,
                peak: -3.34
            },
            metrics: {
                truePeakDbtp: -3.1,
                lufs_integrated: -14.2,
                peak_db: -3.34
            }
        };
        
        // Fun√ß√£o getNestedValue exata do frontend
        const getNestedValue = (obj, path) => {
            return path.split('.').reduce((current, key) => current?.[key], obj);
        };
        
        // Fun√ß√£o getMetric exata do frontend
        const getMetric = (metricPath, fallbackPath = null) => {
            console.log('üéØ DEBUG TRUE PEAK:', {
                metricPath,
                fallbackPath,
                centralizedValue: mockAnalysisData.metrics && getNestedValue(mockAnalysisData.metrics, metricPath),
                legacyValue: fallbackPath ? getNestedValue(mockAnalysisData.technicalData, fallbackPath) : getNestedValue(mockAnalysisData.technicalData, metricPath),
                analysis_metrics: mockAnalysisData.metrics,
                analysis_technicalData: mockAnalysisData.technicalData
            });
            
            // Prioridade: metrics centralizadas > technicalData legado > fallback
            const centralizedValue = mockAnalysisData.metrics && getNestedValue(mockAnalysisData.metrics, metricPath);
            if (Number.isFinite(centralizedValue)) {
                return centralizedValue;
            }
            
            // Fallback para technicalData legado
            const legacyValue = fallbackPath ? getNestedValue(mockAnalysisData.technicalData, fallbackPath) : getNestedValue(mockAnalysisData.technicalData, metricPath);
            return Number.isFinite(legacyValue) ? legacyValue : null;
        };
        
        const safeFixed = (v, d = 1) => (Number.isFinite(v) ? v.toFixed(d) : '‚Äî');
        
        // Testar fun√ß√£o getMetric
        addResult('getMetric("truePeakDbtp", "truePeakDbtp")', getMetric('truePeakDbtp', 'truePeakDbtp'));
        addResult('getMetric("peak_db", "peak")', getMetric('peak_db', 'peak'));
        addResult('getMetric("lufs_integrated", "lufsIntegrated")', getMetric('lufs_integrated', 'lufsIntegrated'));
        
        // Testar como seria no frontend
        const truePeakValue = getMetric('truePeakDbtp', 'truePeakDbtp');
        addResult('Number.isFinite(truePeakValue)', Number.isFinite(truePeakValue));
        addResult('truePeakValue', truePeakValue);
        addResult('safeFixed(truePeakValue)', safeFixed(truePeakValue));
        
        // Testar o HTML que seria gerado
        let html;
        if (Number.isFinite(truePeakValue)) {
            html = `<strong style="color: #00ff92; font-size: 14px;">${safeFixed(truePeakValue)} dBTP</strong>`;
        } else {
            html = '<span style="color: #ffd700;">‚è≥ Calculando...</span>';
        }
        
        addResult('HTML gerado', html);
        
        const testDiv = document.createElement('div');
        testDiv.className = 'test';
        testDiv.innerHTML = `<strong>Preview:</strong> üéØ TRUE PEAK (FFmpeg) ${html}`;
        resultsDiv.appendChild(testDiv);
        
        // Testar todos os tipos de dados poss√≠veis
        const testValues = [-3.1, null, undefined, '--', 'calculando', 0, -0.5];
        testValues.forEach(val => {
            addResult(`Number.isFinite(${val})`, Number.isFinite(val));
        });
    </script>
</body>
</html>