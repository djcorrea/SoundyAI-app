<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Teste: Sistema de Scoring Auditado e Corrigido</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        h1, h2, h3 {
            color: #4CAF50;
            text-align: center;
        }
        
        .test-section {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        
        .test-case {
            background: #3d3d3d;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 3px solid #2196F3;
        }
        
        .score-display {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            color: white;
            margin: 5px;
        }
        
        .score-excellent { background: #4CAF50; }
        .score-good { background: #8BC34A; }
        .score-average { background: #FF9800; }
        .score-poor { background: #f44336; }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: #2d2d2d;
        }
        
        .result-table th,
        .result-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #444;
        }
        
        .result-table th {
            background: #4CAF50;
            color: white;
        }
        
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .curve-visualization {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .curve-point {
            background: #444;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .curve-point.perfect { border-color: #4CAF50; }
        .curve-point.good { border-color: #8BC34A; }
        .curve-point.average { border-color: #FF9800; }
        .curve-point.poor { border-color: #f44336; }
        
        .weight-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .weight-item {
            background: #444;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .scenario-card {
            background: #3d3d3d;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid;
        }
        
        .scenario-perfect { border-left-color: #4CAF50; }
        .scenario-good { border-left-color: #8BC34A; }
        .scenario-average { border-left-color: #FF9800; }
        .scenario-poor { border-left-color: #f44336; }
    </style>
</head>
<body>
    <h1>üîß Teste: Sistema de Scoring Auditado e Corrigido</h1>
    <p style="text-align: center; color: #ccc;">
        Valida√ß√£o da curva de penaliza√ß√£o justa e pesos corrigidos por g√™nero
    </p>

    <!-- Se√ß√£o 1: Teste da Curva de Penaliza√ß√£o Graduada -->
    <div class="test-section">
        <h2>üìà Teste 1: Curva de Penaliza√ß√£o Graduada</h2>
        <p>Valida√ß√£o dos pontos de refer√™ncia: 1x=100, 1.5x=~80, 2x=~60, 3x=~40, >3x=~20</p>
        
        <button onclick="testGradualCurve()">üî¨ Executar Teste de Curva</button>
        
        <div class="curve-visualization" id="curveVisualization" style="display: none;">
        </div>
        
        <table class="result-table" id="curveTestTable" style="display: none;">
            <thead>
                <tr>
                    <th>M√∫ltiplo da Toler√¢ncia</th>
                    <th>Score Obtido</th>
                    <th>Score Esperado</th>
                    <th>Varia√ß√£o</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="curveTestBody">
            </tbody>
        </table>
        
        <div class="console-output" id="curveConsole" style="display: none;"></div>
    </div>

    <!-- Se√ß√£o 2: Teste de Scores T√©cnicos Graduados -->
    <div class="test-section">
        <h2>üîß Teste 2: Scores T√©cnicos Graduados</h2>
        <p>Verifica√ß√£o se problemas t√©cnicos s√£o penalizados gradualmente (nunca zero, exceto falhas cr√≠ticas)</p>
        
        <button onclick="testTechnicalGrading()">üî¨ Executar Teste T√©cnico</button>
        
        <table class="result-table" id="technicalTestTable" style="display: none;">
            <thead>
                <tr>
                    <th>Tipo de Problema</th>
                    <th>Valor Testado</th>
                    <th>Score Obtido</th>
                    <th>Faixa Esperada</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="technicalTestBody">
            </tbody>
        </table>
        
        <div class="console-output" id="technicalConsole" style="display: none;"></div>
    </div>

    <!-- Se√ß√£o 3: Teste de Pesos por G√™nero Corrigidos -->
    <div class="test-section">
        <h2>‚öñÔ∏è Teste 3: Pesos por G√™nero (Conforme Especifica√ß√£o)</h2>
        <p>Valida√ß√£o dos pesos exatos conforme solicitado</p>
        
        <button onclick="testGenreWeightsFixed()">üî¨ Executar Teste de Pesos</button>
        
        <div class="weight-display" id="weightsDisplay" style="display: none;">
        </div>
        
        <div class="console-output" id="weightsConsole" style="display: none;"></div>
    </div>

    <!-- Se√ß√£o 4: Teste de Cen√°rios Realistas -->
    <div class="test-section">
        <h2>üéØ Teste 4: Cen√°rios de Mix Realistas</h2>
        <p>Valida√ß√£o se os scores finais refletem a qualidade real esperada</p>
        
        <button onclick="testRealisticScenarios()">üî¨ Executar Teste de Cen√°rios</button>
        
        <div class="scenario-grid" id="scenarioGrid" style="display: none;">
        </div>
        
        <div class="console-output" id="scenarioConsole" style="display: none;"></div>
    </div>

    <script>
        // Implementar a fun√ß√£o corrigida de scoring
        function calculateMetricScoreFixed(actualValue, targetValue, tolerance) {
            if (!Number.isFinite(actualValue) || !Number.isFinite(targetValue) || !Number.isFinite(tolerance) || tolerance <= 0) {
                return null;
            }
            
            const diff = Math.abs(actualValue - targetValue);
            
            // Dentro da toler√¢ncia = 100 pontos
            if (diff <= tolerance) {
                return 100;
            }
            
            // Curva de penaliza√ß√£o graduada e justa
            const toleranceRatio = diff / tolerance;
            
            let score;
            if (toleranceRatio <= 1.5) {
                // Entre 1x e 1.5x toler√¢ncia: decaimento suave de 100 para 80
                score = 100 - (toleranceRatio - 1.0) * 40; // 40 pontos em 0.5x toler√¢ncia
            } else if (toleranceRatio <= 2.0) {
                // Entre 1.5x e 2x toler√¢ncia: de 80 para 60
                score = 80 - (toleranceRatio - 1.5) * 40; // 20 pontos em 0.5x toler√¢ncia
            } else if (toleranceRatio <= 3.0) {
                // Entre 2x e 3x toler√¢ncia: de 60 para 40
                score = 60 - (toleranceRatio - 2.0) * 20; // 20 pontos em 1x toler√¢ncia
            } else {
                // Acima de 3x toler√¢ncia: m√≠nimo de 20
                score = 20;
            }
            
            return Math.max(20, Math.min(100, Math.round(score)));
        }
        
        // Pesos corrigidos conforme especifica√ß√£o
        const FIXED_GENRE_WEIGHTS = {
            'funk_mandela': {
                loudness: 0.32, dinamica: 0.23, frequencia: 0.20, estereo: 0.15, tecnico: 0.10
            },
            'trap': {
                loudness: 0.25, frequencia: 0.30, estereo: 0.20, dinamica: 0.15, tecnico: 0.10
            },
            'trance': {
                loudness: 0.25, frequencia: 0.30, estereo: 0.20, dinamica: 0.15, tecnico: 0.10
            },
            'eletronico': {
                frequencia: 0.30, estereo: 0.25, loudness: 0.20, dinamica: 0.15, tecnico: 0.10
            }
        };
        
        function testGradualCurve() {
            const visualization = document.getElementById('curveVisualization');
            const table = document.getElementById('curveTestTable');
            const body = document.getElementById('curveTestBody');
            const console = document.getElementById('curveConsole');
            
            visualization.style.display = 'grid';
            table.style.display = 'table';
            console.style.display = 'block';
            
            body.innerHTML = '';
            console.innerHTML = '';
            visualization.innerHTML = '';
            
            const targetValue = -17.3;
            const tolerance = 3.0;
            
            const testPoints = [
                { ratio: 0.0, expected: 100, desc: "Exato no alvo" },
                { ratio: 1.0, expected: 100, desc: "1x toler√¢ncia" },
                { ratio: 1.5, expected: 80, desc: "1.5x toler√¢ncia" },
                { ratio: 2.0, expected: 60, desc: "2x toler√¢ncia" },
                { ratio: 2.5, expected: 50, desc: "2.5x toler√¢ncia" },
                { ratio: 3.0, expected: 40, desc: "3x toler√¢ncia" },
                { ratio: 4.0, expected: 20, desc: "4x toler√¢ncia" }
            ];
            
            console.innerHTML += `üîß Testando curva de penaliza√ß√£o graduada\n`;
            console.innerHTML += `Target: ${targetValue}, Toler√¢ncia: ${tolerance}\n\n`;
            
            testPoints.forEach(point => {
                const actualValue = targetValue + (point.ratio * tolerance);
                const score = calculateMetricScoreFixed(actualValue, targetValue, tolerance);
                const variance = Math.abs(score - point.expected);
                const isCorrect = variance <= 5; // Toler√¢ncia de ¬±5 pontos
                
                // Visualiza√ß√£o
                const pointDiv = document.createElement('div');
                pointDiv.className = `curve-point ${getScoreClass(score).replace('score-', '')}`;
                pointDiv.innerHTML = `
                    <div><strong>${point.desc}</strong></div>
                    <div>${point.ratio}x toler√¢ncia</div>
                    <div class="score-display ${getScoreClass(score)}">${score}%</div>
                    <div style="font-size: 11px; color: #ccc;">Esperado: ${point.expected}%</div>
                `;
                visualization.appendChild(pointDiv);
                
                // Tabela
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${point.desc} (${point.ratio}x)</td>
                    <td><span class="score-display ${getScoreClass(score)}">${score}%</span></td>
                    <td>${point.expected}%</td>
                    <td style="color: ${variance <= 5 ? '#4CAF50' : '#f44336'}">¬±${variance}%</td>
                    <td>${isCorrect ? '‚úÖ OK' : '‚ùå Erro'}</td>
                `;
                body.appendChild(row);
                
                console.innerHTML += `${point.desc}: ${score}% (esperado: ${point.expected}%, varia√ß√£o: ¬±${variance}%) - ${isCorrect ? 'OK' : 'ERRO'}\n`;
            });
        }
        
        function testTechnicalGrading() {
            const table = document.getElementById('technicalTestTable');
            const body = document.getElementById('technicalTestBody');
            const console = document.getElementById('technicalConsole');
            
            table.style.display = 'table';
            console.style.display = 'block';
            
            body.innerHTML = '';
            console.innerHTML = '';
            
            const technicalTests = [
                { type: "Clipping", value: 0.0005, expectedRange: "90-100%", description: "‚â§0.1% (perfeito)" },
                { type: "Clipping", value: 0.005, expectedRange: "70-90%", description: "0.1-1% (bom)" },
                { type: "Clipping", value: 0.03, expectedRange: "30-50%", description: "1-5% (ruim)" },
                { type: "Clipping", value: 0.08, expectedRange: "10-20%", description: ">5% (cr√≠tico)" },
                { type: "DC Offset", value: 0.005, expectedRange: "90-100%", description: "‚â§1% (perfeito)" },
                { type: "DC Offset", value: 0.03, expectedRange: "70-90%", description: "1-5% (bom)" },
                { type: "DC Offset", value: 0.08, expectedRange: "40-60%", description: "5-10% (ruim)" },
                { type: "DC Offset", value: 0.15, expectedRange: "20-30%", description: ">10% (cr√≠tico)" },
                { type: "THD", value: 0.005, expectedRange: "90-100%", description: "‚â§1% (perfeito)" },
                { type: "THD", value: 0.02, expectedRange: "70-90%", description: "1-3% (bom)" },
                { type: "THD", value: 0.08, expectedRange: "40-60%", description: "3-10% (ruim)" },
                { type: "THD", value: 0.15, expectedRange: "20-30%", description: ">10% (cr√≠tico)" }
            ];
            
            console.innerHTML += `üîß Testando penaliza√ß√£o graduada de problemas t√©cnicos\n\n`;
            
            technicalTests.forEach(test => {
                let score;
                
                // Simular l√≥gica t√©cnica corrigida
                if (test.type === "Clipping") {
                    if (test.value <= 0.001) score = 100;
                    else if (test.value <= 0.01) score = 80;
                    else if (test.value <= 0.05) score = 40;
                    else score = 10;
                } else if (test.type === "DC Offset") {
                    if (test.value <= 0.01) score = 100;
                    else if (test.value <= 0.05) score = 80;
                    else if (test.value <= 0.1) score = 50;
                    else score = 20;
                } else if (test.type === "THD") {
                    if (test.value <= 0.01) score = 100;
                    else if (test.value <= 0.03) score = 80;
                    else if (test.value <= 0.1) score = 50;
                    else score = 20;
                }
                
                const rangeNumbers = test.expectedRange.match(/(\d+)-(\d+)/);
                const isInRange = rangeNumbers && score >= parseInt(rangeNumbers[1]) && score <= parseInt(rangeNumbers[2]);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${test.type}</td>
                    <td>${(test.value * 100).toFixed(2)}% (${test.description})</td>
                    <td><span class="score-display ${getScoreClass(score)}">${score}%</span></td>
                    <td>${test.expectedRange}</td>
                    <td>${isInRange ? '‚úÖ OK' : '‚ùå Fora da faixa'}</td>
                `;
                body.appendChild(row);
                
                console.innerHTML += `${test.type} ${(test.value*100).toFixed(2)}%: ${score}% (esperado: ${test.expectedRange}) - ${isInRange ? 'OK' : 'ERRO'}\n`;
            });
        }
        
        function testGenreWeightsFixed() {
            const display = document.getElementById('weightsDisplay');
            const console = document.getElementById('weightsConsole');
            
            display.style.display = 'grid';
            console.style.display = 'block';
            
            display.innerHTML = '';
            console.innerHTML = '';
            
            console.innerHTML += `‚öñÔ∏è Valida√ß√£o dos pesos corrigidos conforme especifica√ß√£o\n\n`;
            
            Object.entries(FIXED_GENRE_WEIGHTS).forEach(([genre, weights]) => {
                const total = Object.values(weights).reduce((sum, w) => sum + w, 0);
                const isExact = Math.abs(total - 1.0) < 0.001;
                
                const weightItem = document.createElement('div');
                weightItem.className = 'weight-item';
                weightItem.innerHTML = `
                    <h4>${genre.replace('_', ' ').toUpperCase()}</h4>
                    <div style="text-align: left; font-size: 13px; margin: 10px 0;">
                        <div>Loudness: <strong>${(weights.loudness * 100).toFixed(0)}%</strong></div>
                        <div>Din√¢mica: <strong>${(weights.dinamica * 100).toFixed(0)}%</strong></div>
                        <div>Frequ√™ncia: <strong>${(weights.frequencia * 100).toFixed(0)}%</strong></div>
                        <div>Est√©reo: <strong>${(weights.estereo * 100).toFixed(0)}%</strong></div>
                        <div>T√©cnico: <strong>${(weights.tecnico * 100).toFixed(0)}%</strong></div>
                    </div>
                    <hr style="border-color: #666;">
                    <div style="color: ${isExact ? '#4CAF50' : '#f44336'};">
                        <strong>Total: ${(total * 100).toFixed(1)}% ${isExact ? '‚úÖ' : '‚ùå'}</strong>
                    </div>
                `;
                display.appendChild(weightItem);
                
                console.innerHTML += `${genre}: Total=${(total*100).toFixed(1)}% ${isExact ? '‚úÖ' : '‚ùå'}\n`;
                console.innerHTML += `  - Loudness: ${(weights.loudness*100).toFixed(0)}%, Din√¢mica: ${(weights.dinamica*100).toFixed(0)}%, Frequ√™ncia: ${(weights.frequencia*100).toFixed(0)}%\n`;
            });
        }
        
        function testRealisticScenarios() {
            const grid = document.getElementById('scenarioGrid');
            const console = document.getElementById('scenarioConsole');
            
            grid.style.display = 'grid';
            console.style.display = 'block';
            
            grid.innerHTML = '';
            console.innerHTML = '';
            
            const scenarios = [
                {
                    name: "Mix Bem Mixado (pequenos desvios)",
                    subScores: { loudness: 95, dinamica: 90, frequencia: 88, estereo: 92, tecnico: 95 },
                    expectedRange: "60-80%",
                    description: "LUFS perfeito, 1 banda ligeiramente fora",
                    class: "scenario-perfect"
                },
                {
                    name: "Mix Aud√≠vel (alguns problemas)",
                    subScores: { loudness: 75, dinamica: 70, frequencia: 65, estereo: 80, tecnico: 85 },
                    expectedRange: "60-80%",
                    description: "Algumas m√©tricas fora da toler√¢ncia",
                    class: "scenario-good"
                },
                {
                    name: "Mix Fora do Padr√£o",
                    subScores: { loudness: 50, dinamica: 45, frequencia: 60, estereo: 55, tecnico: 40 },
                    expectedRange: "30-50%",
                    description: "V√°rias m√©tricas problem√°ticas",
                    class: "scenario-average"
                },
                {
                    name: "Mix Muito Ruim",
                    subScores: { loudness: 25, dinamica: 30, frequencia: 35, estereo: 20, tecnico: 15 },
                    expectedRange: "10-30%",
                    description: "M√∫ltiplos problemas s√©rios",
                    class: "scenario-poor"
                }
            ];
            
            console.innerHTML += `üéØ Testando cen√°rios realistas de mixing\n\n`;
            
            scenarios.forEach(scenario => {
                // Calcular score final usando pesos do Funk Mandela
                const weights = FIXED_GENRE_WEIGHTS.funk_mandela;
                const finalScore = Math.round(
                    (scenario.subScores.loudness * weights.loudness) +
                    (scenario.subScores.dinamica * weights.dinamica) +
                    (scenario.subScores.frequencia * weights.frequencia) +
                    (scenario.subScores.estereo * weights.estereo) +
                    (scenario.subScores.tecnico * weights.tecnico)
                );
                
                const rangeNumbers = scenario.expectedRange.match(/(\d+)-(\d+)/);
                const isInRange = rangeNumbers && finalScore >= parseInt(rangeNumbers[1]) && finalScore <= parseInt(rangeNumbers[2]);
                
                const card = document.createElement('div');
                card.className = `scenario-card ${scenario.class}`;
                card.innerHTML = `
                    <h4>${scenario.name}</h4>
                    <div style="margin: 10px 0;">
                        <div class="score-display ${getScoreClass(finalScore)}" style="font-size: 18px;">
                            ${finalScore}%
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #ccc; margin: 10px 0;">
                        ${scenario.description}
                    </div>
                    <div style="font-size: 11px; margin: 10px 0;">
                        Sub-scores: L:${scenario.subScores.loudness}%, D:${scenario.subScores.dinamica}%, 
                        F:${scenario.subScores.frequencia}%, E:${scenario.subScores.estereo}%, T:${scenario.subScores.tecnico}%
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                        <div>Esperado: ${scenario.expectedRange}</div>
                        <div style="color: ${isInRange ? '#4CAF50' : '#f44336'};">
                            Status: ${isInRange ? '‚úÖ Na faixa' : '‚ùå Fora da faixa'}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
                
                console.innerHTML += `${scenario.name}: ${finalScore}% (esperado: ${scenario.expectedRange}) - ${isInRange ? 'OK' : 'ERRO'}\n`;
                console.innerHTML += `  Sub-scores: L:${scenario.subScores.loudness}% D:${scenario.subScores.dinamica}% F:${scenario.subScores.frequencia}% E:${scenario.subScores.estereo}% T:${scenario.subScores.tecnico}%\n\n`;
            });
        }
        
        function getScoreClass(score) {
            if (score >= 85) return 'score-excellent';
            if (score >= 70) return 'score-good';
            if (score >= 50) return 'score-average';
            return 'score-poor';
        }
        
        // Auto-executar todos os testes
        setTimeout(() => {
            testGradualCurve();
            setTimeout(testTechnicalGrading, 500);
            setTimeout(testGenreWeightsFixed, 1000);
            setTimeout(testRealisticScenarios, 1500);
        }, 1000);
    </script>
</body>
</html>