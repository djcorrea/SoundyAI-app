<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ Teste Sistema HÃ­brido Pista A + Pista B</title>
    <style>
        body { font-family: 'Consolas', monospace; margin: 20px; background: #0a0a0a; color: #00ff88; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: #111; border: 1px solid #333; border-radius: 8px; padding: 20px; margin: 15px 0; }
        .button { background: #007acc; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .button:hover { background: #005a9e; }
        .result { background: #001a0a; border-left: 4px solid #00ff88; padding: 15px; margin: 10px 0; font-family: monospace; }
        .baseline { background: #1a1a00; border-left: 4px solid #ffaa00; padding: 15px; margin: 10px 0; }
        .log { background: #0a0a1a; border: 1px solid #333; padding: 10px; margin: 10px 0; height: 200px; overflow-y: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ Sistema HÃ­brido de Scoring - Pista A + Pista B</h1>
        
        <div class="section">
            <h2>ğŸ“Š Controles de Teste</h2>
            <button class="button" onclick="enableDebug()">ğŸ” Ativar Debug HÃ­brido</button>
            <button class="button" onclick="resetBaseline()">ğŸ—‘ï¸ Reset Baseline</button>
            <button class="button" onclick="showBaseline()">ğŸ“‹ Mostrar Baseline</button>
            <button class="button" onclick="simulateAnalysis()">ğŸµ Simular AnÃ¡lise #1 (Baseline)</button>
            <button class="button" onclick="simulateImprovement()">ğŸ¯ Simular AnÃ¡lise #2 (+3dB Melhoria)</button>
        </div>

        <div class="section">
            <h2>ğŸ¯ Status do Sistema</h2>
            <div id="status" class="result">Aguardando primeira anÃ¡lise...</div>
        </div>

        <div class="section">
            <h2>ğŸ“ Log de Debug</h2>
            <div id="debugLog" class="log"></div>
        </div>

        <div class="section">
            <h2>â„¹ï¸ Como Funciona - VERSÃƒO APRIMORADA</h2>
            <div class="baseline">
                <strong>Pista A (Proximidade):</strong> Score baseado na distÃ¢ncia ao target ideal (sistema original)<br>
                <strong>Pista B (Melhoria):</strong> Score baseado na melhoria vs estado inicial<br>
                <strong>STEP_MAX:</strong> 4dB = melhoria que dÃ¡ 100% de score (boost 1.2x)<br>
                <strong>Cap de Sanidade:</strong> MÃ¡x 80% se banda continua muito longe (>2Ã—tolerÃ¢ncia)<br>
                <strong>Score Final:</strong> Math.max(scoreA, scoreB) - o melhor dos dois sistemas<br>
                <strong>PersistÃªncia:</strong> Baseline salva no localStorage por trackId
            </div>
        </div>
    </div>

    <script src="lib/audio/features/scoring.js"></script>
    <script>
        let logCount = 0;
        
        // Capturar logs do console
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            
            const logDiv = document.getElementById('debugLog');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${++logCount}] ${args.join(' ')}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        function enableDebug() {
            if (typeof window.enableHybridDebug === 'function') {
                window.enableHybridDebug();
                updateStatus();
            } else {
                console.log('âŒ FunÃ§Ã£o enableHybridDebug nÃ£o encontrada - verifique se scoring.js estÃ¡ carregado');
            }
        }

        function resetBaseline() {
            if (typeof window.resetBaseline === 'function') {
                window.resetBaseline();
                updateStatus();
            } else {
                console.log('âŒ FunÃ§Ã£o resetBaseline nÃ£o encontrada');
            }
        }

        function showBaseline() {
            if (typeof window.showBaseline === 'function') {
                window.showBaseline();
            } else {
                console.log('âŒ FunÃ§Ã£o showBaseline nÃ£o encontrada');
            }
        }

        function simulateAnalysis() {
            // Simular dados de bandas espectrais
            const mockMetrics = {
                bandEnergies: {
                    sub: { rms_db: -18.5 },
                    bass: { rms_db: -12.3 },
                    low_mid: { rms_db: -10.1 },
                    mid: { rms_db: -8.7 },
                    high_mid: { rms_db: -11.2 },
                    presence: { rms_db: -15.8 },
                    air: { rms_db: -20.1 }
                },
                lufsIntegrated: -23.0
            };

            const mockReference = {
                bands: {
                    sub: { target_db: -14.0, tol_db: 6.0 },
                    bass: { target_db: -10.0, tol_db: 6.0 },
                    low_mid: { target_db: -8.0, tol_db: 6.0 },
                    mid: { target_db: -6.0, tol_db: 6.0 },
                    high_mid: { target_db: -8.0, tol_db: 6.0 },
                    presence: { target_db: -12.0, tol_db: 6.0 },
                    air: { target_db: -18.0, tol_db: 6.0 }
                }
            };

            console.log('ğŸµ Executando anÃ¡lise simulada...');
            
            try {
                if (typeof computeMixScore === 'function') {
                    const result = computeMixScore(mockMetrics, mockReference);
                    console.log('âœ… AnÃ¡lise concluÃ­da:', result);
                    updateStatus();
                } else {
                    console.log('âŒ FunÃ§Ã£o computeMixScore nÃ£o encontrada');
                }
            } catch (error) {
                console.log('âŒ Erro na anÃ¡lise:', error.message);
            }
        }

        function simulateImprovement() {
            // Simular melhoria de +3dB em sub/bass/mid (ficam mais prÃ³ximos do target)
            const improvedMetrics = {
                bandEnergies: {
                    sub: { rms_db: -15.5 },    // foi -18.5, melhorou +3dB (target: -14.0)
                    bass: { rms_db: -9.3 },    // foi -12.3, melhorou +3dB (target: -10.0) 
                    low_mid: { rms_db: -7.1 }, // foi -10.1, melhorou +3dB (target: -8.0)
                    mid: { rms_db: -8.7 },     // mantido igual
                    high_mid: { rms_db: -11.2 }, // mantido igual
                    presence: { rms_db: -15.8 }, // mantido igual
                    air: { rms_db: -20.1 }       // mantido igual
                },
                lufsIntegrated: -23.0
            };

            const mockReference = {
                bands: {
                    sub: { target_db: -14.0, tol_db: 6.0 },
                    bass: { target_db: -10.0, tol_db: 6.0 },
                    low_mid: { target_db: -8.0, tol_db: 6.0 },
                    mid: { target_db: -6.0, tol_db: 6.0 },
                    high_mid: { target_db: -8.0, tol_db: 6.0 },
                    presence: { target_db: -12.0, tol_db: 6.0 },
                    air: { target_db: -18.0, tol_db: 6.0 }
                }
            };

            console.log('ğŸ¯ Simulando melhoria de +3dB em sub/bass/low_mid...');
            
            try {
                if (typeof computeMixScore === 'function') {
                    const result = computeMixScore(improvedMetrics, mockReference);
                    console.log('âœ… AnÃ¡lise pÃ³s-melhoria concluÃ­da:', result);
                    
                    // Verificar se scoreB ficou entre 0.75-1.00 para as bandas melhoradas
                    const bandScores = result.perMetric?.filter(m => m.key.startsWith('band_'));
                    if (bandScores) {
                        console.log('ğŸ“Š Scores das bandas:');
                        bandScores.forEach(band => {
                            const score = (band.score * 100).toFixed(1);
                            console.log(`  ${band.key}: ${score}%`);
                        });
                    }
                    
                    updateStatus();
                } else {
                    console.log('âŒ FunÃ§Ã£o computeMixScore nÃ£o encontrada');
                }
            } catch (error) {
                console.log('âŒ Erro na anÃ¡lise:', error.message);
            }
        }

        function updateStatus() {
            const statusDiv = document.getElementById('status');
            const hasBaseline = typeof window !== 'undefined' && window.__BASELINE_BAND_ENERGIES;
            const debugEnabled = typeof window !== 'undefined' && window.DEBUG_HYBRID_SCORE;
            
            statusDiv.innerHTML = `
                <strong>Baseline:</strong> ${hasBaseline ? 'âœ… Armazenado' : 'âŒ NÃ£o definido'}<br>
                <strong>Debug HÃ­brido:</strong> ${debugEnabled ? 'âœ… Ativo' : 'âŒ Inativo'}<br>
                <strong>Sistema:</strong> ${hasBaseline ? 'Pronto para scoring hÃ­brido' : 'Aguardando primeira anÃ¡lise'}
            `;
        }

        // Atualizar status inicial
        updateStatus();
        console.log('ğŸ¯ Sistema de teste hÃ­brido carregado');
    </script>
</body>
</html>