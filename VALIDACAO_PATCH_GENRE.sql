-- ๐ฅ SCRIPT DE VALIDAรรO DO PATCH DEFINITIVO
-- Execute apรณs rodar uma anรกlise para verificar se genre estรก correto

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 1๏ธโฃ VERIFICAR JOB MAIS RECENTE (รLTIMA ANรLISE)
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

SELECT 
  id,
  status,
  mode,
  created_at,
  
  -- โ COLUNA DATA (deve ter genre correto)
  data->>'genre' AS data_genre,
  
  -- โ COLUNA RESULT (compatibilidade)
  result->>'genre' AS result_genre,
  
  -- โ COLUNA RESULTS (GARANTIA - campo principal)
  results->>'genre' AS results_genre,
  results->'data'->>'genre' AS results_data_genre,
  results->'summary'->>'genre' AS results_summary_genre,
  results->'metadata'->>'genre' AS results_metadata_genre,
  results->'suggestionMetadata'->>'genre' AS results_suggestionmeta_genre

FROM jobs 
ORDER BY created_at DESC 
LIMIT 1;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- RESULTADO ESPERADO (exemplo com eletrofunk):
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- data_genre                   : eletrofunk   โ
-- result_genre                 : eletrofunk   โ
-- results_genre                : eletrofunk   โ
-- results_data_genre           : eletrofunk   โ
-- results_summary_genre        : eletrofunk   โ
-- results_metadata_genre       : eletrofunk   โ
-- results_suggestionmeta_genre : eletrofunk   โ
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 2๏ธโฃ VERIFICAR รLTIMOS 5 JOBS (HISTรRICO)
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

SELECT 
  id,
  status,
  data->>'genre' AS data_genre,
  results->>'genre' AS results_genre,
  results->'data'->>'genre' AS results_data_genre,
  created_at
FROM jobs 
ORDER BY created_at DESC 
LIMIT 5;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 3๏ธโฃ VERIFICAR JOBS COM GENRE NULL EM RESULTS (PROBLEMA)
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

SELECT 
  id,
  status,
  data->>'genre' AS data_genre,
  results->>'genre' AS results_genre,
  created_at
FROM jobs 
WHERE 
  status = 'done' 
  AND data->>'genre' IS NOT NULL  -- data tem genre
  AND results->>'genre' IS NULL   -- mas results NรO tem
ORDER BY created_at DESC;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- RESULTADO ESPERADO APรS PATCH:
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 0 rows  โ (nenhum job com results.genre NULL)
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 4๏ธโฃ VERIFICAR CONSISTรNCIA (data.genre == results.genre)
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

SELECT 
  id,
  data->>'genre' AS data_genre,
  results->>'genre' AS results_genre,
  
  -- โ Verificaรงรฃo: devem ser iguais
  CASE 
    WHEN data->>'genre' = results->>'genre' THEN 'โ OK'
    WHEN data->>'genre' IS NULL AND results->>'genre' IS NULL THEN 'โ๏ธ Ambos NULL'
    ELSE 'โ INCONSISTENTE'
  END AS status_consistencia,
  
  created_at
FROM jobs 
WHERE status = 'done'
ORDER BY created_at DESC 
LIMIT 10;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- RESULTADO ESPERADO:
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- Todos os jobs devem ter status_consistencia = 'โ OK'
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 5๏ธโฃ VERIFICAR ESTRUTURA COMPLETA DO รLTIMO JOB
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

SELECT 
  id,
  status,
  mode,
  
  -- JSON completo do results
  jsonb_pretty(results) AS results_full_json
  
FROM jobs 
ORDER BY created_at DESC 
LIMIT 1;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- VERIFICAR NO JSON SE:
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- โ "genre": "eletrofunk" (raiz)
-- โ "data": { "genre": "eletrofunk" }
-- โ "summary": { "genre": "eletrofunk" }
-- โ "metadata": { "genre": "eletrofunk" }
-- โ "suggestionMetadata": { "genre": "eletrofunk" }
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 6๏ธโฃ ESTATรSTICAS GERAIS
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

SELECT 
  COUNT(*) AS total_jobs,
  
  COUNT(CASE WHEN data->>'genre' IS NOT NULL THEN 1 END) AS jobs_com_data_genre,
  COUNT(CASE WHEN results->>'genre' IS NOT NULL THEN 1 END) AS jobs_com_results_genre,
  
  -- โ Consistentes: data.genre == results.genre
  COUNT(CASE WHEN data->>'genre' = results->>'genre' THEN 1 END) AS jobs_consistentes,
  
  -- โ Inconsistentes: data.genre != results.genre
  COUNT(CASE 
    WHEN data->>'genre' IS NOT NULL 
    AND results->>'genre' IS NULL 
    THEN 1 
  END) AS jobs_com_results_null,
  
  -- ๐ Porcentagem de sucesso
  ROUND(
    COUNT(CASE WHEN data->>'genre' = results->>'genre' THEN 1 END)::numeric / 
    NULLIF(COUNT(*), 0) * 100, 
    2
  ) AS porcentagem_sucesso

FROM jobs 
WHERE status = 'done';

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- RESULTADO ESPERADO APรS PATCH:
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- jobs_com_results_null : 0        โ
-- porcentagem_sucesso   : 100.00   โ
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 7๏ธโฃ VERIFICAR GรNEROS รNICOS EM RESULTS
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

SELECT 
  results->>'genre' AS genre,
  COUNT(*) AS total_jobs,
  MAX(created_at) AS ultimo_job
FROM jobs 
WHERE status = 'done'
GROUP BY results->>'genre'
ORDER BY COUNT(*) DESC;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- VERIFICAR:
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- โ Gรชneros vรกlidos: eletrofunk, funk_bh, trap, etc.
-- โ NULL: NรO deve aparecer apรณs patch
-- โ "default": NรO deve aparecer no modo genre
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- ๐ฏ CRITรRIO DE ACEITE DO PATCH
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- Execute query #1 e verifique:
-- 
-- โ data_genre = "eletrofunk" (ou gรชnero escolhido)
-- โ results_genre = "eletrofunk" (NUNCA NULL)
-- โ results_data_genre = "eletrofunk"
-- โ results_summary_genre = "eletrofunk"
-- โ results_metadata_genre = "eletrofunk"
--
-- SE TODOS OS CAMPOS == GรNERO CORRETO โ PATCH ACEITO! โ
-- SE QUALQUER CAMPO == NULL โ PATCH FALHOU โ
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
