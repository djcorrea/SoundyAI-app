rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“‹ COLEÃ‡ÃƒO: usuarios/{userId}
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REGRA CRÃTICA: Permitir criaÃ§Ã£o ANTES de SMS estar completo
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    match /usuarios/{userId} {
      
      // âœ… LEITURA: Apenas o prÃ³prio usuÃ¡rio
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ”¥ CORREÃ‡ÃƒO: CRIAÃ‡ÃƒO INICIAL (permite verificadoPorSMS = false)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // JUSTIFICATIVA:
      // - Durante cadastro com SMS, onAuthStateChanged dispara ANTES de linkWithCredential
      // - Documento precisa ser criado com verificadoPorSMS: false temporariamente
      // - ApÃ³s linkWithCredential, serÃ¡ atualizado para verificadoPorSMS: true
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.uid == userId
                    && request.resource.data.email is string
                    && request.resource.data.plan is string
                    && request.resource.data.deviceId is string;
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ”’ ATUALIZAÃ‡ÃƒO: Permite sincronizaÃ§Ã£o de SMS e campos permitidos
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    && (
                      // âœ… SINCRONIZAÃ‡ÃƒO SMS (apÃ³s linkWithCredential)
                      // Permite atualizar verificadoPorSMS e telefone
                      (
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
                          'verificadoPorSMS',
                          'telefone',
                          'smsVerificadoEm',
                          'updatedAt'
                        ])
                      )
                      // âœ… CAMPOS DE USO GERAL (messagesToday, analysesToday, etc)
                      || (
                        !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                          'uid',
                          'email',
                          'referralCode',
                          'referralTimestamp',
                          'convertedAt',
                          'firstPaidPlan',
                          'visitorId',
                          'plan',
                          'subscription',
                          'deviceId'
                        ])
                      )
                    );
      
      // âŒ DELEÃ‡ÃƒO: Bloqueada (manter histÃ³rico)
      allow delete: if false;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”— COLEÃ‡ÃƒO: referral_visitors/{visitorId}
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Sistema de Afiliados V2 - Rastreamento desde primeira visita
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    match /referral_visitors/{visitorId} {
      
      // âœ… CRIAÃ‡ÃƒO: AnÃ´nimos podem criar (apenas campos especÃ­ficos)
      allow create: if request.auth == null 
                    && request.resource.data.visitorId == visitorId
                    && request.resource.data.partnerId is string
                    && request.resource.data.registered == false
                    && request.resource.data.uid == null
                    && request.resource.data.converted == false
                    && request.resource.data.plan == null
                    && request.resource.data.convertedAt == null;
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ”¥ CORREÃ‡ÃƒO CRÃTICA: Permitir UPDATE de registro (visitor â†’ user)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PROBLEMA ANTERIOR:
      // - allow update: if false â†’ Bloqueava vincular uid ao visitor
      // - auth.js linha 1670 falhava silenciosamente
      // - Painel do parceiro nÃ£o detectava cadastros (registered=false)
      // 
      // SOLUÃ‡ÃƒO:
      // - Permitir update APENAS na primeira vez (registered: false â†’ true)
      // - UID no update DEVE coincidir com request.auth.uid (anti-fraude)
      // - Permitir alterar APENAS campos de registro (nÃ£o fraudar conversÃ£o)
      // - Bloquear alteraÃ§Ãµes subsequentes (idempotÃªncia)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      allow update: if request.auth != null
                    && (
                      // âœ… CENÃRIO 1: VINCULAR UID ao cadastrar (registered: false â†’ true)
                      (
                        resource.data.registered == false  // Primeira vez
                        && request.resource.data.registered == true
                        && request.resource.data.uid == request.auth.uid
                        && request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['registered', 'uid', 'registeredAt', 'lastSeenAt', 'updatedAt'])
                      )
                      // âœ… CENÃRIO 2: BACKEND atualiza conversÃ£o (apenas campos especÃ­ficos)
                      // Nota: Backend usa Admin SDK que bypassa estas regras
                      // Este caso Ã© redundante mas explÃ­cito para documentaÃ§Ã£o
                      || (
                        resource.data.uid == request.auth.uid  // PrÃ³prio usuÃ¡rio
                        && request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['converted', 'plan', 'convertedAt', 'lastSeenAt', 'updatedAt'])
                      )
                    );
      
      // ğŸ‘ï¸ LEITURA: UsuÃ¡rio pode ler seu prÃ³prio registro
      allow read: if request.auth != null 
                  && resource.data.uid == request.auth.uid;
      
      // âŒ DELEÃ‡ÃƒO: Bloqueada
      allow delete: if false;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ¤ COLEÃ‡ÃƒO: partners/{partnerId}
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    match /partners/{partnerId} {
      allow read: if request.auth != null;
      allow write: if false;  // Apenas admin/script
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” COLEÃ‡Ã•ES DE MAPEAMENTO (Unicidade telefone/device)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    match /phone_mappings/{phoneId} {
      allow read: if request.auth != null;
      allow write: if false;  // Apenas Transaction backend
    }
    
    match /device_mappings/{deviceId} {
      allow read: if request.auth != null;
      allow write: if false;  // Apenas Transaction backend
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’³ COLEÃ‡Ã•ES DE PAGAMENTO (IdempotÃªncia)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    match /processed_stripe_events/{eventId} {
      allow read, write: if false;  // Apenas backend
    }
    
    match /hotmart_transactions/{transactionId} {
      allow read, write: if false;  // Apenas backend
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š COLEÃ‡Ã•ES DE HISTÃ“RICO E ANÃLISE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    match /analysis_history/{analysisId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
    
    match /ips/{ipId} {
      allow read, write: if false;  // Apenas backend para rate limiting
    }
    
    match /waitlist/{email} {
      allow create: if true;  // Qualquer um pode se inscrever
      allow read, update, delete: if false;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âš ï¸ COLEÃ‡Ã•ES LEGADAS (Deprecadas mas mantidas para compatibilidade)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    match /phones/{phoneId} {
      allow read, write: if false;
    }
    
    match /fingerprints/{fpId} {
      allow read, write: if false;
    }
  }
}

