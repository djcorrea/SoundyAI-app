rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // âœ… USUÃRIOS: Somente o prÃ³prio usuÃ¡rio pode ler/escrever
    match /usuarios/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // âœ… VALIDAÃ‡ÃƒO DE ESCRITA: Impedir criaÃ§Ã£o sem telefone verificado
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.verificadoPorSMS == true
                    && request.resource.data.telefone != null
                    && request.resource.data.deviceId != null;
      
      // âœ… ATUALIZAÃ‡ÃƒO: Impedir alteraÃ§Ã£o de telefone sem nova verificaÃ§Ã£o
      // ğŸ”’ SEGURANÃ‡A AFILIADOS: UsuÃ¡rio NÃƒO pode alterar campos de referÃªncia
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    && (
                      // Se nÃ£o alterar telefone, permitir
                      request.resource.data.telefone == resource.data.telefone
                      // OU se alterar telefone, deve reverificar por SMS
                      || request.resource.data.verificadoPorSMS == true
                    )
                    // âœ… NOVO: Proteger campos de sistema de afiliados
                    && (
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny([
                        'referralCode',
                        'referralTimestamp',
                        'convertedAt',
                        'firstPaidPlan'
                      ])
                    );
      
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // âœ… MAPEAMENTO TELEFONE â†’ USERID: Apenas backend pode manipular
    match /phone_mappings/{phoneId} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas Transaction do Firebase pode escrever
    }
    
    // âœ… MAPEAMENTO DEVICEID â†’ USERID: Apenas backend pode manipular
    match /device_mappings/{deviceId} {
      allow read: if request.auth != null;
      allow write: if false; // Apenas Transaction do Firebase pode escrever
    }
    
    // âš ï¸ COLEÃ‡Ã•ES LEGADAS (manter compatibilidade)
    match /phones/{phoneId} {
      allow read, write: if false;
    }
    match /fingerprints/{fpId} {
      allow read, write: if false;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ¤ SISTEMA DE AFILIADOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // âœ… PARCEIROS: Leitura pÃºblica (para validaÃ§Ã£o), escrita apenas backend
    match /partners/{partnerId} {
      allow read: if request.auth != null;  // Qualquer usuÃ¡rio autenticado
      allow write: if false;  // Apenas admin via backend/script
    }
    
    // âœ… TRANSAÃ‡Ã•ES STRIPE (idempotÃªncia)
    match /processed_stripe_events/{eventId} {
      allow read, write: if false;  // Apenas backend
    }
    
    // âœ… TRANSAÃ‡Ã•ES HOTMART (idempotÃªncia)
    match /hotmart_transactions/{transactionId} {
      allow read, write: if false;  // Apenas backend
    }
  }
}
