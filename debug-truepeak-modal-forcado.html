<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Debug True Peak Modal - FOR√áADO</title>
    <style>
        body { 
            background: #0a0a0a; color: #00ff92; font-family: 'Courier New'; 
            padding: 20px; line-height: 1.6; 
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .success { color: #00ff92; }
        .warning { color: #ffa500; }
        .error { color: #ff4444; }
        .info { color: #4da6ff; }
        pre { 
            background: #1a1a1a; padding: 15px; border-radius: 5px; 
            border-left: 4px solid #00ff92; overflow-x: auto; 
            font-size: 12px; max-height: 400px; overflow-y: auto;
        }
        button {
            background: #00ff92; color: #0a0a0a; border: none; 
            padding: 12px 24px; border-radius: 5px; cursor: pointer; 
            font-weight: bold; margin: 10px 5px;
        }
        button:hover { background: #00cc77; }
        .debug-section {
            border: 1px solid #333; margin: 10px 0; padding: 15px;
            border-radius: 5px; background: #111;
        }
        .force-value {
            background: #ff4444; color: #fff; padding: 5px 10px;
            border-radius: 3px; margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Debug True Peak Modal - FOR√áADO</h1>
        <p class="warning">Este debug vai FOR√áAR o True Peak a aparecer no modal!</p>
        
        <div>
            <button onclick="debugModal()">üîç Debug Modal</button>
            <button onclick="forcarTruePeak()">üí™ FOR√áAR True Peak</button>
            <button onclick="testarGetMetric()">üéØ Testar getMetric</button>
            <button onclick="limparLogs()">üßπ Limpar</button>
        </div>
        
        <div class="debug-section">
            <h3>üîß For√ßar Valores</h3>
            <button class="force-value" onclick="forcarValor(-3.1)">For√ßar -3.1 dBTP</button>
            <button class="force-value" onclick="forcarValor(-1.2)">For√ßar -1.2 dBTP</button>
            <button class="force-value" onclick="forcarValor(-0.5)">For√ßar -0.5 dBTP</button>
        </div>
        
        <pre id="logs"></pre>
    </div>

    <script>
        let logContainer = document.getElementById('logs');

        function log(message, type = 'info') {
            const colors = {
                'success': '#00ff92',
                'warning': '#ffa500', 
                'error': '#ff4444',
                'info': '#4da6ff'
            };
            
            const timestamp = new Date().toLocaleTimeString();
            const coloredMessage = `<span style="color: ${colors[type] || '#4da6ff'}">[${timestamp}] ${message}</span>`;
            logContainer.innerHTML += coloredMessage + '\n';
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function limparLogs() {
            logContainer.innerHTML = '';
        }

        async function debugModal() {
            log('üîç Iniciando debug do modal...', 'info');
            
            try {
                // Verificar se SoundyAI est√° aberto
                if (!parent || parent === window) {
                    log('‚ö†Ô∏è Este debug deve ser executado no contexto da SoundyAI', 'warning');
                    log('üí° Abra SoundyAI e execute este c√≥digo no console', 'info');
                    return;
                }

                // Verificar an√°lise atual
                const currentAnalysis = parent.window.currentModalAnalysis || parent.window.__CURRENT_ANALYSIS__;
                if (currentAnalysis) {
                    log('‚úÖ An√°lise encontrada:', 'success');
                    log(JSON.stringify(currentAnalysis, null, 2), 'info');
                    
                    // Verificar True Peak na an√°lise
                    const truePeak = currentAnalysis.technicalData?.truePeakDbtp;
                    log(`üéØ True Peak na an√°lise: ${truePeak}`, truePeak ? 'success' : 'error');
                    
                } else {
                    log('‚ùå Nenhuma an√°lise encontrada', 'error');
                }

            } catch (error) {
                log('‚ùå Erro no debug: ' + error.message, 'error');
            }
        }

        async function testarGetMetric() {
            log('üéØ Testando fun√ß√£o getMetric...', 'info');
            
            try {
                // Acessar o contexto da SoundyAI
                const soundyWindow = parent.window;
                const currentAnalysis = soundyWindow.currentModalAnalysis || soundyWindow.__CURRENT_ANALYSIS__;
                
                if (!currentAnalysis) {
                    log('‚ùå Nenhuma an√°lise dispon√≠vel para testar', 'error');
                    return;
                }

                log('üìä Testando getMetric no contexto atual...', 'info');
                
                // Simular a fun√ß√£o getMetric
                const getNestedValue = (obj, path) => {
                    return path.split('.').reduce((current, key) => current?.[key], obj);
                };

                const getMetric = (metricPath, fallbackPath = null) => {
                    // Prioridade: metrics centralizadas > technicalData legado > fallback
                    const centralizedValue = currentAnalysis.metrics && getNestedValue(currentAnalysis.metrics, metricPath);
                    if (Number.isFinite(centralizedValue)) {
                        return centralizedValue;
                    }
                    
                    // Fallback para technicalData legado
                    const legacyValue = fallbackPath ? getNestedValue(currentAnalysis.technicalData, fallbackPath) : getNestedValue(currentAnalysis.technicalData, metricPath);
                    return Number.isFinite(legacyValue) ? legacyValue : null;
                };

                const truePeakValue = getMetric('truePeakDbtp', 'truePeakDbtp');
                log(`üéØ getMetric('truePeakDbtp'): ${truePeakValue}`, truePeakValue ? 'success' : 'error');
                
                // Verificar estrutura completa
                log('üìä Estrutura da an√°lise:', 'info');
                log(`- technicalData.truePeakDbtp: ${currentAnalysis.technicalData?.truePeakDbtp}`, 'info');
                log(`- metrics.truePeakDbtp: ${currentAnalysis.metrics?.truePeakDbtp}`, 'info');
                log(`- technicalData keys: ${Object.keys(currentAnalysis.technicalData || {}).join(', ')}`, 'info');

            } catch (error) {
                log('‚ùå Erro ao testar getMetric: ' + error.message, 'error');
            }
        }

        function forcarValor(valor) {
            log(`üí™ For√ßando True Peak = ${valor} dBTP...`, 'warning');
            
            try {
                const soundyWindow = parent.window;
                
                // Criar an√°lise mock se n√£o existir
                if (!soundyWindow.currentModalAnalysis) {
                    soundyWindow.currentModalAnalysis = {
                        technicalData: {},
                        metrics: {}
                    };
                }

                // For√ßar valor em ambos os locais
                soundyWindow.currentModalAnalysis.technicalData.truePeakDbtp = valor;
                soundyWindow.currentModalAnalysis.metrics.truePeakDbtp = valor;
                
                log(`‚úÖ Valor for√ßado! technicalData.truePeakDbtp = ${valor}`, 'success');
                log(`‚úÖ Valor for√ßado! metrics.truePeakDbtp = ${valor}`, 'success');
                
                // Tentar atualizar o modal
                if (soundyWindow.displayModalResults) {
                    soundyWindow.displayModalResults(soundyWindow.currentModalAnalysis);
                    log('üîÑ Modal atualizado!', 'success');
                } else {
                    log('‚ö†Ô∏è Fun√ß√£o displayModalResults n√£o encontrada', 'warning');
                }

            } catch (error) {
                log('‚ùå Erro ao for√ßar valor: ' + error.message, 'error');
            }
        }

        async function forcarTruePeak() {
            log('üí™ FOR√áANDO True Peak a aparecer...', 'warning');
            
            try {
                const soundyWindow = parent.window;
                
                // Monkeypatch na fun√ß√£o getMetric para SEMPRE retornar um valor para True Peak
                const originalCode = soundyWindow.document.querySelector('script[src*="audio-analyzer-integration.js"]');
                
                // Injetar c√≥digo direto no contexto
                const forceScript = soundyWindow.document.createElement('script');
                forceScript.innerHTML = `
                    // PATCH TEMPOR√ÅRIO PARA TRUE PEAK
                    window.__ORIGINAL_GET_METRIC__ = window.getMetric;
                    
                    // Override da fun√ß√£o getMetric para for√ßar True Peak
                    window.getMetricForced = function(metricPath, fallbackPath = null) {
                        if (metricPath === 'truePeakDbtp') {
                            console.log('üéØ [FOR√áADO] getMetric truePeakDbtp interceptado!');
                            return -3.1; // VALOR FOR√áADO
                        }
                        
                        // Para outras m√©tricas, usar l√≥gica original
                        if (window.__ORIGINAL_GET_METRIC__) {
                            return window.__ORIGINAL_GET_METRIC__(metricPath, fallbackPath);
                        }
                        
                        return null;
                    };
                    
                    console.log('üí™ [FORCE PATCH] True Peak for√ßado = -3.1 dBTP');
                `;
                
                soundyWindow.document.head.appendChild(forceScript);
                log('‚úÖ Patch aplicado! True Peak for√ßado = -3.1 dBTP', 'success');
                
                // Recarregar modal se poss√≠vel
                if (soundyWindow.currentModalAnalysis && soundyWindow.displayModalResults) {
                    // Patch tempor√°rio na an√°lise tamb√©m
                    soundyWindow.currentModalAnalysis.technicalData = soundyWindow.currentModalAnalysis.technicalData || {};
                    soundyWindow.currentModalAnalysis.technicalData.truePeakDbtp = -3.1;
                    
                    soundyWindow.displayModalResults(soundyWindow.currentModalAnalysis);
                    log('üîÑ Modal recarregado com patch!', 'success');
                }

            } catch (error) {
                log('‚ùå Erro ao aplicar patch: ' + error.message, 'error');
            }
        }

        // Auto-executar quando a p√°gina carrega
        window.addEventListener('load', () => {
            log('üöÄ Debug True Peak Modal carregado!', 'info');
            log('üí° Este tool vai FOR√áAR o True Peak a aparecer no modal da SoundyAI', 'info');
        });
    </script>
</body>
</html>