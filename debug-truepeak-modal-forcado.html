<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ Debug True Peak Modal - FORÃ‡ADO</title>
    <style>
        body { 
            background: #0a0a0a; color: #00ff92; font-family: 'Courier New'; 
            padding: 20px; line-height: 1.6; 
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .success { color: #00ff92; }
        .warning { color: #ffa500; }
        .error { color: #ff4444; }
        .info { color: #4da6ff; }
        pre { 
            background: #1a1a1a; padding: 15px; border-radius: 5px; 
            border-left: 4px solid #00ff92; overflow-x: auto; 
            font-size: 12px; max-height: 400px; overflow-y: auto;
        }
        button {
            background: #00ff92; color: #0a0a0a; border: none; 
            padding: 12px 24px; border-radius: 5px; cursor: pointer; 
            font-weight: bold; margin: 10px 5px;
        }
        button:hover { background: #00cc77; }
        .debug-section {
            border: 1px solid #333; margin: 10px 0; padding: 15px;
            border-radius: 5px; background: #111;
        }
        .force-value {
            background: #ff4444; color: #fff; padding: 5px 10px;
            border-radius: 3px; margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ Debug True Peak Modal - FORÃ‡ADO</h1>
        <p class="warning">Este debug vai FORÃ‡AR o True Peak a aparecer no modal!</p>
        
        <div>
            <button onclick="debugModal()">ğŸ” Debug Modal</button>
            <button onclick="forcarTruePeak()">ğŸ’ª FORÃ‡AR True Peak</button>
            <button onclick="testarGetMetric()">ğŸ¯ Testar getMetric</button>
            <button onclick="limparLogs()">ğŸ§¹ Limpar</button>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ”§ ForÃ§ar Valores</h3>
            <button class="force-value" onclick="forcarValor(-3.1)">ForÃ§ar -3.1 dBTP</button>
            <button class="force-value" onclick="forcarValor(-1.2)">ForÃ§ar -1.2 dBTP</button>
            <button class="force-value" onclick="forcarValor(-0.5)">ForÃ§ar -0.5 dBTP</button>
        </div>
        
        <pre id="logs"></pre>
    </div>

    <script>
        let logContainer = document.getElementById('logs');

        function log(message, type = 'info') {
            const colors = {
                'success': '#00ff92',
                'warning': '#ffa500', 
                'error': '#ff4444',
                'info': '#4da6ff'
            };
            
            const timestamp = new Date().toLocaleTimeString();
            const coloredMessage = `<span style="color: ${colors[type] || '#4da6ff'}">[${timestamp}] ${message}</span>`;
            logContainer.innerHTML += coloredMessage + '\n';
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function limparLogs() {
            logContainer.innerHTML = '';
        }

        async function debugModal() {
            log('ğŸ” Iniciando debug do modal...', 'info');
            
            try {
                // Verificar se SoundyAI estÃ¡ aberto
                if (!parent || parent === window) {
                    log('âš ï¸ Este debug deve ser executado no contexto da SoundyAI', 'warning');
                    log('ğŸ’¡ Abra SoundyAI e execute este cÃ³digo no console', 'info');
                    return;
                }

                // Verificar anÃ¡lise atual
                const currentAnalysis = parent.window.currentModalAnalysis || parent.window.__CURRENT_ANALYSIS__;
                if (currentAnalysis) {
                    log('âœ… AnÃ¡lise encontrada:', 'success');
                    log(JSON.stringify(currentAnalysis, null, 2), 'info');
                    
                    // Verificar True Peak na anÃ¡lise
                    const truePeak = currentAnalysis.technicalData?.truePeakDbtp;
                    log(`ğŸ¯ True Peak na anÃ¡lise: ${truePeak}`, truePeak ? 'success' : 'error');
                    
                } else {
                    log('âŒ Nenhuma anÃ¡lise encontrada', 'error');
                }

            } catch (error) {
                log('âŒ Erro no debug: ' + error.message, 'error');
            }
        }

        async function testarGetMetric() {
            log('ğŸ¯ Testando funÃ§Ã£o getMetric...', 'info');
            
            try {
                // Acessar o contexto da SoundyAI
                const soundyWindow = parent.window;
                const currentAnalysis = soundyWindow.currentModalAnalysis || soundyWindow.__CURRENT_ANALYSIS__;
                
                if (!currentAnalysis) {
                    log('âŒ Nenhuma anÃ¡lise disponÃ­vel para testar', 'error');
                    return;
                }

                log('ğŸ“Š Testando getMetric no contexto atual...', 'info');
                
                // Simular a funÃ§Ã£o getMetric
                const getNestedValue = (obj, path) => {
                    return path.split('.').reduce((current, key) => current?.[key], obj);
                };

                const getMetric = (metricPath, fallbackPath = null) => {
                    // Prioridade: metrics centralizadas > technicalData legado > fallback
                    const centralizedValue = currentAnalysis.metrics && getNestedValue(currentAnalysis.metrics, metricPath);
                    if (Number.isFinite(centralizedValue)) {
                        return centralizedValue;
                    }
                    
                    // Fallback para technicalData legado
                    const legacyValue = fallbackPath ? getNestedValue(currentAnalysis.technicalData, fallbackPath) : getNestedValue(currentAnalysis.technicalData, metricPath);
                    return Number.isFinite(legacyValue) ? legacyValue : null;
                };

                const truePeakValue = getMetric('truePeakDbtp', 'truePeakDbtp');
                log(`ğŸ¯ getMetric('truePeakDbtp'): ${truePeakValue}`, truePeakValue ? 'success' : 'error');
                
                // Verificar estrutura completa
                log('ğŸ“Š Estrutura da anÃ¡lise:', 'info');
                log(`- technicalData.truePeakDbtp: ${currentAnalysis.technicalData?.truePeakDbtp}`, 'info');
                log(`- metrics.truePeakDbtp: ${currentAnalysis.metrics?.truePeakDbtp}`, 'info');
                log(`- technicalData keys: ${Object.keys(currentAnalysis.technicalData || {}).join(', ')}`, 'info');

            } catch (error) {
                log('âŒ Erro ao testar getMetric: ' + error.message, 'error');
            }
        }

        function forcarValor(valor) {
            log(`ğŸ’ª ForÃ§ando True Peak = ${valor} dBTP...`, 'warning');
            
            try {
                const soundyWindow = parent.window;
                
                // Criar anÃ¡lise mock se nÃ£o existir
                if (!soundyWindow.currentModalAnalysis) {
                    soundyWindow.currentModalAnalysis = {
                        technicalData: {},
                        metrics: {}
                    };
                }

                // ForÃ§ar valor em ambos os locais
                soundyWindow.currentModalAnalysis.technicalData.truePeakDbtp = valor;
                soundyWindow.currentModalAnalysis.metrics.truePeakDbtp = valor;
                
                log(`âœ… Valor forÃ§ado! technicalData.truePeakDbtp = ${valor}`, 'success');
                log(`âœ… Valor forÃ§ado! metrics.truePeakDbtp = ${valor}`, 'success');
                
                // Tentar atualizar o modal
                if (soundyWindow.displayModalResults) {
                    soundyWindow.displayModalResults(soundyWindow.currentModalAnalysis);
                    log('ğŸ”„ Modal atualizado!', 'success');
                } else {
                    log('âš ï¸ FunÃ§Ã£o displayModalResults nÃ£o encontrada', 'warning');
                }

            } catch (error) {
                log('âŒ Erro ao forÃ§ar valor: ' + error.message, 'error');
            }
        }

        async function forcarTruePeak() {
            log('ğŸ’ª FORÃ‡ANDO True Peak a aparecer...', 'warning');
            
            try {
                const soundyWindow = parent.window;
                
                // Monkeypatch na funÃ§Ã£o getMetric para SEMPRE retornar um valor para True Peak
                const originalCode = soundyWindow.document.querySelector('script[src*="audio-analyzer-integration.js"]');
                
                // Injetar cÃ³digo direto no contexto
                const forceScript = soundyWindow.document.createElement('script');
                forceScript.innerHTML = `
                    // PATCH TEMPORÃRIO PARA TRUE PEAK
                    window.__ORIGINAL_GET_METRIC__ = window.getMetric;
                    
                    // Override da funÃ§Ã£o getMetric para forÃ§ar True Peak
                    window.getMetricForced = function(metricPath, fallbackPath = null) {
                        if (metricPath === 'truePeakDbtp') {
                            console.log('ğŸ¯ [FORÃ‡ADO] getMetric truePeakDbtp interceptado!');
                            return -3.1; // VALOR FORÃ‡ADO
                        }
                        
                        // Para outras mÃ©tricas, usar lÃ³gica original
                        if (window.__ORIGINAL_GET_METRIC__) {
                            return window.__ORIGINAL_GET_METRIC__(metricPath, fallbackPath);
                        }
                        
                        return null;
                    };
                    
                    console.log('ğŸ’ª [FORCE PATCH] True Peak forÃ§ado = -3.1 dBTP');
                `;
                
                soundyWindow.document.head.appendChild(forceScript);
                log('âœ… Patch aplicado! True Peak forÃ§ado = -3.1 dBTP', 'success');
                
                // Recarregar modal se possÃ­vel
                if (soundyWindow.currentModalAnalysis && soundyWindow.displayModalResults) {
                    // Patch temporÃ¡rio na anÃ¡lise tambÃ©m
                    soundyWindow.currentModalAnalysis.technicalData = soundyWindow.currentModalAnalysis.technicalData || {};
                    soundyWindow.currentModalAnalysis.technicalData.truePeakDbtp = -3.1;
                    
                    soundyWindow.displayModalResults(soundyWindow.currentModalAnalysis);
                    log('ğŸ”„ Modal recarregado com patch!', 'success');
                }

            } catch (error) {
                log('âŒ Erro ao aplicar patch: ' + error.message, 'error');
            }
        }

        // Auto-executar quando a pÃ¡gina carrega
        window.addEventListener('load', () => {
            log('ğŸš€ Debug True Peak Modal carregado!', 'info');
            log('ğŸ’¡ Este tool vai FORÃ‡AR o True Peak a aparecer no modal da SoundyAI', 'info');
        });
    </script>
</body>
</html>