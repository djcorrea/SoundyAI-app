<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 Teste Fix Ordenação IA</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        
        .suggestion-card {
            border: 1px solid #ddd;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .priority-high { border-left: 5px solid #dc3545; }
        .priority-medium { border-left: 5px solid #ffc107; }
        .priority-low { border-left: 5px solid #28a745; }
    </style>
</head>
<body>
    <h1>🔧 Teste: Fix Ordenação IA - Priority Mapping</h1>
    
    <div id="results"></div>
    
    <h2>📊 Simulação de Prioridades:</h2>
    <div id="priority-test"></div>
    
    <button onclick="runTests()">🚀 Executar Testes</button>
    <button onclick="clearResults()">🧹 Limpar</button>

    <script>
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('priority-test').innerHTML = '';
        }

        // Função corrigida de mapeamento de prioridade (como implementado)
        function mapPriorityFixed(priority) {
            if (typeof priority !== 'number') {
                if (priority === 'alta' || priority === 'high') return 8;
                else if (priority === 'média' || priority === 'medium') return 5; 
                else if (priority === 'baixa' || priority === 'low') return 2;
                else return 5;
            }
            return Math.max(1, Math.min(10, Math.floor(priority)));
        }

        // Função antiga (problemática)
        function mapPriorityOld(priority) {
            if (typeof priority !== 'number') {
                if (priority === 'alta' || priority === 'high') return 1; // ERRO: invertido
                else if (priority === 'média' || priority === 'medium') return 2; 
                else if (priority === 'baixa' || priority === 'low') return 3;
                else return 2;
            }
            return Math.max(1, Math.min(3, Math.floor(priority)));
        }

        function testPriorityMapping() {
            log('🔍 Testando mapeamento de prioridades...', 'info');
            
            const testCases = [
                { input: 'alta', expected: 8 },
                { input: 'high', expected: 8 },
                { input: 'média', expected: 5 },
                { input: 'medium', expected: 5 },
                { input: 'baixa', expected: 2 },
                { input: 'low', expected: 2 },
                { input: 10, expected: 10 },
                { input: 5, expected: 5 },
                { input: 1, expected: 1 }
            ];

            testCases.forEach(test => {
                const resultFixed = mapPriorityFixed(test.input);
                const resultOld = mapPriorityOld(test.input);
                
                const status = resultFixed === test.expected ? 'success' : 'error';
                log(`Input: "${test.input}" | Expected: ${test.expected} | Fixed: ${resultFixed} | Old: ${resultOld} | Status: ${status === 'success' ? '✅' : '❌'}`, status);
            });
        }

        function simulateSuggestionOrdering() {
            log('📊 Simulando ordenação de sugestões...', 'info');
            
            // Simulação de sugestões como chegam do Enhanced Engine
            const suggestions = [
                {
                    message: '⚠️ True Peak alto - CORRIJA PRIMEIRO antes de outros ajustes',
                    priority: 10,
                    type: 'true_peak',
                    metricKey: 'true_peak'
                },
                {
                    message: 'lufs fora do alvo',
                    priority: 1,
                    type: 'lufs',
                    metricKey: 'lufs'
                },
                {
                    message: 'dr fora do alvo',
                    priority: 1.44,
                    type: 'dr',
                    metricKey: 'dr'
                },
                {
                    message: 'Banda sub pode ser reforçada',
                    priority: 1.26,
                    type: 'band',
                    metricKey: 'sub'
                }
            ];

            // Simular como IA processa (converte priorities)
            const processedSuggestions = suggestions.map(sug => ({
                ...sug,
                originalPriority: sug.priority,
                processedPriority: mapPriorityFixed(sug.priority),
                backendPriority: sug.priority >= 8 ? 'alta' : sug.priority >= 5 ? 'média' : 'baixa'
            }));

            // Ordenar como sistema faria (priority desc = maior primeiro)
            processedSuggestions.sort((a, b) => b.processedPriority - a.processedPriority);

            log(`🎯 Ordem final das sugestões (${processedSuggestions.length}):`, 'info');
            
            const priorityDiv = document.getElementById('priority-test');
            processedSuggestions.forEach((sug, index) => {
                const div = document.createElement('div');
                div.className = `suggestion-card priority-${sug.backendPriority === 'alta' ? 'high' : sug.backendPriority === 'média' ? 'medium' : 'low'}`;
                div.innerHTML = `
                    <strong>#${index + 1}</strong>: ${sug.message}<br>
                    <small>
                        Original Priority: ${sug.originalPriority} | 
                        Processed: ${sug.processedPriority} | 
                        Backend: ${sug.backendPriority} |
                        Type: ${sug.type}
                    </small>
                `;
                priorityDiv.appendChild(div);
                
                const status = index === 0 && sug.type === 'true_peak' ? 'success' : index === 0 ? 'error' : 'info';
                log(`#${index + 1}: ${sug.message} (Priority: ${sug.processedPriority}, Type: ${sug.type})`, status);
            });

            if (processedSuggestions[0].type === 'true_peak') {
                log('✅ True Peak está em primeiro lugar - ORDENAÇÃO CORRETA!', 'success');
            } else {
                log('❌ True Peak NÃO está em primeiro lugar - PROBLEMA NA ORDENAÇÃO!', 'error');
            }
        }

        function runTests() {
            clearResults();
            log('🚀 Iniciando testes de ordenação...', 'info');
            
            testPriorityMapping();
            log('', 'info'); // separator
            simulateSuggestionOrdering();
            
            log('✅ Testes concluídos!', 'success');
        }

        // Auto-run on load
        window.onload = () => {
            log('🔧 Página carregada. Pronto para testar fix de ordenação.', 'info');
            runTests();
        };
    </script>
</body>
</html>