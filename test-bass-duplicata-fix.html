<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Corre√ß√£o Duplicatas Bandas Espectrais</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>üß™ Teste: Corre√ß√£o Duplicatas Bandas Espectrais</h1>
    
    <div class="test-section">
        <h2>üìä Objetivo do Teste</h2>
        <p>Verificar se todas as bandas espectrais duplicadas foram removidas da tabela de resultados.</p>
        <p><strong>Antes:</strong> M√∫ltiplas linhas para as mesmas bandas (bass/low_bass, lowMid/low_mid, etc.)</p>
        <p><strong>Depois:</strong> Apenas 1 linha por banda espectral √∫nica</p>
    </div>

    <div class="test-section">
        <h2>üîß Simula√ß√£o dos Mapeamentos Corrigidos</h2>
        <div id="test-results"></div>
    </div>

    <script>
        // üéØ TESTE: Simular os mapeamentos ANTES e DEPOIS da corre√ß√£o
        
        console.log('üß™ TESTE: Corre√ß√£o Duplicata Bass');
        
        // ANTES - Como estava (com duplica√ß√£o)
        const bandMapANTES = {
            sub: { refKey: 'sub', name: 'Sub (20‚Äì60Hz)', range: '20‚Äì60Hz' },
            bass: { refKey: 'low_bass', name: 'Bass (60‚Äì150Hz)', range: '60‚Äì150Hz' },
            low_bass: { refKey: 'low_bass', name: 'Bass (60‚Äì150Hz)', range: '60‚Äì150Hz' }, // üî¥ DUPLICATA
            lowMid: { refKey: 'low_mid', name: 'Low-Mid (150‚Äì500Hz)', range: '150‚Äì500Hz' },
            low_mid: { refKey: 'low_mid', name: 'Low-Mid (150‚Äì500Hz)', range: '150‚Äì500Hz' }, // üî¥ DUPLICATA
            mid: { refKey: 'mid', name: 'Mid (500‚Äì2kHz)', range: '500‚Äì2000Hz' },
            highMid: { refKey: 'high_mid', name: 'High-Mid (2‚Äì5kHz)', range: '2000‚Äì5000Hz' },
            high_mid: { refKey: 'high_mid', name: 'High-Mid (2‚Äì5kHz)', range: '2000‚Äì5000Hz' }, // üî¥ DUPLICATA
            presence: { refKey: 'presenca', name: 'Presence (5‚Äì10kHz)', range: '5000‚Äì10000Hz' },
            presenca: { refKey: 'presenca', name: 'Presence (5‚Äì10kHz)', range: '5000‚Äì10000Hz' }, // üî¥ DUPLICATA
            air: { refKey: 'brilho', name: 'Air (10‚Äì20kHz)', range: '10000‚Äì20000Hz' },
            brilho: { refKey: 'brilho', name: 'Air (10‚Äì20kHz)', range: '10000‚Äì20000Hz' } // üî¥ DUPLICATA
        };
        
        // DEPOIS - Como est√° agora (sem duplica√ß√£o)
        const bandMapDEPOIS = {
            sub: { refKey: 'sub', name: 'Sub (20‚Äì60Hz)', range: '20‚Äì60Hz' },
            bass: { refKey: 'low_bass', name: 'Bass (60‚Äì150Hz)', range: '60‚Äì150Hz' }, // ‚úÖ APENAS UMA
            lowMid: { refKey: 'low_mid', name: 'Low-Mid (150‚Äì500Hz)', range: '150‚Äì500Hz' }, // ‚úÖ APENAS UMA
            mid: { refKey: 'mid', name: 'Mid (500‚Äì2kHz)', range: '500‚Äì2000Hz' },
            highMid: { refKey: 'high_mid', name: 'High-Mid (2‚Äì5kHz)', range: '2000‚Äì5000Hz' }, // ‚úÖ APENAS UMA
            presence: { refKey: 'presenca', name: 'Presence (5‚Äì10kHz)', range: '5000‚Äì10000Hz' }, // ‚úÖ APENAS UMA
            air: { refKey: 'brilho', name: 'Air (10‚Äì20kHz)', range: '10000‚Äì20000Hz' } // ‚úÖ APENAS UMA
        };
        
        // Simular dados de exemplo
        const spectralBands = {
            sub: { energy_db: -18.5, percentage: 12.3, status: 'calculated' },
            bass: { energy_db: -14.2, percentage: 26.8, status: 'calculated' },
            low_bass: { energy_db: -14.2, percentage: 26.8, status: 'calculated' }, // Mesmo valor de bass
            lowMid: { energy_db: -12.1, percentage: 22.4, status: 'calculated' },
            low_mid: { energy_db: -12.1, percentage: 22.4, status: 'calculated' }, // Mesmo valor de lowMid
            mid: { energy_db: -10.8, percentage: 28.1, status: 'calculated' },
            highMid: { energy_db: -16.5, percentage: 7.8, status: 'calculated' },
            high_mid: { energy_db: -16.5, percentage: 7.8, status: 'calculated' }, // Mesmo valor de highMid
            presence: { energy_db: -22.3, percentage: 8.2, status: 'calculated' },
            presenca: { energy_db: -22.3, percentage: 8.2, status: 'calculated' }, // Mesmo valor de presence
            air: { energy_db: -28.7, percentage: 2.2, status: 'calculated' },
            brilho: { energy_db: -28.7, percentage: 2.2, status: 'calculated' } // Mesmo valor de air
        };
        
        // üß™ TESTE 1: Contar TODAS as duplicatas ANTES
        function contarDuplicatasANTES() {
            const duplicatas = {};
            Object.entries(bandMapANTES).forEach(([key, band]) => {
                if (!duplicatas[band.name]) {
                    duplicatas[band.name] = [];
                }
                duplicatas[band.name].push(key);
            });
            
            const duplicatesFound = Object.entries(duplicatas).filter(([name, keys]) => keys.length > 1);
            return duplicatesFound;
        }
        
        // üß™ TESTE 2: Contar TODAS as duplicatas DEPOIS
        function contarDuplicatasDEPOIS() {
            const duplicatas = {};
            Object.entries(bandMapDEPOIS).forEach(([key, band]) => {
                if (!duplicatas[band.name]) {
                    duplicatas[band.name] = [];
                }
                duplicatas[band.name].push(key);
            });
            
            const duplicatesFound = Object.entries(duplicatas).filter(([name, keys]) => keys.length > 1);
            return duplicatesFound;
        }
        
        // üß™ TESTE 3: Simular processamento com filtro de duplicatas
        function simularProcessamentoComFiltro() {
            const addedLabels = new Set();
            const resultRows = [];
            
            Object.entries(bandMapDEPOIS).forEach(([key, band]) => {
                const bandData = spectralBands[key];
                if (bandData && bandData.status === 'calculated') {
                    // Simular a verifica√ß√£o de duplicatas
                    if (addedLabels.has(band.name)) {
                        console.warn(`‚ö†Ô∏è Duplicata evitada: ${band.name}`);
                        return;
                    }
                    addedLabels.add(band.name);
                    
                    resultRows.push({
                        key: key,
                        name: band.name,
                        value: `${bandData.energy_db} dB (${bandData.percentage}%)`
                    });
                }
            });
            
            return resultRows;
        }
        
        // Executar testes
        const duplicatasANTES = contarDuplicatasANTES();
        const duplicatasDEPOIS = contarDuplicatasDEPOIS();
        const processedRows = simularProcessamentoComFiltro();
        
        // Gerar relat√≥rio
        const testResults = document.getElementById('test-results');
        
        let html = '<h3>üìä Resultados dos Testes</h3>';
        
        // Teste 1
        html += `<div class="${duplicatasANTES.length > 0 ? 'error' : 'success'}">`;
        html += `<h4>üî¥ ANTES da Corre√ß√£o:</h4>`;
        html += `<p><strong>Duplicatas encontradas:</strong> ${duplicatasANTES.length}</p>`;
        if (duplicatasANTES.length > 0) {
            html += '<ul>';
            duplicatasANTES.forEach(([name, keys]) => {
                html += `<li><strong>${name}:</strong> ${keys.join(', ')} (${keys.length} entradas)</li>`;
            });
            html += '</ul>';
        }
        html += `<p><strong>Status:</strong> ${duplicatasANTES.length > 0 ? '‚ùå DUPLICATAS DETECTADAS' : '‚úÖ OK'}</p>`;
        html += '</div>';
        
        // Teste 2
        html += `<div class="${duplicatasDEPOIS.length === 0 ? 'success' : 'error'}">`;
        html += `<h4>‚úÖ DEPOIS da Corre√ß√£o:</h4>`;
        html += `<p><strong>Duplicatas encontradas:</strong> ${duplicatasDEPOIS.length}</p>`;
        if (duplicatasDEPOIS.length > 0) {
            html += '<ul>';
            duplicatasDEPOIS.forEach(([name, keys]) => {
                html += `<li><strong>${name}:</strong> ${keys.join(', ')} (${keys.length} entradas)</li>`;
            });
            html += '</ul>';
        }
        html += `<p><strong>Status:</strong> ${duplicatasDEPOIS.length === 0 ? '‚úÖ TODAS AS DUPLICATAS REMOVIDAS' : '‚ùå AINDA H√Å DUPLICATAS'}</p>`;
        html += '</div>';
        
        // Teste 3
        const uniqueNames = [...new Set(processedRows.map(row => row.name))];
        html += `<div class="${processedRows.length === uniqueNames.length ? 'success' : 'error'}">`;
        html += `<h4>üîß Simula√ß√£o Final (com filtro):</h4>`;
        html += `<p><strong>Total de linhas:</strong> ${processedRows.length}</p>`;
        html += `<p><strong>Nomes √∫nicos:</strong> ${uniqueNames.length}</p>`;
        html += `<p><strong>Status:</strong> ${processedRows.length === uniqueNames.length ? '‚úÖ FILTRO FUNCIONANDO' : '‚ùå FILTRO FALHOU'}</p>`;
        html += '</div>';
        
        // Tabela final simulada
        html += '<h4>üìã Tabela Final Simulada:</h4>';
        html += '<table><thead><tr><th>Banda</th><th>Valor</th></tr></thead><tbody>';
        processedRows.forEach(row => {
            html += `<tr><td>${row.name}</td><td>${row.value}</td></tr>`;
        });
        html += '</tbody></table>';
        
        testResults.innerHTML = html;
        
        // Log no console para debug
        console.log('üî¥ DUPLICATAS ANTES:', duplicatasANTES);
        console.log('‚úÖ DUPLICATAS DEPOIS:', duplicatasDEPOIS);
        console.log('üîß PROCESSADO:', processedRows.map(r => r.name));
        console.log('üéØ Total √∫nico vs processado:', uniqueNames.length, 'vs', processedRows.length);
    </script>
</body>
</html>