<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ Teste Crest Factor - Especifica√ß√£o dBFS</title>
    <style>
        body { 
            font-family: 'Segoe UI', monospace; 
            margin: 20px; 
            background: #0d1117; 
            color: #c9d1d9; 
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .result { 
            background: #21262d; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 6px; 
            border-left: 4px solid #238636; 
        }
        .error { border-left-color: #da3633; }
        .warning { border-left-color: #f85149; }
        pre { 
            background: #161b22; 
            padding: 12px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-size: 12px; 
        }
        button { 
            background: #238636; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { background: #2ea043; }
        .spec { 
            background: #0969da; 
            color: white; 
            padding: 8px 12px; 
            border-radius: 4px; 
            display: inline-block; 
            margin: 5px 0; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Teste Crest Factor - Especifica√ß√£o dBFS</h1>
        
        <div class="spec">
            <strong>ESPECIFICA√á√ÉO:</strong> crestDb = truePeakDbtp - rmsDbfs | assert(crestDb >= 0 && crestDb <= 20)
        </div>
        
        <button onclick="testCrestFactorSpec()">üß™ Testar Crest Factor com Especifica√ß√£o</button>
        <button onclick="testValidationCases()">‚ö° Testar Casos de Valida√ß√£o</button>
        <button onclick="testTypicalValues()">üìä Testar Valores T√≠picos (8-14 dB)</button>
        
        <div id="results"></div>
    </div>

    <script type="module">
        // Importar m√≥dulo corrigido
        import { CrestFactorCalculator } from './work/lib/audio/features/dynamics-corrected.js';
        
        window.testCrestFactorSpec = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>üß™ Teste Crest Factor - Especifica√ß√£o dBFS</h3>';
            
            try {
                // Gerar sinais de teste
                const sampleRate = 48000;
                const duration = 1.0; // 1 segundo
                const length = Math.floor(sampleRate * duration);
                
                // Caso 1: Sine wave (baixo crest factor)
                const leftSine = new Float32Array(length);
                const rightSine = new Float32Array(length);
                
                for (let i = 0; i < length; i++) {
                    const t = i / sampleRate;
                    const amplitude = 0.5; // -6 dBFS peak
                    leftSine[i] = amplitude * Math.sin(2 * Math.PI * 1000 * t);
                    rightSine[i] = amplitude * Math.sin(2 * Math.PI * 1000 * t);
                }
                
                // True Peak simulado para teste
                const truePeakDbtp = 20 * Math.log10(0.5); // ~-6.02 dBTP
                
                const result1 = CrestFactorCalculator.calculateCrestFactor(leftSine, rightSine, truePeakDbtp);
                
                results.innerHTML += `
                    <div class="result">
                        <h4>üìà Caso 1: Sine Wave (1 kHz, -6 dBFS)</h4>
                        <pre>${JSON.stringify(result1, null, 2)}</pre>
                        <strong>Esperado:</strong> Crest Factor ~3 dB (sine wave te√≥rico)
                    </div>
                `;
                
                // Caso 2: Impulse (alto crest factor)
                const leftImpulse = new Float32Array(length);
                const rightImpulse = new Float32Array(length);
                
                // Impulso no meio
                leftImpulse[Math.floor(length/2)] = 0.8;
                rightImpulse[Math.floor(length/2)] = 0.8;
                
                const truePeakImpulse = 20 * Math.log10(0.8); // ~-1.94 dBTP
                
                const result2 = CrestFactorCalculator.calculateCrestFactor(leftImpulse, rightImpulse, truePeakImpulse);
                
                results.innerHTML += `
                    <div class="result">
                        <h4>‚ö° Caso 2: Impulso (Alto Crest Factor)</h4>
                        <pre>${JSON.stringify(result2, null, 2)}</pre>
                        <strong>Esperado:</strong> Crest Factor alto (>15 dB)
                    </div>
                `;
                
                // Caso 3: Ru√≠do (m√©dio crest factor)
                const leftNoise = new Float32Array(length);
                const rightNoise = new Float32Array(length);
                
                let maxNoise = 0;
                for (let i = 0; i < length; i++) {
                    leftNoise[i] = (Math.random() - 0.5) * 0.4;
                    rightNoise[i] = (Math.random() - 0.5) * 0.4;
                    maxNoise = Math.max(maxNoise, Math.abs(leftNoise[i]), Math.abs(rightNoise[i]));
                }
                
                const truePeakNoise = 20 * Math.log10(maxNoise);
                
                const result3 = CrestFactorCalculator.calculateCrestFactor(leftNoise, rightNoise, truePeakNoise);
                
                results.innerHTML += `
                    <div class="result">
                        <h4>üéµ Caso 3: Ru√≠do Branco</h4>
                        <pre>${JSON.stringify(result3, null, 2)}</pre>
                        <strong>Esperado:</strong> Crest Factor ~12-15 dB (t√≠pico para ru√≠do)
                    </div>
                `;
                
            } catch (error) {
                results.innerHTML += `
                    <div class="result error">
                        <h4>‚ùå Erro no teste</h4>
                        <pre>${error.message}\n${error.stack}</pre>
                    </div>
                `;
            }
        };
        
        window.testValidationCases = function() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>‚ö° Teste Casos de Valida√ß√£o</h3>';
            
            // Casos que devem falhar na valida√ß√£o
            const testCases = [
                { truePeak: -6, rms: -6, desc: "Crest = 0 dB (limite inferior)" },
                { truePeak: -6, rms: -26, desc: "Crest = 20 dB (limite superior)" },
                { truePeak: -6, rms: -5, desc: "Crest = -1 dB (INV√ÅLIDO)" },
                { truePeak: -6, rms: -27, desc: "Crest = 21 dB (INV√ÅLIDO)" },
                { truePeak: null, rms: -12, desc: "True Peak nulo (INV√ÅLIDO)" }
            ];
            
            testCases.forEach((testCase, i) => {
                try {
                    // Simular dados
                    const length = 1000;
                    const leftCh = new Float32Array(length);
                    const rightCh = new Float32Array(length);
                    
                    // Preencher com valor RMS simulado
                    if (testCase.rms !== null) {
                        const rmsLinear = Math.pow(10, testCase.rms / 20);
                        for (let j = 0; j < length; j++) {
                            leftCh[j] = rmsLinear * (Math.random() - 0.5) * 2 * Math.sqrt(3);
                            rightCh[j] = rmsLinear * (Math.random() - 0.5) * 2 * Math.sqrt(3);
                        }
                    }
                    
                    const result = CrestFactorCalculator.calculateCrestFactor(leftCh, rightCh, testCase.truePeak);
                    
                    const isValid = result?.valid === true && result?.assertion?.includes('PASSED');
                    const expectedValid = testCase.desc.includes('INV√ÅLIDO') ? false : true;
                    const testPassed = isValid === expectedValid;
                    
                    results.innerHTML += `
                        <div class="result ${testPassed ? '' : 'error'}">
                            <h4>${testPassed ? '‚úÖ' : '‚ùå'} Caso ${i+1}: ${testCase.desc}</h4>
                            <p><strong>Resultado:</strong> ${result?.valid ? 'V√ÅLIDO' : 'INV√ÅLIDO'}</p>
                            <p><strong>Crest Factor:</strong> ${result?.crestFactorDb?.toFixed(2) || 'null'} dB</p>
                            <p><strong>Assertion:</strong> ${result?.assertion || 'N/A'}</p>
                        </div>
                    `;
                } catch (error) {
                    results.innerHTML += `
                        <div class="result error">
                            <h4>‚ùå Erro no caso ${i+1}</h4>
                            <pre>${error.message}</pre>
                        </div>
                    `;
                }
            });
        };
        
        window.testTypicalValues = function() {
            const results = document.getElementById('results');
            results.innerHTML = '<h3>üìä Teste Valores T√≠picos (8-14 dB)</h3>';
            
            // Simular materiais musicais t√≠picos
            const materials = [
                { name: "Pop/Rock comprimido", targetCrest: 8 },
                { name: "Jazz/Cl√°ssica", targetCrest: 12 },
                { name: "Metal mastered", targetCrest: 6 },
                { name: "Ac√∫stico natural", targetCrest: 14 }
            ];
            
            materials.forEach(material => {
                try {
                    const length = 48000; // 1 segundo
                    const leftCh = new Float32Array(length);
                    const rightCh = new Float32Array(length);
                    
                    // Simular peak e RMS para obter crest factor desejado
                    const peakDbfs = -3; // -3 dBFS peak t√≠pico
                    const rmsDbfs = peakDbfs - material.targetCrest;
                    const rmsLinear = Math.pow(10, rmsDbfs / 20);
                    
                    // Gerar sinal com RMS controlado
                    for (let i = 0; i < length; i++) {
                        leftCh[i] = rmsLinear * (Math.random() - 0.5) * 2 * Math.sqrt(3);
                        rightCh[i] = rmsLinear * (Math.random() - 0.5) * 2 * Math.sqrt(3);
                    }
                    
                    const result = CrestFactorCalculator.calculateCrestFactor(leftCh, rightCh, peakDbfs);
                    
                    const inTypicalRange = result?.crestFactorDb >= 8 && result?.crestFactorDb <= 14;
                    
                    results.innerHTML += `
                        <div class="result ${inTypicalRange ? '' : 'warning'}">
                            <h4>${inTypicalRange ? 'üìä' : '‚ö†Ô∏è'} ${material.name}</h4>
                            <p><strong>Target:</strong> ${material.targetCrest} dB</p>
                            <p><strong>Calculado:</strong> ${result?.crestFactorDb?.toFixed(2) || 'null'} dB</p>
                            <p><strong>Range t√≠pico:</strong> ${inTypicalRange ? 'SIM (8-14 dB)' : 'N√ÉO'}</p>
                            <p><strong>Interpreta√ß√£o:</strong> ${result?.interpretation?.description || 'N/A'}</p>
                        </div>
                    `;
                } catch (error) {
                    results.innerHTML += `
                        <div class="result error">
                            <h4>‚ùå Erro em ${material.name}</h4>
                            <pre>${error.message}</pre>
                        </div>
                    `;
                }
            });
        };
        
        console.log('üî¨ Teste Crest Factor carregado - especifica√ß√£o dBFS implementada');
        
    </script>
</body>
</html>