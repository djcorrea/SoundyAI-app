<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üéØ Teste Final Sistema de Sugest√µes</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .test-result { 
            margin: 15px 0; 
            padding: 15px; 
            border-radius: 5px; 
            border: 1px solid #ddd;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .suggestion { 
            margin: 10px 0; 
            padding: 10px; 
            background: #f8f9fa; 
            border-left: 4px solid #007bff;
            border-radius: 3px;
        }
        .delta { font-weight: bold; color: #dc3545; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste Final - Sistema de Sugest√µes SoundyAI</h1>
        
        <div id="loadStatus" class="test-result">
            üîÑ Carregando sistema...
        </div>
        
        <div id="testResults"></div>
    </div>

    <!-- IMPORTANTE: Carregar na mesma ordem que o index.html -->
    <script src="suggestion-system-unified.js?v=20250829-fix-sugestoes"></script>
    
    <script>
        console.log('=== TESTE FINAL DO SISTEMA ===');
        
        function updateStatus(message, type = 'warning') {
            const statusDiv = document.getElementById('loadStatus');
            statusDiv.className = `test-result ${type}`;
            statusDiv.innerHTML = message;
        }
        
        function addResult(title, content, type = 'success') {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<h3>${title}</h3>${content}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        // Aguardar carregamento
        setTimeout(() => {
            console.log('üïí Verificando carregamento do sistema...');
            
            // 1. Verificar carregamento
            if (typeof window.suggestionSystem === 'undefined') {
                updateStatus('‚ùå Sistema n√£o carregado - window.suggestionSystem n√£o encontrado', 'error');
                return;
            }
            
            updateStatus('‚úÖ Sistema carregado com sucesso!', 'success');
            
            // 2. Dados de teste EXATOS como um Trance real problem√°tico
            const testAnalysis = {
                technicalData: {
                    lufs: -6.2,           // PROBLEMA: Muito alto (alvo -9.0)
                    true_peak: -0.1,      // PROBLEMA: Muito alto (limite -1.0)
                    dr: 4.5,              // PROBLEMA: Muito baixo (alvo 7.0)
                    lra: 1.8,             // OK (dentro da toler√¢ncia)
                    stereo: 0.45,         // PROBLEMA: Muito baixo (alvo 0.7)
                    bands: {
                        sub: { energy: 8.2 },        // PROBLEMA: Baixo (alvo 10.0)
                        bass: { energy: 24.5 },      // PROBLEMA: Alto (alvo 20.0)
                        low_mids: { energy: 16.1 },  // OK
                        mids: { energy: 29.3 },      // PROBLEMA: Alto (alvo 25.0)
                        high_mids: { energy: 17.8 }, // OK  
                        highs: { energy: 13.4 }      // PROBLEMA: Baixo (alvo 17.0)
                    }
                }
            };
            
            const referenceData = {
                genre: 'trance',
                lufs_target: -9.0,
                tol_lufs: 1.0,
                true_peak_target: -1.0,
                tol_true_peak: 0.5,
                dr_target: 7.0,
                tol_dr: 1.5,
                lra_target: 3.0,
                tol_lra: 1.0,
                stereo_target: 0.7,
                tol_stereo: 0.15,
                bands: {
                    sub: { target: 10.0, tolerance: 2.5 },
                    bass: { target: 20.0, tolerance: 3.5 },
                    low_mids: { target: 18.0, tolerance: 3.0 },
                    mids: { target: 25.0, tolerance: 3.5 },
                    high_mids: { target: 20.0, tolerance: 3.0 },
                    highs: { target: 17.0, tolerance: 2.5 }
                }
            };
            
            console.log('üìä Executando teste com dados problem√°ticos...');
            
            try {
                // 3. Processar sugest√µes
                const startTime = performance.now();
                const result = window.suggestionSystem.process(testAnalysis, referenceData);
                const processingTime = performance.now() - startTime;
                
                console.log('‚úÖ Resultado obtido:', result);
                
                // 4. Verificar resultado
                const suggestions = result.suggestions || [];
                
                if (suggestions.length === 0) {
                    addResult(
                        '‚ùå FALHA CR√çTICA',
                        `<p>Nenhuma sugest√£o foi gerada, mas deveria haver pelo menos 6 problemas detectados!</p>
                         <p><strong>Problemas esperados:</strong></p>
                         <ul>
                            <li>LUFS: -6.2 vs -9.0 (Œî: +3.2 LUFS) - deve reduzir</li>
                            <li>True Peak: -0.1 vs -1.0 (Œî: +0.9 dBTP) - deve reduzir</li>
                            <li>DR: 4.5 vs 7.0 (Œî: -2.5 dB) - deve aumentar</li>
                            <li>Stereo: 0.45 vs 0.7 (Œî: -0.25) - deve aumentar</li>
                            <li>Bass: 24.5 vs 20.0 (Œî: +4.5) - deve reduzir</li>
                            <li>Mids: 29.3 vs 25.0 (Œî: +4.3) - deve reduzir</li>
                         </ul>`,
                        'error'
                    );
                    return;
                }
                
                // 5. Analisar cada sugest√£o
                addResult(
                    `‚úÖ ${suggestions.length} Sugest√µes Geradas`,
                    `<p>Tempo de processamento: ${processingTime.toFixed(2)}ms</p>
                     <p>Metadata: ${JSON.stringify(result._suggestionMetadata, null, 2)}</p>`,
                    'success'
                );
                
                suggestions.forEach((suggestion, index) => {
                    const hasEducationalContent = suggestion.problem && suggestion.explanation && suggestion.solution;
                    const deltaInfo = suggestion.delta ? 
                        `${suggestion.direction === 'reduce' ? '-' : '+'}${Math.abs(suggestion.delta).toFixed(2)} ${suggestion.unit || ''}` : 
                        'N/A';
                    
                    let content = `
                        <p><strong>M√©trica:</strong> ${suggestion.metric}</p>
                        <p><strong>Delta:</strong> <span class="delta">${deltaInfo}</span></p>
                        <p><strong>Medido:</strong> ${suggestion.measured?.toFixed(2)} | <strong>Alvo:</strong> ${suggestion.target?.toFixed(2)}</p>
                        <p><strong>Severidade:</strong> ${(suggestion.severity || 0).toFixed(2)}</p>
                        <p><strong>Conte√∫do Educativo:</strong> ${hasEducationalContent ? '‚úÖ Completo' : '‚ùå Ausente'}</p>
                    `;
                    
                    if (hasEducationalContent) {
                        content += `
                            <div class="suggestion">
                                <strong>üî¥ Problema:</strong> ${suggestion.problem}<br><br>
                                <strong>üìö Explica√ß√£o:</strong> ${suggestion.explanation}<br><br>
                                <strong>‚úÖ Solu√ß√£o:</strong> ${suggestion.solution}
                            </div>
                        `;
                    } else {
                        content += `<p style="color: red;"><strong>‚ùå ERRO:</strong> Sugest√£o sem conte√∫do educativo!</p>`;
                    }
                    
                    addResult(
                        `Sugest√£o ${index + 1}: ${suggestion.metric?.toUpperCase()}`,
                        content,
                        hasEducationalContent ? 'success' : 'error'
                    );
                });
                
                // 6. Verifica√ß√£o final
                const hasAllEducationalContent = suggestions.every(s => s.problem && s.explanation && s.solution);
                const hasCorrectDeltas = suggestions.every(s => s.delta !== undefined && s.direction);
                
                addResult(
                    'üìã Verifica√ß√£o Final',
                    `
                        <p><strong>‚úÖ Conte√∫do educativo completo:</strong> ${hasAllEducationalContent ? 'SIM' : 'N√ÉO'}</p>
                        <p><strong>‚úÖ Deltas corretos:</strong> ${hasCorrectDeltas ? 'SIM' : 'N√ÉO'}</p>
                        <p><strong>‚úÖ Quantidade esperada:</strong> ${suggestions.length >= 5 ? 'SIM' : 'N√ÉO'} (${suggestions.length}/5+ esperadas)</p>
                        <p><strong>üéØ Sistema funcional:</strong> ${hasAllEducationalContent && hasCorrectDeltas && suggestions.length >= 5 ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
                    `,
                    hasAllEducationalContent && hasCorrectDeltas && suggestions.length >= 5 ? 'success' : 'error'
                );
                
            } catch (error) {
                console.error('‚ùå Erro durante teste:', error);
                addResult(
                    '‚ùå ERRO DURANTE EXECU√á√ÉO',
                    `<pre>${error.message}\n\n${error.stack}</pre>`,
                    'error'
                );
            }
            
        }, 1000); // Aguardar 1 segundo para carregamento
    </script>
</body>
</html>