<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ValidaÃ§Ã£o Subscore TÃ©cnico V3 - SoundyAI</title>
    <style>
        :root {
            --verde: #10b981;
            --amarelo: #f59e0b;
            --vermelho: #ef4444;
            --bg-dark: #1a1a2e;
            --card-bg: #252545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #818cf8;
        }
        
        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            color: #818cf8;
            margin-bottom: 15px;
            border-bottom: 1px solid #374151;
            padding-bottom: 10px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .test-card {
            background: #1e1e3f;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #374151;
        }
        
        .test-card.verde { border-left-color: var(--verde); }
        .test-card.amarela { border-left-color: var(--amarelo); }
        .test-card.vermelha { border-left-color: var(--vermelho); }
        
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .test-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .test-score {
            font-size: 2em;
            font-weight: bold;
        }
        
        .test-score.verde { color: var(--verde); }
        .test-score.amarela { color: var(--amarelo); }
        .test-score.vermelha { color: var(--vermelho); }
        
        .test-details {
            font-size: 0.9em;
            color: #94a3b8;
        }
        
        .test-reason {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            font-size: 0.85em;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .comparison div {
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            text-align: center;
        }
        
        .comparison .label {
            font-size: 0.8em;
            color: #6b7280;
            display: block;
            margin-bottom: 4px;
        }
        
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .summary-table th, .summary-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #374151;
        }
        
        .summary-table th {
            background: rgba(0,0,0,0.3);
            color: #818cf8;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .badge.verde { background: rgba(16, 185, 129, 0.2); color: var(--verde); }
        .badge.amarela { background: rgba(245, 158, 11, 0.2); color: var(--amarelo); }
        .badge.vermelha { background: rgba(239, 68, 68, 0.2); color: var(--vermelho); }
        
        .audit-box {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .audit-box h3 {
            color: #f97316;
            margin-bottom: 15px;
        }
        
        .audit-item {
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }
        
        .audit-item.fixed {
            border-left: 3px solid var(--verde);
        }
        
        .audit-item .title {
            font-weight: bold;
            color: #f97316;
        }
        
        .audit-item .description {
            color: #94a3b8;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .curva-visual {
            margin-top: 20px;
            padding: 15px;
            background: #0f172a;
            border-radius: 8px;
        }
        
        .curva-visual h4 {
            color: #818cf8;
            margin-bottom: 15px;
        }
        
        .curva-bar {
            height: 40px;
            display: flex;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .curva-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
        }
        
        .curva-segment.verde { background: var(--verde); }
        .curva-segment.amarela { background: var(--amarelo); }
        .curva-segment.vermelha { background: var(--vermelho); }
        
        .curva-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Š ValidaÃ§Ã£o Subscore TÃ©cnico V3</h1>
        <p class="subtitle">Auditoria de correÃ§Ãµes aplicadas em 19/01/2026</p>
        
        <!-- RESUMO DAS CORREÃ‡Ã•ES -->
        <div class="section">
            <h2>ğŸ“‹ CorreÃ§Ãµes Aplicadas</h2>
            
            <div class="audit-box">
                <h3>ğŸ”§ Erro #1: DetecÃ§Ã£o de Modo Streaming</h3>
                <div class="audit-item fixed">
                    <div class="title">ANTES (ERRADO)</div>
                    <div class="description">
                        <code>if (analysisMode === 'streaming')</code><br>
                        âŒ analysisMode NUNCA era 'streaming' â€” era 'genre', 'reference', etc.
                    </div>
                </div>
                <div class="audit-item fixed">
                    <div class="title">DEPOIS (CORRETO)</div>
                    <div class="description">
                        <code>if (soundDestination === 'streaming')</code><br>
                        âœ… soundDestination Ã© o campo correto para detectar streaming
                    </div>
                </div>
            </div>
            
            <div class="audit-box">
                <h3>ğŸ”§ Erro #2: Curva True Peak Streaming</h3>
                <div class="audit-item fixed">
                    <div class="title">ANTES (ERRADO)</div>
                    <div class="description">
                        Zona Verde: [-2.0, -1.2] â†’ TP -0.6 caÃ­a na zona AMARELA com score ~70
                    </div>
                </div>
                <div class="audit-item fixed">
                    <div class="title">DEPOIS (CORRETO)</div>
                    <div class="description">
                        Zona Verde: [-1.2, -0.6] â†’ TP -0.6 agora cai na zona VERDE com score 85-100<br>
                        <strong>Conforme especificaÃ§Ã£o do usuÃ¡rio:</strong><br>
                        â€¢ Zona OK: -1.2 a -0.6<br>
                        â€¢ PenalizaÃ§Ã£o leve atÃ© -0.6 âœ…<br>
                        â€¢ PenalizaÃ§Ã£o mÃ©dia atÃ© -0.3 âœ…<br>
                        â€¢ PenalizaÃ§Ã£o forte sÃ³ acima de -0.3 âœ…
                    </div>
                </div>
            </div>
            
            <div class="audit-box">
                <h3>ğŸ”§ Erro #3: Gates Redundantes</h3>
                <div class="audit-item fixed">
                    <div class="title">ANTES (ERRADO)</div>
                    <div class="description">
                        Gates de TRUE_PEAK e LUFS aplicavam mesmo em streaming, causando penalizaÃ§Ã£o dupla
                    </div>
                </div>
                <div class="audit-item fixed">
                    <div class="title">DEPOIS (CORRETO)</div>
                    <div class="description">
                        Gates desabilitados para streaming â€” score jÃ¡ vem correto das funÃ§Ãµes Strict
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CURVAS VISUAIS -->
        <div class="section">
            <h2>ğŸ“Š Curvas de Score (Streaming)</h2>
            
            <div class="curva-visual">
                <h4>True Peak (dBTP) â€” Target: -1.0</h4>
                <div class="curva-bar">
                    <div class="curva-segment vermelha" style="flex: 1;" title="< -2.0: Score 40-69">< -2.0</div>
                    <div class="curva-segment amarela" style="flex: 0.8;" title="[-2.0, -1.2): Score 70-84">-2.0 ~ -1.2</div>
                    <div class="curva-segment verde" style="flex: 0.6;" title="[-1.2, -0.6]: Score 85-100">-1.2 ~ -0.6</div>
                    <div class="curva-segment amarela" style="flex: 0.3;" title="(-0.6, -0.3]: Score 65-84">-0.6 ~ -0.3</div>
                    <div class="curva-segment vermelha" style="flex: 1.3;" title="(-0.3, +1.0]: Score 30-64">> -0.3</div>
                </div>
                <div class="curva-labels">
                    <span>-4.0</span>
                    <span>-2.0</span>
                    <span>-1.2</span>
                    <span>-0.6</span>
                    <span>-0.3</span>
                    <span>+1.0</span>
                </div>
            </div>
            
            <div class="curva-visual">
                <h4>LUFS Integrado â€” Target: -14.0</h4>
                <div class="curva-bar">
                    <div class="curva-segment vermelha" style="flex: 1;" title="< -16.0: Score â‰¤40">< -16</div>
                    <div class="curva-segment amarela" style="flex: 0.5;" title="[-16, -15): Score 60-80">-16 ~ -15</div>
                    <div class="curva-segment verde" style="flex: 1;" title="[-15, -13]: Score 90-100">-15 ~ -13</div>
                    <div class="curva-segment amarela" style="flex: 0.5;" title="(-13, -12]: Score 60-80">-13 ~ -12</div>
                    <div class="curva-segment vermelha" style="flex: 1;" title="> -12: Score â‰¤40">> -12</div>
                </div>
                <div class="curva-labels">
                    <span>-18</span>
                    <span>-16</span>
                    <span>-15</span>
                    <span>-14</span>
                    <span>-13</span>
                    <span>-12</span>
                    <span>-10</span>
                </div>
            </div>
        </div>
        
        <!-- TESTES TRUE PEAK -->
        <div class="section">
            <h2>ğŸ¯ Testes True Peak (Streaming)</h2>
            <div class="test-grid" id="tp-tests"></div>
        </div>
        
        <!-- TESTES LUFS -->
        <div class="section">
            <h2>ğŸ”Š Testes LUFS (Streaming)</h2>
            <div class="test-grid" id="lufs-tests"></div>
        </div>
        
        <!-- TABELA COMPARATIVA -->
        <div class="section">
            <h2>ğŸ“‹ Tabela Comparativa: Casos do UsuÃ¡rio</h2>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Caso</th>
                        <th>Valor Medido</th>
                        <th>Alvo</th>
                        <th>Score ANTIGO</th>
                        <th>Score CORRIGIDO</th>
                        <th>Zona</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="comparison-table"></tbody>
            </table>
        </div>
    </div>
    
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CÃ“PIA DAS FUNÃ‡Ã•ES CORRIGIDAS PARA TESTE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function calculateStreamingTruePeakScoreStrict(tp) {
            if (!Number.isFinite(tp)) {
                return { score: null, severity: 'N/A', reason: 'Valor invÃ¡lido', zone: 'unknown', conformance: 'N/A' };
            }
            
            const TARGET = -1.0;
            let score, severity, reason, zone, conformance;
            
            // CLIPPING SEVERO: > +1.0 dBTP
            if (tp > 1.0) {
                zone = 'VERMELHA';
                conformance = 'CLIPPING SEVERO';
                score = Math.max(20, Math.round(30 - (tp * 10)));
                severity = 'CRÃTICA';
                reason = `ğŸ”´ CLIPPING SEVERO! Reduzir ${(tp - TARGET).toFixed(2)} dB URGENTEMENTE`;
                return { score, severity, reason, zone, conformance, measuredTp: tp, targetTp: TARGET };
            }
            
            // ZONA VERDE: -1.2 a -0.6 dBTP (zona OK conforme especificaÃ§Ã£o)
            if (tp >= -1.2 && tp <= -0.6) {
                zone = 'VERDE';
                conformance = 'CONFORME';
                const distFromTarget = Math.abs(tp - TARGET);
                score = Math.round(100 - (distFromTarget * 75));
                score = Math.max(85, Math.min(100, score));
                severity = 'OK';
                reason = score >= 98 ? 'âœ… True Peak ideal para streaming' : `âœ… Dentro do padrÃ£o streaming (${distFromTarget.toFixed(2)} dB do ideal)`;
                return { score, severity, reason, zone, conformance, measuredTp: tp, targetTp: TARGET };
            }
            
            // ZONA AMARELA SUPERIOR: (-0.6, -0.3] (penalizaÃ§Ã£o mÃ©dia)
            if (tp > -0.6 && tp <= -0.3) {
                zone = 'AMARELA';
                conformance = 'ATENÃ‡ÃƒO';
                const distFromGreenEdge = Math.abs(tp - (-0.6));
                score = Math.round(84 - (distFromGreenEdge * 63));
                score = Math.max(65, Math.min(84, score));
                severity = 'ATENÃ‡ÃƒO';
                reason = `âš ï¸ ATENÃ‡ÃƒO: Aproximando do clipping. Considere reduzir ${(tp - TARGET).toFixed(1)} dB`;
                return { score, severity, reason, zone, conformance, measuredTp: tp, targetTp: TARGET };
            }
            
            // ZONA AMARELA INFERIOR: [-2.0, -1.2) (headroom excessivo)
            if (tp >= -2.0 && tp < -1.2) {
                zone = 'AMARELA';
                conformance = 'ATENÃ‡ÃƒO';
                const distFromGreenEdge = Math.abs(tp - (-1.2));
                score = Math.round(84 - (distFromGreenEdge * 17.5));
                score = Math.max(70, Math.min(84, score));
                severity = 'ATENÃ‡ÃƒO';
                reason = `âš ï¸ Master conservadora. Considere aumentar ${Math.abs(tp - TARGET).toFixed(1)} dB`;
                return { score, severity, reason, zone, conformance, measuredTp: tp, targetTp: TARGET };
            }
            
            // ZONA VERMELHA SUPERIOR: (-0.3, +1.0] (penalizaÃ§Ã£o forte)
            if (tp > -0.3 && tp <= 1.0) {
                zone = 'VERMELHA';
                conformance = 'CRÃTICO';
                const distFromYellowEdge = Math.abs(tp - (-0.3));
                score = Math.max(30, Math.round(64 - (distFromYellowEdge * 26)));
                severity = 'CRÃTICA';
                reason = `ğŸ”´ CLIPPING IMINENTE! Reduzir ${(tp - TARGET).toFixed(1)} dB URGENTEMENTE`;
                return { score, severity, reason, zone, conformance, measuredTp: tp, targetTp: TARGET };
            }
            
            // ZONA VERMELHA INFERIOR: < -2.0 dBTP (headroom muito excessivo)
            zone = 'VERMELHA';
            conformance = 'ERRO TÃ‰CNICO';
            const distFromYellowEdge = Math.abs(tp - (-2.0));
            score = Math.max(40, Math.round(69 - (distFromYellowEdge * 14.5)));
            severity = 'ALTA';
            reason = `âš ï¸ Headroom excessivo (${Math.abs(tp - TARGET).toFixed(1)} dB abaixo do ideal). Aumentar gain`;
            return { score, severity, reason, zone, conformance, measuredTp: tp, targetTp: TARGET };
        }
        
        function calculateStreamingLufsScoreStrict(lufs) {
            if (!Number.isFinite(lufs)) {
                return { score: null, severity: 'N/A', reason: 'Valor invÃ¡lido', zone: 'unknown', conformance: 'N/A' };
            }
            
            const TARGET = -14.0;
            let score, severity, reason, zone, conformance;
            
            // ZONA VERDE: -15.0 a -13.0 LUFS (Â±1.0 dB do target)
            if (lufs >= -15.0 && lufs <= -13.0) {
                zone = 'VERDE';
                conformance = 'CONFORME';
                const distFromTarget = Math.abs(lufs - TARGET);
                score = Math.round(100 - (distFromTarget * 10));
                score = Math.max(90, Math.min(100, score));
                severity = 'OK';
                reason = score >= 98 ? 'âœ… Conformidade total para streaming' : `âœ… Dentro do padrÃ£o streaming (${distFromTarget.toFixed(1)} LU do ideal)`;
                return { score, severity, reason, zone, conformance, measuredLufs: lufs, targetLufs: TARGET };
            }
            
            // ZONA AMARELA: [-16.0, -15.0) ou (-13.0, -12.0]
            if ((lufs >= -16.0 && lufs < -15.0) || (lufs > -13.0 && lufs <= -12.0)) {
                zone = 'AMARELA';
                conformance = 'FORA DO PADRÃƒO';
                const distFromEdge = lufs > -13.0 ? Math.abs(lufs - (-13.0)) : Math.abs(lufs - (-15.0));
                score = Math.round(80 - (distFromEdge * 20));
                score = Math.max(60, Math.min(80, score));
                severity = 'ALTA';
                reason = lufs > -13.0 
                    ? `ğŸŸ¡ FORA DO PADRÃƒO STREAMING (${(lufs - TARGET).toFixed(1)} LU acima). Reduzir urgentemente`
                    : `ğŸŸ¡ FORA DO PADRÃƒO STREAMING (${Math.abs(lufs - TARGET).toFixed(1)} LU abaixo). Aumentar urgentemente`;
                return { score, severity, reason, zone, conformance, measuredLufs: lufs, targetLufs: TARGET };
            }
            
            // ZONA VERMELHA: < -16.0 ou > -12.0
            zone = 'VERMELHA';
            conformance = 'NÃƒO CONFORME';
            const distFromLimit = lufs > -12.0 ? Math.abs(lufs - (-12.0)) : Math.abs(lufs - (-16.0));
            score = Math.max(20, Math.round(40 - (distFromLimit * 10)));
            severity = 'CRÃTICA';
            reason = lufs > -12.0 
                ? `ğŸ”´ NÃƒO CONFORME STREAMING (${(lufs - TARGET).toFixed(1)} LU acima). CORRIGIR`
                : `ğŸ”´ NÃƒO CONFORME STREAMING (${Math.abs(lufs - TARGET).toFixed(1)} LU abaixo). CORRIGIR`;
            return { score, severity, reason, zone, conformance, measuredLufs: lufs, targetLufs: TARGET };
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDERIZAÃ‡ÃƒO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function renderTestCard(result, value, unit, metricName) {
            const zone = (result.zone || 'unknown').toLowerCase();
            return `
                <div class="test-card ${zone}">
                    <div class="test-header">
                        <div class="test-value">${value.toFixed(2)} ${unit}</div>
                        <div class="test-score ${zone}">${result.score}</div>
                    </div>
                    <div class="test-details">
                        <span class="badge ${zone}">${result.zone}</span>
                        <span style="margin-left: 10px;">${result.conformance}</span>
                    </div>
                    <div class="test-reason">${result.reason}</div>
                </div>
            `;
        }
        
        // Testes True Peak
        const tpTests = [
            -0.6,  // Caso do usuÃ¡rio (deveria ser OK agora)
            -1.0,  // Ideal
            -0.8,  // PrÃ³ximo do ideal
            -1.2,  // Borda da zona verde
            -0.3,  // Borda da zona amarela/vermelha
            -0.5,  // Zona amarela
            0.0,   // Zero (clipping iminente)
            -2.0,  // Borda inferior amarela
            -3.0,  // Zona vermelha inferior
        ];
        
        document.getElementById('tp-tests').innerHTML = tpTests.map(tp => {
            const result = calculateStreamingTruePeakScoreStrict(tp);
            return renderTestCard(result, tp, 'dBTP', 'True Peak');
        }).join('');
        
        // Testes LUFS
        const lufsTests = [
            -11.8,  // Caso do usuÃ¡rio (deveria ser vermelho)
            -14.0,  // Ideal
            -13.0,  // Borda superior verde
            -15.0,  // Borda inferior verde
            -12.0,  // Borda superior amarela
            -16.0,  // Borda inferior amarela
            -11.0,  // Zona vermelha (muito alto)
            -17.0,  // Zona vermelha (muito baixo)
        ];
        
        document.getElementById('lufs-tests').innerHTML = lufsTests.map(lufs => {
            const result = calculateStreamingLufsScoreStrict(lufs);
            return renderTestCard(result, lufs, 'LUFS', 'Loudness');
        }).join('');
        
        // Tabela comparativa
        const cases = [
            { 
                name: 'True Peak', 
                value: -0.6, 
                unit: 'dBTP',
                target: -1.0,
                oldScore: '~30 (ERRADO)',
                func: calculateStreamingTruePeakScoreStrict
            },
            { 
                name: 'LUFS', 
                value: -11.8, 
                unit: 'LUFS',
                target: -14.0,
                oldScore: '~80-90 (ERRADO)',
                func: calculateStreamingLufsScoreStrict
            }
        ];
        
        document.getElementById('comparison-table').innerHTML = cases.map(c => {
            const result = c.func(c.value);
            const zone = (result.zone || 'unknown').toLowerCase();
            return `
                <tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.value} ${c.unit}</td>
                    <td>${c.target} ${c.unit}</td>
                    <td style="color: #ef4444;">${c.oldScore}</td>
                    <td><span class="test-score ${zone}">${result.score}</span></td>
                    <td><span class="badge ${zone}">${result.zone}</span></td>
                    <td>
                        ${result.zone === 'VERDE' ? 'âœ… CORRIGIDO' : 
                          result.zone === 'VERMELHA' ? 'âœ… CORRETO (deveria ser vermelho)' :
                          'âš ï¸ Revisar'}
                    </td>
                </tr>
            `;
        }).join('');
    </script>
</body>
</html>
