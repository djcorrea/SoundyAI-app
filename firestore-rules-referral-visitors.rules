// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”’ FIRESTORE SECURITY RULES - COLEÃ‡ÃƒO referral_visitors
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 
// ARQUIVO: firestore-rules-referral-visitors.rules
// 
// ğŸ¯ OBJETIVO: Regras de seguranÃ§a para a coleÃ§Ã£o referral_visitors
// 
// ARQUITETURA:
// - UsuÃ¡rios anÃ´nimos podem CRIAR visitantes (primeira visita com ?ref)
// - Apenas backend pode ATUALIZAR (vincular uid, marcar conversÃ£o)
// - UsuÃ¡rios autenticados podem LER apenas seus prÃ³prios dados
// - Parceiros podem LER dados dos visitantes com seu partnerId
// 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“‹ COLEÃ‡ÃƒO: referral_visitors/{visitorId}
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    match /referral_visitors/{visitorId} {
      
      // âœ… CREATE: AnÃ´nimos podem criar (apenas campos especÃ­ficos)
      allow create: if request.auth == null 
                    && request.resource.data.visitorId == visitorId
                    && request.resource.data.partnerId is string
                    && request.resource.data.registered == false
                    && request.resource.data.uid == null
                    && request.resource.data.converted == false
                    && request.resource.data.plan == null
                    && request.resource.data.convertedAt == null;
      
      // ğŸ”’ UPDATE: Apenas backend (via Admin SDK) pode atualizar
      // UsuÃ¡rios frontend NÃƒO podem editar (previne fraude)
      allow update: if false;
      
      // ğŸ‘ï¸ READ: UsuÃ¡rio autenticado pode ler seus prÃ³prios dados
      allow read: if request.auth != null 
                  && (resource.data.uid == request.auth.uid);
      
      // ğŸ“Š READ (Parceiros): LÃ³gica especial para partners acessarem dashboard
      // NOTA: Implementar via backend endpoint autenticado para evitar exposiÃ§Ã£o
      // Frontend do parceiro deve chamar endpoint backend, nÃ£o Firestore direto
      
      // ğŸ—‘ï¸ DELETE: Apenas backend (via Admin SDK)
      allow delete: if false;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” OBSERVAÃ‡Ã•ES DE SEGURANÃ‡A
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // 1. FRAUD PREVENTION:
    //    - UsuÃ¡rios anÃ´nimos SÃ“ podem criar com registered=false
    //    - NÃ£o podem forjar conversÃµes (converted deve ser false)
    //    - NÃ£o podem alterar apÃ³s criaÃ§Ã£o (UPDATE bloqueado)
    
    // 2. BACKEND UPDATES:
    //    - auth.js usa Firebase Client SDK mas com onAuthStateChanged (autenticado)
    //    - userPlans.js usa Admin SDK (bypass de regras)
    //    - Webhook Stripe usa Admin SDK (bypass de regras)
    
    // 3. PARTNER DASHBOARD:
    //    - Recomendado: Criar endpoint backend /api/partner/stats
    //    - Backend valida auth do parceiro (email/password)
    //    - Backend consulta referral_visitors WHERE partnerId == X
    //    - Retorna mÃ©tricas agregadas (nÃ£o expÃµe dados individuais)
    
    // 4. USER PRIVACY:
    //    - UsuÃ¡rio sÃ³ vÃª seu prÃ³prio visitorId (via uid match)
    //    - Parceiro nÃ£o vÃª email/dados pessoais (apenas mÃ©tricas)
    
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‹ INSTRUÃ‡Ã•ES DE DEPLOY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// OPÃ‡ÃƒO 1: Console Firebase
// 1. Acesse: https://console.firebase.google.com
// 2. Selecione projeto: soundy-ai
// 3. Menu: Firestore Database â†’ Rules
// 4. Copie a seÃ§Ã£o "match /referral_visitors/{visitorId}" acima
// 5. Cole DENTRO do bloco "match /databases/{database}/documents"
// 6. Clique "Publicar"
//
// OPÃ‡ÃƒO 2: Firebase CLI
// 1. firebase init firestore (se ainda nÃ£o inicializado)
// 2. Edite: firestore.rules
// 3. Adicione a seÃ§Ã£o referral_visitors
// 4. Execute: firebase deploy --only firestore:rules
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš ï¸ ATENÃ‡ÃƒO: TESTAR EM AMBIENTE DE DESENVOLVIMENTO ANTES DE PRODUÃ‡ÃƒO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// TESTES RECOMENDADOS:
// 
// Teste 1: Criar visitante anÃ´nimo
// - URL: /?ref=papohertz
// - Esperado: Documento criado em referral_visitors/
// - Validar: registered=false, uid=null, converted=false
//
// Teste 2: Cadastro vincula uid
// - Cadastrar email apÃ³s teste 1
// - Esperado: referral_visitors/{visitorId} atualizado com uid
// - Validar: registered=true, uid preenchido
//
// Teste 3: ConversÃ£o via Stripe
// - Comprar plano Plus apÃ³s teste 2
// - Esperado: referral_visitors/{visitorId} atualizado
// - Validar: converted=true, plan='plus', convertedAt preenchido
//
// Teste 4: Tentativa de fraude
// - Console navegador: Tentar updateDoc(visitorRef, {converted: true})
// - Esperado: ERRO "Missing or insufficient permissions"
// - Validar: UPDATE bloqueado para frontend
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
