<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valida√ß√£o Final - Sistema de Toler√¢ncias</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            margin: 20px; 
            line-height: 1.6; 
            background: #f8f9fa;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        h1, h2 { 
            color: #2c3e50; 
            border-bottom: 3px solid #3498db; 
            padding-bottom: 10px;
        }
        .test-case {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .success { border-left: 4px solid #28a745; background: #d4edda; }
        .warning { border-left: 4px solid #ffc107; background: #fff3cd; }
        .error { border-left: 4px solid #dc3545; background: #f8d7da; }
        .metric-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .metric-table th, .metric-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        .metric-table th {
            background: #e9ecef;
            font-weight: 600;
        }
        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover { background: #0056b3; }
        .priority-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        .priority-1 { background: #dc3545; color: white; }
        .priority-2 { background: #fd7e14; color: white; }
        .priority-3 { background: #ffc107; color: black; }
        .priority-4 { background: #17a2b8; color: white; }
        .priority-5 { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Valida√ß√£o Final - Sistema de Toler√¢ncias</h1>
        
        <div class="test-case">
            <h3>üìä Status da Valida√ß√£o</h3>
            <p><strong>Objetivo:</strong> Confirmar que todas toler√¢ncias s√£o extra√≠das corretamente, sem warnings falsas.</p>
            <p><strong>Crit√©rios de Sucesso:</strong></p>
            <ul>
                <li>‚úÖ Nenhum warning "‚ö†Ô∏è M√©trica n√£o encontrada: *_tolerance"</li>
                <li>‚úÖ True Peak deve aparecer como "Corrigir Primeiro" (priority: 1)</li>
                <li>‚úÖ Ordem de sugest√µes baseada em prioridade coerente</li>
                <li>‚úÖ Todas as toler√¢ncias (LUFS, True Peak, DR, LRA, Stereo) extra√≠das corretamente</li>
            </ul>
        </div>

        <div class="test-case">
            <button class="button" onclick="executarTeste()">üöÄ Executar Teste Completo</button>
            <button class="button" onclick="limparLogs()">üßπ Limpar Logs</button>
        </div>

        <div id="resultados">
            <!-- Resultados ser√£o inseridos aqui -->
        </div>

        <div class="test-case">
            <h3>üìù Console Logs</h3>
            <div id="logs" class="logs">Clique em "Executar Teste Completo" para come√ßar a valida√ß√£o...</div>
        </div>
    </div>

    <script src="audio-analyzer-integration.js"></script>
    <script src="enhanced-suggestion-engine.js"></script>
    <script>
        let originalConsoleLog = console.log;
        let originalConsoleWarn = console.warn;
        let originalConsoleError = console.error;
        let logBuffer = [];

        function interceptarLogs() {
            console.log = (...args) => {
                logBuffer.push(`[LOG] ${args.join(' ')}`);
                originalConsoleLog.apply(console, args);
                atualizarLogsDisplay();
            };
            
            console.warn = (...args) => {
                logBuffer.push(`[WARN] ${args.join(' ')}`);
                originalConsoleWarn.apply(console, args);
                atualizarLogsDisplay();
            };
            
            console.error = (...args) => {
                logBuffer.push(`[ERROR] ${args.join(' ')}`);
                originalConsoleError.apply(console, args);
                atualizarLogsDisplay();
            };
        }

        function limparLogs() {
            logBuffer = [];
            document.getElementById('logs').textContent = 'Logs limpos. Execute o teste novamente.';
        }

        function atualizarLogsDisplay() {
            const logsElement = document.getElementById('logs');
            logsElement.textContent = logBuffer.join('\n');
            logsElement.scrollTop = logsElement.scrollHeight;
        }

        async function executarTeste() {
            interceptarLogs();
            limparLogs();
            
            const resultados = document.getElementById('resultados');
            resultados.innerHTML = '<div class="test-case"><h3>‚è≥ Executando testes...</h3></div>';

            try {
                console.log('=== IN√çCIO DA VALIDA√á√ÉO FINAL ===');
                
                // 1. Carregar dados de refer√™ncia reais
                const referenceManager = new AudioAnalyzerIntegration();
                await referenceManager.initialize();
                
                console.log('‚úÖ AudioAnalyzerIntegration inicializado');
                
                // 2. Simular dados de an√°lise com estrutura real
                const mockAnalysisData = {
                    overall_lufs: -15.5,
                    true_peak: -0.8,
                    dynamic_range: 8.2,
                    lra: 4.1,
                    stereo_correlation: 0.85,
                    spectral_bands: {
                        sub_bass: -25.2,
                        bass: -18.7,
                        low_mid: -16.3,
                        mid: -14.8,
                        high_mid: -17.2,
                        presence: -19.5,
                        brilliance: -22.1
                    }
                };

                console.log('‚úÖ Dados de an√°lise simulados criados');

                // 3. Testar Enhanced Suggestion Engine
                const engine = new EnhancedSuggestionEngine();
                
                console.log('=== TESTE 1: Inicializa√ß√£o e An√°lise ===');
                const analiseResult = await engine.analyzeTrack(mockAnalysisData, referenceManager);
                
                console.log('=== TESTE 2: Valida√ß√£o de Toler√¢ncias ===');
                
                // Verificar se toler√¢ncias foram extra√≠das corretamente
                const toleranciasTestResults = {
                    lufs_tolerance: analiseResult.references?.tol_lufs !== undefined,
                    true_peak_tolerance: analiseResult.references?.tol_true_peak !== undefined,
                    dr_tolerance: analiseResult.references?.tol_dr !== undefined,
                    lra_tolerance: analiseResult.references?.tol_lra !== undefined,
                    stereo_tolerance: analiseResult.references?.tol_stereo !== undefined
                };

                console.log('‚úÖ Verifica√ß√£o de toler√¢ncias:', toleranciasTestResults);

                // 4. Verificar se h√° warnings de toler√¢ncia
                const warningsEncontrados = logBuffer.filter(log => 
                    log.includes('‚ö†Ô∏è M√©trica n√£o encontrada:') && 
                    log.includes('_tolerance')
                );

                console.log('=== TESTE 3: Verifica√ß√£o de Warnings ===');
                console.log(`Warnings de toler√¢ncia encontrados: ${warningsEncontrados.length}`);
                
                if (warningsEncontrados.length > 0) {
                    console.warn('‚ùå Warnings encontrados:');
                    warningsEncontrados.forEach(warning => console.warn(warning));
                } else {
                    console.log('‚úÖ Nenhum warning de toler√¢ncia encontrado!');
                }

                // 5. Verificar prioriza√ß√£o de True Peak
                console.log('=== TESTE 4: Verifica√ß√£o de Prioriza√ß√£o ===');
                
                const suggestions = analiseResult.suggestions || [];
                const truePeakSuggestion = suggestions.find(s => s.type === 'true_peak');
                
                if (truePeakSuggestion) {
                    console.log(`‚úÖ True Peak encontrado com prioridade: ${truePeakSuggestion.priority}`);
                    if (truePeakSuggestion.priority === 1) {
                        console.log('‚úÖ True Peak corretamente priorizado como "Corrigir Primeiro"');
                    } else {
                        console.warn(`‚ö†Ô∏è True Peak com prioridade ${truePeakSuggestion.priority}, esperado: 1`);
                    }
                } else {
                    console.warn('‚ö†Ô∏è True Peak n√£o encontrado nas sugest√µes');
                }

                // 6. Gerar relat√≥rio final
                gerarRelatorioFinal(analiseResult, toleranciasTestResults, warningsEncontrados, truePeakSuggestion);

            } catch (error) {
                console.error('‚ùå Erro durante a valida√ß√£o:', error);
                resultados.innerHTML = `
                    <div class="test-case error">
                        <h3>‚ùå Erro na Valida√ß√£o</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <p><strong>Stack:</strong> <code>${error.stack}</code></p>
                    </div>
                `;
            }
        }

        function gerarRelatorioFinal(analiseResult, toleranciasTestResults, warningsEncontrados, truePeakSuggestion) {
            const resultados = document.getElementById('resultados');
            
            // Calcular pontua√ß√£o de sucesso
            let pontuacaoSucesso = 0;
            let totalTestes = 6;

            // Teste 1: Toler√¢ncias extra√≠das
            const toleranciasOK = Object.values(toleranciasTestResults).every(Boolean);
            if (toleranciasOK) pontuacaoSucesso++;

            // Teste 2: Sem warnings
            const semWarnings = warningsEncontrados.length === 0;
            if (semWarnings) pontuacaoSucesso++;

            // Teste 3: True Peak priorizado
            const truePeakPriorizado = truePeakSuggestion && truePeakSuggestion.priority === 1;
            if (truePeakPriorizado) pontuacaoSucesso++;

            // Teste 4: An√°lise completada
            const analiseCompleta = analiseResult && analiseResult.suggestions;
            if (analiseCompleta) pontuacaoSucesso++;

            // Teste 5: Refer√™ncias carregadas
            const referenciasOK = analiseResult && analiseResult.references;
            if (referenciasOK) pontuacaoSucesso++;

            // Teste 6: Sistema funcional
            const sistemaFuncional = analiseResult && analiseResult.score;
            if (sistemaFuncional) pontuacaoSucesso++;

            const percentualSucesso = (pontuacaoSucesso / totalTestes) * 100;
            const statusClass = percentualSucesso >= 90 ? 'success' : 
                               percentualSucesso >= 70 ? 'warning' : 'error';

            resultados.innerHTML = `
                <div class="test-case ${statusClass}">
                    <h2>üéØ Relat√≥rio Final de Valida√ß√£o</h2>
                    <p><strong>Pontua√ß√£o:</strong> ${pontuacaoSucesso}/${totalTestes} (${percentualSucesso.toFixed(1)}%)</p>
                </div>

                <div class="test-case">
                    <h3>üìä Resultados Detalhados</h3>
                    <table class="metric-table">
                        <tr>
                            <th>Teste</th>
                            <th>Status</th>
                            <th>Detalhes</th>
                        </tr>
                        <tr>
                            <td>Toler√¢ncias Extra√≠das</td>
                            <td>${toleranciasOK ? '‚úÖ Passou' : '‚ùå Falhou'}</td>
                            <td>LUFS: ${toleranciasTestResults.lufs_tolerance ? '‚úÖ' : '‚ùå'}, 
                                True Peak: ${toleranciasTestResults.true_peak_tolerance ? '‚úÖ' : '‚ùå'}, 
                                DR: ${toleranciasTestResults.dr_tolerance ? '‚úÖ' : '‚ùå'},
                                LRA: ${toleranciasTestResults.lra_tolerance ? '‚úÖ' : '‚ùå'},
                                Stereo: ${toleranciasTestResults.stereo_tolerance ? '‚úÖ' : '‚ùå'}</td>
                        </tr>
                        <tr>
                            <td>Sem Warnings Falsos</td>
                            <td>${semWarnings ? '‚úÖ Passou' : '‚ùå Falhou'}</td>
                            <td>${warningsEncontrados.length} warnings encontrados</td>
                        </tr>
                        <tr>
                            <td>True Peak Priorizado</td>
                            <td>${truePeakPriorizado ? '‚úÖ Passou' : '‚ùå Falhou'}</td>
                            <td>Prioridade: ${truePeakSuggestion ? truePeakSuggestion.priority : 'N/A'}</td>
                        </tr>
                        <tr>
                            <td>An√°lise Completa</td>
                            <td>${analiseCompleta ? '‚úÖ Passou' : '‚ùå Falhou'}</td>
                            <td>${analiseResult?.suggestions?.length || 0} sugest√µes geradas</td>
                        </tr>
                        <tr>
                            <td>Refer√™ncias Carregadas</td>
                            <td>${referenciasOK ? '‚úÖ Passou' : '‚ùå Falhou'}</td>
                            <td>Objeto refer√™ncias: ${typeof analiseResult?.references}</td>
                        </tr>
                        <tr>
                            <td>Sistema Funcional</td>
                            <td>${sistemaFuncional ? '‚úÖ Passou' : '‚ùå Falhou'}</td>
                            <td>Score final: ${analiseResult?.score || 'N/A'}</td>
                        </tr>
                    </table>
                </div>

                ${analiseResult?.suggestions ? `
                <div class="test-case">
                    <h3>üéØ Sugest√µes Geradas (por Prioridade)</h3>
                    <table class="metric-table">
                        <tr>
                            <th>Tipo</th>
                            <th>Prioridade</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Impacto</th>
                        </tr>
                        ${analiseResult.suggestions
                            .sort((a, b) => a.priority - b.priority)
                            .map(s => `
                                <tr>
                                    <td>${s.type}
                                        <span class="priority-indicator priority-${s.priority}">
                                            P${s.priority}
                                        </span>
                                    </td>
                                    <td>${s.priority === 1 ? 'Corrigir Primeiro' : 
                                          s.priority === 2 ? 'Muito Alto' :
                                          s.priority === 3 ? 'Alto' :
                                          s.priority === 4 ? 'M√©dio' : 'Baixo'}</td>
                                    <td>${s.current_value}</td>
                                    <td>${s.target_value}</td>
                                    <td>${s.impact_score || 'N/A'}</td>
                                </tr>
                            `).join('')}
                    </table>
                </div>
                ` : ''}

                <div class="test-case ${percentualSucesso >= 90 ? 'success' : 'warning'}">
                    <h3>üéâ Conclus√£o</h3>
                    <p><strong>Status:</strong> ${
                        percentualSucesso >= 90 ? '‚úÖ VALIDA√á√ÉO APROVADA - Sistema funcionando perfeitamente!' :
                        percentualSucesso >= 70 ? '‚ö†Ô∏è VALIDA√á√ÉO PARCIAL - Alguns ajustes necess√°rios' :
                        '‚ùå VALIDA√á√ÉO REPROVADA - Corre√ß√µes cr√≠ticas necess√°rias'
                    }</p>
                    <p>${
                        percentualSucesso >= 90 ? 
                        'Todas as toler√¢ncias est√£o sendo extra√≠das corretamente, sem warnings falsos. True Peak aparece como "Corrigir Primeiro" e o sistema est√° operacional.' :
                        'Alguns testes falharam. Verifique os logs acima para detalhes espec√≠ficos.'
                    }</p>
                </div>
            `;
        }

        // Interceptar logs na inicializa√ß√£o
        interceptarLogs();
        
        console.log('üîç Sistema de Valida√ß√£o Final carregado. Clique em "Executar Teste Completo" para come√ßar.');
    </script>
</body>
</html>