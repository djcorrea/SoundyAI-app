<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Teste: Normaliza√ß√£o de M√©tricas - SoundyAI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #0f0f23;
            color: #cccccc;
        }
        .header {
            background: linear-gradient(135deg, #1e1e3f, #2d2d5f);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .test-section {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4a9eff;
        }
        .success {
            border-left-color: #28a745;
        }
        .error {
            border-left-color: #dc3545;
        }
        .warning {
            border-left-color: #ffc107;
        }
        pre {
            background: #0d1117;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .metric-item {
            background: #16213e;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #333;
        }
        .metric-name {
            font-weight: bold;
            color: #4a9eff;
        }
        .metric-value {
            color: #28a745;
        }
        .metric-missing {
            color: #dc3545;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #357abd;
        }
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Teste de Normaliza√ß√£o de M√©tricas</h1>
        <p>Verificando se todas as m√©tricas do backend s√£o convertidas corretamente para o Suggestion Engine</p>
    </div>

    <div class="test-section">
        <h3>üéØ Objetivo</h3>
        <p>Garantir que todas as m√©tricas calculadas no backend sejam convertidas corretamente para os nomes esperados pelo Suggestion Engine, evitando valores undefined e garantindo sugest√µes completas.</p>
    </div>

    <div class="test-section">
        <h3>üß™ Dados de Teste</h3>
        <button onclick="runNormalizationTest()">üöÄ Executar Teste de Normaliza√ß√£o</button>
        <button onclick="clearResults()">üßπ Limpar Resultados</button>
    </div>

    <div id="results"></div>

    <script src="audio-analyzer-integration.js"></script>
    <script>
        // üß™ Dados de teste simulando resposta do backend com nomes inconsistentes
        const mockBackendResponse = {
            technicalData: {
                // ‚ö†Ô∏è Nomes inconsistentes que precisam ser normalizados
                lufs: -18.5,           // deve virar lufsIntegrated
                dbtp: -1.2,           // deve virar truePeakDbtp  
                dr: 8.5,              // deve virar dynamicRange
                correlation: 0.85,    // deve virar stereoCorrelation
                width: 65,            // deve virar stereoWidth
                balance: 0.02,        // deve virar balanceLR
                centroid: 2500,       // deve virar spectralCentroid
                rolloff: 8000,        // deve virar spectralRolloff
                zcr: 0.15,           // deve virar zeroCrossingRate
                clipping: 15,         // deve virar clippingSamples
                clip_pct: 0.5,       // deve virar clippingPct
                dc: 0.001,           // deve virar dcOffset
                thd: 0.8,            // deve virar thdPercent
                
                // M√©tricas j√° com nomes corretos (devem ser preservadas)
                peak: -3.2,
                rms: -21.8,
                crestFactor: 12.5,
                lra: 4.2,
                lufsShortTerm: -18.8,
                lufsMomentary: -19.1,
                
                // Bandas espectrais com nomes inconsistentes
                spectral_balance: {
                    low_bass: -25.3,    // deve virar bass
                    bass: -22.1,        // j√° correto
                    low_mid: -18.5,     // deve virar lowMid
                    mid: -16.2,         // j√° correto
                    high_mid: -14.8,    // deve virar highMid
                    presence: -12.3,    // j√° correto
                    brilho: -10.1      // deve virar air
                },
                
                bandEnergies: {
                    sub_bass: 0.05,     // deve virar subBass
                    low_bass: 0.12,     // deve virar bass
                    bass: 0.18,         // j√° correto
                    low_mids: 0.22,     // deve virar lowMid
                    mids: 0.25,         // deve virar mid
                    high_mids: 0.20,    // deve virar highMid
                    presence: 0.15,     // j√° correto
                    brilliance: 0.08    // deve virar air
                }
            },
            problems: ['mock_problem'],
            suggestions: ['mock_suggestion'],
            qualityOverall: 7.5
        };

        function runNormalizationTest() {
            const resultsDiv = document.getElementById('results');
            
            try {
                console.log('üß™ Iniciando teste de normaliza√ß√£o...');
                
                // Executar normaliza√ß√£o
                const normalized = normalizeBackendAnalysisData(mockBackendResponse);
                
                // Verificar se a fun√ß√£o de normaliza√ß√£o existe
                if (typeof normalizeMetricNames !== 'function') {
                    throw new Error('Fun√ß√£o normalizeMetricNames n√£o encontrada!');
                }
                
                if (typeof normalizeSpectralBands !== 'function') {
                    throw new Error('Fun√ß√£o normalizeSpectralBands n√£o encontrada!');
                }
                
                // Executar normaliza√ß√µes individuais para teste
                const normalizedMetrics = normalizeMetricNames(mockBackendResponse.technicalData);
                const normalizedBands = normalizeSpectralBands(mockBackendResponse.technicalData.spectral_balance || {});
                const normalizedEnergies = normalizeSpectralBands(mockBackendResponse.technicalData.bandEnergies || {});
                
                resultsDiv.innerHTML = `
                    <div class="test-section success">
                        <h3>‚úÖ Teste Executado com Sucesso!</h3>
                        <p>Todas as fun√ß√µes de normaliza√ß√£o foram encontradas e executadas.</p>
                    </div>
                    
                    <div class="test-section">
                        <h3>üìä M√©tricas Normalizadas</h3>
                        <div class="metric-grid">
                            ${generateMetricValidation(normalized.technicalData, normalizedMetrics)}
                        </div>
                    </div>
                    
                    <div class="test-section">
                        <h3>üéµ Bandas Espectrais Normalizadas</h3>
                        <div class="metric-grid">
                            ${generateBandValidation(normalized.technicalData.spectral_balance, normalizedBands)}
                        </div>
                    </div>
                    
                    <div class="test-section">
                        <h3>üîä Energias de Banda Normalizadas</h3>
                        <div class="metric-grid">
                            ${generateBandValidation(normalized.technicalData.bandEnergies, normalizedEnergies)}
                        </div>
                    </div>
                    
                    <div class="test-section">
                        <h3>üîç Verifica√ß√£o de M√©tricas Undefined</h3>
                        ${checkUndefinedMetrics(normalized.technicalData)}
                    </div>
                    
                    <div class="test-section">
                        <h3>üìù Log Detalhado</h3>
                        <pre>${JSON.stringify(normalized, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
                resultsDiv.innerHTML = `
                    <div class="test-section error">
                        <h3>‚ùå Erro no Teste</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }
        
        function generateMetricValidation(finalData, normalizedData) {
            const expectedMappings = {
                'lufs ‚Üí lufsIntegrated': [finalData.lufsIntegrated, normalizedData.lufsIntegrated],
                'dbtp ‚Üí truePeakDbtp': [finalData.truePeakDbtp, normalizedData.truePeakDbtp],
                'dr ‚Üí dynamicRange': [finalData.dynamicRange, normalizedData.dynamicRange],
                'correlation ‚Üí stereoCorrelation': [finalData.stereoCorrelation, normalizedData.stereoCorrelation],
                'width ‚Üí stereoWidth': [finalData.stereoWidth, normalizedData.stereoWidth],
                'balance ‚Üí balanceLR': [finalData.balanceLR, normalizedData.balanceLR],
                'centroid ‚Üí spectralCentroid': [finalData.spectralCentroid, normalizedData.spectralCentroid],
                'rolloff ‚Üí spectralRolloff': [finalData.spectralRolloff, normalizedData.spectralRolloff],
                'zcr ‚Üí zeroCrossingRate': [finalData.zeroCrossingRate, normalizedData.zeroCrossingRate],
                'clipping ‚Üí clippingSamples': [finalData.clippingSamples, normalizedData.clippingSamples],
                'clip_pct ‚Üí clippingPct': [finalData.clippingPct, normalizedData.clippingPct],
                'dc ‚Üí dcOffset': [finalData.dcOffset, normalizedData.dcOffset],
                'thd ‚Üí thdPercent': [finalData.thdPercent, normalizedData.thdPercent]
            };
            
            return Object.entries(expectedMappings)
                .map(([mapping, [finalValue, normalizedValue]]) => {
                    const isValid = finalValue !== undefined && normalizedValue !== undefined;
                    const className = isValid ? 'metric-value' : 'metric-missing';
                    return `
                        <div class="metric-item">
                            <div class="metric-name">${mapping}</div>
                            <div class="${className}">
                                Final: ${finalValue !== undefined ? finalValue : 'undefined'}<br>
                                Normalizado: ${normalizedValue !== undefined ? normalizedValue : 'undefined'}
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        function generateBandValidation(finalData, normalizedData) {
            const expectedBandMappings = {
                'low_bass ‚Üí bass': [finalData?.bass, normalizedData?.bass],
                'low_mid ‚Üí lowMid': [finalData?.lowMid, normalizedData?.lowMid],
                'high_mid ‚Üí highMid': [finalData?.highMid, normalizedData?.highMid],
                'brilho ‚Üí air': [finalData?.air, normalizedData?.air],
                'sub_bass ‚Üí subBass': [finalData?.subBass, normalizedData?.subBass],
                'low_mids ‚Üí lowMid': [finalData?.lowMid, normalizedData?.lowMid],
                'mids ‚Üí mid': [finalData?.mid, normalizedData?.mid],
                'high_mids ‚Üí highMid': [finalData?.highMid, normalizedData?.highMid],
                'brilliance ‚Üí air': [finalData?.air, normalizedData?.air]
            };
            
            return Object.entries(expectedBandMappings)
                .map(([mapping, [finalValue, normalizedValue]]) => {
                    const isValid = finalValue !== undefined && normalizedValue !== undefined;
                    const className = isValid ? 'metric-value' : 'metric-missing';
                    return `
                        <div class="metric-item">
                            <div class="metric-name">${mapping}</div>
                            <div class="${className}">
                                Final: ${finalValue !== undefined ? finalValue : 'undefined'}<br>
                                Normalizado: ${normalizedValue !== undefined ? normalizedValue : 'undefined'}
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        function checkUndefinedMetrics(technicalData) {
            const undefinedMetrics = Object.entries(technicalData)
                .filter(([key, value]) => value === undefined)
                .map(([key]) => key);
            
            if (undefinedMetrics.length === 0) {
                return `
                    <div class="metric-item success">
                        <div class="metric-name">‚úÖ Verifica√ß√£o Completa</div>
                        <div class="metric-value">
                            Nenhuma m√©trica undefined detectada!<br>
                            Todas as ${Object.keys(technicalData).length} m√©tricas foram normalizadas com sucesso.
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="metric-item error">
                        <div class="metric-name">‚ö†Ô∏è M√©tricas Undefined</div>
                        <div class="metric-missing">
                            ${undefinedMetrics.length} m√©tricas undefined:<br>
                            ${undefinedMetrics.join(', ')}
                        </div>
                    </div>
                `;
            }
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            console.clear();
            console.log('üßπ Resultados limpos');
        }
        
        // Auto-executar teste ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ P√°gina de teste carregada');
            console.log('üéØ Objetivo: Testar normaliza√ß√£o de m√©tricas do backend para Suggestion Engine');
        });
    </script>
</body>
</html>