<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üîß Diagn√≥stico Completo - Sugest√µes SoundyAI</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f8ff; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { 
            background: #007bff; color: white; border: none; padding: 10px 20px; 
            border-radius: 5px; cursor: pointer; margin: 5px; 
        }
        button:hover { background: #0056b3; }
        .log { 
            background: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; 
            font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; 
        }
        .suggestion-card {
            margin: 10px 0; padding: 15px; background: #ffffff; 
            border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .metric-header { font-weight: bold; color: #007bff; font-size: 16px; margin-bottom: 8px; }
        .delta-display { 
            background: #f8f9fa; padding: 8px; border-radius: 5px; 
            font-weight: bold; color: #dc3545; margin: 5px 0; 
        }
        .educational-content { 
            margin: 10px 0; padding: 10px; border-left: 4px solid #28a745; 
            background: #f8fff9; border-radius: 0 5px 5px 0; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Diagn√≥stico Completo - Sistema de Sugest√µes</h1>
        <p>Este teste vai diagnosticar exatamente por que as sugest√µes n√£o est√£o aparecendo ou est√£o erradas.</p>
        
        <!-- Se√ß√£o 1: Status do Sistema -->
        <div class="section info">
            <h2>üìä 1. Status do Sistema</h2>
            <div id="systemStatus" class="log">Verificando...</div>
            <button onclick="checkSystem()">üîç Verificar Sistema</button>
        </div>
        
        <!-- Se√ß√£o 2: Teste de Carregamento -->
        <div class="section warning">
            <h2>‚ö° 2. Teste de Carregamento</h2>
            <div id="loadTest" class="log">Aguardando...</div>
            <button onclick="testLoading()">üì• Testar Carregamento</button>
        </div>
        
        <!-- Se√ß√£o 3: Teste de Dados -->
        <div class="section info">
            <h2>üß™ 3. Teste com Dados Reais</h2>
            <div id="dataTest" class="log">Aguardando...</div>
            <button onclick="testWithRealData()">üéµ Testar Dados do Trance</button>
        </div>
        
        <!-- Se√ß√£o 4: Display das Sugest√µes -->
        <div class="section">
            <h2>üí° 4. Resultado das Sugest√µes</h2>
            <div id="suggestionsDisplay">
                <p style="color: #6c757d;">As sugest√µes aparecer√£o aqui depois dos testes...</p>
            </div>
        </div>
        
        <!-- Se√ß√£o 5: Diagn√≥stico de Problemas -->
        <div class="section error">
            <h2>üö® 5. Diagn√≥stico de Problemas</h2>
            <div id="problemDiagnostic" class="log">
                <p>Problemas comuns que podem impedir o funcionamento:</p>
                <ul>
                    <li>‚ùå Sistema n√£o carregado (window.suggestionSystem undefined)</li>
                    <li>‚ùå M√©todos ausentes (process, normalizer, etc.)</li>
                    <li>‚ùå Dados de entrada inv√°lidos</li>
                    <li>‚ùå Erros de processamento</li>
                    <li>‚ùå Textos educativos n√£o gerados</li>
                </ul>
            </div>
            <button onclick="runFullDiagnostic()">üîç Executar Diagn√≥stico Completo</button>
        </div>
    </div>

    <!-- Carregar sistema (mesma ordem do index.html) -->
    <script src="suggestion-system-unified.js?v=20250829-fix-sugestoes"></script>
    
    <script>
        let logs = [];
        
        function log(message, section = 'general') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            logs.push({timestamp, message, section});
            console.log(entry);
        }
        
        function displayLogs(sectionId, sectionFilter = null) {
            const container = document.getElementById(sectionId);
            const filteredLogs = sectionFilter ? logs.filter(l => l.section === sectionFilter) : logs;
            container.innerHTML = filteredLogs.map(l => `[${l.timestamp}] ${l.message}`).join('\n');
        }
        
        function checkSystem() {
            logs = logs.filter(l => l.section !== 'system');
            log('üîç Verificando status do sistema...', 'system');
            
            // Verificar window.suggestionSystem
            if (typeof window.suggestionSystem === 'undefined') {
                log('‚ùå FALHA CR√çTICA: window.suggestionSystem n√£o existe!', 'system');
                log('Isso significa que o arquivo suggestion-system-unified.js n√£o foi carregado ou falhou.', 'system');
            } else {
                log('‚úÖ window.suggestionSystem encontrado', 'system');
                log(`Tipo: ${typeof window.suggestionSystem}`, 'system');
                
                // Verificar m√©todos
                const methods = ['process'];
                methods.forEach(method => {
                    if (typeof window.suggestionSystem[method] === 'function') {
                        log(`‚úÖ M√©todo ${method}() dispon√≠vel`, 'system');
                    } else {
                        log(`‚ùå M√©todo ${method}() N√ÉO encontrado!`, 'system');
                    }
                });
                
                // Verificar engine e componentes
                if (window.suggestionSystem.engine) {
                    log('‚úÖ Engine dispon√≠vel', 'system');
                    const components = ['normalizer', 'scorer', 'textGenerator'];
                    components.forEach(comp => {
                        if (window.suggestionSystem.engine[comp]) {
                            log(`‚úÖ ${comp} dispon√≠vel`, 'system');
                        } else {
                            log(`‚ùå ${comp} N√ÉO encontrado!`, 'system');
                        }
                    });
                } else {
                    log('‚ùå Engine N√ÉO encontrada!', 'system');
                }
                
                // Verificar vari√°vel de controle
                if (window.USE_UNIFIED_SUGGESTIONS === true) {
                    log('‚úÖ USE_UNIFIED_SUGGESTIONS = true', 'system');
                } else {
                    log(`‚ö†Ô∏è USE_UNIFIED_SUGGESTIONS = ${window.USE_UNIFIED_SUGGESTIONS}`, 'system');
                }
            }
            
            displayLogs('systemStatus', 'system');
        }
        
        function testLoading() {
            logs = logs.filter(l => l.section !== 'loading');
            log('üì• Testando carregamento do sistema...', 'loading');
            
            // Verificar se os scripts foram adicionados ao DOM
            const scripts = document.querySelectorAll('script[src*="suggestion-system"]');
            log(`Scripts encontrados: ${scripts.length}`, 'loading');
            
            scripts.forEach((script, index) => {
                log(`Script ${index + 1}: ${script.src}`, 'loading');
                log(`  - Carregado: ${script.readyState || 'unknown'}`, 'loading');
            });
            
            // Verificar erros de carregamento
            if (window.suggestionSystem) {
                log('‚úÖ Sistema carregado com sucesso', 'loading');
                
                // Teste r√°pido de instancia√ß√£o
                try {
                    const testInstance = new window.SuggestionSystemUnified();
                    log('‚úÖ Nova inst√¢ncia criada com sucesso', 'loading');
                } catch (error) {
                    log(`‚ùå Erro ao criar nova inst√¢ncia: ${error.message}`, 'loading');
                }
            } else {
                log('‚ùå Sistema N√ÉO carregado', 'loading');
                log('Poss√≠veis causas: erro de sintaxe, falha de rede, ordem de carregamento', 'loading');
            }
            
            displayLogs('loadTest', 'loading');
        }
        
        function testWithRealData() {
            logs = logs.filter(l => l.section !== 'data');
            log('üéµ Testando com dados reais de Trance...', 'data');
            
            if (!window.suggestionSystem) {
                log('‚ùå Sistema n√£o dispon√≠vel para teste!', 'data');
                displayLogs('dataTest', 'data');
                return;
            }
            
            // Dados que DEVEM gerar sugest√µes
            const testAnalysis = {
                technicalData: {
                    lufs: -5.8,           // MUITO ALTO (alvo: -9.0)
                    true_peak: 0.2,       // ACIMA DO LIMITE (limite: -1.0)
                    dr: 3.2,              // MUITO BAIXO (alvo: 7.0)
                    lra: 1.5,             // OK
                    stereo: 0.4,          // MUITO BAIXO (alvo: 0.7)
                    bands: {
                        sub: { energy: 6.8 },        // BAIXO
                        bass: { energy: 28.2 },      // ALTO
                        low_mids: { energy: 14.5 },  // OK
                        mids: { energy: 32.1 },      // MUITO ALTO
                        high_mids: { energy: 15.8 }, // OK
                        highs: { energy: 11.2 }      // BAIXO
                    }
                }
            };
            
            const referenceData = {
                genre: 'trance',
                lufs_target: -9.0, tol_lufs: 1.0,
                true_peak_target: -1.0, tol_true_peak: 0.5,
                dr_target: 7.0, tol_dr: 1.5,
                lra_target: 3.0, tol_lra: 1.0,
                stereo_target: 0.7, tol_stereo: 0.15,
                bands: {
                    sub: { target: 10.0, tolerance: 2.5 },
                    bass: { target: 20.0, tolerance: 3.5 },
                    low_mids: { target: 18.0, tolerance: 3.0 },
                    mids: { target: 25.0, tolerance: 3.5 },
                    high_mids: { target: 20.0, tolerance: 3.0 },
                    highs: { target: 17.0, tolerance: 2.5 }
                }
            };
            
            log('üìä Dados preparados - problemas esperados:', 'data');
            log(`  LUFS: ${testAnalysis.technicalData.lufs} vs ${referenceData.lufs_target} (deve reduzir ${Math.abs(testAnalysis.technicalData.lufs - referenceData.lufs_target).toFixed(1)})`, 'data');
            log(`  True Peak: ${testAnalysis.technicalData.true_peak} vs ${referenceData.true_peak_target} (deve reduzir ${Math.abs(testAnalysis.technicalData.true_peak - referenceData.true_peak_target).toFixed(1)})`, 'data');
            log(`  DR: ${testAnalysis.technicalData.dr} vs ${referenceData.dr_target} (deve aumentar ${Math.abs(testAnalysis.technicalData.dr - referenceData.dr_target).toFixed(1)})`, 'data');
            log(`  Stereo: ${testAnalysis.technicalData.stereo} vs ${referenceData.stereo_target} (deve aumentar ${Math.abs(testAnalysis.technicalData.stereo - referenceData.stereo_target).toFixed(2)})`, 'data');
            
            try {
                log('‚ö° Executando processamento...', 'data');
                const startTime = performance.now();
                
                const result = window.suggestionSystem.process(testAnalysis, referenceData);
                
                const endTime = performance.now();
                log(`‚úÖ Processamento conclu√≠do em ${(endTime - startTime).toFixed(2)}ms`, 'data');
                
                if (!result) {
                    log('‚ùå ERRO: Resultado null/undefined!', 'data');
                    displayLogs('dataTest', 'data');
                    return;
                }
                
                const suggestions = result.suggestions || [];
                log(`üìã Sugest√µes encontradas: ${suggestions.length}`, 'data');
                
                if (suggestions.length === 0) {
                    log('‚ùå PROBLEMA: Nenhuma sugest√£o gerada!', 'data');
                    log('Isso √© inesperado, pois h√° v√°rios problemas nos dados de teste.', 'data');
                    
                    // Debug metadata
                    if (result._suggestionMetadata) {
                        log(`Metadata: ${JSON.stringify(result._suggestionMetadata)}`, 'data');
                    }
                } else {
                    log('‚úÖ Sugest√µes geradas com sucesso!', 'data');
                    
                    // Verificar qualidade das sugest√µes
                    suggestions.forEach((suggestion, index) => {
                        const hasEducation = suggestion.problem && suggestion.explanation && suggestion.solution;
                        const hasCorrectDelta = suggestion.delta !== undefined && suggestion.direction;
                        
                        log(`Sugest√£o ${index + 1} (${suggestion.metric}):`, 'data');
                        log(`  - Delta: ${suggestion.delta?.toFixed(2)} (dire√ß√£o: ${suggestion.direction})`, 'data');
                        log(`  - Educa√ß√£o: ${hasEducation ? '‚úÖ' : '‚ùå'} ${hasEducation ? 'Completa' : 'Ausente'}`, 'data');
                    });
                    
                    // Mostrar sugest√µes na UI
                    displaySuggestions(suggestions);
                }
                
            } catch (error) {
                log(`‚ùå ERRO durante processamento: ${error.message}`, 'data');
                log(`Stack: ${error.stack}`, 'data');
            }
            
            displayLogs('dataTest', 'data');
        }
        
        function displaySuggestions(suggestions) {
            const container = document.getElementById('suggestionsDisplay');
            
            if (!suggestions || suggestions.length === 0) {
                container.innerHTML = '<div class="error section">‚ùå Nenhuma sugest√£o encontrada!</div>';
                return;
            }
            
            let html = `<h3 style="color: #28a745;">‚úÖ ${suggestions.length} Sugest√µes Encontradas:</h3>`;
            
            suggestions.forEach((suggestion, index) => {
                const deltaText = suggestion.delta ? 
                    `${suggestion.direction === 'reduce' ? 'Reduzir' : 'Aumentar'} ${Math.abs(suggestion.delta).toFixed(2)} ${suggestion.unit || ''}` :
                    'Delta n√£o calculado';
                    
                const hasEducation = suggestion.problem && suggestion.explanation && suggestion.solution;
                
                html += `
                    <div class="suggestion-card">
                        <div class="metric-header">
                            ${index + 1}. ${suggestion.metric?.toUpperCase() || 'M√©trica desconhecida'}
                        </div>
                        
                        <div class="delta-display">
                            üéØ ${deltaText}
                            <br>üìä Medido: ${suggestion.measured?.toFixed(2) || 'N/A'} | Alvo: ${suggestion.target?.toFixed(2) || 'N/A'}
                        </div>
                        
                        ${hasEducation ? `
                            <div class="educational-content">
                                <strong>üî¥ Problema:</strong><br>
                                ${suggestion.problem}<br><br>
                                
                                <strong>üìö Explica√ß√£o:</strong><br>
                                ${suggestion.explanation}<br><br>
                                
                                <strong>‚úÖ Solu√ß√£o:</strong><br>
                                ${suggestion.solution}
                            </div>
                        ` : `
                            <div style="color: red; font-weight: bold;">
                                ‚ùå ERRO: Conte√∫do educativo ausente!
                            </div>
                        `}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function runFullDiagnostic() {
            document.getElementById('problemDiagnostic').innerHTML = '<p>üîç Executando diagn√≥stico completo...</p>';
            
            setTimeout(() => {
                checkSystem();
                setTimeout(() => {
                    testLoading();
                    setTimeout(() => {
                        testWithRealData();
                        
                        // Resumo final
                        setTimeout(() => {
                            const hasSystem = typeof window.suggestionSystem !== 'undefined';
                            const hasProcess = hasSystem && typeof window.suggestionSystem.process === 'function';
                            
                            const diagnostic = `
                                <h4>üìã Resumo do Diagn√≥stico:</h4>
                                <p><strong>Sistema carregado:</strong> ${hasSystem ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
                                <p><strong>M√©todo process():</strong> ${hasProcess ? '‚úÖ SIM' : '‚ùå N√ÉO'}</p>
                                <p><strong>Status geral:</strong> ${hasSystem && hasProcess ? '‚úÖ FUNCIONAL' : '‚ùå COM PROBLEMAS'}</p>
                                
                                ${!hasSystem ? '<p style="color: red;"><strong>SOLU√á√ÉO:</strong> Verificar carregamento do arquivo suggestion-system-unified.js</p>' : ''}
                                ${hasSystem && !hasProcess ? '<p style="color: red;"><strong>SOLU√á√ÉO:</strong> Erro na implementa√ß√£o do sistema - verificar console para erros de sintaxe</p>' : ''}
                            `;
                            
                            document.getElementById('problemDiagnostic').innerHTML = diagnostic;
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 500);
        }
        
        // Auto-executar ao carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('üöÄ P√°gina carregada, executando verifica√ß√£o inicial...', 'general');
                checkSystem();
            }, 1000);
        });
    </script>
</body>
</html>