<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Sistema de Sugest√µes</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error { color: #dc3545; font-weight: bold; }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .suggestion-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            background: white;
        }
        .suggestion-metric {
            font-weight: bold;
            color: #007bff;
        }
        .suggestion-text {
            margin: 5px 0;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 3px;
        }
        .delta-info {
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Sistema de Sugest√µes SoundyAI</h1>
        
        <div class="test-section">
            <h2>üìã Status do Sistema</h2>
            <div id="systemStatus" class="log"></div>
            <button onclick="checkSystemStatus()">Verificar Sistema</button>
        </div>

        <div class="test-section">
            <h2>üéµ Teste com Dados Reais do Trance</h2>
            <p>Simulando an√°lise de uma m√∫sica Trance para verificar as sugest√µes.</p>
            <div id="tranceResults" class="log"></div>
            <button onclick="testTranceSuggestions()">Testar Trance</button>
        </div>

        <div class="test-section">
            <h2>üß™ Teste de M√©tricas Individuais</h2>
            <div id="metricsResults" class="log"></div>
            <button onclick="testIndividualMetrics()">Testar M√©tricas</button>
        </div>

        <div class="test-section">
            <h2>üìù Resultado das Sugest√µes</h2>
            <div id="suggestionsDisplay"></div>
        </div>
    </div>

    <!-- Carregar sistema de sugest√µes -->
    <script src="public/suggestion-system-unified.js"></script>
    
    <script>
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push({timestamp, message, type});
            console.log(logEntry);
        }

        function displayLog(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = debugLog.map(entry => 
                `<div class="${entry.type}">[${entry.timestamp}] ${entry.message}</div>`
            ).join('');
        }

        function checkSystemStatus() {
            debugLog = [];
            log('üîç Verificando status do sistema...', 'info');
            
            // Verificar se o sistema foi carregado
            if (typeof window.suggestionSystem === 'undefined') {
                log('‚ùå window.suggestionSystem n√£o encontrado!', 'error');
            } else {
                log('‚úÖ window.suggestionSystem encontrado', 'success');
                log(`Tipo: ${typeof window.suggestionSystem}`, 'info');
                
                // Verificar m√©todos
                if (typeof window.suggestionSystem.process === 'function') {
                    log('‚úÖ M√©todo process() dispon√≠vel', 'success');
                } else {
                    log('‚ùå M√©todo process() n√£o encontrado!', 'error');
                }
                
                // Verificar engine
                if (window.suggestionSystem.engine) {
                    log('‚úÖ Engine dispon√≠vel', 'success');
                    
                    // Verificar componentes da engine
                    const components = ['normalizer', 'scorer', 'textGenerator'];
                    components.forEach(comp => {
                        if (window.suggestionSystem.engine[comp]) {
                            log(`‚úÖ Engine.${comp} dispon√≠vel`, 'success');
                        } else {
                            log(`‚ùå Engine.${comp} n√£o encontrado!`, 'error');
                        }
                    });
                } else {
                    log('‚ùå Engine n√£o encontrada!', 'error');
                }
            }
            
            displayLog('systemStatus');
        }

        function testTranceSuggestions() {
            debugLog = [];
            log('üéµ Testando sugest√µes para Trance...', 'info');
            
            if (!window.suggestionSystem) {
                log('‚ùå Sistema n√£o dispon√≠vel!', 'error');
                displayLog('tranceResults');
                return;
            }

            // Dados de teste simulando uma an√°lise real
            const testAnalysis = {
                technicalData: {
                    lufs: -6.5,           // Muito alto para Trance
                    true_peak: -0.2,      // Acima do limite
                    dr: 4.8,              // Baixo para Trance
                    lra: 2.1,             // Dentro da faixa
                    stereo: 0.65,         // OK
                    bands: {
                        sub: { energy: 12.5 },
                        bass: { energy: 18.3 },
                        low_mids: { energy: 15.7 },
                        mids: { energy: 22.1 },
                        high_mids: { energy: 16.9 },
                        highs: { energy: 14.5 }
                    }
                }
            };

            // Dados de refer√™ncia para Trance
            const referenceData = {
                genre: 'trance',
                lufs_target: -9.0,
                tol_lufs: 1.0,
                true_peak_target: -1.0,
                tol_true_peak: 0.5,
                dr_target: 7.0,
                tol_dr: 1.5,
                lra_target: 3.0,
                tol_lra: 1.0,
                stereo_target: 0.7,
                tol_stereo: 0.2,
                bands: {
                    sub: { target: 10.0, tolerance: 3.0 },
                    bass: { target: 20.0, tolerance: 4.0 },
                    low_mids: { target: 18.0, tolerance: 3.0 },
                    mids: { target: 25.0, tolerance: 4.0 },
                    high_mids: { target: 20.0, tolerance: 3.0 },
                    highs: { target: 17.0, tolerance: 3.0 }
                }
            };

            log('üìä Dados de teste preparados:', 'info');
            log(`LUFS: ${testAnalysis.technicalData.lufs} (alvo: ${referenceData.lufs_target})`, 'info');
            log(`True Peak: ${testAnalysis.technicalData.true_peak} (limite: ${referenceData.true_peak_target})`, 'info');
            log(`DR: ${testAnalysis.technicalData.dr} (alvo: ${referenceData.dr_target})`, 'info');

            try {
                // Processar sugest√µes
                const result = window.suggestionSystem.process(testAnalysis, referenceData);
                
                log(`‚úÖ Processamento conclu√≠do!`, 'success');
                log(`Sugest√µes encontradas: ${result.suggestions.length}`, 'info');
                
                if (result._suggestionMetadata) {
                    log(`G√™nero processado: ${result._suggestionMetadata.genre}`, 'info');
                    log(`Tempo de processamento: ${result._suggestionMetadata.processingTimeMs?.toFixed(2)}ms`, 'info');
                    
                    if (result._suggestionMetadata.error) {
                        log(`‚ùå Erro reportado: ${result._suggestionMetadata.error}`, 'error');
                    }
                }

                // Exibir sugest√µes detalhadas
                displaySuggestions(result.suggestions);
                
                if (result.suggestions.length === 0) {
                    log('‚ö†Ô∏è Nenhuma sugest√£o gerada! Verificando motivos...', 'warning');
                    
                    // Debug: verificar cada m√©trica individualmente
                    log('üîç Debug das m√©tricas:', 'info');
                    
                    // LUFS
                    const lufsDelta = testAnalysis.technicalData.lufs - referenceData.lufs_target;
                    log(`LUFS Delta: ${lufsDelta.toFixed(2)} (toler√¢ncia: ${referenceData.tol_lufs})`, 'info');
                    log(`LUFS deve gerar sugest√£o? ${Math.abs(lufsDelta) > referenceData.tol_lufs}`, 'info');
                    
                    // True Peak
                    const tpExcess = testAnalysis.technicalData.true_peak - referenceData.true_peak_target;
                    log(`True Peak Excesso: ${tpExcess.toFixed(2)} (deve ser > 0)`, 'info');
                    log(`True Peak deve gerar sugest√£o? ${tpExcess > 0}`, 'info');
                    
                    // DR
                    const drDelta = testAnalysis.technicalData.dr - referenceData.dr_target;
                    log(`DR Delta: ${drDelta.toFixed(2)} (toler√¢ncia: ${referenceData.tol_dr})`, 'info');
                    log(`DR deve gerar sugest√£o? ${Math.abs(drDelta) > referenceData.tol_dr}`, 'info');
                }

            } catch (error) {
                log(`‚ùå Erro durante processamento: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
            
            displayLog('tranceResults');
        }

        function testIndividualMetrics() {
            debugLog = [];
            log('üß™ Testando m√©tricas individuais...', 'info');
            
            if (!window.suggestionSystem || !window.suggestionSystem.engine) {
                log('‚ùå Sistema ou engine n√£o dispon√≠vel!', 'error');
                displayLog('metricsResults');
                return;
            }

            const engine = window.suggestionSystem.engine;
            
            // Teste do normalizador
            try {
                log('üîß Testando normalizador...', 'info');
                
                const testMetrics = {
                    lufs: -8.5,
                    true_peak: -0.5,
                    dr: 6.0,
                    bands: { bass: { energy: 20.0 } }
                };
                
                const normalized = engine.normalizer.normalizeBackendMetrics(testMetrics);
                log(`‚úÖ Normaliza√ß√£o OK: ${Object.keys(normalized).length} m√©tricas`, 'success');
                log(`M√©tricas normalizadas: ${Object.keys(normalized).join(', ')}`, 'info');
                
                // Teste de refer√™ncia
                const testRef = {
                    genre: 'trance',
                    lufs_target: -9.0,
                    tol_lufs: 1.0
                };
                
                const normalizedRef = engine.normalizer.normalizeReferenceData(testRef);
                if (normalizedRef) {
                    log(`‚úÖ Normaliza√ß√£o de refer√™ncia OK: g√™nero ${normalizedRef.genre}`, 'success');
                } else {
                    log('‚ùå Falha na normaliza√ß√£o de refer√™ncia', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro no normalizador: ${error.message}`, 'error');
            }

            // Teste do gerador de texto
            try {
                log('üìù Testando gerador de texto...', 'info');
                
                const testSuggestion = {
                    metric: 'lufs',
                    measured: -6.5,
                    target: -9.0,
                    tolerance: 1.0,
                    delta: 2.5,
                    direction: 'reduce',
                    unit: 'LUFS',
                    genre: 'trance',
                    severity: 0.8
                };
                
                const textResult = engine.textGenerator.generateText(testSuggestion);
                
                if (textResult.problem && textResult.explanation && textResult.solution) {
                    log('‚úÖ Gera√ß√£o de texto OK: todas as camadas presentes', 'success');
                    log(`Problema: "${textResult.problem.substring(0, 50)}..."`, 'info');
                    log(`Explica√ß√£o: "${textResult.explanation.substring(0, 50)}..."`, 'info');
                    log(`Solu√ß√£o: "${textResult.solution.substring(0, 50)}..."`, 'info');
                } else {
                    log('‚ùå Gera√ß√£o de texto incompleta', 'error');
                    log(`Campos presentes: ${Object.keys(textResult).join(', ')}`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå Erro no gerador de texto: ${error.message}`, 'error');
            }
            
            displayLog('metricsResults');
        }

        function displaySuggestions(suggestions) {
            const container = document.getElementById('suggestionsDisplay');
            
            if (!suggestions || suggestions.length === 0) {
                container.innerHTML = '<p class="warning">‚ùå Nenhuma sugest√£o encontrada</p>';
                return;
            }
            
            let html = `<h3>‚úÖ ${suggestions.length} Sugest√µes Encontradas:</h3>`;
            
            suggestions.forEach((suggestion, index) => {
                html += `
                    <div class="suggestion-item">
                        <div class="suggestion-metric">
                            ${index + 1}. ${suggestion.metric?.toUpperCase()} 
                            <span class="delta-info">
                                (Œî: ${suggestion.direction === 'reduce' ? '-' : '+'}${Math.abs(suggestion.delta || 0).toFixed(2)} ${suggestion.unit || ''})
                            </span>
                        </div>
                        
                        ${suggestion.problem ? `
                            <div class="suggestion-text">
                                <strong>üî¥ Problema:</strong> ${suggestion.problem}
                            </div>
                        ` : ''}
                        
                        ${suggestion.explanation ? `
                            <div class="suggestion-text">
                                <strong>üìö Explica√ß√£o:</strong> ${suggestion.explanation}
                            </div>
                        ` : ''}
                        
                        ${suggestion.solution ? `
                            <div class="suggestion-text">
                                <strong>‚úÖ Solu√ß√£o:</strong> ${suggestion.solution}
                            </div>
                        ` : ''}
                        
                        <div class="delta-info">
                            Medido: ${suggestion.measured?.toFixed(2)} | 
                            Alvo: ${suggestion.target?.toFixed(2)} | 
                            Severidade: ${(suggestion.severity || 0).toFixed(2)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Auto-executar verifica√ß√£o inicial
        window.onload = function() {
            setTimeout(() => {
                checkSystemStatus();
            }, 500);
        };
    </script>
</body>
</html>