<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß TESTE: Integra√ß√£o Scoring.js Corrigida</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; background: #0a0a0a; color: #e0e0e0; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #1e3c72, #2a5298); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .test-section { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4CAF50; }
        .logs { background: #0d1117; padding: 15px; border-radius: 6px; margin: 10px 0; font-family: 'Fira Code', 'Consolas', monospace; font-size: 13px; overflow-x: auto; border: 1px solid #30363d; }
        .success { color: #51cf66; font-weight: bold; }
        .error { color: #ff6b6b; font-weight: bold; }
        .warning { color: #ffd43b; font-weight: bold; }
        .emoji { font-size: 1.3em; margin-right: 8px; }
        .status-indicator { padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; margin: 0 5px; }
        .status-ok { background: #1b5e1f; color: #51cf66; }
        .status-error { background: #5e1b1b; color: #ff6b6b; }
        .status-warning { background: #5e4b1b; color: #ffd43b; }
        button { background: #2a5298; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 10px 5px; }
        button:hover { background: #1e3c72; }
        #testResults { min-height: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="emoji">üîß</span>TESTE: Integra√ß√£o Scoring.js Corrigida</h1>
            <p><strong>Objetivo:</strong> Verificar se o scoring.js carrega sem erros e elimina o fallback</p>
            <p><strong>Status:</strong> <span id="loadStatus" class="warning">‚è≥ Carregando...</span></p>
        </div>

        <div class="test-section">
            <h3><span class="emoji">üìã</span>Testes Autom√°ticos de Carregamento</h3>
            <button onclick="runFullTest()">üß™ Executar Teste Completo</button>
            <button onclick="testCalculateMetricScore()">üìä Testar calculateMetricScore</button>
            <button onclick="clearLogs()">üßπ Limpar Logs</button>
            
            <div id="testResults" class="logs">
                Clique em "Executar Teste Completo" para iniciar...
            </div>
        </div>

        <div class="test-section">
            <h3><span class="emoji">üîç</span>Status das Fun√ß√µes-Chave</h3>
            <div id="functionStatus">
                <div>üîÑ Verificando disponibilidade das fun√ß√µes...</div>
            </div>
        </div>
    </div>

    <!-- üéØ CARREGAR SCORING.JS (CORRIGIDO) -->
    <script src="public/lib/audio/features/scoring.js"></script>
    
    <!-- üéØ CARREGAR ADVANCED EDUCATIONAL SYSTEM -->
    <script src="public/advanced-educational-suggestion-system.js?v=20250920-ultra" defer></script>

    <script>
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const colorClass = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            
            testResults.push(`[${timestamp}] ${emoji} ${message}`);
            updateDisplay();
            console.log(`${emoji} [TEST] ${message}`);
        }

        function updateDisplay() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = testResults.map(result => 
                `<div class="${result.includes('‚úÖ') ? 'success' : result.includes('‚ùå') ? 'error' : result.includes('‚ö†Ô∏è') ? 'warning' : ''}">${result}</div>`
            ).join('');
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearLogs() {
            testResults = [];
            updateDisplay();
            document.getElementById('testResults').innerHTML = 'Logs limpos. Execute novos testes...';
        }

        function updateLoadStatus(status, type) {
            const statusElement = document.getElementById('loadStatus');
            statusElement.innerHTML = `<span class="status-indicator status-${type}">${status}</span>`;
        }

        function updateFunctionStatus() {
            const statusDiv = document.getElementById('functionStatus');
            
            // Verificar todas as fun√ß√µes necess√°rias
            const functions = [
                { name: 'window.computeMixScore', available: typeof window.computeMixScore === 'function' },
                { name: 'window.computeMixScoreBoth', available: typeof window.computeMixScoreBoth === 'function' },
                { name: 'window.calculateMetricScore', available: typeof window.calculateMetricScore === 'function' },
                { name: 'window.AdvancedEducationalSuggestionSystem', available: typeof window.AdvancedEducationalSuggestionSystem !== 'undefined' },
                { name: 'window.__MIX_SCORING_VERSION__', available: !!window.__MIX_SCORING_VERSION__ }
            ];

            const statusHTML = functions.map(func => {
                const statusClass = func.available ? 'status-ok' : 'status-error';
                const statusText = func.available ? 'OK' : 'AUSENTE';
                return `<div>${func.name}: <span class="status-indicator ${statusClass}">${statusText}</span></div>`;
            }).join('');

            statusDiv.innerHTML = statusHTML;
            
            // Update main status
            const allAvailable = functions.every(f => f.available);
            if (allAvailable) {
                updateLoadStatus('‚úÖ Todas as fun√ß√µes carregadas', 'ok');
            } else {
                const missing = functions.filter(f => !f.available).length;
                updateLoadStatus(`‚ùå ${missing} fun√ß√£o(√µes) ausente(s)`, 'error');
            }
        }

        async function runFullTest() {
            log('üß™ Iniciando teste completo da integra√ß√£o scoring.js...', 'info');
            
            // Teste 1: Verificar carregamento b√°sico
            log('üì¶ Teste 1: Verificando carregamento das fun√ß√µes principais...', 'info');
            
            const hasComputeMixScore = typeof window.computeMixScore === 'function';
            const hasCalculateMetricScore = typeof window.calculateMetricScore === 'function';
            const hasVersion = !!window.__MIX_SCORING_VERSION__;
            const hasAdvancedSystem = typeof window.AdvancedEducationalSuggestionSystem !== 'undefined';
            
            log(`computeMixScore: ${hasComputeMixScore ? '‚úÖ Dispon√≠vel' : '‚ùå Ausente'}`, hasComputeMixScore ? 'success' : 'error');
            log(`calculateMetricScore: ${hasCalculateMetricScore ? '‚úÖ Dispon√≠vel' : '‚ùå Ausente'}`, hasCalculateMetricScore ? 'success' : 'error');
            log(`__MIX_SCORING_VERSION__: ${hasVersion ? '‚úÖ ' + window.__MIX_SCORING_VERSION__ : '‚ùå Ausente'}`, hasVersion ? 'success' : 'error');
            log(`AdvancedEducationalSuggestionSystem: ${hasAdvancedSystem ? '‚úÖ Dispon√≠vel' : '‚ùå Ausente'}`, hasAdvancedSystem ? 'success' : 'error');
            
            // Teste 2: Teste funcional do calculateMetricScore
            if (hasCalculateMetricScore) {
                log('üìä Teste 2: Testando funcionalidade do calculateMetricScore...', 'info');
                await testCalculateMetricScore();
            } else {
                log('‚ùå Teste 2: Pulado - calculateMetricScore n√£o dispon√≠vel', 'error');
            }
            
            // Teste 3: Verificar se n√£o est√° caindo no fallback
            log('üîç Teste 3: Verificando se n√£o cai no fallback...', 'info');
            
            // Capturar console.warn para detectar fallback
            const originalWarn = console.warn;
            let fallbackDetected = false;
            
            console.warn = function(...args) {
                if (args.some(arg => typeof arg === 'string' && arg.includes('FALLBACK'))) {
                    fallbackDetected = true;
                    log('‚ùå FALLBACK detectado: ' + args.join(' '), 'error');
                }
                originalWarn.apply(console, args);
            };
            
            // Executar uma opera√ß√£o que deveria usar o scoring.js
            try {
                const testResult = window.calculateMetricScore(10, 8, 2, 'test');
                if (!fallbackDetected) {
                    log('‚úÖ Nenhum fallback detectado - usando scoring.js corretamente!', 'success');
                } else {
                    log('‚ö†Ô∏è Fallback foi acionado mesmo com scoring.js dispon√≠vel', 'warning');
                }
            } catch (error) {
                log('‚ùå Erro ao testar calculateMetricScore: ' + error.message, 'error');
            } finally {
                console.warn = originalWarn;
            }
            
            // Resultado final
            const successCount = testResults.filter(r => r.includes('‚úÖ')).length;
            const errorCount = testResults.filter(r => r.includes('‚ùå')).length;
            
            log(`üéØ Teste completo finalizado: ${successCount} sucessos, ${errorCount} erros`, errorCount === 0 ? 'success' : 'warning');
            
            if (errorCount === 0) {
                log('üéâ SUCESSO TOTAL: Integra√ß√£o scoring.js funcionando perfeitamente!', 'success');
            }
        }

        async function testCalculateMetricScore() {
            if (typeof window.calculateMetricScore !== 'function') {
                log('‚ùå calculateMetricScore n√£o dispon√≠vel para teste', 'error');
                return;
            }

            log('üìä Testando calculateMetricScore com valores reais...', 'info');
            
            // Testes com diferentes cen√°rios
            const tests = [
                { actual: 10, target: 8, tolerance: 2, expected: 'should work' },
                { actual: -12, target: -14, tolerance: 3, expected: 'negative values' },
                { actual: 0.5, target: 0.7, tolerance: 0.3, expected: 'decimals' }
            ];
            
            for (const test of tests) {
                try {
                    const result = window.calculateMetricScore(test.actual, test.target, test.tolerance, 'test');
                    if (result !== null && typeof result === 'number') {
                        log(`‚úÖ Test (${test.expected}): ${test.actual} vs ${test.target} ¬±${test.tolerance} = ${result.toFixed(2)}`, 'success');
                    } else {
                        log(`‚ö†Ô∏è Test (${test.expected}): resultado inv√°lido (${result})`, 'warning');
                    }
                } catch (error) {
                    log(`‚ùå Test (${test.expected}): erro - ${error.message}`, 'error');
                }
            }
        }

        // Verificar status quando a p√°gina carrega
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateFunctionStatus();
                log('üîÑ Status inicial verificado', 'info');
            }, 200);
        });

        // Verificar periodicamente se tudo carregou
        const checkInterval = setInterval(() => {
            updateFunctionStatus();
            
            // Parar de verificar quando tudo estiver carregado
            if (typeof window.calculateMetricScore === 'function' && 
                typeof window.computeMixScore === 'function' && 
                window.__MIX_SCORING_VERSION__) {
                clearInterval(checkInterval);
                log('‚úÖ Todas as fun√ß√µes principais detectadas e carregadas!', 'success');
            }
        }, 500);

        // Parar verifica√ß√£o ap√≥s 10 segundos
        setTimeout(() => {
            clearInterval(checkInterval);
        }, 10000);
    </script>
</body>
</html>