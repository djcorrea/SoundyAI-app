<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Teste - Detec√ß√£o Autom√°tica EQ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #0a0a0a;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.warning {
            background: #ff9800;
        }
        .button.danger {
            background: #f44336;
        }
        .log-output {
            background: #000;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        .status.warning {
            background: #f57c00;
            border-left: 4px solid #ff9800;
        }
        .status.info {
            background: #1976d2;
            border-left: 4px solid #2196f3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #333;
        }
        .metric-high {
            color: #ff5722;
            font-weight: bold;
        }
        .metric-normal {
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste - Sistema de Detec√ß√£o Autom√°tica de EQ</h1>
        <p>Este teste simula diferentes cen√°rios de an√°lise de √°udio para verificar se o sistema detecta automaticamente quando deve ativar o <strong>Modo T√©cnico Absoluto</strong>.</p>

        <div class="test-section">
            <h2>üéõÔ∏è Controles de Teste</h2>
            <button class="button" onclick="testarEQNormal()">üü¢ Testar EQ Normal (‚â§1.5dB)</button>
            <button class="button warning" onclick="testarEQModerado()">üü° Testar EQ Moderado (~2.0dB)</button>
            <button class="button danger" onclick="testarEQExtremo()">üî¥ Testar EQ Extremo (>3dB)</button>
            <button class="button" onclick="limparLogs()">üßπ Limpar Logs</button>
        </div>

        <div class="test-section">
            <h2>üìä Status da Detec√ß√£o</h2>
            <div id="statusDeteccao" class="status info">Aguardando teste...</div>
            <div id="statusModo" class="status info">Modo: Normal</div>
        </div>

        <div class="test-section">
            <h2>üìà Dados de Teste Simulados</h2>
            <table id="tabelaBandas">
                <thead>
                    <tr>
                        <th>Banda</th>
                        <th>RMS dB</th>
                        <th>Varia√ß√£o</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="corpoTabelaBandas">
                    <tr><td colspan="4">Nenhum teste executado</td></tr>
                </tbody>
            </table>
        </div>

        <div class="test-section">
            <h2>üîç Log de Console</h2>
            <div id="logOutput" class="log-output">Logs aparecer√£o aqui...\n</div>
        </div>
    </div>

    <!-- Carregar o sistema principal -->
    <script src="audio-analyzer-integration.js"></script>
    
    <script>
        // üìù Sistema de captura de logs
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        
        function addToLogOutput(message, type = 'log') {
            const logDiv = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'warn' ? '‚ö†Ô∏è' : type === 'error' ? '‚ùå' : 'üìù';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToLogOutput(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addToLogOutput(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToLogOutput(args.join(' '), 'error');
        };

        // üéØ Fun√ß√£o de teste para EQ normal (sem ativa√ß√£o autom√°tica)
        function testarEQNormal() {
            console.log('\nüü¢ ========== TESTE: EQ NORMAL ==========');
            
            const bandasNormais = {
                sub: { rms_db: -30.5 },
                bass: { rms_db: -31.2 },
                lowMid: { rms_db: -30.8 },
                mid: { rms_db: -29.9 },
                highMid: { rms_db: -30.3 },
                presence: { rms_db: -31.0 },
                air: { rms_db: -30.7 }
            };
            
            simularDeteccaoAutomatica(bandasNormais, 'EQ Normal');
        }

        // üéØ Fun√ß√£o de teste para EQ moderado (pode ativar)
        function testarEQModerado() {
            console.log('\nüü° ========== TESTE: EQ MODERADO ==========');
            
            const bandasModeradas = {
                sub: { rms_db: -32.0 },
                bass: { rms_db: -28.5 },  // +3.5dB diferen√ßa
                lowMid: { rms_db: -31.0 },
                mid: { rms_db: -29.0 },   // +2dB diferen√ßa  
                highMid: { rms_db: -30.5 },
                presence: { rms_db: -27.0 }, // +5dB diferen√ßa
                air: { rms_db: -31.5 }
            };
            
            simularDeteccaoAutomatica(bandasModeradas, 'EQ Moderado');
        }

        // üéØ Fun√ß√£o de teste para EQ extremo (deve ativar)
        function testarEQExtremo() {
            console.log('\nüî¥ ========== TESTE: EQ EXTREMO ==========');
            
            const bandasExtremas = {
                sub: { rms_db: -35.0 },
                bass: { rms_db: -25.0 },   // +10dB diferen√ßa!
                lowMid: { rms_db: -32.0 },
                mid: { rms_db: -22.0 },    // +13dB diferen√ßa!
                highMid: { rms_db: -28.0 },
                presence: { rms_db: -20.0 }, // +15dB diferen√ßa!
                air: { rms_db: -33.0 }
            };
            
            simularDeteccaoAutomatica(bandasExtremas, 'EQ Extremo');
        }

        // üîç Simular o algoritmo de detec√ß√£o autom√°tica
        function simularDeteccaoAutomatica(rawBandEnergies, tipoTeste) {
            console.log(`üîç [SIMULA√á√ÉO] Iniciando detec√ß√£o autom√°tica para: ${tipoTeste}`);
            
            // Calcular desvio padr√£o das bandas (mesmo algoritmo do sistema real)
            const validRMSValues = Object.values(rawBandEnergies)
                .map(band => band?.rms_db)
                .filter(value => Number.isFinite(value));
                
            if (validRMSValues.length >= 3) {
                const mean = validRMSValues.reduce((sum, val) => sum + val, 0) / validRMSValues.length;
                const variance = validRMSValues.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / validRMSValues.length;
                const stdDev = Math.sqrt(variance);
                
                // Detectar varia√ß√£o extrema entre bandas (threshold: 1.5 dB)
                const avgVariation = stdDev;
                const VARIATION_THRESHOLD = 1.5; // dB
                
                const shouldActivate = avgVariation > VARIATION_THRESHOLD;
                
                console.log(`üìä [DETEC√á√ÉO] M√©dia: ${mean.toFixed(2)} dB`);
                console.log(`üìä [DETEC√á√ÉO] Desvio padr√£o: ${avgVariation.toFixed(2)} dB`);
                console.log(`üìä [DETEC√á√ÉO] Threshold: ${VARIATION_THRESHOLD} dB`);
                console.log(`üìä [DETEC√á√ÉO] Deve ativar modo absoluto: ${shouldActivate ? 'SIM' : 'N√ÉO'}`);
                
                if (shouldActivate) {
                    console.warn(`üéõÔ∏è [AUTO-DETECT] Varia√ß√£o espectral significativa detectada: ${avgVariation.toFixed(2)} dB > ${VARIATION_THRESHOLD} dB`);
                    console.warn('üîÑ [AUTO-DETECT] Ativando MODO ABSOLUTO automaticamente para exibir EQ real');
                } else {
                    console.log(`üìä [AUTO-DETECT] Varia√ß√£o espectral normal: ${avgVariation.toFixed(2)} dB ‚â§ ${VARIATION_THRESHOLD} dB - mantendo modo educacional`);
                }
                
                // Atualizar interface
                atualizarInterface(rawBandEnergies, avgVariation, shouldActivate, tipoTeste);
            }
        }

        // üé® Atualizar interface com resultados
        function atualizarInterface(bandas, variacao, ativado, tipoTeste) {
            // Status da detec√ß√£o
            const statusDiv = document.getElementById('statusDeteccao');
            if (ativado) {
                statusDiv.className = 'status warning';
                statusDiv.innerHTML = `üéõÔ∏è <strong>DETEC√á√ÉO ATIVADA!</strong><br>Varia√ß√£o: ${variacao.toFixed(2)} dB > 1.5 dB<br>Tipo: ${tipoTeste}`;
            } else {
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `‚úÖ <strong>Detec√ß√£o Normal</strong><br>Varia√ß√£o: ${variacao.toFixed(2)} dB ‚â§ 1.5 dB<br>Tipo: ${tipoTeste}`;
            }
            
            // Status do modo
            const modoDiv = document.getElementById('statusModo');
            if (ativado) {
                modoDiv.className = 'status warning';
                modoDiv.innerHTML = 'üî• <strong>Modo: T√âCNICO ABSOLUTO (Autom√°tico)</strong><br>Exibindo valores reais em dB RMS';
            } else {
                modoDiv.className = 'status info';
                modoDiv.innerHTML = 'üìö <strong>Modo: Educacional (Normal)</strong><br>Valores normalizados para aprendizado';
            }
            
            // Tabela de bandas
            const corpoTabela = document.getElementById('corpoTabelaBandas');
            corpoTabela.innerHTML = '';
            
            const mean = Object.values(bandas)
                .map(b => b.rms_db)
                .reduce((sum, val) => sum + val, 0) / Object.keys(bandas).length;
            
            Object.entries(bandas).forEach(([banda, dados]) => {
                const variacao = Math.abs(dados.rms_db - mean);
                const row = corpoTabela.insertRow();
                row.innerHTML = `
                    <td>${banda}</td>
                    <td class="${variacao > 1.5 ? 'metric-high' : 'metric-normal'}">${dados.rms_db} dB</td>
                    <td class="${variacao > 1.5 ? 'metric-high' : 'metric-normal'}">${variacao.toFixed(2)} dB</td>
                    <td>${variacao > 1.5 ? 'üî¥ Alta' : 'üü¢ Normal'}</td>
                `;
            });
        }

        // üßπ Limpar logs
        function limparLogs() {
            document.getElementById('logOutput').textContent = 'Logs aparecer√£o aqui...\n';
        }

        // üöÄ Inicializa√ß√£o
        console.log('üöÄ Sistema de teste carregado');
        console.log('üí° Clique nos bot√µes acima para testar diferentes cen√°rios de EQ');
    </script>
</body>
</html>