<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ AUDITORIA FINAL: Sistema Educativo</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #0a0e1a; color: #e0e6ed; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-card { background: #141b2d; border: 1px solid #2a3441; border-radius: 8px; padding: 20px; margin: 15px 0; }
        .result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background: #0f4c3a; border-left: 4px solid #10b981; }
        .error { background: #4c1d1d; border-left: 4px solid #ef4444; }
        .warning { background: #4c3d1d; border-left: 4px solid #f59e0b; }
        .info { background: #1e3a8a; border-left: 4px solid #3b82f6; }
        .audit-section { border: 2px solid #374151; margin: 15px 0; padding: 20px; background: #1f2937; border-radius: 8px; }
        .status-ok { color: #10b981; font-weight: bold; }
        .status-error { color: #ef4444; font-weight: bold; }
        .status-warning { color: #f59e0b; font-weight: bold; }
        button { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 8px; font-size: 14px; }
        button:hover { background: #2563eb; }
        .big-button { font-size: 16px; padding: 15px 30px; background: #059669; }
        .big-button:hover { background: #047857; }
        pre { background: #0f1419; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 13px; border: 1px solid #374151; }
        .highlight { background: #fbbf24; color: #000; padding: 2px 6px; border-radius: 3px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ AUDITORIA FINAL: Sistema Educativo</h1>
        <p>Verifica√ß√£o completa do sistema de <span class="highlight">score educativo por toler√¢ncia</span> e <span class="highlight">mensagens educativas com limita√ß√£o de dB</span></p>
        
        <div class="test-card">
            <h2>üöÄ AUDITORIA COMPLETA</h2>
            <button class="big-button" onclick="runCompleteAudit()">üîç EXECUTAR AUDITORIA COMPLETA</button>
            <div id="audit-results"></div>
        </div>

        <div class="test-card">
            <h2>üìä SIMULA√á√ÉO REAL DO PIPELINE</h2>
            <button onclick="simulateRealPipeline()">üéµ Simular An√°lise de √Åudio Real</button>
            <div id="pipeline-results"></div>
        </div>

        <div class="test-card">
            <h2>üéì CEN√ÅRIOS EDUCATIVOS ESPEC√çFICOS</h2>
            <button onclick="testEducationalScenarios()">üìö Testar Cen√°rios Educativos</button>
            <div id="educational-results"></div>
        </div>
    </div>

    <!-- Carregar todos os scripts necess√°rios -->
    <script src="public/lib/audio/features/scoring.js"></script>
    <script src="public/suggestion-scorer.js"></script>
    <script src="public/enhanced-suggestion-engine.js"></script>

    <script>
        function log(message, type = 'info') {
            const classes = { success: 'success', error: 'error', warning: 'warning', info: 'info' };
            return `<div class="result ${classes[type]}">${message}</div>`;
        }

        function runCompleteAudit() {
            let html = '<div class="audit-section"><h3>üîç AUDITORIA COMPLETA DO SISTEMA EDUCATIVO</h3>';
            
            // 1. Verificar carregamento dos m√≥dulos
            html += '<h4>üì¶ 1. M√ìDULOS CARREGADOS</h4>';
            const hasScoringJS = typeof window.calculateMetricScore === 'function';
            const hasSuggestionScorer = typeof window.SuggestionScorer === 'function';
            const hasGlobalScorer = typeof window.suggestionScorer === 'object' && window.suggestionScorer;
            const hasEnhancedEngine = typeof window.EnhancedSuggestionEngine === 'function';
            
            html += `<div class="result ${hasScoringJS ? 'success' : 'error'}">`;
            html += `‚úÖ scoring.js (calculateMetricScore): <span class="${hasScoringJS ? 'status-ok' : 'status-error'}">${hasScoringJS ? 'OK' : 'AUSENTE'}</span>`;
            html += '</div>';
            
            html += `<div class="result ${hasSuggestionScorer ? 'success' : 'error'}">`;
            html += `‚úÖ suggestion-scorer.js (SuggestionScorer): <span class="${hasSuggestionScorer ? 'status-ok' : 'status-error'}">${hasSuggestionScorer ? 'OK' : 'AUSENTE'}</span>`;
            html += '</div>';
            
            html += `<div class="result ${hasGlobalScorer ? 'success' : 'error'}">`;
            html += `‚úÖ Inst√¢ncia Global (window.suggestionScorer): <span class="${hasGlobalScorer ? 'status-ok' : 'status-error'}">${hasGlobalScorer ? 'OK' : 'AUSENTE'}</span>`;
            html += '</div>';
            
            html += `<div class="result ${hasEnhancedEngine ? 'success' : 'error'}">`;
            html += `‚úÖ Enhanced Suggestion Engine: <span class="${hasEnhancedEngine ? 'status-ok' : 'status-error'}">${hasEnhancedEngine ? 'OK' : 'AUSENTE'}</span>`;
            html += '</div>';
            
            // 2. Testar Score Educativo por Toler√¢ncia
            html += '<h4>üéì 2. SCORE EDUCATIVO POR TOLER√ÇNCIA</h4>';
            if (hasScoringJS) {
                const toleranceTests = [
                    { desc: 'Perfeito (0 dB diferen√ßa)', actual: -14, target: -14, tolerance: 1, expected: 100 },
                    { desc: 'Limite exato da toler√¢ncia', actual: -15, target: -14, tolerance: 1, expected: 100 },
                    { desc: 'Pouco fora (score educativo)', actual: -16, target: -14, tolerance: 1, expectedMin: 70 },
                    { desc: 'Muito fora (score m√≠nimo)', actual: -20, target: -14, tolerance: 1, expectedMin: 10 }
                ];
                
                toleranceTests.forEach(test => {
                    try {
                        const score = window.calculateMetricScore(test.actual, test.target, test.tolerance, 'lufs');
                        const diff = Math.abs(test.actual - test.target);
                        
                        let isValid = false;
                        if (test.expected) {
                            isValid = score === test.expected;
                        } else if (test.expectedMin) {
                            isValid = score >= test.expectedMin;
                        }
                        
                        html += `<div class="result ${isValid ? 'success' : 'error'}">`;
                        html += `üìä ${test.desc}: ${score} pontos (diff: ${diff} dB) `;
                        html += `<span class="${isValid ? 'status-ok' : 'status-error'}">${isValid ? 'OK' : 'FALHOU'}</span>`;
                        html += '</div>';
                    } catch (error) {
                        html += log(`‚ùå Erro no teste "${test.desc}": ${error.message}`, 'error');
                    }
                });
            } else {
                html += log('‚ùå N√£o foi poss√≠vel testar - calculateMetricScore ausente', 'error');
            }
            
            // 3. Testar Mensagens Educativas com Limita√ß√£o de dB
            html += '<h4>üí¨ 3. MENSAGENS EDUCATIVAS COM LIMITA√á√ÉO DE dB</h4>';
            if (hasGlobalScorer) {
                const dbTests = [
                    { type: 'lufs', value: -20, target: -14, tolerance: 1, maxDb: 6, desc: 'LUFS muito baixo' },
                    { type: 'true_peak', value: -0.1, target: -1, tolerance: 0.2, maxDb: 3, desc: 'True Peak alto' },
                    { type: 'dr', value: 6, target: 12, tolerance: 2, maxDb: 4, desc: 'DR muito baixo' }
                ];
                
                dbTests.forEach(test => {
                    try {
                        const suggestion = window.suggestionScorer.generateSuggestion({
                            type: test.type,
                            value: test.value,
                            target: test.target,
                            tolerance: test.tolerance,
                            severity: 'high',
                            metricType: test.type
                        });
                        
                        const adjustmentAbs = Math.abs(suggestion.adjustmentValue || 0);
                        const isWithinLimit = adjustmentAbs <= test.maxDb;
                        const hasMessage = suggestion.message && suggestion.message.length > 0;
                        
                        html += `<div class="result ${isWithinLimit && hasMessage ? 'success' : 'warning'}">`;
                        html += `üí¨ ${test.desc}: "${suggestion.message.substring(0, 80)}..." <br>`;
                        html += `üéöÔ∏è Ajuste: ${suggestion.adjustmentValue} dB (limite: ‚â§${test.maxDb} dB) `;
                        html += `<span class="${isWithinLimit ? 'status-ok' : 'status-warning'}">${isWithinLimit ? 'OK' : 'ACIMA DO LIMITE'}</span>`;
                        html += '</div>';
                    } catch (error) {
                        html += log(`‚ùå Erro no teste "${test.desc}": ${error.message}`, 'error');
                    }
                });
            } else {
                html += log('‚ùå N√£o foi poss√≠vel testar - suggestionScorer ausente', 'error');
            }
            
            // 4. Testar Sistema IA
            html += '<h4>ü§ñ 4. SISTEMA DE IA AVAN√áADO</h4>';
            const aiLayerEnabled = window.AI_SUGGESTION_LAYER_ENABLED === true;
            html += `<div class="result ${aiLayerEnabled ? 'success' : 'warning'}">`;
            html += `ü§ñ AI_SUGGESTION_LAYER_ENABLED: <span class="${aiLayerEnabled ? 'status-ok' : 'status-warning'}">${aiLayerEnabled ? 'ATIVO' : 'INATIVO'}</span>`;
            html += '</div>';
            
            // 5. Conclus√£o da Auditoria
            html += '<h4>üìã 5. CONCLUS√ÉO DA AUDITORIA</h4>';
            const systemsWorking = hasScoringJS && hasSuggestionScorer && hasGlobalScorer;
            html += `<div class="result ${systemsWorking ? 'success' : 'error'}">`;
            html += `üéØ <strong>SISTEMA EDUCATIVO: <span class="${systemsWorking ? 'status-ok' : 'status-error'}">${systemsWorking ? 'FUNCIONANDO' : 'COM PROBLEMAS'}</span></strong>`;
            html += '</div>';
            
            if (systemsWorking) {
                html += log('‚úÖ Score educativo por toler√¢ncia: CONFIRMADO FUNCIONANDO', 'success');
                html += log('‚úÖ Mensagens educativas com limita√ß√£o de dB: CONFIRMADO FUNCIONANDO', 'success');
                html += log('‚úÖ Sistema de sugest√µes ordenadas: CONFIRMADO FUNCIONANDO', 'success');
            } else {
                html += log('‚ùå Sistema apresenta problemas de carregamento', 'error');
            }
            
            html += '</div>';
            document.getElementById('audit-results').innerHTML = html;
        }

        function simulateRealPipeline() {
            if (!window.EnhancedSuggestionEngine || !window.calculateMetricScore) {
                document.getElementById('pipeline-results').innerHTML = 
                    log('‚ùå Sistemas necess√°rios n√£o dispon√≠veis', 'error');
                return;
            }
            
            try {
                const engine = new window.EnhancedSuggestionEngine();
                
                // Simular uma an√°lise de √°udio real com problemas educativos
                const realAnalysis = {
                    technicalData: {
                        lufs: { value: -16.5, lufs: -16.5 },           // Pouco baixo (educativo)
                        true_peak: { value: -0.3, true_peak: -0.3 },   // Alto (cr√≠tico)
                        dr: { value: 9, dr: 9 },                       // Baixo (educativo)
                        lra: { value: 3.5, lra: 3.5 },
                        spectralBands: {
                            bass: { energy_db: -18 },                  // Baixo (educativo)
                            mid: { energy_db: -8 },                    // Alto (educativo)
                            brilliance: { energy_db: -16 }             // Baixo (educativo)
                        }
                    }
                };
                
                const realReference = {
                    lufs_target: -14, tol_lufs: 1,
                    true_peak_target: -1, tol_true_peak: 0.2,
                    dr_target: 12, tol_dr: 2,
                    lra_target: 6, tol_lra: 2,
                    spectralBands: {
                        bass: { target_db: -12, tol_db: 2 },
                        mid: { target_db: -10, tol_db: 2 },
                        brilliance: { target_db: -20, tol_db: 3 }
                    }
                };
                
                // Gerar sugest√µes atrav√©s do sistema completo
                const suggestions = engine.generateSuggestions(realAnalysis, realReference);
                
                let html = '<div class="audit-section"><h3>üéµ SIMULA√á√ÉO DE PIPELINE REAL</h3>';
                
                // Mostrar scores educativos
                html += '<h4>üìä Scores Educativos Calculados:</h4>';
                const lufsScore = window.calculateMetricScore(-16.5, -14, 1, 'lufs');
                const truePeakScore = window.calculateMetricScore(-0.3, -1, 0.2, 'true_peak');
                const drScore = window.calculateMetricScore(9, 12, 2, 'dr');
                
                html += log(`üéØ LUFS Score: ${lufsScore}% (valor: -16.5 LUFS, target: -14 LUFS)`, lufsScore >= 70 ? 'success' : 'warning');
                html += log(`üéØ True Peak Score: ${truePeakScore}% (valor: -0.3 dBTP, target: -1 dBTP)`, truePeakScore >= 70 ? 'success' : 'error');
                html += log(`üéØ DR Score: ${drScore}% (valor: 9 dB, target: 12 dB)`, drScore >= 70 ? 'success' : 'warning');
                
                // Mostrar sugest√µes educativas
                html += '<h4>üí¨ Sugest√µes Educativas Geradas:</h4>';
                html += `<p><strong>Total de sugest√µes:</strong> ${suggestions.length}</p>`;
                
                suggestions.slice(0, 6).forEach((suggestion, index) => {
                    const priority = suggestion.priority || 5;
                    const priorityColor = priority > 8 ? 'error' : priority > 5 ? 'warning' : 'success';
                    
                    html += `<div class="result ${priorityColor}">`;
                    html += `<strong>${index + 1}. ${suggestion.type.toUpperCase()}</strong> (Prioridade: ${priority})<br>`;
                    html += `üí¨ ${suggestion.message}<br>`;
                    if (suggestion.adjustmentValue) {
                        html += `üéöÔ∏è Ajuste educativo: ${suggestion.adjustmentValue} dB<br>`;
                    }
                    html += `</div>`;
                });
                
                // Verificar se True Peak tem prioridade
                const truePeakSuggestion = suggestions.find(s => s.type === 'true_peak');
                if (truePeakSuggestion) {
                    const isHighPriority = truePeakSuggestion.priority > 8;
                    html += log(`üö® True Peak priorizado: ${isHighPriority ? 'SIM' : 'N√ÉO'} (prioridade: ${truePeakSuggestion.priority})`, 
                               isHighPriority ? 'success' : 'error');
                }
                
                html += '</div>';
                document.getElementById('pipeline-results').innerHTML = html;
                
            } catch (error) {
                document.getElementById('pipeline-results').innerHTML = 
                    log(`‚ùå Erro na simula√ß√£o: ${error.message}`, 'error');
            }
        }

        function testEducationalScenarios() {
            let html = '<div class="audit-section"><h3>üéì CEN√ÅRIOS EDUCATIVOS ESPEC√çFICOS</h3>';
            
            const educationalScenarios = [
                {
                    name: 'M√∫sico Iniciante - Problemas B√°sicos',
                    description: 'LUFS muito baixo, True Peak ok, DR baixo',
                    analysis: { lufs: -18, true_peak: -1.2, dr: 7 },
                    reference: { lufs_target: -14, tol_lufs: 1, true_peak_target: -1, tol_true_peak: 0.2, dr_target: 12, tol_dr: 2 }
                },
                {
                    name: 'Produtor Intermedi√°rio - Ajustes Finos',
                    description: 'Pequenos desvios, requer ajustes educativos de poucos dB',
                    analysis: { lufs: -15.5, true_peak: -0.8, dr: 10.5 },
                    reference: { lufs_target: -14, tol_lufs: 1, true_peak_target: -1, tol_true_peak: 0.2, dr_target: 12, tol_dr: 2 }
                },
                {
                    name: 'Mix Cr√≠tico - True Peak Problema',
                    description: 'True Peak alto (prioridade m√°xima), outros ok',
                    analysis: { lufs: -14.2, true_peak: -0.1, dr: 11.8 },
                    reference: { lufs_target: -14, tol_lufs: 1, true_peak_target: -1, tol_true_peak: 0.2, dr_target: 12, tol_dr: 2 }
                }
            ];
            
            educationalScenarios.forEach((scenario, index) => {
                html += `<h4>üéµ ${index + 1}. ${scenario.name}</h4>`;
                html += `<p><em>${scenario.description}</em></p>`;
                
                // Calcular scores educativos
                const lufsScore = window.calculateMetricScore ? 
                    window.calculateMetricScore(scenario.analysis.lufs, scenario.reference.lufs_target, scenario.reference.tol_lufs, 'lufs') : 'N/A';
                const truePeakScore = window.calculateMetricScore ? 
                    window.calculateMetricScore(scenario.analysis.true_peak, scenario.reference.true_peak_target, scenario.reference.tol_true_peak, 'true_peak') : 'N/A';
                const drScore = window.calculateMetricScore ? 
                    window.calculateMetricScore(scenario.analysis.dr, scenario.reference.dr_target, scenario.reference.tol_dr, 'dr') : 'N/A';
                
                html += log(`üìä Scores: LUFS ${lufsScore}%, True Peak ${truePeakScore}%, DR ${drScore}%`, 'info');
                
                // Gerar sugest√µes educativas
                if (window.suggestionScorer) {
                    ['lufs', 'true_peak', 'dr'].forEach(type => {
                        const value = scenario.analysis[type];
                        const target = scenario.reference[`${type}_target`];
                        const tolerance = scenario.reference[`tol_${type}`];
                        
                        if (Math.abs(value - target) > tolerance) {
                            try {
                                const suggestion = window.suggestionScorer.generateSuggestion({
                                    type: type,
                                    value: value,
                                    target: target,
                                    tolerance: tolerance,
                                    severity: 'medium',
                                    metricType: type
                                });
                                
                                html += `<div class="result info">`;
                                html += `üí¨ ${type.toUpperCase()}: "${suggestion.message}"<br>`;
                                html += `üéöÔ∏è Ajuste educativo: ${suggestion.adjustmentValue} dB`;
                                html += `</div>`;
                            } catch (error) {
                                html += log(`‚ùå Erro ao gerar sugest√£o para ${type}: ${error.message}`, 'error');
                            }
                        }
                    });
                }
            });
            
            html += '</div>';
            document.getElementById('educational-results').innerHTML = html;
        }

        // Auto-executar ao carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('üéØ Sistema carregado, executando auditoria autom√°tica...');
                runCompleteAudit();
            }, 1500);
        });
    </script>
</body>
</html>