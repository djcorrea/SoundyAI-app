<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Score Progressivo - Cen√°rio Espec√≠fico</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .scenario {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .test-button {
            background: #27ae60;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
        }
        .test-button:hover {
            background: #219a52;
        }
        .results {
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .progress-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .progress-table th, .progress-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .progress-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .zone-green { background: #d4edda; }
        .zone-yellow { background: #fff3cd; }
        .zone-red { background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste Score Progressivo - Cen√°rio Espec√≠fico</h1>
        
        <div class="scenario">
            <h3>üìä Cen√°rio de Teste:</h3>
            <ul>
                <li><strong>Target:</strong> -23 dB</li>
                <li><strong>Toler√¢ncia:</strong> ¬±2.5 dB</li>
                <li><strong>Valor inicial:</strong> -40 dB (17 dB de dist√¢ncia)</li>
                <li><strong>Teste:</strong> Ajustes incrementais de +2 dB</li>
                <li><strong>Objetivo:</strong> Verificar se h√° progresso cont√≠nuo no score</li>
            </ul>
        </div>

        <button class="test-button" onclick="executarTeste()">üöÄ Executar Teste</button>

        <div id="status"></div>
        <div id="results"></div>
        <div id="table-container"></div>
    </div>

    <!-- Carregar scoring.js -->
    <script src="public/lib/audio/features/scoring.js"></script>
    
    <script>
        function mostrarStatus(mensagem, tipo = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${tipo}">${mensagem}</div>`;
        }

        function executarTeste() {
            try {
                // Verificar se o scoring est√° carregado
                if (typeof window.calculateMetricScore !== 'function') {
                    mostrarStatus('‚ùå Fun√ß√£o calculateMetricScore n√£o encontrada. Verifique se scoring.js foi carregado.', 'error');
                    return;
                }

                mostrarStatus('‚úÖ Iniciando teste de score progressivo...', 'success');

                // Par√¢metros do teste
                const target = -23;
                const tolerance = 2.5;
                const initialValue = -40;
                const options = { yellowMin: 70, bufferFactor: 1.5, severity: tolerance * 2 };

                let output = '';
                
                // Simular ajustes graduais
                const adjustments = [0, 2, 4, 6, 8, 10, 12, 14, 16, 17]; // √öltimo leva ao target
                const progressData = [];
                
                adjustments.forEach(adjustment => {
                    const currentValue = initialValue + adjustment;
                    const score = window.calculateMetricScore(currentValue, target, tolerance, options);
                    const distance = Math.abs(currentValue - target);
                    
                    progressData.push({
                        adjustment: adjustment,
                        value: currentValue,
                        score: score,
                        distance: distance
                    });
                });

                // Gerar tabela de resultados
                let tableHTML = `
                    <h3>üìà Progresso do Score</h3>
                    <table class="progress-table">
                        <thead>
                            <tr>
                                <th>Ajuste</th>
                                <th>Valor (dB)</th>
                                <th>Score</th>
                                <th>Dist√¢ncia</th>
                                <th>Zona</th>
                                <th>Delta Score</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let previousScore = 0;
                progressData.forEach((data, index) => {
                    const zone = data.distance <= tolerance ? 'Verde' : 
                                (data.distance <= tolerance * 2.5 ? 'Amarela' : 'Vermelha');
                    const zoneClass = data.distance <= tolerance ? 'zone-green' : 
                                     (data.distance <= tolerance * 2.5 ? 'zone-yellow' : 'zone-red');
                    
                    const deltaScore = index > 0 ? (data.score - previousScore).toFixed(1) : '‚Äî';
                    const deltaArrow = index > 0 ? (data.score > previousScore ? 'üìà' : 'üìâ') : '';
                    
                    tableHTML += `
                        <tr class="${zoneClass}">
                            <td>+${data.adjustment} dB</td>
                            <td>${data.value} dB</td>
                            <td><strong>${data.score}</strong>/100</td>
                            <td>${data.distance.toFixed(1)} dB</td>
                            <td>${zone}</td>
                            <td>${deltaArrow} ${deltaScore}</td>
                        </tr>
                    `;
                    previousScore = data.score;
                });

                tableHTML += '</tbody></table>';

                // Valida√ß√£o dos resultados
                let progressCount = 0;
                for (let i = 1; i < progressData.length; i++) {
                    if (progressData[i].score > progressData[i-1].score) {
                        progressCount++;
                    }
                }

                const hasConsistentProgress = progressCount >= (progressData.length - 2);
                const finalScore = progressData[progressData.length - 1].score;
                const initialScore = progressData[0].score;
                const totalImprovement = finalScore - initialScore;

                // Casos extremos
                const extremeFarScore = window.calculateMetricScore(-100, target, tolerance, options);
                const perfectScore = window.calculateMetricScore(target, target, tolerance, options);

                // Resumo final
                let summaryHTML = `
                    <h3>üìã Resumo da Valida√ß√£o</h3>
                    <div class="status ${hasConsistentProgress ? 'success' : 'error'}">
                        <strong>Progresso Cont√≠nuo:</strong> ${hasConsistentProgress ? '‚úÖ PASSOU' : '‚ùå FALHOU'} 
                        (${progressCount}/${progressData.length-1} melhorias)
                    </div>
                    <div class="status ${extremeFarScore >= 10 ? 'success' : 'error'}">
                        <strong>Score M√≠nimo ‚â•10:</strong> ${extremeFarScore >= 10 ? '‚úÖ PASSOU' : '‚ùå FALHOU'} 
                        (Score em -100 dB: ${extremeFarScore})
                    </div>
                    <div class="status ${perfectScore === 100 ? 'success' : 'error'}">
                        <strong>Score Perfeito no Target:</strong> ${perfectScore === 100 ? '‚úÖ PASSOU' : '‚ùå FALHOU'} 
                        (Score: ${perfectScore})
                    </div>
                    <div class="status ${totalImprovement > 0 ? 'success' : 'error'}">
                        <strong>Melhoria Total:</strong> ${totalImprovement > 0 ? '‚úÖ PASSOU' : '‚ùå FALHOU'} 
                        (${initialScore} ‚Üí ${finalScore} = +${totalImprovement} pontos)
                    </div>
                `;

                document.getElementById('table-container').innerHTML = tableHTML + summaryHTML;
                mostrarStatus('üéâ Teste conclu√≠do! Verifique os resultados abaixo.', 'success');

            } catch (error) {
                mostrarStatus(`‚ùå Erro durante o teste: ${error.message}`, 'error');
                console.error('Erro no teste:', error);
            }
        }

        // Verificar disponibilidade do scoring ao carregar
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (typeof window.calculateMetricScore === 'function') {
                    mostrarStatus('üéØ Sistema de scoring carregado e pronto para teste!', 'success');
                } else {
                    mostrarStatus('‚ö†Ô∏è Aguardando carregamento do sistema de scoring...', 'warning');
                }
            }, 1000);
        });
    </script>
</body>
</html>