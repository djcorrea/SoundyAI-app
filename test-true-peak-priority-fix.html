<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Teste da Corre√ß√£o de Mensagem Priorit√°ria do True Peak</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        .test-title {
            font-size: 24px;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            margin: 8px 0;
        }
        .status.success { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status.warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .code {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 12px 0;
        }
        .button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px 8px 8px 0;
            transition: all 0.3s;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        .suggestion-preview {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
        }
        .priority-alert {
            border: 2px solid rgba(220, 38, 38, 0.4);
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, rgba(185, 28, 28, 0.2) 100%);
            animation: priorityPulse 2s infinite;
        }
        @keyframes priorityPulse {
            0%, 100% { border-color: rgba(220, 38, 38, 0.4); }
            50% { border-color: rgba(220, 38, 38, 0.8); }
        }
        .priority-alert-banner {
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.8), rgba(239, 68, 68, 0.9));
            color: #ffffff;
            text-align: center;
            padding: 8px 16px;
            margin: -16px -16px 16px -16px;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 6px 6px 0 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="test-card">
            <div class="test-title">
                üö® Teste da Corre√ß√£o de Mensagem Priorit√°ria do True Peak
            </div>
            <p>Este teste valida se a mensagem priorit√°ria do True Peak aparece corretamente quando o valor est√° acima de +0.3 dBTP.</p>
            
            <div class="status warning">
                ‚ö†Ô∏è <strong>Problema Original:</strong> True Peak com 2.60 dBTP n√£o mostrava mensagem "Corrigir primeiro"
            </div>
            
            <div class="status success">
                ‚úÖ <strong>Corre√ß√£o Implementada:</strong> 
                <ul>
                    <li>üîß Detec√ß√£o de flags especiais no ai-suggestions-integration.js</li>
                    <li>üé® Estilos CSS para alertas priorit√°rios</li>
                    <li>üö® Banner de corre√ß√£o priorit√°ria</li>
                    <li>üìä Preserva√ß√£o de flags durante merge</li>
                </ul>
            </div>
            
            <button class="button" onclick="testTruePeakPriorityDetection()">
                üß™ Testar Detec√ß√£o de True Peak Cr√≠tico
            </button>
            
            <button class="button" onclick="testSuggestionRendering()">
                üé® Testar Renderiza√ß√£o de Sugest√£o Priorit√°ria
            </button>
            
            <button class="button" onclick="testEnhancedSuggestionEngine()">
                ‚öôÔ∏è Testar Enhanced Suggestion Engine
            </button>
            
            <div id="testResults"></div>
        </div>

        <div class="test-card">
            <div class="test-title">
                üìã Preview da Sugest√£o Priorit√°ria
            </div>
            <div id="suggestionPreview"></div>
        </div>
    </div>

    <!-- Incluir scripts necess√°rios -->
    <script src="enhanced-suggestion-engine.js"></script>
    <script src="ai-suggestions-integration.js"></script>

    <script>
        // Dados de teste simulando True Peak cr√≠tico
        const mockTruePeakCriticalData = {
            technicalData: {
                truePeak: 2.60, // True Peak cr√≠tico > +0.3 dBTP
                lufsIntegrated: -8.5,
                dynamicRange: 7.2,
                lra: 9.8,
                stereoCorrelation: 0.85
            },
            audioBuffer: {
                length: 48000 * 180, // 3 minutos
                sampleRate: 48000
            }
        };

        const mockReferenceData = {
            true_peak_target: -1.0,
            tol_true_peak: 1.0,
            lufs_target: -14.0,
            tol_lufs: 2.0
        };

        let testResults = [];

        function addTestResult(test, status, message, details = null) {
            testResults.push({ test, status, message, details, timestamp: new Date() });
            updateTestResults();
        }

        function updateTestResults() {
            const container = document.getElementById('testResults');
            const html = testResults.map(result => `
                <div class="status ${result.status}">
                    <strong>${result.test}:</strong> ${result.message}
                    ${result.details ? `<div class="code">${JSON.stringify(result.details, null, 2)}</div>` : ''}
                </div>
            `).join('');
            container.innerHTML = html;
        }

        function testTruePeakPriorityDetection() {
            console.log('üß™ [TEST] Iniciando teste de detec√ß√£o de True Peak cr√≠tico...');
            
            try {
                // Verificar se Enhanced Suggestion Engine est√° dispon√≠vel
                if (typeof EnhancedSuggestionEngine === 'undefined') {
                    addTestResult('Detec√ß√£o TP', 'error', 'EnhancedSuggestionEngine n√£o carregado');
                    return;
                }

                const engine = new EnhancedSuggestionEngine();
                
                // Processar an√°lise simulada
                const result = engine.processAnalysis(mockTruePeakCriticalData, mockReferenceData);
                
                // Verificar se gerou sugest√µes
                const suggestions = result.suggestions || [];
                const truePeakSuggestions = suggestions.filter(s => 
                    s.metricType === 'true_peak' || s.type?.includes('true_peak')
                );

                if (truePeakSuggestions.length === 0) {
                    addTestResult('Detec√ß√£o TP', 'error', 'Nenhuma sugest√£o de True Peak gerada');
                    return;
                }

                const prioritySuggestion = truePeakSuggestions.find(s => 
                    s.specialAlert === true || s.alertType === "priority_first" || s.correctionOrder === "PRIMEIRO"
                );

                if (prioritySuggestion) {
                    addTestResult('Detec√ß√£o TP', 'success', 'True Peak cr√≠tico detectado com flags especiais', {
                        specialAlert: prioritySuggestion.specialAlert,
                        alertType: prioritySuggestion.alertType,
                        correctionOrder: prioritySuggestion.correctionOrder,
                        priorityWarning: prioritySuggestion.priorityWarning,
                        currentValue: prioritySuggestion.currentValue,
                        targetValue: prioritySuggestion.targetValue
                    });
                } else {
                    addTestResult('Detec√ß√£o TP', 'warning', 'True Peak detectado mas sem flags especiais', {
                        suggestions: truePeakSuggestions.length,
                        firstSuggestion: truePeakSuggestions[0]
                    });
                }

            } catch (error) {
                addTestResult('Detec√ß√£o TP', 'error', 'Erro durante teste: ' + error.message);
                console.error('Erro no teste:', error);
            }
        }

        function testSuggestionRendering() {
            console.log('üé® [TEST] Testando renderiza√ß√£o de sugest√£o priorit√°ria...');
            
            try {
                // Verificar se AISuggestionsIntegration est√° dispon√≠vel
                if (typeof AISuggestionsIntegration === 'undefined') {
                    addTestResult('Renderiza√ß√£o', 'error', 'AISuggestionsIntegration n√£o carregado');
                    return;
                }

                // Criar sugest√£o simulada com flags especiais
                const mockPrioritySuggestion = {
                    type: 'reference_true_peak',
                    metricType: 'true_peak',
                    specialAlert: true,
                    alertType: "priority_first",
                    correctionOrder: "PRIMEIRO",
                    priorityWarning: "‚ö†Ô∏è ATEN√á√ÉO: True Peak deve ser corrigido antes de outros ajustes!",
                    message: "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA (2.6 dBTP ‚Üí -1.0 dBTP)",
                    why: "CR√çTICO: Corrija o True Peak PRIMEIRO antes de ajustar outras m√©tricas",
                    action: "Usar limiter com True Peak detection",
                    currentValue: 2.6,
                    targetValue: -1.0,
                    icon: '‚ö°'
                };

                const integration = new AISuggestionsIntegration();
                const card = integration.createSuggestionCard(mockPrioritySuggestion, 0, 'test');

                // Adicionar preview
                const preview = document.getElementById('suggestionPreview');
                preview.innerHTML = '';
                preview.appendChild(card);

                addTestResult('Renderiza√ß√£o', 'success', 'Sugest√£o priorit√°ria renderizada com sucesso');

            } catch (error) {
                addTestResult('Renderiza√ß√£o', 'error', 'Erro durante renderiza√ß√£o: ' + error.message);
                console.error('Erro na renderiza√ß√£o:', error);
            }
        }

        function testEnhancedSuggestionEngine() {
            console.log('‚öôÔ∏è [TEST] Testando Enhanced Suggestion Engine completo...');
            
            try {
                // Teste de condi√ß√µes espec√≠ficas para True Peak cr√≠tico
                const testValues = [
                    { value: 2.60, expected: 'CRITICAL' },
                    { value: 0.5, expected: 'HIGH' },
                    { value: -0.3, expected: 'MEDIUM' },
                    { value: -1.2, expected: 'OK' }
                ];

                const results = testValues.map(test => {
                    const isCritical = test.value > 0.3;
                    const isHigh = test.value > -0.5;
                    const status = isCritical ? 'CRITICAL' : isHigh ? 'HIGH' : test.value > -1.0 ? 'MEDIUM' : 'OK';
                    
                    return {
                        value: test.value,
                        expected: test.expected,
                        actual: status,
                        correct: status === test.expected,
                        shouldHavePriority: isCritical
                    };
                });

                const allCorrect = results.every(r => r.correct);
                const criticalDetected = results.filter(r => r.shouldHavePriority && r.actual === 'CRITICAL').length;

                if (allCorrect && criticalDetected > 0) {
                    addTestResult('Engine Logic', 'success', `L√≥gica de detec√ß√£o funcionando corretamente (${criticalDetected} cr√≠ticos detectados)`, results);
                } else {
                    addTestResult('Engine Logic', 'warning', 'L√≥gica de detec√ß√£o requer verifica√ß√£o', results);
                }

            } catch (error) {
                addTestResult('Engine Logic', 'error', 'Erro durante teste de engine: ' + error.message);
                console.error('Erro no teste de engine:', error);
            }
        }

        // Auto-executar testes b√°sicos ao carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('üöÄ Executando testes autom√°ticos...');
                testTruePeakPriorityDetection();
                testSuggestionRendering();
                testEnhancedSuggestionEngine();
            }, 1000);
        });
    </script>
</body>
</html>