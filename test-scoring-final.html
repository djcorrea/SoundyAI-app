<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste Final do Sistema de Scoring Corrigido</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1a1a; 
            color: #fff; 
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { 
            background: #2a2a2a; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            border-left: 4px solid #0066cc;
        }
        .result { 
            background: #0a3a0a; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 6px; 
            border-left: 4px solid #00ff00;
        }
        .result.fail { 
            background: #3a0a0a; 
            border-left-color: #ff0000;
        }
        .result.warning { 
            background: #3a3a0a; 
            border-left-color: #ffaa00;
        }
        pre { 
            background: #000; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-size: 12px;
        }
        button { 
            background: #0066cc; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 8px; 
            font-size: 14px;
            font-weight: bold;
        }
        button:hover { background: #0088ff; }
        .score-display {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 4px;
        }
        .score-excellent { background: #00ff92; color: #000; }
        .score-good { background: #ffd700; color: #000; }
        .score-average { background: #ff9500; color: #fff; }
        .score-poor { background: #ff3366; color: #fff; }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
        }
        .metric-card h4 {
            margin-top: 0;
            color: #0088ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste Final do Sistema de Scoring Corrigido</h1>
        
        <div class="test-section">
            <h2>üìã Valida√ß√µes Implementadas</h2>
            <p>Este teste valida as corre√ß√µes cr√≠ticas no sistema de scoring:</p>
            <ul>
                <li>‚úÖ <strong>Toler√¢ncia Respeitada:</strong> Dentro da toler√¢ncia = 100 pontos</li>
                <li>‚úÖ <strong>Pesos por G√™nero:</strong> Funk Mandela, Bruxaria, Trap, Eletr√¥nico</li>
                <li>‚úÖ <strong>Sub-scores Balanceados:</strong> M√©dia justa de m√©tricas por categoria</li>
                <li>‚úÖ <strong>Scores Realistas:</strong> Valores entre 50-90 na maioria dos casos</li>
                <li>‚úÖ <strong>Verde = Alto Score:</strong> M√©tricas IDEAL resultam em sub-scores altos</li>
            </ul>
            
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="runCriticalTests()">üöÄ Executar Testes Cr√≠ticos</button>
                <button onclick="testGenreWeights()">‚öñÔ∏è Testar Pesos por G√™nero</button>
                <button onclick="testToleranceRespect()">‚úÖ Testar Respeito √† Toler√¢ncia</button>
                <button onclick="testRealScenarios()">üéµ Cen√°rios Reais</button>
            </div>
        </div>

        <div id="testResults" class="test-section">
            <h2>üìä Resultados dos Testes</h2>
            <p>Clique em um dos bot√µes acima para ver os resultados...</p>
        </div>
    </div>

    <script src="audio-analyzer-integration.js"></script>
    <script>
        // Dados de refer√™ncia simulados (baseados em funk_mandela.json)
        const mockRefData = {
            lufs_target: -7.8,
            tol_lufs: 2.5,
            true_peak_target: -1.0,
            tol_true_peak: 1.0,
            dr_target: 7.8,
            tol_dr: 1.5,
            lra_target: 2.5,
            tol_lra: 1.5,
            stereo_target: 0.85,
            tol_stereo: 0.25,
            crest_target: 12.0,
            tol_crest: 2.0,
            bands: {
                sub: { target_db: -17.3, tol_db: 3.0 },
                low_bass: { target_db: -17.7, tol_db: 3.0 },
                low_mid: { target_db: -18.7, tol_db: 2.5 },
                mid: { target_db: -17.9, tol_db: 2.5 },
                high_mid: { target_db: -22.9, tol_db: 2.5 },
                presenca: { target_db: -34.0, tol_db: 3.5 },
                brilho: { target_db: -29.3, tol_db: 3.5 }
            }
        };

        function clearResults() {
            document.getElementById('testResults').innerHTML = '<h2>üìä Resultados dos Testes</h2>';
        }

        function addResult(html, type = 'success') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = html;
            document.getElementById('testResults').appendChild(div);
        }

        function getScoreClass(score) {
            if (score >= 85) return 'score-excellent';
            if (score >= 70) return 'score-good';
            if (score >= 50) return 'score-average';
            return 'score-poor';
        }

        function formatScore(score, label) {
            const scoreClass = getScoreClass(score);
            return `<span class="score-display ${scoreClass}">${label}: ${score}%</span>`;
        }

        function testToleranceRespect() {
            clearResults();
            addResult('<h3>‚úÖ Teste: Respeito √† Toler√¢ncia</h3>');
            
            // Teste 1: Valor exatamente no alvo
            const score1 = calculateMetricScore(-17.3, -17.3, 3.0);
            const pass1 = score1 === 100;
            addResult(`<strong>Valor no alvo:</strong> -17.3 vs -17.3 (¬±3.0) = ${score1}% ${pass1 ? '‚úÖ' : '‚ùå'}`, pass1 ? 'success' : 'fail');
            
            // Teste 2: Valor dentro da toler√¢ncia
            const score2 = calculateMetricScore(-15.0, -17.3, 3.0); // Delta = 2.3, dentro de ¬±3.0
            const pass2 = score2 === 100;
            addResult(`<strong>Dentro da toler√¢ncia:</strong> -15.0 vs -17.3 (¬±3.0) = ${score2}% ${pass2 ? '‚úÖ' : '‚ùå'}`, pass2 ? 'success' : 'fail');
            
            // Teste 3: No limite da toler√¢ncia
            const score3 = calculateMetricScore(-14.3, -17.3, 3.0); // Delta = 3.0, exatamente no limite
            const pass3 = score3 === 100;
            addResult(`<strong>No limite da toler√¢ncia:</strong> -14.3 vs -17.3 (¬±3.0) = ${score3}% ${pass3 ? '‚úÖ' : '‚ùå'}`, pass3 ? 'success' : 'fail');
            
            // Teste 4: Fora da toler√¢ncia
            const score4 = calculateMetricScore(-10.0, -17.3, 3.0); // Delta = 7.3, fora de ¬±3.0
            const pass4 = score4 < 100;
            addResult(`<strong>Fora da toler√¢ncia:</strong> -10.0 vs -17.3 (¬±3.0) = ${score4}% ${pass4 ? '‚úÖ' : '‚ùå'}`, pass4 ? 'success' : 'fail');
            
            addResult('<h4>üéØ Conclus√£o</h4><p>O sistema deve sempre dar 100% quando o valor est√° dentro da toler√¢ncia, independente da dist√¢ncia do alvo.</p>');
        }

        function testGenreWeights() {
            clearResults();
            addResult('<h3>‚öñÔ∏è Teste: Pesos por G√™nero</h3>');
            
            // An√°lise simulada com scores fixos para cada categoria
            const mockAnalysis = {
                metrics: {
                    lufs_integrated: -7.8,     // 100%
                    true_peak_dbtp: -1.0,      // 100%
                    dynamic_range: 7.8,        // 100%
                    lra: 2.5,                  // 100%
                    stereo_correlation: 0.85,  // 100%
                    bands: {
                        sub: { energy_db: -17.3 },      // 100%
                        bass: { energy_db: -17.7 },     // 100%
                        lowMid: { energy_db: -18.7 },   // 100%
                        mid: { energy_db: -17.9 },      // 100%
                        highMid: { energy_db: -22.9 },  // 100%
                        presence: { energy_db: -34.0 }, // 100%
                        air: { energy_db: -29.3 }       // 100%
                    }
                },
                technicalData: {},
                issues: []
            };
            
            const genres = ['funk_mandela', 'funk_bruxaria', 'trap', 'eletronico', 'default'];
            
            genres.forEach(genre => {
                const scores = calculateAnalysisScores(mockAnalysis, mockRefData, genre);
                if (scores) {
                    const weights = GENRE_SCORING_WEIGHTS[genre] || GENRE_SCORING_WEIGHTS['default'];
                    
                    addResult(`
                        <h4>üéµ ${genre.toUpperCase()}</h4>
                        <div class="metric-grid">
                            <div class="metric-card">
                                <h4>Pesos</h4>
                                <p>Loudness: ${(weights.loudness * 100).toFixed(0)}%</p>
                                <p>Din√¢mica: ${(weights.dinamica * 100).toFixed(0)}%</p>
                                <p>Frequ√™ncia: ${(weights.frequencia * 100).toFixed(0)}%</p>
                                <p>Est√©reo: ${(weights.estereo * 100).toFixed(0)}%</p>
                                <p>T√©cnico: ${(weights.tecnico * 100).toFixed(0)}%</p>
                            </div>
                            <div class="metric-card">
                                <h4>Scores</h4>
                                ${formatScore(scores.loudness, 'Loudness')}
                                ${formatScore(scores.dinamica, 'Din√¢mica')}
                                ${formatScore(scores.frequencia, 'Frequ√™ncia')}
                                ${formatScore(scores.estereo, 'Est√©reo')}
                                ${formatScore(scores.tecnico, 'T√©cnico')}
                                <br><br>
                                ${formatScore(scores.final, 'FINAL')}
                            </div>
                        </div>
                    `);
                }
            });
        }

        function testRealScenarios() {
            clearResults();
            addResult('<h3>üéµ Teste: Cen√°rios Reais</h3>');
            
            const scenarios = [
                {
                    name: 'Mix Perfeito',
                    description: 'Todas as m√©tricas dentro da toler√¢ncia',
                    analysis: {
                        metrics: {
                            lufs_integrated: -7.8,
                            true_peak_dbtp: -1.0,
                            dynamic_range: 7.8,
                            lra: 2.5,
                            stereo_correlation: 0.85,
                            bands: {
                                sub: { energy_db: -17.3 },
                                bass: { energy_db: -17.7 },
                                lowMid: { energy_db: -18.7 },
                                mid: { energy_db: -17.9 },
                                highMid: { energy_db: -22.9 },
                                presence: { energy_db: -34.0 },
                                air: { energy_db: -29.3 }
                            }
                        },
                        technicalData: {},
                        issues: []
                    }
                },
                {
                    name: 'Mix com Problemas de Graves',
                    description: 'Sub e bass fora da toler√¢ncia',
                    analysis: {
                        metrics: {
                            lufs_integrated: -7.8,
                            true_peak_dbtp: -1.0,
                            dynamic_range: 7.8,
                            lra: 2.5,
                            stereo_correlation: 0.85,
                            bands: {
                                sub: { energy_db: -12.0 },      // Muito alto
                                bass: { energy_db: -13.0 },     // Muito alto
                                lowMid: { energy_db: -18.7 },   // OK
                                mid: { energy_db: -17.9 },      // OK
                                highMid: { energy_db: -22.9 },  // OK
                                presence: { energy_db: -34.0 }, // OK
                                air: { energy_db: -29.3 }       // OK
                            }
                        },
                        technicalData: {},
                        issues: []
                    }
                },
                {
                    name: 'Mix com Problemas T√©cnicos',
                    description: 'Clipping e DC offset detectados',
                    analysis: {
                        metrics: {
                            lufs_integrated: -7.8,
                            true_peak_dbtp: -1.0,
                            dynamic_range: 7.8,
                            lra: 2.5,
                            stereo_correlation: 0.85,
                            bands: {
                                sub: { energy_db: -17.3 },
                                bass: { energy_db: -17.7 },
                                lowMid: { energy_db: -18.7 },
                                mid: { energy_db: -17.9 },
                                highMid: { energy_db: -22.9 },
                                presence: { energy_db: -34.0 },
                                air: { energy_db: -29.3 }
                            }
                        },
                        technicalData: {
                            clipping: 0.02,    // 2% de clipping
                            dcOffset: 0.15     // DC offset significativo
                        },
                        issues: [
                            { severity: 'high', description: 'Clipping detectado' },
                            { severity: 'medium', description: 'DC offset elevado' }
                        ]
                    }
                }
            ];
            
            scenarios.forEach(scenario => {
                const scores = calculateAnalysisScores(scenario.analysis, mockRefData, 'funk_mandela');
                
                addResult(`
                    <h4>üéµ ${scenario.name}</h4>
                    <p><em>${scenario.description}</em></p>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <h4>Sub-Scores</h4>
                            ${formatScore(scores.loudness || 0, 'Loudness')}
                            ${formatScore(scores.dinamica || 0, 'Din√¢mica')}
                            ${formatScore(scores.frequencia || 0, 'Frequ√™ncia')}
                            ${formatScore(scores.estereo || 0, 'Est√©reo')}
                            ${formatScore(scores.tecnico || 0, 'T√©cnico')}
                        </div>
                        <div class="metric-card">
                            <h4>Score Final</h4>
                            ${formatScore(scores.final || 0, 'SCORE FINAL')}
                            <br><br>
                            <p><strong>An√°lise:</strong> ${scores.final >= 90 ? 'Excelente' : scores.final >= 75 ? 'Muito Bom' : scores.final >= 60 ? 'Bom' : scores.final >= 40 ? 'Regular' : 'Necessita Melhorias'}</p>
                        </div>
                    </div>
                `);
            });
        }

        function runCriticalTests() {
            clearResults();
            addResult('<h3>üöÄ Testes Cr√≠ticos do Sistema</h3>');
            
            // Teste cr√≠tico: m√©trica verde deve resultar em score alto
            addResult('<h4>üéØ Teste 1: M√©trica Verde = Score Alto</h4>');
            
            const greenMetrics = {
                metrics: {
                    lufs_integrated: -7.8,    // Exatamente no alvo
                    bands: {
                        sub: { energy_db: -17.3 },  // Exatamente no alvo
                        bass: { energy_db: -17.7 }  // Exatamente no alvo
                    }
                },
                technicalData: {},
                issues: []
            };
            
            const loudnessScore = calculateLoudnessScore(greenMetrics, mockRefData);
            const frequencyScore = calculateFrequencyScore(greenMetrics, mockRefData);
            
            addResult(`LUFS no alvo (-7.8): Score = ${loudnessScore}% ${loudnessScore >= 90 ? '‚úÖ' : '‚ùå'}`, loudnessScore >= 90 ? 'success' : 'fail');
            addResult(`Bandas no alvo: Score = ${frequencyScore}% ${frequencyScore >= 90 ? '‚úÖ' : '‚ùå'}`, frequencyScore >= 90 ? 'success' : 'fail');
            
            // Teste cr√≠tico: scores realistas
            addResult('<h4>üéØ Teste 2: Scores Realistas</h4>');
            
            const mixedMetrics = {
                metrics: {
                    lufs_integrated: -6.5,    // Um pouco fora, mas dentro da toler√¢ncia
                    true_peak_dbtp: -0.8,     // Pr√≥ximo do limite
                    dynamic_range: 6.5,       // Um pouco baixo
                    stereo_correlation: 0.90,  // Um pouco alto
                    bands: {
                        sub: { energy_db: -16.0 },      // Dentro da toler√¢ncia
                        bass: { energy_db: -19.0 },     // Dentro da toler√¢ncia
                        lowMid: { energy_db: -20.0 },   // Fora da toler√¢ncia
                        mid: { energy_db: -17.9 },      // No alvo
                        highMid: { energy_db: -25.0 },  // Fora da toler√¢ncia
                        presence: { energy_db: -32.0 }, // Dentro da toler√¢ncia
                        air: { energy_db: -31.0 }       // Fora da toler√¢ncia
                    }
                },
                technicalData: {},
                issues: [
                    { severity: 'low', description: 'Leve desequil√≠brio espectral' }
                ]
            };
            
            const mixedScores = calculateAnalysisScores(mixedMetrics, mockRefData, 'funk_mandela');
            
            addResult(`
                <div class="metric-grid">
                    <div class="metric-card">
                        <h4>Mix Misto (algumas m√©tricas OK, outras n√£o)</h4>
                        ${formatScore(mixedScores.loudness, 'Loudness')}
                        ${formatScore(mixedScores.dinamica, 'Din√¢mica')}
                        ${formatScore(mixedScores.frequencia, 'Frequ√™ncia')}
                        ${formatScore(mixedScores.estereo, 'Est√©reo')}
                        ${formatScore(mixedScores.tecnico, 'T√©cnico')}
                        <br><br>
                        ${formatScore(mixedScores.final, 'FINAL')}
                    </div>
                </div>
            `);
            
            const isRealistic = mixedScores.final >= 40 && mixedScores.final <= 85;
            addResult(`Score final real√≠stico (40-85%): ${isRealistic ? '‚úÖ' : '‚ùå'}`, isRealistic ? 'success' : 'fail');
            
            addResult('<h4>‚úÖ Conclus√£o dos Testes Cr√≠ticos</h4><p>O sistema agora respeita toler√¢ncias, produz scores realistas e d√° pontua√ß√£o alta para m√©tricas verdes/ideais.</p>');
        }

        // Auto-executar teste b√°sico ao carregar
        window.addEventListener('load', () => {
            addResult('<p>üéØ Sistema de scoring carregado e pronto para testes.</p><p><strong>Clique nos bot√µes acima para executar valida√ß√µes espec√≠ficas.</strong></p>');
        });
    </script>
</body>
</html>