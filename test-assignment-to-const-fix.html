<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: Corre√ß√£o Assignment to const</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }
        
        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }
        
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin: 15px 0;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin: 15px 0;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .code-block {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 8px 0;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß Teste: Corre√ß√£o Assignment to const</h1>
        <p>Verifica√ß√£o se o erro "Assignment to const variable" foi corrigido</p>
    </div>

    <div class="test-card">
        <h3>üéØ Objetivo do Teste</h3>
        <p>Verificar se a fun√ß√£o <code>generateReferenceSuggestions</code> n√£o gera mais o erro "Assignment to const variable" ap√≥s a corre√ß√£o aplicada.</p>
        
        <div class="code-block">
            <strong>Corre√ß√£o aplicada:</strong><br>
            - Linha 604: <code>const suggestions = [];</code> ‚Üí <code>let suggestions = [];</code><br>
            - P√≥s-processamento: <code>suggestions = this.postProcessBandSuggestions(suggestions);</code> agora funciona
        </div>
        
        <button class="test-button" onclick="testAssignmentError()">Testar Corre√ß√£o do Assignment to const</button>
        <button class="test-button" onclick="testFullSuggestionFlow()">Testar Fluxo Completo de Sugest√µes</button>
        <button class="test-button" onclick="clearResults()">Limpar</button>
        
        <div id="test-results"></div>
    </div>

    <script src="public/suggestion-scorer.js"></script>
    <script src="public/enhanced-suggestion-engine.js"></script>

    <script>
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        function showResult(html) {
            document.getElementById('test-results').innerHTML = html;
        }

        function testAssignmentError() {
            console.log('üîß Testando corre√ß√£o do Assignment to const...');
            
            try {
                const engine = new EnhancedSuggestionEngine();
                
                // Dados de teste simulando o cen√°rio real
                const mockMetrics = {
                    lufs: -14.5,
                    true_peak: -1.2,
                    dr: 8.5,
                    sub: 10.1,
                    bass: -12.5,
                    low_mid: -8.2
                };
                
                const mockReferenceData = {
                    lufs_target: -14.0,
                    tol_lufs: 0.5,
                    true_peak_target: -1.0,
                    tol_true_peak: 1.0,
                    dr_target: 9.0,
                    tol_dr: 1.0,
                    bands: {
                        sub: { target_db: -17.3, tol_db: 3.0 },
                        bass: { target_db: -15.8, tol_db: 3.0 },
                        low_mid: { target_db: -10.0, tol_db: 2.5 }
                    }
                };
                
                const mockZScores = {
                    lufs_z: 1.0,
                    true_peak_z: 0.2,
                    dr_z: 0.5,
                    sub_z: 9.0,
                    bass_z: 1.1,
                    low_mid_z: 0.7
                };
                
                const mockDependencyBonuses = {
                    sub: 0.1,
                    bass: 0.0,
                    low_mid: 0.0
                };
                
                // Chamar a fun√ß√£o que antes gerava erro
                const suggestions = engine.generateReferenceSuggestions(
                    mockMetrics, 
                    mockReferenceData, 
                    mockZScores, 
                    0.9, 
                    mockDependencyBonuses
                );
                
                showResult(`
                    <div class="success">
                        <h4>‚úÖ SUCESSO: Erro Assignment to const corrigido!</h4>
                        <p>A fun√ß√£o <code>generateReferenceSuggestions</code> executou sem erros.</p>
                        <p><strong>Sugest√µes geradas:</strong> ${suggestions.length}</p>
                        <div class="code-block">
                            ${suggestions.map((s, i) => 
                                `${i + 1}. ${s.action || s.message || 'Sugest√£o gerada'}`
                            ).join('<br>')}
                        </div>
                    </div>
                `);
                
                console.log('‚úÖ Teste passou - generateReferenceSuggestions executou sem erros');
                console.log('üìä Sugest√µes geradas:', suggestions);
                
            } catch (error) {
                console.error('‚ùå Teste falhou:', error);
                
                let errorMessage = error.message;
                let isAssignmentError = errorMessage.includes('Assignment to const');
                
                showResult(`
                    <div class="error">
                        <h4>‚ùå ERRO: ${isAssignmentError ? 'Assignment to const ainda presente!' : 'Outro erro encontrado'}</h4>
                        <p><strong>Mensagem do erro:</strong> ${errorMessage}</p>
                        ${isAssignmentError ? 
                            '<p><strong>Solu√ß√£o:</strong> Verificar se todas as vari√°veis que precisam ser reatribu√≠das est√£o declaradas com <code>let</code> em vez de <code>const</code>.</p>' :
                            '<p><strong>Investigar:</strong> Este √© um erro diferente que precisa ser analisado.</p>'
                        }
                    </div>
                `);
            }
        }

        function testFullSuggestionFlow() {
            console.log('üîÑ Testando fluxo completo de sugest√µes...');
            
            try {
                const engine = new EnhancedSuggestionEngine();
                
                // Simular dados de an√°lise real
                const mockAnalysis = {
                    technicalData: {
                        lufs: -16.2,
                        true_peak: -0.5,
                        dr: 7.8,
                        sub_energy_db: 10.1,
                        bass_energy_db: -12.5,
                        low_mid_energy_db: -8.2,
                        mid_energy_db: -6.5,
                        high_mid_energy_db: -14.2,
                        presence_energy_db: -18.5
                    }
                };
                
                const mockReferenceData = {
                    lufs_target: -14.0,
                    tol_lufs: 0.5,
                    true_peak_target: -1.0,
                    tol_true_peak: 1.0,
                    dr_target: 9.0,
                    tol_dr: 1.0,
                    bands: {
                        sub: { target_db: -17.3, tol_db: 3.0 },
                        bass: { target_db: -15.8, tol_db: 3.0 },
                        low_mid: { target_db: -10.0, tol_db: 2.5 },
                        mid: { target_db: -8.0, tol_db: 2.5 },
                        high_mid: { target_db: -12.0, tol_db: 3.0 },
                        presence: { target_db: -15.0, tol_db: 3.5 }
                    }
                };
                
                // Executar processamento completo
                const result = engine.processAnalysis(mockAnalysis, mockReferenceData);
                
                // Verificar crit√©rios de aceite
                const hasSuggestions = result.suggestions && result.suggestions.length > 0;
                const hasRealDeltas = result.suggestions.every(s => {
                    if (s.technical && s.technical.delta !== null) {
                        return !s.action || !s.action.includes('6.0 dB') && !s.action.includes('4.0 dB');
                    }
                    return true;
                });
                
                const hasValidActions = result.suggestions.filter(s => s.action).length > 0;
                
                showResult(`
                    <div class="${hasSuggestions && hasRealDeltas && hasValidActions ? 'success' : 'error'}">
                        <h4>${hasSuggestions && hasRealDeltas && hasValidActions ? '‚úÖ' : '‚ùå'} Teste do Fluxo Completo</h4>
                        <p><strong>Crit√©rios de Aceite:</strong></p>
                        <ul>
                            <li>${hasSuggestions ? '‚úÖ' : '‚ùå'} analysis.suggestions deve ter entradas</li>
                            <li>${hasRealDeltas ? '‚úÖ' : '‚ùå'} Nunca voltar valores fixos (6 dB)</li>
                            <li>${hasValidActions ? '‚úÖ' : '‚ùå'} Actions v√°lidos gerados</li>
                        </ul>
                        <p><strong>Sugest√µes geradas:</strong> ${result.suggestions?.length || 0}</p>
                        <div class="code-block">
                            ${result.suggestions?.slice(0, 3).map((s, i) => 
                                `${i + 1}. ${s.action || s.message || 'Sem action'} (Delta: ${s.technical?.delta?.toFixed(1) || 'N/A'})`
                            ).join('<br>') || 'Nenhuma sugest√£o gerada'}
                        </div>
                    </div>
                `);
                
                console.log('üìä Resultado do processamento:', result);
                
            } catch (error) {
                console.error('‚ùå Erro no fluxo completo:', error);
                
                showResult(`
                    <div class="error">
                        <h4>‚ùå ERRO no Fluxo Completo</h4>
                        <p><strong>Mensagem:</strong> ${error.message}</p>
                    </div>
                `);
            }
        }

        // Executar teste autom√°tico ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(testAssignmentError, 1000);
        });
    </script>
</body>
</html>