<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug True Peak - Frontend</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #00ffff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        #console-output {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: rgba(0, 255, 255, 0.3);
        }
        .debug-info {
            background: rgba(0, 255, 146, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Debug - True Peak Frontend</h1>
        
        <div class="section">
            <h2>üîß Console Debug</h2>
            <button onclick="enableDebugMode()">üöÄ Ativar Debug Mode</button>
            <button onclick="clearConsole()">üóëÔ∏è Limpar Console</button>
            <button onclick="checkGlobalState()">üîç Verificar Estado Global</button>
            <div id="console-output"></div>
        </div>
        
        <div class="section">
            <h2>üìã Instru√ß√µes</h2>
            <div class="debug-info">
                <h3>Como usar:</h3>
                <ol>
                    <li>Clique em "Ativar Debug Mode" para capturar logs do console</li>
                    <li>Abra o SoundyAI em outra aba: <code>soundyai-app-production.uparkhway.app</code></li>
                    <li>Fa√ßa upload de um arquivo de √°udio</li>
                    <li>Volte aqui para ver os logs detalhados</li>
                    <li>Procure por logs do tipo "üéØ DEBUG TRUE PEAK" nos resultados</li>
                </ol>
                
                <h3>O que procurar:</h3>
                <ul>
                    <li><strong>üéØ DEBUG TRUE PEAK:</strong> - Logs da fun√ß√£o getMetric</li>
                    <li><strong>üéØ [JSON-OUTPUT] True Peak Debug:</strong> - Logs do backend</li>
                    <li><strong>Valores technicalData.truePeakDbtp:</strong> - Se est√° sendo preenchido</li>
                    <li><strong>advancedReady:</strong> - Se est√° true ou false</li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h2>üéÆ Debug Manual</h2>
            <button onclick="simulateAnalysisDebug()">üß™ Simular An√°lise</button>
            <button onclick="testGetMetricFunction()">‚öôÔ∏è Testar getMetric</button>
            <div id="manual-debug-output"></div>
        </div>
    </div>

    <script>
        let debugMode = false;
        let originalConsole = {};
        
        function enableDebugMode() {
            if (debugMode) return;
            
            debugMode = true;
            const consoleOutput = document.getElementById('console-output');
            
            // Backup original console methods
            originalConsole.log = console.log;
            originalConsole.warn = console.warn;
            originalConsole.error = console.error;
            
            // Override console methods
            ['log', 'warn', 'error'].forEach(method => {
                console[method] = function(...args) {
                    // Call original method
                    originalConsole[method].apply(console, args);
                    
                    // Add to our debug output
                    const timestamp = new Date().toLocaleTimeString();
                    const message = args.map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                    ).join(' ');
                    
                    const color = method === 'error' ? '#ff3366' : 
                                 method === 'warn' ? '#ffd700' : '#00ffff';
                    
                    consoleOutput.innerHTML += 
                        '<div style="color: ' + color + '; margin: 2px 0;">' +
                        '[' + timestamp + '] ' + method.toUpperCase() + ': ' + message +
                        '</div>';
                    
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                };
            });
            
            consoleOutput.innerHTML += '<div style="color: #00ff92;">‚úÖ Debug mode ativado! Fa√ßa upload no SoundyAI...</div>';
        }
        
        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }
        
        function checkGlobalState() {
            const consoleOutput = document.getElementById('console-output');
            
            // Check if we can access the main window
            try {
                const mainWindow = window.parent || window.opener || window;
                const globals = {
                    '__AUDIO_ADVANCED_READY__': mainWindow.__AUDIO_ADVANCED_READY__,
                    'lastAnalysis': mainWindow.lastAnalysis,
                    'currentModalAnalysis': mainWindow.currentModalAnalysis
                };
                
                consoleOutput.innerHTML += 
                    '<div style="color: #00ff92;">üîç Estado Global:</div>' +
                    '<pre style="color: #ffd700;">' + JSON.stringify(globals, null, 2) + '</pre>';
            } catch (error) {
                consoleOutput.innerHTML += 
                    '<div style="color: #ff3366;">‚ùå N√£o foi poss√≠vel acessar estado global: ' + error.message + '</div>';
            }
        }
        
        function simulateAnalysisDebug() {
            const output = document.getElementById('manual-debug-output');
            
            // Simulate analysis object structure
            const mockAnalysis = {
                technicalData: {
                    peak: -0.796,
                    truePeakDbtp: -0.796,
                    truePeakLinear: 0.913,
                    lufsIntegrated: -23.2
                },
                metrics: {
                    truePeakDbtp: -0.796,
                    peak_db: -0.796
                }
            };
            
            // Simulate getMetric function
            function getMetric(metricPath, fallbackPath = null) {
                console.log('üéØ DEBUG TRUE PEAK (SIMULATION):', {
                    metricPath,
                    fallbackPath,
                    centralizedValue: mockAnalysis.metrics[metricPath],
                    legacyValue: mockAnalysis.technicalData[fallbackPath || metricPath],
                    analysis_metrics: mockAnalysis.metrics,
                    analysis_technicalData: mockAnalysis.technicalData
                });
                
                const centralizedValue = mockAnalysis.metrics[metricPath];
                if (Number.isFinite(centralizedValue)) {
                    return centralizedValue;
                }
                
                const legacyValue = mockAnalysis.technicalData[fallbackPath || metricPath];
                return Number.isFinite(legacyValue) ? legacyValue : null;
            }
            
            // Test the function
            const samplePeak = getMetric('peak_db', 'peak');
            const truePeak = getMetric('truePeakDbtp', 'truePeakDbtp');
            const advancedReady = Number.isFinite(mockAnalysis.technicalData.truePeakDbtp) && 
                                 Number.isFinite(mockAnalysis.technicalData.lufsIntegrated);
            
            output.innerHTML = 
                '<h3>üß™ Resultado da Simula√ß√£o:</h3>' +
                '<div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">' +
                '<div><strong>Sample Peak:</strong> ' + samplePeak + ' dBFS</div>' +
                '<div><strong>True Peak:</strong> ' + truePeak + ' dBTP</div>' +
                '<div><strong>Advanced Ready:</strong> ' + advancedReady + '</div>' +
                '<div><strong>Show True Peak?:</strong> ' + (Number.isFinite(truePeak)) + '</div>' +
                '</div>' +
                '<p><em>Verifique o console acima para logs detalhados da simula√ß√£o.</em></p>';
        }
        
        function testGetMetricFunction() {
            console.log('üîß [MANUAL] Testando fun√ß√£o getMetric...');
            
            // Try to access the global getMetric if available
            try {
                const mainWindow = window.parent || window.opener || window;
                if (mainWindow.getMetric) {
                    console.log('‚úÖ [MANUAL] Fun√ß√£o getMetric encontrada!');
                    const test = mainWindow.getMetric('truePeakDbtp', 'truePeakDbtp');
                    console.log('üéØ [MANUAL] Teste getMetric(truePeakDbtp):', test);
                } else {
                    console.log('‚ùå [MANUAL] Fun√ß√£o getMetric n√£o encontrada no escopo global');
                }
            } catch (error) {
                console.log('‚ùå [MANUAL] Erro ao acessar getMetric:', error.message);
            }
        }
        
        // Auto-enable debug mode when page loads
        window.onload = function() {
            enableDebugMode();
        };
    </script>
</body>
</html>