<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste Ordem Sugest√µes Definitivo - SoundyAI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.5em;
        }
        
        .header p {
            color: #7f8c8d;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-section h3 {
            color: #495057;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .button.success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .suggestion-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }
        
        .suggestion-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .suggestion-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .suggestion-content {
            flex: 1;
        }
        
        .suggestion-type {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .suggestion-message {
            color: #6c757d;
            font-size: 14px;
        }
        
        .priority-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .validation-result {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .validation-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .validation-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .log-viewer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        
        .log-info { color: #63b3ed; }
        .log-success { color: #68d391; }
        .log-warning { color: #fbd38d; }
        .log-error { color: #fc8181; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Teste Ordem Sugest√µes Definitivo</h1>
            <p>Valida√ß√£o da corre√ß√£o aplicada ao sistema de ordena√ß√£o do SoundyAI</p>
        </div>
        
        <div class="test-section">
            <h3>üß™ Teste de Ordena√ß√£o Determin√≠stica</h3>
            <p>Este teste valida se a fun√ß√£o <code>applyFinalDeterministicOrdering</code> est√° funcionando corretamente.</p>
            
            <button class="button" onclick="testarOrdenacaoDeterministica()">
                üîÑ Executar Teste de Ordena√ß√£o
            </button>
            
            <button class="button success" onclick="validarOrdemTruePeak()">
                ‚ö° Validar True Peak Primeiro
            </button>
            
            <button class="button danger" onclick="simularCenarioProblema()">
                üö® Simular Cen√°rio Problem√°tico
            </button>
            
            <div id="resultados-ordenacao" class="results" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>üéµ Teste de Integra√ß√£o Completa</h3>
            <p>Teste da integra√ß√£o completa com mock de dados reais do SoundyAI.</p>
            
            <button class="button" onclick="testarIntegracaoCompleta()">
                üîß Executar Integra√ß√£o Completa
            </button>
            
            <div id="resultados-integracao" class="results" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä Log de Auditoria</h3>
            <div id="log-viewer" class="log-viewer" style="display: none;"></div>
            <button class="button" onclick="limparLog()">üóëÔ∏è Limpar Log</button>
        </div>
    </div>

    <script>
        // Sistema de log
        const logEntries = [];
        
        function log(level, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, level, message, data };
            logEntries.push(entry);
            
            console.log(`[${timestamp}] ${level.toUpperCase()}: ${message}`, data || '');
            updateLogViewer();
        }
        
        function updateLogViewer() {
            const logViewer = document.getElementById('log-viewer');
            logViewer.style.display = 'block';
            
            logViewer.innerHTML = logEntries.map(entry => {
                const className = `log-${entry.level}`;
                const dataStr = entry.data ? ` | ${JSON.stringify(entry.data)}` : '';
                return `<div class="${className}">[${entry.timestamp}] ${entry.message}${dataStr}</div>`;
            }).join('');
            
            logViewer.scrollTop = logViewer.scrollHeight;
        }
        
        function limparLog() {
            logEntries.length = 0;
            document.getElementById('log-viewer').innerHTML = '';
            document.getElementById('log-viewer').style.display = 'none';
        }

        // Mock da fun√ß√£o de ordena√ß√£o (copiada da corre√ß√£o aplicada)
        const SUGGESTION_PRIORITY = {
            // N√≠vel 1: CR√çTICO - True Peak deve ser sempre primeiro
            true_peak: 10,
            reference_true_peak: 10,
            reference_true_peak_critical: 10,
            reference_true_peak_warning: 10,
            heuristic_true_peak: 10,
            
            // N√≠vel 2: LOUDNESS - Segundo mais importante
            lufs: 20,
            reference_loudness: 20,
            heuristic_lufs: 20,
            
            // N√≠vel 3: DIN√ÇMICA - Terceiro
            dr: 30,
            reference_dynamics: 30,
            heuristic_lra: 30,
            
            // N√≠vel 4: LRA - Quarto
            lra: 40,
            reference_lra: 40,
            
            // N√≠vel 5: EST√âREO - Quinto
            stereo: 50,
            reference_stereo: 50,
            heuristic_stereo: 50,
            
            // N√≠vel 6: BANDAS ESPECTRAIS - Por √∫ltimo
            sub: 100,
            bass: 110,
            low_mid: 120,
            lowMid: 120,
            mid: 130,
            high_mid: 140,
            highMid: 140,
            presence: 150,
            presenca: 150,
            air: 160,
            brilho: 160,
            
            // Tipos de banda
            band_adjust: 170,
            reference_band_comparison: 170,
            heuristic_spectral_imbalance: 170
        };

        function stableSuggestionSort(a, b) {
            const getMetricKey = (suggestion) => {
                return suggestion.metricKey || 
                       suggestion.type || 
                       suggestion.subtype || 
                       suggestion.band || 
                       'unknown';
            };

            const keyA = getMetricKey(a);
            const keyB = getMetricKey(b);
            
            const pa = SUGGESTION_PRIORITY[keyA] ?? 9999;
            const pb = SUGGESTION_PRIORITY[keyB] ?? 9999;
            
            if (pa !== pb) return pa - pb;
            
            const priorityA = a.priority || 0;
            const priorityB = b.priority || 0;
            if (priorityA !== priorityB) return priorityB - priorityA;
            
            const severityOrder = { 'red': 1, 'orange': 2, 'yellow': 3, 'green': 4 };
            const severityA = severityOrder[a.severity?.level] || 999;
            const severityB = severityOrder[b.severity?.level] || 999;
            if (severityA !== severityB) return severityA - severityB;
            
            return (keyA || '').localeCompare(keyB || '');
        }

        function applyFinalDeterministicOrdering(suggestions) {
            if (!Array.isArray(suggestions) || suggestions.length === 0) {
                return suggestions;
            }
            return [...suggestions].sort(stableSuggestionSort);
        }

        // Dados de teste
        function criarSugestoesMock() {
            return [
                {
                    type: 'band_adjust',
                    subtype: 'bass',
                    message: 'Ajustar Bass',
                    priority: 5,
                    severity: { level: 'yellow' }
                },
                {
                    type: 'reference_true_peak',
                    message: 'True Peak alto - CORRIJA PRIMEIRO',
                    priority: 9.5,
                    severity: { level: 'red' }
                },
                {
                    type: 'reference_loudness',
                    message: 'LUFS fora do ideal',
                    priority: 7,
                    severity: { level: 'orange' }
                },
                {
                    type: 'band_adjust',
                    subtype: 'presenca',
                    message: 'Ajustar Presen√ßa',
                    priority: 4,
                    severity: { level: 'yellow' }
                },
                {
                    type: 'reference_lra',
                    message: 'LRA baixo',
                    priority: 6,
                    severity: { level: 'yellow' }
                },
                {
                    type: 'reference_stereo',
                    message: 'Correla√ß√£o est√©reo estreita',
                    priority: 5.5,
                    severity: { level: 'yellow' }
                }
            ];
        }

        function testarOrdenacaoDeterministica() {
            log('info', 'Iniciando teste de ordena√ß√£o determin√≠stica');
            
            const suggestionsOriginal = criarSugestoesMock();
            log('info', 'Sugest√µes originais criadas', { count: suggestionsOriginal.length });
            
            // Embaralhar propositalmente
            const suggestionsEmbaralhadas = [...suggestionsOriginal].sort(() => Math.random() - 0.5);
            log('warning', 'Sugest√µes embaralhadas propositalmente');
            
            // Aplicar ordena√ß√£o
            const suggestionsOrdenadas = applyFinalDeterministicOrdering(suggestionsEmbaralhadas);
            log('success', 'Ordena√ß√£o aplicada', { 
                originalCount: suggestionsEmbaralhadas.length,
                orderedCount: suggestionsOrdenadas.length 
            });
            
            // Mostrar resultados
            mostrarResultados('resultados-ordenacao', suggestionsOrdenadas);
            
            // Validar
            validarOrdemCorreta(suggestionsOrdenadas);
        }

        function validarOrdemTruePeak() {
            log('info', 'Validando se True Peak aparece primeiro');
            
            const suggestions = criarSugestoesMock();
            const ordered = applyFinalDeterministicOrdering(suggestions);
            
            const primeiro = ordered[0];
            const isTruePeakFirst = primeiro && primeiro.type?.includes('true_peak');
            
            if (isTruePeakFirst) {
                log('success', '‚úÖ True Peak est√° em primeiro lugar!');
                showValidationResult('success', '‚úÖ True Peak aparece primeiro conforme esperado!');
            } else {
                log('error', '‚ùå True Peak N√ÉO est√° em primeiro lugar!', { primeiro });
                showValidationResult('error', '‚ùå ERRO: True Peak n√£o est√° em primeiro lugar!');
            }
        }

        function simularCenarioProblema() {
            log('info', 'Simulando cen√°rio problem√°tico (sistema legado interferindo)');
            
            // Simular o problema antigo: Enhanced Engine ordena, sistema legado quebra
            const enhancedSuggestions = applyFinalDeterministicOrdering(criarSugestoesMock());
            log('info', 'Enhanced Engine ordenou corretamente');
            
            // Simular o problema: adicionar sugest√µes no final (sistema legado)
            const legacySuggestions = [
                {
                    type: 'reference_true_peak_critical',
                    message: 'True Peak cr√≠tico (sistema legado)',
                    priority: 10,
                    severity: { level: 'red' }
                }
            ];
            
            // O problema antigo: misturar sem reordenar
            const problematico = [...enhancedSuggestions, ...legacySuggestions];
            log('warning', 'Sistema legado adicionou sugest√µes no final (problema antigo)');
            
            // Nossa corre√ß√£o: reordenar tudo novamente
            const corrigido = applyFinalDeterministicOrdering(problematico);
            log('success', 'Corre√ß√£o aplicada - reordena√ß√£o final');
            
            mostrarResultados('resultados-ordenacao', corrigido);
            
            // Verificar se True Peak ficou primeiro
            const truePeakFirst = corrigido[0]?.type?.includes('true_peak');
            if (truePeakFirst) {
                showValidationResult('success', '‚úÖ Corre√ß√£o funcionou! True Peak voltou ao primeiro lugar ap√≥s interfer√™ncia do sistema legado.');
            } else {
                showValidationResult('error', '‚ùå PROBLEMA: A corre√ß√£o n√£o funcionou adequadamente.');
            }
        }

        function testarIntegracaoCompleta() {
            log('info', 'Testando integra√ß√£o completa com dados realistas');
            
            const mockAnalysis = {
                technicalData: {
                    lufsIntegrated: -12.5,
                    truePeakDbtp: -0.3,
                    dynamicRange: 8.2,
                    lra: 4.1,
                    stereoCorrelation: 0.85,
                    bandEnergies: {
                        bass: { rms_db: -18.5 },
                        mid: { rms_db: -15.2 },
                        presenca: { rms_db: -12.1 }
                    }
                }
            };
            
            const mockReference = {
                lufs_target: -14.0,
                tol_lufs: 2.0,
                true_peak_target: -1.0,
                tol_true_peak: 0.5,
                dr_target: 10.0,
                tol_dr: 2.0,
                lra_target: 6.0,
                tol_lra: 2.0,
                stereo_target: 0.90,
                tol_stereo: 0.10
            };
            
            log('info', 'Mock data criado', { analysis: mockAnalysis, reference: mockReference });
            
            // Simular processamento do Enhanced Engine
            const enhancedSuggestions = [
                { type: 'reference_true_peak', message: 'True Peak alto', priority: 9.5, severity: { level: 'red' } },
                { type: 'reference_loudness', message: 'LUFS adequado', priority: 6, severity: { level: 'green' } },
                { type: 'reference_lra', message: 'LRA baixo', priority: 7, severity: { level: 'yellow' } },
                { type: 'band_adjust', subtype: 'bass', message: 'Bass ajustado', priority: 5, severity: { level: 'yellow' } }
            ];
            
            // Aplicar nossa corre√ß√£o
            const finalSuggestions = applyFinalDeterministicOrdering(enhancedSuggestions);
            
            log('success', 'Integra√ß√£o completa processada', { 
                inputCount: enhancedSuggestions.length,
                outputCount: finalSuggestions.length 
            });
            
            mostrarResultados('resultados-integracao', finalSuggestions);
            validarOrdemCorreta(finalSuggestions);
        }

        function mostrarResultados(containerId, suggestions) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            
            const html = suggestions.map((suggestion, index) => {
                const priority = SUGGESTION_PRIORITY[suggestion.type || suggestion.metricKey] || 9999;
                return `
                    <div class="suggestion-card">
                        <div class="suggestion-number">${index + 1}</div>
                        <div class="suggestion-content">
                            <div class="suggestion-type">${suggestion.type || 'Desconhecido'}</div>
                            <div class="suggestion-message">${suggestion.message || 'Sem mensagem'}</div>
                        </div>
                        <div class="priority-badge">P: ${priority}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<h4>üìã Resultados da Ordena√ß√£o:</h4>${html}`;
        }

        function validarOrdemCorreta(suggestions) {
            const primeiroTruePeak = suggestions[0]?.type?.includes('true_peak');
            const ultimasBandas = suggestions.slice(-2).every(s => 
                s.type?.includes('band') || s.subtype || 
                ['sub', 'bass', 'mid', 'presenca', 'air'].includes(s.type)
            );
            
            if (primeiroTruePeak) {
                log('success', '‚úÖ True Peak em primeiro lugar');
            } else {
                log('error', '‚ùå True Peak N√ÉO est√° em primeiro lugar');
            }
            
            if (ultimasBandas && suggestions.length > 2) {
                log('success', '‚úÖ Bandas espectrais no final da lista');
            } else {
                log('warning', '‚ÑπÔ∏è Poucas bandas para validar posi√ß√£o final');
            }
        }

        function showValidationResult(type, message) {
            const existingResult = document.querySelector('.validation-result');
            if (existingResult) {
                existingResult.remove();
            }
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `validation-result ${type}`;
            resultDiv.textContent = message;
            
            document.querySelector('.test-section').appendChild(resultDiv);
            
            setTimeout(() => {
                resultDiv.remove();
            }, 5000);
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('info', 'Sistema de teste inicializado');
            log('info', 'Fun√ß√£o applyFinalDeterministicOrdering carregada');
            log('info', 'SUGGESTION_PRIORITY configurado com ' + Object.keys(SUGGESTION_PRIORITY).length + ' tipos');
        });
    </script>
</body>
</html>