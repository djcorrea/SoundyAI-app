<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® TESTE EMERG√äNCIA - Sistema de Sugest√µes</title>
    <style>
        body {
            background: #0a0a0a;
            color: white;
            font-family: monospace;
            padding: 20px;
        }
        .log {
            background: #1a1a1a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00ff88;
        }
        .error {
            border-left-color: #ff4444;
        }
        .warning {
            border-left-color: #ffaa00;
        }
        .test-result {
            background: #2a2a2a;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border: 2px solid #444;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #005a99;
        }
        .success {
            color: #00ff88;
        }
        .fail {
            color: #ff4444;
        }
    </style>
</head>
<body>
    <h1>üö® TESTE EMERG√äNCIA - Sistema de Sugest√µes</h1>
    <p>Sistema para for√ßar ativa√ß√£o e testar o sistema de sugest√µes que n√£o est√° aparecendo.</p>
    
    <button onclick="testarCarregamento()">1. Testar Carregamento de Sistemas</button>
    <button onclick="testarProcessamento()">2. Testar Processamento de Sugest√µes</button>
    <button onclick="simularAnaliseCompleta()">3. Simular An√°lise Completa</button>
    <button onclick="forcarAtualizacao()">4. FOR√áAR Atualiza√ß√£o do Modal</button>
    
    <div id="resultados"></div>

    <!-- Carregar sistemas necess√°rios -->
    <script src="suggestion-system-emergency.js?v=emergency-20250920"></script>
    <script src="embedded-refs-new.js?v=20250829-true-peak-fix&timestamp=1756500921"></script>
    <script src="status-suggestion-unified-v1.js?v=20250829"></script>
    <script src="force-unified-activation.js?v=20250829"></script>

    <script>
        const log = (msg, type = 'info') => {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('resultados').appendChild(div);
            console.log(msg);
        };

        const testResult = (title, success, details) => {
            const div = document.createElement('div');
            div.className = 'test-result';
            div.innerHTML = `
                <h3>${title}: <span class="${success ? 'success' : 'fail'}">${success ? '‚úÖ SUCESSO' : '‚ùå FALHA'}</span></h3>
                <p>${details}</p>
            `;
            document.getElementById('resultados').appendChild(div);
        };

        function testarCarregamento() {
            log('üîç Testando carregamento de sistemas...');
            
            // Testar emergency system
            const emergencyOK = typeof window.suggestionSystem === 'object' && typeof window.suggestionSystem.process === 'function';
            testResult('Sistema de Emerg√™ncia', emergencyOK, 
                emergencyOK ? 'window.suggestionSystem.process dispon√≠vel' : 'window.suggestionSystem n√£o encontrado');
            
            // Testar refer√™ncias
            const refsOK = typeof window.EMBEDDED_REFS === 'object' && window.EMBEDDED_REFS;
            testResult('Refer√™ncias Embarcadas', refsOK, 
                refsOK ? `${Object.keys(window.EMBEDDED_REFS).length} g√™neros carregados` : 'EMBEDDED_REFS n√£o encontrado');
            
            // Testar unified system
            const unifiedOK = typeof window.createEnhancedSuggestions === 'function';
            testResult('Sistema Unificado', unifiedOK, 
                unifiedOK ? 'createEnhancedSuggestions dispon√≠vel' : 'Sistema unificado n√£o carregado');
            
            // Testar flag
            const flagOK = window.USE_UNIFIED_SUGGESTIONS === true;
            testResult('Flag de Ativa√ß√£o', flagOK, 
                `USE_UNIFIED_SUGGESTIONS = ${window.USE_UNIFIED_SUGGESTIONS}`);
        }

        function testarProcessamento() {
            log('üß™ Testando processamento de sugest√µes...');
            
            if (!window.suggestionSystem) {
                testResult('Processamento', false, 'Sistema de emerg√™ncia n√£o dispon√≠vel');
                return;
            }
            
            // Dados de teste simulando Trance
            const analysisTest = {
                technicalData: {
                    lufs: -22.08,
                    true_peak: 0.3,
                    dr: 5.176,
                    stereo_correlation: 0.783
                },
                suggestions: []
            };
            
            const refTest = {
                genre: 'trance',
                lufs: -11.5,
                truePeak: -1,
                dr: 8.8,
                stereoCorrelation: 0.72
            };
            
            try {
                log('üìä Processando an√°lise de teste...');
                const result = window.suggestionSystem.process(analysisTest, refTest);
                
                const success = result && result.suggestions && result.suggestions.length > 0;
                testResult('Processamento de Sugest√µes', success, 
                    success ? `${result.suggestions.length} sugest√µes geradas` : 'Nenhuma sugest√£o gerada');
                
                if (success) {
                    result.suggestions.forEach((s, i) => {
                        log(`üìù Sugest√£o ${i+1}: ${s.type || 'sem tipo'} - ${s.message || 'sem mensagem'}`);
                    });
                }
                
            } catch (error) {
                testResult('Processamento de Sugest√µes', false, `Erro: ${error.message}`);
                log(`‚ùå Erro: ${error}`, 'error');
            }
        }

        function simularAnaliseCompleta() {
            log('üé¨ Simulando an√°lise completa com Trance...');
            
            // Simular dados reais da an√°lise que falhou
            const analysisCompleta = {
                technicalData: {
                    lufs: -22.08,
                    true_peak: 0.3,
                    dr: 5.176,
                    stereo_correlation: 0.783,
                    centralizedBands: {
                        sub: 6.8,
                        bass: 9.2,
                        lowMid: 7.7,
                        mid: 3.8,
                        highMid: -1.1,
                        presence: -6.2,
                        air: -12.8
                    }
                },
                suggestions: [], // Vazio inicialmente
                metadata: { genre: 'trance' }
            };
            
            const refTrance = window.EMBEDDED_REFS?.trance || {
                genre: 'trance',
                lufs: -11.5,
                truePeak: -1,
                dr: 8.8,
                stereoCorrelation: 0.72
            };
            
            try {
                log('üéØ Processando an√°lise completa...');
                const enhanced = window.suggestionSystem.process(analysisCompleta, refTrance);
                
                const success = enhanced && enhanced.suggestions && enhanced.suggestions.length > 0;
                testResult('An√°lise Completa', success, 
                    success ? `An√°lise processada com ${enhanced.suggestions.length} sugest√µes` : 'Falha no processamento');
                
                if (success) {
                    log('üìã Sugest√µes geradas:');
                    enhanced.suggestions.forEach((s, i) => {
                        log(`  ${i+1}. [${s.type}] ${s.message}`, 'success');
                        if (s.explanation) log(`     üí° ${s.explanation}`);
                        if (s.impact) log(`     ‚ö†Ô∏è ${s.impact}`);
                        if (s.action) log(`     üîß ${s.action}`);
                    });
                    
                    // Armazenar globalmente para debug
                    window.__TEST_ENHANCED_ANALYSIS__ = enhanced;
                    log('üíæ An√°lise armazenada em window.__TEST_ENHANCED_ANALYSIS__', 'success');
                }
                
            } catch (error) {
                testResult('An√°lise Completa', false, `Erro: ${error.message}`);
                log(`‚ùå Erro na an√°lise: ${error}`, 'error');
            }
        }

        function forcarAtualizacao() {
            log('‚ö° FOR√áANDO atualiza√ß√£o do modal atual...');
            
            // Tentar encontrar an√°lise atual no modal
            if (typeof currentModalAnalysis !== 'undefined' && currentModalAnalysis) {
                log('üìä currentModalAnalysis encontrada, processando...');
                
                try {
                    const refAtual = window.__activeRefData || window.EMBEDDED_REFS?.trance;
                    if (refAtual && window.suggestionSystem) {
                        log('üîÑ Processando an√°lise atual...');
                        const enhanced = window.suggestionSystem.process(currentModalAnalysis, refAtual);
                        
                        if (enhanced && enhanced.suggestions) {
                            currentModalAnalysis.suggestions = enhanced.suggestions;
                            log(`‚úÖ ${enhanced.suggestions.length} sugest√µes adicionadas √† an√°lise atual`, 'success');
                            
                            // For√ßar re-renderiza√ß√£o
                            if (typeof displayModalResults === 'function') {
                                log('üîÑ Re-renderizando modal...');
                                displayModalResults(currentModalAnalysis);
                                testResult('Atualiza√ß√£o For√ßada', true, 'Modal atualizado com novas sugest√µes');
                            } else {
                                testResult('Atualiza√ß√£o For√ßada', false, 'displayModalResults n√£o encontrada');
                            }
                        } else {
                            testResult('Atualiza√ß√£o For√ßada', false, 'Falha ao gerar sugest√µes');
                        }
                    } else {
                        testResult('Atualiza√ß√£o For√ßada', false, 'Refer√™ncia ou sistema n√£o dispon√≠vel');
                    }
                } catch (error) {
                    testResult('Atualiza√ß√£o For√ßada', false, `Erro: ${error.message}`);
                    log(`‚ùå Erro: ${error}`, 'error');
                }
            } else {
                testResult('Atualiza√ß√£o For√ßada', false, 'currentModalAnalysis n√£o encontrada (modal n√£o est√° aberto?)');
                log('‚ö†Ô∏è Certifique-se de que h√° uma an√°lise aberta no modal principal', 'warning');
            }
        }

        // Auto-inicializa√ß√£o
        window.addEventListener('load', () => {
            log('üöÄ Sistema de teste carregado!', 'success');
            log('üìã Comandos dispon√≠veis via console:');
            log('  - testarCarregamento()');
            log('  - testarProcessamento()');
            log('  - simularAnaliseCompleta()');
            log('  - forcarAtualizacao()');
        });
    </script>
</body>
</html>