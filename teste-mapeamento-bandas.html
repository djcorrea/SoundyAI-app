<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Teste de Mapeamento de Bandas Espectrais</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #53a8ff;
            margin-top: 0;
        }
        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .mapping-table th, .mapping-table td {
            border: 1px solid #0f3460;
            padding: 8px 12px;
            text-align: left;
        }
        .mapping-table th {
            background: #0f3460;
            color: #53a8ff;
        }
        .status-ok { color: #52f7ad; }
        .status-warn { color: #ffce4d; }
        .status-error { color: #ff7b7b; }
        .log-container {
            background: #0a0a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #53a8ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #4691e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Auditoria de Bandas Espectrais</h1>
        
        <div class="section">
            <h2>📋 Mapeamento de Bandas</h2>
            <p>Verificação do mapeamento entre bandas calculadas e referências.</p>
            
            <table class="mapping-table">
                <thead>
                    <tr>
                        <th>Banda Calculada</th>
                        <th>Chave na Referência</th>
                        <th>Nome de Display</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="mappingTableBody">
                    <!-- Será preenchido via JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>🧪 Testes</h2>
            <button onclick="testMapping()">Testar Mapeamento</button>
            <button onclick="testReferenceLoad()">Carregar Referência</button>
            <button onclick="simulateAnalysis()">Simular Análise</button>
            <button onclick="testFullFlow()">Teste Completo</button>
            <button onclick="clearLogs()">Limpar Logs</button>
        </div>
        
        <div class="section">
            <h2>📊 Resultados dos Testes</h2>
            <div id="testResults"></div>
        </div>
        
        <div class="section">
            <h2>📝 Logs</h2>
            <div id="logContainer" class="log-container"></div>
        </div>
    </div>

    <script>
        // Interceptar console.log para mostrar na página
        const logContainer = document.getElementById('logContainer');
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logContainer.textContent += `[LOG] ${args.join(' ')}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logContainer.textContent += `[WARN] ${args.join(' ')}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logContainer.textContent += `[ERROR] ${args.join(' ')}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        };
        
        // Mapeamento esperado
        const expectedMapping = {
            'sub': 'sub',
            'bass': 'low_bass',
            'lowMid': 'low_mid',
            'mid': 'mid',
            'highMid': 'high_mid',
            'presence': 'presenca',
            'air': 'brilho'
        };
        
        // Dados de teste simulados
        const simulatedAnalysisData = {
            metrics: {
                bands: {
                    sub: { energy_db: -18.5 },
                    bass: { energy_db: -16.2 },
                    lowMid: { energy_db: -19.8 },
                    mid: { energy_db: -15.1 },
                    highMid: { energy_db: -23.4 },
                    presence: { energy_db: -28.9 },
                    air: { energy_db: -31.2 }
                }
            }
        };
        
        let referenceData = null;
        
        // Preencher tabela de mapeamento
        function populateMappingTable() {
            const tbody = document.getElementById('mappingTableBody');
            tbody.innerHTML = '';
            
            Object.entries(expectedMapping).forEach(([calc, ref]) => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = calc;
                row.insertCell(1).textContent = ref;
                row.insertCell(2).textContent = getDisplayName(calc);
                
                const statusCell = row.insertCell(3);
                if (referenceData && referenceData.legacy_compatibility?.bands?.[ref]) {
                    statusCell.textContent = '✅ OK';
                    statusCell.className = 'status-ok';
                } else if (referenceData) {
                    statusCell.textContent = '❌ Não encontrado';
                    statusCell.className = 'status-error';
                } else {
                    statusCell.textContent = '⏳ Aguardando referência';
                    statusCell.className = 'status-warn';
                }
            });
        }
        
        function getDisplayName(calcBand) {
            const displayNames = {
                sub: 'Sub (20–60Hz)',
                bass: 'Bass (60–150Hz)',
                lowMid: 'Low-Mid (150–500Hz)',
                mid: 'Mid (500–2kHz)',
                highMid: 'High-Mid (2–5kHz)',
                presence: 'Presence (5–10kHz)',
                air: 'Air (10–20kHz)'
            };
            return displayNames[calcBand] || calcBand;
        }
        
        // Testes
        async function testReferenceLoad() {
            console.log('🔄 Carregando dados de referência...');
            try {
                const response = await fetch('./refs/funk_mandela.json');
                referenceData = await response.json();
                
                if (referenceData.funk_mandela) {
                    referenceData = referenceData.funk_mandela;
                    console.log('✅ Referência carregada com sucesso');
                    console.log('📋 Estrutura:', Object.keys(referenceData));
                    
                    if (referenceData.legacy_compatibility?.bands) {
                        console.log('✅ Bandas de referência encontradas:');
                        Object.keys(referenceData.legacy_compatibility.bands).forEach(band => {
                            const data = referenceData.legacy_compatibility.bands[band];
                            console.log(`  ${band}: target=${data.target_db}dB, tol=${data.tol_db}dB`);
                        });
                    }
                } else {
                    console.error('❌ Estrutura de referência inválida');
                }
                
                populateMappingTable();
                updateTestResults('testReferenceLoad', true, 'Referência carregada');
                
            } catch (error) {
                console.error('❌ Erro ao carregar referência:', error);
                updateTestResults('testReferenceLoad', false, error.message);
            }
        }
        
        function testMapping() {
            console.log('🔄 Testando mapeamento de bandas...');
            
            if (!referenceData) {
                console.error('❌ Carregue a referência primeiro');
                updateTestResults('testMapping', false, 'Referência não carregada');
                return;
            }
            
            let success = true;
            let errors = [];
            
            Object.entries(expectedMapping).forEach(([calc, ref]) => {
                const refBandData = referenceData.legacy_compatibility?.bands?.[ref];
                
                if (refBandData) {
                    console.log(`✅ ${calc} → ${ref}: target=${refBandData.target_db}dB`);
                } else {
                    console.error(`❌ ${calc} → ${ref}: Referência não encontrada`);
                    success = false;
                    errors.push(`${calc} → ${ref}`);
                }
            });
            
            updateTestResults('testMapping', success, 
                success ? 'Todos os mapeamentos OK' : `Erros: ${errors.join(', ')}`);
        }
        
        function simulateAnalysis() {
            console.log('🔄 Simulando análise com dados de teste...');
            
            if (!referenceData) {
                console.error('❌ Carregue a referência primeiro');
                updateTestResults('simulateAnalysis', false, 'Referência não carregada');
                return;
            }
            
            console.log('📊 Dados de análise simulados:');
            Object.entries(simulatedAnalysisData.metrics.bands).forEach(([band, data]) => {
                console.log(`  ${band}: ${data.energy_db}dB`);
            });
            
            // Simular comparação
            console.log('\n🔄 Simulando comparação com referência...');
            let comparisons = [];
            
            Object.entries(simulatedAnalysisData.metrics.bands).forEach(([calcBand, calcData]) => {
                const refBandKey = expectedMapping[calcBand];
                const refBandData = referenceData.legacy_compatibility?.bands?.[refBandKey];
                
                if (refBandData) {
                    const difference = calcData.energy_db - refBandData.target_db;
                    const withinTolerance = Math.abs(difference) <= refBandData.tol_db;
                    const status = withinTolerance ? '✅ OK' : '⚠️ Fora da tolerância';
                    
                    console.log(`  ${getDisplayName(calcBand)}:`);
                    console.log(`    Calculado: ${calcData.energy_db}dB`);
                    console.log(`    Target: ${refBandData.target_db}dB`);
                    console.log(`    Diferença: ${difference.toFixed(2)}dB`);
                    console.log(`    Status: ${status}`);
                    
                    comparisons.push({
                        band: calcBand,
                        status: withinTolerance,
                        difference: Math.abs(difference)
                    });
                } else {
                    console.error(`  ❌ ${calcBand}: Referência não encontrada`);
                    comparisons.push({ band: calcBand, status: false, difference: null });
                }
            });
            
            const successCount = comparisons.filter(c => c.status).length;
            const totalCount = comparisons.length;
            
            updateTestResults('simulateAnalysis', successCount === totalCount, 
                `${successCount}/${totalCount} bandas com referência válida`);
        }
        
        function testFullFlow() {
            console.log('🚀 Executando teste completo...');
            
            // Executar todos os testes em sequência
            testReferenceLoad().then(() => {
                setTimeout(() => {
                    testMapping();
                    setTimeout(() => {
                        simulateAnalysis();
                        console.log('✅ Teste completo finalizado');
                    }, 500);
                }, 500);
            });
        }
        
        function updateTestResults(testName, success, message) {
            const resultsDiv = document.getElementById('testResults');
            const existingResult = document.getElementById(`result-${testName}`);
            
            const resultHtml = `
                <div id="result-${testName}" style="margin: 5px 0; padding: 10px; border-radius: 4px; background: ${success ? '#1a5e1a' : '#5e1a1a'};">
                    <strong>${testName}:</strong> 
                    <span class="${success ? 'status-ok' : 'status-error'}">${success ? '✅' : '❌'}</span>
                    ${message}
                </div>
            `;
            
            if (existingResult) {
                existingResult.outerHTML = resultHtml;
            } else {
                resultsDiv.innerHTML += resultHtml;
            }
        }
        
        function clearLogs() {
            logContainer.textContent = '';
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            populateMappingTable();
            console.log('🔍 Sistema de auditoria de bandas espectrais carregado');
            console.log('📋 Use os botões acima para executar os testes');
        });
    </script>
</body>
</html>