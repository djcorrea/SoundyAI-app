<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Debug True Peak Final</title>
    <style>
        body { 
            font-family: monospace; 
            background: #000; 
            color: #0f0; 
            padding: 20px; 
        }
        .debug { 
            background: #111; 
            padding: 10px; 
            margin: 10px 0; 
            border-left: 3px solid #0f0; 
        }
        .error { 
            background: #300; 
            border-left-color: #f00; 
            color: #f88; 
        }
        .success { 
            background: #030; 
            border-left-color: #0f0; 
            color: #8f8; 
        }
        .value { 
            background: #008; 
            border-left-color: #00f; 
            color: #aaf; 
        }
    </style>
</head>
<body>
    <h1>🎯 Debug True Peak - Frontend Final</h1>
    <div id="debugOutput"></div>

    <script>
        // Interceptar console.log para capturar debug do True Peak
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        const debugDiv = document.getElementById('debugOutput');
        
        function addDebugLine(message, type = 'debug') {
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> ${message}`;
            debugDiv.appendChild(div);
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            if (message.includes('TRUE PEAK') || message.includes('truePeak') || message.includes('🎯')) {
                addDebugLine(message, 'success');
            }
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            if (message.includes('TRUE PEAK') || message.includes('truePeak') || message.includes('🎯')) {
                addDebugLine(message, 'error');
            }
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            if (message.includes('TRUE PEAK') || message.includes('truePeak') || message.includes('🎯')) {
                addDebugLine(message, 'error');
            }
        };
        
        // Monitorar mudanças na página para capturar quando análise for carregada
        let lastAnalysisData = null;
        
        setInterval(() => {
            // Tentar acessar dados da análise global
            const analysis = window.currentAnalysis || window.analysis || window.audioAnalysis;
            
            if (analysis && analysis !== lastAnalysisData) {
                lastAnalysisData = analysis;
                
                addDebugLine('🔍 Análise detectada!', 'success');
                
                // Verificar estrutura de dados
                const hasMetrics = !!analysis.metrics;
                const hasTechnicalData = !!analysis.technicalData;
                
                addDebugLine(`📊 Estrutura: metrics=${hasMetrics}, technicalData=${hasTechnicalData}`, 'value');
                
                // Verificar True Peak em diferentes locais
                const locations = [
                    'analysis.metrics.truePeakDbtp',
                    'analysis.technicalData.truePeakDbtp',
                    'analysis.metrics.true_peak_dbtp',
                    'analysis.technicalData.true_peak_dbtp',
                    'analysis.coreMetrics.truePeak.maxDbtp',
                    'analysis.metrics.core.truePeak.maxDbtp'
                ];
                
                locations.forEach(path => {
                    try {
                        const value = path.split('.').reduce((obj, key) => obj?.[key], window);
                        if (value !== undefined) {
                            addDebugLine(`✅ ENCONTRADO: ${path} = ${value}`, 'success');
                        }
                    } catch (e) {
                        // Ignorar erros
                    }
                });
                
                // Mostrar toda a estrutura relevante
                if (analysis.technicalData) {
                    const truePeakKeys = Object.keys(analysis.technicalData).filter(k => 
                        k.toLowerCase().includes('peak') || k.toLowerCase().includes('true')
                    );
                    
                    if (truePeakKeys.length > 0) {
                        addDebugLine(`🔑 Chaves True Peak em technicalData: ${truePeakKeys.join(', ')}`, 'value');
                        truePeakKeys.forEach(key => {
                            addDebugLine(`   ${key}: ${analysis.technicalData[key]}`, 'value');
                        });
                    }
                }
                
                if (analysis.metrics) {
                    const truePeakKeys = Object.keys(analysis.metrics).filter(k => 
                        k.toLowerCase().includes('peak') || k.toLowerCase().includes('true')
                    );
                    
                    if (truePeakKeys.length > 0) {
                        addDebugLine(`🔑 Chaves True Peak em metrics: ${truePeakKeys.join(', ')}`, 'value');
                        truePeakKeys.forEach(key => {
                            addDebugLine(`   ${key}: ${analysis.metrics[key]}`, 'value');
                        });
                    }
                }
            }
        }, 1000);
        
        addDebugLine('🚀 Debug iniciado. Aguardando dados da análise...', 'success');
    </script>
</body>
</html>