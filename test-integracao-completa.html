<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Integra√ß√£o IA Completo - SoundyAI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2d2d2d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #00ff88;
        }
        .log-output {
            background: #000;
            color: #00ff88;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #00cc6a;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success { background: #004d1a; color: #00ff88; }
        .status.error { background: #4d0000; color: #ff6b6b; }
        .status.info { background: #003d4d; color: #4dabf7; }
        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .suggestion-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00ff88;
        }
        .suggestion-card.ai-enhanced {
            border-left-color: #ff6b6b;
        }
        .suggestion-card.ai-generated {
            border-left-color: #4dabf7;
        }
    </style>
</head>
<body>
    <h1>ü§ñ Teste Integra√ß√£o IA Completo - SoundyAI</h1>
    <p>Este teste verifica todo o fluxo de integra√ß√£o com IA, incluindo gera√ß√£o e merge de sugest√µes.</p>

    <div class="test-section">
        <h2>üéØ Teste Completo de Integra√ß√£o</h2>
        <button onclick="testarIntegracaoCompleta()">Testar Fluxo Completo</button>
        <button onclick="testarSemIA()">Testar Sem IA (Baseline)</button>
        <button onclick="limparResultados()">Limpar Resultados</button>
    </div>

    <div class="test-section">
        <h2>üìä Status do Teste</h2>
        <div id="test-status"></div>
    </div>

    <div class="test-section">
        <h2>üìù Log de Execu√ß√£o</h2>
        <div id="log-output" class="log-output"></div>
    </div>

    <div class="test-section">
        <h2>üí° Sugest√µes Resultantes</h2>
        <div id="suggestions-display" class="suggestions-grid"></div>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="public/enhanced-suggestion-engine.js"></script>
    <script src="public/suggestion-scorer.js"></script>
    <script src="public/ai-suggestions-integration.js"></script>

    <script>
        // Vari√°vel global para o log
        let testLog = '';

        // Fun√ß√£o para adicionar ao log
        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            testLog += logMessage;
            document.getElementById('log-output').textContent = testLog;
            
            // Auto-scroll para o final
            const logElement = document.getElementById('log-output');
            logElement.scrollTop = logElement.scrollHeight;
        }

        // Fun√ß√£o para mostrar status
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('test-status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Override do console.log para capturar logs
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            const message = args.join(' ');
            if (message.includes('[ENHANCED-ENGINE]') || 
                message.includes('[AI-INTEGRATION]') || 
                message.includes('[AI-MERGE]')) {
                addToLog(message);
            }
            originalConsoleLog.apply(console, args);
        };

        // Dados de teste simulando an√°lise real com problemas detect√°veis
        const mockAnalysisData = {
            loudness: -15.2,    // Muito baixo (target: -8.3)
            loudnessTarget: -8.3,
            loudnessTolerance: 1.22,
            truePeak: 0.8,      // Muito alto (target: -1.0)
            truePeakTarget: -1.0,
            truePeakTolerance: 0.5,
            dynamicRange: 6.1,  // Muito baixo (target: 10.1)
            dynamicRangeTarget: 10.1,
            dynamicRangeTolerance: 1.35,
            bands: {
                bass: 18.5,     // Muito alto (target: 13.3)
                lowMid: 12.8,   // Muito alto (target: 8.8)
                mid: 6.2,       // Muito alto (target: 2.5)
                highMid: -2.1,  // Muito alto (target: -6.7)
                presence: -18.5, // Muito alto (target: -22.7)
                air: -8.2       // Muito alto (target: -13.1)
            }
        };

        const mockReferenceData = {
            lufs_target: -8.3,
            lufs_tolerance: 1.22,
            true_peak_target: -1.0,
            true_peak_tolerance: 0.5,
            dr_target: 10.1,
            dr_tolerance: 1.35,
            bands: {
                bass: { target: 13.3, tolerance: 2.36 },
                lowMid: { target: 8.8, tolerance: 2.07 },
                mid: { target: 2.5, tolerance: 1.81 },
                highMid: { target: -6.7, tolerance: 1.52 },
                presence: { target: -22.7, tolerance: 3.47 },
                air: { target: -13.1, tolerance: 2.38 }
            }
        };

        // Fun√ß√£o para exibir sugest√µes
        function exibirSugestoes(suggestions, titulo) {
            const display = document.getElementById('suggestions-display');
            
            // Verifica√ß√£o robusta se suggestions √© um array v√°lido
            if (!suggestions || !Array.isArray(suggestions) || suggestions.length === 0) {
                const debugInfo = suggestions ? `(tipo: ${typeof suggestions}, √© array: ${Array.isArray(suggestions)})` : '(null/undefined)';
                display.innerHTML = `<p>Nenhuma sugest√£o dispon√≠vel para ${titulo} ${debugInfo}</p>`;
                addToLog(`‚ö†Ô∏è Sugest√µes inv√°lidas para ${titulo}: ${debugInfo}`);
                return;
            }

            let html = `<h3>${titulo} (${suggestions.length} sugest√µes)</h3>`;
            
            suggestions.forEach((suggestion, index) => {
                const cardClass = suggestion.isAIGenerated ? 'ai-generated' : 
                                 suggestion.aiEnhanced ? 'ai-enhanced' : '';
                
                html += `
                    <div class="suggestion-card ${cardClass}">
                        <h4>${suggestion.title}</h4>
                        <p>${suggestion.description}</p>
                        <div style="font-size: 12px; color: #888;">
                            <strong>Categoria:</strong> ${suggestion.category || 'N/A'}<br>
                            <strong>Prioridade:</strong> ${suggestion.priority || 'N/A'}<br>
                            ${suggestion.aiEnhanced ? '<strong>ü§ñ Enriquecida pela IA</strong><br>' : ''}
                            ${suggestion.isAIGenerated ? '<strong>üÜï Gerada pela IA</strong><br>' : ''}
                            ${suggestion.aiSolution ? `<strong>Solu√ß√£o IA:</strong> ${suggestion.aiSolution}<br>` : ''}
                        </div>
                    </div>
                `;
            });
            
            display.innerHTML = html;
        }

        // Teste completo com IA
        async function testarIntegracaoCompleta() {
            addToLog('üöÄ INICIANDO TESTE COMPLETO DE INTEGRA√á√ÉO COM IA');
            showStatus('üîÑ Executando teste completo...', 'info');
            
            try {
                // 1. Criar engine de sugest√µes
                addToLog('üìã Criando EnhancedSuggestionEngine...');
                const engine = new EnhancedSuggestionEngine();
                
                // 2. Processar an√°lise para gerar sugest√µes base
                addToLog('üîç Processando an√°lise de √°udio...');
                addToLog('üìä Dados de entrada:', JSON.stringify({
                    analysis: Object.keys(mockAnalysisData),
                    reference: Object.keys(mockReferenceData),
                    genre: 'eletrofunk'
                }));
                
                const result = engine.processAnalysis(mockAnalysisData, mockReferenceData, 'eletrofunk');
                
                addToLog(`üîç Resultado processAnalysis: ${result ? 'objeto retornado' : 'undefined/null'}`);
                addToLog(`üìã Tipo do resultado: ${typeof result}`);
                
                if (!result) {
                    addToLog('‚ùå ERRO: processAnalysis retornou null/undefined');
                    showStatus('‚ùå ERRO: Engine n√£o gerou resultado', 'error');
                    return;
                }
                
                const suggestions = result.suggestions || [];
                addToLog(`üìã Sugest√µes extra√≠das: ${suggestions.length} itens`);
                
                if (!Array.isArray(suggestions)) {
                    addToLog('‚ùå ERRO: suggestions n√£o √© um array');
                    addToLog(`üìä Conte√∫do suggestions: ${JSON.stringify(suggestions)}`);
                    showStatus('‚ùå ERRO: Suggestions n√£o √© um array v√°lido', 'error');
                    return;
                }
                
                addToLog(`‚úÖ Geradas ${suggestions.length} sugest√µes base`);
                
                // 3. Criar integra√ß√£o com IA
                addToLog('ü§ñ Criando integra√ß√£o com IA...');
                const aiIntegration = new AISuggestionsIntegration();
                
                // 4. Processar com IA (simulando resposta)
                addToLog('üß† Processando com IA...');
                
                // Simular uma resposta de IA
                const mockAIResponse = {
                    suggestions: [
                        {
                            title: suggestions[0]?.title || "Ajustar Loudness",
                            description: "An√°lise detalhada da IA sobre loudness",
                            solution: "Use um compressor multibanda com ratio 3:1 na cadeia de master",
                            priority: "high",
                            rationale: "O loudness atual est√° significativamente abaixo do target para eletrofunk",
                            techniques: ["Compress√£o Multibanda", "Limitador de Sa√≠da", "Satura√ß√£o Harm√¥nica"]
                        },
                        {
                            title: "Otimiza√ß√£o Espectral IA",
                            description: "Sugest√£o adicional baseada em an√°lise de machine learning",
                            category: "ai-spectral",
                            priority: "medium",
                            solution: "Aplicar boost sutil em 2-4kHz para presen√ßa vocal"
                        }
                    ]
                };
                
                // 5. Fazer merge das sugest√µes
                addToLog('üîÄ Fazendo merge com sugest√µes da IA...');
                const mergedSuggestions = aiIntegration.mergeAISuggestionsWithOriginals(suggestions, mockAIResponse);
                
                // 6. Exibir resultados
                addToLog(`üéâ TESTE CONCLU√çDO! ${mergedSuggestions.length} sugest√µes finais`);
                
                const enrichedCount = mergedSuggestions.filter(s => s.aiEnhanced).length;
                const newAICount = mergedSuggestions.filter(s => s.isAIGenerated).length;
                const originalCount = mergedSuggestions.filter(s => !s.isAIGenerated).length;
                
                addToLog(`üìä Distribui√ß√£o:`);
                addToLog(`   - Originais preservadas: ${originalCount}`);
                addToLog(`   - Enriquecidas pela IA: ${enrichedCount}`);
                addToLog(`   - Novas da IA: ${newAICount}`);
                
                // Verificar se preservou todas as originais
                if (originalCount >= suggestions.length) {
                    showStatus(`‚úÖ SUCESSO! Todas ${suggestions.length} sugest√µes originais preservadas + ${newAICount} da IA`, 'success');
                } else {
                    showStatus(`‚ö†Ô∏è ATEN√á√ÉO! Apenas ${originalCount} de ${suggestions.length} sugest√µes preservadas`, 'error');
                }
                
                exibirSugestoes(mergedSuggestions, 'Sugest√µes com IA Integrada');
                
            } catch (error) {
                addToLog(`‚ùå ERRO no teste completo: ${error.message}`);
                showStatus(`‚ùå ERRO: ${error.message}`, 'error');
            }
        }

        // Teste sem IA (baseline)
        async function testarSemIA() {
            addToLog('üìã INICIANDO TESTE SEM IA (BASELINE)');
            showStatus('üîÑ Executando teste baseline...', 'info');
            
            try {
                // Criar engine de sugest√µes
                const engine = new EnhancedSuggestionEngine();
                
                // Processar an√°lise sem IA
                const suggestions = engine.processAnalysis(mockAnalysisData, mockReferenceData, 'eletrofunk');
                
                addToLog(`‚úÖ Geradas ${suggestions.length} sugest√µes baseline (sem IA)`);
                showStatus(`‚úÖ Baseline: ${suggestions.length} sugest√µes geradas`, 'success');
                
                exibirSugestoes(suggestions, 'Sugest√µes Baseline (Sem IA)');
                
            } catch (error) {
                addToLog(`‚ùå ERRO no teste baseline: ${error.message}`);
                showStatus(`‚ùå ERRO Baseline: ${error.message}`, 'error');
            }
        }

        // Limpar resultados
        function limparResultados() {
            testLog = '';
            document.getElementById('log-output').textContent = '';
            document.getElementById('suggestions-display').innerHTML = '';
            showStatus('üßπ Resultados limpos', 'info');
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar depend√™ncias
            const dependencies = {
                'EnhancedSuggestionEngine': typeof window.EnhancedSuggestionEngine,
                'SuggestionScorer': typeof window.SuggestionScorer,
                'AISuggestionsIntegration': typeof window.AISuggestionsIntegration,
                'AISuggestionIntegration': typeof window.AISuggestionIntegration
            };
            
            let allLoaded = true;
            let statusMessage = 'üöÄ Sistema de testes de integra√ß√£o completa carregado\n';
            statusMessage += 'üìã Depend√™ncias:\n';
            
            Object.entries(dependencies).forEach(([name, type]) => {
                const loaded = type === 'function';
                statusMessage += `   - ${name}: ${loaded ? '‚úÖ' : '‚ùå'} (${type})\n`;
                if (!loaded) allLoaded = false;
            });
            
            if (allLoaded) {
                showStatus(statusMessage, 'success');
                addToLog('‚úÖ Todas as depend√™ncias carregadas com sucesso');
            } else {
                showStatus(statusMessage, 'error');
                addToLog('‚ùå Algumas depend√™ncias n√£o foram carregadas');
            }
            
            addToLog('üöÄ Sistema de testes de integra√ß√£o IA inicializado');
            addToLog('üìã Pronto para executar testes de fluxo completo');
        });
    </script>
</body>
</html>