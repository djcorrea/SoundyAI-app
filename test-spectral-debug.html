<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üéØ DEBUG CR√çTICO - Spectral Bands Pipeline</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #000; color: #0f0; }
        .debug { background: #001; padding: 10px; margin: 10px 0; border-left: 3px solid #0f0; }
        .error { background: #100; border-left-color: #f00; color: #f00; }
        .success { background: #010; border-left-color: #0f0; color: #0f0; }
        .warning { background: #110; border-left-color: #ff0; color: #ff0; }
        button { padding: 10px 20px; margin: 10px; background: #222; color: #0f0; border: 1px solid #0f0; }
        pre { background: #000; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üéØ DEBUG CR√çTICO - Pipeline Spectral Bands</h1>
    
    <button onclick="testSpectralBands()">üîç TESTAR SPECTRAL BANDS PIPELINE</button>
    <button onclick="clearLogs()">üßπ Limpar Logs</button>
    
    <div id="results"></div>

    <script type="module">
        import { analyzeAudio } from './work/api/audio/audio-analyzer.js';
        import { logAudio } from './work/lib/logger/logger.js';

        const results = document.getElementById('results');

        function log(message, type = 'debug') {
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        window.clearLogs = () => {
            results.innerHTML = '';
        };

        window.testSpectralBands = async () => {
            try {
                log('üéØ INICIANDO TESTE CR√çTICO DO PIPELINE SPECTRAL BANDS', 'success');
                
                // Criar um arquivo de teste pequeno
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'audio/*';
                
                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    log(`üìÅ Arquivo selecionado: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'success');
                    
                    try {
                        // Interceptar logs do console
                        const originalConsoleLog = console.log;
                        const originalConsoleError = console.error;
                        const originalConsoleWarn = console.warn;
                        
                        console.log = (...args) => {
                            const message = args.join(' ');
                            if (message.includes('[SPECTRAL_CRITICAL]')) {
                                log(`üîç ${message}`, 'warning');
                            }
                            originalConsoleLog(...args);
                        };
                        
                        console.error = (...args) => {
                            const message = args.join(' ');
                            if (message.includes('[SPECTRAL_CRITICAL]')) {
                                log(`‚ùå ${message}`, 'error');
                            }
                            originalConsoleError(...args);
                        };
                        
                        console.warn = (...args) => {
                            const message = args.join(' ');
                            if (message.includes('[SPECTRAL_CRITICAL]')) {
                                log(`‚ö†Ô∏è ${message}`, 'warning');
                            }
                            originalConsoleWarn(...args);
                        };

                        log('üöÄ Iniciando an√°lise...', 'success');
                        
                        const result = await analyzeAudio(file, {
                            includeMetrics: ['spectralBands'],
                            jobId: 'SPECTRAL_DEBUG_TEST'
                        });
                        
                        // Restaurar console
                        console.log = originalConsoleLog;
                        console.error = originalConsoleError;
                        console.warn = originalConsoleWarn;
                        
                        log('‚úÖ AN√ÅLISE CONCLU√çDA! Verificando resultado...', 'success');
                        
                        // Verificar resultado das bandas espectrais
                        const spectralBands = result?.coreMetrics?.spectralBands;
                        
                        log(`üîç Resultado spectralBands:`, 'debug');
                        log(`<pre>${JSON.stringify(spectralBands, null, 2)}</pre>`, 'debug');
                        
                        if (spectralBands?.aggregated?.bands) {
                            const bands = spectralBands.aggregated.bands;
                            log(`üéØ BANDAS ENCONTRADAS:`, 'success');
                            
                            Object.entries(bands).forEach(([key, band]) => {
                                const status = band.percentage ? '‚úÖ CALCULADA' : '‚ùå NULL';
                                log(`  ${key}: ${band.percentage}% ${status}`, band.percentage ? 'success' : 'error');
                            });
                            
                            log(`üìä Total: ${spectralBands.aggregated.totalPercentage}%`, 'success');
                            log(`‚úÖ V√°lido: ${spectralBands.aggregated.valid}`, 'success');
                            log(`üî¢ Frames usados: ${spectralBands.aggregated.framesUsed}`, 'success');
                        } else {
                            log('‚ùå BANDAS N√ÉO ENCONTRADAS NO RESULTADO', 'error');
                        }
                        
                        // Verificar JSON final
                        const jsonBands = result?.technical?.frequency?.spectralBands;
                        if (jsonBands) {
                            log(`üîç JSON FINAL - Spectral Bands:`, 'debug');
                            log(`<pre>${JSON.stringify(jsonBands, null, 2)}</pre>`, 'debug');
                        }

                    } catch (error) {
                        log(`üí• ERRO NA AN√ÅLISE: ${error.message}`, 'error');
                        log(`Stack: ${error.stack}`, 'error');
                    }
                };
                
                fileInput.click();
                
            } catch (error) {
                log(`üí• ERRO NO TESTE: ${error.message}`, 'error');
            }
        };
    </script>
</body>
</html>