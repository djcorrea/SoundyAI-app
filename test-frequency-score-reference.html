<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste: Score de Frequ√™ncia (Modo Reference)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0f1a;
            color: #e0e6f0;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff88;
            border-bottom: 2px solid #00ff88;
            padding-bottom: 10px;
        }
        .test-section {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section h2 {
            margin-top: 0;
            color: #60a5fa;
        }
        .test-result {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
        }
        .pass {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            color: #00ff88;
        }
        .fail {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff4444;
        }
        .info {
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid #60a5fa;
            color: #60a5fa;
        }
        button {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            transform: scale(1.02);
        }
        .summary {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        .summary h3 {
            color: #fbbf24;
            margin-top: 0;
        }
        pre {
            background: #0d1117;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .badge-critica { background: #ff4444; color: white; }
        .badge-alta { background: #ff9800; color: white; }
        .badge-atencao { background: #ffc107; color: black; }
        .badge-ok { background: #00ff88; color: black; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste: Score de Frequ√™ncia Corrigido (Modo Reference)</h1>
        
        <div class="test-section">
            <h2>üìã Objetivo do Teste</h2>
            <p>Validar que o novo c√°lculo de <code>calculateFrequencyScoreReference</code> penaliza corretamente bandas fora do range, baseado nas <strong>severidades</strong> (CR√çTICA/ALTA/ATEN√á√ÉO/OK).</p>
            <ul>
                <li>‚úÖ Todas OK ‚Üí Score 100</li>
                <li>‚úÖ 2 CR√çTICAS, 2 ATEN√á√ÉO, 4 OK ‚Üí Score ~70-75</li>
                <li>‚úÖ Todas CR√çTICAS ‚Üí Score ~0-20</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>üî¨ Executar Testes</h2>
            <button onclick="runAllTests()">‚ñ∂Ô∏è Executar Todos os Testes</button>
            <button onclick="testCase1()">‚úÖ Caso 1: Todas OK</button>
            <button onclick="testCase2()">‚ö†Ô∏è Caso 2: Mix de severidades</button>
            <button onclick="testCase3()">üö® Caso 3: Todas CR√çTICAS</button>
            <button onclick="testCase4()">üìä Caso 4: Gradual</button>
        </div>

        <div id="results"></div>

        <div class="summary" id="summary" style="display:none;">
            <h3>üìä Resumo Final</h3>
            <div id="summaryContent"></div>
        </div>
    </div>

    <script>
        // Copiar a fun√ß√£o corrigida para teste
        function calculateFrequencyScoreReference(bandsA, bandsB) {
            console.log('[FREQ-SCORE-REF] üéµ Calculando score de frequ√™ncia em modo reference (A vs B) - VERS√ÉO CORRIGIDA');
            
            if (!bandsA || !bandsB) {
                console.warn('[FREQ-SCORE-REF] ‚ö†Ô∏è Bandas ausentes:', { hasA: !!bandsA, hasB: !!bandsB });
                return null;
            }
            
            const bandKeys = ['sub', 'bass', 'low_mid', 'lowMid', 'mid', 'high_mid', 'highMid', 'presence', 'air'];
            const aliases = {
                'low_mid': 'lowMid',
                'high_mid': 'highMid',
                'brilho': 'air',
                'presenca': 'presence'
            };
            
            const bandsData = [];
            const processedKeys = new Set();
            
            for (const key of bandKeys) {
                const canonicalKey = aliases[key] || key;
                if (processedKeys.has(canonicalKey)) continue;
                
                let valueA = null;
                if (bandsA[key] !== undefined) {
                    valueA = typeof bandsA[key] === 'object' ? 
                             (bandsA[key].energy_db ?? bandsA[key].rms_db ?? bandsA[key].value) : 
                             bandsA[key];
                }
                
                let valueB = null;
                if (bandsB[key] !== undefined) {
                    valueB = typeof bandsB[key] === 'object' ? 
                             (bandsB[key].energy_db ?? bandsB[key].rms_db ?? bandsB[key].value) : 
                             bandsB[key];
                }
                
                if (Number.isFinite(valueA) && Number.isFinite(valueB)) {
                    const absDelta = Math.abs(valueA - valueB);
                    
                    let severity = 'OK';
                    if (absDelta >= 4.0) {
                        severity = 'CR√çTICA';
                    } else if (absDelta >= 2.5) {
                        severity = 'ALTA';
                    } else if (absDelta >= 1.5) {
                        severity = 'ATEN√á√ÉO';
                    }
                    
                    bandsData.push({
                        key: canonicalKey,
                        valueA,
                        valueB,
                        delta: absDelta,
                        severity
                    });
                    
                    processedKeys.add(canonicalKey);
                }
            }
            
            if (bandsData.length === 0) {
                return null;
            }
            
            const baseScore = 100;
            const penaltyMap = {
                'CR√çTICA': 20,
                'ALTA': 10,
                'ATEN√á√ÉO': 5,
                'OK': 0
            };
            
            const severityCounts = {
                'CR√çTICA': 0,
                'ALTA': 0,
                'ATEN√á√ÉO': 0,
                'OK': 0
            };
            
            let totalPenalty = 0;
            
            for (const band of bandsData) {
                const penalty = penaltyMap[band.severity] || 0;
                totalPenalty += penalty;
                severityCounts[band.severity]++;
            }
            
            const maxPossiblePenalty = bandsData.length * 20;
            const normalizedPenalty = (totalPenalty / maxPossiblePenalty) * 100;
            const rawScore = baseScore - normalizedPenalty;
            const score = Math.max(0, Math.min(100, Math.round(rawScore)));
            
            return {
                score,
                bandsData,
                severityCounts,
                totalPenalty,
                maxPossiblePenalty,
                normalizedPenalty
            };
        }

        function addResult(container, pass, message, details = null) {
            const div = document.createElement('div');
            div.className = `test-result ${pass ? 'pass' : 'fail'}`;
            div.innerHTML = `${pass ? '‚úÖ' : '‚ùå'} ${message}`;
            if (details) {
                div.innerHTML += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            container.appendChild(div);
            return pass;
        }

        function addInfo(container, message, details = null) {
            const div = document.createElement('div');
            div.className = 'test-result info';
            div.innerHTML = `‚ÑπÔ∏è ${message}`;
            if (details) {
                div.innerHTML += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            container.appendChild(div);
        }

        let testResults = { passed: 0, failed: 0 };

        function testCase1() {
            const container = document.getElementById('results');
            container.innerHTML = '<h2>‚úÖ Caso 1: Todas OK (diferen√ßas < 1.5 dB)</h2>';

            const bandsA = {
                sub: { energy_db: -18.5 },
                bass: { energy_db: -12.3 },
                lowMid: { energy_db: -8.7 },
                mid: { energy_db: -5.2 },
                highMid: { energy_db: -6.8 },
                presence: { energy_db: -12.4 },
                air: { energy_db: -22.1 }
            };

            const bandsB = {
                sub: { energy_db: -18.0 },
                bass: { energy_db: -12.0 },
                lowMid: { energy_db: -8.5 },
                mid: { energy_db: -5.0 },
                highMid: { energy_db: -7.0 },
                presence: { energy_db: -12.0 },
                air: { energy_db: -22.0 }
            };

            const result = calculateFrequencyScoreReference(bandsA, bandsB);
            
            addInfo(container, `Score calculado: ${result.score}`, result.severityCounts);

            if (addResult(container, result.score === 100, `Score deve ser 100 (todas OK)`, { scoreReal: result.score })) testResults.passed++;
            else testResults.failed++;

            if (addResult(container, result.severityCounts.OK === 7, `Todas 7 bandas devem ser OK`, result.severityCounts)) testResults.passed++;
            else testResults.failed++;
        }

        function testCase2() {
            const container = document.getElementById('results');
            container.innerHTML = '<h2>‚ö†Ô∏è Caso 2: Mix de severidades</h2>';

            const bandsA = {
                sub: { energy_db: -18.5 },    // OK (diff 0.3)
                bass: { energy_db: -12.3 },   // CR√çTICA (diff 5.3)
                lowMid: { energy_db: -8.7 },  // CR√çTICA (diff 4.2)
                mid: { energy_db: -5.2 },     // ATEN√á√ÉO (diff 2.2)
                highMid: { energy_db: -6.8 }, // ATEN√á√ÉO (diff 2.0)
                presence: { energy_db: -12.4 },// OK (diff 0.4)
                air: { energy_db: -22.1 }     // OK (diff 1.1)
            };

            const bandsB = {
                sub: { energy_db: -18.2 },
                bass: { energy_db: -7.0 },
                lowMid: { energy_db: -4.5 },
                mid: { energy_db: -3.0 },
                highMid: { energy_db: -4.8 },
                presence: { energy_db: -12.0 },
                air: { energy_db: -21.0 }
            };

            const result = calculateFrequencyScoreReference(bandsA, bandsB);
            
            addInfo(container, `Score calculado: ${result.score}`, {
                severityCounts: result.severityCounts,
                totalPenalty: result.totalPenalty,
                maxPossiblePenalty: result.maxPossiblePenalty
            });

            const badges = document.createElement('div');
            badges.innerHTML = '<strong>Severidades detectadas:</strong><br>';
            for (const band of result.bandsData) {
                const badge = document.createElement('span');
                badge.className = `badge badge-${band.severity.toLowerCase()}`;
                badge.textContent = `${band.key}: ${band.severity} (Œî${band.delta.toFixed(1)}dB)`;
                badges.appendChild(badge);
            }
            container.appendChild(badges);

            // Score esperado: 2 CR√çTICAS (40 pontos) + 2 ATEN√á√ÉO (10 pontos) + 3 OK (0) = 50 de 140 m√°x = ~64%
            const expectedMin = 60;
            const expectedMax = 75;
            if (addResult(container, result.score >= expectedMin && result.score <= expectedMax, 
                         `Score deve estar entre ${expectedMin}-${expectedMax}% (mix de severidades)`, 
                         { scoreReal: result.score })) testResults.passed++;
            else testResults.failed++;

            if (addResult(container, result.severityCounts.CR√çTICA === 2, `Deve ter 2 CR√çTICAS`, result.severityCounts)) testResults.passed++;
            else testResults.failed++;
        }

        function testCase3() {
            const container = document.getElementById('results');
            container.innerHTML = '<h2>üö® Caso 3: Todas CR√çTICAS (diferen√ßas >= 4.0 dB)</h2>';

            const bandsA = {
                sub: { energy_db: -18.5 },
                bass: { energy_db: -12.3 },
                lowMid: { energy_db: -8.7 },
                mid: { energy_db: -5.2 },
                highMid: { energy_db: -6.8 },
                presence: { energy_db: -12.4 },
                air: { energy_db: -22.1 }
            };

            const bandsB = {
                sub: { energy_db: -12.0 },    // diff 6.5
                bass: { energy_db: -6.0 },    // diff 6.3
                lowMid: { energy_db: -3.0 },  // diff 5.7
                mid: { energy_db: -1.0 },     // diff 4.2
                highMid: { energy_db: -2.0 }, // diff 4.8
                presence: { energy_db: -7.0 },// diff 5.4
                air: { energy_db: -16.0 }     // diff 6.1
            };

            const result = calculateFrequencyScoreReference(bandsA, bandsB);
            
            addInfo(container, `Score calculado: ${result.score}`, result.severityCounts);

            // Score esperado: 7 CR√çTICAS (140 pontos) de 140 m√°x = 0%
            if (addResult(container, result.score <= 10, `Score deve ser pr√≥ximo de 0% (todas CR√çTICAS)`, { scoreReal: result.score })) testResults.passed++;
            else testResults.failed++;

            if (addResult(container, result.severityCounts.CR√çTICA === 7, `Todas 7 bandas devem ser CR√çTICAS`, result.severityCounts)) testResults.passed++;
            else testResults.failed++;
        }

        function testCase4() {
            const container = document.getElementById('results');
            container.innerHTML = '<h2>üìä Caso 4: Distribui√ß√£o Gradual</h2>';

            const bandsA = {
                sub: { energy_db: -18.5 },    // CR√çTICA (diff 5.5)
                bass: { energy_db: -12.3 },   // ALTA (diff 3.3)
                lowMid: { energy_db: -8.7 },  // ATEN√á√ÉO (diff 2.2)
                mid: { energy_db: -5.2 },     // ATEN√á√ÉO (diff 1.7)
                highMid: { energy_db: -6.8 }, // OK (diff 0.8)
                presence: { energy_db: -12.4 },// OK (diff 0.4)
                air: { energy_db: -22.1 }     // OK (diff 0.1)
            };

            const bandsB = {
                sub: { energy_db: -13.0 },
                bass: { energy_db: -9.0 },
                lowMid: { energy_db: -6.5 },
                mid: { energy_db: -3.5 },
                highMid: { energy_db: -6.0 },
                presence: { energy_db: -12.0 },
                air: { energy_db: -22.0 }
            };

            const result = calculateFrequencyScoreReference(bandsA, bandsB);
            
            addInfo(container, `Score calculado: ${result.score}`, {
                severityCounts: result.severityCounts,
                totalPenalty: result.totalPenalty,
                maxPossiblePenalty: result.maxPossiblePenalty
            });

            const badges = document.createElement('div');
            badges.innerHTML = '<strong>Distribui√ß√£o:</strong><br>';
            for (const [sev, count] of Object.entries(result.severityCounts)) {
                if (count > 0) {
                    const badge = document.createElement('span');
                    badge.className = `badge badge-${sev.toLowerCase()}`;
                    badge.textContent = `${sev}: ${count}x`;
                    badges.appendChild(badge);
                }
            }
            container.appendChild(badges);

            // Score esperado: 1 CR√çTICA (20) + 1 ALTA (10) + 2 ATEN√á√ÉO (10) + 3 OK (0) = 40 de 140 m√°x = ~71%
            const expectedMin = 65;
            const expectedMax = 80;
            if (addResult(container, result.score >= expectedMin && result.score <= expectedMax, 
                         `Score deve estar entre ${expectedMin}-${expectedMax}% (distribui√ß√£o gradual)`, 
                         { scoreReal: result.score })) testResults.passed++;
            else testResults.failed++;
        }

        function runAllTests() {
            testResults = { passed: 0, failed: 0 };
            
            testCase1();
            const divider1 = document.createElement('hr');
            document.getElementById('results').appendChild(divider1);
            
            testCase2();
            const divider2 = document.createElement('hr');
            document.getElementById('results').appendChild(divider2);
            
            testCase3();
            const divider3 = document.createElement('hr');
            document.getElementById('results').appendChild(divider3);
            
            testCase4();

            const summary = document.getElementById('summary');
            const summaryContent = document.getElementById('summaryContent');
            summary.style.display = 'block';
            
            const total = testResults.passed + testResults.failed;
            const passRate = ((testResults.passed / total) * 100).toFixed(1);
            
            summaryContent.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 15px;">
                    ${passRate >= 100 ? 'üéâ' : passRate >= 80 ? '‚úÖ' : '‚ö†Ô∏è'} ${passRate}% de sucesso
                </div>
                <div style="display: flex; gap: 20px;">
                    <div class="test-result pass" style="flex:1; text-align:center;">
                        <strong>${testResults.passed}</strong> passou
                    </div>
                    <div class="test-result fail" style="flex:1; text-align:center;">
                        <strong>${testResults.failed}</strong> falhou
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #0d1117; border-radius: 8px;">
                    <strong>Conclus√£o:</strong><br>
                    ${passRate >= 100 
                        ? '‚úÖ Todos os testes passaram! O c√°lculo de score est√° correto.' 
                        : passRate >= 80
                            ? '‚ö†Ô∏è A maioria dos testes passou, mas alguns ajustes podem ser necess√°rios.'
                            : '‚ùå H√° problemas significativos que precisam ser corrigidos.'
                    }
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ P√°gina de teste carregada');
        });
    </script>
</body>
</html>
