<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>üîç Interceptador JSON - Captura em Tempo Real</title>
    <style>
        body { font-family: monospace; background: #0a0a0a; color: #fff; padding: 20px; line-height: 1.4; }
        .container { max-width: 1800px; margin: 0 auto; }
        .section { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .log { background: #222; padding: 10px; margin: 8px 0; border-radius: 4px; border-left: 4px solid #666; font-size: 12px; }
        .critical { border-left-color: #e91e63; background: #4a148c; }
        .success { border-left-color: #4caf50; background: #1b5e20; }
        .error { border-left-color: #f44336; background: #5d1a1d; }
        .warning { border-left-color: #ff9800; background: #5d4037; }
        .info { border-left-color: #2196f3; background: #1a237e; }
        button { background: #4a90e2; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin: 8px; font-family: monospace; }
        button:hover { background: #357abd; }
        .danger { background: #f44336; }
        .danger:hover { background: #d32f2f; }
        pre { background: #000; color: #0f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 11px; border: 1px solid #333; max-height: 300px; overflow-y: auto; }
        .highlight { background: #ff9800; color: #000; padding: 2px 4px; border-radius: 3px; }
        .counter { display: inline-block; background: #333; padding: 4px 8px; border-radius: 4px; margin: 0 8px; }
        .live-data { background: #0d1421; border: 2px solid #1976d2; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .data-flow { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .flow-column { background: #1a1a1a; border: 1px solid #444; border-radius: 6px; padding: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Interceptador JSON - Captura em Tempo Real</h1>
        <p>Monitora exatamente onde as sugest√µes s√£o geradas, processadas e exibidas</p>
        
        <div class="section">
            <h2>üéØ Controles de Intercepta√ß√£o</h2>
            <button onclick="iniciarInterceptacao()">üöÄ Iniciar Intercepta√ß√£o</button>
            <button onclick="pararInterceptacao()">‚èπÔ∏è Parar Intercepta√ß√£o</button>
            <button onclick="forcarAnalise()">üß™ For√ßar An√°lise Teste</button>
            <button onclick="simulateRailwayBehavior()">üöÇ Simular Railway</button>
            <button onclick="limparLogs()" class="danger">üßπ Limpar</button>
            
            <div>
                <span class="counter">Intercepta√ß√µes: <span id="intercept-count">0</span></span>
                <span class="counter">An√°lises: <span id="analysis-count">0</span></span>
                <span class="counter">Sugest√µes: <span id="suggestions-count">0</span></span>
                <span class="counter">Erros: <span id="error-count">0</span></span>
            </div>
        </div>

        <div class="section">
            <h2>üìä Fluxo de Dados em Tempo Real</h2>
            <div class="data-flow">
                <div class="flow-column">
                    <h3>‚¨áÔ∏è Entrada (Input)</h3>
                    <div id="input-data" class="live-data">Aguardando dados...</div>
                </div>
                <div class="flow-column">
                    <h3>‚¨ÜÔ∏è Sa√≠da (Output)</h3>
                    <div id="output-data" class="live-data">Aguardando resultados...</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üïµÔ∏è Rastro de Execu√ß√£o</h2>
            <div id="execution-trail">Rastro aparecer√° aqui...</div>
        </div>

        <div class="section">
            <h2>üìã Logs Detalhados</h2>
            <div id="logs">Logs aparecer√£o aqui...</div>
        </div>
    </div>

    <!-- Carregar scripts necess√°rios -->
    <script src="suggestion-scorer.js"></script>
    <script src="enhanced-suggestion-engine.js"></script>
    <script src="suggestion-system-emergency.js"></script>
    <script src="timing-analyzer.js"></script>

    <script>
        let interceptActive = false;
        let interceptCount = 0;
        let analysisCount = 0;
        let suggestionsCount = 0;
        let errorCount = 0;
        let executionTrail = [];
        
        // Contadores
        function updateCounters() {
            document.getElementById('intercept-count').textContent = interceptCount;
            document.getElementById('analysis-count').textContent = analysisCount;
            document.getElementById('suggestions-count').textContent = suggestionsCount;
            document.getElementById('error-count').textContent = errorCount;
        }

        function log(level, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log ${level}`;
            
            const dataDisplay = data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : '';
            entry.innerHTML = `
                <strong>[${timestamp}] ${message}</strong>
                ${dataDisplay}
            `;
            
            logDiv.appendChild(entry);
            console.log(`[${level.toUpperCase()}] ${message}`, data || '');
            entry.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function addToTrail(step, details = null) {
            const timestamp = Date.now();
            executionTrail.push({ step, details, timestamp });
            
            const trailDiv = document.getElementById('execution-trail');
            const entry = document.createElement('div');
            entry.className = 'log info';
            entry.innerHTML = `
                <strong>üîó ${step}</strong>
                ${details ? `<pre>${JSON.stringify(details, null, 2)}</pre>` : ''}
            `;
            trailDiv.appendChild(entry);
        }

        function updateLiveData(inputData, outputData) {
            const inputDiv = document.getElementById('input-data');
            const outputDiv = document.getElementById('output-data');
            
            if (inputData) {
                inputDiv.innerHTML = `<pre>${JSON.stringify(inputData, null, 2)}</pre>`;
            }
            
            if (outputData) {
                outputDiv.innerHTML = `<pre>${JSON.stringify(outputData, null, 2)}</pre>`;
            }
        }

        function interceptSuggestionSystem() {
            if (!window.suggestionSystem || !window.suggestionSystem.process) {
                log('error', '‚ùå window.suggestionSystem.process n√£o encontrado');
                return false;
            }

            const originalProcess = window.suggestionSystem.process.bind(window.suggestionSystem);
            
            window.suggestionSystem.process = function(analysis, referenceData) {
                if (!interceptActive) return originalProcess(analysis, referenceData);
                
                interceptCount++;
                const callId = `call_${Date.now()}_${interceptCount}`;
                
                log('critical', `üö® INTERCEPTADO #${interceptCount} - ${callId}`, {
                    hasAnalysis: !!analysis,
                    hasReferenceData: !!referenceData,
                    analysisKeys: analysis ? Object.keys(analysis) : null,
                    technicalDataKeys: analysis?.technicalData ? Object.keys(analysis.technicalData) : null,
                    referenceGenre: referenceData?.genre
                });
                
                addToTrail(`Intercepta√ß√£o #${interceptCount}`, {
                    callId,
                    inputAnalysis: {
                        lufs: analysis?.technicalData?.lufs || analysis?.technicalData?.lufsIntegrated,
                        truePeak: analysis?.technicalData?.true_peak || analysis?.technicalData?.truePeakDbtp,
                        dr: analysis?.technicalData?.dr || analysis?.technicalData?.dynamicRange,
                        bands: analysis?.technicalData?.frequencyAnalysis
                    },
                    inputReference: {
                        genre: referenceData?.genre,
                        lufsTarget: referenceData?.lufs_target,
                        truePeakTarget: referenceData?.true_peak_target
                    }
                });
                
                // Atualizar dados ao vivo - Input
                updateLiveData({
                    timestamp: new Date().toISOString(),
                    callId,
                    analysis: {
                        metadata: analysis?.metadata,
                        technicalData: analysis?.technicalData
                    },
                    reference: referenceData
                }, null);
                
                try {
                    const startTime = performance.now();
                    const result = originalProcess(analysis, referenceData);
                    const endTime = performance.now();
                    
                    analysisCount++;
                    const suggestionsGenerated = result?.suggestions?.length || 0;
                    suggestionsCount += suggestionsGenerated;
                    
                    log('success', `‚úÖ RESULTADO #${interceptCount} - ${callId}`, {
                        processingTimeMs: (endTime - startTime).toFixed(2),
                        suggestionsGenerated,
                        hasAuditLog: !!result?.auditLog,
                        hasEnhancedMetrics: !!result?.enhancedMetrics,
                        suggestionTypes: (result?.suggestions || []).map(s => s.category || s.type)
                    });
                    
                    addToTrail(`Resultado #${interceptCount}`, {
                        callId,
                        processingTime: `${(endTime - startTime).toFixed(2)}ms`,
                        suggestionsCount: suggestionsGenerated,
                        firstSuggestion: result?.suggestions?.[0] || null
                    });
                    
                    // Atualizar dados ao vivo - Output
                    updateLiveData(null, {
                        timestamp: new Date().toISOString(),
                        callId,
                        processingTime: `${(endTime - startTime).toFixed(2)}ms`,
                        suggestions: result?.suggestions || [],
                        auditLog: result?.auditLog || [],
                        enhancedMetrics: result?.enhancedMetrics || null
                    });
                    
                    updateCounters();
                    
                    return result;
                    
                } catch (error) {
                    errorCount++;
                    log('error', `‚ùå ERRO #${interceptCount} - ${callId}: ${error.message}`, {
                        stack: error.stack,
                        input: { analysis, referenceData }
                    });
                    
                    addToTrail(`Erro #${interceptCount}`, {
                        callId,
                        error: error.message
                    });
                    
                    updateCounters();
                    throw error;
                }
            };
            
            return true;
        }

        function interceptUpdateReferenceSuggestions() {
            if (typeof window.updateReferenceSuggestions !== 'function') {
                log('warning', '‚ö†Ô∏è updateReferenceSuggestions n√£o encontrada');
                return false;
            }

            const original = window.updateReferenceSuggestions.bind(window);
            
            window.updateReferenceSuggestions = function(analysis) {
                if (!interceptActive) return original(analysis);
                
                log('info', 'üîÑ updateReferenceSuggestions chamada', {
                    hasAnalysis: !!analysis,
                    hasTechnicalData: !!analysis?.technicalData,
                    beforeSuggestionsCount: analysis?.suggestions?.length || 0
                });
                
                addToTrail('updateReferenceSuggestions chamada', {
                    beforeSuggestions: analysis?.suggestions?.length || 0
                });
                
                try {
                    const result = original(analysis);
                    
                    log('success', '‚úÖ updateReferenceSuggestions conclu√≠da', {
                        afterSuggestionsCount: analysis?.suggestions?.length || 0,
                        result
                    });
                    
                    addToTrail('updateReferenceSuggestions conclu√≠da', {
                        afterSuggestions: analysis?.suggestions?.length || 0
                    });
                    
                    return result;
                    
                } catch (error) {
                    errorCount++;
                    log('error', `‚ùå Erro em updateReferenceSuggestions: ${error.message}`);
                    addToTrail('updateReferenceSuggestions erro', { error: error.message });
                    updateCounters();
                    throw error;
                }
            };
            
            return true;
        }

        function iniciarInterceptacao() {
            interceptActive = true;
            interceptCount = 0;
            analysisCount = 0;
            suggestionsCount = 0;
            errorCount = 0;
            executionTrail = [];
            
            log('info', 'üöÄ Iniciando intercepta√ß√£o...');
            
            const systemIntercepted = interceptSuggestionSystem();
            const updateIntercepted = interceptUpdateReferenceSuggestions();
            
            if (systemIntercepted) {
                log('success', '‚úÖ suggestionSystem.process interceptado');
            }
            
            if (updateIntercepted) {
                log('success', '‚úÖ updateReferenceSuggestions interceptado');
            }
            
            if (!systemIntercepted && !updateIntercepted) {
                log('error', '‚ùå Nenhuma fun√ß√£o foi interceptada');
                interceptActive = false;
            } else {
                log('success', 'üéØ Intercepta√ß√£o ativa - aguardando chamadas...');
            }
            
            updateCounters();
        }

        function pararInterceptacao() {
            interceptActive = false;
            log('info', '‚èπÔ∏è Intercepta√ß√£o parada');
            
            const summary = {
                totalInterceptions: interceptCount,
                totalAnalyses: analysisCount,
                totalSuggestions: suggestionsCount,
                totalErrors: errorCount,
                averageSuggestionsPerAnalysis: analysisCount > 0 ? (suggestionsCount / analysisCount).toFixed(2) : 0
            };
            
            log('info', 'üìä Resumo da sess√£o:', summary);
        }

        function forcarAnalise() {
            log('info', 'üß™ For√ßando an√°lise de teste...');
            
            const testAnalysis = {
                metadata: {
                    filename: "teste_interceptacao.wav",
                    duration: 180,
                    sampleRate: 48000,
                    channels: 2
                },
                technicalData: {
                    lufs: -12.8,
                    lufsIntegrated: -12.8,
                    true_peak: -0.9,
                    truePeakDbtp: -0.9,
                    dr: 7.2,
                    dynamicRange: 7.2,
                    lra: 5.1,
                    stereo: 0.85,
                    stereoWidth: 0.85,
                    frequencyAnalysis: {
                        subbass: 0.68,
                        bass: 0.82,
                        lowMid: 0.79,
                        mid: 0.91,
                        highMid: 0.73,
                        presenca: 0.67,
                        brilho: 0.76
                    }
                }
            };

            const testReference = {
                genre: "Funk Mandela",
                lufs_target: -14.0,
                lufs_tolerance: 1.0,
                true_peak_target: -1.0,
                true_peak_tolerance: 0.5,
                dr_target: 8.0,
                dr_tolerance: 2.0
            };

            if (window.suggestionSystem) {
                try {
                    const result = window.suggestionSystem.process(testAnalysis, testReference);
                    log('success', `‚úÖ An√°lise for√ßada conclu√≠da: ${result?.suggestions?.length || 0} sugest√µes`);
                } catch (error) {
                    log('error', `‚ùå Erro na an√°lise for√ßada: ${error.message}`);
                }
            } else {
                log('error', '‚ùå window.suggestionSystem n√£o dispon√≠vel');
            }
        }

        function simulateRailwayBehavior() {
            log('info', 'üöÇ Simulando comportamento espec√≠fico da Railway...');
            
            // Simular o problema: primeira chamada vazia, segunda com sugest√µes
            setTimeout(() => {
                log('info', '1Ô∏è‚É£ Primeira tentativa (Railway - problema)...');
                forcarAnalise();
                
                setTimeout(() => {
                    log('info', '2Ô∏è‚É£ Segunda tentativa (Railway - funciona)...');
                    forcarAnalise();
                }, 2000);
            }, 1000);
        }

        function limparLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('execution-trail').innerHTML = 'Rastro aparecer√° aqui...';
            document.getElementById('input-data').innerHTML = 'Aguardando dados...';
            document.getElementById('output-data').innerHTML = 'Aguardando resultados...';
            executionTrail = [];
        }

        // Auto-setup quando carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('info', 'üåê Interceptador carregado e pronto');
                
                if (typeof window.suggestionSystem !== 'undefined') {
                    log('success', '‚úÖ Sistema detectado - pronto para interceptar');
                } else {
                    log('warning', '‚ö†Ô∏è Sistema n√£o detectado - aguardando...');
                }
                
                updateCounters();
            }, 1000);
        });

        // Expor fun√ß√µes globalmente para debug manual
        window.interceptorDebug = {
            iniciar: iniciarInterceptacao,
            parar: pararInterceptacao,
            forcar: forcarAnalise,
            railway: simulateRailwayBehavior,
            getTrail: () => executionTrail,
            getStats: () => ({
                intercepts: interceptCount,
                analyses: analysisCount,
                suggestions: suggestionsCount,
                errors: errorCount
            })
        };
    </script>
</body>
</html>