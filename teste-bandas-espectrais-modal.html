<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste das Bandas Espectrais - Modal</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .data-row:last-child {
            border-bottom: none;
        }
        .label {
            font-weight: 500;
            color: #333;
        }
        .value {
            color: #666;
            font-family: 'SF Mono', Monaco, monospace;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f1aeb5; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Teste das Bandas Espectrais - Modal Din√¢mico</h1>
        
        <div class="test-section">
            <h3>üìä Dados de Teste Simulados</h3>
            <p>Testando a renderiza√ß√£o din√¢mica das bandas espectrais no modal com dados simulados:</p>
            
            <button class="btn" onclick="testNewFormat()">üÜï Testar Novo Formato (energy_db + percentage)</button>
            <button class="btn" onclick="testLegacyFormat()">üîÑ Testar Formato Legado (apenas dB)</button>
            <button class="btn" onclick="testMixedFormat()">üîÄ Testar Formato Misto</button>
            <button class="btn" onclick="testEmptyBands()">‚ùå Testar Bandas Vazias</button>
        </div>
        
        <div id="results" class="test-section" style="display: none;">
            <h3>üìã Resultado da Renderiza√ß√£o</h3>
            <div id="output"></div>
        </div>
        
        <div id="status"></div>
    </div>

    <script>
        // Simular as fun√ß√µes necess√°rias do modal
        const safeFixed = (v, d=1) => (Number.isFinite(v) ? v.toFixed(d) : '‚Äî');
        
        const row = (label, valHtml, keyForSource=null) => {
            return `
                <div class="data-row">
                    <span class="label">${label}</span>
                    <span class="value">${valHtml}</span>
                </div>`;
        };

        // Fun√ß√£o para renderizar bandas espectrais (c√≥pia da l√≥gica implementada)
        function renderSpectralBands(analysis) {
            const spectralBands = analysis.technicalData?.spectral_balance || 
                                analysis.technicalData?.spectralBands || 
                                analysis.metrics?.bands || {};
            
            if (Object.keys(spectralBands).length === 0) {
                return row('Status', 'Nenhuma banda espectral encontrada');
            }
            
            const bandMap = {
                sub: { name: 'Sub (20-60Hz)', range: '20-60Hz' },
                bass: { name: 'Bass (60-150Hz)', range: '60-150Hz' },
                lowMid: { name: 'Low-Mid (150-500Hz)', range: '150-500Hz' },
                mid: { name: 'Mid (500-2kHz)', range: '500-2000Hz' },
                highMid: { name: 'High-Mid (2-5kHz)', range: '2000-5000Hz' },
                presence: { name: 'Presence (5-10kHz)', range: '5000-10000Hz' },
                air: { name: 'Air (10-20kHz)', range: '10000-20000Hz' }
            };
            
            const rows = [];
            
            // Percorrer dinamicamente todas as bandas dispon√≠veis
            Object.keys(bandMap).forEach(bandKey => {
                const bandData = spectralBands[bandKey];
                if (bandData && typeof bandData === 'object') {
                    // Verificar se tem energy_db e percentage (novo formato)
                    const energyDb = bandData.energy_db;
                    const percentage = bandData.percentage;
                    const status = bandData.status;
                    
                    if (status && status !== 'not_calculated') {
                        let displayValue = '';
                        
                        if (Number.isFinite(energyDb) && Number.isFinite(percentage)) {
                            displayValue = `${safeFixed(energyDb, 1)} dB (${safeFixed(percentage, 1)}%)`;
                        } else if (Number.isFinite(energyDb)) {
                            displayValue = `${safeFixed(energyDb, 1)} dB`;
                        } else if (Number.isFinite(percentage)) {
                            displayValue = `${safeFixed(percentage, 1)}%`;
                        } else {
                            displayValue = 'n√£o calculado';
                        }
                        
                        rows.push(row(bandMap[bandKey].name, displayValue));
                    } else {
                        rows.push(row(bandMap[bandKey].name, 'n√£o calculado'));
                    }
                } else if (Number.isFinite(bandData)) {
                    // Formato legado (apenas valor num√©rico)
                    rows.push(row(bandMap[bandKey].name, `${safeFixed(bandData, 1)} dB`));
                } else {
                    rows.push(row(bandMap[bandKey].name, 'n√£o calculado'));
                }
            });
            
            // Se n√£o encontrou nenhuma banda nas chaves esperadas, tentar buscar qualquer banda dispon√≠vel
            if (rows.filter(r => !r.includes('n√£o calculado')).length === 0) {
                Object.keys(spectralBands).forEach(bandKey => {
                    if (bandKey === '_status' || bandKey === 'totalPercentage') return;
                    
                    const bandData = spectralBands[bandKey];
                    if (bandData && typeof bandData === 'object') {
                        const energyDb = bandData.energy_db;
                        const percentage = bandData.percentage;
                        const range = bandData.range || bandData.frequencyRange || 'N/A';
                        const status = bandData.status;
                        
                        if (status && status !== 'not_calculated') {
                            let displayValue = '';
                            if (Number.isFinite(energyDb) && Number.isFinite(percentage)) {
                                displayValue = `${safeFixed(energyDb, 1)} dB (${safeFixed(percentage, 1)}%)`;
                            } else if (Number.isFinite(energyDb)) {
                                displayValue = `${safeFixed(energyDb, 1)} dB`;
                            } else if (Number.isFinite(percentage)) {
                                displayValue = `${safeFixed(percentage, 1)}%`;
                            } else {
                                displayValue = 'n√£o calculado';
                            }
                            
                            const displayName = `${bandKey.charAt(0).toUpperCase() + bandKey.slice(1)} (${range})`;
                            rows.push(row(displayName, displayValue));
                        }
                    } else if (Number.isFinite(bandData)) {
                        const displayName = `${bandKey.charAt(0).toUpperCase() + bandKey.slice(1)}`;
                        rows.push(row(displayName, `${safeFixed(bandData, 1)} dB`));
                    }
                });
            }
            
            return rows.join('');
        }

        // Fun√ß√µes de teste
        function testNewFormat() {
            const analysis = {
                technicalData: {
                    spectral_balance: {
                        sub: { energy_db: -5.2, percentage: 8.5, range: '20-60Hz', status: 'calculated' },
                        bass: { energy_db: 7.8, percentage: 25.6, range: '60-150Hz', status: 'calculated' },
                        lowMid: { energy_db: 2.1, percentage: 18.3, range: '150-500Hz', status: 'calculated' },
                        mid: { energy_db: 5.6, percentage: 22.8, range: '500-2000Hz', status: 'calculated' },
                        highMid: { energy_db: -3.2, percentage: 12.1, range: '2000-5000Hz', status: 'calculated' },
                        presence: { energy_db: -8.7, percentage: 8.9, range: '5000-10000Hz', status: 'calculated' },
                        air: { energy_db: -12.3, percentage: 3.8, range: '10000-20000Hz', status: 'calculated' },
                        totalPercentage: 100.0
                    }
                }
            };
            
            showResults('üÜï Novo Formato (energy_db + percentage)', analysis);
        }

        function testLegacyFormat() {
            const analysis = {
                technicalData: {
                    spectralBands: {
                        sub: -15.2,
                        bass: -8.9,
                        lowMid: -12.1,
                        mid: -6.8,
                        highMid: -18.3,
                        presence: -22.7,
                        air: -28.1
                    }
                }
            };
            
            showResults('üîÑ Formato Legado (apenas dB)', analysis);
        }

        function testMixedFormat() {
            const analysis = {
                metrics: {
                    bands: {
                        sub: { energy_db: -7.2, percentage: 15.2, status: 'calculated' },
                        bass: -10.5, // Legado
                        lowMid: { energy_db: null, percentage: 18.7, status: 'calculated' },
                        mid: { energy_db: 2.3, percentage: null, status: 'calculated' },
                        highMid: { energy_db: -5.1, percentage: 12.8, status: 'not_calculated' },
                        presence: { energy_db: -15.6, percentage: 7.2, status: 'calculated' },
                        air: -25.3 // Legado
                    }
                }
            };
            
            showResults('üîÄ Formato Misto', analysis);
        }

        function testEmptyBands() {
            const analysis = {
                technicalData: {
                    spectral_balance: {}
                }
            };
            
            showResults('‚ùå Bandas Vazias', analysis);
        }

        function showResults(testName, analysis) {
            const output = renderSpectralBands(analysis);
            const resultsDiv = document.getElementById('results');
            const outputDiv = document.getElementById('output');
            const statusDiv = document.getElementById('status');
            
            resultsDiv.style.display = 'block';
            outputDiv.innerHTML = output;
            
            // Contar quantas bandas foram renderizadas
            const renderedBands = (output.match(/data-row/g) || []).length;
            const hasValidData = !output.includes('Nenhuma banda espectral') && !output.includes('n√£o calculado');
            
            statusDiv.innerHTML = `
                <div class="status ${hasValidData ? 'success' : 'warning'}">
                    <strong>Teste: ${testName}</strong><br>
                    üìä Bandas renderizadas: ${renderedBands}<br>
                    ‚úÖ Dados v√°lidos: ${hasValidData ? 'Sim' : 'N√£o'}
                </div>
            `;
            
            console.log('üéµ Teste realizado:', testName);
            console.log('üìä Dados de entrada:', analysis);
            console.log('üìã HTML gerado:', output);
        }

        // Teste inicial
        window.onload = function() {
            document.getElementById('status').innerHTML = `
                <div class="status success">
                    ‚úÖ Sistema de teste carregado! Clique nos bot√µes acima para testar diferentes formatos de dados.
                </div>
            `;
        };
    </script>
</body>
</html>