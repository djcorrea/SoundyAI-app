# üîç AUDITORIA COMPLETA: Integra√ß√£o Granular V1 com Sistema Legacy

**Data**: 16 de outubro de 2025  
**Objetivo**: Mapear todos os pontos cr√≠ticos de integra√ß√£o entre granular_v1 e sistema legacy para garantir compatibilidade total com frontend e scoring.

---

## üìã ETAPA 1: INVENT√ÅRIO DE ARQUIVOS

### Arquivos Core do Sistema Espectral

#### 1. **work/lib/audio/features/spectral-bands-granular.js** (550 linhas)
- **Fun√ß√£o principal**: `analyzeGranularSpectralBands(framesFFT, reference)`
- **Retorna**:
  ```javascript
  {
    algorithm: 'granular_v1',
    groups: { sub, bass, low_mid, mid, high_mid, presence, air },
    granular: [13 sub-bandas],
    suggestions: [array de sugest√µes],
    // metadata...
  }
  ```
- **Fun√ß√µes auxiliares**:
  - `aggregateSubBandsIntoGroups()` ‚Üí Linhas 265-305
  - `buildSuggestions()` ‚Üí Linhas 310-390
- **Status**: ‚úÖ Implementado, testado, sintaxe validada

#### 2. **work/lib/audio/features/spectral-bands.js** (429 linhas)
- **Classe**: `SpectralBandsCalculator` ‚Üí Linhas 30-287
- **Classe**: `SpectralBandsAggregator` ‚Üí Linhas 313-418
- **Fun√ß√£o principal**: `analyzeBands(leftMag, rightMag, frameIndex)`
- **Retorna**:
  ```javascript
  {
    bands: {
      sub: { energy_db, percentage, frequencyRange, name, status },
      bass: { ... },
      // ... 7 bandas
    },
    totalPercentage: 100.0,
    algorithm: 'RMS_7_Band_Normalized',
    valid: true
  }
  ```
- **M√©todo agrega√ß√£o**: `SpectralBandsAggregator.aggregate(bandsArray)` ‚Üí Linha 318
  - Usa **mediana** de m√∫ltiplos frames
  - Retorna estrutura com `.bands.{bandName}`

#### 3. **work/api/audio/core-metrics.js** (2049 linhas)
- **Fun√ß√£o chave**: `calculateSpectralBandsMetrics(framesFFT, options)` ‚Üí Linha 848
- **Roteador condicional** (linha ~854):
  ```javascript
  const engine = process.env.ANALYZER_ENGINE || 'legacy';
  if (engine === 'granular_v1') {
    return await this.calculateGranularSubBands(framesFFT, options);
  }
  // Legacy path...
  ```
- **Nova fun√ß√£o**: `calculateGranularSubBands(framesFFT, options)` ‚Üí Linha 1920
  - Converte estrutura de frames
  - Importa dinamicamente m√≥dulo granular
  - Retorna resultado completo
- **Legacy preservado**: 100% do c√≥digo original mantido

#### 4. **work/api/audio/json-output.js** (1086 linhas)
- **Fun√ß√£o chave**: `extractTechnicalData(coreMetrics, reference)` ‚Üí Linha 158
- **Extra√ß√£o de bandas** (linhas 192-268):
  - Condi√ß√£o: `if (coreMetrics.spectralBands?.bands)`
  - Acessa: `b.bands.sub.energy_db`, `b.bands.sub.percentage`
  - Estrutura final: `technicalData.spectral_balance`
- **Campos aditivos granular** (linhas 781-803):
  ```javascript
  ...(coreMetrics.spectralBands?.algorithm === 'granular_v1' && {
    engineVersion: coreMetrics.spectralBands.algorithm,
    granular: coreMetrics.spectralBands.granular || [],
    suggestions: coreMetrics.spectralBands.suggestions || [],
    granularMetadata: { /* stats */ }
  })
  ```
- **‚ö†Ô∏è PONTO CR√çTICO**: Linha 350 - `hasBands: !!(coreMetrics.spectralBands?.bands)`

#### 5. **work/lib/audio/features/scoring.js** (1229 linhas)
- **Fun√ß√£o principal**: `computeMixScore(technicalData, reference)` ‚Üí Linha ~380
- **Uso de bandas** (linhas 540-590):
  ```javascript
  if (reference?.spectral_bands) {
    for (const [band, refBand] of Object.entries(reference.spectral_bands)) {
      const val = metrics.spectral_balance?.[band]?.energy_db;
      
      // Sistema de ranges (NOVO)
      if (refBand.target_range) {
        addMetric('tonal', `band_${band}`, val, target, tol, { 
          target_range: refBand.target_range 
        });
      }
      // Sistema fixo (LEGADO)
      else if (refBand.target_db) {
        addMetric('tonal', `band_${band}`, val, refBand.target_db, tol);
      }
    }
  }
  ```
- **Fun√ß√£o auxiliar**: `scoreToleranceRange(value, targetRange, fallback, tol)` ‚Üí Linha 149
- **Sistema de pesos**: Linha 665 - `band_high_mid: 0.14`, `band_low_bass: 0.08`, etc.

---

## üìä ETAPA 2: MAPEAMENTO DE S√çMBOLOS E OCORR√äNCIAS

### `spectralBands` - Objeto principal

| Arquivo | Linha | Contexto | Papel |
|---------|-------|----------|-------|
| core-metrics.js | 262 | `spectralBands: spectralBandsResults` | Atribui√ß√£o no resultado |
| core-metrics.js | 848 | `calculateSpectralBandsMetrics()` | Fun√ß√£o de c√°lculo |
| json-output.js | 192 | `if (coreMetrics.spectralBands?.bands)` | Condi√ß√£o de acesso |
| json-output.js | 348 | `hasSpectralBands: !!coreMetrics.spectralBands` | Debug |
| json-output.js | 781 | `coreMetrics.spectralBands?.algorithm === 'granular_v1'` | Condi√ß√£o aditiva |

### `.bands` - Estrutura de 7 bandas

| Arquivo | Linha | Express√£o | Resultado Esperado |
|---------|-------|-----------|-------------------|
| spectral-bands.js | 146 | `return { bands: bandsData, ... }` | Objeto com 7 chaves |
| spectral-bands-granular.js | 237 | `groups: groups` | ‚ö†Ô∏è **N√ÉO TEM `.bands`** |
| core-metrics.js | 929 | `bandsKeys: result.bands ? Object.keys(result.bands)` | Debug |
| json-output.js | 192 | `if (coreMetrics.spectralBands?.bands)` | ‚úÖ Legacy funciona |
| json-output.js | 209 | `if (b.bands && typeof b.bands === 'object')` | Acesso √†s bandas |
| json-output.js | 213 | `b.bands.sub?.energy_db` | Extra√ß√£o de valores |

### `.groups` - **PROBLEMA IDENTIFICADO**

| Arquivo | Linha | Express√£o | Valor |
|---------|-------|-----------|-------|
| spectral-bands-granular.js | 237 | `groups: groups` | `{ sub: {status, score}, bass: {...}, ... }` |
| spectral-bands-granular.js | 295 | `groups[groupName] = { status, score, ... }` | Estrutura diferente |
| core-metrics.js | 1995 | `groupsCount: Object.keys(granularResult.groups).length` | Debug (7) |

### `computeMixScore` - Fun√ß√£o de scoring

| Arquivo | Linha | Contexto |
|---------|-------|----------|
| json-output.js | 50 | `const scoringResult = computeMixScore(technicalData, reference)` | Chamada |
| scoring.js | ~380 | `function computeMixScore(technicalData, reference)` | Defini√ß√£o |
| scoring.js | 550 | `const val = metrics.spectral_balance?.[band]?.energy_db` | Acesso a bandas |

---

## üîç ETAPA 3: CHAVES ESPERADAS PELO FRONT

### Payload Final (json-output.js, linhas 755-804)

```javascript
return {
  score: scoringResult.scorePct,
  classification: scoringResult.classification,
  
  // ‚úÖ BANDAS LEGADAS (sempre presentes)
  bands: technicalData.spectral_balance, // { sub, bass, lowMid, mid, highMid, presence, air }
  
  // ‚úÖ CAMPOS ADITIVOS GRANULAR (apenas se engine = granular_v1)
  ...(coreMetrics.spectralBands?.algorithm === 'granular_v1' && {
    engineVersion: 'granular_v1',
    granular: [...], // 13 sub-bandas
    suggestions: [...], // Sugest√µes inteligentes
    granularMetadata: { /* stats */ }
  }),
  
  // Restante do payload...
}
```

### Estrutura `bands` Esperada

```javascript
{
  "sub": {
    "energy_db": -28.3,
    "percentage": 15.2,
    "range": "20-60Hz",
    "name": "Sub",
    "status": "calculated"
  },
  "bass": { /* similar */ },
  "lowMid": { /* similar */ },
  "mid": { /* similar */ },
  "highMid": { /* similar */ },
  "presence": { /* similar */ },
  "air": { /* similar */ }
}
```

### ‚ö†Ô∏è **PROBLEMA CR√çTICO IDENTIFICADO**

**Granular retorna `.groups`, mas frontend/scoring espera `.bands`**

```javascript
// ‚ùå GRANULAR ATUAL (ERRADO)
{
  algorithm: 'granular_v1',
  groups: {
    sub: { status: 'green', score: 0.0, subBandsCount: 2, description: "..." }
  }
}

// ‚úÖ LEGACY (CORRETO)
{
  bands: {
    sub: { energy_db: -28.3, percentage: 15.2, range: "20-60Hz", name: "Sub", status: "calculated" }
  }
}

// ‚úÖ SOLU√á√ÉO: Granular deve ter AMBOS
{
  algorithm: 'granular_v1',
  bands: { sub: {...}, bass: {...}, ... }, // ‚Üê ADICIONAR
  groups: { sub: {...}, bass: {...}, ... }, // ‚Üê manter para compatibilidade interna
  granular: [...],
  suggestions: [...]
}
```

---

## üö® ETAPA 4: AN√ÅLISE DA CONDI√á√ÉO `[SPECTRAL_BANDS] Condi√ß√£o de acesso falhou`

### Localiza√ß√£o Exata

**Arquivo**: `work/api/audio/json-output.js`  
**Linha**: 354  
**Fun√ß√£o**: `extractTechnicalData(coreMetrics, reference)`

### Condi√ß√£o que Falha

```javascript
// Linha 192
if (coreMetrics.spectralBands?.bands) {
  const b = coreMetrics.spectralBands;
  // ... extra√ß√£o de bandas
} else {
  // Linha 342-360: ELSE BLOCK (erro)
  const debugInfo = {
    hasSpectralBands: !!coreMetrics.spectralBands,
    spectralBandsKeys: coreMetrics.spectralBands ? Object.keys(coreMetrics.spectralBands) : null,
    hasBands: !!(coreMetrics.spectralBands?.bands),  // ‚Üê AQUI: false para granular
    hasAggregated: !!(coreMetrics.spectralBands?.aggregated)
  };
  
  console.warn('‚ö†Ô∏è [SPECTRAL_BANDS] Condi√ß√£o de acesso falhou:', debugInfo);
  // ... retorna null para todas as bandas
}
```

### Por que Falha com Granular V1?

1. **Granular retorna**: `{ algorithm: 'granular_v1', groups: {...}, granular: [...] }`
2. **Condi√ß√£o verifica**: `coreMetrics.spectralBands?.bands`
3. **Resultado**: `undefined` ‚Üí condi√ß√£o falha
4. **Consequ√™ncia**: `hasBands = false` ‚Üí scoring n√£o roda ‚Üí interface quebra

### Debug Esperado com Granular V1 Atual

```javascript
{
  hasSpectralBands: true,
  spectralBandsKeys: ['algorithm', 'groups', 'granular', 'suggestions', 'referenceGenre', ...],
  hasBands: false,  // ‚Üê PROBLEMA!
  hasAggregated: false
}
```

---

## üîß ETAPA 5: PONTOS DE INJE√á√ÉO PARA COMPATIBILIDADE

### **SOLU√á√ÉO 1: Adicionar `.bands` no retorno do Granular (RECOMENDADO)**

**Arquivo**: `work/lib/audio/features/spectral-bands-granular.js`  
**Fun√ß√£o**: `aggregateSubBandsIntoGroups(subBandResults, grouping, severity)`  
**Linha**: ~295 (dentro do loop de grupos)

```javascript
function aggregateSubBandsIntoGroups(subBandResults, grouping, severity) {
  const groups = {};
  const bands = {}; // ‚Üê ADICIONAR
  const weights = severity.weights;
  const thresholds = severity.thresholds;

  for (const [groupName, subBandIds] of Object.entries(grouping)) {
    const subBands = subBandResults.filter(s => subBandIds.includes(s.id));

    if (subBands.length === 0) {
      groups[groupName] = {
        status: 'green',
        score: 0.0,
        subBandsCount: 0
      };
      
      // ‚úÖ ADICIONAR: Banda legada compat√≠vel
      bands[groupName] = {
        energy_db: null,
        percentage: null,
        range: getFrequencyRangeForGroup(groupName),
        name: formatGroupName(groupName),
        status: 'not_calculated'
      };
      continue;
    }

    // Calcular score m√©dio
    const totalPoints = subBands.reduce((acc, s) => acc + weights[s.status], 0);
    const avgScore = totalPoints / subBands.length;

    // Determinar cor
    let color = 'green';
    if (avgScore > thresholds.yellowMax) color = 'red';
    else if (avgScore > thresholds.greenMax) color = 'yellow';

    groups[groupName] = {
      status: color,
      score: parseFloat(avgScore.toFixed(2)),
      subBandsCount: subBands.length,
      description: `${groupName.replace('_', '-')} ${color === 'green' ? 'ideal' : color === 'yellow' ? 'com desvio moderado' : 'com excesso/falta significativo'}`
    };
    
    // ‚úÖ ADICIONAR: Banda legada compat√≠vel
    // Calcular energia m√©dia das sub-bandas deste grupo
    const avgEnergyDb = subBands.reduce((sum, s) => sum + s.energyDb, 0) / subBands.length;
    
    // Calcular percentage estimado (pode ser melhorado)
    const totalEnergy = subBandResults.reduce((sum, s) => sum + Math.pow(10, s.energyDb / 10), 0);
    const groupEnergy = subBands.reduce((sum, s) => sum + Math.pow(10, s.energyDb / 10), 0);
    const percentage = (groupEnergy / totalEnergy) * 100;
    
    bands[groupName] = {
      energy_db: parseFloat(avgEnergyDb.toFixed(1)),
      percentage: parseFloat(percentage.toFixed(2)),
      range: getFrequencyRangeForGroup(groupName),
      name: formatGroupName(groupName),
      status: 'calculated'
    };
  }

  return { groups, bands }; // ‚Üê RETORNAR AMBOS
}

// ‚úÖ FUN√á√ïES AUXILIARES
function getFrequencyRangeForGroup(groupName) {
  const ranges = {
    'sub': '20-60Hz',
    'bass': '60-150Hz',
    'low_mid': '150-500Hz',
    'mid': '500-2000Hz',
    'high_mid': '2000-5000Hz',
    'presence': '5000-10000Hz',
    'air': '10000-20000Hz'
  };
  return ranges[groupName] || 'Unknown';
}

function formatGroupName(groupName) {
  const names = {
    'sub': 'Sub',
    'bass': 'Bass',
    'low_mid': 'Low-Mid',
    'mid': 'Mid',
    'high_mid': 'High-Mid',
    'presence': 'Presence',
    'air': 'Air'
  };
  return names[groupName] || groupName;
}
```

**Modificar fun√ß√£o principal**: `analyzeGranularSpectralBands()` ‚Üí Linha ~237

```javascript
// Linha 234 (antes do return)
const aggregationResult = aggregateSubBandsIntoGroups(subBandResults, grouping, severity);

// Retornar resultado completo
return {
  algorithm: 'granular_v1',
  referenceGenre: reference?.genre || 'techno',
  schemaVersion: reference?.schemaVersion || 1,
  lufsNormalization: true,
  framesProcessed: framesFFT.length,
  aggregationMethod: 'median',
  bands: aggregationResult.bands, // ‚Üê ADICIONAR
  groups: aggregationResult.groups, // ‚Üê manter
  granular: subBandResults,
  suggestions: suggestions,
  subBandsTotal: subBandResults.length,
  subBandsIdeal: subBandResults.filter(s => s.status === 'ideal').length,
  subBandsAdjust: subBandResults.filter(s => s.status === 'adjust').length,
  subBandsFix: subBandResults.filter(s => s.status === 'fix').length
};
```

### **ALTERNATIVA 2: Modificar json-output.js para aceitar `.groups`**

**Arquivo**: `work/api/audio/json-output.js`  
**Linha**: 192

```javascript
// ‚ùå ATUAL (apenas .bands)
if (coreMetrics.spectralBands?.bands) {
  const b = coreMetrics.spectralBands;
  // ...
}

// ‚úÖ CORRIGIDO (aceitar .bands OU .groups)
const spectralSource = coreMetrics.spectralBands?.bands || coreMetrics.spectralBands?.groups;

if (spectralSource) {
  const b = coreMetrics.spectralBands;
  const isGranular = b.algorithm === 'granular_v1';
  
  // Converter .groups para formato .bands se necess√°rio
  if (isGranular && !b.bands && b.groups) {
    // Mapear groups ‚Üí bands
    const convertedBands = {};
    for (const [key, group] of Object.entries(b.groups)) {
      convertedBands[key] = {
        energy_db: null, // N√£o dispon√≠vel em groups
        percentage: null, // Calcular se necess√°rio
        range: getFrequencyRangeForGroup(key),
        name: formatGroupName(key),
        status: group.status === 'green' ? 'calculated' : 'adjust'
      };
    }
    technicalData.spectral_balance = convertedBands;
  } else {
    // Usar estrutura .bands normal
    technicalData.spectral_balance = {
      sub: {
        energy_db: safeSanitize(spectralSource.sub?.energy_db),
        percentage: safeSanitize(spectralSource.sub?.percentage),
        // ...
      }
      // ... restante
    };
  }
}
```

**‚ö†Ô∏è Problema**: Esta solu√ß√£o √© mais fr√°gil e n√£o resolve o scoring que precisa de `energy_db`.

---

## üìà ETAPA 6: ROTA DE SCORING

### Como `bands` √© Usado no Scoring

**Arquivo**: `work/lib/audio/features/scoring.js`  
**Fun√ß√£o**: `computeMixScore(technicalData, reference)`

#### 1. Extra√ß√£o de Valores (linha ~550)

```javascript
if (reference?.spectral_bands) {
  for (const [band, refBand] of Object.entries(reference.spectral_bands)) {
    const val = metrics.spectral_balance?.[band]?.energy_db; // ‚Üê PRECISA de energy_db
    
    if (!Number.isFinite(val)) continue; // ‚Üê Se null, ignora m√©trica
    
    // Adicionar m√©trica ao scoring
    addMetric('tonal', `band_${band}`, val, refBand.target_db, tol);
  }
}
```

#### 2. C√°lculo de Score (linha ~405)

```javascript
function addMetric(category, key, value, target, tol, opts = {}) {
  if (!Number.isFinite(value) || value === -Infinity) return; // ‚Üê EARLY EXIT
  if (!Number.isFinite(target)) return;
  
  // Calcular score...
  const s = scoreTolerance(value, target, tol);
  
  perMetric.push({ 
    category, 
    key, 
    value, 
    target, 
    tol, 
    score: s 
  });
}
```

### Por que `hasBands: false` Interrompe o Fluxo?

1. **json-output.js (linha 192)**: Condi√ß√£o `if (coreMetrics.spectralBands?.bands)` falha
2. **Consequ√™ncia**: `technicalData.spectral_balance` recebe valores `null`:
   ```javascript
   {
     sub: { energy_db: null, percentage: null, status: "not_calculated" },
     // ... todas as bandas null
   }
   ```
3. **scoring.js (linha ~550)**: `val = metrics.spectral_balance?.[band]?.energy_db` ‚Üí `null`
4. **scoring.js (linha 407)**: `if (!Number.isFinite(value))` ‚Üí `return` (early exit)
5. **Resultado**: Nenhuma m√©trica de banda adicionada ao scoring
6. **Score final**: Calculado apenas com LUFS, TP, DR, LRA ‚Üí **incompleto**

### Diagrama de Fluxo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ core-metrics.js                                             ‚îÇ
‚îÇ  calculateSpectralBandsMetrics()                            ‚îÇ
‚îÇ   ‚îú‚îÄ engine === 'legacy'                                    ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ> { bands: {...}, totalPercentage, valid }  ‚úÖ     ‚îÇ
‚îÇ   ‚îÇ                                                          ‚îÇ
‚îÇ   ‚îî‚îÄ engine === 'granular_v1'                               ‚îÇ
‚îÇ       ‚îî‚îÄ> { groups: {...}, granular: [...] }  ‚ùå SEM BANDS ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ json-output.js                                              ‚îÇ
‚îÇ  extractTechnicalData()                                     ‚îÇ
‚îÇ   if (coreMetrics.spectralBands?.bands) {  ‚Üê FALHA         ‚îÇ
‚îÇ     // Extrai bandas                                        ‚îÇ
‚îÇ   } else {                                                  ‚îÇ
‚îÇ     technicalData.spectral_balance = {                     ‚îÇ
‚îÇ       sub: { energy_db: null, ... }  ‚Üê NULLS               ‚îÇ
‚îÇ     }                                                        ‚îÇ
‚îÇ     hasBands: false  ‚Üê MARCA COMO FALHA                    ‚îÇ
‚îÇ   }                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ scoring.js                                                  ‚îÇ
‚îÇ  computeMixScore(technicalData, reference)                 ‚îÇ
‚îÇ   const val = metrics.spectral_balance?.[band]?.energy_db; ‚îÇ
‚îÇ   // val = null                                             ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ   if (!Number.isFinite(val)) return;  ‚Üê EARLY EXIT         ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ   // Banda N√ÉO √â ADICIONADA ao scoring                     ‚îÇ
‚îÇ   // Score calculado SEM bandas espectrais                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   v
         ‚ùå SCORE INCOMPLETO
         ‚ùå UI N√ÉO EXIBE BANDAS
```

---

## üì¶ ETAPA 7: PAYLOAD FINAL

### Estrutura Atual (Legacy)

```javascript
{
  "score": 85.3,
  "classification": "Profissional",
  "bands": {
    "sub": { "energy_db": -28.3, "percentage": 15.2, "range": "20-60Hz", "name": "Sub", "status": "calculated" },
    "bass": { "energy_db": -29.1, "percentage": 22.5, "range": "60-150Hz", "name": "Bass", "status": "calculated" },
    // ... 5 bandas restantes
  },
  "technicalData": {
    "spectral_balance": { /* mesmo que bands */ }
  }
}
```

### Estrutura Desejada (Granular V1)

```javascript
{
  "score": 85.3,
  "classification": "Profissional",
  
  // ‚úÖ BANDAS PRINCIPAIS (compat√≠vel com legacy)
  "bands": {
    "sub": { "energy_db": -28.5, "percentage": 14.8, "range": "20-60Hz", "name": "Sub", "status": "calculated" },
    "bass": { "energy_db": -29.2, "percentage": 23.1, "range": "60-150Hz", "name": "Bass", "status": "calculated" },
    // ... 5 bandas restantes
  },
  
  // ‚úÖ CAMPOS ADITIVOS GRANULAR
  "engineVersion": "granular_v1",
  "granular": [
    {
      "id": "sub_low",
      "range": [20, 40],
      "energyDb": -28.3,
      "target": -28.0,
      "deviation": -0.3,
      "deviationSigmas": 0.2,
      "status": "ideal"
    },
    {
      "id": "sub_high",
      "range": [40, 60],
      "energyDb": -32.1,
      "target": -29.0,
      "deviation": -3.1,
      "deviationSigmas": 2.07,
      "status": "adjust"
    }
    // ... 11 sub-bandas restantes
  ],
  "suggestions": [
    {
      "priority": "high",
      "freq_range": [40, 60],
      "type": "boost",
      "amount": 2.5,
      "metric": "frequency_balance",
      "deviation": -3.1,
      "message": "Falta energia em 40‚Äì60 Hz ‚Äî refor√ßar ~2.5 dB (harm√¥nicos do kick)."
    }
    // ... outras sugest√µes
  ],
  "granularMetadata": {
    "referenceGenre": "techno",
    "schemaVersion": 1,
    "framesProcessed": 1028,
    "subBandsTotal": 13,
    "subBandsIdeal": 9,
    "subBandsAdjust": 2,
    "subBandsFix": 2
  },
  
  "technicalData": {
    "spectral_balance": { /* mesmo que bands */ }
  }
}
```

### Onde Inserir no C√≥digo

**Arquivo**: `work/api/audio/json-output.js`  
**Fun√ß√£o**: `buildFinalJSON(technicalData, scoringResult, metadata, coreMetrics, reference)`  
**Linha**: 755-804

```javascript
return {
  score: scoringResult.scorePct,
  classification: scoringResult.classification,
  
  // ‚úÖ Bandas principais (sempre presentes)
  bands: technicalData.spectral_balance,
  
  // ‚úÖ Campos aditivos (j√° implementado, mas s√≥ funciona se bands existir)
  ...(coreMetrics.spectralBands?.algorithm === 'granular_v1' && {
    engineVersion: coreMetrics.spectralBands.algorithm,
    granular: coreMetrics.spectralBands.granular || [],
    suggestions: coreMetrics.spectralBands.suggestions || [],
    granularMetadata: {
      referenceGenre: coreMetrics.spectralBands.referenceGenre,
      schemaVersion: coreMetrics.spectralBands.schemaVersion,
      lufsNormalization: coreMetrics.spectralBands.lufsNormalization,
      framesProcessed: coreMetrics.spectralBands.framesProcessed,
      aggregationMethod: coreMetrics.spectralBands.aggregationMethod,
      subBandsTotal: coreMetrics.spectralBands.subBandsTotal,
      subBandsIdeal: coreMetrics.spectralBands.subBandsIdeal,
      subBandsAdjust: coreMetrics.spectralBands.subBandsAdjust,
      subBandsFix: coreMetrics.spectralBands.subBandsFix
    }
  }),
  
  // Restante do payload...
}
```

---

## üõ†Ô∏è ETAPA 8: PLANO DE IMPLEMENTA√á√ÉO SEGURO

### **PASSO 1: Adicionar C√°lculo de `.bands` no Granular**

**Arquivo**: `work/lib/audio/features/spectral-bands-granular.js`  
**Linha**: ~270 (fun√ß√£o `aggregateSubBandsIntoGroups`)

**O que fazer**:
1. Adicionar vari√°vel `const bands = {};` no in√≠cio da fun√ß√£o
2. Dentro do loop de grupos, calcular `energy_db` e `percentage`
3. Adicionar fun√ß√µes auxiliares `getFrequencyRangeForGroup()` e `formatGroupName()`
4. Retornar `{ groups, bands }` em vez de apenas `groups`

**Teste**:
```bash
node work/tests/spectral-bands-granular.test.js
```

**Valida√ß√£o**: Resultado deve ter `.bands` com 7 chaves e valores num√©ricos.

---

### **PASSO 2: Atualizar Chamada em `analyzeGranularSpectralBands`**

**Arquivo**: `work/lib/audio/features/spectral-bands-granular.js`  
**Linha**: ~234

**O que fazer**:
```javascript
// Antes
const groups = aggregateSubBandsIntoGroups(subBandResults, grouping, severity);

return {
  // ...
  groups: groups,
  // ...
};

// Depois
const { groups, bands } = aggregateSubBandsIntoGroups(subBandResults, grouping, severity);

return {
  // ...
  bands: bands,  // ‚Üê ADICIONAR
  groups: groups,
  // ...
};
```

**Teste**: Mesmo teste anterior deve passar com `.bands` presente.

---

### **PASSO 3: Atualizar Testes Unit√°rios**

**Arquivo**: `work/tests/spectral-bands-granular.test.js`  
**Linha**: ~141

**O que fazer**:
```javascript
// Adicionar valida√ß√£o de .bands
assert(result.bands, 'Deve ter campo bands');
assert(Object.keys(result.bands).length === 7, 'Bands deve ter 7 chaves');
assert(result.bands.sub, 'Deve ter banda sub');
assert(Number.isFinite(result.bands.sub.energy_db), 'Sub deve ter energy_db num√©rico');
assert(Number.isFinite(result.bands.sub.percentage), 'Sub deve ter percentage num√©rico');
```

---

### **PASSO 4: Teste de Regress√£o (Legacy vs Granular)**

**Criar arquivo**: `work/tests/regression-legacy-vs-granular.test.js`

```javascript
import { calculateCoreMetrics } from '../api/audio/core-metrics.js';

async function testRegressionLegacyVsGranular() {
  // Mock de √°udio
  const mockSegmentedAudio = {
    framesFFT: [
      // ... frames mocados
    ]
  };

  // 1. Executar legacy
  process.env.ANALYZER_ENGINE = 'legacy';
  const legacyResult = await calculateCoreMetrics(mockSegmentedAudio);

  // 2. Executar granular
  process.env.ANALYZER_ENGINE = 'granular_v1';
  const granularResult = await calculateCoreMetrics(mockSegmentedAudio);

  // 3. Comparar estruturas
  console.log('‚úÖ TESTE DE REGRESS√ÉO');
  console.log('');
  console.log('Legacy:');
  console.log('  - Tem .bands:', !!legacyResult.spectralBands.bands);
  console.log('  - Chaves bands:', Object.keys(legacyResult.spectralBands.bands || {}));
  console.log('');
  console.log('Granular:');
  console.log('  - Tem .bands:', !!granularResult.spectralBands.bands);
  console.log('  - Chaves bands:', Object.keys(granularResult.spectralBands.bands || {}));
  console.log('  - Tem .groups:', !!granularResult.spectralBands.groups);
  console.log('  - Tem .granular:', !!granularResult.spectralBands.granular);
  console.log('  - Tem .suggestions:', !!granularResult.spectralBands.suggestions);

  // 4. Validar compatibilidade
  assert(granularResult.spectralBands.bands, 'Granular deve ter .bands');
  assert(Object.keys(granularResult.spectralBands.bands).length === 7, 'Granular.bands deve ter 7 chaves');
  
  // 5. Comparar energy_db
  const legacySubEnergy = legacyResult.spectralBands.bands.sub.energy_db;
  const granularSubEnergy = granularResult.spectralBands.bands.sub.energy_db;
  const diff = Math.abs(legacySubEnergy - granularSubEnergy);
  
  console.log('');
  console.log('Compara√ß√£o energy_db (sub):');
  console.log('  - Legacy:', legacySubEnergy);
  console.log('  - Granular:', granularSubEnergy);
  console.log('  - Diferen√ßa:', diff.toFixed(2), 'dB');
  
  // Toler√¢ncia de 3 dB (aceit√°vel devido a m√©todos diferentes)
  assert(diff < 3.0, `Diferen√ßa em sub.energy_db deve ser < 3 dB (atual: ${diff.toFixed(2)})`);
}

testRegressionLegacyVsGranular().catch(err => {
  console.error('‚ùå Erro no teste de regress√£o:', err);
  process.exit(1);
});
```

**Executar**:
```bash
node work/tests/regression-legacy-vs-granular.test.js
```

---

### **PASSO 5: Teste de Scoring**

**Criar arquivo**: `work/tests/scoring-with-granular.test.js`

```javascript
import { computeMixScore } from '../lib/audio/features/scoring.js';
import referenceData from '../../references/techno.v1.json';

function testScoringWithGranular() {
  // Mock technicalData com structure granular
  const technicalData = {
    lufsIntegrated: -12.5,
    truePeakDbtp: -1.2,
    spectral_balance: {
      sub: { energy_db: -28.5, percentage: 14.8, status: 'calculated' },
      bass: { energy_db: -29.2, percentage: 23.1, status: 'calculated' },
      low_mid: { energy_db: -32.1, percentage: 18.3, status: 'calculated' },
      mid: { energy_db: -34.5, percentage: 16.2, status: 'calculated' },
      high_mid: { energy_db: -36.8, percentage: 14.5, status: 'calculated' },
      presence: { energy_db: -38.2, percentage: 10.1, status: 'calculated' },
      air: { energy_db: -42.5, percentage: 3.0, status: 'calculated' }
    }
  };

  // Executar scoring
  const result = computeMixScore(technicalData, referenceData);

  console.log('‚úÖ TESTE DE SCORING COM GRANULAR');
  console.log('');
  console.log('Score:', result.scorePct);
  console.log('Classification:', result.classification);
  console.log('M√©tricas processadas:', result.perMetric.length);
  console.log('');
  console.log('Bandas no scoring:');
  const bandMetrics = result.perMetric.filter(m => m.key.startsWith('band_'));
  bandMetrics.forEach(m => {
    console.log(`  - ${m.key}: value=${m.value}, target=${m.target}, score=${m.scorePct}%`);
  });

  // Valida√ß√µes
  assert(result.scorePct > 0, 'Score deve ser > 0');
  assert(bandMetrics.length === 7, 'Deve ter processado 7 bandas');
  assert(bandMetrics.every(m => Number.isFinite(m.value)), 'Todas as bandas devem ter valores num√©ricos');
}

testScoringWithGranular();
```

**Executar**:
```bash
node work/tests/scoring-with-granular.test.js
```

---

### **PASSO 6: Valida√ß√£o de Sintaxe**

```bash
# Validar arquivos modificados
npx eslint work/lib/audio/features/spectral-bands-granular.js
npx eslint work/tests/spectral-bands-granular.test.js
```

---

### **PASSO 7: Deploy em Staging**

1. Commit das altera√ß√µes:
```bash
git add work/lib/audio/features/spectral-bands-granular.js
git add work/tests/spectral-bands-granular.test.js
git add work/tests/regression-legacy-vs-granular.test.js
git add work/tests/scoring-with-granular.test.js
git commit -m "feat(granular): add .bands field for frontend/scoring compatibility"
```

2. Deploy em staging:
```bash
git push origin staging
```

3. Ativar granular_v1 em staging:
```bash
# .env em staging
ANALYZER_ENGINE=granular_v1
```

4. Processar 10-20 tracks e validar:
   - ‚úÖ Payload tem `bands` com 7 chaves
   - ‚úÖ Score √© calculado corretamente
   - ‚úÖ UI exibe bandas
   - ‚úÖ N√£o h√° erros no console

---

### **PASSO 8: Rollback (se necess√°rio)**

```bash
# .env
ANALYZER_ENGINE=legacy
```

**Ou reverter commit**:
```bash
git revert HEAD
git push origin staging
```

---

## üéØ ETAPA 9: GARANTIA DE COMPATIBILIDADE

### Checklist Final

#### ‚úÖ Com Granular V1 Ativo

- [ ] `bands` aparece no payload
- [ ] `bands` tem 7 chaves: sub, bass, low_mid, mid, high_mid, presence, air
- [ ] Cada banda tem: `energy_db`, `percentage`, `range`, `name`, `status`
- [ ] `energy_db` √© num√©rico e finito
- [ ] `percentage` √© num√©rico e finito
- [ ] `computeMixScore` processa as 7 bandas
- [ ] `hasBands = true` no log
- [ ] UI exibe bandas corretamente
- [ ] Score √© calculado com bandas espectrais
- [ ] Campos aditivos presentes: `engineVersion`, `granular`, `suggestions`

#### ‚úÖ Com Legacy Ativo (Rollback)

- [ ] `ANALYZER_ENGINE=legacy` retorna ao comportamento original
- [ ] `bands` continua aparecendo
- [ ] Estrutura id√™ntica ao sistema anterior
- [ ] Nenhum campo `granular` ou `suggestions` presente
- [ ] Score id√™ntico ao anterior
- [ ] Logs n√£o mostram nenhuma refer√™ncia a granular_v1

---

## üìå RESPOSTA FINAL

> **"Qual √© o m√≠nimo conjunto de altera√ß√µes necess√°rias para que o granular_v1 funcione no front com score e bandas vis√≠veis, mantendo rollback instant√¢neo via flag?"**

### Resposta T√©cnica

**√öNICA MODIFICA√á√ÉO NECESS√ÅRIA**: Adicionar campo `.bands` ao retorno do m√≥dulo granular.

**Arquivos a modificar**: 1 (um)

**Linhas a adicionar**: ~80 linhas (incluindo fun√ß√µes auxiliares)

**Tempo estimado**: 30 minutos

---

### Implementa√ß√£o M√≠nima

**Arquivo**: `work/lib/audio/features/spectral-bands-granular.js`

**Modifica√ß√µes**:

1. **Fun√ß√£o `aggregateSubBandsIntoGroups` (linha ~270)**:
   - Adicionar c√°lculo de `energy_db` e `percentage` para cada grupo
   - Retornar `{ groups, bands }` em vez de apenas `groups`

2. **Fun√ß√£o `analyzeGranularSpectralBands` (linha ~234)**:
   - Desestruturar retorno: `const { groups, bands } = aggregateSubBandsIntoGroups(...)`
   - Adicionar `bands` ao objeto de retorno

3. **Fun√ß√µes auxiliares (fim do arquivo, ~linha 420)**:
   ```javascript
   function getFrequencyRangeForGroup(groupName) { /* ... */ }
   function formatGroupName(groupName) { /* ... */ }
   ```

**Total**: ~80 linhas de c√≥digo em 1 arquivo.

---

### Por Que Esta Solu√ß√£o √© M√≠nima e Segura?

1. **Isolada**: Modifica apenas o m√≥dulo granular, zero impacto no legacy
2. **Aditiva**: Adiciona `.bands` sem remover `.groups` (compatibilidade interna mantida)
3. **Revers√≠vel**: Feature flag `ANALYZER_ENGINE=legacy` desativa instantaneamente
4. **Compat√≠vel**: `.bands` tem mesma estrutura que o legacy espera
5. **Test√°vel**: Pode ser validada com testes unit√°rios antes do deploy

---

### Fluxo P√≥s-Implementa√ß√£o

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ANALYZER_ENGINE=granular_v1                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ calculateGranularSubBands()                                 ‚îÇ
‚îÇ  ‚îî‚îÄ> analyzeGranularSpectralBands()                        ‚îÇ
‚îÇ       ‚îî‚îÄ> aggregateSubBandsIntoGroups()                    ‚îÇ
‚îÇ            ‚îî‚îÄ> { groups: {...}, bands: {...} }  ‚úÖ         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Retorno para core-metrics.js                               ‚îÇ
‚îÇ  {                                                           ‚îÇ
‚îÇ    algorithm: 'granular_v1',                                ‚îÇ
‚îÇ    bands: { sub: {energy_db, percentage, ...}, ... },  ‚úÖ  ‚îÇ
‚îÇ    groups: { sub: {status, score, ...}, ... },             ‚îÇ
‚îÇ    granular: [...],                                         ‚îÇ
‚îÇ    suggestions: [...]                                       ‚îÇ
‚îÇ  }                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ json-output.js                                              ‚îÇ
‚îÇ  if (coreMetrics.spectralBands?.bands) {  ‚úÖ PASSA         ‚îÇ
‚îÇ    technicalData.spectral_balance = {                      ‚îÇ
‚îÇ      sub: { energy_db: -28.5, percentage: 14.8 },  ‚úÖ     ‚îÇ
‚îÇ      // ... 6 bandas restantes                             ‚îÇ
‚îÇ    }                                                         ‚îÇ
‚îÇ    hasBands: true  ‚úÖ                                       ‚îÇ
‚îÇ  }                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ scoring.js                                                  ‚îÇ
‚îÇ  const val = metrics.spectral_balance?.[band]?.energy_db;  ‚îÇ
‚îÇ  // val = -28.5  ‚úÖ                                         ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  addMetric('tonal', 'band_sub', -28.5, -28.0, 1.5);  ‚úÖ   ‚îÇ
‚îÇ  // Score calculado COM bandas espectrais  ‚úÖ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   v
         ‚úÖ SCORE COMPLETO
         ‚úÖ UI EXIBE BANDAS
         ‚úÖ SUGEST√ïES DISPON√çVEIS
```

---

### Conclus√£o

**Problema identificado**: Granular retorna `.groups` mas frontend/scoring espera `.bands`.

**Solu√ß√£o**: Adicionar c√°lculo de `.bands` no m√≥dulo granular (80 linhas em 1 arquivo).

**Resultado**: Sistema 100% compat√≠vel com legacy, score correto, UI funcional, rollback instant√¢neo.

**Pr√≥ximo passo**: Implementar PASSO 1 do plano acima e executar testes de valida√ß√£o.

---

**üéØ FIM DA AUDITORIA**
