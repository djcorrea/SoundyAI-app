<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>üîç AUDITORIA - Valores Fict√≠cios vs Reais</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #444; border-radius: 8px; }
        .correct { background-color: #1e5128; color: #4caf50; }
        .incorrect { background-color: #5d1a1a; color: #f44336; }
        .warning { background-color: #4a4a1a; color: #ff9800; }
        .info { background-color: #1a2a4a; color: #2196f3; }
        pre { background: #2a2a2a; padding: 10px; overflow: auto; max-height: 400px; border-radius: 4px; }
        button { padding: 12px 24px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .audit-item { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #2a2a2a; }
        .value-comparison { display: flex; gap: 20px; margin: 10px 0; }
        .value-box { padding: 10px; border-radius: 4px; flex: 1; }
        .real-value { background: #1e5128; }
        .fake-value { background: #5d1a1a; }
        h1, h2, h3 { color: #4caf50; }
    </style>
</head>
<body>
    <h1>üîç AUDITORIA COMPLETA - Valores Fict√≠cios vs Reais</h1>
    
    <div class="section">
        <h3>üéØ Problema Identificado</h3>
        <div class="incorrect">
            ‚ùå <strong>Tabela mostra:</strong> -4.90 dB, -10.80 dB (valores reais)<br>
            ‚ùå <strong>Sugest√µes mostram:</strong> -19 dB (valor fict√≠cio)<br>
            ‚ùå <strong>S√≥ aparece SUB:</strong> Faltam outras bandas
        </div>
    </div>
    
    <div class="section">
        <h3>üïµÔ∏è Controles de Auditoria</h3>
        <button onclick="auditFrontendData()">1. Auditar Dados Frontend</button>
        <button onclick="auditBackendFlow()">2. Auditar Fluxo Backend</button>
        <button onclick="auditSuggestionGeneration()">3. Auditar Gera√ß√£o Sugest√µes</button>
        <button onclick="clearAllLogs()">Limpar Logs</button>
    </div>
    
    <div class="section">
        <h3>üìä Status dos Sistemas</h3>
        <div id="system-status"></div>
    </div>
    
    <div class="section">
        <h3>üîç Dados Capturados no Frontend</h3>
        <div id="frontend-data"></div>
    </div>
    
    <div class="section">
        <h3>üì° Dados Enviados para Backend</h3>
        <div id="backend-data"></div>
    </div>
    
    <div class="section">
        <h3>ü§ñ Resposta da IA Backend</h3>
        <div id="ai-response"></div>
    </div>
    
    <div class="section">
        <h3>üìã Logs Completos de Debug</h3>
        <div id="debug-logs"></div>
    </div>

    <!-- Scripts necess√°rios -->
    <script src="public/suggestion-scorer.js"></script>
    <script src="public/enhanced-suggestion-engine.js"></script>
    <script src="public/ai-suggestion-layer.js"></script>
    
    <script>
        let auditLogs = [];
        let interceptedData = {
            frontendSuggestions: null,
            backendPayload: null,
            aiResponse: null
        };
        
        // Interceptar console.log para capturar dados
        const originalLog = console.log;
        console.log = function(...args) {
            const logText = args.join(' ');
            auditLogs.push(`${new Date().toISOString()}: ${logText}`);
            if (auditLogs.length > 200) auditLogs.shift();
            originalLog.apply(console, args);
            updateDebugLogs();
        };
        
        // Interceptar fetch para capturar chamadas ao backend
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const [url, options] = args;
            
            // Capturar chamadas para /api/suggestions
            if (url.includes('/api/suggestions')) {
                console.log('üîç [AUDIT] Interceptada chamada para backend:', url);
                
                if (options && options.body) {
                    try {
                        const payload = JSON.parse(options.body);
                        interceptedData.backendPayload = payload;
                        console.log('üîç [AUDIT] Payload enviado para backend:', payload);
                        updateBackendData();
                    } catch (e) {
                        console.warn('üîç [AUDIT] Erro ao parsear payload:', e);
                    }
                }
            }
            
            // Chamar fetch original e interceptar resposta
            return originalFetch.apply(this, args).then(response => {
                if (url.includes('/api/suggestions')) {
                    const clonedResponse = response.clone();
                    clonedResponse.json().then(data => {
                        interceptedData.aiResponse = data;
                        console.log('üîç [AUDIT] Resposta do backend:', data);
                        updateAIResponse();
                    }).catch(e => console.warn('üîç [AUDIT] Erro ao parsear resposta:', e));
                }
                return response;
            });
        };
        
        function updateDebugLogs() {
            const debugDiv = document.getElementById('debug-logs');
            const relevantLogs = auditLogs.filter(log => 
                log.includes('AUDIT') || 
                log.includes('ENHANCED_ENGINE_VALUES') ||
                log.includes('SUGGESTION_FINAL') ||
                log.includes('banda') ||
                log.includes('delta') ||
                log.includes('dB')
            );
            debugDiv.innerHTML = '<pre>' + relevantLogs.slice(-20).join('\n') + '</pre>';
        }
        
        function updateBackendData() {
            const backendDiv = document.getElementById('backend-data');
            if (interceptedData.backendPayload) {
                const suggestions = interceptedData.backendPayload.suggestions || [];
                
                let html = '<h4>Sugest√µes Enviadas para Backend:</h4>';
                suggestions.forEach((s, i) => {
                    const hasTechnical = s.technical && s.technical.delta !== undefined;
                    const cssClass = hasTechnical ? 'correct' : 'warning';
                    
                    html += `
                        <div class="audit-item ${cssClass}">
                            <strong>Sugest√£o ${i + 1}:</strong> ${s.subtype || 'N/A'}<br>
                            <strong>Action:</strong> ${s.action || 'N/A'}<br>
                            <strong>Technical Delta:</strong> ${s.technical?.delta || 'N/A'} dB<br>
                            <strong>Current Value:</strong> ${s.technical?.value || 'N/A'}<br>
                            <strong>Target Value:</strong> ${s.technical?.target || 'N/A'}<br>
                            <strong>Tem dados t√©cnicos:</strong> ${hasTechnical ? '‚úÖ SIM' : '‚ùå N√ÉO'}
                        </div>
                    `;
                });
                
                backendDiv.innerHTML = html;
            } else {
                backendDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Aguardando dados do backend...</div>';
            }
        }
        
        function updateAIResponse() {
            const aiDiv = document.getElementById('ai-response');
            if (interceptedData.aiResponse) {
                const suggestions = interceptedData.aiResponse.enhancedSuggestions || [];
                
                let html = '<h4>Sugest√µes Retornadas pela IA:</h4>';
                suggestions.forEach((s, i) => {
                    const problema = s.problema || 'N/A';
                    const hasFakeValue = problema.includes('-19') || problema.includes('+8') || problema.includes('-7');
                    const cssClass = hasFakeValue ? 'incorrect' : 'correct';
                    
                    html += `
                        <div class="audit-item ${cssClass}">
                            <strong>Sugest√£o ${i + 1}:</strong><br>
                            <strong>Problema:</strong> ${problema}<br>
                            <strong>Solu√ß√£o:</strong> ${s.solucao || 'N/A'}<br>
                            <strong>Valor fict√≠cio detectado:</strong> ${hasFakeValue ? '‚ùå SIM' : '‚úÖ N√ÉO'}
                        </div>
                    `;
                });
                
                aiDiv.innerHTML = html;
            } else {
                aiDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Aguardando resposta da IA...</div>';
            }
        }
        
        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            
            const aiLayerEnabled = window.AI_SUGGESTION_LAYER_ENABLED;
            const hasEnhancedEngine = typeof window.EnhancedSuggestionEngine !== 'undefined';
            const hasActiveRefData = typeof window.PROD_AI_REF_DATA !== 'undefined' && window.PROD_AI_REF_DATA;
            
            let status = `
                <div class="${aiLayerEnabled ? 'correct' : 'warning'}">
                    ü§ñ AI Layer: ${aiLayerEnabled ? '‚úÖ ATIVADA' : '‚ùå DESATIVADA'}
                </div>
                <div class="${hasEnhancedEngine ? 'correct' : 'incorrect'}">
                    üéØ Enhanced Engine: ${hasEnhancedEngine ? '‚úÖ Carregado' : '‚ùå N√£o encontrado'}
                </div>
                <div class="${hasActiveRefData ? 'correct' : 'incorrect'}">
                    üìä Dados de Refer√™ncia: ${hasActiveRefData ? '‚úÖ Dispon√≠vel' : '‚ùå N√£o encontrado'}
                </div>
            `;
            
            if (hasActiveRefData) {
                const refData = window.PROD_AI_REF_DATA;
                if (refData.bands) {
                    status += '<div class="info">üéµ Bandas na refer√™ncia: ' + Object.keys(refData.bands).join(', ') + '</div>';
                }
            }
            
            statusDiv.innerHTML = status;
        }
        
        function auditFrontendData() {
            console.log('üîç [AUDIT] Iniciando auditoria frontend...');
            
            // Simular dados de teste baseados na imagem
            const testAnalysis = {
                spectral_bands: {
                    sub: -28.10,           // REAL: -28.10 dB (valor da imagem)
                    bass: -24.60,          // REAL: -24.60 dB  
                    low_mid: -26.70,       // REAL: -26.70 dB
                    mid: -31.20,           // REAL: -31.20 dB
                    high_mid: -35.40,      // REAL: -35.40 dB
                    presence: -38.90,      // REAL: -38.90 dB (da imagem)
                    air: -44.80            // REAL: -44.80 dB
                }
            };
            
            const testReference = {
                bands: {
                    sub: { target_db: -17.30, tol_db: 3.00 },      // Alvo da imagem: -17.30 dB
                    bass: { target_db: -17.70, tol_db: 3.00 },     // Alvo da imagem: -17.70 dB
                    low_mid: { target_db: -18.70, tol_db: 2.50 },  // etc...
                    mid: { target_db: -17.90, tol_db: 2.50 },
                    high_mid: { target_db: -22.90, tol_db: 2.50 },
                    presence: { target_db: -34.00, tol_db: 3.50 }, // Alvo: -34.00, atual: -38.90 = -4.90 dB
                    air: { target_db: -29.30, tol_db: 3.50 }
                }
            };
            
            // Definir dados globais
            window.PROD_AI_REF_DATA = testReference;
            window.PROD_AI_REF_GENRE = 'funk_mandela';
            
            try {
                const engine = new EnhancedSuggestionEngine();
                const result = engine.processAnalysis(testAnalysis, testReference);
                
                interceptedData.frontendSuggestions = result.suggestions;
                console.log('üîç [AUDIT] Sugest√µes frontend geradas:', result.suggestions);
                
                updateFrontendData();
                
            } catch (error) {
                console.error('üîç [AUDIT] Erro no frontend:', error);
            }
        }
        
        function updateFrontendData() {
            const frontendDiv = document.getElementById('frontend-data');
            if (interceptedData.frontendSuggestions) {
                const suggestions = interceptedData.frontendSuggestions;
                
                let html = '<h4>Sugest√µes Geradas pelo Enhanced Engine:</h4>';
                suggestions.forEach((s, i) => {
                    const delta = s.technical?.delta;
                    const hasCorrectDelta = delta !== undefined;
                    const cssClass = hasCorrectDelta ? 'correct' : 'warning';
                    
                    // Calcular diferen√ßa esperada baseada nos dados da imagem
                    let expectedDelta = 'N/A';
                    if (s.subtype === 'presence') {
                        expectedDelta = '-4.90'; // -38.90 - (-34.00) = -4.90
                    } else if (s.subtype === 'sub') {
                        expectedDelta = '-10.80'; // -28.10 - (-17.30) = -10.80
                    }
                    
                    html += `
                        <div class="audit-item ${cssClass}">
                            <strong>Banda:</strong> ${s.subtype || 'N/A'}<br>
                            <strong>Delta Calculado:</strong> ${delta?.toFixed(2) || 'N/A'} dB<br>
                            <strong>Delta Esperado:</strong> ${expectedDelta} dB<br>
                            <strong>Action:</strong> ${s.action || 'N/A'}<br>
                            <strong>Valores corretos:</strong> ${hasCorrectDelta ? '‚úÖ SIM' : '‚ùå N√ÉO'}
                        </div>
                    `;
                });
                
                frontendDiv.innerHTML = html;
            }
        }
        
        function auditBackendFlow() {
            console.log('üîç [AUDIT] Iniciando auditoria do fluxo backend...');
            
            if (!interceptedData.frontendSuggestions) {
                alert('Execute primeiro a auditoria do frontend!');
                return;
            }
            
            // Simular chamada para backend com dados reais
            const payload = {
                suggestions: interceptedData.frontendSuggestions,
                metrics: {
                    lufsIntegrated: -14.5,
                    truePeakDbtp: -1.2,
                    dynamicRange: 8.5
                },
                genre: 'funk_mandela'
            };
            
            console.log('üîç [AUDIT] Enviando para backend:', payload);
            
            fetch('/api/suggestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                console.log('üîç [AUDIT] Resposta backend recebida:', data);
            })
            .catch(error => {
                console.error('üîç [AUDIT] Erro no backend:', error);
            });
        }
        
        function auditSuggestionGeneration() {
            console.log('üîç [AUDIT] Auditando gera√ß√£o completa...');
            
            // Executar auditoria completa
            auditFrontendData();
            
            setTimeout(() => {
                auditBackendFlow();
            }, 2000);
        }
        
        function clearAllLogs() {
            auditLogs = [];
            interceptedData = { frontendSuggestions: null, backendPayload: null, aiResponse: null };
            document.getElementById('debug-logs').innerHTML = '';
            document.getElementById('frontend-data').innerHTML = '';
            document.getElementById('backend-data').innerHTML = '';
            document.getElementById('ai-response').innerHTML = '';
        }
        
        // Inicializa√ß√£o
        setTimeout(() => {
            updateSystemStatus();
        }, 1000);
        
        // Atualizar status periodicamente
        setInterval(updateSystemStatus, 5000);
    </script>
</body>
</html>