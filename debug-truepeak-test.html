<!DOCTYPE html>
<html>
<head>
    <title>Debug True Peak Test</title>
</head>
<body>
    <h1>Debug True Peak Test</h1>
    <button id="testBtn">Testar True Peak com sinal conhecido</button>
    <div id="results"></div>

    <script src="work/lib/audio/features/truepeak.js"></script>
    <script>
        document.getElementById('testBtn').addEventListener('click', function() {
            console.log('ðŸ§ª Iniciando teste de debug...');
            
            // Criar um sinal de teste simples
            const sampleRate = 48000;
            const duration = 0.1; // 100ms
            const samples = Math.floor(sampleRate * duration);
            
            // Sinal senoidal puro em 1kHz com amplitude 0.5 (-6 dB)
            const leftChannel = new Float32Array(samples);
            const rightChannel = new Float32Array(samples);
            
            const freq = 1000; // 1kHz
            const amplitude = 0.5; // -6 dB
            
            for (let i = 0; i < samples; i++) {
                const t = i / sampleRate;
                const value = amplitude * Math.sin(2 * Math.PI * freq * t);
                leftChannel[i] = value;
                rightChannel[i] = value;
            }
            
            console.log(`ðŸŽµ Sinal gerado: ${freq}Hz, amplitude ${amplitude} (${(20 * Math.log10(amplitude)).toFixed(2)} dB)`);
            
            // Testar True Peak
            const detector = new TruePeakDetector(sampleRate);
            const leftResult = detector.detectTruePeak(leftChannel);
            
            console.log('ðŸ“Š Resultado True Peak:', leftResult);
            
            // Calcular sample peak manualmente para verificaÃ§Ã£o
            let maxSample = 0;
            for (let i = 0; i < leftChannel.length; i++) {
                maxSample = Math.max(maxSample, Math.abs(leftChannel[i]));
            }
            const samplePeakdB = 20 * Math.log10(maxSample);
            
            console.log(`ðŸ” Sample Peak manual: ${samplePeakdB.toFixed(2)} dB (linear: ${maxSample.toFixed(6)})`);
            console.log(`ðŸ” True Peak resultado: ${leftResult.true_peak_dbtp.toFixed(2)} dBTP (linear: ${leftResult.true_peak_linear.toFixed(6)})`);
            
            const diff = leftResult.true_peak_dbtp - samplePeakdB;
            console.log(`ðŸŽ¯ DiferenÃ§a TP - SP: ${diff.toFixed(2)} dB`);
            
            if (leftResult.true_peak_dbtp < samplePeakdB) {
                console.error('ðŸš¨ ERRO: True Peak menor que Sample Peak!');
            } else {
                console.log('âœ… OK: True Peak >= Sample Peak');
            }
            
            // Mostrar no HTML tambÃ©m
            document.getElementById('results').innerHTML = `
                <h3>Resultados:</h3>
                <p>Sample Peak: ${samplePeakdB.toFixed(2)} dB</p>
                <p>True Peak: ${leftResult.true_peak_dbtp.toFixed(2)} dBTP</p>
                <p>DiferenÃ§a: ${diff.toFixed(2)} dB</p>
                <p>Status: ${leftResult.true_peak_dbtp < samplePeakdB ? 'ðŸš¨ ERRO' : 'âœ… OK'}</p>
            `;
        });
    </script>
</body>
</html>