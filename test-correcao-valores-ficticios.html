<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>🧪 TESTE - Correção Valores Fictícios</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #444; border-radius: 8px; }
        .correct { background-color: #1e5128; color: #4caf50; }
        .incorrect { background-color: #5d1a1a; color: #f44336; }
        .warning { background-color: #4a4a1a; color: #ff9800; }
        .info { background-color: #1a2a4a; color: #2196f3; }
        pre { background: #2a2a2a; padding: 10px; overflow: auto; max-height: 300px; border-radius: 4px; }
        button { padding: 12px 24px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .test-result { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #2a2a2a; }
        .expected-vs-actual { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 10px 0; }
        .expected { background: #1e5128; padding: 10px; border-radius: 4px; }
        .actual { background: #5d1a1a; padding: 10px; border-radius: 4px; }
        h1, h2, h3 { color: #4caf50; }
    </style>
</head>
<body>
    <h1>🧪 TESTE - Correção Valores Fictícios</h1>
    
    <div class="section">
        <h3>🎯 Teste com Dados Reais da Imagem</h3>
        <div class="info">
            <strong>Valores esperados baseados na sua imagem:</strong><br>
            • Presença: -38.90 dB (atual) vs -34.00 dB (alvo) = <strong>-4.90 dB</strong><br>
            • Sub: -28.10 dB (atual) vs -17.30 dB (alvo) = <strong>-10.80 dB</strong><br>
            • Bass: -24.60 dB (atual) vs -17.70 dB (alvo) = <strong>-6.90 dB</strong>
        </div>
        <button onclick="testarValoresReais()">🚀 Executar Teste Completo</button>
        <button onclick="limparResultados()">🧹 Limpar</button>
    </div>
    
    <div class="section">
        <h3>📊 Resultado do Teste</h3>
        <div id="test-results"></div>
    </div>
    
    <div class="section">
        <h3>🔍 Comparação Esperado vs Atual</h3>
        <div id="comparison-results"></div>
    </div>
    
    <div class="section">
        <h3>📋 Logs de Debug</h3>
        <div id="debug-logs"></div>
    </div>

    <!-- Scripts necessários -->  
    <script src="public/suggestion-scorer.js"></script>
    <script src="public/enhanced-suggestion-engine.js"></script>
    <script src="public/ai-suggestion-layer.js"></script>
    
    <script>
        let testLogs = [];
        let testResults = {};
        
        // Interceptar console.log
        const originalLog = console.log;
        console.log = function(...args) {
            const logText = args.join(' ');
            testLogs.push(`${new Date().toISOString()}: ${logText}`);
            if (testLogs.length > 100) testLogs.shift();
            originalLog.apply(console, args);
            updateDebugLogs();
        };
        
        // Interceptar fetch para capturar resposta do backend
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const [url, options] = args;
            
            if (url.includes('/api/suggestions')) {
                console.log('🧪 [TESTE] Interceptando chamada para backend');
                
                return originalFetch.apply(this, args).then(response => {
                    const clonedResponse = response.clone();
                    clonedResponse.json().then(data => {
                        testResults.backendResponse = data;
                        console.log('🧪 [TESTE] Resposta backend capturada:', data);
                        analisarResultados();
                    }).catch(e => console.warn('🧪 [TESTE] Erro ao capturar resposta:', e));
                    return response;
                });
            }
            
            return originalFetch.apply(this, args);
        };
        
        function updateDebugLogs() {
            const debugDiv = document.getElementById('debug-logs');
            const relevantLogs = testLogs.filter(log => 
                log.includes('ENHANCED_ENGINE_VALUES') ||
                log.includes('BANDA_PARA_BACKEND') ||
                log.includes('BACKEND_PREP') ||
                log.includes('PROMPT_PARA_IA') ||
                log.includes('TESTE')
            );
            debugDiv.innerHTML = '<pre>' + relevantLogs.slice(-15).join('\n') + '</pre>';
        }
        
        function testarValoresReais() {
            console.log('🧪 [TESTE] Iniciando teste com valores reais da imagem');
            
            // Dados exatos baseados na sua imagem
            const testAnalysis = {
                spectral_bands: {
                    sub: -28.10,           // Atual da imagem
                    bass: -24.60,          // Atual da imagem  
                    low_mid: -26.70,       // Atual da imagem
                    mid: -31.20,           // Atual da imagem
                    high_mid: -35.40,      // Atual da imagem
                    presence: -38.90,      // Atual da imagem: -38.90 dB
                    air: -44.80            // Atual da imagem
                }
            };
            
            const testReference = {
                bands: {
                    sub: { target_db: -17.30, tol_db: 3.00 },      // Alvo da imagem: -17.30 dB
                    bass: { target_db: -17.70, tol_db: 3.00 },     // Alvo da imagem: -17.70 dB
                    low_mid: { target_db: -18.70, tol_db: 2.50 },  // Alvo da imagem
                    mid: { target_db: -17.90, tol_db: 2.50 },      // Alvo da imagem
                    high_mid: { target_db: -22.90, tol_db: 2.50 }, // Alvo da imagem
                    presence: { target_db: -34.00, tol_db: 3.50 }, // Alvo da imagem: -34.00 dB
                    air: { target_db: -29.30, tol_db: 3.50 }       // Alvo da imagem
                }
            };
            
            // Valores esperados calculados manualmente
            const expectedValues = {
                sub: -10.80,      // -28.10 - (-17.30) = -10.80 dB
                bass: -6.90,      // -24.60 - (-17.70) = -6.90 dB
                low_mid: -8.00,   // -26.70 - (-18.70) = -8.00 dB
                mid: -13.30,      // -31.20 - (-17.90) = -13.30 dB
                high_mid: -12.50, // -35.40 - (-22.90) = -12.50 dB
                presence: -4.90,  // -38.90 - (-34.00) = -4.90 dB (DA SUA IMAGEM!)
                air: -15.50       // -44.80 - (-29.30) = -15.50 dB
            };
            
            // Definir dados globais
            window.PROD_AI_REF_DATA = testReference;
            window.PROD_AI_REF_GENRE = 'funk_mandela';
            
            testResults.expectedValues = expectedValues;
            
            try {
                console.log('🧪 [TESTE] Executando Enhanced Suggestion Engine...');
                
                const engine = new EnhancedSuggestionEngine();
                const result = engine.processAnalysis(testAnalysis, testReference);
                
                testResults.frontendSuggestions = result.suggestions;
                console.log(`🧪 [TESTE] Frontend gerou ${result.suggestions.length} sugestões`);
                
                // Simular envio para backend
                setTimeout(() => {
                    enviarParaBackend(result.suggestions);
                }, 2000);
                
                document.getElementById('test-results').innerHTML = `
                    <div class="info">✅ Frontend processado: ${result.suggestions.length} sugestões geradas</div>
                    <div class="warning">⏳ Enviando para backend...</div>
                `;
                
            } catch (error) {
                console.error('🧪 [TESTE] Erro no frontend:', error);
                document.getElementById('test-results').innerHTML = `
                    <div class="incorrect">❌ Erro no frontend: ${error.message}</div>
                `;
            }
        }
        
        function enviarParaBackend(suggestions) {
            console.log('🧪 [TESTE] Enviando sugestões para backend...');
            
            const payload = {
                suggestions: suggestions,
                metrics: {
                    lufsIntegrated: -14.5,
                    truePeakDbtp: -1.2,
                    dynamicRange: 8.5
                },
                genre: 'funk_mandela'
            };
            
            fetch('/api/suggestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                console.log('🧪 [TESTE] Backend processado com sucesso');
            })
            .catch(error => {
                console.error('🧪 [TESTE] Erro no backend:', error);
                document.getElementById('test-results').innerHTML += `
                    <div class="incorrect">❌ Erro no backend: ${error.message}</div>
                `;
            });
        }
        
        function analisarResultados() {
            if (!testResults.backendResponse || !testResults.expectedValues) {
                return;
            }
            
            const suggestions = testResults.backendResponse.enhancedSuggestions || [];
            const expected = testResults.expectedValues;
            
            let analysisHtml = '<h4>📊 Análise dos Resultados:</h4>';
            let comparisonHtml = '<h4>🔍 Comparação Detalhada:</h4>';
            
            let correctCount = 0;
            let totalCount = 0;
            
            // Analisar cada sugestão
            suggestions.forEach((suggestion, index) => {
                if (suggestion.problema) {
                    totalCount++;
                    
                    // Extrair valor do problema (procurar por padrões como "-4.90 dB" ou "-19 dB")
                    const valorMatch = suggestion.problema.match(/([-+]?\d+\.?\d*)\s*dB/);
                    const valorEncontrado = valorMatch ? parseFloat(valorMatch[1]) : 'N/A';
                    
                    // Identificar banda (procurar por palavras como "Sub", "Bass", "Presença", etc.)
                    let bandaIdentificada = 'unknown';
                    const problemaLower = suggestion.problema.toLowerCase();
                    if (problemaLower.includes('sub')) bandaIdentificada = 'sub';
                    else if (problemaLower.includes('bass')) bandaIdentificada = 'bass';
                    else if (problemaLower.includes('presença') || problemaLower.includes('presence')) bandaIdentificada = 'presence';
                    else if (problemaLower.includes('mid')) bandaIdentificada = 'mid';
                    else if (problemaLower.includes('high')) bandaIdentificada = 'high_mid';
                    else if (problemaLower.includes('air')) bandaIdentificada = 'air';
                    
                    const valorEsperado = expected[bandaIdentificada];
                    const isCorrect = Math.abs(valorEncontrado - valorEsperado) < 0.2; // Tolerância de 0.2 dB
                    
                    if (isCorrect) correctCount++;
                    
                    const cssClass = isCorrect ? 'correct' : 'incorrect';
                    const status = isCorrect ? '✅ CORRETO' : '❌ INCORRETO';
                    
                    comparisonHtml += `
                        <div class="expected-vs-actual">
                            <div class="expected">
                                <strong>ESPERADO (${bandaIdentificada}):</strong><br>
                                ${valorEsperado?.toFixed(1) || 'N/A'} dB
                            </div>
                            <div class="actual">
                                <strong>ATUAL:</strong><br>
                                ${valorEncontrado} dB<br>
                                ${status}
                            </div>
                        </div>
                        <div class="test-result ${cssClass}">
                            <strong>Problema:</strong> ${suggestion.problema}
                        </div>
                    `;
                }
            });
            
            const successRate = totalCount > 0 ? (correctCount / totalCount * 100).toFixed(1) : 0;
            const overallStatus = correctCount === totalCount && totalCount > 0 ? 'correct' : 'incorrect';
            
            analysisHtml += `
                <div class="test-result ${overallStatus}">
                    <strong>Taxa de Sucesso:</strong> ${correctCount}/${totalCount} (${successRate}%)<br>
                    <strong>Sugestões processadas:</strong> ${suggestions.length}<br>
                    <strong>Valores fictícios eliminados:</strong> ${correctCount === totalCount ? '✅ SIM' : '❌ NÃO'}
                </div>
            `;
            
            document.getElementById('test-results').innerHTML = analysisHtml;
            document.getElementById('comparison-results').innerHTML = comparisonHtml;
        }
        
        function limparResultados() {
            testLogs = [];
            testResults = {};
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('comparison-results').innerHTML = '';
            document.getElementById('debug-logs').innerHTML = '';
        }
    </script>
</body>
</html>