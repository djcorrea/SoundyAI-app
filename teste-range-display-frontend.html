<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste: Range Display Frontend</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
        .test-section { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #fd7e14; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .result { background: #ffffff; padding: 10px; margin: 5px 0; border-left: 4px solid #007bff; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border: 1px solid #dee2e6; }
        th { background-color: #e9ecef; }
        .mock-table { max-width: 600px; margin: 20px 0; }
        .tol { font-size: 10px; opacity: 0.7; margin-left: 4px; }
        .ok { background-color: #d4edda; color: #155724; }
        .yellow { background-color: #fff3cd; color: #856404; }
        .warn { background-color: #f8d7da; color: #721c24; }
        .na { background-color: #f8f9fa; color: #6c757d; }
    </style>
</head>
<body>
    <h1>üß™ Teste: Range Display Frontend</h1>
    <p><strong>Objetivo:</strong> Verificar se a exibi√ß√£o de ranges na tabela de refer√™ncia est√° funcionando corretamente.</p>

    <div class="test-section">
        <h2>üìä Simula√ß√£o da Tabela de Refer√™ncia</h2>
        <p>Simulando como as diferentes configura√ß√µes de target aparecem na tabela:</p>
        
        <table class="mock-table">
            <thead>
                <tr>
                    <th>M√©trica</th>
                    <th>Valor Medido</th>
                    <th>Alvo</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="mockTableBody">
                <!-- Ser√° preenchido pelo JavaScript -->
            </tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>üîç Teste da Fun√ß√£o pushRow</h2>
        <div id="pushRowTests"></div>
    </div>

    <div class="test-section">
        <h2>üíæ Dados JSON de Exemplo</h2>
        <div id="jsonExamples"></div>
    </div>

    <script>
        // Simular a fun√ß√£o nf (number format)
        const nf = (n, d = 2) => Number.isFinite(n) ? n.toFixed(d) : '‚Äî';

        // Simular a fun√ß√£o pushRow do sistema real
        function mockPushRow(label, val, target, tol, unit = '') {
            const addedLabels = new Set(); // Simular controle de duplicatas
            const rows = []; // Array para armazenar as linhas
            
            // Simular verifica√ß√£o de duplicatas
            if (addedLabels.has(label)) {
                console.warn(`‚ö†Ô∏è Duplicata evitada: ${label}`);
                return null;
            }
            addedLabels.add(label);
            
            // Tratar target null ou NaN como N/A explicitamente
            const targetIsNA = (target == null || target === '' || (typeof target === 'number' && !Number.isFinite(target)));
            if (!Number.isFinite(val) && targetIsNA) return null; // nada √∫til
            
            if (targetIsNA) {
                return `<tr>
                    <td>${label}</td>
                    <td>${Number.isFinite(val) ? nf(val) + unit : '‚Äî'}</td>
                    <td colspan="2" style="opacity:.55">N/A</td>
                </tr>`;
            }
            
            // üéØ NOVO: C√°lculo de diferen√ßa h√≠brido para targets fixos e ranges
            let diff = null;
            
            if (typeof target === 'object' && target !== null && 
                Number.isFinite(target.min) && Number.isFinite(target.max) && Number.isFinite(val)) {
                // Target √© um range: calcular dist√¢ncia do range
                if (val >= target.min && val <= target.max) {
                    // Dentro do range: diferen√ßa zero (ideal)
                    diff = 0;
                } else if (val < target.min) {
                    // Abaixo do range: diferen√ßa negativa
                    diff = val - target.min;
                } else {
                    // Acima do range: diferen√ßa positiva
                    diff = val - target.max;
                }
            } else if (Number.isFinite(val) && Number.isFinite(target)) {
                // Target fixo: diferen√ßa tradicional
                diff = val - target;
            }
            
            // üéØ CORRE√á√ÉO: Mostrar apenas status visual (n√£o valores num√©ricos)
            let diffCell;
            if (!Number.isFinite(diff) || !Number.isFinite(tol) || tol <= 0) {
                diffCell = '<td class="na" style="text-align: center;"><span style="opacity: 0.6;">‚Äî</span></td>';
            } else {
                const absDiff = Math.abs(diff);
                let cssClass, statusText;
                
                // Mesma l√≥gica de limites do sistema unificado
                if (absDiff <= tol) {
                    // ‚úÖ ZONA IDEAL
                    cssClass = 'ok';
                    statusText = 'Ideal';
                } else {
                    const multiplicador = absDiff / tol;
                    if (multiplicador <= 2) {
                        // ‚ö†Ô∏è ZONA AJUSTAR
                        cssClass = 'yellow';
                        statusText = 'Ajuste leve';
                    } else {
                        // ‚ùå ZONA CORRIGIR
                        cssClass = 'warn';
                        statusText = 'Corrigir';
                    }
                }
                
                diffCell = `<td class="${cssClass}" style="text-align: center; padding: 8px;">
                    <div style="font-size: 12px; font-weight: 600;">${statusText}</div>
                </td>`;
            }
            
            // üéØ NOVO: Renderiza√ß√£o h√≠brida para targets fixos e ranges
            let targetDisplay;
            
            if (typeof target === 'object' && target !== null && 
                Number.isFinite(target.min) && Number.isFinite(target.max)) {
                // Target √© um range: exibir "min dB a max dB"
                targetDisplay = `${nf(target.min)}${unit} a ${nf(target.max)}${unit}`;
            } else if (Number.isFinite(target)) {
                // Target √© um valor fixo: exibir "valor dB"
                targetDisplay = `${nf(target)}${unit}`;
            } else {
                // Target n√£o definido
                targetDisplay = 'N/A';
            }
            
            // Adicionar toler√¢ncia se dispon√≠vel (apenas para targets fixos)
            const tolDisplay = (typeof target !== 'object' && tol != null) ? 
                `<span class="tol">¬±${nf(tol,2)}</span>` : '';
            
            return `<tr>
                <td>${label}</td>
                <td>${Number.isFinite(val) ? nf(val) + unit : '‚Äî'}</td>
                <td>${targetDisplay}${tolDisplay}</td>
                ${diffCell}
            </tr>`;
        }

        // Casos de teste
        const testCases = [
            {
                label: 'LUFS Integrado',
                val: -14.2,
                target: -14,
                tol: 1.0,
                unit: ' LUFS',
                description: 'Target fixo tradicional'
            },
            {
                label: 'Sub (20‚Äì60Hz)',
                val: -28.5,
                target: { min: -34, max: -22 },
                tol: 3.0,
                unit: ' dB',
                description: 'Range novo sistema - valor dentro'
            },
            {
                label: 'Bass (60‚Äì150Hz)',
                val: -18.0,
                target: { min: -32, max: -21 },
                tol: 3.0,
                unit: ' dB',
                description: 'Range novo sistema - valor acima'
            },
            {
                label: 'Mid (500‚Äì2kHz)',
                val: -36.0,
                target: { min: -34, max: -28 },
                tol: 3.0,
                unit: ' dB',
                description: 'Range novo sistema - valor abaixo'
            },
            {
                label: 'True Peak',
                val: -0.8,
                target: -1,
                tol: 0.5,
                unit: ' dBTP',
                description: 'Target fixo tradicional'
            },
            {
                label: 'M√©trica Sem Target',
                val: 123.45,
                target: null,
                tol: null,
                unit: '',
                description: 'M√©trica sem refer√™ncia'
            }
        ];

        // Preencher tabela mock
        function populateMockTable() {
            const tbody = document.getElementById('mockTableBody');
            let html = '';
            
            testCases.forEach(testCase => {
                const row = mockPushRow(testCase.label, testCase.val, testCase.target, testCase.tol, testCase.unit);
                if (row) {
                    html += row;
                }
            });
            
            tbody.innerHTML = html;
        }

        // Testar fun√ß√£o pushRow
        function testPushRowFunction() {
            const output = document.getElementById('pushRowTests');
            let html = '<h3>Resultados dos Testes:</h3>';
            
            testCases.forEach((testCase, index) => {
                const result = mockPushRow(testCase.label, testCase.val, testCase.target, testCase.tol, testCase.unit);
                const status = result ? '‚úÖ Sucesso' : '‚ùå Falhou';
                
                html += `
                    <div class="result">
                        <strong>Teste ${index + 1}:</strong> ${testCase.description}<br>
                        <strong>Status:</strong> ${status}<br>
                        <strong>Input:</strong> val=${testCase.val}, target=${JSON.stringify(testCase.target)}, tol=${testCase.tol}<br>
                        ${result ? `<strong>Output:</strong> HTML gerado corretamente` : '<strong>Output:</strong> Nenhum HTML gerado'}
                    </div>
                `;
            });
            
            output.innerHTML = html;
        }

        // Mostrar exemplos JSON
        function showJSONExamples() {
            const output = document.getElementById('jsonExamples');
            
            const examples = {
                "Target Fixo (Sistema Antigo)": {
                    "sub": {
                        "target_db": -28,
                        "tol_db": 3.0
                    }
                },
                "Target Range (Sistema Novo)": {
                    "sub": {
                        "target_db": -28,
                        "target_range": {
                            "min": -34,
                            "max": -22
                        },
                        "tol_db": 3.0
                    }
                },
                "Backend Response (Range)": {
                    "target": {
                        "min": -32,
                        "max": -24
                    }
                },
                "Backend Response (Fixo)": {
                    "target": -28
                }
            };
            
            let html = '<h3>Exemplos de Estrutura JSON:</h3>';
            
            Object.entries(examples).forEach(([title, data]) => {
                html += `
                    <div class="result">
                        <strong>${title}:</strong>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 5px 0;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            });
            
            output.innerHTML = html;
        }

        // Executar todos os testes
        document.addEventListener('DOMContentLoaded', function() {
            populateMockTable();
            testPushRowFunction();
            showJSONExamples();
        });
    </script>
</body>
</html>