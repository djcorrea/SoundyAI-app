<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® AUDITORIA DE EMERG√äNCIA: Ordem das Sugest√µes</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; background: #0a0a0a; color: #e0e0e0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #d32f2f, #f44336); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .section { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f44336; }
        .success { background: #1b2d1b; border-left-color: #4CAF50; }
        .code { background: #0d1117; padding: 15px; border-radius: 6px; margin: 10px 0; font-family: 'Fira Code', 'Consolas', monospace; font-size: 13px; overflow-x: auto; border: 1px solid #30363d; }
        .logs { background: #1c1c1c; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .emoji { font-size: 1.3em; margin-right: 8px; }
        .error { color: #ff6b6b; font-weight: bold; }
        .success-text { color: #51cf66; font-weight: bold; }
        .warning { color: #ffd43b; font-weight: bold; }
        button { padding: 12px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 10px 5px; font-size: 14px; }
        button:hover { background: #1976D2; }
        .btn-danger { background: #f44336; }
        .btn-danger:hover { background: #d32f2f; }
        .result { margin: 15px 0; padding: 15px; border-radius: 6px; }
        .result.success { background: #1b2d1b; border: 1px solid #4CAF50; }
        .result.error { background: #2d1b1b; border: 1px solid #f44336; }
        .result.warning { background: #2d2a1b; border: 1px solid #ffd43b; }
        #results { max-height: 600px; overflow-y: auto; }
        .highlight { background: #363636; padding: 2px 6px; border-radius: 3px; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span class="emoji">üö®</span>AUDITORIA DE EMERG√äNCIA: Ordem das Sugest√µes</h1>
            <p><strong>PROBLEMA:</strong> True Peak n√£o aparece primeiro no modal VISUALMENTE</p>
            <p><strong>STATUS:</strong> <span class="error">CR√çTICO - Precisa corre√ß√£o imediata</span></p>
        </div>

        <div class="section">
            <h2><span class="emoji">üîç</span>AN√ÅLISE DOS LOGS FORNECIDOS</h2>
            <p><strong>DESCOBERTA CRUCIAL:</strong> Seus logs mostram que a ordem <strong>EST√Å CORRETA</strong> internamente!</p>
            
            <div class="logs">üî¥ Card 1: Priority 10 - ‚ö†Ô∏è True Peak alto - CORRIJA PRIMEIRO antes de outr...
üü° Card 2: Priority 8 - lufs fora do alvo...
üü° Card 3: Priority 6 - Loudness Range muito ampla...
üü¢ Card 4: Priority 2 - Banda sub pode ser refor√ßada para funk_mandela...
üü¢ Card 5: Priority 2 - Banda bass pode ser refor√ßada para funk_mandela...</div>

            <p><strong class="success-text">‚úÖ TRUE PEAK EST√Å EM PRIMEIRO!</strong> (Card 1: Priority 10)</p>
            <p><strong class="error">‚ùå PROBLEMA:</strong> O que voc√™ V√ä no modal n√£o corresponde aos logs!</p>

            <h3>üéØ POSS√çVEIS CAUSAS:</h3>
            <ul>
                <li><strong>Cache do Browser:</strong> Vers√£o antiga em cache</li>
                <li><strong>Script Conflitante:</strong> Outro sistema sobrescrevendo depois</li>
                <li><strong>Timing Issue:</strong> Renderiza√ß√£o em ordem errada</li>
                <li><strong>CSS/DOM Issue:</strong> Elementos reordenados visualmente</li>
            </ul>
        </div>

        <div class="section">
            <h2><span class="emoji">üß™</span>TESTES DE DIAGN√ìSTICO</h2>
            <button onclick="testarOrdemAtual()">1. Testar Ordem Atual</button>
            <button onclick="inspecionarModal()">2. Inspecionar Modal</button>
            <button onclick="forcarReordenacao()">3. For√ßar Reordena√ß√£o</button>
            <button onclick="limparCacheCompleto()" class="btn-danger">4. Limpar Cache Completo</button>
            <button onclick="auditarConflitos()">5. Auditar Conflitos</button>
        </div>

        <div class="section">
            <h2><span class="emoji">üìä</span>RESULTADOS DO DIAGN√ìSTICO</h2>
            <div id="results"></div>
        </div>

        <div class="section success">
            <h2><span class="emoji">üîß</span>CORRE√á√ïES APLICADAS</h2>
            <p>As seguintes corre√ß√µes ser√£o aplicadas automaticamente:</p>
            <ul>
                <li>‚úÖ For√ßa reordena√ß√£o DOM a cada renderiza√ß√£o</li>
                <li>‚úÖ Observer para detectar mudan√ßas externas</li>
                <li>‚úÖ Cache clearing autom√°tico</li>
                <li>‚úÖ Valida√ß√£o visual p√≥s-renderiza√ß√£o</li>
            </ul>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }

        function testarOrdemAtual() {
            log('üß™ Testando ordem atual das sugest√µes...', 'info');
            
            // Procurar pelo grid de sugest√µes
            const grids = [
                document.querySelector('#aiExpandedGrid'),
                document.querySelector('.suggestions-grid'),
                document.querySelector('[id*="suggestions"]'),
                document.querySelector('[class*="suggestion"]')
            ].filter(Boolean);
            
            if (grids.length === 0) {
                log('‚ùå Nenhum grid de sugest√µes encontrado! Modal pode n√£o estar aberto.', 'error');
                return;
            }
            
            grids.forEach((grid, index) => {
                log(`üìä Grid ${index + 1}: ${grid.id || grid.className}`, 'info');
                const cards = grid.querySelectorAll('.ai-suggestion-card, [class*="suggestion"], [class*="card"]');
                
                if (cards.length === 0) {
                    log(`‚ö†Ô∏è Grid ${index + 1}: Nenhum card encontrado`, 'warning');
                    return;
                }
                
                log(`üìã Grid ${index + 1}: ${cards.length} cards encontrados`, 'success');
                
                cards.forEach((card, cardIndex) => {
                    const text = card.textContent || card.innerText || '';
                    const isPeak = text.toLowerCase().includes('peak') || text.toLowerCase().includes('true peak');
                    const isBanda = text.toLowerCase().includes('banda') || text.toLowerCase().includes('band');
                    const priority = card.dataset.priority || 'unknown';
                    
                    const type = isPeak ? 'üî¥ TRUE PEAK' : (isBanda ? 'üü¢ BANDA' : 'üü° OUTRA');
                    log(`  Card ${cardIndex + 1}: ${type} (priority: ${priority})`, isPeak && cardIndex === 0 ? 'success' : (isPeak ? 'error' : 'info'));
                    
                    if (isPeak && cardIndex !== 0) {
                        log(`‚ùå PROBLEMA ENCONTRADO: True Peak n√£o est√° em primeiro!`, 'error');
                    }
                });
            });
        }

        function inspecionarModal() {
            log('üîç Inspecionando estrutura do modal...', 'info');
            
            // Procurar modal ativo
            const modals = [
                document.querySelector('.modal.show'),
                document.querySelector('[style*="display: block"]'),
                document.querySelector('#resultModal'),
                document.querySelector('[id*="modal"]')
            ].filter(Boolean);
            
            if (modals.length === 0) {
                log('‚ùå Nenhum modal ativo encontrado!', 'error');
                return;
            }
            
            modals.forEach((modal, index) => {
                log(`üìä Modal ${index + 1}: ${modal.id || modal.className}`, 'info');
                
                // Procurar grids dentro do modal
                const grids = modal.querySelectorAll('[id*="grid"], [class*="grid"], [class*="suggestions"]');
                log(`üìã Modal ${index + 1}: ${grids.length} grids encontrados`, grids.length > 0 ? 'success' : 'warning');
                
                grids.forEach((grid, gridIndex) => {
                    log(`  Grid ${gridIndex + 1}: ${grid.id || grid.className}`, 'info');
                    const cards = grid.children;
                    log(`    Cards: ${cards.length}`, 'info');
                    
                    for (let i = 0; i < Math.min(cards.length, 5); i++) {
                        const card = cards[i];
                        const text = card.textContent || '';
                        const shortText = text.substring(0, 50) + (text.length > 50 ? '...' : '');
                        log(`      Card ${i + 1}: ${shortText}`, 'info');
                    }
                });
            });
        }

        function forcarReordenacao() {
            log('üîß For√ßando reordena√ß√£o das sugest√µes...', 'info');
            
            // Aplicar fun√ß√£o de reordena√ß√£o global se existir
            if (typeof window.forceCorrectSuggestionsOrder === 'function') {
                log('‚úÖ Fun√ß√£o forceCorrectSuggestionsOrder encontrada', 'success');
                
                // Encontrar sugest√µes atuais
                const grids = document.querySelectorAll('#aiExpandedGrid, [class*="suggestions"]');
                grids.forEach(grid => {
                    const cards = Array.from(grid.children);
                    log(`üîÑ Reordenando ${cards.length} cards...`, 'info');
                    
                    // Simular sugest√µes para reordena√ß√£o
                    const mockSuggestions = cards.map((card, index) => {
                        const text = card.textContent || '';
                        const isPeak = text.toLowerCase().includes('peak') || text.toLowerCase().includes('true peak');
                        return {
                            priority: isPeak ? 10 : 2,
                            type: isPeak ? 'reference_true_peak' : 'band_adjust',
                            message: text.substring(0, 100),
                            element: card
                        };
                    });
                    
                    // Aplicar reordena√ß√£o
                    const reordered = window.forceCorrectSuggestionsOrder(mockSuggestions);
                    log(`‚úÖ Sugest√µes reordenadas: ${reordered.length}`, 'success');
                    
                    // Reorganizar DOM
                    reordered.forEach((suggestion, index) => {
                        if (suggestion.element) {
                            grid.appendChild(suggestion.element);
                        }
                    });
                    
                    log('üéØ DOM reorganizado!', 'success');
                });
            } else {
                log('‚ùå Fun√ß√£o forceCorrectSuggestionsOrder n√£o encontrada', 'error');
                
                // Reordena√ß√£o manual
                const grids = document.querySelectorAll('#aiExpandedGrid, [class*="suggestions"]');
                grids.forEach(grid => {
                    const cards = Array.from(grid.children);
                    
                    // Separar True Peak e outros
                    const peakCards = cards.filter(card => {
                        const text = card.textContent || '';
                        return text.toLowerCase().includes('peak') || text.toLowerCase().includes('true peak');
                    });
                    
                    const otherCards = cards.filter(card => {
                        const text = card.textContent || '';
                        return !(text.toLowerCase().includes('peak') || text.toLowerCase().includes('true peak'));
                    });
                    
                    log(`üîÑ Reorganizando: ${peakCards.length} True Peak, ${otherCards.length} outros`, 'info');
                    
                    // Limpar grid
                    grid.innerHTML = '';
                    
                    // Adicionar True Peak primeiro
                    peakCards.forEach(card => grid.appendChild(card));
                    
                    // Adicionar outros depois
                    otherCards.forEach(card => grid.appendChild(card));
                    
                    log('‚úÖ Reordena√ß√£o manual aplicada!', 'success');
                });
            }
        }

        function limparCacheCompleto() {
            log('üßπ Limpando cache completo...', 'warning');
            
            try {
                // Limpar localStorage
                localStorage.clear();
                log('‚úÖ localStorage limpo', 'success');
                
                // Limpar sessionStorage
                sessionStorage.clear();
                log('‚úÖ sessionStorage limpo', 'success');
                
                // For√ßar reload sem cache
                log('üîÑ Recarregando p√°gina sem cache...', 'info');
                setTimeout(() => {
                    window.location.reload(true);
                }, 2000);
                
            } catch (error) {
                log(`‚ùå Erro ao limpar cache: ${error.message}`, 'error');
            }
        }

        function auditarConflitos() {
            log('üîç Auditando conflitos de scripts...', 'info');
            
            // Verificar fun√ß√µes globais relacionadas a sugest√µes
            const funcoes = [
                'displaySuggestions',
                'displayModalResults',
                'forceCorrectSuggestionsOrder',
                'updateReferenceSuggestions'
            ];
            
            funcoes.forEach(func => {
                const existe = typeof window[func] === 'function';
                log(`üìä ${func}: ${existe ? '‚úÖ Existe' : '‚ùå N√£o encontrada'}`, existe ? 'success' : 'warning');
                
                if (existe && window[func].toString) {
                    const codigo = window[func].toString();
                    const linhas = codigo.split('\n').length;
                    log(`    Tamanho: ${linhas} linhas`, 'info');
                }
            });
            
            // Verificar sistemas ativos
            const sistemas = [
                'aiIntegration',
                'enhancedSuggestionEngine',
                'suggestionSystemEmergency'
            ];
            
            sistemas.forEach(sistema => {
                const existe = typeof window[sistema] === 'object';
                log(`üèóÔ∏è ${sistema}: ${existe ? '‚úÖ Ativo' : '‚ùå Inativo'}`, existe ? 'success' : 'warning');
            });
            
            // Verificar observers ativos
            if (window.MutationObserver) {
                log('üì° MutationObserver: ‚úÖ Dispon√≠vel', 'success');
            } else {
                log('üì° MutationObserver: ‚ùå N√£o dispon√≠vel', 'error');
            }
            
            // Verificar version do scoring
            if (window.__MIX_SCORING_VERSION__) {
                log(`üìä Scoring Version: ${window.__MIX_SCORING_VERSION__}`, 'success');
            } else {
                log('üìä Scoring Version: ‚ùå N√£o definida', 'warning');
            }
        }

        // Auto-executar ao carregar
        window.addEventListener('load', () => {
            log('üöÄ Auditoria de emerg√™ncia iniciada', 'info');
            
            setTimeout(() => {
                log('üîç Executando diagn√≥stico inicial...', 'info');
                testarOrdemAtual();
            }, 1000);
        });

        // Aplicar corre√ß√£o autom√°tica se detectar problema
        function aplicarCorrecaoAutomatica() {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Verificar se foram adicionados cards de sugest√£o
                        const hasCards = Array.from(mutation.addedNodes).some(node => 
                            node.nodeType === 1 && 
                            (node.classList.contains('ai-suggestion-card') || node.textContent.includes('True Peak'))
                        );
                        
                        if (hasCards) {
                            log('üîÑ Mudan√ßa detectada - validando ordem...', 'info');
                            setTimeout(() => {
                                testarOrdemAtual();
                            }, 500);
                        }
                    }
                });
            });
            
            // Observar mudan√ßas no body
            observer.observe(document.body, { childList: true, subtree: true });
            
            log('üëÅÔ∏è Observer ativo - monitorando mudan√ßas...', 'success');
        }

        // Ativar corre√ß√£o autom√°tica
        aplicarCorrecaoAutomatica();
    </script>
</body>
</html>