<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste True Peak - R√°pido</title>
    <style>
        body { 
            background: #0a0a0a; color: #00ff92; font-family: 'Courier New'; 
            padding: 20px; line-height: 1.6; 
        }
        .container { max-width: 800px; margin: 0 auto; }
        .success { color: #00ff92; }
        .warning { color: #ffa500; }
        .error { color: #ff4444; }
        .info { color: #4da6ff; }
        pre { 
            background: #1a1a1a; padding: 15px; border-radius: 5px; 
            border-left: 4px solid #00ff92; overflow-x: auto; 
        }
        button {
            background: #00ff92; color: #0a0a0a; border: none; 
            padding: 12px 24px; border-radius: 5px; cursor: pointer; 
            font-weight: bold; margin: 10px 5px;
        }
        button:hover { background: #00cc77; }
        .progress {
            width: 100%; height: 6px; background: #333; border-radius: 3px; 
            margin: 10px 0; overflow: hidden;
        }
        .progress-bar {
            height: 100%; background: #00ff92; width: 0%; 
            transition: width 0.3s ease;
        }
        #results { margin-top: 20px; }
        .status { 
            display: inline-block; padding: 5px 10px; border-radius: 3px; 
            margin: 5px 0; font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste True Peak - Diagn√≥stico R√°pido</h1>
        <p class="info">Este teste vai verificar se o True Peak est√° funcionando corretamente na SoundyAI.</p>
        
        <div>
            <button onclick="testarTruePeak()">üöÄ Testar True Peak</button>
            <button onclick="limparLogs()">üßπ Limpar Logs</button>
        </div>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div id="status"></div>
        <div id="results"></div>
        <pre id="logs"></pre>
    </div>

    <script>
        let logContainer = document.getElementById('logs');
        let statusContainer = document.getElementById('status');
        let resultsContainer = document.getElementById('results');
        let progressBar = document.getElementById('progressBar');

        function log(message, type = 'info') {
            const colors = {
                'success': '#00ff92',
                'warning': '#ffa500', 
                'error': '#ff4444',
                'info': '#4da6ff'
            };
            
            const timestamp = new Date().toLocaleTimeString();
            const coloredMessage = `<span style="color: ${colors[type] || '#4da6ff'}">[${timestamp}] ${message}</span>`;
            logContainer.innerHTML += coloredMessage + '\n';
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function setStatus(message, type = 'info') {
            statusContainer.innerHTML = `<span class="status ${type}">${message}</span>`;
        }

        function setProgress(percent) {
            progressBar.style.width = percent + '%';
        }

        function limparLogs() {
            logContainer.innerHTML = '';
            resultsContainer.innerHTML = '';
            statusContainer.innerHTML = '';
            setProgress(0);
        }

        async function testarTruePeak() {
            limparLogs();
            setStatus('üîç Iniciando teste...', 'info');
            setProgress(10);

            try {
                log('üéØ Iniciando teste de True Peak', 'info');
                log('1Ô∏è‚É£ Verificando se SoundyAI est√° rodando...', 'info');
                setProgress(20);

                // Testar se SoundyAI est√° acess√≠vel
                try {
                    const response = await fetch('http://localhost:3000/index.html');
                    if (response.ok) {
                        log('‚úÖ SoundyAI est√° acess√≠vel em localhost:3000', 'success');
                    } else {
                        log('‚ùå SoundyAI n√£o est√° respondendo corretamente', 'error');
                        return;
                    }
                } catch (error) {
                    log('‚ùå Erro ao conectar com SoundyAI: ' + error.message, 'error');
                    log('üí° Certifique-se de que o servidor est√° rodando com: python -m http.server 3000', 'warning');
                    return;
                }

                setProgress(40);
                log('2Ô∏è‚É£ Verificando implementa√ß√£o do True Peak...', 'info');

                // Testar carregamento dos m√≥dulos True Peak
                try {
                    const moduleTruePeak = await import('/work/lib/audio/features/truepeak.js');
                    log('‚úÖ M√≥dulo truepeak.js carregado com sucesso', 'success');
                    
                    if (moduleTruePeak.analyzeTruePeaks) {
                        log('‚úÖ Fun√ß√£o analyzeTruePeaks encontrada', 'success');
                    } else {
                        log('‚ùå Fun√ß√£o analyzeTruePeaks n√£o encontrada', 'error');
                    }

                    if (moduleTruePeak.getTruePeakFromFFmpeg) {
                        log('‚úÖ Fun√ß√£o getTruePeakFromFFmpeg encontrada', 'success');
                    } else {
                        log('‚ùå Fun√ß√£o getTruePeakFromFFmpeg n√£o encontrada', 'error');
                    }

                } catch (error) {
                    log('‚ùå Erro ao carregar m√≥dulo truepeak.js: ' + error.message, 'error');
                }

                setProgress(60);
                log('3Ô∏è‚É£ Verificando core-metrics...', 'info');

                try {
                    const coreMetricsModule = await import('/work/api/audio/core-metrics.js');
                    log('‚úÖ M√≥dulo core-metrics.js carregado com sucesso', 'success');
                    
                    if (coreMetricsModule.calculateCoreMetrics) {
                        log('‚úÖ Fun√ß√£o calculateCoreMetrics encontrada', 'success');
                    } else {
                        log('‚ùå Fun√ß√£o calculateCoreMetrics n√£o encontrada', 'error');
                    }

                } catch (error) {
                    log('‚ùå Erro ao carregar core-metrics.js: ' + error.message, 'error');
                }

                setProgress(80);
                log('4Ô∏è‚É£ Verificando frontend integration...', 'info');

                try {
                    const response = await fetch('/public/audio-analyzer-integration.js');
                    const frontendCode = await response.text();
                    
                    if (frontendCode.includes('truePeakDbtp')) {
                        log('‚úÖ Frontend tem refer√™ncias a truePeakDbtp', 'success');
                    } else {
                        log('‚ùå Frontend n√£o tem refer√™ncias a truePeakDbtp', 'error');
                    }

                    if (frontendCode.includes('TRUE PEAK (FFmpeg)')) {
                        log('‚úÖ Frontend tem interface para True Peak FFmpeg', 'success');
                    } else {
                        log('‚ùå Frontend n√£o tem interface para True Peak FFmpeg', 'error');
                    }

                } catch (error) {
                    log('‚ùå Erro ao verificar frontend: ' + error.message, 'error');
                }

                setProgress(100);
                setStatus('‚úÖ Teste conclu√≠do!', 'success');
                
                resultsContainer.innerHTML = `
                    <h3>üìä Resumo do Teste:</h3>
                    <p class="success">‚úÖ Se todos os itens acima est√£o verdes, o True Peak deve estar funcionando!</p>
                    <p class="info">üí° Para testar na pr√°tica:</p>
                    <ol>
                        <li>Abra <a href="http://localhost:3000" target="_blank" style="color: #00ff92;">http://localhost:3000</a></li>
                        <li>Abra o console do navegador (F12)</li>
                        <li>Fa√ßa upload de um arquivo de √°udio</li>
                        <li>Procure por logs com "üéØ [GETMETRIC DEBUG TRUEPEAK]"</li>
                        <li>Verifique se o True Peak aparece como valor num√©rico (n√£o "‚è≥ Calculando...")</li>
                    </ol>
                `;

                log('üéØ Teste de True Peak conclu√≠do!', 'success');

            } catch (error) {
                log('‚ùå Erro durante o teste: ' + error.message, 'error');
                setStatus('‚ùå Teste falhou', 'error');
                setProgress(0);
            }
        }

        // Auto-executar quando a p√°gina carrega
        window.addEventListener('load', () => {
            log('üöÄ P√°gina de teste carregada. Clique em "Testar True Peak" para come√ßar.', 'info');
        });
    </script>
</body>
</html>