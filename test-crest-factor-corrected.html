<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Crest Factor Corrigido</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #e0e0e0; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: #2a2a2a; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; }
        .error { border-left-color: #f44336; }
        .warning { border-left-color: #ff9800; }
        .result { background: #333; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; }
        .success { color: #4CAF50; }
        .error-text { color: #f44336; }
        .warning-text { color: #ff9800; }
        button { padding: 10px 20px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        .progress { width: 100%; background: #333; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 20px; background: #4CAF50; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎚️ Teste Crest Factor Corrigido</h1>
        <p>Teste para validar se o Crest Factor agora usa True Peak (dBTP) corretamente</p>

        <div class="test-section">
            <h2>📊 Teste 1: Sinusoidal Pura (Esperado: ~3.0 dB)</h2>
            <p>Uma sinusoidal pura deve ter Crest Factor próximo a 3.01 dB (teoria: 20*log10(√2) ≈ 3.01)</p>
            <button onclick="testSinusoidal()">Executar Teste Sinusoidal</button>
            <div id="sine-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>📊 Teste 2: Ruído Branco (Esperado: ~12-15 dB)</h2>
            <p>Ruído branco tem distribuição gaussiana, crest factor típico entre 12-15 dB</p>
            <button onclick="testWhiteNoise()">Executar Teste Ruído Branco</button>
            <div id="noise-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>📊 Teste 3: Impulso (Esperado: >20 dB)</h2>
            <p>Impulso isolado deve ter crest factor muito alto (>20 dB)</p>
            <button onclick="testImpulse()">Executar Teste Impulso</button>
            <div id="impulse-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>📊 Teste 4: Comparação Sample Peak vs True Peak</h2>
            <p>Demonstrar diferença entre usar Sample Peak e True Peak no cálculo</p>
            <button onclick="testComparison()">Executar Comparação</button>
            <div id="comparison-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>📋 Resumo dos Resultados</h2>
            <div id="summary" class="result"></div>
        </div>
    </div>

    <script src="public/audio-analyzer.js"></script>
    <script>
        let testResults = [];
        const analyzer = new AudioAnalyzer();

        // Função para gerar sinusoidal pura
        function generateSineWave(frequency = 1000, duration = 1, sampleRate = 48000, amplitude = 0.5) {
            const samples = Math.floor(duration * sampleRate);
            const audioBuffer = new AudioContext().createBuffer(2, samples, sampleRate);
            const leftChannel = audioBuffer.getChannelData(0);
            const rightChannel = audioBuffer.getChannelData(1);
            
            for (let i = 0; i < samples; i++) {
                const t = i / sampleRate;
                const sample = amplitude * Math.sin(2 * Math.PI * frequency * t);
                leftChannel[i] = sample;
                rightChannel[i] = sample;
            }
            
            return audioBuffer;
        }

        // Função para gerar ruído branco
        function generateWhiteNoise(duration = 1, sampleRate = 48000, amplitude = 0.3) {
            const samples = Math.floor(duration * sampleRate);
            const audioBuffer = new AudioContext().createBuffer(2, samples, sampleRate);
            const leftChannel = audioBuffer.getChannelData(0);
            const rightChannel = audioBuffer.getChannelData(1);
            
            for (let i = 0; i < samples; i++) {
                const sample = amplitude * (Math.random() * 2 - 1);
                leftChannel[i] = sample;
                rightChannel[i] = sample;
            }
            
            return audioBuffer;
        }

        // Função para gerar impulso
        function generateImpulse(duration = 1, sampleRate = 48000) {
            const samples = Math.floor(duration * sampleRate);
            const audioBuffer = new AudioContext().createBuffer(2, samples, sampleRate);
            const leftChannel = audioBuffer.getChannelData(0);
            const rightChannel = audioBuffer.getChannelData(1);
            
            // Impulso no meio
            const impulsePosition = Math.floor(samples / 2);
            leftChannel[impulsePosition] = 0.8;
            rightChannel[impulsePosition] = 0.8;
            
            return audioBuffer;
        }

        // Simular True Peak para testes (aproximação)
        function simulateTruePeak(channelData) {
            let maxSample = 0;
            for (let i = 0; i < channelData.length; i++) {
                const abs = Math.abs(channelData[i]);
                if (abs > maxSample) maxSample = abs;
            }
            
            // Simular True Peak sendo ~0.5-2 dB maior que Sample Peak
            const samplePeakDb = 20 * Math.log10(maxSample);
            const truePeakDb = samplePeakDb + (Math.random() * 1.5 + 0.5); // +0.5 a +2.0 dB
            
            return truePeakDb;
        }

        async function testSinusoidal() {
            const resultDiv = document.getElementById('sine-result');
            resultDiv.innerHTML = 'Testando sinusoidal pura...';
            
            try {
                const audioBuffer = generateSineWave(1000, 1, 48000, 0.5);
                const leftChannel = audioBuffer.getChannelData(0);
                
                // Simular True Peak
                const truePeakDbtp = simulateTruePeak(leftChannel);
                
                // Calcular Crest Factor com Sample Peak
                const crestSample = analyzer.calculateCrestFactor(leftChannel);
                
                // Calcular Crest Factor com True Peak
                const crestTrue = analyzer.calculateCrestFactor(leftChannel, truePeakDbtp);
                
                const expected = 3.01; // Valor teórico
                const toleranceSample = Math.abs(crestSample - expected);
                const toleranceTrue = Math.abs(crestTrue - expected);
                
                const result = {
                    test: 'Sinusoidal',
                    expected: expected,
                    samplePeak: crestSample,
                    truePeak: crestTrue,
                    toleranceSample: toleranceSample,
                    toleranceTrue: toleranceTrue,
                    status: toleranceTrue < 0.5 ? 'PASS' : 'FAIL'
                };
                
                testResults.push(result);
                
                resultDiv.innerHTML = `
                    <strong>Resultados Sinusoidal (1kHz, 0.5 amplitude):</strong><br>
                    📐 Valor teórico esperado: ${expected.toFixed(2)} dB<br>
                    📊 Sample Peak: ${crestSample.toFixed(2)} dB (diferença: ${toleranceSample.toFixed(2)} dB)<br>
                    🏔️ True Peak: ${crestTrue.toFixed(2)} dB (diferença: ${toleranceTrue.toFixed(2)} dB)<br>
                    🎯 True Peak simulado: ${truePeakDbtp.toFixed(2)} dBTP<br>
                    ✅ Status: <span class="${result.status === 'PASS' ? 'success' : 'error-text'}">${result.status}</span>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error-text">Erro: ${error.message}</span>`;
            }
            
            updateSummary();
        }

        async function testWhiteNoise() {
            const resultDiv = document.getElementById('noise-result');
            resultDiv.innerHTML = 'Testando ruído branco...';
            
            try {
                const audioBuffer = generateWhiteNoise(2, 48000, 0.3);
                const leftChannel = audioBuffer.getChannelData(0);
                
                const truePeakDbtp = simulateTruePeak(leftChannel);
                
                const crestSample = analyzer.calculateCrestFactor(leftChannel);
                const crestTrue = analyzer.calculateCrestFactor(leftChannel, truePeakDbtp);
                
                const expectedMin = 12;
                const expectedMax = 15;
                const isInRange = crestTrue >= expectedMin && crestTrue <= expectedMax;
                
                const result = {
                    test: 'Ruído Branco',
                    expectedRange: `${expectedMin}-${expectedMax}`,
                    samplePeak: crestSample,
                    truePeak: crestTrue,
                    status: isInRange ? 'PASS' : 'FAIL'
                };
                
                testResults.push(result);
                
                resultDiv.innerHTML = `
                    <strong>Resultados Ruído Branco (2s, amplitude 0.3):</strong><br>
                    📐 Faixa esperada: ${expectedMin}-${expectedMax} dB<br>
                    📊 Sample Peak: ${crestSample.toFixed(2)} dB<br>
                    🏔️ True Peak: ${crestTrue.toFixed(2)} dB<br>
                    🎯 True Peak simulado: ${truePeakDbtp.toFixed(2)} dBTP<br>
                    ✅ Status: <span class="${result.status === 'PASS' ? 'success' : 'error-text'}">${result.status}</span>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error-text">Erro: ${error.message}</span>`;
            }
            
            updateSummary();
        }

        async function testImpulse() {
            const resultDiv = document.getElementById('impulse-result');
            resultDiv.innerHTML = 'Testando impulso...';
            
            try {
                const audioBuffer = generateImpulse(1, 48000);
                const leftChannel = audioBuffer.getChannelData(0);
                
                const truePeakDbtp = simulateTruePeak(leftChannel);
                
                const crestSample = analyzer.calculateCrestFactor(leftChannel);
                const crestTrue = analyzer.calculateCrestFactor(leftChannel, truePeakDbtp);
                
                const expectedMin = 20; // Impulso deve ter crest factor alto
                const isValid = crestTrue >= expectedMin;
                
                const result = {
                    test: 'Impulso',
                    expectedMin: expectedMin,
                    samplePeak: crestSample,
                    truePeak: crestTrue,
                    status: isValid ? 'PASS' : 'FAIL'
                };
                
                testResults.push(result);
                
                resultDiv.innerHTML = `
                    <strong>Resultados Impulso (isolado):</strong><br>
                    📐 Valor mínimo esperado: >${expectedMin} dB<br>
                    📊 Sample Peak: ${crestSample.toFixed(2)} dB<br>
                    🏔️ True Peak: ${crestTrue.toFixed(2)} dB<br>
                    🎯 True Peak simulado: ${truePeakDbtp.toFixed(2)} dBTP<br>
                    ✅ Status: <span class="${result.status === 'PASS' ? 'success' : 'error-text'}">${result.status}</span>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error-text">Erro: ${error.message}</span>`;
            }
            
            updateSummary();
        }

        async function testComparison() {
            const resultDiv = document.getElementById('comparison-result');
            resultDiv.innerHTML = 'Comparando Sample Peak vs True Peak...';
            
            try {
                // Teste com diferentes tipos de sinal
                const tests = [
                    { name: 'Sinusoidal 1kHz', generator: () => generateSineWave(1000, 1, 48000, 0.7) },
                    { name: 'Ruído Branco', generator: () => generateWhiteNoise(1, 48000, 0.4) },
                    { name: 'Sinusoidal 10kHz', generator: () => generateSineWave(10000, 1, 48000, 0.6) }
                ];
                
                let comparisonResults = '';
                
                for (const test of tests) {
                    const audioBuffer = test.generator();
                    const leftChannel = audioBuffer.getChannelData(0);
                    
                    const truePeakDbtp = simulateTruePeak(leftChannel);
                    
                    const crestSample = analyzer.calculateCrestFactor(leftChannel);
                    const crestTrue = analyzer.calculateCrestFactor(leftChannel, truePeakDbtp);
                    
                    const difference = Math.abs(crestTrue - crestSample);
                    
                    comparisonResults += `
                        <strong>${test.name}:</strong><br>
                        • Sample Peak: ${crestSample.toFixed(2)} dB<br>
                        • True Peak: ${crestTrue.toFixed(2)} dB<br>
                        • Diferença: ${difference.toFixed(2)} dB<br><br>
                    `;
                }
                
                resultDiv.innerHTML = `
                    <strong>Comparação Sample Peak vs True Peak:</strong><br><br>
                    ${comparisonResults}
                    <em>💡 True Peak geralmente resulta em valores ligeiramente diferentes devido à interpolação entre amostras.</em>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error-text">Erro: ${error.message}</span>`;
            }
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summary');
            if (testResults.length === 0) {
                summaryDiv.innerHTML = 'Nenhum teste executado ainda.';
                return;
            }
            
            const passed = testResults.filter(r => r.status === 'PASS').length;
            const total = testResults.length;
            
            let summary = `
                <strong>📋 Resumo dos Testes:</strong><br>
                ✅ Aprovados: ${passed}/${total}<br>
                ${passed === total ? '🎉 Todos os testes passaram!' : '⚠️ Alguns testes falharam'}<br><br>
                <strong>Detalhes:</strong><br>
            `;
            
            testResults.forEach(result => {
                summary += `• ${result.test}: <span class="${result.status === 'PASS' ? 'success' : 'error-text'}">${result.status}</span><br>`;
            });
            
            summaryDiv.innerHTML = summary;
        }

        // Executar todos os testes automaticamente
        window.onload = function() {
            console.log('🎚️ Iniciando testes do Crest Factor corrigido...');
        };
    </script>
</body>
</html>