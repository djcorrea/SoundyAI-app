<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üîç Debug Fluxo Real da Aplica√ß√£o</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f8ff; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .log { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 14px; margin: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Fluxo Real da Aplica√ß√£o SoundyAI</h1>
        <p>Este teste simula exatamente o que acontece quando voc√™ faz upload de uma m√∫sica Trance.</p>
        
        <div class="status warning">
            üéØ Este teste vai mostrar exatamente por que o sistema novo n√£o est√° funcionando na aplica√ß√£o real.
        </div>
        
        <button onclick="testSystemLoading()">1. üîç Testar Carregamento do Sistema</button>
        <button onclick="testUpdateReferenceSuggestions()">2. üéµ Simular An√°lise de Trance</button>
        <button onclick="clearLogs()">üóëÔ∏è Limpar Logs</button>
        
        <div id="logs"></div>
    </div>

    <!-- Carregar exatamente como a aplica√ß√£o real -->
    <script src="suggestion-system-emergency.js?v=emergency-20250920"></script>
    
    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            logs.push(entry);
            console.log(entry);
            updateLogsDisplay();
        }
        
        function updateLogsDisplay() {
            document.getElementById('logs').innerHTML = `
                <div class="log">${logs.join('\n')}</div>
            `;
        }
        
        function clearLogs() {
            logs = [];
            updateLogsDisplay();
        }
        
        function testSystemLoading() {
            log('üîç TESTE 1: Verificando carregamento do sistema...');
            
            // Verificar window.suggestionSystem
            if (typeof window.suggestionSystem === 'undefined') {
                log('‚ùå PROBLEMA: window.suggestionSystem n√£o existe!');
                log('Isso significa que o arquivo suggestion-system-emergency.js n√£o foi carregado ou falhou.');
                return;
            }
            
            log('‚úÖ window.suggestionSystem existe');
            log(`Tipo: ${typeof window.suggestionSystem}`);
            
            // Verificar m√©todo process
            if (typeof window.suggestionSystem.process !== 'function') {
                log('‚ùå PROBLEMA: window.suggestionSystem.process n√£o √© uma fun√ß√£o!');
                return;
            }
            
            log('‚úÖ window.suggestionSystem.process() dispon√≠vel');
            
            // Verificar vari√°vel de controle
            log(`USE_UNIFIED_SUGGESTIONS: ${window.USE_UNIFIED_SUGGESTIONS}`);
            
            // Teste r√°pido do sistema
            try {
                const testResult = window.suggestionSystem.process(
                    { technicalData: { lufs: -6.0 } },
                    { genre: 'trance', lufs_target: -9.0, tol_lufs: 1.0 }
                );
                log(`‚úÖ Teste r√°pido OK: ${testResult?.suggestions?.length || 0} sugest√µes`);
            } catch (error) {
                log(`‚ùå Erro no teste r√°pido: ${error.message}`);
            }
        }
        
        function testUpdateReferenceSuggestions() {
            log('üéµ TESTE 2: Simulando an√°lise de Trance...');
            
            // Simular dados de an√°lise como a aplica√ß√£o real
            const mockAnalysis = {
                technicalData: {
                    lufs: -6.2,           // Problema real
                    true_peak: -0.1,      // Problema real
                    dr: 4.5,              // Problema real
                    lra: 2.8,             // OK
                    stereo: 0.45,         // Problema real
                    bands: {
                        sub: { energy: 8.5 },
                        bass: { energy: 22.3 },
                        low_mids: { energy: 16.8 },
                        mids: { energy: 28.1 },
                        high_mids: { energy: 17.2 },
                        highs: { energy: 13.9 }
                    }
                },
                suggestions: []  // Inicialmente vazio
            };
            
            // Simular dados de refer√™ncia como a aplica√ß√£o real
            const mockRefData = {
                genre: 'trance',
                lufs_target: -9.0,
                tol_lufs: 1.0,
                true_peak_target: -1.0,
                tol_true_peak: 0.5,
                dr_target: 7.0,
                tol_dr: 1.5,
                lra_target: 3.0,
                tol_lra: 1.0,
                stereo_target: 0.7,
                tol_stereo: 0.15
            };
            
            log('üìä Dados preparados:');
            log(`  LUFS: ${mockAnalysis.technicalData.lufs} (alvo: ${mockRefData.lufs_target})`);
            log(`  True Peak: ${mockAnalysis.technicalData.true_peak} (limite: ${mockRefData.true_peak_target})`);
            log(`  DR: ${mockAnalysis.technicalData.dr} (alvo: ${mockRefData.dr_target})`);
            log(`  Stereo: ${mockAnalysis.technicalData.stereo} (alvo: ${mockRefData.stereo_target})`);
            
            // Simular a l√≥gica exata do updateReferenceSuggestions
            log('üîç Verificando condi√ß√µes do sistema novo...');
            
            const windowExists = typeof window !== 'undefined';
            const systemExists = !!window.suggestionSystem;
            const flagEnabled = window.USE_UNIFIED_SUGGESTIONS !== false;
            
            log(`  window exists: ${windowExists}`);
            log(`  suggestionSystem exists: ${systemExists}`);
            log(`  USE_UNIFIED_SUGGESTIONS: ${window.USE_UNIFIED_SUGGESTIONS} (enabled: ${flagEnabled})`);
            
            if (windowExists && systemExists && flagEnabled) {
                log('‚úÖ Todas as condi√ß√µes atendidas - usando sistema novo');
                
                try {
                    log('‚ö° Executando window.suggestionSystem.process()...');
                    
                    const enhancedAnalysis = window.suggestionSystem.process(mockAnalysis, mockRefData);
                    
                    log(`‚úÖ Processamento conclu√≠do!`);
                    log(`üìã Sugest√µes geradas: ${enhancedAnalysis?.suggestions?.length || 0}`);
                    
                    if (enhancedAnalysis && enhancedAnalysis.suggestions) {
                        // Simular a combina√ß√£o de sugest√µes
                        const existingSuggestions = Array.isArray(mockAnalysis.suggestions) ? mockAnalysis.suggestions : [];
                        mockAnalysis.suggestions = [...enhancedAnalysis.suggestions, ...existingSuggestions];
                        
                        log(`üìù Total final: ${mockAnalysis.suggestions.length} sugest√µes`);
                        
                        // Mostrar detalhes das sugest√µes
                        enhancedAnalysis.suggestions.forEach((suggestion, index) => {
                            log(`  ${index + 1}. ${suggestion.metric?.toUpperCase()}: ${suggestion.direction} ${Math.abs(suggestion.delta || 0).toFixed(2)} ${suggestion.unit || ''}`);
                        });
                        
                        log('üéØ SUCESSO: Sistema novo funcionou perfeitamente!');
                        
                    } else {
                        log('‚ùå PROBLEMA: Resultado inv√°lido do sistema novo');
                    }
                    
                } catch (error) {
                    log(`‚ùå ERRO no sistema novo: ${error.message}`);
                    log('üîÑ Aplica√ß√£o usaria sistema legado como fallback');
                }
                
            } else {
                log('‚ùå Condi√ß√µes n√£o atendidas - usaria sistema legado');
                log('üîÑ Por isso voc√™ v√™ as sugest√µes antigas e ruins!');
            }
        }
        
        // Auto-executar teste 1 ao carregar
        setTimeout(() => {
            testSystemLoading();
        }, 1000);
    </script>
</body>
</html>