<!DOCTYPE html>
<html>
<head>
    <title>Teste True Peak Corrigido</title>
</head>
<body>
    <h1>Teste True Peak Corrigido</h1>
    <button id="testBtn">Testar Correção Polyphase</button>
    <div id="results"></div>

    <script src="work/lib/audio/features/truepeak.js"></script>
    <script>
        document.getElementById('testBtn').addEventListener('click', function() {
            console.log('🧪 Testando True Peak corrigido...');
            
            // Sinal de teste: senoidal pura com amplitude conhecida
            const sampleRate = 48000;
            const duration = 0.1; // 100ms
            const samples = Math.floor(sampleRate * duration);
            
            // Testar com diferentes amplitudes
            const testCases = [
                { amplitude: 0.5, expectedSamplePeak: -6.02 }, // -6dB
                { amplitude: 0.891, expectedSamplePeak: -1.0 }, // ~-1dB (caso do usuário)
                { amplitude: 1.0, expectedSamplePeak: 0.0 }     // 0dB
            ];
            
            testCases.forEach((testCase, index) => {
                console.log(`\n🎵 Teste ${index + 1}: Amplitude ${testCase.amplitude} (esperado ~${testCase.expectedSamplePeak} dB)`);
                
                const leftChannel = new Float32Array(samples);
                const freq = 1000; // 1kHz
                
                for (let i = 0; i < samples; i++) {
                    const t = i / sampleRate;
                    leftChannel[i] = testCase.amplitude * Math.sin(2 * Math.PI * freq * t);
                }
                
                // Calcular Sample Peak manual
                let maxSample = 0;
                for (let i = 0; i < leftChannel.length; i++) {
                    maxSample = Math.max(maxSample, Math.abs(leftChannel[i]));
                }
                const samplePeakdB = 20 * Math.log10(maxSample);
                
                // Testar True Peak
                const detector = new TruePeakDetector(sampleRate);
                const result = detector.detectTruePeak(leftChannel);
                
                console.log(`📊 Sample Peak: ${samplePeakdB.toFixed(2)} dB`);
                console.log(`📊 True Peak: ${result.true_peak_dbtp.toFixed(2)} dBTP`);
                
                const diff = result.true_peak_dbtp - samplePeakdB;
                console.log(`📊 Diferença: ${diff.toFixed(2)} dB`);
                
                if (result.true_peak_dbtp < samplePeakdB) {
                    console.error(`🚨 ERRO: True Peak menor que Sample Peak!`);
                } else {
                    console.log(`✅ OK: True Peak >= Sample Peak`);
                }
                
                // Verificar se está no range esperado
                const expectedMin = samplePeakdB - 0.5;
                const expectedMax = samplePeakdB + 3.0; // True Peak pode ser até ~3dB maior
                
                if (result.true_peak_dbtp >= expectedMin && result.true_peak_dbtp <= expectedMax) {
                    console.log(`✅ RANGE OK: True Peak dentro do esperado`);
                } else {
                    console.warn(`⚠️ RANGE: True Peak fora do esperado (${expectedMin.toFixed(1)} a ${expectedMax.toFixed(1)} dB)`);
                }
            });
            
            document.getElementById('results').innerHTML = `
                <h3>Testes Realizados:</h3>
                <p>✅ Teste 1: Amplitude 0.5 (~-6dB)</p>
                <p>✅ Teste 2: Amplitude 0.891 (~-1dB) - caso do usuário</p>
                <p>✅ Teste 3: Amplitude 1.0 (0dB)</p>
                <p><strong>Veja o console para resultados detalhados</strong></p>
                <p><em>Se True Peak >= Sample Peak em todos os casos, a correção funcionou!</em></p>
            `;
        });
    </script>
</body>
</html>