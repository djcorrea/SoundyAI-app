<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Auditoria Fluxo Bandas Espectrais - Debug Valores Positivos</title>
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 20px; 
            background: #1e1e1e; 
            color: #ffffff; 
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { 
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
        }
        .debug-section { 
            background: #2d2d2d; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            border-left: 4px solid #e74c3c; 
        }
        .flow-step { 
            background: #3d3d3d; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 0; 
            border-left: 3px solid #f39c12; 
        }
        .positive { color: #e74c3c; font-weight: bold; }
        .negative { color: #27ae60; font-weight: bold; }
        .neutral { color: #95a5a6; }
        .calculation { 
            background: #2c3e50; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: 'Courier New', monospace; 
            margin: 10px 0; 
        }
        .btn { 
            background: #e74c3c; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px; 
        }
        .btn:hover { background: #c0392b; }
        pre { 
            background: #2d2d2d; 
            padding: 15px; 
            border-radius: 8px; 
            overflow-x: auto; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Auditoria Valores Positivos em Bandas Espectrais</h1>
            <p>Investigar onde e por que bandas RMS aparecem positivas quando deveriam ser negativas (dBFS)</p>
        </div>

        <div class="debug-section">
            <h2>üîç Fluxo Energia ‚Üí dB (Rastrear Valores Positivos)</h2>
            <input type="file" id="audioFile" accept="audio/*" class="btn">
            <button onclick="debugSpectralFlow()" class="btn">üî¨ Debug Fluxo Completo</button>
            <button onclick="simulateValues()" class="btn">üßÆ Simular Valores</button>
        </div>

        <div id="flowResults"></div>

        <div class="debug-section">
            <h2>üìä F√≥rmulas e Cen√°rios Problem√°ticos</h2>
            <div class="calculation">
<pre>// F√≥rmula atual (linha 3787 audio-analyzer.js):
rmsDb = 20 * Math.log10(Math.sqrt(band.totalEnergy / validTotalEnergy))

// ‚ö†Ô∏è PROBLEMA: Se (band.totalEnergy / validTotalEnergy) > 1.0
// Ent√£o Math.sqrt(ratio) > 1.0 ‚Üí log10 > 0 ‚Üí rmsDb POSITIVO!

// Cen√°rios que causam ratio > 1.0:
// 1. Normaliza√ß√£o LUFS excessiva (+7dB ou mais)
// 2. Banda dominante ap√≥s processamento 
// 3. √Åudio clipado com energia concentrada
</pre>
            </div>

            <h3>üéØ Targets de Refer√™ncia (Funk Mandela):</h3>
            <div class="calculation">
<pre>Todos os targets s√£o NEGATIVOS (correto):
sub:       -17.3dB  bass:      -17.7dB  
upper_bass:-21.5dB  low_mid:   -18.7dB
mid:       -17.9dB  high_mid:  -22.9dB
brilho:    -29.3dB  presenca:  -34.0dB

‚úÖ Os targets est√£o corretos
‚ùå O problema est√° no c√°lculo das bandas medidas
</pre>
            </div>
        </div>

        <div class="debug-section">
            <h2>üìã Console Logs</h2>
            <pre id="logOutput">Aguardando an√°lise...</pre>
        </div>
    </div>

    <script src="audio-analyzer.js"></script>
    
    <script>
    let audioAnalyzer = new AudioAnalyzer();
    let originalConsoleLog = console.log;
    let logs = [];

    // Interceptar logs
    console.log = function(...args) {
        logs.push(args.join(' '));
        originalConsoleLog.apply(console, args);
        updateLogDisplay();
    };

    function updateLogDisplay() {
        const logOutput = document.getElementById('logOutput');
        if (logOutput) {
            logOutput.textContent = logs.slice(-30).join('\n');
        }
    }

    async function debugSpectralFlow() {
        const fileInput = document.getElementById('audioFile');
        if (!fileInput.files[0]) {
            alert('Selecione um arquivo de √°udio primeiro');
            return;
        }

        const flowResults = document.getElementById('flowResults');
        flowResults.innerHTML = '<div class="flow-step">üîÑ Processando √°udio e rastreando fluxo...</div>';

        try {
            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            console.log('üéµ === IN√çCIO DEBUG FLUXO ESPECTRAL ===');
            console.log('Arquivo:', file.name);
            console.log('Dura√ß√£o:', audioBuffer.duration.toFixed(2), 's');

            const leftChannel = audioBuffer.getChannelData(0);

            // Debug modificado
            const originalCalculateSpectralBalance = audioAnalyzer.calculateSpectralBalance;
            audioAnalyzer.calculateSpectralBalance = function(audioData, sampleRate) {
                console.log('üîç === ENTRANDO EM calculateSpectralBalance ===');
                
                const result = originalCalculateSpectralBalance.call(this, audioData, sampleRate);
                
                if (result && result.bands) {
                    console.log('üéØ === AN√ÅLISE DE VALORES POR BANDA ===');
                    result.bands.forEach((band, index) => {
                        const isPositive = band.rmsDb > 0;
                        const status = isPositive ? '‚ùå POSITIVO' : '‚úÖ NEGATIVO';
                        
                        console.log('Band ' + (index + 1) + ' - ' + band.name + ':');
                        console.log('  RMS dB: ' + band.rmsDb.toFixed(2) + 'dB ' + status);
                        console.log('  % Energia: ' + band.energyPct.toFixed(2) + '%');
                        
                        if (isPositive) {
                            const ratio = band.energy / result.totalEnergy;
                            console.log('  ‚ö†Ô∏è PROBLEMA: Valor positivo!');
                            console.log('  üî¨ energyRatio = ' + ratio.toFixed(6));
                            console.log('  üî¨ sqrt(ratio) = ' + Math.sqrt(ratio).toFixed(6));
                        }
                        console.log('');
                    });
                }
                
                return result;
            };

            const spectralResult = audioAnalyzer.calculateSpectralBalance(leftChannel, audioBuffer.sampleRate);
            audioAnalyzer.calculateSpectralBalance = originalCalculateSpectralBalance;

            if (spectralResult) {
                displayFlowResults(spectralResult);
            }

        } catch (error) {
            console.error('Erro no debug:', error);
            flowResults.innerHTML = '<div class="flow-step">‚ùå Erro: ' + error.message + '</div>';
        }
    }

    function displayFlowResults(result) {
        const positives = result.bands.filter(b => b.rmsDb > 0);
        const negatives = result.bands.filter(b => b.rmsDb <= 0);
        
        let html = '<div class="debug-section">';
        html += '<h2>üìä Resultados do Debug</h2>';
        
        html += '<div class="flow-step">';
        html += '<h3>üìà Resumo Geral:</h3>';
        html += '<div>Total de bandas: ' + result.bands.length + '</div>';
        html += '<div class="positive">Bandas POSITIVAS: ' + positives.length + ' ‚ö†Ô∏è</div>';
        html += '<div class="negative">Bandas NEGATIVAS: ' + negatives.length + ' ‚úÖ</div>';
        html += '</div>';

        if (positives.length > 0) {
            html += '<div class="flow-step">';
            html += '<h3>üö® BANDAS PROBLEM√ÅTICAS (Valores Positivos):</h3>';
            positives.forEach(band => {
                html += '<div class="calculation">';
                html += '<strong>' + band.name + '</strong> (' + band.hzLow + '-' + band.hzHigh + 'Hz)<br>';
                html += 'RMS dB: <span class="positive">' + band.rmsDb.toFixed(2) + 'dB</span><br>';
                html += '% Energia: ' + band.energyPct.toFixed(2) + '%<br>';
                html += 'Energia raw: ' + band.energy.toExponential(3);
                html += '</div>';
            });
            html += '</div>';
        }

        html += '<div class="flow-step">';
        html += '<h3>üîç An√°lise da Causa:</h3>';
        html += '<div class="calculation">';
        if (positives.length > 0) { 
            html += '‚ùå <strong>PROBLEMA CONFIRMADO:</strong> Bandas com valores positivos detectadas.<br>';
            html += 'üî¨ <strong>Causa prov√°vel:</strong><br>';
            html += '‚Ä¢ Normaliza√ß√£o LUFS excessiva (+5dB ou mais)<br>';
            html += '‚Ä¢ Banda dominante com >100% da energia normalizada<br>';
            html += '‚Ä¢ Bug na divis√£o por validTotalEnergy';
        } else {
            html += '‚úÖ <strong>SISTEMA OK:</strong> Todas as bandas t√™m valores negativos corretos.<br>';
            html += 'üéØ Valores est√£o em dBFS como esperado.';
        }
        html += '</div></div></div>';
        
        document.getElementById('flowResults').innerHTML = html;
    }

    function simulateValues() {
        let html = '<div class="debug-section">';
        html += '<h2>üßÆ Simula√ß√£o de Valores (Teoria vs Pr√°tica)</h2>';
        
        html += '<div class="flow-step">';
        html += '<h3>Cen√°rio 1: √Åudio Normal (-18 LUFS)</h3>';
        html += '<div class="calculation">';
        html += 'LUFS original: -18dB ‚Üí Normalizar para -23dB ‚Üí Ganho: -5dB ‚úÖ<br>';
        html += 'Banda dominante: 45% energia ‚Üí ratio = 0.45 ‚Üí sqrt(0.45) = 0.67<br>';
        html += '20*log10(0.67) = <span class="negative">-3.5dB</span> ‚úÖ NEGATIVO';
        html += '</div></div>';

        html += '<div class="flow-step">';
        html += '<h3>Cen√°rio 2: √Åudio Muito Baixo (-30 LUFS)</h3>';
        html += '<div class="calculation">';
        html += 'LUFS original: -30dB ‚Üí Normalizar para -23dB ‚Üí Ganho: +7dB ‚ö†Ô∏è<br>';
        html += 'Ap√≥s ganho: Banda pode ficar >100% energia normalizada<br>';
        html += 'Banda dominante: 120% energia ‚Üí ratio = 1.2 ‚Üí sqrt(1.2) = 1.095<br>';
        html += '20*log10(1.095) = <span class="positive">+0.8dB</span> ‚ùå POSITIVO!';
        html += '</div></div>';

        html += '<div class="flow-step">';
        html += '<h3>üéØ Conclus√£o da Simula√ß√£o:</h3>';
        html += '<div class="calculation">';
        html += '<strong>O problema N√ÉO √© a f√≥rmula</strong> - 20*log10(sqrt()) est√° correta.<br>';
        html += '<strong>O problema √â a normaliza√ß√£o</strong> - criando ratios > 1.0<br><br>';
        html += '<strong>Solu√ß√µes poss√≠veis:</strong><br>';
        html += '1. Limitar normaliza√ß√£o LUFS a m√°ximo +3dB<br>';
        html += '2. Usar escala absoluta (n√£o relativa por energia total)<br>';
        html += '3. Detectar clipping e ajustar refer√™ncia';
        html += '</div></div></div>';
        
        document.getElementById('flowResults').innerHTML = html;
    }

    // Inicializa√ß√£o
    window.addEventListener('load', () => {
        console.log('üîç Sistema de auditoria carregado');
        console.log('üìã Objetivo: Encontrar origem dos valores positivos em bandas espectrais');
    });
    </script>
</body>
</html>