<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Teste Modal Bandas Espectrais</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0e1422;
            color: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a2332;
            border-radius: 12px;
            border: 1px solid #2a3441;
        }
        
        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #005a9e;
        }
        
        .modal-test {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a2332;
            border-radius: 12px;
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #2a3441;
        }
        
        .card {
            background: #2a3441;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            border: 1px solid #3a4451;
        }
        
        .card-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #00d4aa;
        }
        
        .kpi {
            display: inline-block;
            background: #3a4451;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 4px;
            text-align: center;
            min-width: 80px;
        }
        
        .kpi-value {
            font-weight: bold;
            color: #00d4aa;
        }
        
        .kpi-label {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #3a4451;
        }
        
        .row:last-child {
            border-bottom: none;
        }
        
        .row-label {
            opacity: 0.9;
        }
        
        .row-value {
            font-weight: 500;
            color: #00d4aa;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #999;
            font-size: 24px;
            cursor: pointer;
        }
        
        .test-data {
            background: #2a3441;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #3a4451;
        }
        
        pre {
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéµ Teste Modal Bandas Espectrais</h1>
        <p>Teste da corre√ß√£o para mostrar todas as 7 bandas espectrais dinamicamente no modal de an√°lise de √°udio.</p>
        
        <div class="test-data">
            <h3>üîß Dados de Teste (Estrutura Corrigida)</h3>
            <pre id="testDataDisplay"></pre>
        </div>
        
        <button class="btn" onclick="testModalWithCorrectedData()">
            üß™ Testar Modal com Dados Corrigidos
        </button>
        
        <button class="btn" onclick="testModalWithLegacyData()">
            üîÑ Testar Modal com Dados Legacy
        </button>
        
        <button class="btn" onclick="testModalWithMissingData()">
            ‚ùå Testar Modal com Dados Faltando
        </button>
    </div>

    <!-- Modal de Teste -->
    <div id="testModal" class="modal-test">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">&times;</button>
            <h3 id="modalTitle">üéµ An√°lise de √Åudio - Teste</h3>
            <div id="modalTechnicalData">
                <!-- Dados t√©cnicos ser√£o inseridos aqui -->
            </div>
        </div>
    </div>

    <script>
        // üåà Dados de teste com estrutura corrigida
        const testDataCorrected = {
            metrics: {
                bands: {
                    sub: { energy_db: -15.2, percentage: 8.5, range: "20-60Hz", status: "calculated" },
                    bass: { energy_db: -8.7, percentage: 22.3, range: "60-150Hz", status: "calculated" },
                    lowMid: { energy_db: -12.1, percentage: 15.7, range: "150-500Hz", status: "calculated" },
                    mid: { energy_db: -6.4, percentage: 25.8, range: "500-2000Hz", status: "calculated" },
                    highMid: { energy_db: -14.3, percentage: 12.2, range: "2000-5000Hz", status: "calculated" },
                    presence: { energy_db: -18.9, percentage: 9.1, range: "5000-10000Hz", status: "calculated" },
                    air: { energy_db: -22.5, percentage: 6.4, range: "10000-20000Hz", status: "calculated" },
                    totalPercentage: 100.0
                }
            },
            technicalData: {
                lufsIntegrated: -12.3,
                truePeakDbtp: -1.2,
                dynamicRange: 9.5
            }
        };

        // üîÑ Dados legacy (estrutura antiga)
        const testDataLegacy = {
            technicalData: {
                spectral_balance: {
                    sub: -15.2,
                    bass: -8.7,
                    lowMid: -12.1,
                    mid: -6.4,
                    highMid: -14.3,
                    presence: -18.9,
                    air: -22.5
                },
                lufsIntegrated: -12.3,
                truePeakDbtp: -1.2
            }
        };

        // ‚ùå Dados com campos faltando
        const testDataMissing = {
            metrics: {
                bands: {
                    sub: { energy_db: -15.2, percentage: 8.5, range: "20-60Hz", status: "calculated" },
                    bass: { energy_db: null, percentage: null, range: "60-150Hz", status: "not_calculated" },
                    mid: { energy_db: -6.4, percentage: 25.8, range: "500-2000Hz", status: "calculated" },
                    // highMid, presence, air ausentes
                    totalPercentage: 34.3
                }
            },
            technicalData: {
                lufsIntegrated: -12.3
            }
        };

        // Fun√ß√µes auxiliares (simulando as do arquivo original)
        const safeFixed = (v, d=1) => (Number.isFinite(v) ? v.toFixed(d) : '‚Äî');
        
        const row = (label, valHtml, keyForSource=null) => `
            <div class="row">
                <span class="row-label">${label}</span>
                <span class="row-value">${valHtml}</span>
            </div>`;

        // Fun√ß√£o de renderiza√ß√£o das bandas espectrais (copiada da corre√ß√£o)
        function renderSpectralBands(analysis) {
            const bands = analysis.metrics?.bands || analysis.technicalData?.spectral_balance || {};
            
            const formatDb = (v) => Number.isFinite(v) ? `${safeFixed(v, 1)} dB` : 'n√£o calculado';
            const formatPct = (v) => Number.isFinite(v) ? `${safeFixed(v, 1)}%` : 'n√£o calculado';
            const rows = [];
            
            // Defini√ß√£o das 7 bandas espectrais oficiais
            const spectralBands = [
                { key: 'sub', name: 'Sub-bass', defaultRange: '20-60Hz' },
                { key: 'bass', name: 'Bass', defaultRange: '60-150Hz' },
                { key: 'lowMid', name: 'Low-Mid', defaultRange: '150-500Hz' },
                { key: 'mid', name: 'Mid', defaultRange: '500-2kHz' },
                { key: 'highMid', name: 'High-Mid', defaultRange: '2-5kHz' },
                { key: 'presence', name: 'Presence', defaultRange: '5-10kHz' },
                { key: 'air', name: 'Air', defaultRange: '10-20kHz' }
            ];
            
            // Renderizar dinamicamente todas as bandas dispon√≠veis
            for (const band of spectralBands) {
                const bandData = bands[band.key];
                
                if (bandData && typeof bandData === 'object') {
                    // Estrutura nova: { energy_db, percentage, range, status }
                    const range = bandData.range || band.defaultRange;
                    const energyDb = formatDb(bandData.energy_db);
                    const percentage = formatPct(bandData.percentage);
                    const status = bandData.status || 'unknown';
                    
                    if (status === 'calculated') {
                        rows.push(row(`${band.name} (${range})`, `${energyDb} | ${percentage}`, `spectral${band.key}`));
                    } else {
                        rows.push(row(`${band.name} (${range})`, 'n√£o calculado', `spectral${band.key}`));
                    }
                } else if (Number.isFinite(bandData)) {
                    // Estrutura legacy: valor direto
                    const range = band.defaultRange;
                    rows.push(row(`${band.name} (${range})`, formatDb(bandData), `spectral${band.key}`));
                } else {
                    // Banda n√£o dispon√≠vel
                    rows.push(row(`${band.name} (${band.defaultRange})`, 'n√£o calculado', `spectral${band.key}`));
                }
            }
            
            // Se nenhuma banda foi encontrada, mostrar status
            if (rows.length === 0) {
                return row('Status', 'Bandas espectrais n√£o calculadas');
            }
            
            // Adicionar totalPercentage se dispon√≠vel
            if (Number.isFinite(bands.totalPercentage)) {
                rows.push(row('Total', `${safeFixed(bands.totalPercentage, 1)}%`, 'spectralTotal'));
            }
            
            return rows.join('');
        }

        function displayModal(analysis, title) {
            document.getElementById('testDataDisplay').textContent = JSON.stringify(analysis, null, 2);
            document.getElementById('modalTitle').textContent = title;
            
            const modalData = document.getElementById('modalTechnicalData');
            
            modalData.innerHTML = `
                <div class="card">
                    <div class="card-title">üîä Balance Espectral Detalhado</div>
                    ${renderSpectralBands(analysis)}
                </div>
                
                <div class="card">
                    <div class="card-title">üìä Outras M√©tricas</div>
                    ${row('LUFS Integrado', analysis.technicalData?.lufsIntegrated ? `${safeFixed(analysis.technicalData.lufsIntegrated, 1)} LUFS` : '‚Äî')}
                    ${row('True Peak', analysis.technicalData?.truePeakDbtp ? `${safeFixed(analysis.technicalData.truePeakDbtp, 1)} dBTP` : '‚Äî')}
                    ${row('Dynamic Range', analysis.technicalData?.dynamicRange ? `${safeFixed(analysis.technicalData.dynamicRange, 1)} dB` : '‚Äî')}
                </div>
            `;
            
            document.getElementById('testModal').style.display = 'block';
        }

        function testModalWithCorrectedData() {
            displayModal(testDataCorrected, 'üéµ Teste: Dados Corrigidos (metrics.bands)');
        }

        function testModalWithLegacyData() {
            displayModal(testDataLegacy, 'üîÑ Teste: Dados Legacy (spectral_balance)');
        }

        function testModalWithMissingData() {
            displayModal(testDataMissing, '‚ùå Teste: Dados Faltando');
        }

        function closeModal() {
            document.getElementById('testModal').style.display = 'none';
        }

        // Inicializar com dados corretos exibidos
        window.onload = function() {
            document.getElementById('testDataDisplay').textContent = JSON.stringify(testDataCorrected, null, 2);
        };
    </script>
</body>
</html>