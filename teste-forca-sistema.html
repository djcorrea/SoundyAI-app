<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üöÄ FOR√áA SISTEMA NOVO - TESTE FINAL</title>
    <style>
        body { font-family: Arial; margin: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .container { max-width: 1000px; margin: 0 auto; background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; backdrop-filter: blur(10px); }
        .header { text-align: center; font-size: 28px; font-weight: bold; margin-bottom: 30px; }
        .status { padding: 20px; margin: 15px 0; border-radius: 10px; font-weight: bold; }
        .success { background: rgba(40, 167, 69, 0.3); border: 2px solid #28a745; }
        .error { background: rgba(220, 53, 69, 0.3); border: 2px solid #dc3545; }
        .warning { background: rgba(255, 193, 7, 0.3); border: 2px solid #ffc107; color: #856404; }
        .log { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); padding: 15px; margin: 10px 0; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .suggestion { 
            margin: 15px 0; padding: 20px; background: rgba(255,255,255,0.1); 
            border: 2px solid rgba(255,255,255,0.3); border-radius: 10px; 
        }
        .metric { font-size: 20px; font-weight: bold; color: #ffc107; margin-bottom: 15px; }
        .delta { background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin: 10px 0; }
        .content { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin: 8px 0; }
        button { 
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white; border: none; padding: 15px 30px; 
            border-radius: 10px; cursor: pointer; font-size: 18px; font-weight: bold;
            box-shadow: 0 8px 25px rgba(238, 90, 36, 0.4);
            transition: all 0.3s ease; margin: 10px;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(238, 90, 36, 0.6); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">üöÄ FOR√áA SISTEMA NOVO - TESTE FINAL</div>
        <div class="status warning">
            Este teste vai FOR√áAR o sistema novo a funcionar, simulando exatamente o que acontece quando voc√™ faz upload.
        </div>
        
        <button onclick="forcaAtivacao()" style="width: 100%;">
            üöÄ FOR√áAR ATIVA√á√ÉO DO SISTEMA NOVO
        </button>
        
        <button onclick="simulaUpload()" style="width: 100%;">
            üéµ SIMULAR UPLOAD DE TRANCE PROBLEM√ÅTICO
        </button>
        
        <div id="logs"></div>
        <div id="results"></div>
    </div>

    <!-- Carregar sistema -->
    <script src="suggestion-system-emergency.js?v=emergency-20250920"></script>
    
    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            logs.push(entry);
            console.log(entry);
            updateLogsDisplay();
        }
        
        function updateLogsDisplay() {
            document.getElementById('logs').innerHTML = `<div class="log">${logs.join('\n')}</div>`;
        }
        
        function forcaAtivacao() {
            log('üöÄ FOR√áANDO ATIVA√á√ÉO DO SISTEMA NOVO...');
            
            // For√ßar todas as vari√°veis necess√°rias
            window.USE_UNIFIED_SUGGESTIONS = true;
            log('‚úÖ window.USE_UNIFIED_SUGGESTIONS = true');
            
            if (typeof window.suggestionSystem === 'undefined') {
                log('‚ùå CR√çTICO: window.suggestionSystem n√£o existe!');
                log('Tentando criar manualmente...');
                
                // Se n√£o existir, tentar recarregar
                const script = document.createElement('script');
                script.src = 'suggestion-system-emergency.js?v=' + Date.now();
                script.onload = () => {
                    log('‚úÖ Script recarregado!');
                    forcaAtivacao(); // Tentar novamente
                };
                script.onerror = () => log('‚ùå Falha ao recarregar script');
                document.head.appendChild(script);
                return;
            }
            
            log('‚úÖ window.suggestionSystem existe');
            log(`Tipo: ${typeof window.suggestionSystem}`);
            log(`Process: ${typeof window.suggestionSystem.process}`);
            
            // Teste r√°pido
            try {
                const quickTest = window.suggestionSystem.process(
                    { technicalData: { lufs: -6.0 } },
                    { genre: 'trance', lufs_target: -9.0, tol_lufs: 1.0 }
                );
                log(`‚úÖ Teste r√°pido OK: ${quickTest?.suggestions?.length || 0} sugest√µes`);
                log('üéØ SISTEMA NOVO PRONTO PARA USO!');
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`);
            }
        }
        
        function simulaUpload() {
            log('üéµ SIMULANDO UPLOAD DE TRANCE...');
            
            // Verificar se sistema est√° pronto
            if (!window.suggestionSystem || !window.USE_UNIFIED_SUGGESTIONS) {
                log('‚ùå Sistema n√£o est√° pronto! Execute FOR√áAR ATIVA√á√ÉO primeiro.');
                return;
            }
            
            // Simular dados EXATOS como na aplica√ß√£o real
            const currentModalAnalysis = {
                technicalData: {
                    lufs: -5.8,
                    true_peak: 0.3,
                    dr: 3.1,
                    lra: 2.2,
                    stereo: 0.35,
                    bands: {
                        sub: { energy: 7.2 },
                        bass: { energy: 26.8 },
                        low_mids: { energy: 15.1 },
                        mids: { energy: 31.5 },
                        high_mids: { energy: 18.9 },
                        highs: { energy: 12.1 }
                    }
                },
                suggestions: [] // Inicialmente vazio
            };
            
            const __activeRefData = {
                genre: 'trance',
                lufs_target: -9.0,
                tol_lufs: 1.0,
                true_peak_target: -1.0,
                tol_true_peak: 0.5,
                dr_target: 7.0,
                tol_dr: 1.5,
                lra_target: 3.0,
                tol_lra: 1.0,
                stereo_target: 0.7,
                tol_stereo: 0.15,
                bands: {
                    sub: { target: 10.0, tolerance: 2.5 },
                    bass: { target: 20.0, tolerance: 3.5 },
                    low_mids: { target: 18.0, tolerance: 3.0 },
                    mids: { target: 25.0, tolerance: 3.5 },
                    high_mids: { target: 20.0, tolerance: 3.0 },
                    highs: { target: 17.0, tolerance: 2.5 }
                }
            };
            
            log('üìä Dados preparados - problemas detectados:');
            log(`  LUFS: ${currentModalAnalysis.technicalData.lufs} vs ${__activeRefData.lufs_target} (Œî: ${(currentModalAnalysis.technicalData.lufs - __activeRefData.lufs_target).toFixed(1)})`);
            log(`  True Peak: ${currentModalAnalysis.technicalData.true_peak} vs ${__activeRefData.true_peak_target} (Œî: ${(currentModalAnalysis.technicalData.true_peak - __activeRefData.true_peak_target).toFixed(1)})`);
            log(`  DR: ${currentModalAnalysis.technicalData.dr} vs ${__activeRefData.dr_target} (Œî: ${(currentModalAnalysis.technicalData.dr - __activeRefData.dr_target).toFixed(1)})`);
            
            // EXECUTAR EXATAMENTE COMO NA APLICA√á√ÉO REAL
            log('‚ö° Executando updateReferenceSuggestions...');
            
            try {
                // Copiar a l√≥gica EXATA da aplica√ß√£o
                const windowExists = typeof window !== 'undefined';
                const systemExists = !!window.suggestionSystem;
                const flagEnabled = window.USE_UNIFIED_SUGGESTIONS !== false;
                
                log(`Condi√ß√µes: window=${windowExists}, system=${systemExists}, flag=${flagEnabled}`);
                
                if (windowExists && systemExists && flagEnabled) {
                    log('‚úÖ Condi√ß√µes atendidas - processando...');
                    
                    const enhancedAnalysis = window.suggestionSystem.process(currentModalAnalysis, __activeRefData);
                    
                    log(`‚úÖ Processamento OK! Sugest√µes: ${enhancedAnalysis?.suggestions?.length || 0}`);
                    
                    if (enhancedAnalysis && enhancedAnalysis.suggestions && enhancedAnalysis.suggestions.length > 0) {
                        // Aplicar as sugest√µes EXATAMENTE como na aplica√ß√£o
                        const existingSuggestions = Array.isArray(currentModalAnalysis.suggestions) ? currentModalAnalysis.suggestions : [];
                        currentModalAnalysis.suggestions = [...enhancedAnalysis.suggestions, ...existingSuggestions];
                        
                        log(`üéØ SUCESSO! Total de sugest√µes: ${currentModalAnalysis.suggestions.length}`);
                        
                        // Exibir as sugest√µes
                        displaySuggestions(enhancedAnalysis.suggestions);
                        
                    } else {
                        log('‚ùå Nenhuma sugest√£o gerada ou resultado inv√°lido');
                    }
                    
                } else {
                    log('‚ùå Condi√ß√µes n√£o atendidas - usaria sistema legado');
                }
                
            } catch (error) {
                log(`‚ùå ERRO: ${error.message}`);
                log(`Stack: ${error.stack}`);
            }
        }
        
        function displaySuggestions(suggestions) {
            const container = document.getElementById('results');
            
            if (!suggestions || suggestions.length === 0) {
                container.innerHTML = '<div class="status error">‚ùå Nenhuma sugest√£o encontrada!</div>';
                return;
            }
            
            let html = `<div class="status success">üéØ ${suggestions.length} SUGEST√ïES DO SISTEMA NOVO:</div>`;
            
            suggestions.forEach((suggestion, index) => {
                const deltaText = suggestion.direction === 'reduce' ? 'Reduzir' : 'Aumentar';
                
                html += `
                    <div class="suggestion">
                        <div class="metric">${index + 1}. ${suggestion.metric?.toUpperCase()}</div>
                        
                        <div class="delta">
                            üéØ <strong>A√ß√£o:</strong> ${deltaText} ${Math.abs(suggestion.delta || 0).toFixed(2)} ${suggestion.unit || ''}<br>
                            üìä Medido: ${suggestion.measured?.toFixed(2)} | Alvo: ${suggestion.target?.toFixed(2)}
                        </div>
                        
                        <div class="content"><strong>üî¥ Problema:</strong> ${suggestion.problem || 'N√£o informado'}</div>
                        <div class="content"><strong>üìö Explica√ß√£o:</strong> ${suggestion.explanation || 'N√£o informado'}</div>
                        <div class="content"><strong>‚úÖ Solu√ß√£o:</strong> ${suggestion.solution || 'N√£o informado'}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Auto-executar ao carregar
        setTimeout(() => {
            log('üöÄ P√°gina carregada - verificando sistema...');
            if (window.suggestionSystem) {
                log('‚úÖ Sistema j√° carregado!');
                forcaAtivacao();
            } else {
                log('‚è≥ Aguardando carregamento do sistema...');
                setTimeout(forcaAtivacao, 2000);
            }
        }, 1000);
    </script>
</body>
</html>