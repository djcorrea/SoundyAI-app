<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: Correção Bandas Múltiplas</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #0a0a0a; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .result { 
            margin: 20px 0; padding: 15px; border-radius: 8px; 
            border: 1px solid #333; background: #1a1a1a;
        }
        .success { border-color: #28a745; background: #0d2818; }
        .warning { border-color: #ffc107; background: #332b0a; }
        .error { border-color: #dc3545; background: #2c0a0a; }
        .suggestion-item {
            margin: 10px 0; padding: 10px; border-radius: 6px;
            background: #2a2a2a; border-left: 4px solid #007bff;
        }
        .band-suggestion { border-left-color: #ff6b35; }
        pre { background: #111; padding: 10px; border-radius: 4px; overflow: auto; }
        button { 
            background: #007bff; color: white; border: none; 
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
            margin: 10px 5px 0 0;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Teste: Correção Bandas Múltiplas</h1>
        <p>Verificando se todas as sugestões band_adjust aparecem no modal</p>
        
        <button onclick="testarDeduplicacao()">🧪 Testar Função deduplicateByType</button>
        <button onclick="testarModalCompleto()">🖥️ Testar Modal Completo</button>
        <button onclick="limparResultados()">🗑️ Limpar</button>
        
        <div id="resultados"></div>
    </div>

    <!-- Carregar dependências -->
    <script src="public/suggestion-scorer.js"></script>
    <script src="public/enhanced-suggestion-engine.js"></script>
    <script src="public/audio-analyzer-integration.js"></script>

    <script>
        function limparResultados() {
            document.getElementById('resultados').innerHTML = '';
        }

        function logResult(title, content, type = 'result') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<h3>${title}</h3>${content}`;
            document.getElementById('resultados').appendChild(div);
        }

        function testarDeduplicacao() {
            limparResultados();
            
            // Simular sugestões com múltiplas bandas
            const sugestoesTeste = [
                {
                    type: 'band_adjust',
                    subtype: 'sub',
                    message: 'Ajustar Sub',
                    action: 'Reduzir sub em 2.5 dB',
                    icon: '🎵',
                    targetValue: -30,
                    currentValue: -27.5
                },
                {
                    type: 'band_adjust',
                    subtype: 'bass',
                    message: 'Ajustar Bass',
                    action: 'Aumentar bass em 1.8 dB',
                    icon: '🎵',
                    targetValue: -20,
                    currentValue: -21.8
                },
                {
                    type: 'band_adjust',
                    subtype: 'mid',
                    message: 'Ajustar Mid',
                    action: 'Reduzir mid em 3.2 dB',
                    icon: '🎵',
                    targetValue: -10,
                    currentValue: -6.8
                },
                {
                    type: 'reference_lra',
                    message: 'Ajustar LRA',
                    action: 'Aumentar dinâmica',
                    icon: '🔊'
                },
                {
                    type: 'band_adjust', // Duplicata do sub para testar
                    subtype: 'sub',
                    message: 'Ajustar Sub (duplicata)',
                    action: 'Reduzir sub em 2.5 dB',
                    icon: '🎵',
                    targetValue: -30,
                    currentValue: -27.5
                }
            ];
            
            logResult('📝 Sugestões de Entrada', `
                <strong>Total de sugestões:</strong> ${sugestoesTeste.length}<br>
                <strong>band_adjust:</strong> ${sugestoesTeste.filter(s => s.type === 'band_adjust').length}<br>
                <strong>Bandas únicas:</strong> ${[...new Set(sugestoesTeste.filter(s => s.type === 'band_adjust').map(s => s.subtype))].join(', ')}<br>
                <pre>${JSON.stringify(sugestoesTeste.map(s => ({ type: s.type, subtype: s.subtype })), null, 2)}</pre>
            `, 'warning');
            
            // Testar a função deduplicateByType corrigida
            try {
                // Simular a função conforme implementada no arquivo
                const deduplicateByType = (items) => {
                    const seen = new Map();
                    const deduplicated = [];
                    for (const item of items) {
                        if (!item || !item.type) continue;
                        
                        // 🎯 CORREÇÃO: Para band_adjust, usar type + subtype como chave única
                        let uniqueKey = item.type;
                        if (item.type === 'band_adjust' && item.subtype) {
                            uniqueKey = `${item.type}:${item.subtype}`;
                        }
                        
                        const existing = seen.get(uniqueKey);
                        if (!existing) {
                            seen.set(uniqueKey, item);
                            deduplicated.push(item);
                        } else {
                            // Manter o mais detalhado (com mais propriedades)
                            const currentScore = Object.keys(item).length + (item.explanation ? 10 : 0) + (item.impact ? 5 : 0);
                            const existingScore = Object.keys(existing).length + (existing.explanation ? 10 : 0) + (existing.impact ? 5 : 0);
                            if (currentScore > existingScore) {
                                seen.set(uniqueKey, item);
                                const index = deduplicated.findIndex(d => {
                                    if (d.type === 'band_adjust' && item.type === 'band_adjust') {
                                        return d.type === item.type && d.subtype === item.subtype;
                                    }
                                    return d.type === item.type;
                                });
                                if (index >= 0) deduplicated[index] = item;
                            }
                        }
                    }
                    return deduplicated;
                };
                
                const resultado = deduplicateByType(sugestoesTeste);
                
                const bandasResultado = resultado.filter(s => s.type === 'band_adjust');
                const bandasUnicas = [...new Set(bandasResultado.map(s => s.subtype))];
                
                logResult('✅ Resultado da Deduplicação', `
                    <strong>Total após deduplicação:</strong> ${resultado.length}<br>
                    <strong>band_adjust mantidas:</strong> ${bandasResultado.length}<br>
                    <strong>Bandas únicas mantidas:</strong> ${bandasUnicas.join(', ')}<br>
                    <strong>Status:</strong> ${bandasResultado.length === 3 ? '✅ CORRETO' : '❌ INCORRETO'}<br>
                    <pre>${JSON.stringify(resultado.map(s => ({ type: s.type, subtype: s.subtype, message: s.message })), null, 2)}</pre>
                `, bandasResultado.length === 3 ? 'success' : 'error');
                
                // Teste individual de cada banda
                const bandasEsperadas = ['sub', 'bass', 'mid'];
                let detalheBandas = '<h4>📊 Detalhes por Banda:</h4>';
                bandasEsperadas.forEach(banda => {
                    const encontrada = bandasResultado.find(s => s.subtype === banda);
                    detalheBandas += `
                        <div class="suggestion-item band-suggestion">
                            <strong>${banda}:</strong> ${encontrada ? '✅ Encontrada' : '❌ Ausente'}<br>
                            ${encontrada ? `Mensagem: ${encontrada.message}<br>Ação: ${encontrada.action}` : 'Não encontrada no resultado'}
                        </div>
                    `;
                });
                
                logResult('🎵 Status por Banda', detalheBandas, 'warning');
                
            } catch (error) {
                logResult('❌ Erro no Teste', `
                    <strong>Erro:</strong> ${error.message}<br>
                    <pre>${error.stack}</pre>
                `, 'error');
            }
        }

        function testarModalCompleto() {
            logResult('🖥️ Modal Completo', `
                <p>Para testar o modal completo, seria necessário simular o fluxo completo de análise.</p>
                <p>O importante é que a função deduplicateByType foi corrigida para tratar band_adjust corretamente.</p>
                <p><strong>Próximos passos:</strong></p>
                <ul>
                    <li>✅ Função deduplicateByType corrigida</li>
                    <li>✅ Chave única para bandas: type:subtype</li>
                    <li>✅ Cada banda mantém sua sugestão individual</li>
                    <li>🔄 Teste com análise real necessário</li>
                </ul>
            `, 'warning');
        }
    </script>
</body>
</html>