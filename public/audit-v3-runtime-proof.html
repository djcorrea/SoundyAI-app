<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç AUDIT: V3 Runtime Proof - True Peak Gate</title>
    <!-- ‚úÖ CRITICAL: Logger DEVE ser o primeiro script carregado -->
    <script src="logger.js"></script>
    

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #6366f1; margin-bottom: 20px; }
        h2 { color: #22c55e; margin: 20px 0 10px; font-size: 1.2em; }
        
        .test-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-case {
            background: #252525;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .test-case.pass { border-left: 4px solid #22c55e; }
        .test-case.fail { border-left: 4px solid #ef4444; }
        .test-case.running { border-left: 4px solid #fbbf24; }
        
        .test-title { font-weight: bold; margin-bottom: 8px; }
        .test-result { font-family: monospace; font-size: 13px; color: #888; }
        .test-result.pass { color: #22c55e; }
        .test-result.fail { color: #ef4444; }
        
        .btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        .btn:hover { background: #4f46e5; }
        .btn:disabled { background: #444; cursor: not-allowed; }
        .btn.success { background: #22c55e; }
        .btn.warning { background: #f97316; }
        
        .summary {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid #6366f1;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .debug-output {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .mode-btn {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mode-btn.streaming {
            background: #3b82f6;
            border: 2px solid #3b82f6;
            color: white;
        }
        
        .mode-btn.pista {
            background: #f97316;
            border: 2px solid #f97316;
            color: white;
        }
        
        .mode-btn:not(.active) {
            background: transparent;
            opacity: 0.6;
        }
        
        .mode-btn.active {
            box-shadow: 0 0 15px currentColor;
        }
        
        .critical { color: #ef4444; font-weight: bold; }
        .warning { color: #fbbf24; }
        .success { color: #22c55e; }
        
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status-box.ok { background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; }
        .status-box.error { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; }
        .status-box.warn { background: rgba(251, 191, 36, 0.1); border: 1px solid #fbbf24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç AUDIT: Score Engine V3 - Runtime Proof</h1>
        
        <div class="summary">
            <h2>üìä Status do Sistema</h2>
            <div class="summary-item">
                <span>Score Engine V3:</span>
                <span id="status-v3">Verificando...</span>
            </div>
            <div class="summary-item">
                <span>Engine Ativa:</span>
                <span id="status-engine">--</span>
            </div>
            <div class="summary-item">
                <span>Mode Atual:</span>
                <span id="summary-mode">--</span>
            </div>
            <div class="summary-item">
                <span>Testes Passaram:</span>
                <span id="summary-tests">0 / 0</span>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üîß Controle da Engine</h2>
            <button class="btn success" onclick="activateV3()">‚úÖ Ativar V3</button>
            <button class="btn warning" onclick="deactivateV3()">‚ö†Ô∏è Desativar V3</button>
            <button class="btn" onclick="checkStatus()">üîç Verificar Status</button>
            
            <div id="status-message" class="status-box ok" style="display:none;"></div>
        </div>
        
        <div class="test-section">
            <h2>üéØ Sele√ß√£o de Modo</h2>
            <div class="mode-selector">
                <button class="mode-btn streaming active" onclick="setMode('streaming')">
                    üéß Streaming<br>
                    <small>TP max: -0.5 dBTP</small>
                </button>
                <button class="mode-btn pista" onclick="setMode('pista')">
                    üéõÔ∏è Pista / DJ<br>
                    <small>TP max: 0.0 dBTP</small>
                </button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üß™ Testes de Realismo (V3)</h2>
            <button class="btn" onclick="runAllTests()">‚ñ∂Ô∏è Executar Testes V3</button>
            <button class="btn" onclick="runSanityTest()">ü©∫ Teste de Sanidade</button>
            <button class="btn" onclick="clearResults()" style="background: #333;">üóëÔ∏è Limpar</button>
            
            <div id="test-results"></div>
        </div>
        
        <div class="test-section">
            <h2>üìù window.__lastScoreDebug</h2>
            <div class="debug-output" id="debug-output">Aguardando execu√ß√£o dos testes...</div>
        </div>
        
        <div class="test-section">
            <h2>üìã Console Log</h2>
            <div class="debug-output" id="console-output" style="max-height: 200px;"></div>
        </div>
    </div>
    
    <!-- Score Engine V3 deve ser carregado primeiro -->
    <script src="/lib/audio/features/score-engine-v3.js"></script>
    
    <script>
        // Estado global
        let currentMode = 'streaming';
        let testResults = [];
        let consoleBuffer = [];
        
        // Capturar console
        const originalLog = console.log;
        const originalInfo = console.info;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function captureLog(type, args) {
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
            if (msg.includes('SCORE') || msg.includes('V3') || msg.includes('GATE') || msg.includes('Engine')) {
                consoleBuffer.push(`[${type}] ${msg}`);
                updateConsoleOutput();
            }
        }
        
        console.log = function(...args) { originalLog.apply(console, args); captureLog('LOG', args); };
        console.info = function(...args) { originalInfo.apply(console, args); captureLog('INFO', args); };
        console.warn = function(...args) { originalWarn.apply(console, args); captureLog('WARN', args); };
        console.error = function(...args) { originalError.apply(console, args); captureLog('ERROR', args); };
        
        function updateConsoleOutput() {
            const el = document.getElementById('console-output');
            el.textContent = consoleBuffer.slice(-30).join('\n');
            el.scrollTop = el.scrollHeight;
        }
        
        // Verificar status ao carregar
        window.addEventListener('load', () => {
            setTimeout(checkStatus, 500);
        });
        
        function checkStatus() {
            const v3Available = window.ScoreEngineV3 && window.ScoreEngineV3.ready;
            const engineVersion = window.getScoreEngineVersion ? window.getScoreEngineVersion() : 'N/A';
            
            document.getElementById('status-v3').textContent = v3Available ? '‚úÖ Carregado e Pronto' : '‚ùå N√£o dispon√≠vel';
            document.getElementById('status-v3').className = v3Available ? 'success' : 'critical';
            
            document.getElementById('status-engine').textContent = engineVersion.toUpperCase();
            document.getElementById('status-engine').className = engineVersion === 'v3' ? 'success' : 'warning';
            
            const msgBox = document.getElementById('status-message');
            if (v3Available) {
                msgBox.className = 'status-box ok';
                msgBox.innerHTML = `‚úÖ Score Engine V3 dispon√≠vel!<br>Vers√£o: ${window.ScoreEngineV3.version}<br>Engine ativa: ${engineVersion}`;
            } else {
                msgBox.className = 'status-box error';
                msgBox.innerHTML = '‚ùå Score Engine V3 N√ÉO CARREGOU!<br>Verifique o console para erros.';
            }
            msgBox.style.display = 'block';
        }
        
        function activateV3() {
            if (window.enableScoreV3) {
                window.enableScoreV3();
                checkStatus();
            } else {
                alert('enableScoreV3 n√£o dispon√≠vel');
            }
        }
        
        function deactivateV3() {
            if (window.disableScoreV3) {
                window.disableScoreV3();
                checkStatus();
            }
        }
        
        function setMode(mode) {
            currentMode = mode;
            window.__SOUNDY_ANALYSIS_MODE__ = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains(mode)) btn.classList.add('active');
            });
            
            document.getElementById('summary-mode').textContent = mode.toUpperCase();
        }
        
        async function runSanityTest() {
            if (!window.ScoreEngineV3 || !window.testScoreEngineV3) {
                alert('Score Engine V3 n√£o dispon√≠vel. Execute checkStatus() primeiro.');
                return;
            }
            
            const results = await window.testScoreEngineV3();
            
            document.getElementById('debug-output').textContent = JSON.stringify(results, null, 2);
            
            const msgBox = document.getElementById('status-message');
            if (results.allPass) {
                msgBox.className = 'status-box ok';
                msgBox.innerHTML = '‚úÖ Todos os testes de sanidade passaram!';
            } else {
                msgBox.className = 'status-box error';
                msgBox.innerHTML = '‚ùå Alguns testes falharam. Verifique o console.';
            }
            msgBox.style.display = 'block';
        }
        
        async function runTest(testName, technicalData, expectedCheck, description) {
            if (!window.ScoreEngineV3) {
                return { pass: false, reason: 'V3 n√£o dispon√≠vel' };
            }
            
            try {
                const result = await window.ScoreEngineV3.computeScore(technicalData, null, currentMode);
                
                // Atualizar debug
                document.getElementById('debug-output').textContent = JSON.stringify({
                    lastScoreDebug: window.__lastScoreDebug,
                    v3Result: result
                }, null, 2);
                
                const checkResult = expectedCheck(result);
                
                return {
                    pass: checkResult.pass,
                    reason: checkResult.reason,
                    result
                };
            } catch (e) {
                return { pass: false, reason: `Erro: ${e.message}` };
            }
        }
        
        async function runAllTests() {
            const resultsEl = document.getElementById('test-results');
            resultsEl.innerHTML = '';
            testResults = [];
            
            const tests = [
                {
                    name: 'TP Positivo (+2.0 dBTP)',
                    data: { truePeakDbtp: 2.0, lufsIntegrated: -14.0, clippingPct: 0, dr: 8, stereoWidth: 0.6 },
                    check: (r) => ({
                        pass: r.scorePct <= 35 && r.gatesApplied.some(g => g.type === 'TRUE_PEAK_CRITICAL'),
                        reason: `Score: ${r.scorePct}% (esperado: ‚â§35%), Gates: ${r.gatesApplied.map(g => g.type).join(', ')}`
                    }),
                    description: 'True Peak acima de 0 dBTP deve acionar gate cr√≠tico'
                },
                {
                    name: 'TP no Target (-1.0 dBTP)',
                    data: { truePeakDbtp: -1.0, lufsIntegrated: -14.0, clippingPct: 0, dr: 8, stereoWidth: 0.6, stereoCorrelation: 0.6 },
                    check: (r) => ({
                        pass: r.scorePct >= 70,
                        reason: `Score: ${r.scorePct}% (esperado: ‚â•70%)`
                    }),
                    description: 'M√©tricas no target devem resultar em score alto'
                },
                {
                    name: 'LUFS Fora do Range (-6.0 LUFS)',
                    data: { truePeakDbtp: -1.0, lufsIntegrated: -6.0, clippingPct: 0, dr: 8 },
                    check: (r) => ({
                        pass: r.subscores?.loudness?.score <= 10,
                        reason: `Loudness subscore: ${r.subscores?.loudness?.score || 'N/A'}% (esperado: ‚â§10%)`
                    }),
                    description: 'LUFS fora do range para streaming deve zerar subscore'
                },
                {
                    name: 'Clipping Severo (10%)',
                    data: { truePeakDbtp: -1.0, lufsIntegrated: -14.0, clippingPct: 10, dr: 8 },
                    check: (r) => ({
                        pass: r.scorePct <= 50 && r.gatesApplied.some(g => g.type === 'CLIPPING_SEVERE'),
                        reason: `Score: ${r.scorePct}% (esperado: ‚â§50%), Gates: ${r.gatesApplied.map(g => g.type).join(', ')}`
                    }),
                    description: 'Clipping > 5% deve acionar gate e limitar score'
                },
                {
                    name: 'TP Warning (-0.05 dBTP)',
                    data: { truePeakDbtp: -0.05, lufsIntegrated: -14.0, clippingPct: 0, dr: 8 },
                    check: (r) => ({
                        pass: r.gatesApplied.some(g => g.type === 'TRUE_PEAK_WARNING'),
                        reason: `Gates: ${r.gatesApplied.map(g => g.type).join(', ') || 'nenhum'}`
                    }),
                    description: 'TP muito pr√≥ximo de 0 deve acionar warning'
                }
            ];
            
            let passed = 0;
            
            for (const test of tests) {
                const testEl = document.createElement('div');
                testEl.className = 'test-case running';
                testEl.innerHTML = `
                    <div class="test-title">üîÑ ${test.name}</div>
                    <div class="test-result">${test.description}</div>
                `;
                resultsEl.appendChild(testEl);
                
                await new Promise(r => setTimeout(r, 100));
                
                const result = await runTest(test.name, test.data, test.check, test.description);
                
                testEl.className = `test-case ${result.pass ? 'pass' : 'fail'}`;
                testEl.querySelector('.test-title').innerHTML = `${result.pass ? '‚úÖ' : '‚ùå'} ${test.name}`;
                testEl.querySelector('.test-result').innerHTML = result.reason;
                testEl.querySelector('.test-result').className = `test-result ${result.pass ? 'pass' : 'fail'}`;
                
                if (result.pass) passed++;
                testResults.push(result);
            }
            
            document.getElementById('summary-tests').textContent = `${passed} / ${tests.length}`;
            document.getElementById('summary-tests').className = passed === tests.length ? 'success' : 'critical';
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('debug-output').textContent = 'Aguardando...';
            document.getElementById('console-output').textContent = '';
            consoleBuffer = [];
            document.getElementById('summary-tests').textContent = '0 / 0';
        }
        
        // Inicializar
        setMode('streaming');
    </script>
</body>
</html>
