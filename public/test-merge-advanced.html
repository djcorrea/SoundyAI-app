<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Merge Avan√ßado True Peak</title>
</head>
<body>
    <h1>‚ö° Teste - Merge Avan√ßado com Busca em M√∫ltiplos Campos</h1>
    <p>Abra o console (F12) e observe os logs:</p>
    
    <div id="log-container">
        <h3>Valida√ß√£o da Busca em M√∫ltiplos Campos:</h3>
        <ol>
            <li>‚úÖ Prioridade: s.message ‚Üí s.original ‚Üí original.message ‚Üí original.original</li>
            <li>‚úÖ True Peak preservado mesmo se vier em campo alternativo</li>
            <li>‚úÖ Campo hasOriginalMessage indica se mensagem foi encontrada</li>
            <li>‚úÖ Fallback seguro apenas se todos campos est√£o vazios</li>
        </ol>
    </div>

    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px;">
        <h4>üß™ Cen√°rios de Teste:</h4>
        <button onclick="testScenario1()">1Ô∏è‚É£ s.message presente</button>
        <button onclick="testScenario2()">2Ô∏è‚É£ s.original presente</button>
        <button onclick="testScenario3()">3Ô∏è‚É£ original.message presente</button>
        <button onclick="testScenario4()">4Ô∏è‚É£ original.original presente</button>
        <button onclick="testScenario5()">5Ô∏è‚É£ Todos campos vazios</button>
        <button onclick="testTruePeakSpecific()">‚ö° True Peak espec√≠fico</button>
        <button onclick="console.clear()">üßπ Limpar Console</button>
    </div>

    <div id="result-display" style="margin: 20px 0; padding: 15px; background: #e7f3ff; border-radius: 5px;">
        <h4>üìä Resultado do √öltimo Teste:</h4>
        <div id="result-content">Nenhum teste executado ainda.</div>
    </div>

    <script>
        // Fun√ß√£o de merge implementada (c√≥pia da corre√ß√£o)
        function testMergeLogic(validSuggestions, enhancedSuggestions) {
            return enhancedSuggestions.map((s, i) => {
                const original = validSuggestions[i] || {};
                const originalMsg =
                    s.message ||
                    s.original ||
                    original.message ||
                    (original.original && typeof original.original === "string" ? original.original : null);

                const originalAction =
                    s.action ||
                    original.action ||
                    (original.originalAction && typeof original.originalAction === "string" ? original.originalAction : null);

                return {
                    ai_enhanced: true,
                    ...original,
                    ...s,
                    hasOriginalMessage: !!originalMsg,
                    message: originalMsg || "‚ö†Ô∏è Mensagem perdida na integra√ß√£o.",
                    action: originalAction,
                    priority: s.priority || original.priority || 1,
                    confidence: s.confidence || original.confidence || 0.9,
                };
            });
        }

        function displayResult(scenarioName, result, expected) {
            const div = document.getElementById('result-content');
            const success = result.message === expected;
            
            div.innerHTML = `
                <div><strong>Cen√°rio:</strong> ${scenarioName}</div>
                <div><strong>Resultado:</strong> ${success ? '‚úÖ SUCESSO' : '‚ùå FALHA'}</div>
                <div><strong>Mensagem obtida:</strong> "${result.message}"</div>
                <div><strong>Mensagem esperada:</strong> "${expected}"</div>
                <div><strong>hasOriginalMessage:</strong> ${result.hasOriginalMessage}</div>
                <div><strong>Dados completos:</strong> ${JSON.stringify(result, null, 2)}</div>
            `;
            
            console.log(`üß™ ${scenarioName}:`, {
                success,
                message: result.message,
                hasOriginalMessage: result.hasOriginalMessage,
                fullResult: result
            });
        }

        function testScenario1() {
            console.log('üß™ Cen√°rio 1: s.message presente');
            const validSuggestions = [{message: "Original message"}];
            const enhancedSuggestions = [{message: "AI message", original: "Alternative message"}];
            
            const result = testMergeLogic(validSuggestions, enhancedSuggestions)[0];
            const expected = "AI message";
            
            displayResult("s.message presente", result, expected);
        }

        function testScenario2() {
            console.log('üß™ Cen√°rio 2: s.original presente (s.message vazio)');
            const validSuggestions = [{message: "Original message"}];
            const enhancedSuggestions = [{message: null, original: "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA..."}];
            
            const result = testMergeLogic(validSuggestions, enhancedSuggestions)[0];
            const expected = "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA...";
            
            displayResult("s.original presente", result, expected);
        }

        function testScenario3() {
            console.log('üß™ Cen√°rio 3: original.message presente (s.message e s.original vazios)');
            const validSuggestions = [{message: "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA..."}];
            const enhancedSuggestions = [{message: null, original: null}];
            
            const result = testMergeLogic(validSuggestions, enhancedSuggestions)[0];
            const expected = "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA...";
            
            displayResult("original.message presente", result, expected);
        }

        function testScenario4() {
            console.log('üß™ Cen√°rio 4: original.original presente (outros vazios)');
            const validSuggestions = [{
                message: null, 
                original: "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA..."
            }];
            const enhancedSuggestions = [{message: null, original: null}];
            
            const result = testMergeLogic(validSuggestions, enhancedSuggestions)[0];
            const expected = "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA...";
            
            displayResult("original.original presente", result, expected);
        }

        function testScenario5() {
            console.log('üß™ Cen√°rio 5: Todos campos vazios (fallback)');
            const validSuggestions = [{message: null}];
            const enhancedSuggestions = [{message: null, original: null}];
            
            const result = testMergeLogic(validSuggestions, enhancedSuggestions)[0];
            const expected = "‚ö†Ô∏è Mensagem perdida na integra√ß√£o.";
            
            displayResult("Todos campos vazios", result, expected);
        }

        function testTruePeakSpecific() {
            console.log('‚ö° Teste espec√≠fico True Peak com dados reais');
            
            // Simular dados como podem vir do backend
            const validSuggestions = [{
                message: "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA. Reduza o limitador ou use compress√£o suave para evitar clipping digital.",
                action: "Ajustar limitador para -1.0 dB",
                priority: 1,
                type: "truePeak",
                metric: "true_peak",
                value: -0.3,
                target: -1.0
            }];
            
            // Resposta da IA que pode ter sobrescrito a mensagem
            const enhancedSuggestions = [{
                message: null,  // AI n√£o retornou mensagem
                original: null, // AI n√£o preservou em original
                action: "Apply limiter at -1.0 dB peak",
                ai_category: "mastering",
                blocks: {
                    problem: "True peak elevation detected",
                    solution: "Apply gentle limiting"
                }
            }];
            
            const result = testMergeLogic(validSuggestions, enhancedSuggestions)[0];
            const expected = "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA. Reduza o limitador ou use compress√£o suave para evitar clipping digital.";
            
            console.log('üéØ True Peak preservation test:', {
                originalMessage: validSuggestions[0].message,
                aiResponse: enhancedSuggestions[0],
                finalMessage: result.message,
                preserved: result.message === expected
            });
            
            displayResult("True Peak com dados reais", result, expected);
        }

        // Log inicial
        console.log("üöÄ [TEST] Teste de merge avan√ßado com busca em m√∫ltiplos campos iniciado");
        console.log("üîç Testando ordem de prioridade: s.message ‚Üí s.original ‚Üí original.message ‚Üí original.original");
    </script>
</body>
</html>