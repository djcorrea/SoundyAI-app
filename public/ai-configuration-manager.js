// üöÄ AI CONFIGURATION MANAGER - Gerenciamento Avan√ßado de Configura√ß√µes da IA
// Sistema robusto de configura√ß√£o, feature flags e fallbacks

class AIConfigurationManager {
    constructor() {
        this.isInitialized = false;
        this.settings = this.getDefaultSettings();
        this.featureFlags = this.getDefaultFeatureFlags();
        this.loadSavedSettings();
        
        console.log('üöÄ [AI-Config] Gerenciador de configura√ß√µes inicializado');
    }
    
    /**
     * üìã Configura√ß√µes padr√£o do sistema
     */
    getDefaultSettings() {
        return {
            // OpenAI API
            apiKey: '',
            model: 'gpt-3.5-turbo',
            maxTokens: 1500,
            temperature: 0.3,
            
            // Rate Limiting
            maxRequestsPerMinute: 10,
            timeoutMs: 15000,
            
            // Fallback
            fallbackMode: 'graceful', // 'graceful', 'aggressive', 'disabled'
            preserveOriginalSuggestions: true,
            
            // Cache
            enableCache: true,
            cacheExpirationHours: 24,
            maxCacheSize: 100,
            
            // UI
            enableGlassmorphism: true,
            animationsEnabled: true,
            compactMode: false,
            autoOpenModal: false,
            
            // Analytics
            enableAnalytics: true,
            trackUserInteractions: true,
            
            // Debug
            debugMode: false,
            verboseLogging: false
        };
    }
    
    /**
     * üéõÔ∏è Feature flags padr√£o
     */
    getDefaultFeatureFlags() {
        return {
            // Core Features
            AI_SUGGESTION_LAYER_ENABLED: true,
            AI_ENHANCED_PROCESSING: true,
            AI_BATCH_PROCESSING: false,
            
            // Experimental Features
            AI_REAL_TIME_ANALYSIS: false,
            AI_VOICE_SYNTHESIS: false,
            AI_AUTO_MASTERING: false,
            
            // UI Features
            AI_FULL_MODAL: true,
            AI_COMPACT_VIEW: true,
            AI_CHAT_INTEGRATION: true,
            AI_EXPORT_FEATURES: true,
            
            // Safety Features
            FALLBACK_TO_ORIGINAL: true,
            PRESERVE_EXISTING_PIPELINE: true,
            SAFE_MODE: true,
            
            // Performance Features
            ASYNC_PROCESSING: true,
            WORKER_THREADS: false,
            LAZY_LOADING: true
        };
    }
    
    /**
     * üíæ Carregar configura√ß√µes salvas
     */
    loadSavedSettings() {
        try {
            // Configura√ß√µes do localStorage
            const savedSettings = localStorage.getItem('ai_suggestion_settings');
            if (savedSettings) {
                const parsed = JSON.parse(savedSettings);
                this.settings = { ...this.settings, ...parsed };
            }
            
            // Feature flags do localStorage
            const savedFlags = localStorage.getItem('ai_feature_flags');
            if (savedFlags) {
                const parsed = JSON.parse(savedFlags);
                this.featureFlags = { ...this.featureFlags, ...parsed };
            }
            
            // Aplicar flags globalmente
            this.applyFeatureFlags();
            
            console.log('üíæ [AI-Config] Configura√ß√µes carregadas:', {
                settingsCount: Object.keys(this.settings).length,
                flagsEnabled: Object.values(this.featureFlags).filter(f => f).length
            });
            
        } catch (error) {
            console.error('‚ùå [AI-Config] Erro ao carregar configura√ß√µes:', error);
            this.resetToDefaults();
        }
    }
    
    /**
     * üéØ Aplicar feature flags globalmente
     */
    applyFeatureFlags() {
        // Aplicar flags principais no window
        Object.entries(this.featureFlags).forEach(([flag, enabled]) => {
            window[flag] = enabled;
        });
        
        // Configura√ß√µes especiais baseadas em flags
        if (!this.featureFlags.AI_SUGGESTION_LAYER_ENABLED) {
            this.disableAILayer();
        }
        
        if (this.featureFlags.SAFE_MODE) {
            this.enableSafeMode();
        }
        
        if (this.featureFlags.DEBUG_MODE) {
            this.enableDebugMode();
        }
    }
    
    /**
     * üíæ Salvar configura√ß√µes
     */
    saveSettings() {
        try {
            localStorage.setItem('ai_suggestion_settings', JSON.stringify(this.settings));
            localStorage.setItem('ai_feature_flags', JSON.stringify(this.featureFlags));
            
            console.log('üíæ [AI-Config] Configura√ß√µes salvas com sucesso');
            return true;
            
        } catch (error) {
            console.error('‚ùå [AI-Config] Erro ao salvar configura√ß√µes:', error);
            return false;
        }
    }
    
    /**
     * ‚öôÔ∏è Atualizar configura√ß√£o espec√≠fica
     */
    updateSetting(key, value) {
        if (this.settings.hasOwnProperty(key)) {
            const oldValue = this.settings[key];
            this.settings[key] = value;
            
            // Aplicar mudan√ßa se necess√°rio
            this.onSettingChanged(key, value, oldValue);
            
            // Auto-salvar
            this.saveSettings();
            
            console.log(`‚öôÔ∏è [AI-Config] Configura√ß√£o atualizada: ${key} = ${value}`);
            return true;
        }
        
        console.warn(`‚ö†Ô∏è [AI-Config] Configura√ß√£o n√£o encontrada: ${key}`);
        return false;
    }
    
    /**
     * üéõÔ∏è Toggle feature flag
     */
    toggleFeatureFlag(flag) {
        if (this.featureFlags.hasOwnProperty(flag)) {
            const newValue = !this.featureFlags[flag];
            this.featureFlags[flag] = newValue;
            
            // Aplicar globalmente
            window[flag] = newValue;
            
            // Aplicar mudan√ßas especiais
            this.onFeatureFlagChanged(flag, newValue);
            
            // Auto-salvar
            this.saveSettings();
            
            console.log(`üéõÔ∏è [AI-Config] Feature flag alterado: ${flag} = ${newValue}`);
            return newValue;
        }
        
        console.warn(`‚ö†Ô∏è [AI-Config] Feature flag n√£o encontrado: ${flag}`);
        return false;
    }
    
    /**
     * üîÑ Callback para mudan√ßas de configura√ß√£o
     */
    onSettingChanged(key, newValue, oldValue) {
        switch (key) {
            case 'apiKey':
                if (window.aiSuggestionLayer && newValue) {
                    window.aiSuggestionLayer.setApiKey(newValue);
                }
                break;
                
            case 'model':
                if (window.aiSuggestionLayer) {
                    window.aiSuggestionLayer.setModel(newValue);
                }
                break;
                
            case 'debugMode':
                if (newValue) {
                    this.enableDebugMode();
                } else {
                    this.disableDebugMode();
                }
                break;
                
            case 'enableCache':
                if (window.aiSuggestionLayer) {
                    window.aiSuggestionLayer.setCacheEnabled(newValue);
                }
                break;
                
            case 'enableGlassmorphism':
                this.updateUITheme();
                break;
        }
    }
    
    /**
     * üéØ Callback para mudan√ßas de feature flags
     */
    onFeatureFlagChanged(flag, enabled) {
        switch (flag) {
            case 'AI_SUGGESTION_LAYER_ENABLED':
                if (enabled) {
                    this.enableAILayer();
                } else {
                    this.disableAILayer();
                }
                break;
                
            case 'SAFE_MODE':
                if (enabled) {
                    this.enableSafeMode();
                } else {
                    this.disableSafeMode();
                }
                break;
                
            case 'AI_FULL_MODAL':
                this.updateUIFeatures();
                break;
                
            case 'FALLBACK_TO_ORIGINAL':
                if (window.aiSuggestionLayer) {
                    window.aiSuggestionLayer.setFallbackEnabled(enabled);
                }
                break;
        }
    }
    
    /**
     * üõ°Ô∏è Habilitar modo seguro
     */
    enableSafeMode() {
        // Configura√ß√µes conservadoras
        this.settings.preserveOriginalSuggestions = true;
        this.settings.fallbackMode = 'graceful';
        this.settings.maxRequestsPerMinute = 5;
        this.settings.timeoutMs = 10000;
        
        // Flags de seguran√ßa
        this.featureFlags.PRESERVE_EXISTING_PIPELINE = true;
        this.featureFlags.FALLBACK_TO_ORIGINAL = true;
        this.featureFlags.AI_BATCH_PROCESSING = false;
        
        console.log('üõ°Ô∏è [AI-Config] Modo seguro ativado');
    }
    
    /**
     * üö´ Desabilitar modo seguro
     */
    disableSafeMode() {
        // Restaurar configura√ß√µes padr√£o
        const defaults = this.getDefaultSettings();
        this.settings.maxRequestsPerMinute = defaults.maxRequestsPerMinute;
        this.settings.timeoutMs = defaults.timeoutMs;
        
        console.log('üö´ [AI-Config] Modo seguro desativado');
    }
    
    /**
     * ü§ñ Habilitar camada de IA
     */
    enableAILayer() {
        this.featureFlags.AI_SUGGESTION_LAYER_ENABLED = true;
        window.AI_SUGGESTION_LAYER_ENABLED = true;
        
        // Inicializar camada se necess√°rio
        if (window.aiSuggestionLayer) {
            window.aiSuggestionLayer.enable();
        }
        
        // Atualizar UI
        if (window.aiUIController) {
            window.aiUIController.updateStatus('success', 'IA ativada');
        }
        
        console.log('ü§ñ [AI-Config] Camada de IA habilitada');
    }
    
    /**
     * üö´ Desabilitar camada de IA
     */
    disableAILayer() {
        this.featureFlags.AI_SUGGESTION_LAYER_ENABLED = false;
        window.AI_SUGGESTION_LAYER_ENABLED = false;
        
        // Desabilitar camada
        if (window.aiSuggestionLayer) {
            window.aiSuggestionLayer.disable();
        }
        
        // Atualizar UI
        if (window.aiUIController) {
            window.aiUIController.updateStatus('disabled', 'IA desativada');
            window.aiUIController.hideAISection();
        }
        
        console.log('üö´ [AI-Config] Camada de IA desabilitada');
    }
    
    /**
     * üêõ Habilitar modo debug
     */
    enableDebugMode() {
        this.settings.debugMode = true;
        this.settings.verboseLogging = true;
        window.AI_DEBUG_MODE = true;
        
        // Configurar console mais verboso
        if (window.aiSuggestionLayer) {
            window.aiSuggestionLayer.setDebugMode(true);
        }
        
        console.log('üêõ [AI-Config] Modo debug ativado');
    }
    
    /**
     * üîá Desabilitar modo debug
     */
    disableDebugMode() {
        this.settings.debugMode = false;
        this.settings.verboseLogging = false;
        window.AI_DEBUG_MODE = false;
        
        if (window.aiSuggestionLayer) {
            window.aiSuggestionLayer.setDebugMode(false);
        }
        
        console.log('üîá [AI-Config] Modo debug desativado');
    }
    
    /**
     * üé® Atualizar tema da UI
     */
    updateUITheme() {
        const body = document.body;
        
        if (this.settings.enableGlassmorphism) {
            body.classList.add('ai-glassmorphism-enabled');
        } else {
            body.classList.remove('ai-glassmorphism-enabled');
        }
        
        if (this.settings.compactMode) {
            body.classList.add('ai-compact-mode');
        } else {
            body.classList.remove('ai-compact-mode');
        }
    }
    
    /**
     * üß© Atualizar recursos da UI
     */
    updateUIFeatures() {
        // Esconder/mostrar elementos baseado em flags
        const elements = {
            fullModal: document.getElementById('aiSuggestionsFullModal'),
            compactView: document.querySelector('.ai-suggestions-compact'),
            exportBtn: document.querySelector('.ai-export-btn')
        };
        
        if (elements.fullModal) {
            elements.fullModal.style.display = this.featureFlags.AI_FULL_MODAL ? 'flex' : 'none';
        }
        
        if (elements.exportBtn) {
            elements.exportBtn.style.display = this.featureFlags.AI_EXPORT_FEATURES ? 'block' : 'none';
        }
    }
    
    /**
     * üîÑ Resetar para configura√ß√µes padr√£o
     */
    resetToDefaults() {
        this.settings = this.getDefaultSettings();
        this.featureFlags = this.getDefaultFeatureFlags();
        this.applyFeatureFlags();
        this.saveSettings();
        
        console.log('üîÑ [AI-Config] Configura√ß√µes resetadas para padr√£o');
    }
    
    /**
     * üóÇÔ∏è Exportar configura√ß√µes
     */
    exportConfiguration() {
        const config = {
            settings: this.settings,
            featureFlags: this.featureFlags,
            exportedAt: new Date().toISOString(),
            version: '1.0.0'
        };
        
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `ai-config-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('üóÇÔ∏è [AI-Config] Configura√ß√µes exportadas');
    }
    
    /**
     * üì• Importar configura√ß√µes
     */
    importConfiguration(configFile) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    // Validar estrutura
                    if (config.settings && config.featureFlags) {
                        this.settings = { ...this.settings, ...config.settings };
                        this.featureFlags = { ...this.featureFlags, ...config.featureFlags };
                        
                        this.applyFeatureFlags();
                        this.saveSettings();
                        
                        console.log('üì• [AI-Config] Configura√ß√µes importadas com sucesso');
                        resolve(true);
                    } else {
                        throw new Error('Formato de arquivo inv√°lido');
                    }
                    
                } catch (error) {
                    console.error('‚ùå [AI-Config] Erro ao importar configura√ß√µes:', error);
                    reject(error);
                }
            };
            
            reader.readAsText(configFile);
        });
    }
    
    /**
     * üîç Validar configura√ß√£o
     */
    validateConfiguration() {
        const issues = [];
        
        // Validar API Key
        if (!this.settings.apiKey || this.settings.apiKey.length < 10) {
            issues.push('API Key da OpenAI inv√°lida ou n√£o configurada');
        }
        
        // Validar modelo
        const validModels = ['gpt-3.5-turbo', 'gpt-4', 'gpt-4-turbo'];
        if (!validModels.includes(this.settings.model)) {
            issues.push(`Modelo inv√°lido: ${this.settings.model}`);
        }
        
        // Validar rate limiting
        if (this.settings.maxRequestsPerMinute < 1 || this.settings.maxRequestsPerMinute > 60) {
            issues.push('Rate limiting fora do intervalo v√°lido (1-60)');
        }
        
        // Validar timeout
        if (this.settings.timeoutMs < 5000 || this.settings.timeoutMs > 60000) {
            issues.push('Timeout fora do intervalo v√°lido (5s-60s)');
        }
        
        return {
            isValid: issues.length === 0,
            issues: issues
        };
    }
    
    /**
     * üìä Obter estat√≠sticas da configura√ß√£o
     */
    getConfigurationStats() {
        const validation = this.validateConfiguration();
        const enabledFlags = Object.values(this.featureFlags).filter(f => f).length;
        
        return {
            isConfigured: !!this.settings.apiKey,
            isValid: validation.isValid,
            issues: validation.issues,
            enabledFeatures: enabledFlags,
            totalFeatures: Object.keys(this.featureFlags).length,
            safeMode: this.featureFlags.SAFE_MODE,
            debugMode: this.settings.debugMode,
            cacheEnabled: this.settings.enableCache,
            lastSaved: localStorage.getItem('ai_config_last_saved') || 'Nunca'
        };
    }
    
    /**
     * üõ†Ô∏è Obter configura√ß√£o espec√≠fica
     */
    getSetting(key) {
        return this.settings[key];
    }
    
    /**
     * üéõÔ∏è Obter feature flag espec√≠fica
     */
    getFeatureFlag(flag) {
        return this.featureFlags[flag];
    }
    
    /**
     * üìã Obter todas as configura√ß√µes
     */
    getAllSettings() {
        return { ...this.settings };
    }
    
    /**
     * üéØ Obter todas as feature flags
     */
    getAllFeatureFlags() {
        return { ...this.featureFlags };
    }
}

// üåç Fun√ß√µes globais para controle de configura√ß√£o

/**
 * ü§ñ Toggle global da IA
 */
window.toggleAI = function() {
    if (window.aiConfigManager) {
        return window.aiConfigManager.toggleFeatureFlag('AI_SUGGESTION_LAYER_ENABLED');
    }
    return false;
};

/**
 * üõ°Ô∏è Toggle modo seguro
 */
window.toggleSafeMode = function() {
    if (window.aiConfigManager) {
        return window.aiConfigManager.toggleFeatureFlag('SAFE_MODE');
    }
    return false;
};

/**
 * üêõ Toggle modo debug
 */
window.toggleDebugMode = function() {
    if (window.aiConfigManager) {
        return window.aiConfigManager.toggleFeatureFlag('DEBUG_MODE');
    }
    return false;
};

/**
 * ‚öôÔ∏è Configura√ß√£o r√°pida
 */
window.quickConfigureAI = function(apiKey, model = 'gpt-3.5-turbo') {
    if (window.aiConfigManager) {
        window.aiConfigManager.updateSetting('apiKey', apiKey);
        window.aiConfigManager.updateSetting('model', model);
        return true;
    }
    return false;
};

/**
 * üìä Verificar status da configura√ß√£o
 */
window.getAIConfigStatus = function() {
    if (window.aiConfigManager) {
        return window.aiConfigManager.getConfigurationStats();
    }
    return { isConfigured: false, isValid: false };
};

// üöÄ Inicializa√ß√£o autom√°tica
(function() {
    'use strict';
    
    // Criar inst√¢ncia global do gerenciador
    window.aiConfigManager = new AIConfigurationManager();
    
    console.log('üöÄ [AI-Config] Sistema de configura√ß√£o inicializado globalmente');
    
    // Marcar timestamp da √∫ltima inicializa√ß√£o
    localStorage.setItem('ai_config_last_saved', new Date().toISOString());
    
})();