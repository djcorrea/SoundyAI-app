<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Merge Seguro AI Suggestions</title>
    <!-- âœ… CRITICAL: Logger DEVE ser o primeiro script carregado -->
    <script src="logger.js"></script>
    

</head>
<body>
    <h1>ğŸ”„ Teste - Merge Seguro de SugestÃµes IA</h1>
    <p>Abra o console (F12) e observe os logs:</p>
    
    <div id="log-container">
        <h3>ValidaÃ§Ã£o do Merge:</h3>
        <ol>
            <li>âœ… Mensagens originais preservadas (especialmente True Peak)</li>
            <li>âœ… Campos `message`, `action`, `priority` nunca nulos</li>
            <li>âœ… Fallback para valores seguros quando dados ausentes</li>
            <li>âœ… Logs de auditoria mostram preservaÃ§Ã£o</li>
        </ol>
    </div>

    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px;">
        <h4>ğŸ§ª Ferramentas de Teste:</h4>
        <button onclick="testMergeFunction()">ğŸ”„ Testar FunÃ§Ã£o de Merge</button>
        <button onclick="simulateAIResponse()">ğŸ¤– Simular Resposta IA</button>
        <button onclick="testTruePeakPreservation()">âš¡ Testar PreservaÃ§Ã£o True Peak</button>
        <button onclick="console.clear()">ğŸ§¹ Limpar Console</button>
    </div>

    <div id="suggestion-display" style="margin: 20px 0; padding: 15px; background: #e7f3ff; border-radius: 5px;">
        <h4>ğŸ“‹ SugestÃµes Resultantes:</h4>
        <div id="suggestion-content">Nenhuma sugestÃ£o processada ainda.</div>
    </div>

    <script>
        // Simular algumas sugestÃµes originais tÃ­picas
        const mockOriginalSuggestions = [
            {
                message: "âš¡ True Peak requer correÃ§Ã£o PRIORITÃRIA. Reduza o limitador ou use compressÃ£o suave para evitar clipping digital.",
                action: "Ajustar limitador para -1.0 dB",
                priority: 1,
                type: "truePeak",
                metric: "true_peak",
                value: -0.3,
                target: -1.0
            },
            {
                message: "ğŸ“Š LUFS muito baixo. Aumente o volume geral ou use compressÃ£o para atingir o padrÃ£o de streaming.",
                action: "Aumentar gain para -14 LUFS",
                priority: 2,
                type: "lufs",
                metric: "lufs",
                value: -18.5,
                target: -14.0
            },
            {
                message: "ğŸµ Dynamic Range adequado para o gÃªnero, mas pode ser otimizado.",
                action: "Considerar ligeira compressÃ£o",
                priority: 3,
                type: "dynamicRange",
                metric: "dr",
                value: 8.2,
                target: 7.0
            }
        ];

        // Simular resposta da IA (com alguns valores nulos para testar fallback)
        const mockAIResponse = [
            {
                message: null,  // Deveria usar original
                action: "Aplique um limiter configurado para -1.0 dB como peak mÃ¡ximo",
                priority: null, // Deveria usar original
                confidence: 0.95,
                ai_category: "mastering",
                blocks: {
                    problem: "True peak elevation detected",
                    solution: "Apply gentle limiting"
                }
            },
            {
                message: "Enhanced: LUFS optimization required for streaming platforms",
                action: null,   // Deveria usar original
                priority: 1,
                confidence: 0.88,
                ai_category: "loudness",
                blocks: {
                    problem: "Loudness below streaming standards",
                    solution: "Increase overall level"
                }
            },
            {
                message: null,
                action: null,   // Ambos nulos, deveria usar originais
                priority: null,
                confidence: null, // Deveria usar fallback 0.9
                ai_category: "dynamics",
                blocks: {}
            }
        ];

        function testMergeFunction() {
            log('ğŸ§ª [TEST] Testando funÃ§Ã£o de merge com dados simulados...');
            
            // Simular o merge seguro como implementado
            const enhanced = mockAIResponse.map((s, i) => {
                const original = mockOriginalSuggestions[i] || {};
                return {
                    ...original,             // preserva mensagem e aÃ§Ã£o originais
                    ...s,                    // mescla enriquecimentos e metadados
                    ai_enhanced: true,
                    message: s.message || original.message || 'âš ï¸ Sem mensagem original detectada.',
                    action: s.action || original.action || null,
                    priority: s.priority || original.priority || 1,
                    confidence: s.confidence || original.confidence || 0.9,
                };
            });

            log('âœ… Resultado do merge:', enhanced);
            
            // Validar que nÃ£o hÃ¡ campos nulos crÃ­ticos
            enhanced.forEach((sug, i) => {
                const issues = [];
                if (!sug.message || sug.message.includes('âš ï¸')) issues.push('message');
                if (sug.action === null && mockOriginalSuggestions[i]?.action) issues.push('action');
                if (!sug.priority) issues.push('priority');
                
                if (issues.length > 0) {
                    error(`âŒ SugestÃ£o ${i + 1} tem problemas:`, issues);
                } else {
                    log(`âœ… SugestÃ£o ${i + 1} preservada corretamente`);
                }
            });

            updateSuggestionDisplay(enhanced);
        }

        function simulateAIResponse() {
            log('ğŸ¤– [TEST] Simulando resposta completa da IA...');
            
            // Simular dados como viriam do backend
            const mockBackendResponse = {
                enhancedSuggestions: mockAIResponse,
                source: 'ai',
                success: true
            };

            log('ğŸ“¦ Mock backend response:', mockBackendResponse);
            
            // Testar preservaÃ§Ã£o
            testMergeFunction();
        }

        function testTruePeakPreservation() {
            log('âš¡ [TEST] Testando preservaÃ§Ã£o especÃ­fica do True Peak...');
            
            const truePeakOriginal = mockOriginalSuggestions[0];
            const truePeakAI = mockAIResponse[0];
            
            log('Original True Peak:', {
                message: truePeakOriginal.message,
                action: truePeakOriginal.action,
                priority: truePeakOriginal.priority
            });

            log('AI Response (com nulls):', {
                message: truePeakAI.message,
                action: truePeakAI.action,
                priority: truePeakAI.priority
            });

            // Merge seguro
            const merged = {
                ...truePeakOriginal,
                ...truePeakAI,
                ai_enhanced: true,
                message: truePeakAI.message || truePeakOriginal.message || 'âš ï¸ Sem mensagem original detectada.',
                action: truePeakAI.action || truePeakOriginal.action || null,
                priority: truePeakAI.priority || truePeakOriginal.priority || 1,
                confidence: truePeakAI.confidence || truePeakOriginal.confidence || 0.9,
            };

            log('âœ… True Peak apÃ³s merge seguro:', {
                message: merged.message,
                action: merged.action,
                priority: merged.priority,
                ai_enhanced: merged.ai_enhanced,
                preserved_original_message: merged.message === truePeakOriginal.message
            });

            if (merged.message === truePeakOriginal.message) {
                log('ğŸ¯ SUCESSO: Mensagem prioritÃ¡ria do True Peak preservada!');
            } else {
                error('âŒ FALHA: Mensagem do True Peak foi alterada!');
            }
        }

        function updateSuggestionDisplay(suggestions) {
            const div = document.getElementById('suggestion-content');
            let html = '';
            
            suggestions.forEach((sug, i) => {
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: ${sug.priority === 1 ? '#fff3cd' : '#f8f9fa'}; border-radius: 5px;">
                        <strong>SugestÃ£o ${i + 1} (${sug.type || 'unknown'}):</strong><br>
                        <div style="margin: 5px 0;"><strong>Message:</strong> ${sug.message || 'N/A'}</div>
                        <div style="margin: 5px 0;"><strong>Action:</strong> ${sug.action || 'N/A'}</div>
                        <div style="margin: 5px 0;"><strong>Priority:</strong> ${sug.priority || 'N/A'}</div>
                        <div style="margin: 5px 0;"><strong>AI Enhanced:</strong> ${sug.ai_enhanced || false}</div>
                        <div style="margin: 5px 0;"><strong>Confidence:</strong> ${sug.confidence || 'N/A'}</div>
                    </div>
                `;
            });
            
            div.innerHTML = html || 'Nenhuma sugestÃ£o processada ainda.';
        }

        // Log inicial
        log("ğŸš€ [TEST] Teste de merge seguro de sugestÃµes iniciado");
        log("ğŸ“‹ SugestÃµes originais mockadas:", mockOriginalSuggestions);
        log("ğŸ¤– Resposta IA mockada (com nulls):", mockAIResponse);
    </script>
</body>
</html>