<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Conta - PROD.AI</title>
    
    <!-- Bibliotecas para efeitos visuais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.net.min.js" defer></script>
    
    <link rel="stylesheet" href="gerenciar.css">
</head>
<body class="page-doc">
    <!-- Background Elements -->
    <div class="background-container">
        <!-- Container para o fundo animado Vanta.js -->
        <div class="vanta-background" id="vanta-bg"></div>
        
        <!-- Plano de fundo neural (fallback) -->
        <div class="fundo-neural"></div>
        
        <div class="particles" id="particles"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1 class="page-title">Gerenciar conta</h1>
            
            <div class="plan-status" id="plan-status">
                <div class="plan-info">
                    <span class="plan-label">Plano atual:</span>
                    <span class="plan-type plus" id="plan-type">
                        <span class="plan-name">PLUS</span>
                        <span class="plan-icon">âœ…</span>
                    </span>
                </div>
            </div>
            
            <button class="btn-back-simple" id="back-to-chat-simple">
                <span class="back-icon">ğŸ”™</span>
                Voltar ao chat
            </button>
        </div>

        <div class="form-container">
            <!-- Grid de Cards Principais -->
            <div class="cards-grid">
                <!-- Card: Alterar Senha -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">ğŸ”’</span>
                        <h3 class="card-title">Alterar Senha</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <div class="input-group">
                                <label for="new-password">Nova senha</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">ğŸ”’</span>
                                    <input type="password" id="new-password" placeholder="Digite sua nova senha">
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="confirm-password">Confirmar senha</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">ğŸ”’</span>
                                    <input type="password" id="confirm-password" placeholder="Confirme sua nova senha">
                                </div>
                            </div>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-primary" id="update-password-btn">Atualizar senha</button>
                        </div>
                    </div>
                </section>

                <!-- Card: Alterar E-mail -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">âœ‰ï¸</span>
                        <h3 class="card-title">Alterar E-mail</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <div class="input-group">
                                <label for="new-email">Novo e-mail</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">âœ‰ï¸</span>
                                    <input type="email" id="new-email" placeholder="Digite seu novo e-mail">
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="confirm-email">Confirmar e-mail</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">âœ‰ï¸</span>
                                    <input type="email" id="confirm-email" placeholder="Confirme seu novo e-mail">
                                </div>
                            </div>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-primary" id="update-email-btn">Atualizar e-mail</button>
                        </div>
                    </div>
                </section>

                <!-- Card: Refazer Entrevista -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">â™»ï¸</span>
                        <h3 class="card-title">Personalizar Novamente</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Quer mudar suas respostas personalizadas?</p>
                            <p class="card-description">RefaÃ§a o processo de configuraÃ§Ã£o inicial.</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-special" id="redo-interview-btn">
                                <span class="btn-icon">â™»ï¸</span>
                                Personalizar novamente
                            </button>
                            <p class="info-text">DisponÃ­vel para usuÃ¡rios Plus e Pro.</p>
                        </div>
                    </div>
                </section>

                <!-- Card: Fazer Upgrade -->
                <section class="function-card upgrade-card" id="upgrade-card">
                    <div class="card-header">
                        <span class="card-icon">ğŸ”“</span>
                        <h3 class="card-title">Upgrade de Plano</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">VocÃª estÃ¡ no plano gratuito. Desbloqueie todo o potencial do PROD.AI</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-upgrade-premium" id="upgrade-plan-btn">
                                <span class="btn-icon">â­</span>
                                Fazer Upgrade para Plus
                            </button>
                            <p class="upgrade-benefits">Desbloqueie mensagens ilimitadas e respostas avanÃ§adas</p>
                        </div>
                    </div>
                </section>

                <!-- Card: Cancelar Assinatura -->
                <section class="function-card card-perigo">
                    <div class="card-header">
                        <span class="card-icon">âŒ</span>
                        <h3 class="card-title">Cancelar Assinatura</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Cancelar sua assinatura atual do plano Plus.</p>
                            <p class="card-description">VocÃª manterÃ¡ acesso atÃ© o fim do perÃ­odo atual.</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-danger" id="cancel-subscription-btn">
                                <span class="btn-icon">âŒ</span>
                                Cancelar assinatura
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Card: Excluir Conta -->
                <section class="function-card card-perigo">
                    <div class="card-header">
                        <span class="card-icon">âš ï¸</span>
                        <h3 class="card-title">Zona de Perigo</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">
                                <strong>âš ï¸ Esta aÃ§Ã£o Ã© irreversÃ­vel!</strong>
                            </p>
                            <p class="card-description">
                                Ao excluir sua conta, todos os dados serÃ£o perdidos permanentemente.
                            </p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-delete-account" id="delete-account-btn">
                                <span class="btn-icon">ğŸ—‘ï¸</span>
                                Excluir Conta Permanentemente
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- SeÃ§Ã£o de Suporte - RodapÃ© -->
        <div class="support-footer-card">
            <h3 class="support-footer-title">
                <span class="support-icon">ğŸ’¬</span>
                Suporte
            </h3>
            <p class="support-footer-text">Precisa de ajuda? Entre em contato conosco:</p>
            <div class="support-footer-contact">
                <span class="support-email">soundyaibr@gmail.com</span>
            </div>
            <div class="support-footer-info">
                <div class="support-footer-item">
                    <span class="support-item-icon">ğŸ“</span>
                    <span>Suporte telefÃ´nico: Seg-Sex, 9h-18h</span>
                </div>
                <div class="support-footer-item">
                    <span class="support-item-icon">ğŸ’¬</span>
                    <span>Chat online: 24h</span>
                </div>
                <div class="support-footer-item">
                    <span class="support-item-icon">âš¡</span>
                    <span>Resposta em atÃ© 2 horas</span>
            </div>
        </div>
    </div>

    <!-- Modal de ConfirmaÃ§Ã£o de Cancelamento -->
    <div class="cancel-confirmation-overlay" id="cancel-confirmation-overlay">
        <div class="cancel-confirmation-modal">
            <div class="cancel-modal-content">
                <div class="cancel-modal-icon">âš ï¸</div>
                <h3 class="cancel-modal-title">Cancelar Assinatura</h3>
                <p class="cancel-modal-description">
                    Tem certeza que deseja cancelar sua assinatura? VocÃª continuarÃ¡ com acesso ao Plus atÃ© o fim do perÃ­odo atual.
                </p>
                <div class="cancel-modal-buttons">
                    <button class="cancel-modal-btn cancel-modal-btn-cancel" id="cancel-modal-btn-cancel">
                        <span class="btn-icon">âŒ</span>
                        Cancelar
                    </button>
                    <button class="cancel-modal-btn cancel-modal-btn-confirm" id="cancel-modal-btn-confirm">
                        <span class="btn-icon">âœ…</span>
                        Confirmar Cancelamento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de ConfirmaÃ§Ã£o de ExclusÃ£o de Conta -->
    <div class="delete-account-confirmation-overlay" id="delete-account-confirmation-overlay">
        <div class="delete-account-confirmation-modal">
            <div class="delete-account-modal-content">
                <div class="delete-account-modal-icon">âš ï¸</div>
                <h3 class="delete-account-modal-title">âš ï¸ Tem certeza que deseja excluir sua conta?</h3>
                <p class="delete-account-modal-description">
                    Essa aÃ§Ã£o Ã© irreversÃ­vel e todos os seus dados, incluindo e-mail e senha, serÃ£o permanentemente apagados.
                </p>
                <div class="delete-account-modal-buttons">
                    <button class="delete-account-modal-btn delete-account-modal-btn-cancel" id="delete-account-modal-btn-cancel">
                        <span class="btn-icon">âŒ</span>
                        Cancelar
                    </button>
                    <button class="delete-account-modal-btn delete-account-modal-btn-confirm" id="delete-account-modal-btn-confirm">
                        <span class="btn-icon">ğŸ—‘ï¸</span>
                        Sim, excluir minha conta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de ConfirmaÃ§Ã£o ApÃ³s Cancelamento -->
    <div class="success-confirmation-overlay" id="success-confirmation-overlay">
        <div class="success-confirmation-modal">
            <div class="success-modal-content">
                <div class="success-modal-icon">âœ…</div>
                <h3 class="success-modal-title">Assinatura Cancelada com Sucesso!</h3>
                <p class="success-modal-description" id="success-modal-description">
                    Sua assinatura foi cancelada. VocÃª continuarÃ¡ com acesso ao Plus atÃ© o fim do perÃ­odo atual.
                </p>
                <div class="success-modal-buttons">
                    <button class="success-modal-btn" id="success-modal-btn-ok">
                        <span class="btn-icon">ğŸ‘</span>
                        Entendi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="background-effects">
        <div class="glow-effect glow-1"></div>
        <div class="glow-effect glow-2"></div>
        <div class="neural-network">
            <div class="neural-node node-1"></div>
            <div class="neural-node node-2"></div>
            <div class="neural-node node-3"></div>
        </div>
    </div>

    <!-- Firebase e Script de Gerenciamento -->
    <script type="module">
        // ğŸš¨ GUARDRAIL CRÃTICO: Executar ANTES de qualquer lÃ³gica de auth
        // Se for resetPassword, redirecionar IMEDIATAMENTE para /primeiro-acesso.html
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const oobCode = urlParams.get('oobCode');
            
            console.log('[GERENCIAR] PÃ¡gina carregada');
            console.log('[GERENCIAR] mode =', mode || '(ausente)');
            console.log('[GERENCIAR] hasOobCode =', !!oobCode);
            console.log('[GERENCIAR] fullUrl =', window.location.href);
            
            // ğŸš¨ SE FOR RESETPASSWORD: REDIRECIONAR IMEDIATAMENTE
            if (mode === 'resetPassword') {
                console.log('ğŸ”€ [GERENCIAR] resetPassword detectado - redirecionando AGORA');
                console.log('ğŸ”€ [GERENCIAR] Redirecionando para: /primeiro-acesso.html' + window.location.search);
                
                // location.replace para nÃ£o adicionar no histÃ³rico (evita "piscar")
                window.location.replace('/primeiro-acesso.html' + window.location.search);
                
                // Parar execuÃ§Ã£o do script
                throw new Error('Redirecting resetPassword to primeiro-acesso.html');
            }
            
            console.log('âœ… [GERENCIAR] NÃ£o Ã© resetPassword, continuando fluxo normal');
        })();
        
        // Aguardar um pouco para garantir que o Firebase carregue
        setTimeout(async () => {
            const { auth } = await import('./firebase.js');
            const { onAuthStateChanged, updatePassword, updateEmail, verifyBeforeUpdateEmail, applyActionCode, signOut } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js');
            
            console.log('ğŸ”§ Gerenciar.js carregado');
            
            // Elementos do DOM
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const updatePasswordBtn = document.getElementById('update-password-btn');
            const newEmailInput = document.getElementById('new-email');
            const confirmEmailInput = document.getElementById('confirm-email');
            const updateEmailBtn = document.getElementById('update-email-btn');
            const redoInterviewBtn = document.getElementById('redo-interview-btn');
            const backToChatBtn = document.getElementById('back-to-chat-simple');
            const upgradeBtn = document.getElementById('upgrade-plan-btn');
            const cancelSubscriptionBtn = document.getElementById('cancel-subscription-btn');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            
            // Verificar se o usuÃ¡rio estÃ¡ autenticado
            let currentUser = null;
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    console.log('âœ… UsuÃ¡rio autenticado:', user.email);
                    
                    // Atualizar informaÃ§Ãµes do usuÃ¡rio na pÃ¡gina
                    updateUserInfo(user);
                    
                    // Verificar se hÃ¡ cÃ³digo de verificaÃ§Ã£o na URL
                    checkEmailVerificationCode();
                } else {
                    console.log('âŒ UsuÃ¡rio nÃ£o autenticado - redirecionando...');
                    // Redirecionar usuÃ¡rios nÃ£o autenticados
                    window.location.href = 'login.html';
                }
            });
            
            // FunÃ§Ã£o para atualizar informaÃ§Ãµes do usuÃ¡rio
            async function updateUserInfo(user) {
                console.log('ğŸ“§ Email do usuÃ¡rio:', user.email);
                console.log('ğŸ†” UID do usuÃ¡rio:', user.uid);
                
                // Buscar dados do usuÃ¡rio no Firestore para determinar o plano
                await updateUserPlanDisplay(user.uid);
            }
            
            // FunÃ§Ã£o para buscar e atualizar a exibiÃ§Ã£o do plano do usuÃ¡rio
            async function updateUserPlanDisplay(userId) {
                try {
                    console.log('ğŸ” Buscando dados do plano do usuÃ¡rio...');
                    
                    // Importar Firestore necessÃ¡rio
                    const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js');
                    const { db } = await import('./firebase.js');
                    
                    // Buscar documento do usuÃ¡rio
                    const userDocRef = doc(db, 'usuarios', userId);
                    const userDoc = await getDoc(userDocRef);
                    
                    // Elementos do DOM para atualizar
                    const planTypeElement = document.getElementById('plan-type');
                    const planNameElement = planTypeElement?.querySelector('.plan-name');
                    const planIconElement = planTypeElement?.querySelector('.plan-icon');
                    const cancelSubscriptionBtn = document.getElementById('cancel-subscription-btn');
                    
                    if (!planTypeElement || !planNameElement || !planIconElement) {
                        console.error('âŒ Elementos do plano nÃ£o encontrados no DOM');
                        return;
                    }
                    
                    let userPlan = 'free';
                    let isPaidPlan = false;
                    let isCancellationPending = false;
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        
                        // âœ… NOVA ESTRUTURA STRIPE: Usar campo 'plan' e 'subscription'
                        // Fallback para campos antigos se necessÃ¡rio
                        userPlan = userData.plan || userData.plano || 'free';
                        const subscription = userData.subscription || {};
                        
                        console.log('ğŸ“Š Dados do usuÃ¡rio (nova estrutura):', {
                            plan: userPlan,
                            subscription: {
                                id: subscription.id,
                                status: subscription.status,
                                priceId: subscription.priceId,
                                cancel_at_period_end: subscription.cancel_at_period_end,
                                currentPeriodEnd: subscription.currentPeriodEnd
                            },
                            // Campos legados
                            plano_legado: userData.plano,
                            isPlus_legado: userData.isPlus,
                        });
                        
                        // Verificar status da assinatura
                        const subStatus = subscription.status;
                        const isActiveStatus = ['active', 'active_until_period_end', 'trialing'].includes(subStatus);
                        
                        // Plano pago ativo = plan Ã© plus/pro E (status ativo OU assinatura vÃ¡lida)
                        if (userPlan === 'plus' || userPlan === 'pro') {
                            if (isActiveStatus || !subStatus) {
                                isPaidPlan = true;
                            }
                        }
                        
                        // Verificar se cancelamento estÃ¡ pendente
                        isCancellationPending = subscription.cancel_at_period_end === true || 
                                                 subStatus === 'active_until_period_end';
                        
                        // Se a assinatura estÃ¡ cancelada e expirou, considerar como free
                        if (subStatus === 'canceled' && subscription.currentPeriodEnd) {
                            const now = new Date();
                            const periodEnd = new Date(subscription.currentPeriodEnd);
                            if (periodEnd <= now) {
                                isPaidPlan = false;
                                userPlan = 'free';
                                console.log('â° Plano expirou, considerando como FREE');
                            }
                        }
                    } else {
                        console.log('âš ï¸ Documento do usuÃ¡rio nÃ£o encontrado, usando plano gratuito como padrÃ£o');
                    }
                    
                    // Atualizar a exibiÃ§Ã£o do plano
                    const upgradeCard = document.getElementById('upgrade-card');
                    const cancelCards = document.querySelectorAll('.card-perigo');
                    
                    // âœ… ATUALIZADO 2026-01-06: Suporte ao plano STUDIO
                    if (userPlan === 'studio') {
                        // UsuÃ¡rio STUDIO (R$99,90/mÃªs)
                        planTypeElement.className = 'plan-type studio';
                        planNameElement.textContent = 'STUDIO';
                        planIconElement.textContent = 'ğŸ§';
                        console.log('ğŸ§ Exibindo plano STUDIO');
                        
                        if (upgradeCard) upgradeCard.style.display = 'none';
                        cancelCards.forEach(card => {
                            if (!card.querySelector('#delete-account-btn')) {
                                card.style.display = 'block';
                            }
                        });
                        
                    } else if (userPlan === 'pro') {
                        // UsuÃ¡rio PRO
                        planTypeElement.className = 'plan-type pro';
                        planNameElement.textContent = 'PRO';
                        planIconElement.textContent = 'â­';
                        console.log('â­ Exibindo plano PRO');
                        
                        if (upgradeCard) upgradeCard.style.display = 'none';
                        cancelCards.forEach(card => {
                            if (!card.querySelector('#delete-account-btn')) {
                                card.style.display = 'block';
                            }
                        });
                        
                    } else if (userPlan === 'plus' && isPaidPlan) {
                        // UsuÃ¡rio PLUS
                        planTypeElement.className = 'plan-type plus';
                        planNameElement.textContent = 'PLUS';
                        planIconElement.textContent = 'âœ…';
                        console.log('âœ… Exibindo plano PLUS');
                        
                        if (upgradeCard) upgradeCard.style.display = 'none';
                        cancelCards.forEach(card => {
                            if (!card.querySelector('#delete-account-btn')) {
                                card.style.display = 'block';
                            }
                        });
                        
                    } else {
                        // UsuÃ¡rio GRATUITO
                        planTypeElement.className = 'plan-type free';
                        planNameElement.textContent = 'GRÃTIS';
                        planIconElement.textContent = 'âŒ';
                        console.log('ğŸ“± Exibindo plano GRATUITO');
                        
                        if (upgradeCard) upgradeCard.style.display = 'block';
                        cancelCards.forEach(card => {
                            if (!card.querySelector('#delete-account-btn')) {
                                card.style.display = 'none';
                            }
                        });
                    }
                    
                    // Atualizar estado do botÃ£o de cancelamento
                    if (cancelSubscriptionBtn) {
                        if (isCancellationPending) {
                            cancelSubscriptionBtn.disabled = true;
                            cancelSubscriptionBtn.innerHTML = '<span class="btn-icon">ğŸ“…</span>Cancelamento agendado';
                            cancelSubscriptionBtn.classList.add('btn-disabled');
                            console.log('ğŸ“… Cancelamento jÃ¡ agendado');
                        } else if (isPaidPlan) {
                            cancelSubscriptionBtn.disabled = false;
                            cancelSubscriptionBtn.innerHTML = '<span class="btn-icon">âŒ</span>Cancelar assinatura';
                            cancelSubscriptionBtn.classList.remove('btn-disabled');
                        }
                    }
                    
                } catch (error) {
                    console.error('âŒ Erro ao buscar dados do plano:', error);
                    
                    // Em caso de erro, mostrar como gratuito por seguranÃ§a
                    const planTypeElement = document.getElementById('plan-type');
                    const planNameElement = planTypeElement?.querySelector('.plan-name');
                    const planIconElement = planTypeElement?.querySelector('.plan-icon');
                    
                    if (planTypeElement && planNameElement && planIconElement) {
                        planTypeElement.className = 'plan-type free';
                        planNameElement.textContent = 'GRÃTIS';
                        planIconElement.textContent = 'âŒ';
                        console.log('âš ï¸ Erro ao carregar plano, exibindo GRATUITO como padrÃ£o');
                    }
                }
            }
            
            // FunÃ§Ã£o para forÃ§ar atualizaÃ§Ã£o do plano (Ãºtil apÃ³s upgrade)
            async function refreshUserPlan() {
                if (currentUser) {
                    console.log('ğŸ”„ Atualizando exibiÃ§Ã£o do plano...');
                    await updateUserPlanDisplay(currentUser.uid);
                }
            }
            
            // FunÃ§Ã£o para mostrar mensagens de feedback
            function showMessage(message, type = 'success', cardSelector = '.function-card') {
                // Remove mensagem anterior se existir
                const existingMessage = document.querySelector('.feedback-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                // Criar elemento de mensagem
                const messageDiv = document.createElement('div');
                messageDiv.className = `feedback-message ${type}`;
                messageDiv.textContent = message;
                
                // Determinar qual card adicionar a mensagem
                let targetCard;
                if (cardSelector === 'password') {
                    targetCard = updatePasswordBtn.closest('.function-card');
                } else if (cardSelector === 'email') {
                    targetCard = updateEmailBtn.closest('.function-card');
                } else if (cardSelector === 'personalizar') {
                    targetCard = redoInterviewBtn.closest('.function-card');
                } else {
                    targetCard = document.querySelector(cardSelector);
                }
                
                if (targetCard) {
                    targetCard.insertBefore(messageDiv, targetCard.querySelector('.card-body'));
                }
                
                // Auto-remover apÃ³s 5 segundos
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
            
            // FunÃ§Ã£o para validar senha
            function validatePassword(password) {
                if (password.length < 6) {
                    return 'A senha deve ter pelo menos 6 caracteres';
                }
                return null;
            }
            
            // FunÃ§Ã£o para validar e-mail
            function validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    return 'Por favor, insira um e-mail vÃ¡lido';
                }
                return null;
            }
            
            // FunÃ§Ã£o para verificar cÃ³digo de verificaÃ§Ã£o de e-mail na URL
            async function checkEmailVerificationCode() {
                const urlParams = new URLSearchParams(window.location.search);
                const oobCode = urlParams.get('oobCode');
                const mode = urlParams.get('mode');
                
                // Log detalhado para diagnÃ³stico
                console.log('[EMAIL VERIFY] Verificando parÃ¢metros da URL...');
                console.log('[EMAIL VERIFY] oobCode presente:', !!oobCode);
                console.log('[EMAIL VERIFY] mode:', mode);
                console.log('[EMAIL VERIFY] URL completa:', window.location.href);
                
                // NOTA: resetPassword jÃ¡ foi tratado pelo guardrail no inÃ­cio do script
                // Se chegou aqui com resetPassword, algo estÃ¡ errado (nÃ£o deveria acontecer)
                if (mode === 'resetPassword') {
                    console.error('âŒ [EMAIL VERIFY] resetPassword detectado aqui - guardrail falhou!');
                    window.location.replace('/primeiro-acesso.html' + window.location.search);
                    return;
                }
                
                if (oobCode) {
                    console.log('ğŸ” CÃ³digo de verificaÃ§Ã£o encontrado na URL');
                    
                    // Recuperar o novo e-mail salvo temporariamente
                    const novoEmailTemp = localStorage.getItem('novoEmailTemp');
                    console.log('[EMAIL VERIFY] novoEmailTemp no localStorage:', novoEmailTemp || '(nÃ£o encontrado)');
                    
                    // Mostrar indicador de processamento
                    showMessage('â³ Processando verificaÃ§Ã£o de e-mail...', 'info', 'email');
                    
                    try {
                        // Com verifyBeforeUpdateEmail, o Firebase jÃ¡ atualiza o e-mail
                        // ao aplicar o cÃ³digo. NÃ£o precisamos chamar updateEmail depois.
                        console.log('[EMAIL VERIFY] Aplicando cÃ³digo de verificaÃ§Ã£o...');
                        await applyActionCode(auth, oobCode);
                        console.log('âœ… CÃ³digo de verificaÃ§Ã£o aplicado com sucesso');
                        
                        // Recarregar o usuÃ¡rio para obter as informaÃ§Ãµes atualizadas
                        if (currentUser) {
                            await currentUser.reload();
                            console.log('[EMAIL VERIFY] E-mail atual apÃ³s reload:', currentUser.email);
                        }
                        
                        // Verificar se o e-mail foi atualizado automaticamente
                        const emailAtualizado = currentUser && novoEmailTemp && currentUser.email === novoEmailTemp;
                        
                        if (emailAtualizado) {
                            console.log('âœ… E-mail atualizado automaticamente pelo Firebase para:', currentUser.email);
                            showMessage('âœ… E-mail verificado e alterado com sucesso para: ' + currentUser.email, 'success', 'email');
                        } else if (novoEmailTemp && currentUser && currentUser.email !== novoEmailTemp) {
                            // Caso raro: cÃ³digo aplicado mas e-mail nÃ£o mudou automaticamente
                            // Tentar atualizar manualmente
                            console.log('[EMAIL VERIFY] E-mail nÃ£o mudou automaticamente, tentando updateEmail...');
                            try {
                                await updateEmail(currentUser, novoEmailTemp);
                                await currentUser.reload();
                                console.log('âœ… E-mail atualizado manualmente para:', currentUser.email);
                                showMessage('âœ… E-mail alterado com sucesso para: ' + novoEmailTemp, 'success', 'email');
                            } catch (updateError) {
                                console.warn('[EMAIL VERIFY] updateEmail falhou (pode ser normal se jÃ¡ foi atualizado):', updateError.code);
                                // Mesmo que falhe, o applyActionCode jÃ¡ confirmou a verificaÃ§Ã£o
                                showMessage('âœ… E-mail verificado! A alteraÃ§Ã£o pode levar alguns instantes.', 'success', 'email');
                            }
                        } else {
                            // Sem novoEmailTemp mas cÃ³digo aplicado - verificaÃ§Ã£o genÃ©rica bem sucedida
                            showMessage('âœ… VerificaÃ§Ã£o de e-mail concluÃ­da com sucesso!', 'success', 'email');
                        }
                        
                        // Limpar o localStorage
                        localStorage.removeItem('novoEmailTemp');
                        
                        // Limpar a URL removendo os parÃ¢metros
                        const newUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                        
                        // Atualizar UI com informaÃ§Ãµes do usuÃ¡rio
                        if (currentUser) {
                            updateUserInfo(currentUser);
                        }
                        
                    } catch (error) {
                        console.error('âŒ Erro ao confirmar o novo e-mail:', error);
                        console.error('[EMAIL VERIFY] CÃ³digo do erro:', error.code);
                        console.error('[EMAIL VERIFY] Mensagem:', error.message);
                        
                        let errorMessage = 'Erro ao confirmar o novo e-mail. Tente novamente.';
                        
                        switch (error.code) {
                            case 'auth/expired-action-code':
                                errorMessage = 'â° Link de verificaÃ§Ã£o expirado. Solicite um novo.';
                                break;
                            case 'auth/invalid-action-code':
                                errorMessage = 'âŒ Link de verificaÃ§Ã£o invÃ¡lido ou jÃ¡ utilizado.';
                                break;
                            case 'auth/user-disabled':
                                errorMessage = 'ğŸš« Conta desabilitada. Entre em contato com o suporte.';
                                break;
                            case 'auth/email-already-in-use':
                                errorMessage = 'ğŸ“§ Este e-mail jÃ¡ estÃ¡ sendo usado por outra conta.';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'ğŸ“§ E-mail invÃ¡lido.';
                                break;
                            case 'auth/requires-recent-login':
                                errorMessage = 'ğŸ”’ SessÃ£o expirada. FaÃ§a login novamente e repita o processo.';
                                break;
                            default:
                                errorMessage = `âŒ Erro: ${error.message}`;
                        }
                        
                        showMessage(errorMessage, 'error', 'email');
                        
                        // Limpar o localStorage em caso de erro
                        localStorage.removeItem('novoEmailTemp');
                        
                        // Limpar a URL mesmo em caso de erro
                        const newUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                    }
                }
            }
            
            // FunÃ§Ã£o principal para alterar senha
            async function changePassword() {
                if (!currentUser) {
                    showMessage('UsuÃ¡rio nÃ£o autenticado. Redirecionando para login...', 'error', 'password');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const newPassword = newPasswordInput.value.trim();
                const confirmPassword = confirmPasswordInput.value.trim();
                
                // ValidaÃ§Ãµes
                if (!newPassword || !confirmPassword) {
                    showMessage('Por favor, preencha todos os campos', 'error', 'password');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showMessage('As senhas nÃ£o coincidem', 'error', 'password');
                    return;
                }
                
                const passwordError = validatePassword(newPassword);
                if (passwordError) {
                    showMessage(passwordError, 'error', 'password');
                    return;
                }
                
                // Desabilitar botÃ£o durante o processo
                updatePasswordBtn.disabled = true;
                updatePasswordBtn.textContent = 'Atualizando...';
                
                try {
                    // Atualizar senha no Firebase
                    await updatePassword(currentUser, newPassword);
                    
                    console.log('âœ… Senha atualizada com sucesso');
                    
                    // Mostrar mensagem de sucesso
                    showMessage('âœ… Senha atualizada com sucesso! VocÃª serÃ¡ redirecionado para o login.', 'success', 'password');
                    
                    // Limpar campos
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    
                    // Aguardar um momento para que o usuÃ¡rio veja a mensagem
                    setTimeout(async () => {
                        try {
                            // Fazer logout automÃ¡tico
                            console.log('ğŸ” Fazendo logout automÃ¡tico apÃ³s alteraÃ§Ã£o de senha...');
                            await signOut(auth);
                            console.log('âœ… Logout realizado com sucesso');
                            
                            // Redirecionar para login
                            window.location.href = 'login.html';
                        } catch (logoutError) {
                            console.error('âŒ Erro ao fazer logout:', logoutError);
                            // Mesmo com erro no logout, redirecionar para login
                            window.location.href = 'login.html';
                        }
                    }, 2000); // 2 segundos para o usuÃ¡rio ler a mensagem
                    
                } catch (error) {
                    console.error('âŒ Erro ao atualizar senha:', error);
                    
                    // Tratamento de erros especÃ­ficos
                    let errorMessage = 'Erro ao atualizar senha. Tente novamente.';
                    
                    switch (error.code) {
                        case 'auth/requires-recent-login':
                            errorMessage = 'ğŸ”’ Para alterar a senha, vocÃª precisa fazer login novamente. Redirecionando...';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'ğŸ” A senha Ã© muito fraca. Use pelo menos 6 caracteres.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'ğŸŒ Erro de conexÃ£o. Verifique sua internet e tente novamente.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'â° Muitas tentativas. Tente novamente em alguns minutos.';
                            break;
                        default:
                            errorMessage = `âŒ Erro: ${error.message}`;
                    }
                    
                    showMessage(errorMessage, 'error', 'password');
                } finally {
                    // Reabilitar botÃ£o
                    updatePasswordBtn.disabled = false;
                    updatePasswordBtn.textContent = 'Atualizar senha';
                }
            }
            
            // FunÃ§Ã£o principal para alterar e-mail
            async function changeEmail() {
                if (!currentUser) {
                    showMessage('UsuÃ¡rio nÃ£o autenticado. Redirecionando para login...', 'error', 'email');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const newEmail = newEmailInput.value.trim();
                const confirmEmail = confirmEmailInput.value.trim();
                
                // ValidaÃ§Ãµes
                if (!newEmail || !confirmEmail) {
                    showMessage('Por favor, preencha todos os campos', 'error', 'email');
                    return;
                }
                
                if (newEmail !== confirmEmail) {
                    showMessage('Os e-mails nÃ£o coincidem', 'error', 'email');
                    return;
                }
                
                const emailError = validateEmail(newEmail);
                if (emailError) {
                    showMessage(emailError, 'error', 'email');
                    return;
                }
                
                // Verificar se o e-mail Ã© diferente do atual
                if (newEmail === currentUser.email) {
                    showMessage('O novo e-mail deve ser diferente do atual', 'error', 'email');
                    return;
                }
                
                // Desabilitar botÃ£o durante o processo
                updateEmailBtn.disabled = true;
                updateEmailBtn.textContent = 'Enviando verificaÃ§Ã£o...';
                
                try {
                    // PRIMEIRO: Salvar o novo e-mail no localStorage
                    localStorage.setItem('novoEmailTemp', newEmail);
                    console.log('âœ… E-mail salvo no localStorage:', newEmail);
                    
                    // SEGUNDO: Usar verifyBeforeUpdateEmail (mÃ©todo recomendado pelo Firebase)
                    // URL FIXA do domÃ­nio canÃ´nico - NÃƒO usar window.location.origin
                    const actionCodeSettings = {
                        url: 'https://www.soundyai.com.br/gerenciar.html',
                        handleCodeInApp: true
                    };
                    
                    // Logs de diagnÃ³stico para debug
                    console.log('[EMAIL CHANGE] Origin atual:', window.location.origin);
                    console.log('[EMAIL CHANGE] continueUrl:', actionCodeSettings.url);
                    console.log('[EMAIL CHANGE] handleCodeInApp:', actionCodeSettings.handleCodeInApp);
                    console.log('[EMAIL CHANGE] Tentando enviar verificaÃ§Ã£o para:', newEmail);
                    
                    await verifyBeforeUpdateEmail(currentUser, newEmail, actionCodeSettings);
                    
                    console.log('âœ… E-mail de verificaÃ§Ã£o enviado');
                    showMessage('ğŸ“§ E-mail de verificaÃ§Ã£o enviado! Verifique sua caixa de entrada e clique no link para confirmar a alteraÃ§Ã£o.', 'success', 'email');
                    
                    // Limpar campos
                    newEmailInput.value = '';
                    confirmEmailInput.value = '';
                    
                } catch (error) {
                    console.error('âŒ Erro ao enviar verificaÃ§Ã£o de e-mail:', error);
                    
                    // Limpar localStorage em caso de erro
                    localStorage.removeItem('novoEmailTemp');
                    
                    // Tratamento de erros especÃ­ficos
                    let errorMessage = 'Erro ao enviar verificaÃ§Ã£o de e-mail. Tente novamente.';
                    
                    switch (error.code) {
                        case 'auth/requires-recent-login':
                            errorMessage = 'ğŸ”’ Para alterar o e-mail, vocÃª precisa fazer login novamente. Redirecionando...';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'ğŸ“§ E-mail invÃ¡lido. Verifique o formato.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'ğŸŒ Erro de conexÃ£o. Verifique sua internet e tente novamente.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'â° Muitas tentativas. Tente novamente em alguns minutos.';
                            break;
                        case 'auth/unauthorized-continue-uri':
                            errorMessage = 'ğŸš« Erro de configuraÃ§Ã£o do domÃ­nio. Entre em contato com o suporte.';
                            console.error('[EMAIL CHANGE] Erro: DomÃ­nio nÃ£o autorizado no Firebase. Verifique Authorized Domains.');
                            break;
                        case 'auth/email-already-in-use':
                            errorMessage = 'ğŸ“§ Este e-mail jÃ¡ estÃ¡ sendo usado por outra conta.';
                            break;
                        case 'auth/operation-not-allowed':
                            errorMessage = 'ğŸš« OperaÃ§Ã£o nÃ£o permitida. Entre em contato com o suporte.';
                            break;
                        default:
                            errorMessage = `âŒ Erro: ${error.message}`;
                    }
                    
                    showMessage(errorMessage, 'error', 'email');
                } finally {
                    // Reabilitar botÃ£o
                    updateEmailBtn.disabled = false;
                    updateEmailBtn.textContent = 'Atualizar e-mail';
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ğŸ—‘ï¸ FUNÃ‡Ã•ES DO MODAL DE EXCLUSÃƒO DE CONTA
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // FunÃ§Ã£o para mostrar o modal de confirmaÃ§Ã£o de exclusÃ£o de conta
            function showDeleteAccountConfirmationModal() {
                const overlay = document.getElementById('delete-account-confirmation-overlay');
                if (overlay) {
                    overlay.classList.add('show');
                    
                    // Prevenir scroll do body
                    document.body.style.overflow = 'hidden';
                }
            }
            
            // FunÃ§Ã£o para esconder o modal de confirmaÃ§Ã£o de exclusÃ£o de conta
            function hideDeleteAccountConfirmationModal() {
                const overlay = document.getElementById('delete-account-confirmation-overlay');
                if (overlay) {
                    overlay.classList.remove('show');
                    
                    // Restaurar scroll do body
                    document.body.style.overflow = '';
                }
            }
            
            // FunÃ§Ã£o principal para excluir conta permanentemente
            async function deleteAccountPermanently() {
                if (!currentUser) {
                    showMessage('UsuÃ¡rio nÃ£o autenticado. Redirecionando para login...', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const confirmBtn = document.getElementById('delete-account-modal-btn-confirm');
                const cancelBtn = document.getElementById('delete-account-modal-btn-cancel');
                
                // Desabilitar botÃµes durante o processo
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<span class="btn-icon">â³</span>Excluindo...';
                }
                if (cancelBtn) {
                    cancelBtn.disabled = true;
                }
                
                try {
                    console.log('ğŸ—‘ï¸ Iniciando exclusÃ£o permanente da conta...');
                    
                    // Obter token do usuÃ¡rio
                    const idToken = await currentUser.getIdToken();
                    
                    // Fazer requisiÃ§Ã£o para excluir conta
                    const response = await fetch('/api/delete-account', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        console.log('âœ… Conta excluÃ­da com sucesso:', result.message);
                        
                        // Esconder modal
                        hideDeleteAccountConfirmationModal();
                        
                        // Mostrar mensagem de sucesso
                        showMessage('âœ… ' + result.message, 'success');
                        
                        // Aguardar um momento para mostrar a mensagem
                        setTimeout(async () => {
                            try {
                                // Fazer logout do Firebase
                                const { signOut } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js');
                                await signOut(auth);
                                console.log('âœ… Logout realizado com sucesso');
                            } catch (logoutError) {
                                console.log('âš ï¸ Erro no logout (normal apÃ³s exclusÃ£o):', logoutError);
                            }
                            
                            // Redirecionar para a pÃ¡gina inicial
                            window.location.href = 'landing.html';
                        }, 2000);
                        
                    } else {
                        console.error('âŒ Erro do servidor ao excluir conta:', result);
                        
                        // Esconder modal
                        hideDeleteAccountConfirmationModal();
                        
                        // Determinar tipo de mensagem e texto
                        let messageType = 'error';
                        let errorMessage = 'Erro ao excluir conta. Tente novamente.';
                        
                        if (response.status === 401) {
                            messageType = 'error';
                            errorMessage = 'SessÃ£o expirada. FaÃ§a login novamente.';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                        } else if (response.status === 400) {
                            messageType = 'error';
                            errorMessage = result.error || 'Dados invÃ¡lidos para exclusÃ£o.';
                        } else if (response.status >= 500) {
                            messageType = 'error';
                            errorMessage = 'Erro interno do servidor. Tente novamente mais tarde.';
                        }
                        
                        if (result.error || result.message) {
                            errorMessage = result.error || result.message || errorMessage;
                        }
                        
                        showMessage('âŒ ' + errorMessage, messageType);
                    }
                    
                } catch (error) {
                    console.error('âŒ Erro completo ao excluir conta:', error);
                    console.error('âŒ Stack trace:', error.stack);
                    
                    // Esconder modal
                    hideDeleteAccountConfirmationModal();
                    
                    // Mostrar mensagem de erro de rede
                    let errorMessage = 'Erro de conexÃ£o. Verifique sua internet e tente novamente.';
                    if (error.message && error.message.includes('Failed to fetch')) {
                        errorMessage = 'Erro de conexÃ£o com o servidor. Tente novamente.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    showMessage('âŒ ' + errorMessage, 'error');
                    
                } finally {
                    // Reabilitar botÃµes (se ainda existirem)
                    if (confirmBtn && !confirmBtn.disabled) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = '<span class="btn-icon">ğŸ—‘ï¸</span>Sim, excluir minha conta';
                    }
                    if (cancelBtn && !cancelBtn.disabled) {
                        cancelBtn.disabled = false;
                    }
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // âœ… FUNÃ‡Ã•ES DO MODAL DE CONFIRMAÃ‡ÃƒO APÃ“S CANCELAMENTO
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // FunÃ§Ã£o para mostrar o modal de confirmaÃ§Ã£o apÃ³s cancelamento
            async function showSuccessModal(planExpiresAt) {
                const overlay = document.getElementById('success-confirmation-overlay');
                const description = document.getElementById('success-modal-description');
                
                if (!overlay || !description) {
                    console.error('âŒ Elementos do modal de sucesso nÃ£o encontrados');
                    return;
                }
                
                // Determinar a mensagem baseada na data de expiraÃ§Ã£o
                let message = 'Sua assinatura foi cancelada com sucesso.';
                
                if (planExpiresAt) {
                    try {
                        // Converter a data de expiraÃ§Ã£o
                        const expirationDate = planExpiresAt instanceof Date ? 
                            planExpiresAt : 
                            planExpiresAt.toDate ? planExpiresAt.toDate() : new Date(planExpiresAt);
                        
                        // Formatear a data em portuguÃªs
                        const options = { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            timeZone: 'America/Sao_Paulo'
                        };
                        const formattedDate = expirationDate.toLocaleDateString('pt-BR', options);
                        
                        message = `Sua assinatura foi cancelada com sucesso. VocÃª continuarÃ¡ com acesso ao Plus atÃ© ${formattedDate}.`;
                        
                        console.log('ğŸ“… Data de expiraÃ§Ã£o formatada:', formattedDate);
                    } catch (error) {
                        console.error('âŒ Erro ao formatar data de expiraÃ§Ã£o:', error);
                        message = 'Sua assinatura foi cancelada com sucesso. VocÃª continuarÃ¡ com acesso ao Plus atÃ© o fim do perÃ­odo atual.';
                    }
                } else {
                    message = 'Sua assinatura foi cancelada com sucesso. O acesso serÃ¡ mantido atÃ© o fim do perÃ­odo atual.';
                }
                
                // Atualizar a descriÃ§Ã£o do modal
                description.textContent = message;
                
                // Mostrar o modal com animaÃ§Ã£o
                overlay.classList.add('show');
                
                // Prevenir scroll do body
                document.body.style.overflow = 'hidden';
                
                console.log('âœ… Modal de sucesso exibido com a mensagem:', message);
            }
            
            // FunÃ§Ã£o para esconder o modal de confirmaÃ§Ã£o apÃ³s cancelamento
            function hideSuccessModal() {
                const overlay = document.getElementById('success-confirmation-overlay');
                if (overlay) {
                    overlay.classList.remove('show');
                    
                    // Restaurar scroll do body
                    document.body.style.overflow = '';
                    
                    console.log('âœ… Modal de sucesso fechado');
                }
            }
            
            // FunÃ§Ã£o para personalizar novamente (disponÃ­vel para Plus, Pro e DJ)
            async function redoInterview() {
                if (!currentUser) {
                    showMessage('UsuÃ¡rio nÃ£o autenticado. Redirecionando para login...', 'error', 'personalizar');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                try {
                    console.log('ğŸ”„ Verificando plano do usuÃ¡rio...');
                    
                    // Importar Firestore necessÃ¡rio
                    const { doc, getDoc, deleteField, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js');
                    const { db } = await import('./firebase.js');
                    
                    // Verificar plano do usuÃ¡rio no Firestore
                    const userDocRef = doc(db, 'usuarios', currentUser.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (!userDoc.exists()) {
                        showMessage('âŒ Dados do usuÃ¡rio nÃ£o encontrados.', 'error', 'personalizar');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    const userPlan = (userData.plano || '').toLowerCase();
                    
                    // Verificar se Ã© plano Free/Reduced (bloquear apenas esses)
                    const isFreeOrReduced = userPlan === 'free' || userPlan === 'gratis' || userPlan === 'reduced';
                    const isPremium = userPlan === 'plus' || userPlan === 'pro' || userPlan === 'dj' || userData.isPlus === true;
                    
                    console.log('ğŸ“Š Plano do usuÃ¡rio:', userPlan, '| Premium:', isPremium, '| Free/Reduced:', isFreeOrReduced);
                    
                    // Bloquear APENAS Free/Reduced
                    if (isFreeOrReduced) {
                        console.log('ğŸ”’ Plano Free/Reduced - bloqueando personalizaÃ§Ã£o');
                        showPremiumOnlyMessage();
                        return;
                    }
                    
                    // Se chegou aqui, Ã© Premium (Plus/Pro/DJ) ou plano vÃ¡lido - permitir
                    console.log('âœ… Plano Premium confirmado - permitindo personalizaÃ§Ã£o');
                    
                    // UsuÃ¡rio Premium (Plus/Pro/DJ) - prosseguir com redirecionamento e limpeza
                    console.log(`âœ… UsuÃ¡rio ${userPlan.toUpperCase()} confirmado - prosseguindo...`);
                    
                    // Desabilitar botÃ£o durante o processo
                    redoInterviewBtn.disabled = true;
                    redoInterviewBtn.innerHTML = '<span class="btn-icon">â³</span>Apagando dados...';
                    
                    // Apagar dados antigos da entrevista
                    await updateDoc(userDocRef, {
                        perfil: deleteField(),
                        entrevistaConcluida: false,
                        dataUltimaEntrevista: deleteField()
                    });
                    
                    console.log('âœ… Dados da entrevista apagados com sucesso');
                    
                    // Mostrar mensagem de sucesso
                    showMessage('âœ… Dados apagados! Redirecionando para nova entrevista...', 'success', 'personalizar');
                    
                    // Redirecionar apÃ³s breve pausa com parÃ¢metro de repersonalizaÃ§Ã£o
                    setTimeout(() => {
                        window.location.href = 'entrevista.html?repersonalizando=true';
                    }, 1500);
                    
                } catch (error) {
                    console.error('âŒ Erro ao processar personalizaÃ§Ã£o:', error);
                    
                    let errorMessage = 'Erro ao processar solicitaÃ§Ã£o. Tente novamente.';
                    
                    switch (error.code) {
                        case 'auth/requires-recent-login':
                            errorMessage = 'ğŸ”’ Para esta aÃ§Ã£o, vocÃª precisa fazer login novamente. Redirecionando...';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'ğŸŒ Erro de conexÃ£o. Verifique sua internet e tente novamente.';
                            break;
                        default:
                            errorMessage = `âŒ Erro: ${error.message}`;
                    }
                    
                    showMessage(errorMessage, 'error', 'personalizar');
                } finally {
                    // Reabilitar botÃ£o
                    redoInterviewBtn.disabled = false;
                    redoInterviewBtn.innerHTML = '<span class="btn-icon">â™»ï¸</span>Personalizar novamente';
                }
            }
            
            // FunÃ§Ã£o para mostrar mensagem exclusiva para usuÃ¡rios Premium
            function showPremiumOnlyMessage() {
                // Remover mensagem anterior se existir
                const existingCard = document.querySelector('.premium-only-card');
                if (existingCard) {
                    existingCard.remove();
                }
                
                // Criar card de bloqueio
                const premiumCard = document.createElement('div');
                premiumCard.className = 'premium-only-card';
                premiumCard.innerHTML = `
                    <div class="plus-card-content">
                        <div class="plus-card-icon">ğŸ”’</div>
                        <h3 class="plus-card-title">PersonalizaÃ§Ã£o disponÃ­vel para usuÃ¡rios Premium</h3>
                        <p class="plus-card-description">
                            Assine um plano Plus ou Pro para refazer sua entrevista e receber respostas 100% personalizadas com base no seu perfil.
                        </p>
                        <div class="plus-card-buttons">
                            <a href="planos.html" class="btn-plus-upgrade">
                                <span class="btn-icon">â­</span>
                                Ver Planos Premium
                            </a>
                            <button class="btn-plus-close" onclick="this.closest('.premium-only-card').remove()">
                                Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                // Adicionar apÃ³s o card de personalizar
                const personalizeCard = redoInterviewBtn.closest('.function-card');
                personalizeCard.insertAdjacentElement('afterend', premiumCard);
                
                // Animar entrada
                setTimeout(() => {
                    premiumCard.classList.add('show');
                }, 10);
                
                // Auto-remover apÃ³s 15 segundos
                setTimeout(() => {
                    if (premiumCard.parentNode) {
                        premiumCard.classList.remove('show');
                        setTimeout(() => {
                            if (premiumCard.parentNode) {
                                premiumCard.remove();
                            }
                        }, 300);
                    }
                }, 15000);
            }
            
            // FunÃ§Ã£o para mostrar o modal de confirmaÃ§Ã£o de cancelamento
            function showCancelConfirmationModal() {
                const overlay = document.getElementById('cancel-confirmation-overlay');
                if (overlay) {
                    overlay.classList.add('show');
                    
                    // Prevenir scroll do body
                    document.body.style.overflow = 'hidden';
                }
            }
            
            // FunÃ§Ã£o para esconder o modal de confirmaÃ§Ã£o de cancelamento
            function hideCancelConfirmationModal() {
                const overlay = document.getElementById('cancel-confirmation-overlay');
                if (overlay) {
                    overlay.classList.remove('show');
                    
                    // Restaurar scroll do body
                    document.body.style.overflow = '';
                }
            }
            
            // FunÃ§Ã£o principal para cancelar assinatura
            async function cancelSubscription() {
                if (!currentUser) {
                    showMessage('UsuÃ¡rio nÃ£o autenticado. Redirecionando para login...', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const confirmBtn = document.getElementById('cancel-modal-btn-confirm');
                const cancelBtn = document.getElementById('cancel-modal-btn-cancel');
                
                // Desabilitar botÃµes durante o processo
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<span class="btn-icon">â³</span>Cancelando...';
                }
                if (cancelBtn) {
                    cancelBtn.disabled = true;
                }
                
                try {
                    console.log('ğŸ”„ Iniciando cancelamento de assinatura via Stripe...');
                    
                    // Obter token do usuÃ¡rio
                    const idToken = await currentUser.getIdToken();
                    
                    // Fazer requisiÃ§Ã£o para cancelar assinatura no STRIPE
                    const response = await fetch('/api/stripe/cancel-subscription', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${idToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('ğŸ“Š Response status:', response.status);
                    console.log('ğŸ“Š Response ok:', response.ok);
                    
                    let result;
                    try {
                        result = await response.json();
                        console.log('ğŸ“Š Response JSON:', result);
                    } catch (jsonError) {
                        console.error('âŒ Erro ao fazer parse do JSON:', jsonError);
                        const responseText = await response.text();
                        console.error('ğŸ“„ Response text:', responseText);
                        throw new Error(`Resposta invÃ¡lida do servidor: ${responseText.substring(0, 100)}...`);
                    }
                    
                    if (response.ok && result.success) {
                        console.log('âœ… Assinatura cancelada com sucesso');
                        
                        // Esconder modal de confirmaÃ§Ã£o
                        hideCancelConfirmationModal();
                        
                        // Usar data de cancelamento retornada pela API Stripe
                        let cancelAtDate = null;
                        if (result.cancelAt) {
                            cancelAtDate = result.cancelAt;
                            console.log('ğŸ“… Data de fim do acesso (da API):', result.cancelAtFormatted || cancelAtDate);
                        } else {
                            // Fallback: buscar do Firestore
                            try {
                                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js');
                                const { db } = await import('./firebase.js');
                                
                                const userDocRef = doc(db, 'usuarios', currentUser.uid);
                                const userDoc = await getDoc(userDocRef);
                                
                                if (userDoc.exists()) {
                                    const userData = userDoc.data();
                                    cancelAtDate = userData.subscription?.currentPeriodEnd || userData.planExpiresAt;
                                    console.log('ğŸ“… Data de fim do acesso (Firestore):', cancelAtDate);
                                }
                            } catch (firestoreError) {
                                console.error('âŒ Erro ao buscar dados do usuÃ¡rio:', firestoreError);
                            }
                        }
                        
                        // Mostrar modal de confirmaÃ§Ã£o apÃ³s cancelamento
                        await showSuccessModal(cancelAtDate);
                        
                        // Atualizar exibiÃ§Ã£o do plano para refletir cancelamento
                        await refreshUserPlan();
                        
                    } else {
                        console.error('âŒ Erro ao cancelar assinatura:', result);
                        
                        // Esconder modal
                        hideCancelConfirmationModal();
                        
                        // Tratamento especÃ­fico para diferentes tipos de erro
                        let errorMessage = 'Erro ao cancelar assinatura. Tente novamente.';
                        let messageType = 'error';
                        
                        if (response.status === 400) {
                            // Erro de validaÃ§Ã£o (ex: assinatura jÃ¡ cancelada)
                            errorMessage = result.error || result.message || 'Assinatura jÃ¡ foi cancelada ou nÃ£o Ã© vÃ¡lida.';
                            messageType = 'warning'; // Usar warning em vez de error para casos menos crÃ­ticos
                        } else if (response.status === 401) {
                            // Erro de autenticaÃ§Ã£o
                            errorMessage = 'SessÃ£o expirada. FaÃ§a login novamente.';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 2000);
                        } else if (response.status === 404) {
                            // UsuÃ¡rio nÃ£o encontrado
                            errorMessage = 'UsuÃ¡rio nÃ£o encontrado. Tente fazer login novamente.';
                        } else if (response.status >= 500) {
                            // Erro do servidor
                            errorMessage = 'Erro interno do servidor. Tente novamente em alguns minutos.';
                        } else {
                            // Outros erros
                            errorMessage = result.error || result.message || errorMessage;
                        }
                        
                        showMessage('âŒ ' + errorMessage, messageType);
                    }
                    
                } catch (error) {
                    console.error('âŒ Erro completo ao cancelar assinatura:', error);
                    console.error('âŒ Stack trace:', error.stack);
                    
                    // Esconder modal
                    hideCancelConfirmationModal();
                    
                    // Mostrar mensagem de erro de rede
                    let errorMessage = 'Erro de conexÃ£o. Verifique sua internet e tente novamente.';
                    if (error.message && error.message.includes('Failed to fetch')) {
                        errorMessage = 'Erro de conexÃ£o com o servidor. Tente novamente.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    showMessage('âŒ ' + errorMessage, 'error');
                } finally {
                    // Reabilitar botÃµes
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = '<span class="btn-icon">âœ…</span>Confirmar Cancelamento';
                    }
                    if (cancelBtn) {
                        cancelBtn.disabled = false;
                    }
                }
            }
            
            // Event Listeners
            if (updatePasswordBtn) {
                updatePasswordBtn.addEventListener('click', changePassword);
            }
            
            if (updateEmailBtn) {
                updateEmailBtn.addEventListener('click', changeEmail);
            }
            
            if (redoInterviewBtn) {
                redoInterviewBtn.addEventListener('click', redoInterview);
            }
            
            // Permitir Enter nos campos de senha
            if (newPasswordInput) {
                newPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changePassword();
                    }
                });
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changePassword();
                    }
                });
            }
            
            // Permitir Enter nos campos de e-mail
            if (newEmailInput) {
                newEmailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changeEmail();
                    }
                });
            }
            
            if (confirmEmailInput) {
                confirmEmailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changeEmail();
                    }
                });
            }
            
            // BotÃ£o voltar ao chat
            if (backToChatBtn) {
                backToChatBtn.addEventListener('click', function() {
                    window.location.href = 'index.html';
                });
            }

            // BotÃ£o upgrade para planos
            if (upgradeBtn) {
                upgradeBtn.addEventListener('click', function() {
                    window.location.href = 'planos.html';
                });
            }
            
            // BotÃ£o cancelar assinatura - mostrar modal de confirmaÃ§Ã£o
            if (cancelSubscriptionBtn) {
                cancelSubscriptionBtn.addEventListener('click', function() {
                    showCancelConfirmationModal();
                });
            }
            
            // BotÃ£o excluir conta - mostrar modal de confirmaÃ§Ã£o
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', function() {
                    showDeleteAccountConfirmationModal();
                });
            }
            
            // Event listeners para o modal de cancelamento
            const cancelModalBtnCancel = document.getElementById('cancel-modal-btn-cancel');
            const cancelModalBtnConfirm = document.getElementById('cancel-modal-btn-confirm');
            const cancelConfirmationOverlay = document.getElementById('cancel-confirmation-overlay');
            
            // BotÃ£o "Cancelar" no modal (fechar modal)
            if (cancelModalBtnCancel) {
                cancelModalBtnCancel.addEventListener('click', function() {
                    hideCancelConfirmationModal();
                });
            }
            
            // BotÃ£o "Confirmar Cancelamento" no modal
            if (cancelModalBtnConfirm) {
                cancelModalBtnConfirm.addEventListener('click', function() {
                    cancelSubscription();
                });
            }
            
            // Fechar modal clicando no overlay (fundo)
            if (cancelConfirmationOverlay) {
                cancelConfirmationOverlay.addEventListener('click', function(e) {
                    // SÃ³ fechar se clicou no overlay (nÃ£o no modal)
                    if (e.target === cancelConfirmationOverlay) {
                        hideCancelConfirmationModal();
                    }
                });
            }
            
            // Event listeners para o modal de confirmaÃ§Ã£o de exclusÃ£o de conta
            const deleteAccountModalBtnCancel = document.getElementById('delete-account-modal-btn-cancel');
            const deleteAccountModalBtnConfirm = document.getElementById('delete-account-modal-btn-confirm');
            const deleteAccountConfirmationOverlay = document.getElementById('delete-account-confirmation-overlay');
            
            // BotÃ£o "Cancelar" no modal de exclusÃ£o (fechar modal)
            if (deleteAccountModalBtnCancel) {
                deleteAccountModalBtnCancel.addEventListener('click', function() {
                    hideDeleteAccountConfirmationModal();
                });
            }
            
            // BotÃ£o "Sim, excluir minha conta" no modal de exclusÃ£o
            if (deleteAccountModalBtnConfirm) {
                deleteAccountModalBtnConfirm.addEventListener('click', function() {
                    deleteAccountPermanently();
                });
            }
            
            // Fechar modal de exclusÃ£o clicando no overlay (fundo)
            if (deleteAccountConfirmationOverlay) {
                deleteAccountConfirmationOverlay.addEventListener('click', function(e) {
                    // SÃ³ fechar se clicou no overlay (nÃ£o no modal)
                    if (e.target === deleteAccountConfirmationOverlay) {
                        hideDeleteAccountConfirmationModal();
                    }
                });
            }
            
            // Event listeners para o modal de confirmaÃ§Ã£o apÃ³s cancelamento
            const successModalBtnOk = document.getElementById('success-modal-btn-ok');
            const successConfirmationOverlay = document.getElementById('success-confirmation-overlay');
            
            // BotÃ£o "Entendi" no modal de sucesso
            if (successModalBtnOk) {
                successModalBtnOk.addEventListener('click', function() {
                    hideSuccessModal();
                });
            }
            
            // Fechar modal de sucesso clicando no overlay (fundo)
            if (successConfirmationOverlay) {
                successConfirmationOverlay.addEventListener('click', function(e) {
                    // SÃ³ fechar se clicou no overlay (nÃ£o no modal)
                    if (e.target === successConfirmationOverlay) {
                        hideSuccessModal();
                    }
                });
            }
            
            // Fechar modal com tecla ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const cancelOverlay = document.getElementById('cancel-confirmation-overlay');
                    const deleteOverlay = document.getElementById('delete-account-confirmation-overlay');
                    const successOverlay = document.getElementById('success-confirmation-overlay');
                    
                    if (cancelOverlay && cancelOverlay.classList.contains('show')) {
                        hideCancelConfirmationModal();
                    }
                    
                    if (deleteOverlay && deleteOverlay.classList.contains('show')) {
                        hideDeleteAccountConfirmationModal();
                    }
                    
                    if (successOverlay && successOverlay.classList.contains('show')) {
                        hideSuccessModal();
                    }
                }
            });
            
            // Configurar verificaÃ§Ã£o periÃ³dica do plano (a cada 30 segundos)
            // Isso permite detectar mudanÃ§as caso o usuÃ¡rio faÃ§a upgrade em outra aba
            setInterval(async () => {
                if (currentUser) {
                    await updateUserPlanDisplay(currentUser.uid);
                }
            }, 30000); // 30 segundos
            
            // Configurar listener para mudanÃ§as de visibilidade da pÃ¡gina
            // Atualiza o plano quando o usuÃ¡rio volta para a aba
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden && currentUser) {
                    console.log('ğŸ‘ï¸ PÃ¡gina voltou ao foco, atualizando plano...');
                    await updateUserPlanDisplay(currentUser.uid);
                }
            });
            
            console.log('ğŸ”§ Event listeners configurados');
        }, 100);
    </script>

    <script>
        // Particle Generation - Mesmo da landing.html
        const particlesContainer = document.getElementById('particles');
        const particleCount = 50;
        
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 10 + 's';
            particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
            particlesContainer.appendChild(particle);
        }

        // Initialize Vanta.js Background
        function initVantaBackground() {
            try {
                const vantaElement = document.getElementById("vanta-bg");
                if (!vantaElement) {
                    return;
                }
                
                if (typeof VANTA !== 'undefined' && typeof THREE !== 'undefined') {
                    const isLowPerformance = navigator.hardwareConcurrency <= 4;
                    const isDesktop = window.innerWidth > 768;
                    
                    VANTA.NET({
                        el: "#vanta-bg",
                        mouseControls: true,
                        touchControls: true,
                        gyroControls: false,
                        minHeight: 200.00,
                        minWidth: 200.00,
                        scale: 1.00,
                        scaleMobile: 1.00,
                        color: 0x8a2be2,
                        backgroundColor: 0x0a0a1a,
                        points: isLowPerformance ? 3.50 : (isDesktop ? 6.00 : 3.50),
                        maxDistance: isLowPerformance ? 13.00 : (isDesktop ? 20.00 : 13.00),
                        spacing: isLowPerformance ? 30.00 : (isDesktop ? 20.00 : 28.00),
                        showDots: true
                    });
                    console.log('Vanta.js Network background initialized');
                } else {
                    console.log('Vanta.js libraries not available');
                }
            } catch (error) {
                console.log('Vanta.js initialization error:', error);
            }
        }
        
        // Initialize Vanta.js when libraries are loaded
        function checkLibrariesAndInit() {
            if (typeof VANTA !== 'undefined' && typeof THREE !== 'undefined') {
                initVantaBackground();
            } else {
                setTimeout(checkLibrariesAndInit, 100);
            }
        }
        
        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkLibrariesAndInit);
        } else {
            checkLibrariesAndInit();
        }
        
        console.log('Background gerenciar.html carregado com sucesso!');
    </script>
</body>
</html>