<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Conta - PROD.AI</title>
    
    <!-- Bibliotecas para efeitos visuais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.net.min.js" defer></script>
    
    <link rel="stylesheet" href="gerenciar.css">
    <!-- Sistema Centralizado de Logs -->
    <script src="logger.js"></script>
    <script>
        // Importar fun√ß√µes do logger para escopo global
        const { log, warn, error, info, debug } = window.logger;
    </script>
</head>
<body class="page-doc">
    <!-- Background Elements -->
    <div class="background-container">
        <!-- Container para o fundo animado Vanta.js -->
        <div class="vanta-background" id="vanta-bg"></div>
        
        <!-- Plano de fundo neural (fallback) -->
        <div class="fundo-neural"></div>
        
        <div class="particles" id="particles"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1 class="page-title">Gerenciar conta</h1>
            
            <div class="plan-status" id="plan-status">
                <div class="plan-info">
                    <span class="plan-label">Plano atual:</span>
                    <span class="plan-type plus" id="plan-type">
                        <span class="plan-name">PLUS</span>
                        <span class="plan-icon">‚úÖ</span>
                    </span>
                </div>
            </div>
            
            <button class="btn-back-simple" id="back-to-chat-simple">
                <span class="back-icon">üîô</span>
                Voltar ao chat
            </button>
        </div>

        <div class="form-container">
            <!-- Grid de Cards Principais -->
            <div class="cards-grid">
                <!-- Card: Alterar Senha -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">üîí</span>
                        <h3 class="card-title">Alterar Senha</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <div class="input-group">
                                <label for="new-password">Nova senha</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">üîí</span>
                                    <input type="password" id="new-password" placeholder="Digite sua nova senha">
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="confirm-password">Confirmar senha</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">üîí</span>
                                    <input type="password" id="confirm-password" placeholder="Confirme sua nova senha">
                                </div>
                            </div>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-primary" id="update-password-btn">Atualizar senha</button>
                        </div>
                    </div>
                </section>

                <!-- Card: Alterar E-mail -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">‚úâÔ∏è</span>
                        <h3 class="card-title">Alterar E-mail</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <div class="input-group">
                                <label for="new-email">Novo e-mail</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">‚úâÔ∏è</span>
                                    <input type="email" id="new-email" placeholder="Digite seu novo e-mail">
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="confirm-email">Confirmar e-mail</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">‚úâÔ∏è</span>
                                    <input type="email" id="confirm-email" placeholder="Confirme seu novo e-mail">
                                </div>
                            </div>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-primary" id="update-email-btn">Atualizar e-mail</button>
                        </div>
                    </div>
                </section>

                <!-- Card: Refazer Entrevista -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">‚ôªÔ∏è</span>
                        <h3 class="card-title">Personalizar Novamente</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Quer mudar suas respostas personalizadas?</p>
                            <p class="card-description">Refa√ßa o processo de configura√ß√£o inicial.</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-special" id="redo-interview-btn">
                                <span class="btn-icon">‚ôªÔ∏è</span>
                                Personalizar novamente
                            </button>
                            <p class="info-text">Dispon√≠vel para usu√°rios Plus e Pro.</p>
                        </div>
                    </div>
                </section>

                <!-- Card: Fazer Upgrade -->
                <section class="function-card upgrade-card" id="upgrade-card">
                    <div class="card-header">
                        <span class="card-icon">üîì</span>
                        <h3 class="card-title">Upgrade de Plano</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Voc√™ est√° no plano gratuito. Desbloqueie todo o potencial do PROD.AI</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-upgrade-premium" id="upgrade-plan-btn">
                                <span class="btn-icon">‚≠ê</span>
                                Fazer Upgrade para Plus
                            </button>
                            <p class="upgrade-benefits">Desbloqueie mensagens ilimitadas e respostas avan√ßadas</p>
                        </div>
                    </div>
                </section>

                <!-- Card: Cancelar Assinatura -->
                <section class="function-card card-perigo">
                    <div class="card-header">
                        <span class="card-icon">‚ùå</span>
                        <h3 class="card-title">Cancelar Assinatura</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Cancelar sua assinatura atual do plano Plus.</p>
                            <p class="card-description">Voc√™ manter√° acesso at√© o fim do per√≠odo atual.</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-danger" id="cancel-subscription-btn">
                                <span class="btn-icon">‚ùå</span>
                                Cancelar assinatura
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Card: Excluir Conta -->
                <section class="function-card card-perigo">
                    <div class="card-header">
                        <span class="card-icon">‚ö†Ô∏è</span>
                        <h3 class="card-title">Zona de Perigo</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">
                                <strong>‚ö†Ô∏è Esta a√ß√£o √© irrevers√≠vel!</strong>
                            </p>
                            <p class="card-description">
                                Ao excluir sua conta, todos os dados ser√£o perdidos permanentemente.
                            </p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-delete-account" id="delete-account-btn">
                                <span class="btn-icon">üóëÔ∏è</span>
                                Excluir Conta Permanentemente
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Se√ß√£o de Suporte - Rodap√© -->
        <div class="support-footer-card">
            <h3 class="support-footer-title">
                <span class="support-icon">üí¨</span>
                Suporte
            </h3>
            <p class="support-footer-text">Precisa de ajuda? Entre em contato conosco:</p>
            <div class="support-footer-contact">
                <span class="support-email">soundyaibr@gmail.com</span>
            </div>
            <div class="support-footer-info">
                <div class="support-footer-item">
                    <span class="support-item-icon">üìû</span>
                    <span>Suporte telef√¥nico: Seg-Sex, 9h-18h</span>
                </div>
                <div class="support-footer-item">
                    <span class="support-item-icon">üí¨</span>
                    <span>Chat online: 24h</span>
                </div>
                <div class="support-footer-item">
                    <span class="support-item-icon">‚ö°</span>
                    <span>Resposta em at√© 2 horas</span>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Cancelamento -->
    <div class="cancel-confirmation-overlay" id="cancel-confirmation-overlay">
        <div class="cancel-confirmation-modal">
            <div class="cancel-modal-content">
                <div class="cancel-modal-icon">‚ö†Ô∏è</div>
                <h3 class="cancel-modal-title">Cancelar Assinatura</h3>
                <p class="cancel-modal-description">
                    Tem certeza que deseja cancelar sua assinatura? Voc√™ continuar√° com acesso ao Plus at√© o fim do per√≠odo atual.
                </p>
                <div class="cancel-modal-buttons">
                    <button class="cancel-modal-btn cancel-modal-btn-cancel" id="cancel-modal-btn-cancel">
                        <span class="btn-icon">‚ùå</span>
                        Cancelar
                    </button>
                    <button class="cancel-modal-btn cancel-modal-btn-confirm" id="cancel-modal-btn-confirm">
                        <span class="btn-icon">‚úÖ</span>
                        Confirmar Cancelamento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o de Conta -->
    <div class="delete-account-confirmation-overlay" id="delete-account-confirmation-overlay">
        <div class="delete-account-confirmation-modal">
            <div class="delete-account-modal-content">
                <div class="delete-account-modal-icon">‚ö†Ô∏è</div>
                <h3 class="delete-account-modal-title">‚ö†Ô∏è Tem certeza que deseja excluir sua conta?</h3>
                <p class="delete-account-modal-description">
                    Essa a√ß√£o √© irrevers√≠vel e todos os seus dados, incluindo e-mail e senha, ser√£o permanentemente apagados.
                </p>
                <div class="delete-account-modal-buttons">
                    <button class="delete-account-modal-btn delete-account-modal-btn-cancel" id="delete-account-modal-btn-cancel">
                        <span class="btn-icon">‚ùå</span>
                        Cancelar
                    </button>
                    <button class="delete-account-modal-btn delete-account-modal-btn-confirm" id="delete-account-modal-btn-confirm">
                        <span class="btn-icon">üóëÔ∏è</span>
                        Sim, excluir minha conta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o Ap√≥s Cancelamento -->
    <div class="success-confirmation-overlay" id="success-confirmation-overlay">
        <div class="success-confirmation-modal">
            <div class="success-modal-content">
                <div class="success-modal-icon">‚úÖ</div>
                <h3 class="success-modal-title">Assinatura Cancelada com Sucesso!</h3>
                <p class="success-modal-description" id="success-modal-description">
                    Sua assinatura foi cancelada. Voc√™ continuar√° com acesso ao Plus at√© o fim do per√≠odo atual.
                </p>
                <div class="success-modal-buttons">
                    <button class="success-modal-btn" id="success-modal-btn-ok">
                        <span class="btn-icon">üëç</span>
                        Entendi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="background-effects">
        <div class="glow-effect glow-1"></div>
        <div class="glow-effect glow-2"></div>
        <div class="neural-network">
            <div class="neural-node node-1"></div>
            <div class="neural-node node-2"></div>
            <div class="neural-node node-3"></div>
        </div>
    </div>

    <!-- Firebase e Script de Gerenciamento -->
    <script type="module">
        // üö® GUARDRAIL CR√çTICO: Executar ANTES de qualquer l√≥gica de auth
        // Se for resetPassword, redirecionar IMEDIATAMENTE para /primeiro-acesso.html
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const oobCode = urlParams.get('oobCode');
            
            log('[GERENCIAR] P√°gina carregada');
            log('[GERENCIAR] mode =', mode || '(ausente)');
            log('[GERENCIAR] hasOobCode =', !!oobCode);
            log('[GERENCIAR] fullUrl =', window.location.href);
            
            // üö® SE FOR RESETPASSWORD: REDIRECIONAR IMEDIATAMENTE
            if (mode === 'resetPassword') {
                log('üîÄ [GERENCIAR] resetPassword detectado - redirecionando AGORA');
                log('üîÄ [GERENCIAR] Redirecionando para: /primeiro-acesso.html' + window.location.search);
                
                // location.replace para n√£o adicionar no hist√≥rico (evita "piscar")
                window.location.replace('/primeiro-acesso.html' + window.location.search);
                
                // Parar execu√ß√£o do script
                throw new Error('Redirecting resetPassword to primeiro-acesso.html');
            }
            
            log('‚úÖ [GERENCIAR] N√£o √© resetPassword, continuando fluxo normal');
        })();
        
        // Aguardar um pouco para garantir que o Firebase carregue
        setTimeout(async () => {
            const { auth } = await import('./firebase.js');
            const { onAuthStateChanged, updatePassword, updateEmail, verifyBeforeUpdateEmail, applyActionCode, signOut } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js');
            
            log('üîß Gerenciar.js carregado');
            
            // Elementos do DOM
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const updatePasswordBtn = document.getElementById('update-password-btn');
            const newEmailInput = document.getElementById('new-email');
            const confirmEmailInput = document.getElementById('confirm-email');
            const updateEmailBtn = document.getElementById('update-email-btn');
            const redoInterviewBtn = document.getElementById('redo-interview-btn');
            const backToChatBtn = document.getElementById('back-to-chat-simple');
            const upgradeBtn = document.getElementById('upgrade-plan-btn');
            const cancelSubscriptionBtn = document.getElementById('cancel-subscription-btn');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            
            // Verificar se o usu√°rio est√° autenticado
            let currentUser = null;
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    log('‚úÖ Usu√°rio autenticado:', user.email);
                    
                    // Atualizar informa√ß√µes do usu√°rio na p√°gina
                    updateUserInfo(user);
                    
                    // Verificar se h√° c√≥digo de verifica√ß√£o na URL
                    checkEmailVerificationCode();
                } else {
                    log('‚ùå Usu√°rio n√£o autenticado - redirecionando...');
                    // Redirecionar usu√°rios n√£o autenticados
                    window.location.href = 'login.html';
                }
            });
            
            // Fun√ß√£o para atualizar informa√ß√µes do usu√°rio
            async function updateUserInfo(user) {
                log('üìß Email do usu√°rio:', user.email);
                log('üÜî UID do usu√°rio:', user.uid);
                
                // Buscar dados do usu√°rio no Firestore para determinar o plano
                await updateUserPlanDisplay(user.uid);
            }
            
            // Fun√ß√£o para buscar e atualizar a exibi√ß√£o do plano do usu√°rio
            async function updateUserPlanDisplay(userId) {
                try {
                    log('üîç Buscando dados do plano do usu√°rio...');
                    
                    // Importar Firestore necess√°rio
                    const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js');
                    const { db } = await import('./firebase.js');
                    
                    // Buscar documento do usu√°rio
                    const userDocRef = doc(db, 'usuarios', userId);
                    const userDoc = await getDoc(userDocRef);
                    
                    // Elementos do DOM para atualizar
                    const planTypeElement = document.getElementById('plan-type');
                    const planNameElement = planTypeElement?.querySelector('.plan-name');
                    const planIconElement = planTypeElement?.querySelector('.plan-icon');
                    const cancelSubscriptionBtn = document.getElementById('cancel-subscription-btn');
                    
                    if (!planTypeElement || !planNameElement || !planIconElement) {
                        error('‚ùå Elementos do plano n√£o encontrados no DOM');
                        return;
                    }
                    
                    let userPlan = 'free';
                    let isPaidPlan = false;
                    let isCancellationPending = false;
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        
                        // ‚úÖ NOVA ESTRUTURA STRIPE: Usar campo 'plan' e 'subscription'
                        // Fallback para campos antigos se necess√°rio
                        userPlan = userData.plan || userData.plano || 'free';
                        const subscription = userData.subscription || {};
                        
                        log('üìä Dados do usu√°rio (nova estrutura):', {
                            plan: userPlan,
                            subscription: {
                                id: subscription.id,
                                status: subscription.status,
                                priceId: subscription.priceId,
                                cancel_at_period_end: subscription.cancel_at_period_end,
                                currentPeriodEnd: subscription.currentPeriodEnd
                            },
                            // Campos legados
                            plano_legado: userData.plano,
                            isPlus_legado: userData.isPlus,
                        });
                        
                        // Verificar status da assinatura
                        const subStatus = subscription.status;
                        const isActiveStatus = ['active', 'active_until_period_end', 'trialing'].includes(subStatus);
                        
                        // Plano pago ativo = plan √© plus/pro E (status ativo OU assinatura v√°lida)
                        if (userPlan === 'plus' || userPlan === 'pro') {
                            if (isActiveStatus || !subStatus) {
                                isPaidPlan = true;
                            }
                        }
                        
                        // Verificar se cancelamento est√° pendente
                        isCancellationPending = subscription.cancel_at_period_end === true || 
                                                 subStatus === 'active_until_period_end';
                        
                        // Se a assinatura est√° cancelada e expirou, considerar como free
                        if (subStatus === 'canceled' && subscription.currentPeriodEnd) {
                            const now = new Date();
                            const periodEnd = new Date(subscription.currentPeriodEnd);
                            if (periodEnd <= now) {
                                isPaidPlan = false;
                                userPlan = 'free';
                                log('‚è∞ Plano expirou, considerando como FREE');
                            }
                        }
                    } else {
                        log('‚ö†Ô∏è Documento do usu√°rio n√£o encontrado, usando plano gratuito como padr√£o');
                    }
                    
                    // Atualizar a exibi√ß√£o do plano
                    const upgradeCard = document.getElementById('upgrade-card');
                    const cancelCards = document.querySelectorAll('.card-perigo');
                    
                    // ‚úÖ ATUALIZADO 2026-01-06: Suporte ao plano STUDIO
                    if (userPlan === 'studio') {
                        // Usu√°rio STUDIO (R$99,90/m√™s)
                        planTypeElement.className = 'plan-type studio';
                        planNameElement.textContent = 'STUDIO';
                        planIconElement.textContent = 'üéß';
                        log('üéß Exibindo plano STUDIO');
                        
                        if (upgradeCard) upgradeCard.style.display = 'none';
                        cancelCards.forEach(card => {
                            if (!card.querySelector('#delete-account-btn')) {
                                card.style.display = 'block';
                            }
                        });
                        
                    } else if (userPlan === 'pro') {
                        // Usu√°rio PRO
                        planTypeElement.className = 'plan-type pro';
                        planNameElement.textContent = 'PRO';
                        planIconElement.textContent = '‚≠ê';
                        log('‚≠ê Exibindo plano PRO');
                        
                        if (upgradeCard) upgradeCard.style.display = 'none';
                        cancelCards.forEach(card => {
                            if (!card.querySelector('#delete-account-btn')) {
                                card.style.display = 'block';
                            }
                        });
                        
                    } else if (userPlan === 'plus' && isPaidPlan) {
                        // Usu√°rio PLUS
                        planTypeElement.className = 'plan-type plus';
                        planNameElement.textContent = 'PLUS';
                        planIconElement.textContent = '‚úÖ';
                        log('‚úÖ Exibindo plano PLUS');
                        
                        if (upgradeCard) upgradeCard.style.display = 'none';
                        cancelCards.forEach(card => {
                            if (!card.querySelector('#delete-account-btn')) {
                                card.style.display = 'block';
                            }
                        });
                        
                    } else {
                        // Usu√°rio GRATUITO
                        planTypeElement.className = 'plan-type free';
                        planNameElement.textContent = 'GR√ÅTIS';
                        planIconElement.textContent = '‚ùå';
                        log('üì± Exibindo plano GRATUITO');
                        
                        if (upgradeCard) upgradeCard.style.display = 'block';
                        cancelCards.forEach(card => {
                            if (!card.querySelector('#delete-account-btn')) {
                                card.style.display = 'none';
                            }
                        });
                    }
                    
                    // Atualizar estado do bot√£o de cancelamento
                    if (cancelSubscriptionBtn) {
                        if (isCancellationPending) {
                            cancelSubscriptionBtn.disabled = true;
                            cancelSubscriptionBtn.innerHTML = '<span class="btn-icon">üìÖ</span>Cancelamento agendado';
                            cancelSubscriptionBtn.classList.add('btn-disabled');
                            log('üìÖ Cancelamento j√° agendado');
                        } else if (isPaidPlan) {
                            cancelSubscriptionBtn.disabled = false;
                            cancelSubscriptionBtn.innerHTML = '<span class="btn-icon">‚ùå</span>Cancelar assinatura';
                            cancelSubscriptionBtn.classList.remove('btn-disabled');
                        }
                    }
                    
                } catch (error) {
                    error('‚ùå Erro ao buscar dados do plano:', error);
                    
                    // Em caso de erro, mostrar como gratuito por seguran√ßa
                    const planTypeElement = document.getElementById('plan-type');
                    const planNameElement = planTypeElement?.querySelector('.plan-name');
                    const planIconElement = planTypeElement?.querySelector('.plan-icon');
                    
                    if (planTypeElement && planNameElement && planIconElement) {
                        planTypeElement.className = 'plan-type free';
                        planNameElement.textContent = 'GR√ÅTIS';
                        planIconElement.textContent = '‚ùå';
                        log('‚ö†Ô∏è Erro ao carregar plano, exibindo GRATUITO como padr√£o');
                    }
                }
            }
            
            // Fun√ß√£o para for√ßar atualiza√ß√£o do plano (√∫til ap√≥s upgrade)
            async function refreshUserPlan() {
                if (currentUser) {
                    log('üîÑ Atualizando exibi√ß√£o do plano...');
                    await updateUserPlanDisplay(currentUser.uid);
                }
            }
            
            // Fun√ß√£o para mostrar mensagens de feedback
            function showMessage(message, type = 'success', cardSelector = '.function-card') {
                // Remove mensagem anterior se existir
                const existingMessage = document.querySelector('.feedback-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                // Criar elemento de mensagem
                const messageDiv = document.createElement('div');
                messageDiv.className = `feedback-message ${type}`;
                messageDiv.textContent = message;
                
                // Determinar qual card adicionar a mensagem
                let targetCard;
                if (cardSelector === 'password') {
                    targetCard = updatePasswordBtn.closest('.function-card');
                } else if (cardSelector === 'email') {
                    targetCard = updateEmailBtn.closest('.function-card');
                } else if (cardSelector === 'personalizar') {
                    targetCard = redoInterviewBtn.closest('.function-card');
                } else {
                    targetCard = document.querySelector(cardSelector);
                }
                
                if (targetCard) {
                    targetCard.insertBefore(messageDiv, targetCard.querySelector('.card-body'));
                }
                
                // Auto-remover ap√≥s 5 segundos
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
            
            // Fun√ß√£o para validar senha
            function validatePassword(password) {
                if (password.length < 6) {
                    return 'A senha deve ter pelo menos 6 caracteres';
                }
                return null;
            }
            
            // Fun√ß√£o para validar e-mail
            function validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    return 'Por favor, insira um e-mail v√°lido';
                }
                return null;
            }
            
            // Fun√ß√£o para verificar c√≥digo de verifica√ß√£o de e-mail na URL
            async function checkEmailVerificationCode() {
                const urlParams = new URLSearchParams(window.location.search);
                const oobCode = urlParams.get('oobCode');
                const mode = urlParams.get('mode');
                
                // Log detalhado para diagn√≥stico
                log('[EMAIL VERIFY] Verificando par√¢metros da URL...');
                log('[EMAIL VERIFY] oobCode presente:', !!oobCode);
                log('[EMAIL VERIFY] mode:', mode);
                log('[EMAIL VERIFY] URL completa:', window.location.href);
                
                // NOTA: resetPassword j√° foi tratado pelo guardrail no in√≠cio do script
                // Se chegou aqui com resetPassword, algo est√° errado (n√£o deveria acontecer)
                if (mode === 'resetPassword') {
                    error('‚ùå [EMAIL VERIFY] resetPassword detectado aqui - guardrail falhou!');
                    window.location.replace('/primeiro-acesso.html' + window.location.search);
                    return;
                }
                
                if (oobCode) {
                    log('üîç C√≥digo de verifica√ß√£o encontrado na URL');
                    
                    // Recuperar o novo e-mail salvo temporariamente
                    const novoEmailTemp = localStorage.getItem('novoEmailTemp');
                    log('[EMAIL VERIFY] novoEmailTemp no localStorage:', novoEmailTemp || '(n√£o encontrado)');
                    
                    // Mostrar indicador de processamento
                    showMessage('‚è≥ Processando verifica√ß√£o de e-mail...', 'info', 'email');
                    
                    try {
                        // Com verifyBeforeUpdateEmail, o Firebase j√° atualiza o e-mail
                        // ao aplicar o c√≥digo. N√£o precisamos chamar updateEmail depois.
                        log('[EMAIL VERIFY] Aplicando c√≥digo de verifica√ß√£o...');
                        await applyActionCode(auth, oobCode);
                        log('‚úÖ C√≥digo de verifica√ß√£o aplicado com sucesso');
                        
                        // Recarregar o usu√°rio para obter as informa√ß√µes atualizadas
                        if (currentUser) {
                            await currentUser.reload();
                            log('[EMAIL VERIFY] E-mail atual ap√≥s reload:', currentUser.email);
                        }
                        
                        // Verificar se o e-mail foi atualizado automaticamente
                        const emailAtualizado = currentUser && novoEmailTemp && currentUser.email === novoEmailTemp;
                        
                        if (emailAtualizado) {
                            log('‚úÖ E-mail atualizado automaticamente pelo Firebase para:', currentUser.email);
                            showMessage('‚úÖ E-mail verificado e alterado com sucesso para: ' + currentUser.email, 'success', 'email');
                        } else if (novoEmailTemp && currentUser && currentUser.email !== novoEmailTemp) {
                            // Caso raro: c√≥digo aplicado mas e-mail n√£o mudou automaticamente
                            // Tentar atualizar manualmente
                            log('[EMAIL VERIFY] E-mail n√£o mudou automaticamente, tentando updateEmail...');
                            try {
                                await updateEmail(currentUser, novoEmailTemp);
                                await currentUser.reload();
                                log('‚úÖ E-mail atualizado manualmente para:', currentUser.email);
                                showMessage('‚úÖ E-mail alterado com sucesso para: ' + novoEmailTemp, 'success', 'email');
                            } catch (updateError) {
                                warn('[EMAIL VERIFY] updateEmail falhou (pode ser normal se j√° foi atualizado):', updateError.code);
                                // Mesmo que falhe, o applyActionCode j√° confirmou a verifica√ß√£o
                                showMessage('‚úÖ E-mail verificado! A altera√ß√£o pode levar alguns instantes.', 'success', 'email');
                            }
                        } else {
                            // Sem novoEmailTemp mas c√≥digo aplicado - verifica√ß√£o gen√©rica bem sucedida
                            showMessage('‚úÖ Verifica√ß√£o de e-mail conclu√≠da com sucesso!', 'success', 'email');
                        }
                        
                        // Limpar o localStorage
                        localStorage.removeItem('novoEmailTemp');
                        
                        // Limpar a URL removendo os par√¢metros
                        const newUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                        
                        // Atualizar UI com informa√ß√µes do usu√°rio
                        if (currentUser) {
                            updateUserInfo(currentUser);
                        }
                        
                    } catch (error) {
                        error('‚ùå Erro ao confirmar o novo e-mail:', error);
                        error('[EMAIL VERIFY] C√≥digo do erro:', error.code);
                        error('[EMAIL VERIFY] Mensagem:', error.message);
                        
                        let errorMessage = 'Erro ao confirmar o novo e-mail. Tente novamente.';
                        
                        switch (error.code) {
                            case 'auth/expired-action-code':
                                errorMessage = '‚è∞ Link de verifica√ß√£o expirado. Solicite um novo.';
                                break;
                            case 'auth/invalid-action-code':
                                errorMessage = '‚ùå Link de verifica√ß√£o inv√°lido ou j√° utilizado.';
                                break;
                            case 'auth/user-disabled':
                                errorMessage = 'üö´ Conta desabilitada. Entre em contato com o suporte.';
                                break;
                            case 'auth/email-already-in-use':
                                errorMessage = 'üìß Este e-mail j√° est√° sendo usado por outra conta.';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'üìß E-mail inv√°lido.';
                                break;
                            case 'auth/requires-recent-login':
                                errorMessage = 'üîí Sess√£o expirada. Fa√ßa login novamente e repita o processo.';
                                break;
                            default:
                                errorMessage = `‚ùå Erro: ${error.message}`;
                        }
                        
                        showMessage(errorMessage, 'error', 'email');
                        
                        // Limpar o localStorage em caso de erro
                        localStorage.removeItem('novoEmailTemp');
                        
                        // Limpar a URL mesmo em caso de erro
                        const newUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                    }
                }
            }
            
            // Fun√ß√£o principal para alterar senha
            async function changePassword() {
                if (!currentUser) {
                    showMessage('Usu√°rio n√£o autenticado. Redirecionando para login...', 'error', 'password');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const newPassword = newPasswordInput.value.trim();
                const confirmPassword = confirmPasswordInput.value.trim();
                
                // Valida√ß√µes
                if (!newPassword || !confirmPassword) {
                    showMessage('Por favor, preencha todos os campos', 'error', 'password');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showMessage('As senhas n√£o coincidem', 'error', 'password');
                    return;
                }
                
                const passwordError = validatePassword(newPassword);
                if (passwordError) {
                    showMessage(passwordError, 'error', 'password');
                    return;
                }
                
                // Desabilitar bot√£o durante o processo
                updatePasswordBtn.disabled = true;
                updatePasswordBtn.textContent = 'Atualizando...';
                
                try {
                    // Atualizar senha no Firebase
                    await updatePassword(currentUser, newPassword);
                    
                    log('‚úÖ Senha atualizada com sucesso');
                    
                    // Mostrar mensagem de sucesso
                    showMessage('‚úÖ Senha atualizada com sucesso! Voc√™ ser√° redirecionado para o login.', 'success', 'password');
                    
                    // Limpar campos
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    
                    // Aguardar um momento para que o usu√°rio veja a mensagem
                    setTimeout(async () => {
                        try {
                            // Fazer logout autom√°tico
                            log('üîê Fazendo logout autom√°tico ap√≥s altera√ß√£o de senha...');
                            await signOut(auth);
                            log('‚úÖ Logout realizado com sucesso');
                            
                            // Redirecionar para login
                            window.location.href = 'login.html';
                        } catch (logoutError) {
                            error('‚ùå Erro ao fazer logout:', logoutError);
                            // Mesmo com erro no logout, redirecionar para login
                            window.location.href = 'login.html';
                        }
                    }, 2000); // 2 segundos para o usu√°rio ler a mensagem
                    
                } catch (error) {
                    error('‚ùå Erro ao atualizar senha:', error);
                    
                    // Tratamento de erros espec√≠ficos
                    let errorMessage = 'Erro ao atualizar senha. Tente novamente.';
                    
                    switch (error.code) {
                        case 'auth/requires-recent-login':
                            errorMessage = 'üîí Para alterar a senha, voc√™ precisa fazer login novamente. Redirecionando...';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'üîê A senha √© muito fraca. Use pelo menos 6 caracteres.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'üåê Erro de conex√£o. Verifique sua internet e tente novamente.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = '‚è∞ Muitas tentativas. Tente novamente em alguns minutos.';
                            break;
                        default:
                            errorMessage = `‚ùå Erro: ${error.message}`;
                    }
                    
                    showMessage(errorMessage, 'error', 'password');
                } finally {
                    // Reabilitar bot√£o
                    updatePasswordBtn.disabled = false;
                    updatePasswordBtn.textContent = 'Atualizar senha';
                }
            }
            
            // Fun√ß√£o principal para alterar e-mail
            async function changeEmail() {
                if (!currentUser) {
                    showMessage('Usu√°rio n√£o autenticado. Redirecionando para login...', 'error', 'email');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const newEmail = newEmailInput.value.trim();
                const confirmEmail = confirmEmailInput.value.trim();
                
                // Valida√ß√µes
                if (!newEmail || !confirmEmail) {
                    showMessage('Por favor, preencha todos os campos', 'error', 'email');
                    return;
                }
                
                if (newEmail !== confirmEmail) {
                    showMessage('Os e-mails n√£o coincidem', 'error', 'email');
                    return;
                }
                
                const emailError = validateEmail(newEmail);
                if (emailError) {
                    showMessage(emailError, 'error', 'email');
                    return;
                }
                
                // Verificar se o e-mail √© diferente do atual
                if (newEmail === currentUser.email) {
                    showMessage('O novo e-mail deve ser diferente do atual', 'error', 'email');
                    return;
                }
                
                // Desabilitar bot√£o durante o processo
                updateEmailBtn.disabled = true;
                updateEmailBtn.textContent = 'Enviando verifica√ß√£o...';
                
                try {
                    // PRIMEIRO: Salvar o novo e-mail no localStorage
                    localStorage.setItem('novoEmailTemp', newEmail);
                    log('‚úÖ E-mail salvo no localStorage:', newEmail);
                    
                    // SEGUNDO: Usar verifyBeforeUpdateEmail (m√©todo recomendado pelo Firebase)
                    // URL FIXA do dom√≠nio can√¥nico - N√ÉO usar window.location.origin
                    const actionCodeSettings = {
                        url: 'https://www.soundyai.com.br/gerenciar.html',
                        handleCodeInApp: true
                    };
                    
                    // Logs de diagn√≥stico para debug
                    log('[EMAIL CHANGE] Origin atual:', window.location.origin);
                    log('[EMAIL CHANGE] continueUrl:', actionCodeSettings.url);
                    log('[EMAIL CHANGE] handleCodeInApp:', actionCodeSettings.handleCodeInApp);
                    log('[EMAIL CHANGE] Tentando enviar verifica√ß√£o para:', newEmail);
                    
                    await verifyBeforeUpdateEmail(currentUser, newEmail, actionCodeSettings);
                    
                    log('‚úÖ E-mail de verifica√ß√£o enviado');
                    showMessage('üìß E-mail de verifica√ß√£o enviado! Verifique sua caixa de entrada e clique no link para confirmar a altera√ß√£o.', 'success', 'email');
                    
                    // Limpar campos
                    newEmailInput.value = '';
                    confirmEmailInput.value = '';
                    
                } catch (error) {
                    error('‚ùå Erro ao enviar verifica√ß√£o de e-mail:', error);
                    
                    // Limpar localStorage em caso de erro
                    localStorage.removeItem('novoEmailTemp');
                    
                    // Tratamento de erros espec√≠ficos
                    let errorMessage = 'Erro ao enviar verifica√ß√£o de e-mail. Tente novamente.';
                    
                    switch (error.code) {
                        case 'auth/requires-recent-login':
                            errorMessage = 'üîí Para alterar o e-mail, voc√™ precisa fazer login novamente. Redirecionando...';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'üìß E-mail inv√°lido. Verifique o formato.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'üåê Erro de conex√£o. Verifique sua internet e tente novamente.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = '‚è∞ Muitas tentativas. Tente novamente em alguns minutos.';
                            break;
                        case 'auth/unauthorized-continue-uri':
                            errorMessage = 'üö´ Erro de configura√ß√£o do dom√≠nio. Entre em contato com o suporte.';
                            error('[EMAIL CHANGE] Erro: Dom√≠nio n√£o autorizado no Firebase. Verifique Authorized Domains.');
                            break;
                        case 'auth/email-already-in-use':
                            errorMessage = 'üìß Este e-mail j√° est√° sendo usado por outra conta.';
                            break;
                        case 'auth/operation-not-allowed':
                            errorMessage = 'üö´ Opera√ß√£o n√£o permitida. Entre em contato com o suporte.';
                            break;
                        default:
                            errorMessage = `‚ùå Erro: ${error.message}`;
                    }
                    
                    showMessage(errorMessage, 'error', 'email');
                } finally {
                    // Reabilitar bot√£o
                    updateEmailBtn.disabled = false;
                    updateEmailBtn.textContent = 'Atualizar e-mail';
                }
            }
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // üóëÔ∏è FUN√á√ïES DO MODAL DE EXCLUS√ÉO DE CONTA
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            // Fun√ß√£o para mostrar o modal de confirma√ß√£o de exclus√£o de conta
            function showDeleteAccountConfirmationModal() {
                const overlay = document.getElementById('delete-account-confirmation-overlay');
                if (overlay) {
                    overlay.classList.add('show');
                    
                    // Prevenir scroll do body
                    document.body.style.overflow = 'hidden';
                }
            }
            
            // Fun√ß√£o para esconder o modal de confirma√ß√£o de exclus√£o de conta
            function hideDeleteAccountConfirmationModal() {
                const overlay = document.getElementById('delete-account-confirmation-overlay');
                if (overlay) {
                    overlay.classList.remove('show');
                    
                    // Restaurar scroll do body
                    document.body.style.overflow = '';
                }
            }
            
            // Fun√ß√£o principal para excluir conta permanentemente
            async function deleteAccountPermanently() {
                if (!currentUser) {
                    showMessage('Usu√°rio n√£o autenticado. Redirecionando para login...', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const confirmBtn = document.getElementById('delete-account-modal-btn-confirm');
                const cancelBtn = document.getElementById('delete-account-modal-btn-cancel');
                
                // Desabilitar bot√µes durante o processo
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<span class="btn-icon">‚è≥</span>Excluindo...';
                }
                if (cancelBtn) {
                    cancelBtn.disabled = true;
                }
                
                try {
                    log('üóëÔ∏è Iniciando exclus√£o permanente da conta...');
                    
                    // Obter token do usu√°rio
                    const idToken = await currentUser.getIdToken();
                    
                    // Fazer requisi√ß√£o para excluir conta
                    const response = await fetch('/api/delete-account', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        log('‚úÖ Conta exclu√≠da com sucesso:', result.message);
                        
                        // Esconder modal
                        hideDeleteAccountConfirmationModal();
                        
                        // Mostrar mensagem de sucesso
                        showMessage('‚úÖ ' + result.message, 'success');
                        
                        // Aguardar um momento para mostrar a mensagem
                        setTimeout(async () => {
                            try {
                                // Fazer logout do Firebase
                                const { signOut } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js');
                                await signOut(auth);
                                log('‚úÖ Logout realizado com sucesso');
                            } catch (logoutError) {
                                log('‚ö†Ô∏è Erro no logout (normal ap√≥s exclus√£o):', logoutError);
                            }
                            
                            // Redirecionar para a p√°gina inicial
                            window.location.href = 'landing.html';
                        }, 2000);
                        
                    } else {
                        error('‚ùå Erro do servidor ao excluir conta:', result);
                        
                        // Esconder modal
                        hideDeleteAccountConfirmationModal();
                        
                        // Determinar tipo de mensagem e texto
                        let messageType = 'error';
                        let errorMessage = 'Erro ao excluir conta. Tente novamente.';
                        
                        if (response.status === 401) {
                            messageType = 'error';
                            errorMessage = 'Sess√£o expirada. Fa√ßa login novamente.';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                        } else if (response.status === 400) {
                            messageType = 'error';
                            errorMessage = result.error || 'Dados inv√°lidos para exclus√£o.';
                        } else if (response.status >= 500) {
                            messageType = 'error';
                            errorMessage = 'Erro interno do servidor. Tente novamente mais tarde.';
                        }
                        
                        if (result.error || result.message) {
                            errorMessage = result.error || result.message || errorMessage;
                        }
                        
                        showMessage('‚ùå ' + errorMessage, messageType);
                    }
                    
                } catch (error) {
                    error('‚ùå Erro completo ao excluir conta:', error);
                    error('‚ùå Stack trace:', error.stack);
                    
                    // Esconder modal
                    hideDeleteAccountConfirmationModal();
                    
                    // Mostrar mensagem de erro de rede
                    let errorMessage = 'Erro de conex√£o. Verifique sua internet e tente novamente.';
                    if (error.message && error.message.includes('Failed to fetch')) {
                        errorMessage = 'Erro de conex√£o com o servidor. Tente novamente.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    showMessage('‚ùå ' + errorMessage, 'error');
                    
                } finally {
                    // Reabilitar bot√µes (se ainda existirem)
                    if (confirmBtn && !confirmBtn.disabled) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = '<span class="btn-icon">üóëÔ∏è</span>Sim, excluir minha conta';
                    }
                    if (cancelBtn && !cancelBtn.disabled) {
                        cancelBtn.disabled = false;
                    }
                }
            }
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ‚úÖ FUN√á√ïES DO MODAL DE CONFIRMA√á√ÉO AP√ìS CANCELAMENTO
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            // Fun√ß√£o para mostrar o modal de confirma√ß√£o ap√≥s cancelamento
            async function showSuccessModal(planExpiresAt) {
                const overlay = document.getElementById('success-confirmation-overlay');
                const description = document.getElementById('success-modal-description');
                
                if (!overlay || !description) {
                    error('‚ùå Elementos do modal de sucesso n√£o encontrados');
                    return;
                }
                
                // Determinar a mensagem baseada na data de expira√ß√£o
                let message = 'Sua assinatura foi cancelada com sucesso.';
                
                if (planExpiresAt) {
                    try {
                        // Converter a data de expira√ß√£o
                        const expirationDate = planExpiresAt instanceof Date ? 
                            planExpiresAt : 
                            planExpiresAt.toDate ? planExpiresAt.toDate() : new Date(planExpiresAt);
                        
                        // Formatear a data em portugu√™s
                        const options = { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            timeZone: 'America/Sao_Paulo'
                        };
                        const formattedDate = expirationDate.toLocaleDateString('pt-BR', options);
                        
                        message = `Sua assinatura foi cancelada com sucesso. Voc√™ continuar√° com acesso ao Plus at√© ${formattedDate}.`;
                        
                        log('üìÖ Data de expira√ß√£o formatada:', formattedDate);
                    } catch (error) {
                        error('‚ùå Erro ao formatar data de expira√ß√£o:', error);
                        message = 'Sua assinatura foi cancelada com sucesso. Voc√™ continuar√° com acesso ao Plus at√© o fim do per√≠odo atual.';
                    }
                } else {
                    message = 'Sua assinatura foi cancelada com sucesso. O acesso ser√° mantido at√© o fim do per√≠odo atual.';
                }
                
                // Atualizar a descri√ß√£o do modal
                description.textContent = message;
                
                // Mostrar o modal com anima√ß√£o
                overlay.classList.add('show');
                
                // Prevenir scroll do body
                document.body.style.overflow = 'hidden';
                
                log('‚úÖ Modal de sucesso exibido com a mensagem:', message);
            }
            
            // Fun√ß√£o para esconder o modal de confirma√ß√£o ap√≥s cancelamento
            function hideSuccessModal() {
                const overlay = document.getElementById('success-confirmation-overlay');
                if (overlay) {
                    overlay.classList.remove('show');
                    
                    // Restaurar scroll do body
                    document.body.style.overflow = '';
                    
                    log('‚úÖ Modal de sucesso fechado');
                }
            }
            
            // Fun√ß√£o para personalizar novamente (dispon√≠vel para Plus, Pro e DJ)
            async function redoInterview() {
                if (!currentUser) {
                    showMessage('Usu√°rio n√£o autenticado. Redirecionando para login...', 'error', 'personalizar');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                try {
                    log('üîÑ Verificando plano do usu√°rio...');
                    
                    // Importar Firestore necess√°rio
                    const { doc, getDoc, deleteField, updateDoc } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js');
                    const { db } = await import('./firebase.js');
                    
                    // Verificar plano do usu√°rio no Firestore
                    const userDocRef = doc(db, 'usuarios', currentUser.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (!userDoc.exists()) {
                        showMessage('‚ùå Dados do usu√°rio n√£o encontrados.', 'error', 'personalizar');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    const userPlan = (userData.plano || '').toLowerCase();
                    
                    // Verificar se √© plano Free/Reduced (bloquear apenas esses)
                    const isFreeOrReduced = userPlan === 'free' || userPlan === 'gratis' || userPlan === 'reduced';
                    // ‚úÖ ATUALIZADO 2026-01-06: STUDIO adicionado
                    const isPremium = userPlan === 'plus' || userPlan === 'pro' || userPlan === 'dj' || userPlan === 'studio' || userData.isPlus === true;
                    
                    log('üìä Plano do usu√°rio:', userPlan, '| Premium:', isPremium, '| Free/Reduced:', isFreeOrReduced);
                    
                    // Bloquear APENAS Free/Reduced
                    if (isFreeOrReduced) {
                        log('üîí Plano Free/Reduced - bloqueando personaliza√ß√£o');
                        showPremiumOnlyMessage();
                        return;
                    }
                    
                    // Se chegou aqui, √© Premium (Plus/Pro/DJ/STUDIO) ou plano v√°lido - permitir
                    log('‚úÖ Plano Premium confirmado - permitindo personaliza√ß√£o');
                    
                    // Usu√°rio Premium (Plus/Pro/DJ) - prosseguir com redirecionamento e limpeza
                    log(`‚úÖ Usu√°rio ${userPlan.toUpperCase()} confirmado - prosseguindo...`);
                    
                    // Desabilitar bot√£o durante o processo
                    redoInterviewBtn.disabled = true;
                    redoInterviewBtn.innerHTML = '<span class="btn-icon">‚è≥</span>Apagando dados...';
                    
                    // Apagar dados antigos da entrevista
                    await updateDoc(userDocRef, {
                        perfil: deleteField(),
                        entrevistaConcluida: false,
                        dataUltimaEntrevista: deleteField()
                    });
                    
                    log('‚úÖ Dados da entrevista apagados com sucesso');
                    
                    // Mostrar mensagem de sucesso
                    showMessage('‚úÖ Dados apagados! Redirecionando para nova entrevista...', 'success', 'personalizar');
                    
                    // Redirecionar ap√≥s breve pausa com par√¢metro de repersonaliza√ß√£o
                    setTimeout(() => {
                        window.location.href = 'entrevista.html?repersonalizando=true';
                    }, 1500);
                    
                } catch (error) {
                    error('‚ùå Erro ao processar personaliza√ß√£o:', error);
                    
                    let errorMessage = 'Erro ao processar solicita√ß√£o. Tente novamente.';
                    
                    switch (error.code) {
                        case 'auth/requires-recent-login':
                            errorMessage = 'üîí Para esta a√ß√£o, voc√™ precisa fazer login novamente. Redirecionando...';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'üåê Erro de conex√£o. Verifique sua internet e tente novamente.';
                            break;
                        default:
                            errorMessage = `‚ùå Erro: ${error.message}`;
                    }
                    
                    showMessage(errorMessage, 'error', 'personalizar');
                } finally {
                    // Reabilitar bot√£o
                    redoInterviewBtn.disabled = false;
                    redoInterviewBtn.innerHTML = '<span class="btn-icon">‚ôªÔ∏è</span>Personalizar novamente';
                }
            }
            
            // Fun√ß√£o para mostrar mensagem exclusiva para usu√°rios Premium
            function showPremiumOnlyMessage() {
                // Remover mensagem anterior se existir
                const existingCard = document.querySelector('.premium-only-card');
                if (existingCard) {
                    existingCard.remove();
                }
                
                // Criar card de bloqueio
                const premiumCard = document.createElement('div');
                premiumCard.className = 'premium-only-card';
                premiumCard.innerHTML = `
                    <div class="plus-card-content">
                        <div class="plus-card-icon">üîí</div>
                        <h3 class="plus-card-title">Personaliza√ß√£o dispon√≠vel para usu√°rios Premium</h3>
                        <p class="plus-card-description">
                            Assine um plano Plus ou Pro para refazer sua entrevista e receber respostas 100% personalizadas com base no seu perfil.
                        </p>
                        <div class="plus-card-buttons">
                            <a href="planos.html" class="btn-plus-upgrade">
                                <span class="btn-icon">‚≠ê</span>
                                Ver Planos Premium
                            </a>
                            <button class="btn-plus-close" onclick="this.closest('.premium-only-card').remove()">
                                Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                // Adicionar ap√≥s o card de personalizar
                const personalizeCard = redoInterviewBtn.closest('.function-card');
                personalizeCard.insertAdjacentElement('afterend', premiumCard);
                
                // Animar entrada
                setTimeout(() => {
                    premiumCard.classList.add('show');
                }, 10);
                
                // Auto-remover ap√≥s 15 segundos
                setTimeout(() => {
                    if (premiumCard.parentNode) {
                        premiumCard.classList.remove('show');
                        setTimeout(() => {
                            if (premiumCard.parentNode) {
                                premiumCard.remove();
                            }
                        }, 300);
                    }
                }, 15000);
            }
            
            // Fun√ß√£o para mostrar o modal de confirma√ß√£o de cancelamento
            function showCancelConfirmationModal() {
                const overlay = document.getElementById('cancel-confirmation-overlay');
                if (overlay) {
                    overlay.classList.add('show');
                    
                    // Prevenir scroll do body
                    document.body.style.overflow = 'hidden';
                }
            }
            
            // Fun√ß√£o para esconder o modal de confirma√ß√£o de cancelamento
            function hideCancelConfirmationModal() {
                const overlay = document.getElementById('cancel-confirmation-overlay');
                if (overlay) {
                    overlay.classList.remove('show');
                    
                    // Restaurar scroll do body
                    document.body.style.overflow = '';
                }
            }
            
            // Fun√ß√£o principal para cancelar assinatura
            async function cancelSubscription() {
                if (!currentUser) {
                    showMessage('Usu√°rio n√£o autenticado. Redirecionando para login...', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const confirmBtn = document.getElementById('cancel-modal-btn-confirm');
                const cancelBtn = document.getElementById('cancel-modal-btn-cancel');
                
                // Desabilitar bot√µes durante o processo
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<span class="btn-icon">‚è≥</span>Cancelando...';
                }
                if (cancelBtn) {
                    cancelBtn.disabled = true;
                }
                
                try {
                    log('üîÑ Iniciando cancelamento de assinatura via Stripe...');
                    
                    // Obter token do usu√°rio
                    const idToken = await currentUser.getIdToken();
                    
                    // Fazer requisi√ß√£o para cancelar assinatura no STRIPE
                    const response = await fetch('/api/stripe/cancel-subscription', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${idToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    log('üìä Response status:', response.status);
                    log('üìä Response ok:', response.ok);
                    
                    let result;
                    try {
                        result = await response.json();
                        log('üìä Response JSON:', result);
                    } catch (jsonError) {
                        error('‚ùå Erro ao fazer parse do JSON:', jsonError);
                        const responseText = await response.text();
                        error('üìÑ Response text:', responseText);
                        throw new Error(`Resposta inv√°lida do servidor: ${responseText.substring(0, 100)}...`);
                    }
                    
                    if (response.ok && result.success) {
                        log('‚úÖ Assinatura cancelada com sucesso');
                        
                        // Esconder modal de confirma√ß√£o
                        hideCancelConfirmationModal();
                        
                        // Usar data de cancelamento retornada pela API Stripe
                        let cancelAtDate = null;
                        if (result.cancelAt) {
                            cancelAtDate = result.cancelAt;
                            log('üìÖ Data de fim do acesso (da API):', result.cancelAtFormatted || cancelAtDate);
                        } else {
                            // Fallback: buscar do Firestore
                            try {
                                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js');
                                const { db } = await import('./firebase.js');
                                
                                const userDocRef = doc(db, 'usuarios', currentUser.uid);
                                const userDoc = await getDoc(userDocRef);
                                
                                if (userDoc.exists()) {
                                    const userData = userDoc.data();
                                    cancelAtDate = userData.subscription?.currentPeriodEnd || userData.planExpiresAt;
                                    log('üìÖ Data de fim do acesso (Firestore):', cancelAtDate);
                                }
                            } catch (firestoreError) {
                                error('‚ùå Erro ao buscar dados do usu√°rio:', firestoreError);
                            }
                        }
                        
                        // Mostrar modal de confirma√ß√£o ap√≥s cancelamento
                        await showSuccessModal(cancelAtDate);
                        
                        // Atualizar exibi√ß√£o do plano para refletir cancelamento
                        await refreshUserPlan();
                        
                    } else {
                        error('‚ùå Erro ao cancelar assinatura:', result);
                        
                        // Esconder modal
                        hideCancelConfirmationModal();
                        
                        // Tratamento espec√≠fico para diferentes tipos de erro
                        let errorMessage = 'Erro ao cancelar assinatura. Tente novamente.';
                        let messageType = 'error';
                        
                        if (response.status === 400) {
                            // Erro de valida√ß√£o (ex: assinatura j√° cancelada)
                            errorMessage = result.error || result.message || 'Assinatura j√° foi cancelada ou n√£o √© v√°lida.';
                            messageType = 'warning'; // Usar warning em vez de error para casos menos cr√≠ticos
                        } else if (response.status === 401) {
                            // Erro de autentica√ß√£o
                            errorMessage = 'Sess√£o expirada. Fa√ßa login novamente.';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 2000);
                        } else if (response.status === 404) {
                            // Usu√°rio n√£o encontrado
                            errorMessage = 'Usu√°rio n√£o encontrado. Tente fazer login novamente.';
                        } else if (response.status >= 500) {
                            // Erro do servidor
                            errorMessage = 'Erro interno do servidor. Tente novamente em alguns minutos.';
                        } else {
                            // Outros erros
                            errorMessage = result.error || result.message || errorMessage;
                        }
                        
                        showMessage('‚ùå ' + errorMessage, messageType);
                    }
                    
                } catch (error) {
                    error('‚ùå Erro completo ao cancelar assinatura:', error);
                    error('‚ùå Stack trace:', error.stack);
                    
                    // Esconder modal
                    hideCancelConfirmationModal();
                    
                    // Mostrar mensagem de erro de rede
                    let errorMessage = 'Erro de conex√£o. Verifique sua internet e tente novamente.';
                    if (error.message && error.message.includes('Failed to fetch')) {
                        errorMessage = 'Erro de conex√£o com o servidor. Tente novamente.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    showMessage('‚ùå ' + errorMessage, 'error');
                } finally {
                    // Reabilitar bot√µes
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = '<span class="btn-icon">‚úÖ</span>Confirmar Cancelamento';
                    }
                    if (cancelBtn) {
                        cancelBtn.disabled = false;
                    }
                }
            }
            
            // Event Listeners
            if (updatePasswordBtn) {
                updatePasswordBtn.addEventListener('click', changePassword);
            }
            
            if (updateEmailBtn) {
                updateEmailBtn.addEventListener('click', changeEmail);
            }
            
            if (redoInterviewBtn) {
                redoInterviewBtn.addEventListener('click', redoInterview);
            }
            
            // Permitir Enter nos campos de senha
            if (newPasswordInput) {
                newPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changePassword();
                    }
                });
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changePassword();
                    }
                });
            }
            
            // Permitir Enter nos campos de e-mail
            if (newEmailInput) {
                newEmailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changeEmail();
                    }
                });
            }
            
            if (confirmEmailInput) {
                confirmEmailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changeEmail();
                    }
                });
            }
            
            // Bot√£o voltar ao chat
            if (backToChatBtn) {
                backToChatBtn.addEventListener('click', function() {
                    window.location.href = 'index.html';
                });
            }

            // Bot√£o upgrade para planos
            if (upgradeBtn) {
                upgradeBtn.addEventListener('click', function() {
                    window.location.href = 'planos.html';
                });
            }
            
            // Bot√£o cancelar assinatura - mostrar modal de confirma√ß√£o
            if (cancelSubscriptionBtn) {
                cancelSubscriptionBtn.addEventListener('click', function() {
                    showCancelConfirmationModal();
                });
            }
            
            // Bot√£o excluir conta - mostrar modal de confirma√ß√£o
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', function() {
                    showDeleteAccountConfirmationModal();
                });
            }
            
            // Event listeners para o modal de cancelamento
            const cancelModalBtnCancel = document.getElementById('cancel-modal-btn-cancel');
            const cancelModalBtnConfirm = document.getElementById('cancel-modal-btn-confirm');
            const cancelConfirmationOverlay = document.getElementById('cancel-confirmation-overlay');
            
            // Bot√£o "Cancelar" no modal (fechar modal)
            if (cancelModalBtnCancel) {
                cancelModalBtnCancel.addEventListener('click', function() {
                    hideCancelConfirmationModal();
                });
            }
            
            // Bot√£o "Confirmar Cancelamento" no modal
            if (cancelModalBtnConfirm) {
                cancelModalBtnConfirm.addEventListener('click', function() {
                    cancelSubscription();
                });
            }
            
            // Fechar modal clicando no overlay (fundo)
            if (cancelConfirmationOverlay) {
                cancelConfirmationOverlay.addEventListener('click', function(e) {
                    // S√≥ fechar se clicou no overlay (n√£o no modal)
                    if (e.target === cancelConfirmationOverlay) {
                        hideCancelConfirmationModal();
                    }
                });
            }
            
            // Event listeners para o modal de confirma√ß√£o de exclus√£o de conta
            const deleteAccountModalBtnCancel = document.getElementById('delete-account-modal-btn-cancel');
            const deleteAccountModalBtnConfirm = document.getElementById('delete-account-modal-btn-confirm');
            const deleteAccountConfirmationOverlay = document.getElementById('delete-account-confirmation-overlay');
            
            // Bot√£o "Cancelar" no modal de exclus√£o (fechar modal)
            if (deleteAccountModalBtnCancel) {
                deleteAccountModalBtnCancel.addEventListener('click', function() {
                    hideDeleteAccountConfirmationModal();
                });
            }
            
            // Bot√£o "Sim, excluir minha conta" no modal de exclus√£o
            if (deleteAccountModalBtnConfirm) {
                deleteAccountModalBtnConfirm.addEventListener('click', function() {
                    deleteAccountPermanently();
                });
            }
            
            // Fechar modal de exclus√£o clicando no overlay (fundo)
            if (deleteAccountConfirmationOverlay) {
                deleteAccountConfirmationOverlay.addEventListener('click', function(e) {
                    // S√≥ fechar se clicou no overlay (n√£o no modal)
                    if (e.target === deleteAccountConfirmationOverlay) {
                        hideDeleteAccountConfirmationModal();
                    }
                });
            }
            
            // Event listeners para o modal de confirma√ß√£o ap√≥s cancelamento
            const successModalBtnOk = document.getElementById('success-modal-btn-ok');
            const successConfirmationOverlay = document.getElementById('success-confirmation-overlay');
            
            // Bot√£o "Entendi" no modal de sucesso
            if (successModalBtnOk) {
                successModalBtnOk.addEventListener('click', function() {
                    hideSuccessModal();
                });
            }
            
            // Fechar modal de sucesso clicando no overlay (fundo)
            if (successConfirmationOverlay) {
                successConfirmationOverlay.addEventListener('click', function(e) {
                    // S√≥ fechar se clicou no overlay (n√£o no modal)
                    if (e.target === successConfirmationOverlay) {
                        hideSuccessModal();
                    }
                });
            }
            
            // Fechar modal com tecla ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const cancelOverlay = document.getElementById('cancel-confirmation-overlay');
                    const deleteOverlay = document.getElementById('delete-account-confirmation-overlay');
                    const successOverlay = document.getElementById('success-confirmation-overlay');
                    
                    if (cancelOverlay && cancelOverlay.classList.contains('show')) {
                        hideCancelConfirmationModal();
                    }
                    
                    if (deleteOverlay && deleteOverlay.classList.contains('show')) {
                        hideDeleteAccountConfirmationModal();
                    }
                    
                    if (successOverlay && successOverlay.classList.contains('show')) {
                        hideSuccessModal();
                    }
                }
            });
            
            // Configurar verifica√ß√£o peri√≥dica do plano (a cada 30 segundos)
            // Isso permite detectar mudan√ßas caso o usu√°rio fa√ßa upgrade em outra aba
            setInterval(async () => {
                if (currentUser) {
                    await updateUserPlanDisplay(currentUser.uid);
                }
            }, 30000); // 30 segundos
            
            // Configurar listener para mudan√ßas de visibilidade da p√°gina
            // Atualiza o plano quando o usu√°rio volta para a aba
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden && currentUser) {
                    log('üëÅÔ∏è P√°gina voltou ao foco, atualizando plano...');
                    await updateUserPlanDisplay(currentUser.uid);
                }
            });
            
            log('üîß Event listeners configurados');
        }, 100);
    </script>

    <script>
        // Particle Generation - Mesmo da landing.html
        const particlesContainer = document.getElementById('particles');
        const particleCount = 50;
        
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 10 + 's';
            particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
            particlesContainer.appendChild(particle);
        }

        // Initialize Vanta.js Background
        function initVantaBackground() {
            try {
                const vantaElement = document.getElementById("vanta-bg");
                if (!vantaElement) {
                    return;
                }
                
                if (typeof VANTA !== 'undefined' && typeof THREE !== 'undefined') {
                    const isLowPerformance = navigator.hardwareConcurrency <= 4;
                    const isDesktop = window.innerWidth > 768;
                    
                    VANTA.NET({
                        el: "#vanta-bg",
                        mouseControls: true,
                        touchControls: true,
                        gyroControls: false,
                        minHeight: 200.00,
                        minWidth: 200.00,
                        scale: 1.00,
                        scaleMobile: 1.00,
                        color: 0x8a2be2,
                        backgroundColor: 0x0a0a1a,
                        points: isLowPerformance ? 3.50 : (isDesktop ? 6.00 : 3.50),
                        maxDistance: isLowPerformance ? 13.00 : (isDesktop ? 20.00 : 13.00),
                        spacing: isLowPerformance ? 30.00 : (isDesktop ? 20.00 : 28.00),
                        showDots: true
                    });
                    log('Vanta.js Network background initialized');
                } else {
                    log('Vanta.js libraries not available');
                }
            } catch (error) {
                log('Vanta.js initialization error:', error);
            }
        }
        
        // Initialize Vanta.js when libraries are loaded
        function checkLibrariesAndInit() {
            if (typeof VANTA !== 'undefined' && typeof THREE !== 'undefined') {
                initVantaBackground();
            } else {
                setTimeout(checkLibrariesAndInit, 100);
            }
        }
        
        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkLibrariesAndInit);
        } else {
            checkLibrariesAndInit();
        }
        
        log('Background gerenciar.html carregado com sucesso!');
    </script>
</body>
</html>