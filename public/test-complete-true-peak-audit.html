<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Auditoria Completa True Peak</title>
</head>
<body>
    <h1>üîç Teste - Auditoria Completa para True Peak</h1>
    <p>Abra o console (F12) e observe os logs detalhados:</p>
    
    <div id="log-container">
        <h3>üéØ Problemas Identificados e Corrigidos:</h3>
        <ol>
            <li>‚úÖ <strong>Prioridade correta:</strong> s.message agora tem prioridade 1</li>
            <li>‚úÖ <strong>Fallback UI:</strong> createSuggestionCard usa message quando blocos espec√≠ficos n√£o existem</li>
            <li>‚úÖ <strong>Title/Message sync:</strong> title = message quando title est√° vazio</li>
            <li>‚úÖ <strong>True Peak no topo:</strong> ordena√ß√£o mantida</li>
            <li>‚úÖ <strong>Logs detalhados:</strong> rastreamento completo do merge</li>
        </ol>
    </div>

    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px;">
        <h4>üß™ Cen√°rios de Teste:</h4>
        <button onclick="testDirectAIMessage()">üéØ s.message direto da IA</button>
        <button onclick="testTruePeakPriority()">‚ö° True Peak priorit√°rio</button>
        <button onclick="testUIFallback()">üñ•Ô∏è Fallback UI</button>
        <button onclick="testCompleteFlow()">üöÄ Fluxo completo</button>
        <button onclick="testValidationChecklist()">‚úÖ Checklist de valida√ß√£o</button>
        <button onclick="console.clear()">üßπ Limpar Console</button>
    </div>

    <div id="result-display" style="margin: 20px 0; padding: 15px; background: #e7f3ff; border-radius: 5px;">
        <h4>üìä Resultado do √öltimo Teste:</h4>
        <div id="result-content">Nenhum teste executado ainda.</div>
    </div>

    <script>
        // Fun√ß√£o de merge corrigida com prioridade correta
        function testCorrectedMerge(validSuggestions, enhancedSuggestions) {
            return enhancedSuggestions.map((s, i) => {
                const original = validSuggestions[i] || {};
                const meta = s.metadata || {};
                const content = meta.content || {};
                const inner = meta.inner || {};
                const originalData = meta.originalData || {};
                const data = meta.data || {};
                const enriched = meta.enriched || {};

                // Busca recursiva ampla - PRIORIDADE CORRETA
                const resolvedMessage =
                    s.message ||                           // üéØ PRIORIDADE 1: Resposta direta da IA
                    original.message ||                    // üìã PRIORIDADE 2: Sugest√£o original  
                    meta.message ||                        // üîç metadata.message
                    (meta.original && meta.original.message) || // ‚ö° metadata.original.message
                    (meta.enriched && meta.enriched.message) || // ‚ú® metadata.enriched.message
                    data.message ||                        // üìä metadata.data.message
                    originalData.message ||                // üóÇÔ∏è metadata.originalData.message
                    (content.original && content.original.message) || // üèóÔ∏è metadata.content.original.message
                    (content.enriched && content.enriched.message) || // üé® metadata.content.enriched.message
                    (inner.original && inner.original.message) ||     // üè† metadata.inner.original.message
                    (inner.enriched && inner.enriched.message) ||     // üíé metadata.inner.enriched.message
                    (original.original && typeof original.original === "string" ? original.original : null);

                const resolvedAction =
                    s.action ||                           // üéØ PRIORIDADE 1: Action direta da IA
                    original.action ||                    // üìã PRIORIDADE 2: Action original
                    meta.action ||                        // üîç metadata.action
                    (meta.original && meta.original.action) || // ‚ö° metadata.original.action
                    (meta.enriched && meta.enriched.action) || // ‚ú® metadata.enriched.action
                    data.action ||                        // üìä metadata.data.action
                    originalData.action ||                // üóÇÔ∏è metadata.originalData.action
                    (content.original && content.original.action) || // üèóÔ∏è metadata.content.original.action
                    (content.enriched && content.enriched.action) || // üé® metadata.content.enriched.action
                    (inner.original && inner.original.action) ||     // üè† metadata.inner.original.action
                    (inner.enriched && inner.enriched.action) ||     // üíé metadata.inner.enriched.action
                    (original.originalAction && typeof original.originalAction === "string" ? original.originalAction : null);

                return {
                    ai_enhanced: true,
                    ...original,
                    ...s,
                    hasOriginalMessage: !!resolvedMessage,
                    messageSource: resolvedMessage ? "restored" : "fallback",
                    message: resolvedMessage || "‚ö†Ô∏è Mensagem perdida na integra√ß√£o.",
                    title: resolvedMessage || "‚ö†Ô∏è Mensagem perdida na integra√ß√£o.",
                    action: resolvedAction,
                    priority: s.priority || original.priority || 1,
                    confidence: s.confidence || original.confidence || 0.9,
                };
            });
        }

        // Fun√ß√£o de UI com fallback
        function simulateUIRendering(suggestions) {
            // Aplicar corre√ß√£o title/message
            suggestions.forEach((s) => {
                if (!s.title && s.message) {
                    s.title = s.message;
                }
            });

            // Simular createSuggestionCard
            return suggestions.map(suggestion => {
                const blocks = {
                    problem: suggestion.problema || suggestion.blocks?.problem || (suggestion.message && suggestion.message.includes("True Peak") ? suggestion.message : null),
                    cause: suggestion.causa || suggestion.blocks?.cause,
                    solution: suggestion.solucao || suggestion.blocks?.solution || suggestion.action,
                    tip: suggestion.dica_extra || suggestion.blocks?.tip,
                    plugin: suggestion.plugin || suggestion.blocks?.plugin,
                    result: suggestion.resultado || suggestion.blocks?.result
                };
                
                // FALLBACK CR√çTICO: Se n√£o h√° blocos espec√≠ficos, usar message/title como problema principal
                if (!blocks.problem && !blocks.solution && !blocks.cause) {
                    blocks.problem = suggestion.message || suggestion.title || "‚ö†Ô∏è Conte√∫do n√£o dispon√≠vel";
                    if (suggestion.action) {
                        blocks.solution = suggestion.action;
                    }
                }

                return {
                    ...suggestion,
                    renderedBlocks: blocks,
                    willDisplay: !!(blocks.problem || blocks.solution),
                    fallbackUsed: !!(!suggestion.problema && !suggestion.blocks?.problem && suggestion.message)
                };
            });
        }

        function displayResult(scenarioName, results, successCriteria) {
            const div = document.getElementById('result-content');
            
            div.innerHTML = `
                <div><strong>Cen√°rio:</strong> ${scenarioName}</div>
                <div><strong>Crit√©rios de sucesso:</strong> ${successCriteria}</div>
                <div><strong>Resultados:</strong></div>
                <ul>
                    ${results.map(r => `<li>${r.success ? '‚úÖ' : '‚ùå'} ${r.description}</li>`).join('')}
                </ul>
                <div style="margin-top: 10px;"><strong>Status geral:</strong> ${results.every(r => r.success) ? '‚úÖ TODOS OS TESTES PASSARAM' : '‚ùå ALGUNS TESTES FALHARAM'}</div>
            `;
        }

        function testDirectAIMessage() {
            console.log('üéØ Cen√°rio: s.message direto da IA (prioridade 1)');
            
            const validSuggestions = [{
                message: "Mensagem original que deveria ser ignorada",
                priority: 2
            }];
            
            const enhancedSuggestions = [{
                message: "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA (1.2 dBTP ‚Üí -1.0 dBTP)",
                action: "Aplicar FabFilter Pro-L2 com threshold em -1.0 dB",
                priority: 1,
                metadata: {
                    original: {
                        message: "Esta mensagem deveria ser ignorada"
                    }
                }
            }];
            
            const merged = testCorrectedMerge(validSuggestions, enhancedSuggestions);
            
            const results = [
                {
                    success: merged[0].message.includes("True Peak"),
                    description: `s.message preservado: "${merged[0].message}"`
                },
                {
                    success: merged[0].hasOriginalMessage === true,
                    description: `hasOriginalMessage: ${merged[0].hasOriginalMessage}`
                },
                {
                    success: merged[0].messageSource === "restored",
                    description: `messageSource: ${merged[0].messageSource}`
                },
                {
                    success: merged[0].action?.includes("FabFilter"),
                    description: `Action preservada: "${merged[0].action}"`
                }
            ];
            
            console.log('üéØ Direct AI message test:', results);
            
            displayResult("s.message direto da IA", results, "s.message deve ter prioridade sobre todas as outras fontes");
        }

        function testTruePeakPriority() {
            console.log('‚ö° Cen√°rio: True Peak no topo com ordena√ß√£o');
            
            const validSuggestions = [
                { message: "LUFS baixo", priority: 2 },
                { message: "DR adequado", priority: 3 },
                { message: "True Peak original", priority: 1 }
            ];
            
            const enhancedSuggestions = [
                {
                    message: "üìä LUFS est√° em -18.5, ideal para streaming",
                    priority: 2
                },
                {
                    message: "üéµ Dynamic Range adequado para o g√™nero",
                    priority: 3
                },
                {
                    message: "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA (1.2 dBTP ‚Üí -1.0 dBTP)",
                    action: "Aplicar limitador suave FabFilter Pro-L2",
                    priority: 1
                }
            ];
            
            const merged = testCorrectedMerge(validSuggestions, enhancedSuggestions);
            const sorted = merged.sort((a, b) => {
                if (a.message?.includes("True Peak") && !b.message?.includes("True Peak")) return -1;
                if (!a.message?.includes("True Peak") && b.message?.includes("True Peak")) return 1;
                return (a.priority || 1) - (b.priority || 1);
            });
            
            const results = [
                {
                    success: sorted[0].message.includes("True Peak"),
                    description: `True Peak no topo: "${sorted[0].message.substring(0, 40)}..."`
                },
                {
                    success: sorted.every(s => s.hasOriginalMessage),
                    description: `Todas as mensagens preservadas: ${sorted.every(s => s.hasOriginalMessage)}`
                },
                {
                    success: sorted[0].action?.includes("FabFilter"),
                    description: `Plugin espec√≠fico preservado: ${sorted[0].action?.includes("FabFilter") ? 'SIM' : 'N√ÉO'}`
                }
            ];
            
            console.log('‚ö° True Peak priority test:', {
                beforeSort: merged.map(s => s.message.substring(0, 30)),
                afterSort: sorted.map(s => s.message.substring(0, 30)),
                truePeakFirst: sorted[0].message.includes("True Peak")
            });
            
            displayResult("True Peak priorit√°rio", results, "True Peak deve aparecer sempre primeiro ap√≥s ordena√ß√£o");
        }

        function testUIFallback() {
            console.log('üñ•Ô∏è Cen√°rio: Fallback UI quando blocos espec√≠ficos n√£o existem');
            
            const suggestions = [
                {
                    message: "‚ö° True Peak cr√≠tico detectado",
                    action: "Aplicar limitador",
                    hasOriginalMessage: true,
                    messageSource: "restored",
                    // Sem campos problema/solucao espec√≠ficos
                },
                {
                    message: "üìä LUFS adequado para streaming",
                    action: "Manter n√≠veis atuais",
                    hasOriginalMessage: true,
                    messageSource: "restored",
                    problema: "Campo espec√≠fico existente", // Este tem campo espec√≠fico
                }
            ];
            
            const rendered = simulateUIRendering([...suggestions]);
            
            const results = [
                {
                    success: rendered[0].fallbackUsed === true,
                    description: `Fallback ativado para True Peak: ${rendered[0].fallbackUsed}`
                },
                {
                    success: rendered[0].renderedBlocks.problem === "‚ö° True Peak cr√≠tico detectado",
                    description: `Message usado como problema: "${rendered[0].renderedBlocks.problem}"`
                },
                {
                    success: rendered[0].willDisplay === true,
                    description: `Card ser√° exibido: ${rendered[0].willDisplay}`
                },
                {
                    success: rendered[1].fallbackUsed === false,
                    description: `Campo espec√≠fico preservado: ${rendered[1].fallbackUsed === false}`
                }
            ];
            
            console.log('üñ•Ô∏è UI Fallback test:', rendered);
            
            displayResult("Fallback UI", results, "UI deve usar message como fallback quando blocos espec√≠ficos n√£o existem");
        }

        function testCompleteFlow() {
            console.log('üöÄ Cen√°rio: Fluxo completo - merge + ordena√ß√£o + UI');
            
            // Simular resposta real do backend
            const validSuggestions = [
                { message: "LUFS original", priority: 2 },
                { message: "True Peak original", priority: 1 }
            ];
            
            const enhancedSuggestions = [
                {
                    message: "üìä LUFS ideal para plataformas digitais",
                    action: "Ajustar gain para -14 LUFS",
                    priority: 2
                },
                {
                    message: "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA (1.2 dBTP ‚Üí -1.0 dBTP)",
                    action: "Aplicar FabFilter Pro-L2 com threshold suave",
                    priority: 1
                }
            ];
            
            // Executar fluxo completo
            const merged = testCorrectedMerge(validSuggestions, enhancedSuggestions);
            const sorted = merged.sort((a, b) => {
                if (a.message?.includes("True Peak") && !b.message?.includes("True Peak")) return -1;
                if (!a.message?.includes("True Peak") && b.message?.includes("True Peak")) return 1;
                return (a.priority || 1) - (b.priority || 1);
            });
            const rendered = simulateUIRendering(sorted);
            
            const results = [
                {
                    success: sorted.every(s => s.hasOriginalMessage && s.messageSource === "restored"),
                    description: `Todas as mensagens restauradas: ${sorted.every(s => s.hasOriginalMessage)}`
                },
                {
                    success: sorted[0].message.includes("True Peak"),
                    description: `True Peak no topo: "${sorted[0].message.substring(0, 40)}..."`
                },
                {
                    success: rendered.every(r => r.willDisplay),
                    description: `Todos os cards ser√£o exibidos: ${rendered.every(r => r.willDisplay)}`
                },
                {
                    success: !sorted.some(s => s.message.includes("‚ö†Ô∏è Mensagem perdida")),
                    description: `Nenhum fallback de erro: ${!sorted.some(s => s.message.includes("‚ö†Ô∏è Mensagem perdida"))}`
                }
            ];
            
            console.log('üöÄ Complete flow results:', {
                mergedCount: merged.length,
                allRestored: sorted.every(s => s.hasOriginalMessage),
                truePeakFirst: sorted[0].message.includes("True Peak"),
                allWillDisplay: rendered.every(r => r.willDisplay),
                finalSuggestions: sorted.map(s => ({ 
                    message: s.message.substring(0, 50), 
                    action: s.action?.substring(0, 30),
                    willDisplay: rendered.find(r => r.message === s.message)?.willDisplay
                }))
            });
            
            displayResult("Fluxo completo", results, "Merge + Ordena√ß√£o + UI funcionando 100%");
        }

        function testValidationChecklist() {
            console.log('‚úÖ Cen√°rio: Checklist de valida√ß√£o autom√°tica');
            
            // Simular caso mais complexo
            const validSuggestions = [{ message: "Original", priority: 1 }];
            const enhancedSuggestions = [{
                message: "‚ö° True Peak requer corre√ß√£o PRIORIT√ÅRIA",
                action: "Aplicar limitador nativo da DAW ou FabFilter Pro-L2",
                priority: 1
            }];
            
            const merged = testCorrectedMerge(validSuggestions, enhancedSuggestions);
            const sorted = merged.sort((a, b) => {
                if (a.message?.includes("True Peak") && !b.message?.includes("True Peak")) return -1;
                if (!a.message?.includes("True Peak") && b.message?.includes("True Peak")) return 1;
                return (a.priority || 1) - (b.priority || 1);
            });
            const rendered = simulateUIRendering(sorted);
            
            const checklist = [
                {
                    success: !sorted.some(s => s.message.includes("‚ö†Ô∏è Mensagem perdida")),
                    description: "‚ùå Nenhum '‚ö†Ô∏è Mensagem perdida na integra√ß√£o' √© exibido"
                },
                {
                    success: sorted[0].message.includes("True Peak"),
                    description: "‚úÖ True Peak aparece no topo com texto priorit√°rio correto"
                },
                {
                    success: rendered.every(r => r.willDisplay && (r.renderedBlocks.problem || r.renderedBlocks.solution)),
                    description: "‚úÖ Todos os blocos da IA s√£o renderizados (Problema/Solu√ß√£o)"
                },
                {
                    success: sorted.every(s => s.hasOriginalMessage === true),
                    description: "‚úÖ hasOriginalMessage: true no log"
                },
                {
                    success: sorted.every(s => s.messageSource === "restored"),
                    description: "‚úÖ messageSource: 'restored' no log"
                },
                {
                    success: sorted.every(s => s.message && s.title && s.message === s.title),
                    description: "‚úÖ Nenhum campo v√°lido √© apagado (message = title)"
                }
            ];
            
            console.log('‚úÖ Validation checklist:', checklist);
            
            displayResult("Checklist de valida√ß√£o", checklist, "Todos os crit√©rios do checklist devem passar");
        }

        // Log inicial
        console.log("üîç [AUDIT] Auditoria completa para True Peak iniciada");
        console.log("üéØ Corre√ß√µes aplicadas: prioridade s.message, fallback UI, logs detalhados");
        console.log("‚ö° Meta: eliminar '‚ö†Ô∏è Mensagem perdida' e exibir True Peak corretamente");
    </script>
</body>
</html>