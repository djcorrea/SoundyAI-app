<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üß™ Teste HARD GATES - Score Engine V3.1</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --card: #1a1a2e;
      --border: #2d2d4a;
      --text: #f0f0f0;
      --accent: #6366f1;
      --red: #ef4444;
      --yellow: #fbbf24;
      --green: #22c55e;
      --blue: #3b82f6;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }
    
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 2rem;
      font-size: 0.9rem;
    }
    
    .mode-selector {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .mode-btn {
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mode-btn.active {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.2);
    }
    
    .mode-btn:hover {
      border-color: var(--accent);
    }
    
    .mode-info {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .mode-info .label {
      color: #888;
      font-size: 0.8rem;
    }
    
    .mode-info .value {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--blue);
    }
    
    .test-container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
    }
    
    .test-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    .test-card h2 {
      font-size: 1rem;
      color: var(--accent);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .test-card.critical { border-color: var(--red); }
    .test-card.warning { border-color: var(--yellow); }
    .test-card.success { border-color: var(--green); }
    
    .input-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .input-group input, .input-group select {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
      color: var(--text);
      font-size: 0.9rem;
    }
    
    button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.2s;
    }
    
    button:hover { opacity: 0.9; }
    
    .result {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      max-height: 350px;
      overflow-y: auto;
    }
    
    .score-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .score-value {
      font-size: 3rem;
      font-weight: bold;
    }
    
    .score-value.critical { color: var(--red); }
    .score-value.warning { color: var(--yellow); }
    .score-value.good { color: var(--green); }
    
    .classification {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    .status-bar {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .status-indicator.active { background: var(--green); }
    .status-indicator.inactive { background: var(--red); }
    .status-indicator.pending { background: var(--yellow); }
    
    .criteria {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 2rem;
    }
    
    .criteria h3 {
      color: var(--accent);
      margin-bottom: 1rem;
    }
    
    .criteria-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .criteria-item:last-child { border-bottom: none; }
    
    .criteria-check { color: var(--green); }
    .criteria-fail { color: var(--red); }
  </style>
</head>
<body>
  <h1>üß™ Teste HARD GATES - Score Engine V3.1</h1>
  <p class="subtitle">Valida√ß√£o dos crit√©rios de aceite do sistema de scoring</p>
  
  <div class="mode-selector">
    <button class="mode-btn active" data-mode="streaming">üì∫ Streaming</button>
    <button class="mode-btn" data-mode="pista">üéµ Pista/Club</button>
    <button class="mode-btn" data-mode="reference">üéöÔ∏è Reference</button>
  </div>
  
  <div class="mode-info">
    <div class="label">True Peak Max para modo selecionado:</div>
    <div class="value" id="modeMaxTP">-1.0 dBTP (streaming)</div>
  </div>
  
  <div class="status-bar">
    <div class="status-item">
      <span class="status-indicator pending" id="scoringStatus"></span>
      <span id="scoringStatusText">Carregando m√≥dulo...</span>
    </div>
    <div class="status-item">
      <span>Engine: </span>
      <strong id="engineVersion">--</strong>
    </div>
    <div class="status-item">
      <span>Modo: </span>
      <strong id="currentMode">streaming</strong>
    </div>
  </div>
  
  <div class="test-container">
    <!-- Teste 1: True Peak acima do max do modo -->
    <div class="test-card critical">
      <h2>üö® HARD GATE: True Peak > Max do Modo</h2>
      <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 1rem;">
        Streaming: TP > -1.0 dBTP ‚Üí score ‚â§ 30<br>
        Pista: TP > 0.0 dBTP ‚Üí score ‚â§ 30
      </p>
      <div class="input-group">
        <input type="number" id="truePeakCritical" value="0.50" step="0.1" placeholder="True Peak (dBTP)">
        <button onclick="runTest('critical')">Testar</button>
      </div>
      <div class="score-display">
        <span class="score-value critical" id="scoreCritical">--</span>
        <span class="classification" id="classCritical">--</span>
      </div>
      <div class="result" id="resultCritical">Aguardando teste...</div>
    </div>
    
    <!-- Teste 2: True Peak warning (pr√≥ximo do limite) -->
    <div class="test-card warning">
      <h2>‚ö†Ô∏è WARNING: True Peak pr√≥ximo do limite</h2>
      <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 1rem;">
        Dentro de 0.5 dB do max ‚Üí score ‚â§ 70
      </p>
      <div class="input-group">
        <input type="number" id="truePeakWarning" value="-1.3" step="0.1" placeholder="True Peak (dBTP)">
        <button onclick="runTest('warning')">Testar</button>
      </div>
      <div class="score-display">
        <span class="score-value warning" id="scoreWarning">--</span>
        <span class="classification" id="classWarning">--</span>
      </div>
      <div class="result" id="resultWarning">Aguardando teste...</div>
    </div>
    
    <!-- Teste 3: True Peak OK -->
    <div class="test-card success">
      <h2>‚úÖ OK: True Peak dentro do range</h2>
      <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 1rem;">
        TP bem abaixo do max ‚Üí score normal
      </p>
      <div class="input-group">
        <input type="number" id="truePeakNormal" value="-2.0" step="0.1" placeholder="True Peak (dBTP)">
        <button onclick="runTest('normal')">Testar</button>
      </div>
      <div class="score-display">
        <span class="score-value good" id="scoreNormal">--</span>
        <span class="classification" id="classNormal">--</span>
      </div>
      <div class="result" id="resultNormal">Aguardando teste...</div>
    </div>
    
    <!-- Teste 4: Caso extremo +4.4 dBTP -->
    <div class="test-card critical">
      <h2>üî• EXTREMO: +4.4 dBTP (caso real)</h2>
      <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 1rem;">
        Caso real reportado: deve ter score ‚â§ 30
      </p>
      <div class="input-group">
        <input type="number" id="truePeakExtreme" value="4.40" step="0.1" placeholder="True Peak (dBTP)">
        <button onclick="runTest('extreme')">Testar</button>
      </div>
      <div class="score-display">
        <span class="score-value critical" id="scoreExtreme">--</span>
        <span class="classification" id="classExtreme">--</span>
      </div>
      <div class="result" id="resultExtreme">Aguardando teste...</div>
    </div>
  </div>
  
  <!-- Crit√©rios de aceite -->
  <div class="criteria">
    <h3>üìã Crit√©rios de Aceite</h3>
    <div class="criteria-item">
      <span id="criteriaTP050" class="criteria-fail">‚ùì</span>
      <span>truePeakDbtp = +0.50 (streaming) ‚Üí finalScore ‚â§ 30, criticalErrors = TRUE_PEAK_CLIPPING</span>
    </div>
    <div class="criteria-item">
      <span id="criteriaTP440" class="criteria-fail">‚ùì</span>
      <span>truePeakDbtp = +4.40 ‚Üí finalScore ‚â§ 30</span>
    </div>
    <div class="criteria-item">
      <span id="criteriaFields" class="criteria-fail">‚ùì</span>
      <span>Result inclui: scoringEngineVersion, modeUsed, genreUsed, fallbackUsed</span>
    </div>
    <div class="criteria-item">
      <span id="criteriaNoFallback" class="criteria-fail">‚ùì</span>
      <span>Nenhum fallback acontece sem marcar fallbackUsed=true</span>
    </div>
  </div>
  
  <script type="module">
    let scorerMod = null;
    let currentMode = 'streaming';
    
    const MODE_MAX_TP = {
      streaming: -1.0,
      pista: 0.0,
      reference: 0.0
    };
    
    // Mode selector
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode;
        document.getElementById('currentMode').textContent = currentMode;
        document.getElementById('modeMaxTP').textContent = `${MODE_MAX_TP[currentMode]} dBTP (${currentMode})`;
        
        // Definir globalmente
        window.SCORE_MODE = currentMode;
      });
    });
    
    async function loadScoring() {
      try {
        // Carregar reference adapter primeiro
        try {
          await import('/lib/audio/features/reference-adapter.js');
          log('[TEST] ‚úÖ Reference Adapter carregado');
        } catch (e) {
          warn('[TEST] ‚ö†Ô∏è Reference Adapter n√£o dispon√≠vel:', e.message);
        }
        
        scorerMod = await import('/lib/audio/features/scoring.js');
        if (scorerMod && typeof scorerMod.computeMixScore === 'function') {
          document.getElementById('scoringStatus').className = 'status-indicator active';
          document.getElementById('scoringStatusText').textContent = '‚úÖ M√≥dulo carregado';
          document.getElementById('engineVersion').textContent = 'V3.1 Hard Gates';
          log('[TEST] ‚úÖ M√≥dulo de scoring carregado');
          
          // Rodar todos os testes automaticamente
          setTimeout(() => {
            runTest('critical');
            runTest('warning');
            runTest('normal');
            runTest('extreme');
          }, 100);
        } else {
          throw new Error('computeMixScore n√£o encontrado');
        }
      } catch (err) {
        error('[TEST] ‚ùå Erro ao carregar scoring:', err);
        document.getElementById('scoringStatus').className = 'status-indicator inactive';
        document.getElementById('scoringStatusText').textContent = '‚ùå Erro: ' + err.message;
      }
    }
    
    function getBaseMetrics() {
      return {
        lufsIntegrated: -14.0,
        lra: 7.0,
        stereoWidth: 0.6,
        spectralCentroid: 2500,
        spectralRolloff85: 8000,
        dynamicRange: 8.0,
        peakDb: -0.5,
        rmsDb: -12.0
      };
    }
    
    window.runTest = function(type) {
      if (!scorerMod) {
        alert('M√≥dulo de scoring n√£o carregado!');
        return;
      }
      
      let truePeak;
      
      switch(type) {
        case 'critical':
          truePeak = parseFloat(document.getElementById('truePeakCritical').value);
          break;
        case 'warning':
          truePeak = parseFloat(document.getElementById('truePeakWarning').value);
          break;
        case 'normal':
          truePeak = parseFloat(document.getElementById('truePeakNormal').value);
          break;
        case 'extreme':
          truePeak = parseFloat(document.getElementById('truePeakExtreme').value);
          break;
      }
      
      const technicalData = {
        ...getBaseMetrics(),
        truePeakDbtp: truePeak
      };
      
      log(`[TEST:${type}] Testando TP=${truePeak} mode=${currentMode}`);
      
      // Chamar computeMixScore com mode
      const result = scorerMod.computeMixScore(technicalData, null, { mode: currentMode });
      
      log(`[TEST:${type}] Resultado:`, result);
      
      // Atualizar UI
      const typeCap = type.charAt(0).toUpperCase() + type.slice(1);
      const scoreEl = document.getElementById(`score${typeCap}`);
      const classEl = document.getElementById(`class${typeCap}`);
      const resultEl = document.getElementById(`result${typeCap}`);
      
      if (scoreEl) {
        scoreEl.textContent = result.scorePct + '%';
        scoreEl.className = 'score-value';
        if (result.scorePct <= 30) scoreEl.classList.add('critical');
        else if (result.scorePct <= 70) scoreEl.classList.add('warning');
        else scoreEl.classList.add('good');
      }
      
      if (classEl) {
        classEl.textContent = result.classification;
      }
      
      if (resultEl) {
        const gatesInfo = result.gatesTriggered?.length > 0 
          ? '\n\nGATES ATIVADOS:\n' + result.gatesTriggered.map(g => 
              `- ${g.type}\n  ${g.reason}\n  Valor: ${g.value?.toFixed?.(2) || g.value}, Limite: ${g.limit}`
            ).join('\n')
          : '\n\n‚úÖ Nenhum gate ativado';
        
        const diagnostico = `
ENGINE: ${result.scoringEngineVersion || 'N/A'}
MODE USADO: ${result.modeUsed || 'N/A'}
GENRE USADO: ${result.genreUsed || 'N/A'}
FALLBACK: ${result.fallbackUsed ? 'SIM - ' + result.fallbackReason : 'N√ÉO'}

SCORE ORIGINAL: ${result.originalScoreBeforeGates || result.scorePct}%
SCORE FINAL: ${result.scorePct}%
CLASSIFICA√á√ÉO: ${result.classification}
CAP APLICADO: ${result.finalScoreCapApplied ? result.finalScoreCapApplied + '%' : 'Nenhum'}
ERROS CR√çTICOS: ${result.criticalErrors?.join(', ') || 'Nenhum'}
${gatesInfo}

TARGETS USADOS:
- True Peak Max: ${result._targetsUsed?.truePeakMax} dBTP
- LUFS Max: ${result._targetsUsed?.lufsMax} LUFS
- Mode: ${result._targetsUsed?.mode}
        `.trim();
        
        resultEl.textContent = diagnostico;
        
        // Validar e colorir resultado
        if (type === 'critical' || type === 'extreme') {
          const tpMax = MODE_MAX_TP[currentMode];
          if (truePeak > tpMax && result.scorePct > 30) {
            resultEl.style.background = 'rgba(239, 68, 68, 0.2)';
            error(`[TEST:${type}] ‚ùå FALHOU! Score ${result.scorePct}% > 30%`);
          } else if (truePeak > tpMax && result.scorePct <= 30) {
            resultEl.style.background = 'rgba(34, 197, 94, 0.2)';
            log(`[TEST:${type}] ‚úÖ PASSOU! Score ${result.scorePct}% ‚â§ 30%`);
          }
        }
      }
      
      // Atualizar crit√©rios
      updateCriteria(type, result, truePeak);
    };
    
    function updateCriteria(type, result, truePeak) {
      // Crit√©rio 1: TP +0.50 streaming ‚Üí score ‚â§ 30
      if (type === 'critical' && truePeak >= 0.5 && currentMode === 'streaming') {
        const el = document.getElementById('criteriaTP050');
        const passed = result.scorePct <= 30 && result.criticalErrors?.includes('TRUE_PEAK_CLIPPING');
        el.className = passed ? 'criteria-check' : 'criteria-fail';
        el.textContent = passed ? '‚úÖ' : '‚ùå';
      }
      
      // Crit√©rio 2: TP +4.40 ‚Üí score ‚â§ 30
      if (type === 'extreme' && truePeak >= 4.4) {
        const el = document.getElementById('criteriaTP440');
        const passed = result.scorePct <= 30;
        el.className = passed ? 'criteria-check' : 'criteria-fail';
        el.textContent = passed ? '‚úÖ' : '‚ùå';
      }
      
      // Crit√©rio 3: Campos obrigat√≥rios
      const hasFields = result.scoringEngineVersion && 
                       result.modeUsed && 
                       result.genreUsed !== undefined && 
                       result.fallbackUsed !== undefined;
      const elFields = document.getElementById('criteriaFields');
      elFields.className = hasFields ? 'criteria-check' : 'criteria-fail';
      elFields.textContent = hasFields ? '‚úÖ' : '‚ùå';
      
      // Crit√©rio 4: Fallback expl√≠cito
      const elFallback = document.getElementById('criteriaNoFallback');
      const fallbackOk = result.fallbackUsed === false || 
                        (result.fallbackUsed === true && result.fallbackReason);
      elFallback.className = fallbackOk ? 'criteria-check' : 'criteria-fail';
      elFallback.textContent = fallbackOk ? '‚úÖ' : '‚ùå';
    }
    
    loadScoring();
  </script>
</body>
</html>
