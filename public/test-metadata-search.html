<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Busca em Metadata True Peak</title>
    <!-- âœ… CRITICAL: Logger DEVE ser o primeiro script carregado -->
    <script src="logger.js"></script>
    

</head>
<body>
    <h1>ğŸ” Teste - Busca em Metadata para True Peak</h1>
    <p>Abra o console (F12) e observe os logs:</p>
    
    <div id="log-container">
        <h3>Nova Ordem de Busca em Metadata:</h3>
        <ol>
            <li>ğŸ¯ <code>s.message</code> (resposta direta da IA)</li>
            <li>ğŸ” <code>meta.message</code> (metadata.message)</li>
            <li>âš¡ <code>meta.original.message</code> (metadata.original.message)</li>
            <li>ğŸ“‹ <code>original.message</code> (sugestÃ£o original)</li>
            <li>ğŸ”„ <code>original.original</code> (campo aninhado)</li>
        </ol>
    </div>

    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px;">
        <h4>ğŸ§ª CenÃ¡rios de Teste:</h4>
        <button onclick="testMetadataMessage()">ğŸ” meta.message presente</button>
        <button onclick="testMetadataOriginal()">âš¡ meta.original.message</button>
        <button onclick="testMetadataAction()">ğŸ¬ meta.original.action</button>
        <button onclick="testTruePeakFromBackend()">ğŸ“¡ True Peak do Backend</button>
        <button onclick="testCompleteMetadataFlow()">ğŸ”„ Fluxo Completo Metadata</button>
        <button onclick="console.clear()">ğŸ§¹ Limpar Console</button>
    </div>

    <div id="result-display" style="margin: 20px 0; padding: 15px; background: #e7f3ff; border-radius: 5px;">
        <h4>ğŸ“Š Resultado do Ãšltimo Teste:</h4>
        <div id="result-content">Nenhum teste executado ainda.</div>
    </div>

    <script>
        // FunÃ§Ã£o de merge implementada (cÃ³pia da correÃ§Ã£o com metadata)
        function testMergeWithMetadata(validSuggestions, enhancedSuggestions) {
            return enhancedSuggestions.map((s, i) => {
                const original = validSuggestions[i] || {};
                const meta = s.metadata || {};

                // Busca mensagem original em mÃºltiplos nÃ­veis
                const originalMsg =
                    s.message ||
                    meta.message ||
                    (meta.original && meta.original.message) ||
                    original.message ||
                    (original.original && typeof original.original === "string" ? original.original : null);

                // Busca aÃ§Ã£o original
                const originalAction =
                    s.action ||
                    meta.action ||
                    (meta.original && meta.original.action) ||
                    original.action ||
                    (original.originalAction && typeof original.originalAction === "string" ? original.originalAction : null);

                return {
                    ai_enhanced: true,
                    ...original,
                    ...s,
                    hasOriginalMessage: !!originalMsg,
                    messageSource: originalMsg ? "restored" : "fallback",
                    message: originalMsg || "âš ï¸ Mensagem perdida na integraÃ§Ã£o.",
                    action: originalAction,
                    priority: s.priority || original.priority || 1,
                    confidence: s.confidence || original.confidence || 0.9,
                };
            });
        }

        function displayResult(scenarioName, result, expected, metadata) {
            const div = document.getElementById('result-content');
            const success = result.message === expected;
            
            div.innerHTML = `
                <div><strong>CenÃ¡rio:</strong> ${scenarioName}</div>
                <div><strong>Resultado:</strong> ${success ? 'âœ… SUCESSO' : 'âŒ FALHA'}</div>
                <div><strong>Mensagem obtida:</strong> "${result.message}"</div>
                <div><strong>Mensagem esperada:</strong> "${expected}"</div>
                <div><strong>Message Source:</strong> ${result.messageSource}</div>
                <div><strong>hasOriginalMessage:</strong> ${result.hasOriginalMessage}</div>
                <div><strong>Metadata presente:</strong> ${!!metadata}</div>
                <div style="margin-top: 10px;"><strong>Dados completos:</strong> ${JSON.stringify(result, null, 2)}</div>
            `;
            
            log(`ğŸ§ª ${scenarioName}:`, {
                success,
                message: result.message,
                messageSource: result.messageSource,
                hasOriginalMessage: result.hasOriginalMessage,
                metadata: metadata,
                fullResult: result
            });
        }

        function testMetadataMessage() {
            log('ğŸ” CenÃ¡rio: meta.message presente');
            const validSuggestions = [{message: "Original message"}];
            const enhancedSuggestions = [{
                message: null,
                metadata: {
                    message: "âš¡ True Peak from metadata.message"
                }
            }];
            
            const result = testMergeWithMetadata(validSuggestions, enhancedSuggestions)[0];
            const expected = "âš¡ True Peak from metadata.message";
            
            displayResult("meta.message presente", result, expected, enhancedSuggestions[0].metadata);
        }

        function testMetadataOriginal() {
            log('âš¡ CenÃ¡rio: meta.original.message presente');
            const validSuggestions = [{message: "Fallback message"}];
            const enhancedSuggestions = [{
                message: null,
                metadata: {
                    message: null,
                    original: {
                        message: "âš¡ True Peak requer correÃ§Ã£o PRIORITÃRIA. Reduza o limitador ou use compressÃ£o suave para evitar clipping digital."
                    }
                }
            }];
            
            const result = testMergeWithMetadata(validSuggestions, enhancedSuggestions)[0];
            const expected = "âš¡ True Peak requer correÃ§Ã£o PRIORITÃRIA. Reduza o limitador ou use compressÃ£o suave para evitar clipping digital.";
            
            displayResult("meta.original.message", result, expected, enhancedSuggestions[0].metadata);
        }

        function testMetadataAction() {
            log('ğŸ¬ CenÃ¡rio: meta.original.action presente');
            const validSuggestions = [{action: "Fallback action"}];
            const enhancedSuggestions = [{
                action: null,
                metadata: {
                    action: null,
                    original: {
                        action: "Ajustar limitador para -1.0 dB",
                        message: "True Peak message"
                    }
                }
            }];
            
            const result = testMergeWithMetadata(validSuggestions, enhancedSuggestions)[0];
            
            log('ğŸ“Š Action test result:', {
                action: result.action,
                expected: "Ajustar limitador para -1.0 dB",
                success: result.action === "Ajustar limitador para -1.0 dB"
            });

            displayResult("meta.original.action", result, result.message, enhancedSuggestions[0].metadata);
        }

        function testTruePeakFromBackend() {
            log('ğŸ“¡ CenÃ¡rio: True Peak completo do Backend');
            
            // Simular sugestÃ£o original
            const validSuggestions = [{
                message: "âš¡ True Peak requer correÃ§Ã£o PRIORITÃRIA. Reduza o limitador ou use compressÃ£o suave para evitar clipping digital.",
                action: "Ajustar limitador para -1.0 dB",
                priority: 1,
                type: "truePeak",
                metric: "true_peak",
                value: 0.5,
                target: -1.0
            }];
            
            // Simular resposta do backend que preservou em metadata
            const enhancedSuggestions = [{
                message: null, // IA nÃ£o retornou mensagem direta
                action: "Apply gentle limiting to reduce peaks",
                metadata: {
                    processing_type: "mastering",
                    priority: "high",
                    original: {
                        message: "âš¡ True Peak requer correÃ§Ã£o PRIORITÃRIA. Reduza o limitador ou use compressÃ£o suave para evitar clipping digital.",
                        action: "Ajustar limitador para -1.0 dB",
                        metric: "true_peak",
                        value: 0.5,
                        target: -1.0
                    }
                },
                blocks: {
                    problem: "True peak elevation detected",
                    solution: "Apply gentle limiting",
                    education: "Digital clipping prevention"
                }
            }];
            
            const result = testMergeWithMetadata(validSuggestions, enhancedSuggestions)[0];
            const expected = "âš¡ True Peak requer correÃ§Ã£o PRIORITÃRIA. Reduza o limitador ou use compressÃ£o suave para evitar clipping digital.";
            
            log('ğŸ¯ True Peak Backend test:', {
                originalMessage: validSuggestions[0].message,
                backendMetadata: enhancedSuggestions[0].metadata,
                finalMessage: result.message,
                preserved: result.message === expected,
                messageSource: result.messageSource
            });
            
            displayResult("True Peak do Backend", result, expected, enhancedSuggestions[0].metadata);
        }

        function testCompleteMetadataFlow() {
            log('ğŸ”„ CenÃ¡rio: Fluxo Completo com Metadata');
            
            // Testar mÃºltiplas sugestÃµes com diferentes localizaÃ§Ãµes de dados
            const validSuggestions = [
                {message: "Original True Peak", priority: 1},
                {message: "Original LUFS", priority: 2},
                {message: "Original DR", priority: 3}
            ];
            
            const enhancedSuggestions = [
                {
                    message: null,
                    metadata: {
                        original: {
                            message: "âš¡ True Peak (metadata.original.message)"
                        }
                    }
                },
                {
                    message: null,
                    metadata: {
                        message: "ğŸ“Š LUFS (metadata.message)"
                    }
                },
                {
                    message: "ğŸµ DR (s.message direct)",
                    metadata: {
                        message: "Should not be used"
                    }
                }
            ];
            
            const results = testMergeWithMetadata(validSuggestions, enhancedSuggestions);
            
            log('ğŸ”„ Complete flow results:', results.map((r, i) => ({
                index: i + 1,
                message: r.message,
                messageSource: r.messageSource,
                hasOriginalMessage: r.hasOriginalMessage
            })));
            
            const allPreserved = results.every(r => r.hasOriginalMessage);
            
            displayResult("Fluxo Completo Metadata", {
                message: `${results.length} sugestÃµes processadas`,
                messageSource: allPreserved ? "restored" : "mixed",
                hasOriginalMessage: allPreserved
            }, `${results.length} sugestÃµes processadas`, {complete: true});
        }

        // Log inicial
        log("ğŸš€ [TEST] Teste de busca em metadata iniciado");
        log("ğŸ” Nova ordem: s.message â†’ meta.message â†’ meta.original.message â†’ original.message â†’ original.original");
    </script>
</body>
</html>