<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste True Peak Pipeline</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #f0f0f0;
        }
        
        .test-container {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            margin: 5px;
        }
        
        button:hover {
            background: #005999;
        }
        
        .success {
            color: #4CAF50;
        }
        
        .error {
            color: #f44336;
        }
        
        .warning {
            color: #ff9800;
        }
        
        .log {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .metric {
            display: inline-block;
            background: #333;
            padding: 8px 12px;
            margin: 4px;
            border-radius: 4px;
            border-left: 3px solid #007acc;
        }
        
        .metric-value {
            font-weight: bold;
            color: #4CAF50;
        }
    </style>
    <!-- Sistema Centralizado de Logs -->
    <script src="logger.js"></script>
    <script>
        // Importar funÃ§Ãµes do logger para escopo global
        const { log, warn, error, info, debug } = window.logger;
    </script>
</head>
<body>
    <h1>ðŸ§ª Teste True Peak Pipeline</h1>
    
    <div class="test-container">
        <h2>Teste Automatizado</h2>
        <button onclick="runAutomaticTest()">ðŸš€ Executar Teste AutomÃ¡tico</button>
        <button onclick="clearLog()">ðŸ§¹ Limpar Log</button>
        
        <div id="metrics" style="margin: 15px 0;"></div>
        <div id="log" class="log"></div>
    </div>
    
    <div class="test-container">
        <h2>Teste Manual</h2>
        <input type="file" id="fileInput" accept="audio/*">
        <button onclick="uploadFile()">ðŸ“¤ Upload Manual</button>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let metricsElement = document.getElementById('metrics');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.innerHTML = '';
            metricsElement.innerHTML = '';
        }
        
        function displayMetrics(data) {
            metricsElement.innerHTML = '';
            
            if (data.technicalData) {
                const metrics = [
                    ['True Peak', `${data.technicalData.truePeakDbtp} dBTP`],
                    ['LUFS', `${data.technicalData.lufsIntegrated} LUFS`],
                    ['Dynamic Range', `${data.technicalData.dynamicRange} LU`],
                    ['Score', `${data.score}/10`]
                ];
                
                metrics.forEach(([label, value]) => {
                    const div = document.createElement('div');
                    div.className = 'metric';
                    div.innerHTML = `${label}: <span class="metric-value">${value}</span>`;
                    metricsElement.appendChild(div);
                });
            }
        }
        
        async function runAutomaticTest() {
            log('ðŸ§ª Iniciando teste automÃ¡tico...', 'info');
            
            try {
                // Criar arquivo WAV sintÃ©tico
                log('ðŸ“ Criando arquivo WAV de teste...', 'info');
                
                const sampleRate = 48000;
                const duration = 0.2; // 200ms
                const frequency = 1000; // 1kHz
                const amplitude = 0.8; // Alto para testar True Peak
                
                const length = Math.floor(sampleRate * duration);
                const samples = new Float32Array(length);
                
                // Senoidal com harmonics para gerar True Peak > Sample Peak
                for (let i = 0; i < length; i++) {
                    const t = i / sampleRate;
                    samples[i] = amplitude * (
                        Math.sin(2 * Math.PI * frequency * t) +
                        0.3 * Math.sin(2 * Math.PI * frequency * 3 * t) +
                        0.1 * Math.sin(2 * Math.PI * frequency * 5 * t)
                    );
                }
                
                // Converter para PCM 16-bit estÃ©reo
                const pcmData = new Int16Array(length * 2);
                for (let i = 0; i < length; i++) {
                    const sample = Math.max(-32768, Math.min(32767, samples[i] * 32767));
                    pcmData[i * 2] = sample;     // Left
                    pcmData[i * 2 + 1] = sample; // Right
                }
                
                // Criar header WAV
                const headerSize = 44;
                const dataSize = pcmData.length * 2;
                const fileSize = headerSize + dataSize - 8;
                
                const buffer = new ArrayBuffer(headerSize + dataSize);
                const view = new DataView(buffer);
                
                // RIFF header
                view.setUint32(0, 0x52494646, false); // "RIFF"
                view.setUint32(4, fileSize, true);
                view.setUint32(8, 0x57415645, false); // "WAVE"
                
                // fmt chunk
                view.setUint32(12, 0x666D7420, false); // "fmt "
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true); // PCM
                view.setUint16(22, 2, true); // stereo
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 4, true);
                view.setUint16(32, 4, true);
                view.setUint16(34, 16, true);
                
                // data chunk
                view.setUint32(36, 0x64617461, false); // "data"
                view.setUint32(40, dataSize, true);
                
                // Audio data
                for (let i = 0; i < pcmData.length; i++) {
                    view.setInt16(44 + i * 2, pcmData[i], true);
                }
                
                const audioBlob = new Blob([buffer], { type: 'audio/wav' });
                log(`ðŸ“ Arquivo criado: ${audioBlob.size} bytes, ${duration}s, estÃ©reo`, 'success');
                
                // Upload
                log('ðŸ“¤ Fazendo upload...', 'info');
                
                const formData = new FormData();
                formData.append('audioFile', audioBlob, 'test-truepeak.wav');
                
                const response = await fetch('/api/audio/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                log(`ðŸ“‹ Response: ${response.status} ${response.statusText}`, 'info');
                
                const result = await response.json();
                
                // AnÃ¡lise do resultado
                log(`ðŸ“Š Status: ${result.status}`, result.ok ? 'success' : 'error');
                log(`ðŸ“Š Score: ${result.score}/10`, 'info');
                
                if (result.error) {
                    log(`âŒ Erro: ${result.error}`, 'error');
                    return;
                }
                
                if (result.technicalData) {
                    log('âœ… technicalData encontrado:', 'success');
                    log(`   truePeakDbtp: ${result.technicalData.truePeakDbtp}`, 'success');
                    log(`   lufsIntegrated: ${result.technicalData.lufsIntegrated}`, 'info');
                    log(`   dynamicRange: ${result.technicalData.dynamicRange}`, 'info');
                    
                    displayMetrics(result);
                    
                    // ValidaÃ§Ã£o True Peak
                    const truePeak = parseFloat(result.technicalData.truePeakDbtp);
                    if (truePeak >= -2) { // Alto como esperado
                        log(`ðŸŽ‰ True Peak OK: ${truePeak} dBTP (alto como esperado)`, 'success');
                    } else {
                        log(`âš ï¸ True Peak baixo: ${truePeak} dBTP (pode estar incorreto)`, 'warning');
                    }
                    
                } else {
                    log('âŒ technicalData nÃ£o encontrado no resultado', 'error');
                }
                
                if (result.warnings?.length > 0) {
                    log(`âš ï¸ Warnings: ${result.warnings.join(', ')}`, 'warning');
                }
                
                // Log JSON completo (resumido)
                log('ðŸ” Resultado completo:', 'info');
                log(JSON.stringify(result, null, 2), 'info');
                
            } catch (error) {
                log(`ðŸ’¥ Erro no teste: ${error.message}`, 'error');
                error(error);
            }
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                log('âŒ Selecione um arquivo primeiro', 'error');
                return;
            }
            
            try {
                log(`ðŸ“¤ Uploading: ${file.name} (${file.size} bytes)`, 'info');
                
                const formData = new FormData();
                formData.append('audioFile', file);
                
                const response = await fetch('/api/audio/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                log(`ðŸ“‹ Status: ${response.status} - ${result.status}`, result.ok ? 'success' : 'error');
                
                if (result.technicalData) {
                    displayMetrics(result);
                    log(`âœ… True Peak: ${result.technicalData.truePeakDbtp} dBTP`, 'success');
                } else {
                    log('âŒ Sem technicalData', 'error');
                }
                
                log(JSON.stringify(result, null, 2), 'info');
                
            } catch (error) {
                log(`ðŸ’¥ Erro: ${error.message}`, 'error');
            }
        }
        
        // Auto-executar teste ao carregar
        window.addEventListener('load', () => {
            log('ðŸ”§ PÃ¡gina carregada, pronto para testes', 'info');
        });
    </script>
</body>
</html>