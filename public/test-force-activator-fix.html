<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Force Activator Fix</title>
</head>
<body>
    <h1>üéØ Teste - Corre√ß√£o Force Activator</h1>
    <p>Abra o console (F12) e observe os logs:</p>
    
    <div id="log-container">
        <h3>Logs esperados (em ordem correta):</h3>
        <ol>
            <li>‚è≥ ForceActivator adiado: sistema ainda n√£o est√° pronto.</li>
            <li>üéµ Audio Analyzer Integration carregada com sucesso!</li>
            <li>‚è≥ [READY-CHECK] Estado atual: {audioAnalyzer: true, CACHE_CTX_AWARE_V1_API: true, refsReady: false}</li>
            <li>‚è≥ [READY-CHECK] Estado atual: {audioAnalyzer: true, CACHE_CTX_AWARE_V1_API: true, refsReady: true}</li>
            <li>‚úÖ [GLOBAL] Todos os sistemas prontos. Disparando analysisReady...</li>
            <li>‚úÖ ForceActivator executado ap√≥s sistema pronto (analysisReady).</li>
        </ol>
    </div>

    <button onclick="testForceActivator()">üß™ Testar Force Activator Manual</button>
    <button onclick="console.clear()">üßπ Limpar Console</button>

    <script>
        // Simular sequ√™ncia de carregamento realista dos sistemas
        setTimeout(() => {
            log("üîß [TEST] Simulando AudioAnalyzer pronto...");
            window.audioAnalyzer = { ready: true };
        }, 1000);

        setTimeout(() => {
            log("üîß [TEST] Simulando CACHE_CTX_AWARE_V1_API pronto...");
            window.CACHE_CTX_AWARE_V1_API = { ready: true };
        }, 1500);

        setTimeout(() => {
            log("üîß [TEST] Simulando refsReady...");
            window.refsReady = true;
            // Simular fun√ß√£o applyGenreSelection que deveria existir
            window.applyGenreSelection = function(genre) {
                log("‚úÖ [TEST] applyGenreSelection chamada com:", genre);
            };
            
            // Simular o disparo do waitForRefsAndCacheBeforeReady para teste
            log("üîß [TEST] Simulando chamada de waitForRefsAndCacheBeforeReady...");
            if (window.waitForRefsAndCacheBeforeReady) {
                window.waitForRefsAndCacheBeforeReady();
            } else {
                // Simular o comportamento da fun√ß√£o se n√£o existir
                setTimeout(() => {
                    log("‚è≥ [READY-CHECK] Estado atual:", {
                        audioAnalyzer: !!window.audioAnalyzer,
                        CACHE_CTX_AWARE_V1_API: !!window.CACHE_CTX_AWARE_V1_API,
                        refsReady: !!window.refsReady
                    });
                    log("‚úÖ [GLOBAL] Todos os sistemas prontos. Disparando analysisReady...");
                    const evt = new Event("analysisReady");
                    document.dispatchEvent(evt);
                }, 100);
            }
        }, 2000);

        function testForceActivator() {
            if (window.forceUnifiedSystem) {
                log("üß™ [TEST] Testando Force Activator manual...");
                window.forceUnifiedSystem();
            } else {
                error("‚ùå [TEST] Force Activator n√£o dispon√≠vel");
            }
        }

        // Log inicial para mostrar estado
        log("üöÄ [TEST] P√°gina de teste carregada");
        log("Estado inicial dos sistemas:", {
            audioAnalyzer: !!window.audioAnalyzer,
            CACHE_CTX_AWARE_V1_API: !!window.CACHE_CTX_AWARE_V1_API,
            refsReady: !!window.refsReady
        });
    </script>

    <!-- Carregar Force Activator com defer -->
    <script src="/force-unified-activation.js?v=20250829" defer></script>
</body>
</html>