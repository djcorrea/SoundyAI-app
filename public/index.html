<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>SoundyAI - Mentor Virtual</title>
    <!-- DEPLOY_VERSION: 2026-01-21 23:30 -->
    
    <!-- âœ… Sistema Centralizado de Logs - DEVE SER O PRIMEIRO SCRIPT -->
    <script src="logger.js"></script>
    
    <!-- ğŸ”— SISTEMA DE AFILIADOS V2: Rastreamento profissional com visitorId -->
    <script type="module">
        (async function() {
            try {
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸ¯ ETAPA 1: GERAR/RECUPERAR VISITOR ID (UUID ÃšNICO)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                function generateVisitorId() {
                    // UUID v4 (RFC 4122)
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }
                
                let visitorId = localStorage.getItem('soundy_visitor_id');
                
                if (!visitorId) {
                    visitorId = generateVisitorId();
                    localStorage.setItem('soundy_visitor_id', visitorId);
                    console.log('ğŸ†” [VISITOR] Novo visitante gerado:', visitorId);
                } else {
                    console.log('ğŸ†” [VISITOR] Visitante existente:', visitorId);
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸ¯ ETAPA 2: CAPTURAR CÃ“DIGO DE PARCEIRO (?ref)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref');
                
                let partnerId = localStorage.getItem('soundy_referral_code');
                let referralTimestamp = localStorage.getItem('soundy_referral_timestamp');
                
                if (refCode && refCode.trim()) {
                    const cleanRef = refCode.trim().toLowerCase();
                    const timestamp = new Date().toISOString();
                    
                    // Atualizar localStorage
                    localStorage.setItem('soundy_referral_code', cleanRef);
                    localStorage.setItem('soundy_referral_timestamp', timestamp);
                    
                    partnerId = cleanRef;
                    referralTimestamp = timestamp;
                    
                    console.log('ğŸ”— [REFERRAL] CÃ³digo capturado:', cleanRef);
                    console.log('ğŸ• [REFERRAL] Timestamp:', timestamp);
                    
                    // Remover ?ref da URL para ficar limpo
                    const cleanUrl = window.location.protocol + '//' + 
                                     window.location.host + 
                                     window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                }
                
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // ğŸ¯ ETAPA 3: PERSISTIR VIA BACKEND (REFERRAL V3)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                if (partnerId) {
                    console.log('ğŸ’¾ [REFERRAL-V3] Enviando para backend...');
                    console.log('   visitorId:', visitorId);
                    console.log('   partnerId:', partnerId);
                    
                    try {
                        // âœ… NOVO: Chamar backend via Admin SDK (bypassa Firestore Rules)
                        const apiUrl = window.getAPIUrl ? window.getAPIUrl('/api/referral/track-visitor') : '/api/referral/track-visitor';
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                visitorId: visitorId,
                                partnerId: partnerId,
                                timestamp: referralTimestamp,
                                userAgent: navigator.userAgent,
                                referrer: document.referrer || null
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            console.log('âœ… [REFERRAL-V3] Rastreamento salvo com sucesso!');
                            console.log('   Backend response:', result.message);
                            console.log('   isNew:', result.data?.isNew);
                        } else {
                            console.warn('âš ï¸ [REFERRAL-V3] Backend retornou erro:', result.message);
                            console.warn('   Detalhes:', result.error);
                        }
                        
                    } catch (error) {
                        console.error('âŒ [REFERRAL-V3] Erro ao chamar backend:', error);
                        console.error('   Detalhes:', error.message);
                        // âš ï¸ NÃƒO bloquear carregamento da pÃ¡gina - erro silencioso
                    }
                } else {
                    console.log('â„¹ï¸ [REFERRAL-V3] Sem cÃ³digo de parceiro, nada a rastrear');
                }
                
            } catch (error) {
                console.error('âŒ [REFERRAL-V2] Erro geral:', error);
            }
        })();
    </script>
    
    <!-- ğŸŒ API URL Resolver - DEVE SER CARREGADO ANTES DE TUDO -->
    <script src="api-url-resolver.js?v=20260121"></script>
    
    <!-- ğŸ“Š Google Ads Conversion Tracking -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17884386312"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'AW-17884386312');
        
        // Debug mode: ?debug_tracking=1
        window.TRACKING_DEBUG = window.location.search.includes('debug_tracking=1');
        if (window.TRACKING_DEBUG) console.log('ğŸ¯ [TRACKING] Debug mode ativado');
    </script>
    
    <!-- ğŸ“Š Google Analytics 4 Tracking Module -->
    <script src="analytics-tracking.js" defer></script>
    
    <!-- ğŸš€ PRE-LAUNCH GATE: Sistema de prÃ©-lanÃ§amento -->
    <!-- âš ï¸ IMPORTANTE: Altere PRE_LAUNCH para false no dia do lanÃ§amento (22/01/2026) -->
    <script>
        (function() {
            // ========================================
            // ğŸ¯ FLAG DE PRÃ‰-LANÃ‡AMENTO
            // ========================================
            // Mude para FALSE no dia do lanÃ§amento
            var PRE_LAUNCH = false;
            
            // Data oficial do lanÃ§amento
            var LAUNCH_DATE = '2026-01-22T00:00:00';
            
            // ========================================
            // ğŸ” BYPASS DE ADMIN (DESENVOLVIMENTO)
            // ========================================
            // Chave secreta para bypass do prÃ©-lanÃ§amento
            // âš ï¸ REMOVER ESTE BLOCO INTEIRO NO DIA DO LANÃ‡AMENTO
            var ADMIN_BYPASS_KEY = 'soundyai-dev-2026';
            var ADMIN_STORAGE_KEY = 'soundy_admin_bypass';
            
            // Verifica parÃ¢metro na URL PRIMEIRO
            var urlParams = new URLSearchParams(window.location.search);
            var adminParam = urlParams.get('admin');
            
            // Verifica se o admin jÃ¡ estÃ¡ autenticado no localStorage
            var isAdminBypass = false;
            try {
                isAdminBypass = localStorage.getItem(ADMIN_STORAGE_KEY) === 'true';
            } catch (e) {
                // localStorage indisponÃ­vel
            }
            
            // Se o parÃ¢metro correto foi passado, ativa o bypass
            if (adminParam === ADMIN_BYPASS_KEY) {
                isAdminBypass = true; // Ativa imediatamente
                try {
                    localStorage.setItem(ADMIN_STORAGE_KEY, 'true');
                    // Remove o parÃ¢metro da URL (fica limpa)
                    urlParams.delete('admin');
                    var newUrl = window.location.pathname;
                    if (urlParams.toString()) {
                        newUrl += '?' + urlParams.toString();
                    }
                    newUrl += window.location.hash;
                    window.history.replaceState({}, '', newUrl);
                    log('%c[ADMIN] Bypass salvo com sucesso!', 'color: #22c55e; font-weight: bold;');
                } catch (e) {
                    warn('[PRE-LAUNCH] NÃ£o foi possÃ­vel salvar bypass no localStorage');
                }
            }
            
            // Se admin, pula todo o resto do gate
            if (isAdminBypass) {
                window.SOUNDY_PRE_LAUNCH = false; // Admin vÃª como se nÃ£o fosse prÃ©-lanÃ§amento
                window.SOUNDY_LAUNCH_DATE = LAUNCH_DATE;
                window.SOUNDY_ADMIN_MODE = true;
                log('%c[ADMIN] Bypass ativo - modo desenvolvimento', 'color: #8b5cf6; font-weight: bold;');
                return; // Sai do IIFE, nÃ£o redireciona
            }
            // ========================================
            // ğŸ” FIM BYPASS DE ADMIN
            // ========================================
            
            // PÃ¡ginas que NÃƒO devem ser redirecionadas (evita loop)
            var SAFE_PAGES = [
                '/prelaunch.html',
                '/lista.html',
                '/lista',
                '/prelaunch',
                '/login.html',
                '/termos.html',
                '/privacidade.html',
                '/reembolso.html',
                '/suporte.html'
            ];
            
            // Verifica se estÃ¡ em pÃ¡gina segura
            var currentPath = window.location.pathname.toLowerCase();
            var isSafePage = SAFE_PAGES.some(function(page) {
                return currentPath === page || currentPath.endsWith(page);
            });
            
            // Executa redirecionamento se PRE_LAUNCH ativo e nÃ£o estÃ¡ em pÃ¡gina segura
            if (PRE_LAUNCH && !isSafePage) {
                // Redireciona imediatamente para landing de prÃ©-lanÃ§amento
                window.location.replace('/prelaunch.html');
            }
            
            // ExpÃµe flag globalmente para debug
            window.SOUNDY_PRE_LAUNCH = PRE_LAUNCH;
            window.SOUNDY_LAUNCH_DATE = LAUNCH_DATE;
        })();
    </script>
    <!-- ğŸš€ FIM PRE-LAUNCH GATE -->
    
    <!-- ğŸš€ PERFORMANCE: Preload de recursos crÃ­ticos -->
    <link rel="preload" href="robo.webp?v=20250810" as="image" fetchpriority="high">
    <link rel="preload" href="style.css?v=20250810" as="style">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- ğŸš€ PERFORMANCE: DNS Prefetch para CDNs -->
    <link rel="dns-prefetch" href="https://soundyai-app-production.up.railway.app">
    
    <link rel="stylesheet" href="style.css?v=20250810">
    <link rel="stylesheet" href="audio-analyzer.css?v=20250810">
    <link rel="stylesheet" href="music-button-below-chat.css?v=20250810">
    <link rel="stylesheet" href="friendly-labels.css?v=20250817">
    <link rel="stylesheet" href="image-upload-styles.css?v=20241219">
    <link rel="stylesheet" href="ultra-advanced-styles.css?v=20250920-ultra">
    <link rel="stylesheet" href="ai-suggestion-styles.css?v=20250922-ai-layer">
    <link rel="stylesheet" href="ai-suggestions-expanded.css?v=20250922-expanded">
    <link rel="stylesheet" href="ai-suggestions-futuristic.css?v=20250923-cyberpunk">
    <link rel="stylesheet" href="ScoreFinal.css?v=20251021-futuristic">
    <link rel="stylesheet" href="plan-mask-styles.css?v=20251211-reduced-mode">
    <link rel="stylesheet" href="secure-render-styles.css?v=2.0.0">
    <link rel="stylesheet" href="upgrade-modal-styles.css?v=20251213">
    <link rel="stylesheet" href="login-required-modal.css?v=20260102">
    <link rel="stylesheet" href="modal-mobile-spacing.css?v=20260104">
    <link rel="stylesheet" href="analysis-history.css?v=20260104">
    
    <!-- Fontes otimizadas com display=swap para nÃ£o bloquear renderizaÃ§Ã£o -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;500;600&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bibliotecas para efeitos visuais -->
    <!-- ğŸš€ PERFORMANCE: defer para nÃ£o bloquear parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.net.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
    
    <!-- DependÃªncias para geraÃ§Ã£o de PDF - carregamento tardio pois nÃ£o sÃ£o crÃ­ticas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

    <!-- Firebase e Scripts funcionais -->
    <script type="module" src="firebase.js?v=20250810"></script>
    <script src="auth.js?v=20250810" defer></script>
    <script src="friendly-labels.js?v=20250817" defer></script>
    
    <!-- ğŸ”“ Sistema de Modo AnÃ´nimo -->
    <script src="anonymous-mode.js?v=20260102" defer></script>
    
    <!-- ï¿½ Sistema de Fingerprint Forte (Canvas + Audio + WebGL + Hardware) -->
    <script src="device-fingerprint.js?v=20260103" defer></script>
    
    <!-- ï¿½ğŸ”¥ Sistema de Demo de Venda (detecta /demo ou ?mode=demo) -->
    <!-- MÃ³dulos refatorados: Core â†’ Guards â†’ UI (ordem obrigatÃ³ria) -->
    <script src="demo-core.js?v=20260102" defer></script>
    <script src="demo-guards.js?v=20260127" defer></script>
    <script src="demo-ui.js?v=20260127" defer></script>
    
    <!-- ğŸ”¥ğŸ”¥ğŸ”¥ FORÃ‡A BRUTA: CTA Demo (garantia absoluta) -->
    <script src="demo-cta-force.js?v=20260127" defer></script>
    
    <!-- ğŸ§ª ValidaÃ§Ã£o do CTA de Primeira AnÃ¡lise (apenas dev/test) -->
    <!-- Descomentar para testar localmente -->
    <!-- <script src="demo-first-analysis-cta-validation.js?v=20260122" defer></script> -->
    
    <!-- ğŸ¯ CorreÃ§Ã£o da Ordem do Pipeline -->
    <script src="/pipeline-order-correction.js?v=20250828" defer></script>
    
    <!-- Feature Flags para AnÃ¡lise por ReferÃªncia -->
    <script>
        // ğŸ¯ Feature Flags: AnÃ¡lise por MÃºsica de ReferÃªncia
        window.FEATURE_FLAGS = {
            REFERENCE_MODE_ENABLED: true,      // Liga/desliga modo referÃªncia
            FALLBACK_TO_GENRE: true,          // Fallback automÃ¡tico em caso de erro
            DEBUG_REFERENCE_MODE: false       // Debug logs para desenvolvimento
        };
        
        // Logs mÃ­nimos para monitoramento
        window.logReferenceEvent = function(event, data = {}) {
            if (window.FEATURE_FLAGS.DEBUG_REFERENCE_MODE) {
                log(`[REFERENCE-MODE] ${event}`, data);
            }
        };
    </script>
    
    <!-- ğŸ¯ TT-DR OFICIAL - ATIVAÃ‡ÃƒO AUTOMÃTICA -->
    <script>
        // âœ… ATIVAÃ‡ÃƒO AUTOMÃTICA TT-DR OFICIAL
        log('ğŸ¯ Iniciando TT-DR Oficial - AtivaÃ§Ã£o AutomÃ¡tica...');
        
        // ğŸ¯ SISTEMA UNIFICADO STATUS/SUGESTÃƒO V1 - ATIVAÃ‡ÃƒO AUTOMÃTICA
        window.STATUS_SUGGESTION_UNIFIED_V1 = true;
        log('ğŸ¯ Sistema Unificado Status/SugestÃ£o V1 - ATIVADO');
        
        // ğŸ”§ FUNÃ‡ÃƒO DE TESTE INLINE (sempre disponÃ­vel)
        window.testarSistemaUnificado = function() {
            console.group('ğŸ§ª TESTE SISTEMA UNIFICADO');
            
            log('1ï¸âƒ£ Feature Flag:', window.STATUS_SUGGESTION_UNIFIED_V1 ? 'âœ… ATIVA' : 'âŒ INATIVA');
            log('2ï¸âƒ£ FunÃ§Ã£o Principal:', typeof window.calcularStatusSugestaoUnificado === 'function' ? 'âœ… DISPONÃVEL' : 'âŒ INDISPONÃVEL');
            
            if (window.calcularStatusSugestaoUnificado) {
                // Testes funcionais
                const casos = [
                    { valor: -14.0, alvo: -14, tolerancia: 1, esperado: 'ideal' },
                    { valor: -15.5, alvo: -14, tolerancia: 1, esperado: 'ajustar' },
                    { valor: -17.0, alvo: -14, tolerancia: 1, esperado: 'corrigir' }
                ];
                
                let todosPassaram = true;
                casos.forEach((caso, i) => {
                    const resultado = window.calcularStatusSugestaoUnificado(caso.valor, caso.alvo, caso.tolerancia, 'LUFS', 'Teste');
                    const passou = resultado.status === caso.esperado;
                    todosPassaram = todosPassaram && passou;
                    log(`${passou ? 'âœ…' : 'âŒ'} Caso ${i+1}: ${caso.valor} â†’ ${resultado.status}`);
                });
                
                log(`ğŸ¯ RESULTADO: ${todosPassaram ? 'âœ… FUNCIONANDO PERFEITAMENTE!' : 'âŒ COM PROBLEMAS'}`);
            } else {
                log('â³ Sistema ainda nÃ£o carregou. Aguarde ou recarregue a pÃ¡gina.');
            }
            
            console.groupEnd();
        };
        
        log('ğŸ’¡ Execute no console: testarSistemaUnificado()');
    </script>
    
    <!-- ğŸ¯ Sistema Unificado Status/SugestÃ£o V1 (COM DEFER para carregamento apÃ³s sistema pronto) -->
    <script src="/status-suggestion-unified-v1.js?v=20250829"></script>
    <script src="/status-migration-v1.js?v=20250829"></script>
    <script src="/force-unified-activation.js?v=20250829" defer></script>
    <script src="/auto-validator-unified.js?v=20250829" defer></script>
    
    <!-- ğŸ›¡ï¸ TONAL BALANCE SAFE V1 - Sistema seguro para bandas espectrais -->
    <script src="/tonal-balance-safe-v1.js?v=20250829"></script>
    <script src="/auto-validator-tonal-safe.js?v=20250829" defer></script>
    
    <!-- ğŸ“‹ Estilos do BotÃ£o Plano de CorreÃ§Ã£o -->
    <style>
        .correction-plan-btn {
            display: inline-flex !important;
            align-items: center !important;
            gap: 8px !important;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%) !important;
            color: white !important;
            border: none !important;
            padding: 12px 20px !important;
            border-radius: 10px !important;
            font-size: 0.95rem !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3) !important;
        }
        .correction-plan-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4) !important;
        }
        .correction-plan-btn:disabled {
            opacity: 0.6 !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
        .correction-plan-btn .cta-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: ctaSpin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes ctaSpin {
            to { transform: rotate(360deg); }
        }
        .correction-plan-error {
            width: 100%;
            color: #ef4444;
            font-size: 0.8rem;
            text-align: center;
            margin-top: 8px;
            padding: 8px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
        }
        @media (max-width: 640px) {
            .correction-plan-btn {
                width: 100% !important;
                justify-content: center !important;
            }
        }
        
        /* ğŸš« Ocultar botÃ£o no modo referÃªncia */
        body[data-analysis-mode="reference"] #btnGenerateCorrectionPlan,
        .reference-mode-active #btnGenerateCorrectionPlan {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
    </style>
    
    <!-- ğŸ“‹ Handler Global para Plano de CorreÃ§Ã£o -->
    <script>
        function handleCorrectionPlanClick() {
            log('[CORRECTION-PLAN] ğŸ–±ï¸ handleCorrectionPlanClick() chamada via onclick');
            
            // Tentar chamar a funÃ§Ã£o do audio-analyzer-integration.js
            if (typeof window.handleGenerateCorrectionPlan === 'function') {
                log('[CORRECTION-PLAN] âœ… Delegando para window.handleGenerateCorrectionPlan');
                window.handleGenerateCorrectionPlan();
            } else {
                error('[CORRECTION-PLAN] âŒ window.handleGenerateCorrectionPlan nÃ£o encontrada!');
                alert('Erro: Sistema de Plano de CorreÃ§Ã£o ainda nÃ£o carregou. Aguarde alguns segundos e tente novamente.');
            }
        }
        
        // Expor globalmente
        window.handleCorrectionPlanClick = handleCorrectionPlanClick;
        log('[CORRECTION-PLAN] ğŸŒ handleCorrectionPlanClick exposta no window');
    </script>
</head>
<body class="page-index">
    <!-- Menu HambÃºrguer - Canto Superior Esquerdo -->
    <button class="hamburger-menu-btn" id="hamburgerMenuBtn" aria-label="Abrir menu de atalhos">
        <span class="hamburger-bar"></span>
        <span class="hamburger-bar"></span>
        <span class="hamburger-bar"></span>
    </button>

    <!-- Painel Lateral de Atalhos -->
    <div class="side-panel-overlay" id="sidePanelOverlay"></div>
    <nav class="side-panel" id="sidePanel" aria-label="Menu de atalhos">
        <div class="side-panel-header">
            <span class="side-panel-title">Menu</span>
            <button class="side-panel-close" id="sidePanelClose" aria-label="Fechar menu">&times;</button>
        </div>
        <ul class="side-panel-menu">
            <li>
                <button class="side-panel-item side-panel-item-highlight" data-action="analyze">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18V5l12-2v13"/>
                        <circle cx="6" cy="18" r="3"/>
                        <circle cx="18" cy="16" r="3"/>
                    </svg>
                    <span>Analisar Ã¡udio</span>
                </button>
            </li>
            <li>
                <button class="side-panel-item" data-action="docs">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <span>Documento tÃ©cnico</span>
                </button>
            </li>
            <!-- ğŸ• HISTÃ“RICO DE ANÃLISES - PRO e STUDIO -->
            <li id="historyMenuItem" class="history-menu-item" style="display: none;">
                <button class="side-panel-item" data-action="history">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span>HistÃ³rico</span>
                    <span class="pro-badge" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; margin-left: auto; font-weight: 600;">PRO</span>
                </button>
            </li>
            <li>
                <button class="side-panel-item" data-action="upgrade">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    <span>Upgrade de plano</span>
                </button>
            </li>
            <li>
                <button class="side-panel-item" data-action="manage">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span>Gerenciar conta</span>
                </button>
            </li>
            <li>
                <button class="side-panel-item side-panel-item-logout" data-action="logout">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    <span>Sair</span>
                </button>
            </li>
        </ul>
        <div class="side-panel-footer">
            <span class="side-panel-version">SoundyAI v1</span>
        </div>
    </nav>

    <!-- Fundo animado 3D -->
    <div class="cenario">
        <!-- Container para o fundo animado Vanta.js -->
        <div class="vanta-background" id="vanta-bg"></div>
        
        <!-- ğŸš€ PERFORMANCE: Fundo com lazy loading (baixa prioridade) -->
        <img src="fundo.webp?v=20250810" alt="Fundo futurista" class="fundo" loading="lazy" decoding="async" />

        <!-- ğŸš€ PERFORMANCE: Imagens otimizadas com decoding async -->
        <!-- RobÃ´ Ã© LCP element - carregamento eager + fetchpriority high via preload -->
    <img src="robo.webp?v=20250810" alt="RobÃ´ futurista" class="robo fade-in-start" loading="eager" decoding="async" fetchpriority="high" />
    <img src="mesa.webp?v=20250810" alt="Mesa" class="mesa fade-in-start" loading="lazy" decoding="async" />
    <img src="caixas.webp?v=20250810" alt="Caixas de som principais" class="caixas fade-in-start" loading="lazy" decoding="async" />
    <img src="notebook.webp?v=20250810" alt="Notebook" class="notebook fade-in-start" loading="lazy" decoding="async" />
    <img src="teclado.webp?v=20250810" alt="teclado" class="teclado fade-in-start" loading="lazy" decoding="async" />
        
        <!-- Overlay de partÃ­culas - renderizaÃ§Ã£o otimizada via CSS -->
        <div class="particles-overlay fade-in-start"></div>
    </div>

    <!-- Chatbot posicionado no monitor -->
    <div class="chatbot-container" id="chatbotContainer">
        <!-- Estado Inicial (Welcome) -->
        <div class="chatbot-welcome-state" id="chatbotWelcomeState">
            <div class="chatbot-robot-wrapper">
                <img src="robo 2.webp?v=20250810" alt="SoundyAI Robot" class="chatbot-main-robot" id="chatbotMainRobot">
            </div>
            
            <div class="chatbot-branding" id="chatbotBranding">
                <h1 class="chatbot-main-title" id="chatbotMainTitle">SoundyAI</h1>
                <p class="chatbot-main-subtitle" id="chatbotMainSubtitle">Seu engenheiro de Ã¡udio virtual</p>
            </div>
            
            <div class="chatbot-input-section" id="chatbotInputSection">
                <div class="chatbot-input-field chat-input-container">
                    <button
                      class="chatbot-add-btn chat-plus-btn"
                      aria-label="Adicionar"
                      type="button"
                      style="all:unset;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;margin:0 8px 0 10px;cursor:pointer;border-radius:6px;background:transparent;"
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                           xmlns="http://www.w3.org/2000/svg"
                           style="display:block;stroke:#fff;stroke-width:2">
                        <path d="M12 5v14M5 12h14" />
                      </svg>
                    </button>
                    <input type="text" 
                           class="chatbot-main-input chat-text-input" 
                           id="chatbotMainInput" 
                           placeholder="Digite aqui..."
                           maxlength="500">
                    <svg class="chatbot-mic-icon chat-mic-btn" width="20" height="20" viewBox="0 0 384 512" fill="currentColor">
                        <path d="M192 0C139 0 96 43 96 96v160c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464h-48c-13.3 0-24 10.7-24 24s10.7 24 24 24h144c13.3 0 24-10.7 24-24s-10.7-24-24-24h-48v-33.6c85.8-11.7 152-85.3 152-174.4v-40c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/>
                    </svg>
                    <button class="chatbot-send-button chat-send-btn" id="chatbotSendButton">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="white" stroke="none"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Estado Ativo (Chat) -->
        <div class="chatbot-active-state" id="chatbotActiveState">
            <div class="chatbot-header-bar" id="chatbotHeaderBar">
                <div class="chatbot-header-centered">
                    <div class="chatbot-header-text">
                        <span class="chatbot-header-name">SoundyAI</span>
                        <span class="chatbot-header-desc">Seu engenheiro de Ã¡udio virtual</span>
                    </div>
                </div>
            </div>
            
            <div class="chatbot-conversation-area" id="chatbotConversationArea">
                <!-- As mensagens serÃ£o inseridas aqui dinamicamente -->
            </div>
            
            <div class="chatbot-input-area">
                <div class="chatbot-typing-indicator" id="chatbotTypingIndicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
          <div class="chatbot-active-input-field chat-input-container">
              <button
                class="chatbot-add-btn chat-plus-btn"
                aria-label="Adicionar"
                type="button"
                style="all:unset;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;margin:0 8px 0 10px;cursor:pointer;border-radius:6px;background:transparent;"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                     xmlns="http://www.w3.org/2000/svg"
                     style="display:block;stroke:#fff;stroke-width:2">
                  <path d="M12 5v14M5 12h14" />
                </svg>
              </button>
                    <input type="text" 
                  class="chatbot-active-input chat-text-input" 
                           id="chatbotActiveInput" 
                           placeholder="Digite sua mensagem..."
                           maxlength="500">
              <svg class="chatbot-mic-icon chat-mic-btn" width="20" height="20" viewBox="0 0 384 512" fill="currentColor">
                        <path d="M192 0C139 0 96 43 96 96v160c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464h-48c-13.3 0-24 10.7-24 24s10.7 24 24 24h144c13.3 0 24-10.7 24-24s-10.7-24-24-24h-48v-33.6c85.8-11.7 152-85.3 152-174.4v-40c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/>
                    </svg>
              <button class="chatbot-active-send-btn chat-send-btn" id="chatbotActiveSendBtn">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
                            <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="white" stroke="none"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- BotÃµes de aÃ§Ã£o do chatbot -->
    <div class="chatbot-action-buttons">
        <button class="chatbot-action-btn btn-analyze-highlight" data-action="analyze">
            <span>AnÃ¡lise de Ã¡udio</span>
        </button>
        <button class="chatbot-action-btn" data-action="upgrade">
            <span>Upgrade de plano</span>
        </button>
        <button class="chatbot-action-btn" data-action="manage">
            <span>Gerenciar conta</span>
        </button>
        <button class="chatbot-action-btn" data-action="logout">
            <span>Sair</span>
        </button>
    </div>

    <!-- ï¿½ MODAL DE SELEÃ‡ÃƒO DE MODO (NOVO) -->
    <div id="analysisModeModal" class="audio-modal" style="display: none;">
        <div class="audio-modal-content mode-selection-modal">
            <div class="audio-modal-header">
                <h2 class="analysis-modal-title">
                    <span>COMO DESEJA</span><br>
                    <span>ANALISAR SUA MÃšSICA?</span>
                </h2>
                <button class="audio-modal-close" onclick="closeModeSelectionModal()">&times;</button>
            </div>
            
            <div class="mode-selection-container">
                <div class="mode-selection-description">
                    <p>Escolha o tipo de anÃ¡lise que melhor se adequa Ã s suas necessidades:</p>
                </div>
                
                <div class="mode-selection-options">
                    <!-- OpÃ§Ã£o: AnÃ¡lise por GÃªnero (atual) -->
                    <button class="mode-option-btn" id="genreModeBtn" onclick="selectAnalysisMode('genre')">
                        <div class="mode-option-left">
                            <svg class="icon-phones" width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
                                <path fill="currentColor" d="M12 3a7 7 0 0 0-7 7v6a3 3 0 0 0 3 3h1a1 1 0 0 0 1-1v-6a1 1 0 0 0-1-1H6v-1a6 6 0 1 1 12 0v1h-3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h1a3 3 0 0 0 3-3V10a7 7 0 0 0-7-7Z"/>
                            </svg>
                            <div class="mode-option-content">
                                <h4>Por GÃªnero Musical</h4>
                                <p>Compare sua mÃºsica com padrÃµes profissionais do gÃªnero selecionado</p>
                                <span class="mode-option-badge">Recomendado</span>
                            </div>
                        </div>
                        <div class="mode-option-right">â†’</div>
                    </button>
                    
                    <!-- OpÃ§Ã£o: AnÃ¡lise por ReferÃªncia (novo) -->
                    <button class="mode-option-btn" id="referenceModeBtn" onclick="selectAnalysisMode('reference')" 
                            style="display: none;">
                        <div class="mode-option-left">
                            <div class="mode-option-icon">ğŸ¯</div>
                            <div class="mode-option-content">
                                <h4>Por MÃºsica de ReferÃªncia</h4>
                                <p>Compare sua mÃºsica diretamente com uma faixa de referÃªncia especÃ­fica</p>
                                <span class="mode-option-badge new">Novo</span>
                            </div>
                        </div>
                        <div class="mode-option-right">â†’</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸŒŸ MODAL DE BOAS-VINDAS Ã€ ANÃLISE -->
    <div id="welcomeAnalysisModal" class="audio-modal" style="display: none;">
        <div class="audio-modal-content welcome-modal-content">
            <div class="audio-modal-header">
                <h2 class="analysis-modal-title">
                    <span>BEM-VINDO Ã€</span><br>
                    <span>ANÃLISE DE MÃšSICA</span>
                </h2>
                <button class="audio-modal-close" onclick="closeWelcomeModal()">&times;</button>
            </div>
            
            <div class="welcome-modal-body">
                <p class="welcome-subtitle">
                    Envie seu Ã¡udio e receba mÃ©tricas tÃ©cnicas claras para melhorar sua mix/master.
                </p>
                
                <div class="welcome-description">
                    <p>
                        <strong>AnÃ¡lise completa de True Peak, LUFS, DinÃ¢mica, FrequÃªncias e muito mais.</strong>
                    </p>
                    <p>
                        Nosso sistema compara seu Ã¡udio com referÃªncias do gÃªnero escolhido e fornece 
                        sugestÃµes personalizadas para vocÃª alcanÃ§ar o padrÃ£o profissional.
                    </p>
                </div>
                
                <div class="welcome-tip">
                    <span class="tip-icon">ğŸ’¡</span>
                    <p>
                        Para tirar o mÃ¡ximo da anÃ¡lise, <strong>siga um passo a passo antes e depois de enviar.</strong> A ordem certa das correÃ§Ãµes evita retrabalho e acelera sua evoluÃ§Ã£o
                    </p>
                </div>
                
                <div class="welcome-actions">
                    <button class="welcome-btn primary" onclick="openTechnicalGuide()">
                        ğŸ“– Abrir Guia TÃ©cnico
                    </button>
                    <button class="welcome-btn secondary" onclick="proceedToAnalysis()">
                        â–¶ï¸ Continuar para AnÃ¡lise
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ§ MODAL DE ENCERRAMENTO DO BETA DJS -->
    <div id="betaDjExpiredModal" class="audio-modal" style="display: none;">
        <div class="audio-modal-content welcome-modal-content" style="max-width: 650px;">
            <div class="audio-modal-header">
                <h2 class="analysis-modal-title" style="text-align: center; line-height: 1.4;">
                    <span style="font-size: 2rem;">ğŸ§</span><br>
                    <span>OBRIGADO POR FAZER PARTE</span><br>
                    <span>DO BETA DA SOUNDYAI</span>
                </h2>
                <button class="audio-modal-close" onclick="closeBetaExpiredModal()">&times;</button>
            </div>
            
            <div class="welcome-modal-body" style="padding: 24px;">
                <p style="font-size: 1rem; line-height: 1.7; margin-bottom: 20px; text-align: center;">
                    Seu perÃ­odo de acesso antecipado chegou ao fim, e o seu feedback foi â€” e continua sendo â€” 
                    <strong>extremamente importante</strong> pra evoluÃ§Ã£o da plataforma.
                </p>
                
                <div class="welcome-description" style="text-align: center;">
                    <p style="font-size: 0.95rem; line-height: 1.6; margin-bottom: 16px;">
                        A SoundyAI estÃ¡ sendo construÃ­da junto com <strong>DJs e produtores</strong> que 
                        realmente vivem a mÃºsica, e sua participaÃ§Ã£o fez parte disso.
                    </p>
                    <p style="font-size: 0.95rem; line-height: 1.6; margin-bottom: 16px;">
                        Em breve, entraremos em contato para conversar sobre feedbacks, prÃ³ximos passos 
                        e <strong>possÃ­veis parcerias</strong>.
                    </p>
                </div>
                
                <div class="welcome-tip" style="background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; padding: 16px; margin: 24px 0;">
                    <span class="tip-icon" style="font-size: 1.5rem;">ğŸ™</span>
                    <p style="font-size: 0.9rem; line-height: 1.6; margin: 8px 0 0 0;">
                        <strong>Obrigado por fortalecer a SoundyAI desde o comeÃ§o.</strong><br>
                        Sua contribuiÃ§Ã£o foi essencial para chegarmos atÃ© aqui.
                    </p>
                </div>
                
                <div class="welcome-actions" style="display: flex; gap: 12px; justify-content: center; margin-top: 28px;">
                    <button class="welcome-btn secondary" onclick="closeBetaExpiredModal()" style="min-width: 140px;">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="audioAnalysisModal" class="audio-modal" style="display: none;">
        <div class="audio-modal-content">
            <div class="audio-modal-header" style="display: none;">
                <h3 id="audioModalTitle">ğŸµ AnÃ¡lise de Ãudio</h3>
                <div id="audioModalSubtitle" class="audio-modal-subtitle" style="display: none;">
                    <span id="audioModeIndicator"></span>
                </div>
                <button class="audio-modal-close" onclick="closeAudioModal()">&times;</button>
            </div>
            
            <!-- SeleÃ§Ã£o de GÃªnero de ReferÃªncia (apenas para modo gÃªnero) -->
            <div id="audioRefGenreContainer" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:4px 4px 10px 4px;">
                <label for="audioRefGenreSelect" style="font-size:12px;opacity:.8;">GÃªnero de ReferÃªncia:</label>
                <select id="audioRefGenreSelect" style="background:#0e1422;color:#fff;border:1px solid #1f2b40;padding:4px 8px;border-radius:6px;font-size:12px;outline:none;">
                    <option value="progressive_trance">Progressive Trance</option>
                    <option value="funk_mandela">Funk Mandela</option>
                    <option value="funk_bruxaria">Funk Bruxaria</option>
                    <option value="edm">EDM</option>
                    <option value="funk_bh">Funk BH</option>
                    <option value="eletronico">EletrÃ´nico</option>
                </select>
                <span id="audioRefStatus" style="font-size:11px;padding:2px 6px;border-radius:4px;background:#1f2b40;opacity:.9;">Carregando referÃªncias...</span>
            </div>
            
            <!-- Progress Steps para Modo ReferÃªncia -->
            <div id="referenceProgressSteps" class="reference-progress-steps" style="display: none;">
                <div class="progress-step" id="stepUserAudio">
                    <div class="step-number">1</div>
                    <div class="step-label">Sua MÃºsica</div>
                </div>
                <div class="progress-step" id="stepReferenceAudio">
                    <div class="step-number">2</div>
                    <div class="step-label">MÃºsica de ReferÃªncia</div>
                </div>
                <div class="progress-step" id="stepAnalysis">
                    <div class="step-number">3</div>
                    <div class="step-label">AnÃ¡lise Comparativa</div>
                </div>
            </div>
            
            <!-- Upload Area -->
            <div class="audio-upload-area" id="audioUploadArea">
                <div class="upload-content">
                    <div class="upload-icon">ğŸµ</div>
                    <h4>Analisar seu Ã¡udio</h4>
                    <p>Arraste seu arquivo aqui ou clique para selecionar</p>
                    <p class="supported-formats">Suporta: WAV, FLAC, MP3 (mÃ¡x. 150MB)</p>
                    <p class="format-recommendation">ğŸ’¡ Prefira WAV ou FLAC para maior precisÃ£o na anÃ¡lise</p>
                    <input type="file" id="modalAudioFileInput" 
                           accept="audio/wav,audio/flac,audio/mp3,audio/mpeg,.wav,.flac,.mp3" 
                           style="position:absolute;left:-9999px;opacity:0;width:1px;height:1px;" tabindex="-1">
                    <label for="modalAudioFileInput" class="upload-btn">
                        Escolher Arquivo
                    </label>
                </div>
                <button class="audio-close-bottom" onclick="closeAudioModal()">Fechar</button>
            </div>

            <!-- Loading -->
            <div id="audioAnalysisLoading" class="audio-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p id="audioProgressText">ğŸš€ Inicializando Sistema de AnÃ¡lise...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="audioProgressFill"></div>
                </div>
                
                <!-- Aviso de conexÃ£o (aparece primeiro durante upload) -->
                <p id="audioConnectionHint" class="connection-hint" style="display: none;">
                    <span class="hint-icon">â³</span>
                    <span class="hint-text">Esta etapa depende da sua conexÃ£o com a internet.<br>Se sua internet estiver lenta, o envio pode demorar um pouco mais.</span>
                </p>
                
                <!-- Aviso importante durante anÃ¡lise (sempre visÃ­vel durante loading) -->
                <div class="audio-analysis-warning">
                    <div class="warning-icon">âš™ï¸</div>
                    <div class="warning-content">
                        <p class="warning-title">AnÃ¡lise em andamento</p>
                        <p class="warning-text">Para garantir que o processo seja concluÃ­do corretamente, mantenha esta pÃ¡gina aberta atÃ© o fim da anÃ¡lise.</p>
                        <p class="warning-subtext">Isso normalmente leva apenas alguns instantes.</p>
                    </div>
                </div>
                
                <button class="audio-close-bottom" onclick="closeAudioModal()">Fechar</button>
            </div>

            <!-- Results -->
            <div id="audioAnalysisResults" class="audio-results" style="display: none;">
                <div class="results-header">
                    <h4>AnÃ¡lise Completa</h4>
                </div>
                
                <div class="analysis-info-text">
                    As mÃ©tricas e sugestÃµes sÃ£o baseadas em ciÃªncia de Ã¡udio e referÃªncias reais do gÃªnero.<br>
                    PorÃ©m, mÃºsica Ã© arte: cada produtor pode querer caracterÃ­sticas diferentes.<br>
                    Use estas dicas como um guia de referÃªncia, nÃ£o como uma regra absoluta.
                </div>
                
                <!-- ğŸµ BLOCO DE IDENTIFICAÃ‡ÃƒO DA MÃšSICA (REPOSICIONADO) -->
                <div id="musicIdentificationBlock" class="music-identification-container">
                    <!-- SerÃ¡ preenchido dinamicamente via JavaScript -->
                </div>
                
                <!-- ğŸ¯ SCORE FINAL NO TOPO - DISPLAY FUTURISTA -->
                <div id="final-score-display"></div>
                
                <div class="technical-data" id="modalTechnicalData">
                    <!-- Dados tÃ©cnicos serÃ£o inseridos aqui -->
                </div>
                <div id="referenceComparisons" style="margin-top:16px;"></div>
                
                <!-- ğŸš€ NOVA SEÃ‡ÃƒO: Modal Expansivo de SugestÃµes IA integrado -->
                <div id="aiSuggestionsExpanded" class="ai-suggestions-expanded" style="display: none;">
                    <div class="ai-expanded-header">
                        <div class="ai-header-left">
                            <h3>ğŸš€ AnÃ¡lise Inteligente & SugestÃµes</h3>
                            <div class="ai-header-subtitle">Powered by AI â€¢ SugestÃµes educativas e prÃ¡ticas</div>
                        </div>
                        <div class="ai-header-right">
                            <div class="ai-status-indicator" id="aiExpandedStatus">
                                <span class="ai-status-dot"></span>
                                <span class="ai-status-text">Analisando...</span>
                            </div>
                            <button class="ai-expanded-toggle" onclick="toggleAIExpanded()">
                                <span id="aiExpandedToggleIcon">â†—</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="ai-expanded-content" id="aiExpandedContent">
                        <div class="ai-suggestions-loading" id="aiExpandedLoading">
                            <div class="ai-loading-spinner"></div>
                            <p>Conectando com sistema de IA...</p>
                        </div>
                        
                        <div class="ai-suggestions-grid" id="aiExpandedGrid" style="display: none;">
                            <!-- Grid de sugestÃµes serÃ¡ inserido aqui -->
                        </div>
                        
                        <div class="ai-fallback-notice" id="aiFallbackNotice" style="display: none;">
                            <div class="ai-fallback-icon">âš ï¸</div>
                            <div class="ai-fallback-content">
                                <strong>IA temporariamente indisponÃ­vel</strong>
                                <p>Exibindo sugestÃµes bÃ¡sicas do sistema. A funcionalidade completa serÃ¡ restaurada em breve.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ai-expanded-footer">
                    </div>
                </div>

                <div class="analysis-helper-text" id="aiHelperText">
                    ğŸ’¡ Se precisar de ajuda para aplicar as melhorias, clique em <strong>"Pedir ajuda Ã  IA"</strong> e seja redirecionado para um Chat Bot especialista em Ã¡udio.
                </div>

                <div class="analysis-actions">
                    <button class="action-btn primary" id="btnAskAI" onclick="sendModalAnalysisToChat()">
                        ğŸ¤– Pedir Ajuda Ã  IA
                    </button>
                    <button class="action-btn secondary" onclick="downloadModalAnalysis()">
                        ğŸ“„ Baixar RelatÃ³rio
                    </button>
                    <button class="action-btn correction-plan-btn" id="btnGenerateCorrectionPlan" onclick="handleCorrectionPlanClick()">
                        ğŸ“‹ Gerar Plano de CorreÃ§Ã£o
                    </button>
                </div>
                
            </div>
        </div>
    </div>

    <!-- ï¿½ NOVO MODAL DE SELEÃ‡ÃƒO DE GÃŠNERO MUSICAL -->
    <div id="newGenreModal" class="genre-modal hidden" aria-modal="true" role="dialog">
        <div class="genre-modal-container">
            <h2 class="genre-modal-title">
                <span>ESCOLHA</span><br>
                <span>O GÃŠNERO</span>
            </h2>
            <p class="genre-modal-subtitle">Selecione um gÃªnero para continuar</p>

            <div class="genre-grid">
                <button class="genre-card" data-genre="funk_mandela">
                    <span class="genre-icon">ğŸ”¥</span>
                    <span class="genre-name">Funk Mandela</span>
                </button>
                <button class="genre-card" data-genre="edm">
                    <span class="genre-icon">ğŸµ</span>
                    <span class="genre-name">EDM</span>
                </button>
                <button class="genre-card" data-genre="funk_bh">
                    <span class="genre-icon">â›°ï¸</span>
                    <span class="genre-name">Funk BH</span>
                </button>
                <button class="genre-card" data-genre="funk_bruxaria">
                    <span class="genre-icon">ğŸ”®</span>
                    <span class="genre-name">Funk Bruxaria</span>
                </button>
                <button class="genre-card" data-genre="eletrofunk">
                    <span class="genre-icon">ğŸ›ï¸</span>
                    <span class="genre-name">Eletrofunk</span>
                </button>
                <button class="genre-card" data-genre="progressive_trance">
                    <span class="genre-icon">ğŸŒŠ</span>
                    <span class="genre-name">Progressive Trance</span>
                </button>
                <button class="genre-card" data-genre="trap">
                    <span class="genre-icon">ğŸ’</span>
                    <span class="genre-name">Trap</span>
                </button>
                <button class="genre-card" data-genre="tech_house">
                    <span class="genre-icon">ğŸ </span>
                    <span class="genre-name">Tech House</span>
                </button>
                <button class="genre-card" data-genre="fullon">
                    <span class="genre-icon">ğŸ¤–</span>
                    <span class="genre-name">Fullon</span>
                </button>
                <button class="genre-card" data-genre="house">
                    <span class="genre-icon">ğŸ§</span>
                    <span class="genre-name">House</span>
                </button>
                <button class="genre-card" data-genre="brazilian_phonk">
                    <span class="genre-icon">ğŸ‡§ğŸ‡·</span>
                    <span class="genre-name">Brazilian Phonk</span>
                </button>
                <button class="genre-card" data-genre="rap_drill">
                    <span class="genre-icon">ğŸ¤</span>
                    <span class="genre-name">Rap / Drill</span>
                </button>
            </div>

            <button class="genre-modal-close" data-close>Fechar</button>
        </div>
    </div>

    <!-- ï¿½ğŸŒŸ MODAL GLASSMORPHISM EXPANDIDO - SugestÃµes IA em Tela Cheia -->
    <div id="aiSuggestionsFullModal" class="ai-full-modal glassmorphism" style="display: none;">
        <div class="ai-full-modal-backdrop" onclick="closeAIFullModal()"></div>
        <div class="ai-full-modal-container">
            <div class="ai-full-modal-header">
                <div class="ai-modal-title">
                    <h2>ğŸš€ SugestÃµes Inteligentes</h2>
                    <div class="ai-modal-subtitle">AnÃ¡lise detalhada com IA para otimizaÃ§Ã£o profissional</div>
                </div>
                <button class="ai-modal-close" onclick="closeAIFullModal()">
                    <span>Ã—</span>
                </button>
            </div>
            
            <div class="ai-full-modal-content" id="aiFullModalContent">
                <div class="ai-suggestions-grid">
                    <!-- Grid de sugestÃµes serÃ¡ inserido aqui -->
                </div>
            </div>
            
            <div class="ai-full-modal-footer">
                <div class="ai-stats-container">
                    <div class="ai-stat-item">
                        <span class="ai-stat-label">SugestÃµes:</span>
                        <span class="ai-stat-value" id="aiStatsCount">0</span>
                    </div>
                    <div class="ai-stat-item">
                        <span class="ai-stat-label">Modelo:</span>
                        <span class="ai-stat-value" id="aiStatsModel">GPT-3.5</span>
                    </div>
                    <div class="ai-stat-item">
                        <span class="ai-stat-label">Tempo:</span>
                        <span class="ai-stat-value" id="aiStatsTime">--</span>
                    </div>
                </div>
                
                <div class="ai-modal-actions">
                    <button class="action-btn secondary" onclick="downloadAISuggestions()">
                        ğŸ“„ Baixar SugestÃµes IA
                    </button>
                    <button class="action-btn primary" onclick="sendAISuggestionsToChat()">
                        ğŸ’¬ Discutir com IA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ¯ ERROR MAPPER - Sistema centralizado de mensagens de erro amigÃ¡veis -->
    <script src="error-mapper.js?v=1.0.0"></script>
    
    <!-- Script integrado com as funcionalidades existentes -->
    <!-- Otimizado: Removido cache busting desnecessÃ¡rio para melhor cache -->
    <script src="script.js?v=20250813-1" defer></script>
    
    <!-- ğŸ¤ VOICE MESSAGE SIMPLE - PROD.AI -->
    <script src="voice-clean.js?v=20250810" defer></script>
    
    <!-- ğŸ§ª DEBUG FASE 1 - Sistema runId Global -->
    
    <!-- ğŸµ AUDIO ANALYZER - Carregar os scripts -->
    <script src="audio-analyzer.js?v=20250825-memory-fix" defer></script>
    <!-- ğŸ¯ CACHE CONTEXT-AWARE V1 - Sistema inteligente de cache -->
    <script src="cache-context-aware-v1.js?v=20250829-ctx-aware" defer></script>
    <!-- Opcional: o integrador possui fallback inline; permita rede setando window.REFS_ALLOW_NETWORK=true antes do load -->
    <script src="refs/embedded-refs-new.js?v=20250829-true-peak-fix&timestamp=1756500921" defer></script>
    
    <!-- ğŸ¯ SISTEMA DE SUGESTÃ•ES MELHORADO - DEPENDÃŠNCIAS ESSENCIAIS -->
    <script src="suggestion-scorer.js?v=20250920-enhanced" defer></script>
    <script src="enhanced-suggestion-engine.js?v=20250920-enhanced" defer></script>
    
    <!-- ğŸš€ SISTEMA ULTRA-AVANÃ‡ADO DE SUGESTÃ•ES EDUCACIONAIS -->
    <script src="advanced-educational-suggestion-system.js?v=20250920-ultra" defer></script>
    
    <!-- ğŸš€ SISTEMA ULTRA-AVANÃ‡ADO V2 - IntegraÃ§Ã£o Direta -->
    <script src="ultra-advanced-suggestion-enhancer-v2.js?v=20250920-ultra-v2" defer></script>
    
    <!-- ğŸ” VALIDADOR DE INTEGRAÃ‡ÃƒO DO SISTEMA ULTRA-AVANÃ‡ADO -->
    <script src="validador-integracao-ultra-avancado.js?v=20250920-validator" defer></script>
    
    <!-- ğŸ¯ MONITOR MODAL - Detecta e valida sistema ultra-avanÃ§ado durante anÃ¡lises -->
    <script src="monitor-modal-ultra-avancado.js?v=20250920-monitor" defer></script>
    
    <script src="suggestion-text-generator.js?v=20250815" defer></script>
    <!-- ğŸš¨ SISTEMA DE EMERGÃŠNCIA - SUGESTÃ•ES FUNCIONAIS -->
    <script src="suggestion-system-emergency.js?v=emergency-20250920" defer></script>
    
    <!-- ğŸ¤– NOVA CAMADA DE IA - Sistema Inteligente de SugestÃµes -->
    <script src="ai-suggestion-layer.js?v=20250922-ai-layer" defer></script>
    <script src="ai-configuration-manager.js?v=20250922-config" defer></script>
    <script src="ai-suggestion-ui-controller.js?v=20250922-ui" defer></script>
    <script src="ai-suggestions-integration.js?v=20250922-integration" defer></script>
    <script src="ai-suggestion-system-tester.js?v=20250922-test" defer></script>
    <script src="ai-force-test.js?v=20250922-force" defer></script>
    <script src="ai-auto-config.js?v=20250922-autoconfig" defer></script>
    <script src="secure-api-loader.js?v=20250922-secure" defer></script>
    
    <!-- ğŸ¯ ATIVAÃ‡ÃƒO FORÃ‡ADA DO SISTEMA NOVO -->
    <script>
        // ForÃ§a ativaÃ§Ã£o do sistema novo assim que carregar
        window.addEventListener('DOMContentLoaded', function() {
            log('ğŸ¯ [INDEX] ForÃ§ando ativaÃ§Ã£o do sistema novo...');
            
            let attempts = 0;
            const maxAttempts = 100; // Aumentado para 10 segundos
            
            const forceActivate = () => {
                attempts++;
                log(`ğŸ¯ [INDEX] Tentativa ${attempts} de ativaÃ§Ã£o...`);
                
                if (window.suggestionSystem && typeof window.suggestionSystem.process === 'function') {
                    window.USE_UNIFIED_SUGGESTIONS = true;
                    log('ğŸ¯ [INDEX] âœ… SISTEMA NOVO ATIVADO COM SUCESSO!');
                    log('ğŸ¯ [INDEX] window.suggestionSystem:', typeof window.suggestionSystem);
                    log('ğŸ¯ [INDEX] window.suggestionSystem.process:', typeof window.suggestionSystem.process);
                    log('ğŸ¯ [INDEX] window.USE_UNIFIED_SUGGESTIONS:', window.USE_UNIFIED_SUGGESTIONS);
                    
                    // ğŸš¨ CRITICAL: Marcar que o sistema estÃ¡ pronto para evitar race conditions
                    window.__SUGGESTION_SYSTEM_READY = true;
                    log('ğŸ¯ [INDEX] Sistema marcado como pronto para uso');
                    
                } else if (attempts < maxAttempts) {
                    setTimeout(forceActivate, 100);
                } else {
                    error('ğŸ¯ [INDEX] âŒ FALHA: Sistema nÃ£o carregou apÃ³s 10 segundos');
                    error('ğŸ¯ [INDEX] window.suggestionSystem:', typeof window.suggestionSystem);
                    error('ğŸ¯ [INDEX] window.SuggestionSystemUnified:', typeof window.SuggestionSystemUnified);
                    
                    // Tentar carregar sistema de emergÃªncia manualmente
                    if (typeof window.SuggestionSystemUnified === 'function') {
                        log('ğŸ¯ [INDEX] Tentando ativar sistema de emergÃªncia...');
                        try {
                            window.suggestionSystem = new window.SuggestionSystemUnified();
                            window.USE_UNIFIED_SUGGESTIONS = true;
                            window.__SUGGESTION_SYSTEM_READY = true;
                            log('ğŸ¯ [INDEX] âœ… Sistema de emergÃªncia ativado!');
                        } catch (e) {
                            error('ğŸ¯ [INDEX] âŒ Falha no sistema de emergÃªncia:', e);
                        }
                    }
                }
            };
            
            forceActivate();
        });
    </script>
    <!-- ğŸ”’ Secure Render Utils - Sistema de RenderizaÃ§Ã£o Segura -->
    <script src="/secure-render-utils.js?v=2.0.0" defer></script>
    <!-- ğŸ” Reduced Mode Security Guard - FunÃ§Ã£o Centralizada de SeguranÃ§a -->
    <script src="/reduced-mode-security-guard.js?v=1.0.0" defer></script>
    <!-- ğŸ” AUDIT: Reference Mode Auditor (ANTES de tudo) -->
    <script src="/reference-mode-auditor.js?v=AUDIT" defer></script>
    <!-- ğŸ†• REF-FLOW: Reference Flow Controller (ISOLADO E DETERMINÃSTICO) -->
    <script src="/reference-flow.js?v=1.0.0" defer></script>
    <!-- ğŸ†• REF-NORMALIZE: Reference Normalizer (SEM GÃŠNERO) -->
    <script src="/reference-normalizer.js?v=1.0.0" defer></script>
    <!-- ğŸ†• PR2: Analysis State Machine (PRIMEIRO - fonte de verdade - SEM defer) -->
    <script src="/analysis-state-machine.js?v=PR2"></script>
    <!-- ğŸ” PR1: Reference Trace Utils (ANTES DO AUDIO ANALYZER) -->
    <script src="/reference-trace-utils.js?v=PR1" defer></script>
    
    <!-- ğŸ¯ BAND KEY ALIASES - Sistema centralizado de normalizaÃ§Ã£o de bandas -->
    <script src="/lib/audio/utils/band-key-aliases.js?v=1.0.0"></script>
    
    <!-- ğŸ¯ SCORE ENGINE V3 - Sistema de Score Realista por GÃªnero e Modo -->
    <script src="/lib/audio/features/score-engine-v3.js?v=3.3.0" defer></script>
    
    <!-- ğŸš¨ SCORING.JS - MÃ“DULO PRINCIPAL DE CÃLCULO (expÃµe window.computeMixScore) -->
    <script type="module" src="/lib/audio/features/scoring.js?v=3.3.0"></script>
    
    <!-- ğŸ¯ TOOLTIP MANAGER - Sistema Global de Tooltips com Event Delegation -->
    <script src="tooltip-manager.js?v=20260105-tooltips" defer></script>
    
    <!-- ğŸ¯ ERROR MAPPER - Sistema centralizado de mensagens de erro amigÃ¡veis -->
    <script src="/error-mapper.js?v=1.0.0"></script>
    
    <script src="/audio-analyzer-integration.js?v=NO_CACHE_FORCE&ts=20251228" defer></script>
    
    <!-- Inicializar Audio Analyzer -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Force external refs loading (bypass embedded)
            window.REFS_ALLOW_NETWORK = true;
            window.DEBUG_ANALYZER = true;
            window.REFS_BYPASS_CACHE = true;
            
            log('ğŸ”§ INIT: ForÃ§ando carregamento de refs externas');
            
            // Aguardar um pouco para garantir que todos os scripts carregaram
            setTimeout(() => {
                if (typeof initializeAudioAnalyzerIntegration === 'function') {
                    initializeAudioAnalyzerIntegration();
                    log('ğŸµ Audio Analyzer Integration inicializado');
                } else {
                    warn('âš ï¸ initializeAudioAnalyzerIntegration nÃ£o encontrada');
                }
            }, 1000);

            // Patch para botÃµes "+" - setup do menu popover CORRIGIDO E OTIMIZADO
            (function setupPlusPopovers() {
              let isInitialized = false; // Flag para evitar mÃºltiplas inicializaÃ§Ãµes
              let initializationTimeout = null;
              
              // Helper para criar popover para um container especÃ­fico
              function setupPopoverForContainer(container, plusBtn) {
                if (!container || !plusBtn) return false;

                // Verificar se jÃ¡ foi configurado
                if (plusBtn.hasAttribute('data-popover-configured')) return true;

                // Garante que o popover nÃ£o afete o layout
                container.style.position = (getComputedStyle(container).position === 'static') ? 'relative' : getComputedStyle(container).position;

                // Remove versÃµes antigas
                container.querySelector('.chatplus-popover')?.remove();

                // Cria popover
                const pop = document.createElement('div');
                pop.className = 'chatplus-popover';
                pop.setAttribute('role', 'menu');
                pop.setAttribute('aria-hidden', 'true');
                Object.assign(pop.style, {
                  position: 'absolute',
                  left: '8px',
                  bottom: 'calc(100% + 10px)',   // fica acima do input
                  minWidth: '220px',
                  background: '#0e0f1a',
                  color: '#e9e9f1',
                  border: '1px solid rgba(255,255,255,.08)',
                  borderRadius: '12px',
                  boxShadow: '0 10px 30px rgba(0,0,0,.35)',
                  padding: '6px',
                  opacity: '0',
                  transform: 'scale(.98) translateY(4px)',
                  pointerEvents: 'none',
                  transition: 'opacity .15s ease, transform .15s ease',
                  zIndex: '9999'
                });

                // Helper p/ criar item
                const mkItem = (label, action, svg) => {
                  const b = document.createElement('button');
                  b.className = 'chatplus-item';
                  b.setAttribute('role', 'menuitem');
                  b.dataset.action = action;
                  Object.assign(b.style, {
                    width: '100%',
                    textAlign: 'left',
                    padding: '10px 12px',
                    border: '0',
                    background: 'transparent',
                    color: 'inherit',
                    borderRadius: '8px',
                    fontSize: '14px',
                    display: 'flex',
                    gap: '10px',
                    alignItems: 'center',
                    cursor: 'pointer'
                  });
                  b.onpointerenter = () => (b.style.background = 'rgba(255,255,255,.06)');
                  b.onpointerleave = () => (b.style.background = 'transparent');
                  b.innerHTML = `${svg}<span>${label}</span>`;
                  return b;
                };

                const clipSVG = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="display:block;stroke:#cfcff9;stroke-width:1.8"><path d="M8 12l6-6a4 4 0 1 1 6 6l-8 8a5 5 0 1 1-7-7l8-8"/></svg>`;
                const audioSVG = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="display:block;stroke:#cfcff9;stroke-width:1.8"><path d="M3 12h2m2 0h2m2-6v12m4-9v6m4-3h2"/></svg>`;

                const addPhotos   = mkItem('Adicionar fotos', 'upload',  clipSVG);
                const analyzeSong = mkItem('AnÃ¡lise de Ã¡udio', 'analyze', audioSVG);
                pop.append(addPhotos, analyzeSong);
                container.appendChild(pop);

                // Abrir/fechar
                function open() {
                  // Fechar outros popovers abertos
                  document.querySelectorAll('.chatplus-popover').forEach(otherPop => {
                    if (otherPop !== pop && otherPop.getAttribute('aria-hidden') === 'false') {
                      otherPop.setAttribute('aria-hidden', 'true');
                      otherPop.style.opacity = '0';
                      otherPop.style.transform = 'scale(.98) translateY(4px)';
                      otherPop.style.pointerEvents = 'none';
                    }
                  });

                  pop.setAttribute('aria-hidden', 'false');
                  pop.style.opacity = '1';
                  pop.style.transform = 'scale(1) translateY(0)';
                  pop.style.pointerEvents = 'auto';
                  plusBtn.setAttribute('aria-expanded', 'true');
                  addPhotos.focus();
                  document.addEventListener('pointerdown', onOutside, { capture: true });
                  document.addEventListener('keydown', onKey);
                }
                function close() {
                  pop.setAttribute('aria-hidden', 'true');
                  pop.style.opacity = '0';
                  pop.style.transform = 'scale(.98) translateY(4px)';
                  pop.style.pointerEvents = 'none';
                  plusBtn.setAttribute('aria-expanded', 'false');
                  document.removeEventListener('pointerdown', onOutside, { capture: true });
                  document.removeEventListener('keydown', onKey);
                }
                function toggle() {
                  (pop.getAttribute('aria-hidden') === 'true') ? open() : close();
                }
                function onOutside(e) {
                  if (!pop.contains(e.target) && e.target !== plusBtn) close();
                }
                function onKey(e) {
                  if (e.key === 'Escape') return close();
                  const items = [addPhotos, analyzeSong];
                  const i = items.indexOf(document.activeElement);
                  if (e.key === 'ArrowDown') { (items[i+1] || items[0]).focus(); e.preventDefault(); }
                  if (e.key === 'ArrowUp')   { (items[i-1] || items.at(-1)).focus(); e.preventDefault(); }
                }

                plusBtn.setAttribute('aria-haspopup', 'menu');
                plusBtn.setAttribute('aria-expanded', 'false');
                
                // Remove listener anterior se existir
                if (plusBtn._clickHandler) {
                  plusBtn.removeEventListener('click', plusBtn._clickHandler);
                }
                plusBtn._clickHandler = toggle;
                plusBtn.addEventListener('click', toggle);

                // AÃ§Ãµes
                pop.addEventListener('click', (e) => {
                  const btn = e.target.closest('.chatplus-item');
                  if (!btn) return;
                  if (btn.dataset.action === 'upload') {
                    let fileInput = container.querySelector('input[type="file"].chatplus-file');
                    if (!fileInput) {
                      fileInput = document.createElement('input');
                      fileInput.type = 'file';
                      fileInput.accept = 'image/*';
                      fileInput.multiple = true;
                      fileInput.hidden = true;
                      fileInput.className = 'chatplus-file';
                      container.appendChild(fileInput);
                    }
                    fileInput.onchange = () => {
                      window.dispatchEvent(new CustomEvent('chat:add-photos', { detail: fileInput.files }));
                      fileInput.value = '';
                    };
                    fileInput.click();
                    close();
                  }
                  if (btn.dataset.action === 'analyze') {
                    if (typeof window.openAudioModal === 'function') window.openAudioModal();
                    else window.dispatchEvent(new CustomEvent('chat:analyze-audio-request'));
                    close();
                  }
                });

                // Marcar como configurado
                plusBtn.setAttribute('data-popover-configured', 'true');
                return true;
              }

              // Configurar popovers para ambos os estados do chat
              function initializeAllPopovers() {
                if (isInitialized) return; // Evitar mÃºltiplas execuÃ§Ãµes

                // Limpar timeout anterior
                if (initializationTimeout) {
                  clearTimeout(initializationTimeout);
                  initializationTimeout = null;
                }

                // Estado de boas-vindas
                const welcomeContainer = document.querySelector('.chatbot-input-field.chat-input-container');
                const welcomePlusBtn = welcomeContainer?.querySelector('.chatbot-add-btn.chat-plus-btn');
                
                // Estado ativo
                const activeContainer = document.querySelector('.chatbot-active-input-field.chat-input-container');
                const activePlusBtn = activeContainer?.querySelector('.chatbot-add-btn.chat-plus-btn');

                let setupCount = 0;
                
                if (welcomeContainer && welcomePlusBtn && !welcomePlusBtn.hasAttribute('data-popover-configured')) {
                  if (setupPopoverForContainer(welcomeContainer, welcomePlusBtn)) {
                    setupCount++;
                    log('âœ… Popover configurado para estado de boas-vindas');
                  }
                }

                if (activeContainer && activePlusBtn && !activePlusBtn.hasAttribute('data-popover-configured')) {
                  if (setupPopoverForContainer(activeContainer, activePlusBtn)) {
                    setupCount++;
                    log('âœ… Popover configurado para estado ativo');
                  }
                }

                // Se configurou pelo menos um, considerar inicializado
                if (setupCount > 0 || (welcomePlusBtn?.hasAttribute('data-popover-configured') && activePlusBtn?.hasAttribute('data-popover-configured'))) {
                  isInitialized = true;
                  log('âœ… Sistema de popovers inicializado completamente');
                }

                // Se nÃ£o conseguiu configurar todos, tentar novamente COM LIMITE
                if (!isInitialized && setupCount === 0) {
                  initializationTimeout = setTimeout(() => {
                    isInitialized = false; // Reset para nova tentativa
                    initializeAllPopovers();
                  }, 500); // Intervalo maior para evitar loop
                }
              }

              // Configurar observador para mudanÃ§as no chat (COM THROTTLING)
              let observerTimeout = null;
              function setupChatObserver() {
                const chatContainer = document.getElementById('chatbotContainer');
                if (chatContainer && !chatContainer.hasAttribute('data-observer-setup')) {
                  const observer = new MutationObserver((mutations) => {
                    // Throttling - evitar execuÃ§Ãµes excessivas
                    if (observerTimeout) return;
                    
                    observerTimeout = setTimeout(() => {
                      // Verificar se realmente precisa re-configurar
                      const activeContainer = document.querySelector('.chatbot-active-input-field.chat-input-container');
                      const activePlusBtn = activeContainer?.querySelector('.chatbot-add-btn.chat-plus-btn');
                      
                      if (activePlusBtn && !activePlusBtn.hasAttribute('data-popover-configured')) {
                        isInitialized = false; // Reset apenas se necessÃ¡rio
                        initializeAllPopovers();
                      }
                      
                      observerTimeout = null;
                    }, 200); // Throttling de 200ms
                  });
                  
                  observer.observe(chatContainer, { 
                    attributes: true, 
                    childList: true, 
                    subtree: true 
                  });
                  
                  chatContainer.setAttribute('data-observer-setup', 'true');
                }
              }

              // Inicializar quando a pÃ¡gina estiver pronta
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                  initializeAllPopovers();
                  setupChatObserver();
                });
              } else {
                initializeAllPopovers();
                setupChatObserver();
              }
            })();
        });
    </script>
    
    <!-- Scripts de monitoramento desabilitados para performance -->
    <!-- <script src="plan-monitor.js"></script> -->
    <!-- <script src="force-visibility.js"></script> -->
    <script src="plan-monitor.js?v=20250810"></script>
    <script src="force-visibility.js?v=20250810"></script>
    
    <!-- Sistema de Upload de Imagens -->
    <script src="image-upload-system.js?v=20241219-final"></script>
    
    <!-- ğŸ¯ FunÃ§Ãµes Globais para Modo ReferÃªncia -->
    <script>
        // Tornar funÃ§Ãµes disponÃ­veis globalmente para onclick handlers
        window.selectAnalysisMode = function(mode) {
            if (typeof selectAnalysisMode === 'function') {
                selectAnalysisMode(mode);
            } else {
                error('selectAnalysisMode nÃ£o estÃ¡ disponÃ­vel');
            }
        };
        
        window.closeModeSelectionModal = function() {
            if (typeof closeModeSelectionModal === 'function') {
                closeModeSelectionModal();
            } else {
                error('closeModeSelectionModal nÃ£o estÃ¡ disponÃ­vel');
            }
        };
        
        window.closeAudioModal = function() {
            if (typeof closeAudioModal === 'function') {
                closeAudioModal();
            } else {
                error('closeAudioModal nÃ£o estÃ¡ disponÃ­vel');
            }
        };
        
        // Acessibilidade: escape key para fechar modais
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modeModal = document.getElementById('analysisModeModal');
                const audioModal = document.getElementById('audioAnalysisModal');
                
                if (modeModal && modeModal.style.display === 'flex') {
                    window.closeModeSelectionModal();
                } else if (audioModal && audioModal.style.display === 'flex') {
                    window.closeAudioModal();
                }
            }
        });
        
        // Acessibilidade: tab navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                const modeModal = document.getElementById('analysisModeModal');
                if (modeModal && modeModal.style.display === 'flex') {
                    const focusableElements = modeModal.querySelectorAll(
                        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                    );
                    
                    if (focusableElements.length > 0) {
                        const firstElement = focusableElements[0];
                        const lastElement = focusableElements[focusableElements.length - 1];
                        
                        if (e.shiftKey && document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        } else if (!e.shiftKey && document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                }
            }
        });
    </script>
    
    <!-- Debug do analyzer - caminho corrigido -->
    <script src="../debug-analyzer.js"></script>
    
    <!-- Debug WAV Support - investigar problemas de formato -->
    <script src="../debug-wav-support.js"></script>
    
    <!-- Debug Upload Diagnostic - investigar uploads parciais -->
    <script src="../debug-upload-diagnostic.js"></script>
    
    <!-- Debug Upload Test - teste especÃ­fico 32MB â†’ 15 bytes -->
    <script src="../debug-upload-test.js"></script>
    
    <!-- Debug Audio Analyzer Deep - interceptar pipeline completo -->
    <script src="../debug-audio-analyzer-deep.js"></script>
    
    <!-- ğŸ¯ BAND WEIGHTED SCORE V2 - CorreÃ§Ã£o Inteligente de Score -->
    <script src="band-weighted-score-v2.js?v=20250131" defer></script>
    
    <!-- ğŸ§ª VERIFICAÃ‡ÃƒO: Modal de GÃªnero Musical -->
    <script src="verify-genre-modal.js" defer></script>
    
    <!-- ğŸ¯ SISTEMA CENTRALIZADO DE CAPABILITIES - Plano Plus Support -->
    <script src="plan-capabilities.js?v=20251213-plus" defer></script>
    
    <!-- ï¿½ ENTITLEMENTS HANDLER - Intercepta 403 PLAN_REQUIRED do backend -->
    <script src="entitlements-handler.js?v=20260103"></script>
    
    <!-- ï¿½ğŸ”’ SISTEMA DE GATE PREMIUM - Bloqueio Completo com Defesa em Profundidade -->
    <script src="premium-gate-system.js?v=20251213-final"></script>
    
    <!-- ğŸ›¡ï¸ BLOQUEADOR PREMIUM: Sistema de Bloqueio InquebrÃ¡vel (3 Camadas) -->
    <script src="premium-blocker.js?v=20251213" defer></script>
    
    <!-- ğŸ”’ MODAL DE UPGRADE - Bloqueio de Funcionalidades Premium -->
    <div id="upgradeModal" role="dialog" aria-modal="true" aria-labelledby="upgradeModalTitle">
        <div class="upgrade-modal-card">
            <div class="upgrade-modal-icon">ğŸ”’</div>
            <h2 class="upgrade-modal-title" id="upgradeModalTitle">Recurso Premium</h2>
            <p class="upgrade-modal-text">
                Este recurso estÃ¡ disponÃ­vel apenas para usuÃ¡rios com plano premium.
                FaÃ§a upgrade para desbloquear todas as funcionalidades avanÃ§adas do SoundyAI.
            </p>
            <div class="upgrade-modal-buttons">
                <button class="upgrade-modal-btn upgrade-modal-cta" aria-label="Ver planos disponÃ­veis">
                    âœ¨ Ver Planos
                </button>
                <button class="upgrade-modal-btn upgrade-modal-close" aria-label="Fechar modal">
                    Agora nÃ£o
                </button>
            </div>
        </div>
    </div>
    
    <!-- ğŸ¯ SCRIPT DE INICIALIZAÃ‡ÃƒO DO MODAL DE UPGRADE -->
    <script>
        // Inicializar modal de upgrade quando o DOM estiver pronto
        (function initUpgradeModal() {
            document.addEventListener('DOMContentLoaded', function() {
                const modal = document.getElementById('upgradeModal');
                if (!modal) {
                    error('âŒ [UPGRADE-MODAL] Modal nÃ£o encontrado no DOM');
                    return;
                }
                
                log('âœ… [UPGRADE-MODAL] Inicializando handlers...');
                
                // Handler: Fechar ao clicar no botÃ£o "Agora nÃ£o"
                const closeBtn = modal.querySelector('.upgrade-modal-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        modal.classList.remove('visible');
                        log('ğŸ”“ [UPGRADE-MODAL] Modal fechado pelo botÃ£o');
                    });
                }
                
                // Handler: Redirecionar ao clicar em "Ver Planos"
                const ctaBtn = modal.querySelector('.upgrade-modal-cta');
                if (ctaBtn) {
                    ctaBtn.addEventListener('click', function() {
                        log('ğŸ”— [UPGRADE-MODAL] Redirecionando para planos.html');
                        window.location.href = '/planos.html';
                    });
                }
                
                // Handler: Fechar ao clicar fora do card
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.remove('visible');
                        log('ğŸ”“ [UPGRADE-MODAL] Modal fechado (clique fora)');
                    }
                });
                
                // Handler: Fechar com ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && modal.classList.contains('visible')) {
                        modal.classList.remove('visible');
                        log('ğŸ”“ [UPGRADE-MODAL] Modal fechado (ESC)');
                    }
                });
                
                log('âœ… [UPGRADE-MODAL] Modal inicializado com sucesso');
            });
        })();
    </script>
    
    <!-- Template invisÃ­vel para geraÃ§Ã£o de PDF -->
    <div id="pdf-report-template" style="position: absolute; left: -9999px; top: 0; visibility: hidden;"></div>

    <!-- ğŸ¯ SCRIPT DO MENU HAMBÃšRGUER E PAINEL LATERAL -->
    <script>
        (function initSidePanel() {
            document.addEventListener('DOMContentLoaded', function() {
                const hamburgerBtn = document.getElementById('hamburgerMenuBtn');
                const sidePanel = document.getElementById('sidePanel');
                const overlay = document.getElementById('sidePanelOverlay');
                const closeBtn = document.getElementById('sidePanelClose');
                const menuItems = document.querySelectorAll('.side-panel-item');
                
                if (!hamburgerBtn || !sidePanel || !overlay) {
                    error('âŒ [SIDE-PANEL] Elementos nÃ£o encontrados');
                    return;
                }
                
                log('âœ… [SIDE-PANEL] Inicializando menu lateral...');
                
                // FunÃ§Ã£o para abrir/fechar painel
                function togglePanel() {
                    const isActive = sidePanel.classList.contains('active');
                    
                    if (isActive) {
                        closePanel();
                    } else {
                        openPanel();
                    }
                }
                
                function openPanel() {
                    sidePanel.classList.add('active');
                    overlay.classList.add('active');
                    hamburgerBtn.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                function closePanel() {
                    sidePanel.classList.remove('active');
                    overlay.classList.remove('active');
                    hamburgerBtn.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                // Event Listeners
                hamburgerBtn.addEventListener('click', togglePanel);
                closeBtn.addEventListener('click', closePanel);
                overlay.addEventListener('click', closePanel);
                
                // Fechar com ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && sidePanel.classList.contains('active')) {
                        closePanel();
                    }
                });
                
                // Handler para itens do menu
                menuItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        closePanel();
                        
                        // Pequeno delay para animaÃ§Ã£o de fechamento
                        setTimeout(() => {
                            handleSidePanelAction(action);
                        }, 150);
                    });
                });
                
                // FunÃ§Ã£o para executar aÃ§Ãµes
                function handleSidePanelAction(action) {
                    log('ğŸ¯ [SIDE-PANEL] AÃ§Ã£o:', action);
                    
                    // ğŸ”“ MODO ANÃ”NIMO: Interceptar aÃ§Ãµes que requerem login
                    if (window.SoundyAnonymous && window.SoundyAnonymous.isAnonymousMode) {
                        if (action === 'upgrade' || action === 'manage') {
                            log('ğŸ”“ [SIDE-PANEL] AÃ§Ã£o bloqueada - modo anÃ´nimo');
                            window.SoundyAnonymous.showLoginModal(action);
                            return;
                        }
                        if (action === 'logout') {
                            // Em modo anÃ´nimo, "logout" redireciona para login
                            window.location.href = 'login.html';
                            return;
                        }
                    }
                    
                    switch(action) {
                        case 'analyze':
                            // âœ… Usar openAudioModal para garantir fluxo completo (welcome â†’ mode â†’ genre/reference)
                            if (typeof window.openAudioModal === 'function') {
                                window.openAudioModal();
                            } else {
                                error('openAudioModal nÃ£o disponÃ­vel');
                            }
                            break;
                            
                        case 'docs':
                            // Abrir documento tÃ©cnico
                            window.open('documento-tecnico.html', '_blank');
                            break;
                            
                        case 'history':
                            // ğŸ• Abrir histÃ³rico de anÃ¡lises (PRO/STUDIO only)
                            if (window.SoundyHistory && window.SoundyHistory.open) {
                                window.SoundyHistory.open();
                            } else {
                                warn('SoundyHistory nÃ£o disponÃ­vel');
                            }
                            break;
                            
                        case 'upgrade':
                            window.location.href = 'planos.html';
                            break;
                            
                        case 'manage':
                            window.location.href = 'gerenciar.html';
                            break;
                            
                        case 'logout':
                            if (typeof window.logout === 'function') {
                                window.logout();
                            } else {
                                // ğŸ”— Preservar dados importantes antes de limpar
                                var adminBypass = localStorage.getItem('soundy_admin_bypass');
                                var referralCode = localStorage.getItem('soundy_referral_code');
                                var referralTimestamp = localStorage.getItem('soundy_referral_timestamp');
                                
                                localStorage.clear();
                                
                                // Restaurar dados preservados
                                if (adminBypass) {
                                    localStorage.setItem('soundy_admin_bypass', adminBypass);
                                }
                                if (referralCode) {
                                    localStorage.setItem('soundy_referral_code', referralCode);
                                    localStorage.setItem('soundy_referral_timestamp', referralTimestamp);
                                    console.log('ğŸ”— [REFERRAL] CÃ³digo preservado apÃ³s logout:', referralCode);
                                }
                                
                                window.location.href = 'login.html';
                            }
                            break;
                            
                        default:
                            warn('AÃ§Ã£o nÃ£o reconhecida:', action);
                    }
                }
                
                log('âœ… [SIDE-PANEL] Menu lateral inicializado com sucesso');
            });
        })();
    </script>
    
    <!-- ğŸ• Sistema de HistÃ³rico de AnÃ¡lises (PRO/STUDIO only) -->
    <script src="analysis-history.js?v=20260104" defer></script>
    
    <!-- Scoring Debug Visual (apenas em dev/debug) -->
    <script src="js/scoring-debug-visual.js" defer></script>
    
    <!-- ğŸš« Script para ocultar botÃ£o "Plano de CorreÃ§Ã£o" no modo referÃªncia -->
    <script>
        (function() {
            // FunÃ§Ã£o para controlar visibilidade do botÃ£o baseado no modo
            function updateCorrectionPlanButtonVisibility() {
                const currentMode = window.currentAnalysisMode || 
                                  window.__soundyState?.currentAnalysisMode || 
                                  (window.AnalysisStateMachine?.getMode && window.AnalysisStateMachine.getMode()) || 
                                  'genre';
                
                const btnCorrectionPlan = document.getElementById('btnGenerateCorrectionPlan');
                const body = document.body;
                
                // Definir atributo data no body para CSS
                if (body) {
                    body.setAttribute('data-analysis-mode', currentMode);
                }
                
                if (btnCorrectionPlan) {
                    if (currentMode === 'reference') {
                        btnCorrectionPlan.style.display = 'none';
                        btnCorrectionPlan.style.visibility = 'hidden';
                        btnCorrectionPlan.style.pointerEvents = 'none';
                        log('[BUTTON-CONTROL] ğŸ”’ BotÃ£o "Plano de CorreÃ§Ã£o" ocultado (modo referÃªncia)');
                    } else {
                        btnCorrectionPlan.style.display = '';
                        btnCorrectionPlan.style.visibility = '';
                        btnCorrectionPlan.style.pointerEvents = '';
                        log('[BUTTON-CONTROL] âœ… BotÃ£o "Plano de CorreÃ§Ã£o" visÃ­vel (modo:', currentMode, ')');
                    }
                }
            }
            
            // Executar imediatamente
            updateCorrectionPlanButtonVisibility();
            
            // Executar quando DOM estiver pronto
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateCorrectionPlanButtonVisibility);
            }
            
            // Monitorar mudanÃ§as no modo
            setInterval(updateCorrectionPlanButtonVisibility, 500);
            
            // Observar mudanÃ§as no currentAnalysisMode
            let lastMode = null;
            setInterval(() => {
                const currentMode = window.currentAnalysisMode;
                if (currentMode !== lastMode) {
                    lastMode = currentMode;
                    updateCorrectionPlanButtonVisibility();
                }
            }, 100);
            
            log('[BUTTON-CONTROL] âœ… Sistema de controle do botÃ£o inicializado');
        })();
    </script>
</body>
</html>