<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Teste: Corre√ß√£o LRA e Bandas Espectrais</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            line-height: 1.6;
        }
        .container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        pre { 
            background: #2d3748; 
            color: #e2e8f0; 
            padding: 15px; 
            border-radius: 4px; 
            overflow-x: auto;
            font-size: 14px;
        }
        .test-section {
            margin: 20px 0;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .test-header {
            background: #343a40;
            color: white;
            padding: 15px;
            margin: 0;
            font-size: 18px;
        }
        .test-content { padding: 20px; }
        .metric-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #6c757d;
        }
        .found { border-left-color: #28a745; background: #d4edda; }
        .missing { border-left-color: #dc3545; background: #f8d7da; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>üîß Teste: Corre√ß√£o LRA e Bandas Espectrais</h1>
    
    <div class="container info">
        <h3>üìã Objetivo do Teste</h3>
        <p>Validar que as corre√ß√µes implementadas resolvem:</p>
        <ul>
            <li><strong>Problema LRA:</strong> M√©trica n√£o reconhecida apesar de estar no JSON</li>
            <li><strong>Problema Bandas:</strong> Nem todas as bandas espectrais geram sugest√µes</li>
        </ul>
    </div>

    <div class="test-section">
        <h2 class="test-header">üß™ Dados de Teste Simulados</h2>
        <div class="test-content">
            <p>Simulando dados do backend com LRA e bandas espectrais:</p>
            <button onclick="testarDadosBackend()">üöÄ Executar Teste</button>
            <button onclick="limparResultados()">üßπ Limpar</button>
        </div>
    </div>

    <div id="results"></div>

    <!-- Carregar depend√™ncias -->
    <script src="audio-analyzer-integration.js"></script>
    <script src="enhanced-suggestion-engine.js"></script>

    <script>
        // üß™ DADOS DE TESTE: Simular resposta do backend
        const dadosBackendTeste = {
            technicalData: {
                peak: -3.2,
                rms: -18.5,
                dynamicRange: 15.3,
                lufsIntegrated: -14.2,
                // LRA em diferentes formatos para teste
                lra: 5.63,
                spectral_balance: {
                    sub: -25.4,
                    bass: -18.7,
                    low_bass: -18.7, // alias para bass
                    lowMid: -15.2,
                    low_mid: -15.2, // alias para lowMid
                    mid: -12.8,
                    highMid: -16.1,
                    high_mid: -16.1, // alias para highMid
                    presence: -20.3,
                    presenca: -20.3, // alias para presence
                    air: -22.1,
                    brilho: -22.1 // alias para air
                }
            },
            // LRA tamb√©m na estrutura loudness
            loudness: {
                integrated: -14.2,
                lra: 5.63,
                shortTerm: -13.8,
                momentary: -13.1
            },
            // LRA tamb√©m na raiz
            lra: 5.63,
            loudnessRange: 5.63,
            problems: [],
            suggestions: []
        };

        // üìä DADOS DE REFER√äNCIA SIMULADOS
        const dadosReferenciaTeste = {
            bands: {
                sub: { target_db: -24.0, tol_db: 3.0 },
                bass: { target_db: -18.0, tol_db: 2.5 },
                low_bass: { target_db: -18.0, tol_db: 2.5 }, // alias
                lowMid: { target_db: -15.0, tol_db: 2.0 },
                low_mid: { target_db: -15.0, tol_db: 2.0 }, // alias
                mid: { target_db: -12.0, tol_db: 1.5 },
                highMid: { target_db: -16.0, tol_db: 2.0 },
                high_mid: { target_db: -16.0, tol_db: 2.0 }, // alias
                presence: { target_db: -20.0, tol_db: 2.5 },
                presenca: { target_db: -20.0, tol_db: 2.5 }, // alias
                air: { target_db: -22.0, tol_db: 3.0 },
                brilho: { target_db: -22.0, tol_db: 3.0 } // alias
            },
            mainMetrics: {
                lra: { target: 6.0, tolerance: 2.0 },
                lufs: { target: -14.0, tolerance: 1.0 },
                truePeak: { target: -1.0, tolerance: 0.5 }
            }
        };

        function adicionarResultado(titulo, conteudo, tipo = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `container ${tipo}`;
            div.innerHTML = `<h3>${titulo}</h3>${conteudo}`;
            results.appendChild(div);
        }

        function limparResultados() {
            document.getElementById('results').innerHTML = '';
        }

        async function testarDadosBackend() {
            limparResultados();
            
            try {
                adicionarResultado('üöÄ Iniciando Teste', 'Testando normaliza√ß√£o dos dados do backend...');

                // 1. TESTAR NORMALIZA√á√ÉO
                console.log('üß™ [TESTE] Dados originais:', dadosBackendTeste);
                
                if (typeof normalizeBackendAnalysisData !== 'function') {
                    throw new Error('Fun√ß√£o normalizeBackendAnalysisData n√£o encontrada');
                }

                const dadosNormalizados = normalizeBackendAnalysisData(dadosBackendTeste);
                
                adicionarResultado(
                    'üìä Dados Normalizados', 
                    `<pre>${JSON.stringify(dadosNormalizados.technicalData, null, 2)}</pre>`
                );

                // 2. TESTAR LRA
                const lraEncontrado = dadosNormalizados.technicalData.lra;
                if (lraEncontrado !== null && lraEncontrado !== undefined) {
                    adicionarResultado(
                        '‚úÖ LRA: SUCESSO', 
                        `LRA foi mapeado corretamente: <strong>${lraEncontrado}</strong>`,
                        'success'
                    );
                } else {
                    adicionarResultado(
                        '‚ùå LRA: ERRO', 
                        'LRA n√£o foi mapeado corretamente',
                        'error'
                    );
                }

                // 3. TESTAR BANDAS ESPECTRAIS
                const bandasEspectrais = dadosNormalizados.technicalData.spectral_balance;
                if (bandasEspectrais) {
                    const bandasDetectadas = Object.entries(bandasEspectrais)
                        .filter(([key, value]) => value !== null && value !== undefined)
                        .map(([key, value]) => `${key}: ${value}dB`);
                    
                    if (bandasDetectadas.length > 0) {
                        adicionarResultado(
                            '‚úÖ Bandas Espectrais: SUCESSO', 
                            `${bandasDetectadas.length} bandas mapeadas:<br><strong>${bandasDetectadas.join(', ')}</strong>`,
                            'success'
                        );
                    } else {
                        adicionarResultado(
                            '‚ùå Bandas Espectrais: ERRO', 
                            'Nenhuma banda foi mapeada',
                            'error'
                        );
                    }
                } else {
                    adicionarResultado(
                        '‚ùå Bandas Espectrais: ERRO', 
                        'spectral_balance n√£o foi criado',
                        'error'
                    );
                }

                // 4. TESTAR ENHANCED SUGGESTION ENGINE
                if (typeof window !== 'undefined' && window.enhancedSuggestionEngine) {
                    try {
                        adicionarResultado('üéØ Testando Enhanced Suggestion Engine', 'Processando an√°lise...');
                        
                        const enhancedAnalysis = window.enhancedSuggestionEngine.processAnalysis(
                            dadosNormalizados, 
                            dadosReferenciaTeste
                        );
                        
                        const sugestoesLRA = enhancedAnalysis.suggestions.filter(s => 
                            s.description && s.description.toLowerCase().includes('lra')
                        );
                        
                        const sugestoesBandas = enhancedAnalysis.suggestions.filter(s => 
                            s.type && s.type.includes('band_adjust')
                        );
                        
                        adicionarResultado(
                            'üéØ Enhanced Suggestion Engine: Resultado',
                            `
                            <strong>Total de sugest√µes:</strong> ${enhancedAnalysis.suggestions.length}<br>
                            <strong>Sugest√µes LRA:</strong> ${sugestoesLRA.length}<br>
                            <strong>Sugest√µes de Bandas:</strong> ${sugestoesBandas.length}<br>
                            ${enhancedAnalysis.auditLog ? `<br><strong>Audit Log dispon√≠vel:</strong> ‚úÖ` : ''}
                            `,
                            enhancedAnalysis.suggestions.length > 0 ? 'success' : 'warning'
                        );
                        
                        if (enhancedAnalysis.auditLog && enhancedAnalysis.auditLog.length > 0) {
                            const logRelevante = enhancedAnalysis.auditLog
                                .filter(entry => entry.includes('LRA') || entry.includes('banda'))
                                .slice(0, 10);
                            
                            if (logRelevante.length > 0) {
                                adicionarResultado(
                                    'üîç Audit Log (LRA/Bandas)',
                                    `<pre>${logRelevante.join('\n')}</pre>`
                                );
                            }
                        }
                        
                    } catch (engineError) {
                        adicionarResultado(
                            '‚ùå Enhanced Suggestion Engine: ERRO',
                            `Erro: ${engineError.message}`,
                            'error'
                        );
                    }
                } else {
                    adicionarResultado(
                        '‚ö†Ô∏è Enhanced Suggestion Engine: N√£o Dispon√≠vel',
                        'Enhanced Suggestion Engine n√£o est√° carregado',
                        'warning'
                    );
                }

                // 5. RESUMO FINAL
                const problemas = [];
                const sucessos = [];
                
                if (lraEncontrado !== null) {
                    sucessos.push('‚úÖ LRA mapeado corretamente');
                } else {
                    problemas.push('‚ùå LRA n√£o foi mapeado');
                }
                
                if (bandasEspectrais && Object.values(bandasEspectrais).some(v => v !== null)) {
                    sucessos.push('‚úÖ Bandas espectrais mapeadas');
                } else {
                    problemas.push('‚ùå Bandas espectrais n√£o foram mapeadas');
                }
                
                const resumo = `
                    <h4>Sucessos (${sucessos.length}):</h4>
                    <ul>${sucessos.map(s => `<li>${s}</li>`).join('')}</ul>
                    <h4>Problemas (${problemas.length}):</h4>
                    <ul>${problemas.map(p => `<li>${p}</li>`).join('')}</ul>
                `;
                
                adicionarResultado(
                    'üìã Resumo Final',
                    resumo,
                    problemas.length === 0 ? 'success' : 'warning'
                );

            } catch (error) {
                adicionarResultado(
                    'üí• Erro no Teste',
                    `Erro inesperado: ${error.message}<br><pre>${error.stack}</pre>`,
                    'error'
                );
            }
        }

        // Executar teste automaticamente quando a p√°gina carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                adicionarResultado(
                    'üìù Instru√ß√µes',
                    'Clique em "üöÄ Executar Teste" para validar as corre√ß√µes implementadas.',
                    'info'
                );
            }, 1000);
        });
    </script>
</body>
</html>