<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>üîç Debug JSON Sugest√µes - An√°lise Profunda</title>
    <style>
        body { font-family: monospace; background: #111; color: #fff; padding: 20px; line-height: 1.4; }
        .container { max-width: 1600px; margin: 0 auto; }
        .section { background: #222; border: 1px solid #444; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .log { background: #333; padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 4px solid #666; }
        .success { border-left-color: #4caf50; background: #1b5e20; }
        .error { border-left-color: #f44336; background: #5d1a1d; }
        .warning { border-left-color: #ff9800; background: #5d4037; }
        .info { border-left-color: #2196f3; background: #1a237e; }
        .critical { border-left-color: #e91e63; background: #4a148c; font-weight: bold; }
        button { background: #4a90e2; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin: 8px; font-family: monospace; }
        button:hover { background: #357abd; }
        .danger { background: #f44336; }
        .danger:hover { background: #d32f2f; }
        pre { background: #000; color: #0f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 12px; border: 1px solid #333; }
        .highlight { background: #ff9800; color: #000; padding: 2px 4px; border-radius: 3px; }
        .flow-step { background: #2a2a2a; margin: 10px 0; padding: 15px; border-radius: 6px; border-left: 4px solid #4a90e2; }
        .json-display { background: #1a1a1a; border: 2px solid #333; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; margin: 4px; font-weight: bold; }
        .status.pass { background: #4caf50; color: white; }
        .status.fail { background: #f44336; color: white; }
        .status.unknown { background: #757575; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug JSON Sugest√µes - An√°lise Profunda Railway</h1>
        <p>Investiga√ß√£o completa do fluxo de sugest√µes desde gera√ß√£o at√© exibi√ß√£o</p>
        
        <div class="section">
            <h2>üéØ Controles de Debug</h2>
            <button onclick="debugFluxoCompleto()">üöÄ Debug Fluxo Completo</button>
            <button onclick="interceptarChamadas()">üïµÔ∏è Interceptar Chamadas</button>
            <button onclick="simularProblema()">üîÑ Simular Problema Real</button>
            <button onclick="capturarJSON()">üì¶ Capturar JSON Final</button>
            <button onclick="limpar()" class="danger">üßπ Limpar</button>
        </div>

        <div class="section">
            <h2>üìä Status das Verifica√ß√µes</h2>
            <div id="status-checks">Aguardando verifica√ß√µes...</div>
        </div>

        <div class="section">
            <h2>üîÑ Fluxo de Execu√ß√£o</h2>
            <div id="flow-steps">Fluxo ser√° mapeado durante execu√ß√£o...</div>
        </div>

        <div class="section">
            <h2>üì¶ Captura de Dados</h2>
            <div id="data-capture">Dados capturados aparecer√£o aqui...</div>
        </div>

        <div class="section">
            <h2>üìã Logs Detalhados</h2>
            <div id="logs">Logs de debug aparecer√£o aqui...</div>
        </div>
    </div>

    <!-- Scripts na ordem correta -->
    <script src="suggestion-scorer.js"></script>
    <script src="enhanced-suggestion-engine.js"></script>
    <script src="suggestion-system-emergency.js"></script>

    <script>
        let interceptedCalls = [];
        let flowSteps = [];
        let capturedData = {};

        function log(level, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log ${level}`;
            entry.innerHTML = `
                <strong>[${timestamp}] ${message}</strong>
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            logDiv.appendChild(entry);
            console.log(`[${level.toUpperCase()}] ${message}`, data || '');
            entry.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function addFlowStep(step, status, details = null) {
            flowSteps.push({ step, status, details, timestamp: Date.now() });
            updateFlowDisplay();
        }

        function updateFlowDisplay() {
            const flowDiv = document.getElementById('flow-steps');
            flowDiv.innerHTML = flowSteps.map((item, index) => `
                <div class="flow-step">
                    <strong>${index + 1}. ${item.step}</strong>
                    <span class="status ${item.status}">${item.status.toUpperCase()}</span>
                    ${item.details ? `<pre>${JSON.stringify(item.details, null, 2)}</pre>` : ''}
                </div>
            `).join('');
        }

        function updateStatusChecks() {
            const checks = [
                { name: 'SuggestionScorer carregado', test: () => typeof window.SuggestionScorer !== 'undefined' },
                { name: 'EnhancedSuggestionEngine carregado', test: () => typeof window.EnhancedSuggestionEngine !== 'undefined' },
                { name: 'window.suggestionSystem existe', test: () => typeof window.suggestionSystem !== 'undefined' },
                { name: 'window.suggestionSystem.process funcional', test: () => typeof window.suggestionSystem?.process === 'function' },
                { name: 'Dados de refer√™ncia globais', test: () => typeof window.embeddedReferences !== 'undefined' },
                { name: 'USE_UNIFIED_SUGGESTIONS ativo', test: () => window.USE_UNIFIED_SUGGESTIONS === true }
            ];

            const statusDiv = document.getElementById('status-checks');
            statusDiv.innerHTML = checks.map(check => {
                const result = check.test();
                return `<span class="status ${result ? 'pass' : 'fail'}">${check.name}: ${result ? 'OK' : 'FAIL'}</span>`;
            }).join(' ');
        }

        function interceptarChamadas() {
            log('info', 'üïµÔ∏è Interceptando chamadas do sistema...');
            
            // Interceptar window.suggestionSystem.process
            if (window.suggestionSystem && window.suggestionSystem.process) {
                const originalProcess = window.suggestionSystem.process.bind(window.suggestionSystem);
                
                window.suggestionSystem.process = function(analysis, referenceData) {
                    const callId = Date.now();
                    
                    log('critical', `üö® CHAMADA INTERCEPTADA #${callId}`, {
                        hasAnalysis: !!analysis,
                        hasTechnicalData: !!analysis?.technicalData,
                        hasReferenceData: !!referenceData,
                        referenceGenre: referenceData?.genre,
                        analysisKeys: analysis ? Object.keys(analysis) : null,
                        technicalDataKeys: analysis?.technicalData ? Object.keys(analysis.technicalData) : null
                    });
                    
                    addFlowStep(`Chamada do suggestionSystem.process #${callId}`, 'pass', {
                        analysisData: {
                            lufs: analysis?.technicalData?.lufs || analysis?.technicalData?.lufsIntegrated,
                            truePeak: analysis?.technicalData?.true_peak || analysis?.technicalData?.truePeakDbtp,
                            dr: analysis?.technicalData?.dr || analysis?.technicalData?.dynamicRange
                        },
                        reference: {
                            genre: referenceData?.genre,
                            lufsTarget: referenceData?.lufs_target,
                            truePeakTarget: referenceData?.true_peak_target
                        }
                    });
                    
                    try {
                        const result = originalProcess(analysis, referenceData);
                        
                        log('success', `‚úÖ RESULTADO INTERCEPTADO #${callId}`, {
                            suggestionsCount: result?.suggestions?.length || 0,
                            hasAuditLog: !!result?.auditLog,
                            hasEnhancedMetrics: !!result?.enhancedMetrics,
                            suggestionTypes: (result?.suggestions || []).map(s => s.category || s.type),
                            firstSuggestion: result?.suggestions?.[0] || null
                        });
                        
                        addFlowStep(`Resultado gerado #${callId}`, result?.suggestions?.length > 0 ? 'pass' : 'fail', {
                            suggestionsGenerated: result?.suggestions?.length || 0,
                            processingTime: result?.enhancedMetrics?.processingTimeMs || 'N/A'
                        });
                        
                        // Armazenar para an√°lise posterior
                        capturedData[`call_${callId}`] = {
                            input: { analysis, referenceData },
                            output: result,
                            timestamp: new Date().toISOString()
                        };
                        
                        interceptedCalls.push({
                            id: callId,
                            input: { analysis, referenceData },
                            output: result,
                            timestamp: Date.now()
                        });
                        
                        return result;
                        
                    } catch (error) {
                        log('error', `‚ùå ERRO INTERCEPTADO #${callId}: ${error.message}`, error);
                        addFlowStep(`Erro na chamada #${callId}`, 'fail', { error: error.message });
                        throw error;
                    }
                };
                
                log('success', '‚úÖ Intercepta√ß√£o ativada com sucesso');
            } else {
                log('error', '‚ùå N√£o foi poss√≠vel interceptar - suggestionSystem.process n√£o encontrado');
            }
        }

        function debugFluxoCompleto() {
            log('info', 'üöÄ Iniciando debug completo do fluxo...');
            flowSteps = [];
            capturedData = {};
            
            addFlowStep('Iniciando debug completo', 'pass');
            
            // Verificar depend√™ncias
            updateStatusChecks();
            addFlowStep('Verifica√ß√£o de depend√™ncias', 'pass');
            
            // Ativar intercepta√ß√£o
            interceptarChamadas();
            addFlowStep('Intercepta√ß√£o ativada', 'pass');
            
            // Simular chamada real
            setTimeout(() => {
                simularProblema();
            }, 1000);
        }

        function simularProblema() {
            log('info', 'üîÑ Simulando problema real (primeira abertura vs segunda sele√ß√£o)...');
            
            // Dados de teste simulando an√°lise real da Railway
            const testAnalysis = {
                metadata: {
                    filename: "railway_debug_test.wav",
                    duration: 185.7,
                    sampleRate: 48000,
                    channels: 2
                },
                technicalData: {
                    lufs: -13.2,
                    lufsIntegrated: -13.2,
                    true_peak: -1.1,
                    truePeakDbtp: -1.1,
                    dr: 6.8,
                    dynamicRange: 6.8,
                    lra: 4.5,
                    stereo: 0.82,
                    stereoWidth: 0.82,
                    frequencyAnalysis: {
                        subbass: 0.71,
                        bass: 0.83,
                        lowMid: 0.78,
                        mid: 0.89,
                        highMid: 0.72,
                        presenca: 0.65,
                        brilho: 0.74
                    }
                }
            };

            // Simular refer√™ncia de Funk Mandela
            const funkMandelaRef = {
                genre: "Funk Mandela",
                lufs_target: -14.0,
                lufs_tolerance: 1.0,
                true_peak_target: -1.0,
                true_peak_tolerance: 0.5,
                dr_target: 8.0,
                dr_tolerance: 2.0,
                lra_target: 6.0,
                lra_tolerance: 2.0,
                stereo_target: 0.8,
                stereo_tolerance: 0.15,
                bands: {
                    subbass: { target: 0.75, tolerance: 0.1 },
                    bass: { target: 0.8, tolerance: 0.1 },
                    lowMid: { target: 0.8, tolerance: 0.1 },
                    mid: { target: 0.9, tolerance: 0.1 },
                    highMid: { target: 0.75, tolerance: 0.1 },
                    presenca: { target: 0.7, tolerance: 0.1 },
                    brilho: { target: 0.8, tolerance: 0.1 }
                }
            };

            log('info', '1Ô∏è‚É£ Simulando PRIMEIRA abertura do modal (problema)...');
            addFlowStep('Primeira abertura - an√°lise inicial', 'unknown');
            
            if (window.suggestionSystem) {
                try {
                    const resultado1 = window.suggestionSystem.process(testAnalysis, funkMandelaRef);
                    
                    log('info', `üìä PRIMEIRA TENTATIVA: ${resultado1?.suggestions?.length || 0} sugest√µes`, {
                        suggestions: resultado1?.suggestions || [],
                        auditLog: resultado1?.auditLog?.length || 0,
                        enhancedMetrics: resultado1?.enhancedMetrics || null
                    });
                    
                    addFlowStep('Primeira tentativa conclu√≠da', 
                        resultado1?.suggestions?.length > 0 ? 'pass' : 'fail',
                        { suggestionsCount: resultado1?.suggestions?.length || 0 }
                    );
                    
                    // Aguardar e simular segunda tentativa
                    setTimeout(() => {
                        log('info', '2Ô∏è‚É£ Simulando SEGUNDA sele√ß√£o de g√™nero (funciona)...');
                        addFlowStep('Segunda sele√ß√£o - troca de g√™nero', 'unknown');
                        
                        try {
                            const resultado2 = window.suggestionSystem.process(testAnalysis, funkMandelaRef);
                            
                            log('success', `üìä SEGUNDA TENTATIVA: ${resultado2?.suggestions?.length || 0} sugest√µes`, {
                                suggestions: resultado2?.suggestions || [],
                                auditLog: resultado2?.auditLog?.length || 0,
                                enhancedMetrics: resultado2?.enhancedMetrics || null
                            });
                            
                            addFlowStep('Segunda tentativa conclu√≠da',
                                resultado2?.suggestions?.length > 0 ? 'pass' : 'fail',
                                { suggestionsCount: resultado2?.suggestions?.length || 0 }
                            );
                            
                            // Comparar resultados
                            const primeiraVazia = !resultado1?.suggestions || resultado1.suggestions.length === 0;
                            const segundaFunciona = resultado2?.suggestions && resultado2.suggestions.length > 0;
                            
                            if (primeiraVazia && segundaFunciona) {
                                log('critical', 'üö® PROBLEMA CONFIRMADO: Primeira vazia, segunda funciona!');
                                addFlowStep('PROBLEMA CONFIRMADO', 'fail', {
                                    primeira: resultado1?.suggestions?.length || 0,
                                    segunda: resultado2?.suggestions?.length || 0
                                });
                            } else if (!primeiraVazia && segundaFunciona) {
                                log('success', '‚úÖ PROBLEMA RESOLVIDO: Ambas funcionam!');
                                addFlowStep('PROBLEMA RESOLVIDO', 'pass');
                            } else {
                                log('warning', '‚ö†Ô∏è Comportamento inconsistente detectado');
                                addFlowStep('Comportamento inconsistente', 'unknown');
                            }
                            
                        } catch (error2) {
                            log('error', `‚ùå Erro na segunda tentativa: ${error2.message}`);
                            addFlowStep('Erro na segunda tentativa', 'fail', { error: error2.message });
                        }
                    }, 1500);
                    
                } catch (error1) {
                    log('error', `‚ùå Erro na primeira tentativa: ${error1.message}`);
                    addFlowStep('Erro na primeira tentativa', 'fail', { error: error1.message });
                }
            } else {
                log('error', '‚ùå window.suggestionSystem n√£o encontrado');
                addFlowStep('Sistema n√£o encontrado', 'fail');
            }
        }

        function capturarJSON() {
            log('info', 'üì¶ Capturando estado atual do JSON...');
            
            const jsonState = {
                timestamp: new Date().toISOString(),
                systemState: {
                    suggestionScorer: typeof window.SuggestionScorer,
                    enhancedEngine: typeof window.EnhancedSuggestionEngine,
                    suggestionSystem: typeof window.suggestionSystem,
                    unifiedSuggestions: window.USE_UNIFIED_SUGGESTIONS,
                    embeddedReferences: typeof window.embeddedReferences
                },
                interceptedCalls: interceptedCalls.length,
                capturedData: Object.keys(capturedData).length,
                lastCall: interceptedCalls[interceptedCalls.length - 1] || null
            };
            
            const captureDiv = document.getElementById('data-capture');
            captureDiv.innerHTML = `
                <div class="json-display">
                    <h3>üì¶ Estado Capturado</h3>
                    <pre>${JSON.stringify(jsonState, null, 2)}</pre>
                </div>
                <div class="json-display">
                    <h3>üïµÔ∏è Chamadas Interceptadas (${interceptedCalls.length})</h3>
                    <pre>${JSON.stringify(interceptedCalls, null, 2)}</pre>
                </div>
            `;
            
            // Salvar globalmente para acesso via console
            window.__DEBUG_CAPTURED_DATA = capturedData;
            window.__DEBUG_INTERCEPTED_CALLS = interceptedCalls;
            window.__DEBUG_JSON_STATE = jsonState;
            
            log('success', '‚úÖ JSON capturado - dispon√≠vel em window.__DEBUG_*');
        }

        function limpar() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('flow-steps').innerHTML = 'Fluxo ser√° mapeado durante execu√ß√£o...';
            document.getElementById('data-capture').innerHTML = 'Dados capturados aparecer√£o aqui...';
            flowSteps = [];
            interceptedCalls = [];
            capturedData = {};
            updateStatusChecks();
        }

        // Auto-executar quando carregar
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('info', 'üåê Sistema carregado - executando verifica√ß√µes iniciais...');
                updateStatusChecks();
                
                // Auto-debug se sistema estiver dispon√≠vel
                if (typeof window.suggestionSystem !== 'undefined') {
                    log('success', '‚úÖ Sistema detectado - executando debug autom√°tico...');
                    setTimeout(debugFluxoCompleto, 1000);
                } else {
                    log('warning', '‚ö†Ô∏è Sistema n√£o detectado - aguardando carregamento...');
                }
            }, 500);
        });

        // Helpers globais para debug manual
        window.debugManual = simularProblema;
        window.getInterceptedData = () => interceptedCalls;
        window.getCurrentState = () => capturedData;
    </script>
</body>
</html>