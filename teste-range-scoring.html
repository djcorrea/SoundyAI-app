<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste: Sistema Range-based Scoring</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
        .test-section { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { color: #28a745; font-weight: bold; }
        .warning { color: #fd7e14; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .result { background: #ffffff; padding: 10px; margin: 5px 0; border-left: 4px solid #007bff; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border: 1px solid #dee2e6; }
        th { background-color: #e9ecef; }
        .score-1 { background-color: #d4edda; } /* Verde */
        .score-07 { background-color: #fff3cd; } /* Amarelo */
        .score-03 { background-color: #f8d7da; } /* Vermelho */
    </style>
</head>
<body>
    <h1>üß™ Teste: Sistema Range-based Scoring</h1>
    <p><strong>Objetivo:</strong> Verificar se o novo sistema de ranges para bandas espectrais est√° funcionando corretamente.</p>

    <div class="test-section">
        <h2>üìä Teste 1: Carregamento das Refer√™ncias JSON</h2>
        <div id="json-test"></div>
    </div>

    <div class="test-section">
        <h2>üéØ Teste 2: Scoring com Ranges vs Fixed Targets</h2>
        <div id="scoring-test"></div>
    </div>

    <div class="test-section">
        <h2>üìà Teste 3: Simula√ß√£o Completa de Bandas Espectrais</h2>
        <div id="spectral-test"></div>
    </div>

    <script>
        // Simula√ß√£o das fun√ß√µes de scoring (vers√£o simplificada para teste)
        function scoreToleranceRange(metricValue, targetRange, fallbackTarget = null, tol = null) {
            if (!Number.isFinite(metricValue)) return null;
            
            // Se targetRange √© um objeto com min/max, usar sistema de ranges
            if (targetRange && typeof targetRange === 'object' && 
                Number.isFinite(targetRange.min) && Number.isFinite(targetRange.max)) {
                
                const { min, max } = targetRange;
                
                // Dentro do range = score m√°ximo
                if (metricValue >= min && metricValue <= max) {
                    return 1.0;
                }
                
                // Fora do range = penaliza√ß√£o proporcional
                let distance;
                if (metricValue < min) {
                    distance = min - metricValue;
                } else {
                    distance = metricValue - max;
                }
                
                const rangeWidth = max - min;
                const defaultTolerance = rangeWidth * 0.25;
                const tolerance = Number.isFinite(tol) && tol > 0 ? tol : defaultTolerance;
                
                if (distance <= tolerance) {
                    return 1.0 - (distance / tolerance) * 0.5;
                } else if (distance <= tolerance * 2) {
                    return 0.5 - (distance - tolerance) / tolerance * 0.3;
                } else {
                    return Math.max(0.1, 0.2 - (distance - tolerance * 2) / (tolerance * 3) * 0.1);
                }
            }
            
            // Fallback para sistema antigo (target fixo)
            if (Number.isFinite(fallbackTarget) && Number.isFinite(tol)) {
                const deviation = Math.abs(metricValue - fallbackTarget);
                if (deviation <= tol) {
                    return 1.0;
                } else {
                    return Math.max(0.1, 1.0 - deviation / tol * 0.5);
                }
            }
            
            return null;
        }

        // Teste 1: Carregar e verificar JSON
        async function testeCarregarJSON() {
            const output = document.getElementById('json-test');
            try {
                // Simula√ß√£o dos dados esperados (em produ√ß√£o viria do JSON)
                const funkMandela = {
                    spectral_bands: {
                        sub: { 
                            target_db: -28,
                            target_range: { min: -34, max: -22 }
                        },
                        bass: { 
                            target_db: -26.5,
                            target_range: { min: -32, max: -21 }
                        },
                        low_mid: { 
                            target_db: -29.5,
                            target_range: { min: -33, max: -26 }
                        },
                        mid: { 
                            target_db: -31,
                            target_range: { min: -34, max: -28 }
                        },
                        high_mid: { 
                            target_db: -34,
                            target_range: { min: -40, max: -28 }
                        },
                        presence: { 
                            target_db: -39,
                            target_range: { min: -45, max: -33 }
                        },
                        air: { 
                            target_db: -41,
                            target_range: { min: -44, max: -38 }
                        }
                    }
                };

                output.innerHTML = `
                    <div class="result success">‚úÖ JSON carregado com sucesso!</div>
                    <table>
                        <tr><th>Banda</th><th>Target Original</th><th>Novo Range</th><th>Status</th></tr>
                        ${Object.entries(funkMandela.spectral_bands).map(([banda, config]) => `
                            <tr>
                                <td>${banda}</td>
                                <td>${config.target_db} dB</td>
                                <td>[${config.target_range.min}, ${config.target_range.max}] dB</td>
                                <td class="success">‚úÖ Range definido</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            } catch (error) {
                output.innerHTML = `<div class="result error">‚ùå Erro ao carregar JSON: ${error.message}</div>`;
            }
        }

        // Teste 2: Comparar scoring range vs fixed
        function testeScoring() {
            const output = document.getElementById('scoring-test');
            
            const testCases = [
                // [valor, range, target_fixo, esperado]
                [-28, {min: -34, max: -22}, -28, "Dentro do range"],
                [-22, {min: -34, max: -22}, -28, "No limite superior"],
                [-34, {min: -34, max: -22}, -28, "No limite inferior"],
                [-20, {min: -34, max: -22}, -28, "Acima do range"],
                [-36, {min: -34, max: -22}, -28, "Abaixo do range"],
                [-40, {min: -34, max: -22}, -28, "Muito abaixo"]
            ];

            let tableHTML = `
                <table>
                    <tr>
                        <th>Valor</th>
                        <th>Range</th>
                        <th>Score Range</th>
                        <th>Score Fixo</th>
                        <th>Situa√ß√£o</th>
                        <th>Cor</th>
                    </tr>
            `;

            testCases.forEach(([valor, range, targetFixo, situacao]) => {
                const scoreRange = scoreToleranceRange(valor, range);
                const scoreFixo = scoreToleranceRange(valor, null, targetFixo, 3.0);
                
                let cor = 'score-03'; // Vermelho
                if (scoreRange >= 0.7) cor = 'score-1'; // Verde
                else if (scoreRange >= 0.4) cor = 'score-07'; // Amarelo

                tableHTML += `
                    <tr class="${cor}">
                        <td>${valor} dB</td>
                        <td>[${range.min}, ${range.max}]</td>
                        <td>${scoreRange ? scoreRange.toFixed(3) : 'null'}</td>
                        <td>${scoreFixo ? scoreFixo.toFixed(3) : 'null'}</td>
                        <td>${situacao}</td>
                        <td>${scoreRange >= 0.7 ? 'üü¢' : scoreRange >= 0.4 ? 'üü°' : 'üî¥'}</td>
                    </tr>
                `;
            });

            tableHTML += '</table>';
            
            output.innerHTML = `
                <div class="result success">‚úÖ Teste de scoring conclu√≠do!</div>
                <p><strong>Legenda:</strong> üü¢ Score ‚â• 0.7 | üü° Score 0.4-0.7 | üî¥ Score < 0.4</p>
                ${tableHTML}
                <div class="result">
                    <strong>üìã Observa√ß√µes:</strong>
                    <ul>
                        <li>Range-based scoring d√° score m√°ximo (1.0) para qualquer valor dentro do intervalo</li>
                        <li>Sistema antigo (fixed) penaliza qualquer desvio do target espec√≠fico</li>
                        <li>Compatibilidade mantida: se n√£o h√° range, usa target fixo</li>
                    </ul>
                </div>
            `;
        }

        // Teste 3: Simula√ß√£o completa
        function testeSpectral() {
            const output = document.getElementById('spectral-test');
            
            // Simula√ß√£o de dados de uma m√∫sica "Funk Mandela style"
            const medicaoMusica = {
                sub: -28,      // Dentro do range [-34, -22]
                bass: -25,     // Dentro do range [-32, -21]  
                low_mid: -30,  // Dentro do range [-33, -26]
                mid: -31,      // Dentro do range [-34, -28]
                high_mid: -32, // Dentro do range [-40, -28]
                presence: -38, // Dentro do range [-45, -33]
                air: -40       // Dentro do range [-44, -38]
            };

            const ranges = {
                sub: {min: -34, max: -22},
                bass: {min: -32, max: -21},
                low_mid: {min: -33, max: -26},
                mid: {min: -34, max: -28},
                high_mid: {min: -40, max: -28},
                presence: {min: -45, max: -33},
                air: {min: -44, max: -38}
            };

            let totalScore = 0;
            let bandasCount = 0;
            let tableHTML = `
                <table>
                    <tr><th>Banda</th><th>Valor Medido</th><th>Range Alvo</th><th>Score</th><th>Status</th></tr>
            `;

            Object.entries(medicaoMusica).forEach(([banda, valor]) => {
                const range = ranges[banda];
                const score = scoreToleranceRange(valor, range);
                
                if (score !== null) {
                    totalScore += score;
                    bandasCount++;
                }

                let status = 'üî¥ Problem√°tico';
                let rowClass = 'score-03';
                
                if (score >= 0.7) {
                    status = 'üü¢ Excelente';
                    rowClass = 'score-1';
                } else if (score >= 0.4) {
                    status = 'üü° Aceit√°vel';
                    rowClass = 'score-07';
                }

                tableHTML += `
                    <tr class="${rowClass}">
                        <td><strong>${banda.toUpperCase()}</strong></td>
                        <td>${valor} dB</td>
                        <td>[${range.min}, ${range.max}] dB</td>
                        <td>${score ? score.toFixed(3) : 'N/A'}</td>
                        <td>${status}</td>
                    </tr>
                `;
            });

            tableHTML += '</table>';

            const scoreGeral = bandasCount > 0 ? (totalScore / bandasCount * 100).toFixed(1) : 0;
            
            output.innerHTML = `
                <div class="result success">
                    <h3>üéµ An√°lise: M√∫sica Estilo "Funk Mandela"</h3>
                    <p><strong>Score Geral:</strong> ${scoreGeral}% (${bandasCount} bandas analisadas)</p>
                </div>
                ${tableHTML}
                <div class="result">
                    <strong>üéØ Interpreta√ß√£o:</strong>
                    <p>Com o novo sistema de ranges, uma m√∫sica com "batida forte sem distorcer" 
                    recebe scores altos em todas as bandas espectrais, pois os valores ficam 
                    dentro das faixas aceit√°veis. O sistema anterior seria mais restritivo.</p>
                </div>
            `;
        }

        // Executar todos os testes
        document.addEventListener('DOMContentLoaded', function() {
            testeCarregarJSON();
            testeScoring();
            testeSpectral();
        });
    </script>
</body>
</html>