<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Debug Sugest√µes Railway - SoundyAI</title>
    <style>
        body { 
            font-family: monospace; 
            background: #0d1117; 
            color: #f0f6fc; 
            margin: 0; 
            padding: 20px;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .panel { 
            background: #161b22; 
            border: 1px solid #30363d; 
            border-radius: 6px; 
            padding: 16px; 
            margin: 16px 0; 
        }
        .success { border-left: 4px solid #238636; }
        .error { border-left: 4px solid #da3633; }
        .warning { border-left: 4px solid #f85149; }
        .info { border-left: 4px solid #1f6feb; }
        button { 
            background: #238636; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 8px 4px;
            font-family: monospace;
        }
        button:hover { background: #2ea043; }
        .danger { background: #da3633; }
        .danger:hover { background: #f85149; }
        pre { 
            background: #0d1117; 
            border: 1px solid #30363d; 
            padding: 12px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-size: 12px;
        }
        .stat { 
            display: inline-block; 
            background: #21262d; 
            padding: 8px 12px; 
            border-radius: 6px; 
            margin: 4px; 
            border: 1px solid #30363d;
        }
        .highlight { color: #f85149; font-weight: bold; }
        .ok { color: #238636; font-weight: bold; }
        .loading { 
            border: 2px solid #30363d;
            border-top: 2px solid #1f6feb;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Debug Sistema de Sugest√µes - Railway Production</h1>
        <p>Teste completo do sistema de sugest√µes em produ√ß√£o na Railway</p>
        
        <div class="panel info">
            <h2>üéØ Controles de Teste</h2>
            <button onclick="runFullDiagnostic()" id="btn-test">üîç Executar Diagn√≥stico Completo</button>
            <button onclick="testOnlyExtraction()" id="btn-extract">‚öôÔ∏è Testar S√≥ Extra√ß√£o</button>
            <button onclick="clearLogs()" class="danger">üßπ Limpar</button>
            <button onclick="exportDebugData()">üíæ Exportar Debug</button>
        </div>

        <div class="panel" id="status-panel">
            <h2>üìä Status do Sistema</h2>
            <div id="system-status">Aguardando teste...</div>
        </div>

        <div class="panel" id="results-panel">
            <h2>üéµ Resultados</h2>
            <div id="test-results">Nenhum teste executado ainda</div>
        </div>

        <div class="panel" id="logs-panel">
            <h2>üìã Logs Detalhados</h2>
            <div id="debug-logs">Logs aparecer√£o aqui...</div>
        </div>

        <div class="panel" id="raw-data-panel" style="display: none;">
            <h2>üîß Dados Brutos</h2>
            <pre id="raw-data"></pre>
        </div>
    </div>

    <!-- Carregamento das depend√™ncias -->
    <script src="suggestion-scorer.js"></script>
    <script src="enhanced-suggestion-engine.js"></script>

    <script>
        // üéØ Dados de teste que simulam an√°lise real
        const TESTE_ANALYSIS = {
            metadata: {
                filename: "railway-test.wav",
                duration: 210.3,
                sampleRate: 48000,
                channels: 2
            },
            technicalData: {
                lufsIntegrated: -12.8,
                truePeakDbtp: -0.9,
                dynamicRange: 6.2,
                lra: 4.8,
                stereoWidth: 0.82,
                frequencyAnalysis: {
                    subbass: 0.71,
                    bass: 0.85,
                    lowMid: 0.79,
                    mid: 0.91,
                    highMid: 0.73,
                    presenca: 0.66,
                    brilho: 0.78
                }
            },
            qualityMetrics: {
                totalHarmonicDistortion: 0.012,
                signalToNoiseRatio: 68.2
            }
        };

        const TESTE_REFERENCE = {
            "lufs_target": -14.0,
            "lufs_tolerance": 1.0,
            "true_peak_target": -1.0,
            "true_peak_tolerance": 0.5,
            "dr_target": 8.0,
            "dr_tolerance": 2.0,
            "lra_target": 6.0,
            "lra_tolerance": 2.0,
            "stereo_target": 0.8,
            "stereo_tolerance": 0.15,
            "bands": {
                "subbass": { "target": 0.75, "tolerance": 0.1 },
                "bass": { "target": 0.8, "tolerance": 0.1 },
                "lowMid": { "target": 0.8, "tolerance": 0.1 },
                "mid": { "target": 0.9, "tolerance": 0.1 },
                "highMid": { "target": 0.75, "tolerance": 0.1 },
                "presenca": { "target": 0.7, "tolerance": 0.1 },
                "brilho": { "target": 0.8, "tolerance": 0.1 }
            }
        };

        let logs = [];
        let currentEngine = null;

        function log(level, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { timestamp, level, message, data };
            logs.push(entry);
            
            const logsDiv = document.getElementById('debug-logs');
            const logElement = document.createElement('div');
            logElement.className = `panel ${level}`;
            logElement.innerHTML = `
                <strong>[${timestamp}] ${level.toUpperCase()}:</strong> ${message}
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            logsDiv.appendChild(logElement);
            logElement.scrollIntoView({ behavior: 'smooth' });
        }

        function updateStatus(status, isError = false) {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = `<span class="${isError ? 'highlight' : 'ok'}">${status}</span>`;
        }

        function showResults(results) {
            const resultsDiv = document.getElementById('test-results');
            
            if (!results || !results.suggestions) {
                resultsDiv.innerHTML = '<span class="highlight">‚ùå Nenhuma sugest√£o gerada</span>';
                return;
            }

            const suggestions = results.suggestions;
            let html = `
                <div class="stat">Sugest√µes: <span class="${suggestions.length > 0 ? 'ok' : 'highlight'}">${suggestions.length}</span></div>
                <div class="stat">Tempo: ${results.enhancedMetrics?.processingTimeMs || 0}ms</div>
                <div class="stat">Confian√ßa: ${(results.enhancedMetrics?.confidence || 0).toFixed(2)}</div>
            `;

            if (suggestions.length > 0) {
                html += '<h3>üéØ Top 5 Sugest√µes:</h3>';
                suggestions.slice(0, 5).forEach((s, i) => {
                    html += `<div class="stat">${i+1}. ${s.category} (${s.priority.toFixed(2)})</div>`;
                });
            }

            resultsDiv.innerHTML = html;
        }

        async function runFullDiagnostic() {
            clearLogs();
            log('info', 'üöÄ Iniciando diagn√≥stico completo...');
            updateStatus('üîÑ Executando testes...', false);

            try {
                // Passo 1: Verificar depend√™ncias
                log('info', 'üì¶ Verificando depend√™ncias...');
                
                if (typeof SuggestionScorer === 'undefined') {
                    throw new Error('SuggestionScorer n√£o carregado');
                }
                
                if (typeof EnhancedSuggestionEngine === 'undefined') {
                    throw new Error('EnhancedSuggestionEngine n√£o carregado');
                }
                
                log('success', '‚úÖ Depend√™ncias carregadas');

                // Passo 2: Inicializar engine
                log('info', '‚öôÔ∏è Inicializando Enhanced Suggestion Engine...');
                currentEngine = new EnhancedSuggestionEngine({
                    maxSuggestions: 10,
                    enableHeuristics: true,
                    groupByTheme: false
                });
                log('success', '‚úÖ Engine inicializado');

                // Passo 3: Executar processamento
                log('info', 'üéµ Processando an√°lise de teste...');
                const result = currentEngine.processAnalysis(TESTE_ANALYSIS, TESTE_REFERENCE);
                
                // Passo 4: Analisar resultado
                log('success', '‚úÖ Processamento conclu√≠do', {
                    suggestionsCount: result.suggestions?.length || 0,
                    hasEnhancedMetrics: !!result.enhancedMetrics,
                    hasAuditLog: !!result.auditLog,
                    processingTime: result.enhancedMetrics?.processingTimeMs
                });

                // Passo 5: Mostrar audit log se dispon√≠vel
                if (result.auditLog && result.auditLog.length > 0) {
                    log('info', 'üìã Logs de auditoria dispon√≠veis', {
                        logCount: result.auditLog.length,
                        logTypes: [...new Set(result.auditLog.map(l => l.type))]
                    });
                    
                    // Mostrar logs cr√≠ticos
                    result.auditLog.forEach(auditEntry => {
                        if (auditEntry.type.includes('ERROR') || auditEntry.type.includes('FAILURE')) {
                            log('error', `Audit: ${auditEntry.message}`, auditEntry.data);
                        } else if (auditEntry.type.includes('FINAL_RESULT')) {
                            log('info', `Audit: ${auditEntry.message}`, auditEntry.data);
                        }
                    });
                }

                // Salvar dados para debug
                window.__RAILWAY_DEBUG = {
                    analysis: TESTE_ANALYSIS,
                    reference: TESTE_REFERENCE,
                    result: result,
                    logs: logs
                };

                showResults(result);
                updateStatus('‚úÖ Diagn√≥stico conclu√≠do', false);

            } catch (error) {
                log('error', `‚ùå Erro durante diagn√≥stico: ${error.message}`, error);
                updateStatus('‚ùå Falha no diagn√≥stico', true);
            }
        }

        async function testOnlyExtraction() {
            clearLogs();
            log('info', '‚öôÔ∏è Testando apenas extra√ß√£o de m√©tricas...');

            try {
                if (!currentEngine) {
                    currentEngine = new EnhancedSuggestionEngine();
                }

                // Testar normaliza√ß√£o
                const normalized = currentEngine.normalizeReferenceData(TESTE_REFERENCE);
                log('info', 'üìä Dados de refer√™ncia normalizados', normalized);

                // Testar extra√ß√£o
                const metrics = currentEngine.extractMetrics(TESTE_ANALYSIS, normalized);
                log('info', 'üîç M√©tricas extra√≠das', metrics);

                if (Object.keys(metrics).length === 0) {
                    log('error', '‚ùå Nenhuma m√©trica extra√≠da - verifique estrutura dos dados');
                } else {
                    log('success', `‚úÖ ${Object.keys(metrics).length} m√©tricas extra√≠das com sucesso`);
                }

                updateStatus('‚úÖ Teste de extra√ß√£o conclu√≠do', false);

            } catch (error) {
                log('error', `‚ùå Erro na extra√ß√£o: ${error.message}`, error);
                updateStatus('‚ùå Falha na extra√ß√£o', true);
            }
        }

        function clearLogs() {
            logs = [];
            document.getElementById('debug-logs').innerHTML = '';
            document.getElementById('test-results').innerHTML = 'Aguardando teste...';
            updateStatus('Aguardando comando...', false);
        }

        function exportDebugData() {
            const debugData = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                logs: logs,
                railwayDebug: window.__RAILWAY_DEBUG || null
            };
            
            const blob = new Blob([JSON.stringify(debugData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `soundyai-debug-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('success', 'üíæ Dados de debug exportados');
        }

        // Auto-executar quando carregar
        window.addEventListener('load', () => {
            log('info', 'üåê Sistema carregado na Railway');
            log('info', 'üîó URL: ' + window.location.href);
            log('info', 'üïê Timestamp: ' + new Date().toISOString());
            updateStatus('Sistema carregado - pronto para testes', false);
        });

        // Capturar erros globais
        window.addEventListener('error', (e) => {
            log('error', `üí• Erro JavaScript: ${e.message}`, {
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno
            });
        });

        // Debug helpers
        window.debugSuggestions = function() {
            console.log('üîç Railway Debug Data:', window.__RAILWAY_DEBUG);
            console.log('üìã Logs:', logs);
        };

        window.testManual = function(analysis, reference) {
            if (!currentEngine) currentEngine = new EnhancedSuggestionEngine();
            return currentEngine.processAnalysis(analysis || TESTE_ANALYSIS, reference || TESTE_REFERENCE);
        };
    </script>
</body>
</html>