<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Modal: M√©tricas Reais do Backend</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="no-fallbacks.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .test-controls { margin: 20px 0; padding: 20px; background: #2a2a2a; border-radius: 8px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .result-log { background: #000; color: #0f0; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üß™ Teste: Modal com M√©tricas Reais</h1>
    
    <div class="test-controls">
        <h3>Cen√°rios de Teste</h3>
        <button class="btn btn-primary" onclick="testarDadosCompletos()">Dados Completos do Backend</button>
        <button class="btn btn-warning" onclick="testarDadosIncompletos()">Dados Incompletos</button>
        <button class="btn btn-success" onclick="testarDadosVazios()">Backend sem Dados</button>
        <button onclick="limparLog()" class="btn">Limpar Log</button>
    </div>
    
    <div id="log" class="result-log">
        Console de teste iniciado...<br>
    </div>
    
    <!-- Incluir estrutura do modal -->
    <div id="audioAnalysisModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">An√°lise de √Åudio</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="audioUploadArea" style="display: none;">Upload area</div>
                <div id="audioAnalysisLoading" style="display: none;">Loading...</div>
                <div id="audioAnalysisResults" style="display: none;">
                    <div id="modalTechnicalData">Technical data aqui</div>
                </div>
            </div>
        </div>
    </div>

    <script src="audio-analyzer-integration.js"></script>
    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function limparLog() {
            document.getElementById('log').innerHTML = 'Console de teste limpo...<br>';
        }
        
        function testarDadosCompletos() {
            log('üß™ Testando dados COMPLETOS do backend...');
            
            // Simular resposta completa do backend
            const dadosBackend = {
                score: 8.7,
                loudness: {
                    integrated: -16.3,
                    shortTerm: -15.8,
                    momentary: -14.2,
                    lra: 4.5
                },
                truePeak: {
                    maxDbtp: -8.1,
                    maxLinear: 0.39,
                    oversamplingFactor: 4,
                    clippingCount: 0,
                    leftPeak: -8.3,
                    rightPeak: -8.1,
                    unit: 'dBTP'
                },
                stereo: {
                    correlation: 0.82,
                    width: 0.75,
                    balance: 0.02,
                    isMonoCompatible: true,
                    hasPhaseIssues: false,
                    correlationCategory: 'good',
                    widthCategory: 'wide'
                },
                spectral: {
                    spectralCentroidHz: 2150.5,
                    spectralRolloffHz: 8500,
                    spectralBandwidthHz: 4200,
                    spectralFlatness: 0.15,
                    processedFrames: 1024
                },
                dynamics: {
                    dynamicRange: 12.5,
                    crestFactor: 8.2,
                    lra: 4.5,
                    peakToAverage: 15.3
                },
                qualityOverall: 8.7,
                processingMs: 2845,
                runId: 'test_' + Date.now()
            };
            
            try {
                log('‚úÖ Normalizando dados do backend...');
                const dadosNormalizados = normalizeBackendAnalysisData(dadosBackend);
                log('‚úÖ Dados normalizados com sucesso');
                
                log('üéØ Exibindo no modal...');
                displayModalResults(dadosNormalizados);
                
                // Mostrar modal
                document.getElementById('audioAnalysisModal').style.display = 'block';
                
                log('‚úÖ Modal exibido com DADOS REAIS!');
                log('üìä M√©tricas dispon√≠veis: LUFS ' + dadosNormalizados.technicalData.lufsIntegrated + 
                    ', True Peak ' + dadosNormalizados.technicalData.truePeakDbtp + 
                    ', Stereo ' + dadosNormalizados.technicalData.stereoCorrelation);
                    
            } catch (error) {
                log('‚ùå ERRO: ' + error.message);
                console.error('Erro no teste:', error);
            }
        }
        
        function testarDadosIncompletos() {
            log('üß™ Testando dados INCOMPLETOS do backend...');
            
            // Simular resposta parcial do backend
            const dadosBackend = {
                score: 6.2,
                loudness: {
                    integrated: -18.5
                    // outros campos ausentes
                },
                // truePeak ausente
                // stereo ausente
                spectral: {
                    spectralCentroidHz: 1890.3
                    // outros campos ausentes
                },
                qualityOverall: 6.2,
                processingMs: 1523,
                runId: 'test_incomplete_' + Date.now()
            };
            
            try {
                log('‚úÖ Normalizando dados incompletos...');
                const dadosNormalizados = normalizeBackendAnalysisData(dadosBackend);
                log('‚úÖ Dados normalizados (alguns campos nulos)');
                
                log('üéØ Exibindo no modal...');
                displayModalResults(dadosNormalizados);
                
                // Mostrar modal
                document.getElementById('audioAnalysisModal').style.display = 'block';
                
                log('‚úÖ Modal exibido - campos ausentes mostram "N√£o dispon√≠vel"');
                log('üìä Dispon√≠vel: LUFS ' + dadosNormalizados.technicalData.lufsIntegrated + 
                    ', True Peak: ' + (dadosNormalizados.technicalData.truePeakDbtp || 'N√£o dispon√≠vel') +
                    ', Stereo: ' + (dadosNormalizados.technicalData.stereoCorrelation || 'N√£o dispon√≠vel'));
                    
            } catch (error) {
                log('‚ùå ERRO: ' + error.message);
                console.error('Erro no teste:', error);
            }
        }
        
        function testarDadosVazios() {
            log('üß™ Testando backend SEM DADOS...');
            
            const dadosBackend = {
                score: null,
                // Todos os campos ausentes
                qualityOverall: null,
                processingMs: 500,
                runId: 'test_empty_' + Date.now()
            };
            
            try {
                log('‚úÖ Normalizando dados vazios...');
                const dadosNormalizados = normalizeBackendAnalysisData(dadosBackend);
                log('‚úÖ Dados normalizados (maioria nulo)');
                
                log('üéØ Exibindo no modal...');
                displayModalResults(dadosNormalizados);
                
                // Mostrar modal
                document.getElementById('audioAnalysisModal').style.display = 'block';
                
                log('‚úÖ Modal exibido - TODOS os campos mostram "N√£o dispon√≠vel"');
                log('üìä Nenhum valor fict√≠cio exibido');
                    
            } catch (error) {
                log('‚ùå ERRO: ' + error.message);
                console.error('Erro no teste:', error);
            }
        }
        
        // Fechar modal
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('close') || e.target.classList.contains('modal')) {
                document.getElementById('audioAnalysisModal').style.display = 'none';
            }
        });
        
        log('üöÄ Teste pronto. Clique nos bot√µes para testar diferentes cen√°rios.');
    </script>
</body>
</html>