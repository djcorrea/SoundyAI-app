<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste: Corre√ß√£o dominantFrequencies TypeError</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #0f0f23;
            color: #cccccc;
        }
        .header {
            background: linear-gradient(135deg, #1e1e3f, #2d2d5f);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .test-section {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4a9eff;
        }
        .success {
            border-left-color: #28a745;
        }
        .error {
            border-left-color: #dc3545;
        }
        .warning {
            border-left-color: #ffc107;
        }
        pre {
            background: #0d1117;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #357abd;
        }
        #results {
            margin-top: 20px;
        }
        .test-case {
            background: #16213e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #333;
        }
        .test-pass {
            border-left: 4px solid #28a745;
        }
        .test-fail {
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Teste: Corre√ß√£o dominantFrequencies TypeError</h1>
        <p>Verificando se a corre√ß√£o resolve o erro "... is not iterable" com JSONs reais do backend</p>
    </div>

    <div class="test-section">
        <h3>üéØ Objetivo</h3>
        <p>Garantir que o TypeError em dominantFrequencies foi corrigido e que o motor de sugest√µes funciona com dados reais do backend.</p>
    </div>

    <div class="test-section">
        <h3>üß™ Casos de Teste</h3>
        <button onclick="runAllTests()">üöÄ Executar Todos os Testes</button>
        <button onclick="clearResults()">üßπ Limpar Resultados</button>
    </div>

    <div id="results"></div>

    <script src="audio-analyzer-integration.js"></script>
    <script>
        // üß™ Casos de teste simulando diferentes formatos de dominantFrequencies do backend
        const testCases = [
            {
                name: "Formato Backend Atual (objeto com detailed)",
                data: {
                    technicalData: {
                        peak: -3.2,
                        rms: -21.8,
                        dynamicRange: 8.5,
                        // Formato que causa TypeError
                        dominantFrequencies: {
                            unit: "Hz",
                            value: 440,
                            status: "ok",
                            detailed: {
                                peaks: [
                                    { frequency: 440, magnitude: 0.8 },
                                    { frequency: 880, magnitude: 0.6 },
                                    { frequency: 1320, magnitude: 0.4 }
                                ],
                                primary: 440,
                                secondary: 880
                            }
                        }
                    },
                    problems: [],
                    suggestions: [],
                    qualityOverall: 7.5
                }
            },
            {
                name: "Formato Array (antigo)",
                data: {
                    technicalData: {
                        peak: -3.2,
                        rms: -21.8,
                        dynamicRange: 8.5,
                        dominantFrequencies: [
                            { frequency: 440, occurrences: 150 },
                            { frequency: 880, occurrences: 100 },
                            { frequency: 1320, occurrences: 75 }
                        ]
                    },
                    problems: [],
                    suggestions: [],
                    qualityOverall: 7.5
                }
            },
            {
                name: "dominantFrequencies ausente",
                data: {
                    technicalData: {
                        peak: -3.2,
                        rms: -21.8,
                        dynamicRange: 8.5
                        // dominantFrequencies n√£o presente
                    },
                    problems: [],
                    suggestions: [],
                    qualityOverall: 7.5
                }
            },
            {
                name: "dominantFrequencies null",
                data: {
                    technicalData: {
                        peak: -3.2,
                        rms: -21.8,
                        dynamicRange: 8.5,
                        dominantFrequencies: null
                    },
                    problems: [],
                    suggestions: [],
                    qualityOverall: 7.5
                }
            },
            {
                name: "Objeto com peaks direto",
                data: {
                    technicalData: {
                        peak: -3.2,
                        rms: -21.8,
                        dynamicRange: 8.5
                    },
                    // dominantFrequencies no n√≠vel root
                    dominantFrequencies: {
                        peaks: [
                            { frequency: 440, magnitude: 0.8 },
                            { frequency: 880, magnitude: 0.6 }
                        ],
                        primary: 440,
                        secondary: 880
                    },
                    problems: [],
                    suggestions: [],
                    qualityOverall: 7.5
                }
            }
        ];

        function runAllTests() {
            const resultsDiv = document.getElementById('results');
            let allTestsHtml = '';
            let passedTests = 0;
            let totalTests = testCases.length;

            console.log('üß™ Iniciando testes de corre√ß√£o dominantFrequencies...');

            testCases.forEach((testCase, index) => {
                console.log(`\nüß™ Testando: ${testCase.name}`);
                
                try {
                    // 1. Testar fun√ß√£o de normaliza√ß√£o diretamente
                    let normalizeResult;
                    if (testCase.data.technicalData.dominantFrequencies) {
                        normalizeResult = normalizeDominantFrequencies(testCase.data.technicalData.dominantFrequencies);
                    } else if (testCase.data.dominantFrequencies) {
                        normalizeResult = normalizeDominantFrequencies(testCase.data.dominantFrequencies);
                    } else {
                        normalizeResult = normalizeDominantFrequencies(null);
                    }
                    
                    // 2. Testar processamento completo
                    const processedData = normalizeBackendAnalysisData(testCase.data);
                    
                    // 3. Verificar se pode gerar relat√≥rio sem erro
                    let reportGenerated = false;
                    try {
                        // Simular parte do c√≥digo que antes causava erro
                        if (processedData.technicalData && processedData.technicalData.dominantFrequencies) {
                            const testFreqs = normalizeDominantFrequencies(processedData.technicalData.dominantFrequencies);
                            if (testFreqs.status === "ok" && testFreqs.peaks.length > 0) {
                                // Simular itera√ß√£o que antes causava TypeError
                                testFreqs.peaks.slice(0, 10).forEach((freq, i) => {
                                    const frequency = freq.frequency || freq.value || freq;
                                    // Esta linha antes causava erro
                                });
                            }
                        }
                        reportGenerated = true;
                    } catch (reportError) {
                        console.error(`‚ùå Erro ao gerar relat√≥rio para ${testCase.name}:`, reportError);
                    }
                    
                    // Resultado do teste
                    const testPassed = normalizeResult && reportGenerated;
                    if (testPassed) passedTests++;
                    
                    allTestsHtml += `
                        <div class="test-case ${testPassed ? 'test-pass' : 'test-fail'}">
                            <h4>${testPassed ? '‚úÖ' : '‚ùå'} ${testCase.name}</h4>
                            <p><strong>Status:</strong> ${testPassed ? 'PASSOU' : 'FALHOU'}</p>
                            <p><strong>Normaliza√ß√£o:</strong> ${normalizeResult ? `${normalizeResult.status} (${normalizeResult.peaks.length} peaks)` : 'FALHOU'}</p>
                            <p><strong>Relat√≥rio:</strong> ${reportGenerated ? 'Gerado sem erro' : 'ERRO'}</p>
                            <details>
                                <summary>Resultado da normaliza√ß√£o</summary>
                                <pre>${JSON.stringify(normalizeResult, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error(`‚ùå Erro no teste ${testCase.name}:`, error);
                    allTestsHtml += `
                        <div class="test-case test-fail">
                            <h4>‚ùå ${testCase.name}</h4>
                            <p><strong>Status:</strong> ERRO CR√çTICO</p>
                            <p><strong>Erro:</strong> ${error.message}</p>
                            <pre>${error.stack}</pre>
                        </div>
                    `;
                }
            });

            // Resumo final
            const allPassed = passedTests === totalTests;
            resultsDiv.innerHTML = `
                <div class="test-section ${allPassed ? 'success' : 'error'}">
                    <h3>${allPassed ? '‚úÖ' : '‚ö†Ô∏è'} Resumo dos Testes</h3>
                    <p><strong>Resultado:</strong> ${passedTests}/${totalTests} testes passaram</p>
                    <p><strong>Status TypeError:</strong> ${allPassed ? 'RESOLVIDO' : 'AINDA PRESENTE'}</p>
                    <p><strong>Sugest√µes funcionando:</strong> ${allPassed ? 'SIM' : 'VERIFICAR'}</p>
                </div>
                ${allTestsHtml}
            `;

            console.log(`\nüìä Resumo final: ${passedTests}/${totalTests} testes passaram`);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            console.clear();
            console.log('üßπ Resultados limpos');
        }

        // Verificar se fun√ß√µes est√£o dispon√≠veis
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ P√°gina de teste carregada');
            
            if (typeof normalizeDominantFrequencies !== 'function') {
                document.getElementById('results').innerHTML = `
                    <div class="test-section error">
                        <h3>‚ùå Erro Cr√≠tico</h3>
                        <p>Fun√ß√£o normalizeDominantFrequencies() n√£o encontrada!</p>
                        <p>Verifique se o arquivo audio-analyzer-integration.js foi carregado corretamente.</p>
                    </div>
                `;
            } else {
                console.log('‚úÖ Fun√ß√£o normalizeDominantFrequencies() encontrada');
            }
        });
    </script>
</body>
</html>